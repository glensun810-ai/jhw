<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯Šæ–­ç›‘æ§å¤§ç›˜ - AI å“ç‰Œè¯Šæ–­ç³»ç»Ÿ</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #1a2a3a 0%, #2a3a4a 100%);
      color: #e8e8e8;
      min-height: 100vh;
    }

    .header {
      background: rgba(0, 0, 0, 0.3);
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header h1 {
      font-size: 28px;
      font-weight: 600;
      color: #ffffff;
    }

    .header-controls {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .period-selector {
      display: flex;
      gap: 10px;
    }

    .period-btn {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #e8e8e8;
      cursor: pointer;
      transition: all 0.3s;
    }

    .period-btn.active {
      background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%);
      border-color: #1890ff;
    }

    .period-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.2);
    }

    .refresh-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #52c41a 0%, #73d13d 100%);
      border: none;
      border-radius: 8px;
      color: #ffffff;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }

    .refresh-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(82, 196, 26, 0.4);
    }

    .container {
      padding: 30px 40px;
    }

    /* æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .metric-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s;
    }

    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      border-color: rgba(24, 144, 255, 0.3);
    }

    .metric-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .metric-title {
      font-size: 14px;
      color: #8c8c8c;
      font-weight: 500;
    }

    .metric-icon {
      font-size: 24px;
    }

    .metric-value {
      font-size: 36px;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 8px;
    }

    .metric-sub {
      font-size: 13px;
      color: #8c8c8c;
    }

    .metric-trend {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      margin-left: 8px;
    }

    .trend-up {
      background: rgba(82, 196, 26, 0.2);
      color: #95de64;
    }

    .trend-down {
      background: rgba(255, 77, 79, 0.2);
      color: #ff4d4f;
    }

    /* å›¾è¡¨åŒºåŸŸ */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .chart-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 600;
      color: #ffffff;
    }

    .chart-container {
      height: 300px;
      width: 100%;
    }

    /* æœ€è¿‘è¯Šæ–­åˆ—è¡¨ */
    .recent-section {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #ffffff;
    }

    .diagnosis-table {
      width: 100%;
      border-collapse: collapse;
    }

    .diagnosis-table th {
      text-align: left;
      padding: 12px;
      color: #8c8c8c;
      font-weight: 500;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .diagnosis-table td {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-success {
      background: rgba(82, 196, 26, 0.2);
      color: #95de64;
    }

    .status-partial {
      background: rgba(250, 173, 20, 0.2);
      color: #ffc53d;
    }

    .status-failed {
      background: rgba(255, 77, 79, 0.2);
      color: #ff4d4f;
    }

    .completion-bar {
      width: 100px;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }

    .completion-fill {
      height: 100%;
      background: linear-gradient(90deg, #1890ff 0%, #40a9ff 100%);
      border-radius: 4px;
      transition: width 0.3s;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 400px;
      font-size: 18px;
      color: #8c8c8c;
    }

    .error-message {
      background: rgba(255, 77, 79, 0.1);
      border: 1px solid rgba(255, 77, 79, 0.3);
      border-radius: 8px;
      padding: 16px;
      color: #ff4d4f;
      margin-bottom: 20px;
    }

    .last-updated {
      font-size: 13px;
      color: #8c8c8c;
      text-align: right;
      margin-top: 20px;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 20px;
        padding: 20px;
      }

      .period-selector {
        flex-wrap: wrap;
        justify-content: center;
      }

      .container {
        padding: 20px;
      }

      .metrics-grid {
        grid-template-columns: 1fr; /* ç§»åŠ¨ç«¯å•åˆ—æ˜¾ç¤º */
        gap: 15px;
      }

      .metric-value {
        font-size: 28px; /* ç§»åŠ¨ç«¯å­—ä½“ç¼©å° */
      }

      .charts-grid {
        grid-template-columns: 1fr; /* ç§»åŠ¨ç«¯å•åˆ—æ˜¾ç¤ºå›¾è¡¨ */
      }

      .chart-container {
        height: 250px; /* ç§»åŠ¨ç«¯å›¾è¡¨é«˜åº¦å‡å° */
      }

      .diagnosis-table {
        font-size: 12px; /* ç§»åŠ¨ç«¯è¡¨æ ¼å­—ä½“ç¼©å° */
      }

      .diagnosis-table th,
      .diagnosis-table td {
        padding: 8px 4px; /* ç§»åŠ¨ç«¯è¡¨æ ¼å†…è¾¹è·å‡å° */
      }

      /* éšè—æ¬¡è¦åˆ— */
      .diagnosis-table th:nth-child(6),
      .diagnosis-table td:nth-child(6) {
        display: none; /* ç§»åŠ¨ç«¯éšè—é…é¢ç”¨å°½åˆ— */
      }
    }

    @media (max-width: 480px) {
      .metric-value {
        font-size: 24px; /* å°å±æ‰‹æœºå­—ä½“æ›´å° */
      }

      .chart-container {
        height: 200px; /* å°å±æ‰‹æœºå›¾è¡¨é«˜åº¦æ›´å° */
      }

      .period-btn {
        padding: 8px 12px; /* å°å±æ‰‹æœºæŒ‰é’®æ›´å° */
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ“Š è¯Šæ–­ç›‘æ§å¤§ç›˜</h1>
    <div class="header-controls">
      <div class="period-selector">
        <button class="period-btn active" data-period="today">ä»Šæ—¥</button>
        <button class="period-btn" data-period="week">æœ¬å‘¨</button>
        <button class="period-btn" data-period="month">æœ¬æœˆ</button>
      </div>
      <button class="refresh-btn" onclick="loadDashboard()">ğŸ”„ åˆ·æ–°</button>
    </div>
  </div>

  <div class="container">
    <div id="error-container"></div>

    <!-- æ ¸å¿ƒæŒ‡æ ‡ -->
    <div class="metrics-grid" id="metrics-grid">
      <div class="loading">åŠ è½½ä¸­...</div>
    </div>

    <!-- å›¾è¡¨ -->
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">ğŸ“ˆ è¯Šæ–­è¶‹åŠ¿</div>
        </div>
        <div class="chart-container" id="trend-chart"></div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">ğŸ¯ å®Œæˆç‡åˆ†å¸ƒ</div>
        </div>
        <div class="chart-container" id="completion-chart"></div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">â±ï¸ è€—æ—¶åˆ†å¸ƒ</div>
        </div>
        <div class="chart-container" id="duration-chart"></div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">âš ï¸ é”™è¯¯ç±»å‹åˆ†å¸ƒ</div>
        </div>
        <div class="chart-container" id="error-chart"></div>
      </div>
    </div>

    <!-- æœ€è¿‘è¯Šæ–­ -->
    <div class="recent-section">
      <div class="section-header">
        <div class="section-title">ğŸ“‹ æœ€è¿‘è¯Šæ–­è®°å½•</div>
      </div>
      <table class="diagnosis-table">
        <thead>
          <tr>
            <th>æ‰§è¡Œ ID</th>
            <th>æ—¶é—´</th>
            <th>çŠ¶æ€</th>
            <th>å®Œæˆç‡</th>
            <th>è€—æ—¶</th>
            <th>é…é¢ç”¨å°½</th>
          </tr>
        </thead>
        <tbody id="recent-table-body">
          <tr><td colspan="6" class="loading">åŠ è½½ä¸­...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="last-updated" id="last-updated"></div>
  </div>

  <script>
    // é…ç½® - P1-004 ä¿®å¤ï¼šä»å…¨å±€é…ç½®è¯»å–ï¼Œæ”¯æŒç”Ÿäº§ç¯å¢ƒ
    // ä¼˜å…ˆä½¿ç”¨ window.config.API_BASE_URLï¼Œå…¶æ¬¡ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œæœ€åä½¿ç”¨é»˜è®¤å€¼
    const API_BASE_URL = (typeof window !== 'undefined' && window.config && window.config.API_BASE_URL) ||
                         (typeof process !== 'undefined' && process.env && process.env.API_BASE_URL) ||
                         'http://localhost:5001';  // é»˜è®¤å¼€å‘ç¯å¢ƒåœ°å€
    
    // å¯ä»¥åœ¨éƒ¨ç½²æ—¶é€šè¿‡ä»¥ä¸‹æ–¹å¼é…ç½®ï¼š
    // 1. åœ¨ HTML ä¸­æ·»åŠ ï¼š<script>window.config = { API_BASE_URL: 'https://api.example.com' };</script>
    // 2. æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼šAPI_BASE_URL=https://api.example.com
    let currentPeriod = 'today';
    let trendChart, completionChart, durationChart, errorChart;

    // åˆå§‹åŒ–å›¾è¡¨
    function initCharts() {
      trendChart = echarts.init(document.getElementById('trend-chart'));
      completionChart = echarts.init(document.getElementById('completion-chart'));
      durationChart = echarts.init(document.getElementById('duration-chart'));
      errorChart = echarts.init(document.getElementById('error-chart'));

      window.addEventListener('resize', () => {
        trendChart.resize();
        completionChart.resize();
        durationChart.resize();
        errorChart.resize();
      });
    }

    // åŠ è½½ç›‘æ§å¤§ç›˜
    async function loadDashboard() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/monitoring/dashboard?period=${currentPeriod}`);
        const result = await response.json();

        if (result.success) {
          renderMetrics(result.data);
          renderCharts(result.data);
          loadRecentDiagnosis();
          updateLastUpdated();
        } else {
          showError('åŠ è½½ç›‘æ§æ•°æ®å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        showError('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
      }
    }

    // æ¸²æŸ“æ ¸å¿ƒæŒ‡æ ‡
    function renderMetrics(data) {
      const metricsGrid = document.getElementById('metrics-grid');
      const successRateTrend = data.success_rate >= 95 ? 
        '<span class="metric-trend trend-up">â†‘ ä¼˜ç§€</span>' : 
        '<span class="metric-trend trend-down">â†“ éœ€å…³æ³¨</span>';

      metricsGrid.innerHTML = `
        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-title">è¯Šæ–­æ€»æ•°</span>
            <span class="metric-icon">ğŸ“Š</span>
          </div>
          <div class="metric-value">${data.total_diagnosis}</div>
          <div class="metric-sub">æˆåŠŸï¼š${data.successful_diagnosis} | å¤±è´¥ï¼š${data.failed_diagnosis}</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-title">æˆåŠŸç‡</span>
            <span class="metric-icon">âœ…</span>
          </div>
          <div class="metric-value">${data.success_rate}%${successRateTrend}</div>
          <div class="metric-sub">ç›®æ ‡ï¼š>99%</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-title">å¹³å‡å®Œæˆç‡</span>
            <span class="metric-icon">ğŸ¯</span>
          </div>
          <div class="metric-value">${data.completion.avg_completion_rate}%</div>
          <div class="metric-sub">å®Œå…¨å®Œæˆï¼š${data.completion.full_completion_count} (${data.completion.full_completion_rate}%)</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-title">å¹³å‡è€—æ—¶</span>
            <span class="metric-icon">â±ï¸</span>
          </div>
          <div class="metric-value">${data.performance.avg_duration_seconds}s</div>
          <div class="metric-sub">P95: ${data.performance.p95_duration_seconds}s | æœ€å¤§ï¼š${data.performance.max_duration_seconds}s</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-title">é…é¢ç”¨å°½</span>
            <span class="metric-icon">ğŸ’°</span>
          </div>
          <div class="metric-value">${data.quota.quota_exhausted_count}</div>
          <div class="metric-sub">å‘ç”Ÿç‡ï¼š${data.quota.quota_exhausted_rate}%</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-title">é”™è¯¯æ€»æ•°</span>
            <span class="metric-icon">âš ï¸</span>
          </div>
          <div class="metric-value">${data.errors.total_errors}</div>
          <div class="metric-sub">ç±»å‹æ•°ï¼š${Object.keys(data.errors.error_distribution).length}</div>
        </div>
      `;
    }

    // æ¸²æŸ“å›¾è¡¨
    function renderCharts(data) {
      // è¯Šæ–­è¶‹åŠ¿å›¾ï¼ˆæŒ‰å°æ—¶ï¼‰
      const hourlyData = data.hourly_distribution || {};
      const hours = Array.from({length: 24}, (_, i) => i.toString());
      const counts = hours.map(h => hourlyData[h] || 0);

      trendChart.setOption({
        tooltip: { trigger: 'axis' },
        xAxis: {
          type: 'category',
          data: hours,
          axisLabel: { color: '#8c8c8c' }
        },
        yAxis: {
          type: 'value',
          axisLabel: { color: '#8c8c8c' }
        },
        series: [{
          data: counts,
          type: 'line',
          smooth: true,
          areaStyle: {
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              { offset: 0, color: 'rgba(24, 144, 255, 0.5)' },
              { offset: 1, color: 'rgba(24, 144, 255, 0)' }
            ])
          },
          itemStyle: { color: '#1890ff' }
        }]
      });

      // å®Œæˆç‡åˆ†å¸ƒé¥¼å›¾
      completionChart.setOption({
        tooltip: { trigger: 'item' },
        legend: {
          orient: 'vertical',
          right: 10,
          top: 'center',
          textStyle: { color: '#e8e8e8' }
        },
        series: [{
          type: 'pie',
          radius: ['40%', '70%'],
          center: ['35%', '50%'],
          data: [
            { value: data.completion.full_completion_count, name: 'å®Œå…¨å®Œæˆ', itemStyle: { color: '#52c41a' } },
            { value: data.completion.partial_completion_count, name: 'éƒ¨åˆ†å®Œæˆ', itemStyle: { color: '#faad14' } },
            { value: data.failed_diagnosis, name: 'å®Œå…¨å¤±è´¥', itemStyle: { color: '#ff4d4f' } }
          ],
          label: { color: '#e8e8e8' }
        }]
      });

      // è€—æ—¶åˆ†å¸ƒ
      durationChart.setOption({
        tooltip: { trigger: 'axis' },
        xAxis: {
          type: 'category',
          data: ['å¹³å‡è€—æ—¶', 'P95 è€—æ—¶', 'æœ€å¤§è€—æ—¶'],
          axisLabel: { color: '#8c8c8c' }
        },
        yAxis: {
          type: 'value',
          name: 'ç§’',
          axisLabel: { color: '#8c8c8c' }
        },
        series: [{
          data: [
            data.performance.avg_duration_seconds,
            data.performance.p95_duration_seconds,
            data.performance.max_duration_seconds
          ],
          type: 'bar',
          itemStyle: {
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              { offset: 0, color: '#1890ff' },
              { offset: 1, color: '#40a9ff' }
            ])
          }
        }]
      });

      // é”™è¯¯ç±»å‹åˆ†å¸ƒ
      const errorTypes = Object.keys(data.errors.error_distribution);
      const errorCounts = Object.values(data.errors.error_distribution);

      errorChart.setOption({
        tooltip: { trigger: 'item' },
        series: [{
          type: 'pie',
          radius: '70%',
          data: errorTypes.map((type, index) => ({
            value: errorCounts[index],
            name: type,
            itemStyle: {
              color: ['#ff4d4f', '#faad14', '#1890ff', '#52c41a', '#722ed1'][index % 5]
            }
          })),
          label: { color: '#e8e8e8' }
        }]
      });
    }

    // åŠ è½½æœ€è¿‘è¯Šæ–­
    async function loadRecentDiagnosis() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/monitoring/recent?limit=10`);
        const result = await response.json();

        if (result.success) {
          renderRecentTable(result.data);
        }
      } catch (error) {
        console.error('åŠ è½½æœ€è¿‘è¯Šæ–­å¤±è´¥:', error);
      }
    }

    // æ¸²æŸ“æœ€è¿‘è¯Šæ–­è¡¨æ ¼
    function renderRecentTable(data) {
      const tbody = document.getElementById('recent-table-body');
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="loading">æš‚æ— æ•°æ®</td></tr>';
        return;
      }

      tbody.innerHTML = data.map(item => {
        const statusClass = item.success ? 
          (item.completion_rate >= 100 ? 'status-success' : 'status-partial') : 
          'status-failed';
        const statusText = item.success ? 
          (item.completion_rate >= 100 ? 'æˆåŠŸ' : 'éƒ¨åˆ†å®Œæˆ') : 
          'å¤±è´¥';

        return `
          <tr>
            <td>${item.execution_id.substring(0, 8)}...</td>
            <td>${new Date(item.timestamp).toLocaleString('zh-CN')}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>
              <div class="completion-bar">
                <div class="completion-fill" style="width: ${item.completion_rate}%"></div>
              </div>
              ${item.completion_rate.toFixed(1)}%
            </td>
            <td>${item.duration_seconds.toFixed(1)}s</td>
            <td>${item.quota_exhausted_models.length > 0 ? item.quota_exhausted_models.join(', ') : '-'}</td>
          </tr>
        `;
      }).join('');
    }

    // æ˜¾ç¤ºé”™è¯¯
    function showError(message) {
      document.getElementById('error-container').innerHTML = `
        <div class="error-message">âŒ ${message}</div>
      `;
    }

    // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
    function updateLastUpdated() {
      const now = new Date();
      document.getElementById('last-updated').textContent = 
        `æœ€åæ›´æ–°ï¼š${now.toLocaleString('zh-CN')}`;
    }

    // äº‹ä»¶ç›‘å¬
    document.querySelectorAll('.period-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentPeriod = this.dataset.period;
        loadDashboard();
      });
    });

    // é¡µé¢åŠ è½½
    window.addEventListener('DOMContentLoaded', () => {
      initCharts();
      loadDashboard();

      // æ¯ 30 ç§’è‡ªåŠ¨åˆ·æ–°
      setInterval(loadDashboard, 30000);
    });
  </script>
</body>
</html>
