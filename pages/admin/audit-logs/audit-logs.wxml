<!--pages/admin/audit-logs/audit-logs.wxml-->
<!-- å®¡è®¡æ—¥å¿—é¡µé¢ -->
<view class="audit-container">
  <view class="audit-header">
    <text class="audit-title">å®¡è®¡æ—¥å¿—</text>
    <text class="audit-subtitle">ç®¡ç†å‘˜æ“ä½œè®°å½•ä¸ç›‘æ§</text>
  </view>

  <!-- ç­›é€‰å·¥å…·æ  -->
  <view class="filter-toolbar">
    <view class="filter-group">
      <input class="filter-input" placeholder="ç®¡ç†å‘˜ ID" bindinput="onAdminIdInput" value="{{filters.admin_id}}" />
    </view>
    <view class="filter-group">
      <picker mode="selector" range="{{actionOptions}}" value="{{filters.actionIndex}}" bindchange="onActionChange">
        <view class="filter-picker">
          <text>{{actionOptions[filters.actionIndex] || 'æ“ä½œç±»å‹'}}</text>
        </view>
      </picker>
    </view>
    <view class="filter-group">
      <picker mode="date" value="{{filters.end_date}}" bindchange="onDateChange">
        <view class="filter-picker">
          <text>{{filters.end_date || 'ç»“æŸæ—¥æœŸ'}}</text>
        </view>
      </picker>
    </view>
    <button class="filter-btn" bindtap="applyFilters">æŸ¥è¯¢</button>
    <button class="filter-btn secondary" bindtap="resetFilters">é‡ç½®</button>
  </view>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-section" wx:if="{{statistics}}">
    <view class="stat-card">
      <text class="stat-value">{{statistics.total_actions}}</text>
      <text class="stat-label">æ€»æ“ä½œæ•°</text>
    </view>
    <view class="stat-card">
      <text class="stat-value">{{statistics.error_count}}</text>
      <text class="stat-label">é”™è¯¯æ•°</text>
    </view>
    <view class="stat-card {{statistics.error_rate > 5 ? 'warning' : ''}}">
      <text class="stat-value">{{statistics.error_rate}}%</text>
      <text class="stat-label">é”™è¯¯ç‡</text>
    </view>
  </view>

  <!-- å¯ç–‘æ´»åŠ¨å‘Šè­¦ -->
  <view class="alert-section" wx:if="{{suspiciousActivities && suspiciousActivities.length > 0}}">
    <view class="alert-header">
      <text class="alert-icon">âš ï¸</text>
      <text class="alert-title">å‘ç° {{suspiciousActivities.length}} ä¸ªå¯ç–‘æ´»åŠ¨</text>
    </view>
    <view class="alert-list">
      <view class="alert-item" wx:for="{{suspiciousActivities}}" wx:key="type" wx:for-item="activity">
        <text class="alert-text">{{activity.type === 'frequent_action' ? 'é¢‘ç¹æ“ä½œ' : 'é¢‘ç¹é”™è¯¯'}} - {{activity.admin_id}}</text>
        <text class="alert-count">{{activity.count || activity.error_count}} æ¬¡</text>
      </view>
    </view>
  </view>

  <!-- æ—¥å¿—åˆ—è¡¨ -->
  <view class="logs-section">
    <view class="logs-header">
      <text class="logs-title">æ“ä½œæ—¥å¿—</text>
      <view class="logs-actions">
        <button class="action-btn-small" bindtap="exportLogs">å¯¼å‡ºæ—¥å¿—</button>
      </view>
    </view>

    <view class="logs-list">
      <view class="log-item" wx:for="{{logs}}" wx:key="id" wx:for-item="log">
        <view class="log-header">
          <view class="log-meta">
            <text class="log-action {{log.response_status >= 400 ? 'error' : ''}}">{{log.action}}</text>
            <text class="log-admin">ç®¡ç†å‘˜ï¼š{{log.admin_id}}</text>
          </view>
          <text class="log-status {{log.response_status >= 400 ? 'error' : 'success'}}">
            {{log.response_status >= 400 ? 'âŒ' : 'âœ…'}} {{log.response_status}}
          </text>
        </view>
        
        <view class="log-details">
          <view class="log-detail-item" wx:if="{{log.resource}}">
            <text class="detail-label">èµ„æº:</text>
            <text class="detail-value">{{log.resource}}</text>
            <text class="detail-value" wx:if="{{log.resource_id}}">({{log.resource_id}})</text>
          </view>
          <view class="log-detail-item">
            <text class="detail-label">IP:</text>
            <text class="detail-value">{{log.ip_address || 'æœªçŸ¥'}}</text>
          </view>
          <view class="log-detail-item">
            <text class="detail-label">æ—¶é—´:</text>
            <text class="detail-value">{{formatDateTime(log.created_at)}}</text>
          </view>
          <view class="log-detail-item error" wx:if="{{log.error_message}}">
            <text class="detail-label">é”™è¯¯:</text>
            <text class="detail-value">{{log.error_message}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{!loading && logs.length === 0}}" class="empty-state">
      <text class="empty-icon">ğŸ“‹</text>
      <text class="empty-text">æš‚æ— å®¡è®¡æ—¥å¿—</text>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{loading}}" class="loading-container">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
  </view>

  <!-- åˆ†é¡µ -->
  <view class="pagination" wx:if="{{pagination.total_pages > 1}}">
    <button class="page-btn" bindtap="prevPage" disabled="{{pagination.page <= 1}}">ä¸Šä¸€é¡µ</button>
    <text class="page-info">{{pagination.page}} / {{pagination.total_pages}}</text>
    <button class="page-btn" bindtap="nextPage" disabled="{{pagination.page >= pagination.total_pages}}">ä¸‹ä¸€é¡µ</button>
  </view>
</view>
