<!-- GEO å“ç‰Œæˆ˜ç•¥è¯Šæ–­çœ‹æ¿ - å®Œæ•´ç‰ˆ (P0 å¢å¼ºç‰ˆ) -->
<!-- è¯¦æƒ…æŠ½å±‰ç»„ä»¶ -->
<diagnostic-drawer
  showDrawer="{{showDrawer}}"
  currentQuestionData="{{currentQuestionData}}"
  brandName="{{brandName}}"
  competitors="{{competitors}}"
  bind:close="onDrawerClose"
  bind:save="onDrawerSave"
></diagnostic-drawer>

<!-- ä¸»å®¹å™¨ï¼šæ•°æ®åŠ è½½æˆåŠŸ -->
<view class="container" wx:if="{{dashboardData}}">
  <!-- æ“ä½œæ  -->
  <view class="action-bar">
    <view class="action-item" bindtap="toggleFavorite">
      <text class="action-icon">{{isFavorite ? 'â¤ï¸' : 'ğŸ¤'}}</text>
      <text class="action-text">{{isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
    </view>
    <view class="action-item" bindtap="viewHistory">
      <text class="action-icon">ğŸ“‹</text>
      <text class="action-text">å†å²è®°å½•</text>
    </view>
    <view class="action-item" bindtap="shareReport">
      <text class="action-icon">ğŸ“¤</text>
      <text class="action-text">åˆ†äº«</text>
    </view>
  </view>

  <!-- P0 æ–°å¢ï¼šæƒ…æŠ¥æµæ°´çº¿ç»„ä»¶ -->
  <view class="pipeline-section" wx:if="{{executionId}}">
    <intelligence-pipeline
      executionId="{{executionId}}"
      brandName="{{dashboardData.summary.brandName}}"
      enableSSE="{{true}}"
      autoScroll="{{true}}"
      collapsed="{{false}}"
      bind:loaded="onPipelineLoaded"
      bind:update="onPipelineUpdate"
      bind:error="onPipelineError"
      bind:itemtap="onPipelineItemTap"
    ></intelligence-pipeline>
  </view>

  <!-- P0 æ–°å¢ï¼šROI æŒ‡æ ‡å’Œå½±å“åŠ›å¡ç‰‡ -->
  <view class="p0-section" wx:if="{{dashboardData.roi_metrics || dashboardData.impact_scores}}">
    <!-- ROI æŒ‡æ ‡å¡ç‰‡ -->
    <roi-card
      wx:if="{{dashboardData.roi_metrics}}"
      title="ROI æŒ‡æ ‡"
      subtitle="æŠ•èµ„å›æŠ¥åˆ†æ"
      roiData="{{dashboardData.roi_metrics}}"
      impactScores="{{dashboardData.impact_scores}}"
      benchmarks="{{dashboardData.benchmarks || defaultBenchmarks}}"
      showDelta="{{true}}"
      showImpact="{{true}}"
      showDetail="{{false}}"
      bind:cardtap="onROICardTap"
    ></roi-card>

    <!-- å½±å“åŠ›ä»ªè¡¨ç›˜ -->
    <impact-gauge
      wx:if="{{dashboardData.impact_scores}}"
      impactScores="{{dashboardData.impact_scores}}"
      showInsight="{{true}}"
      title="å“ç‰Œå½±å“åŠ›"
    ></impact-gauge>
  </view>

  <!-- ç¬¬ä¸€æ®µï¼šæ¦‚è§ˆè¯„åˆ†å¡ç‰‡ -->
  <view class="header-card">
    <view class="brand-title">
      <text>{{dashboardData.summary.brandName || 'å“ç‰Œ'}} Â· GEO å“ç‰Œè¯Šæ–­æŠ¥å‘Š</text>
      <view class="sov-badge {{dashboardData.summary.sovLabelClass || 'neutral'}}">
        <text class="sov-badge-icon">{{dashboardData.summary.sovLabelClass === 'leading' ? 'ğŸ‘‘' : dashboardData.summary.sovLabelClass === 'neutral' ? 'âš–ï¸' : 'ğŸ“‰'}}</text>
        <text class="sov-badge-text">{{dashboardData.summary.sovLabel || 'æŒå¹³'}}</text>
      </view>
    </view>

    <view class="score-section">
      <view class="score-box">
        <text class="score-label">å“ç‰Œå¥åº·åº¦å¾—åˆ†</text>
        <text class="score-value {{dashboardData.summary.healthScore >= 80 ? 'excellent' : dashboardData.summary.healthScore >= 60 ? 'good' : 'fair'}}">{{dashboardData.summary.healthScore || 0}}</text>
        <text class="score-unit">åˆ†</text>
        <view class="risk-level-badge {{dashboardData.summary.riskLevel || 'safe'}}">
          <text class="risk-level-icon">{{dashboardData.summary.riskLevel === 'critical' ? 'ğŸš¨' : dashboardData.summary.riskLevel === 'warning' ? 'âš ï¸' : 'âœ…'}}</text>
          <text class="risk-level-text">{{dashboardData.summary.riskLevelText || 'ä½é£é™©'}}</text>
        </view>
      </view>

      <view class="metrics-row">
        <view class="metric-item">
          <view class="metric-value">{{dashboardData.summary.sov || dashboardData.summary.sov_value || 0}}%</view>
          <view class="metric-label">AI å£°é‡å æ¯”</view>
          <view class="metric-sub">{{dashboardData.summary.totalMentions || 0}}/{{dashboardData.summary.totalTests || 0}} æåŠ</view>
        </view>
        <view class="metric-divider"></view>
        <view class="metric-item">
          <view class="metric-value {{dashboardData.summary.sentimentStatus || 'neutral'}}">{{dashboardData.summary.avgSentiment || dashboardData.summary.sentiment_value || 0}}</view>
          <view class="metric-label">æƒ…æ„Ÿå‡å€¼</view>
          <view class="metric-sub">{{dashboardData.summary.sentimentLabel || 'ä¸­æ€§'}}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- P1 æ–°å¢ï¼šå·¥ä½œæµåˆ†æå‘ç° -->
  <view class="section" wx:if="{{workflowResults}}">
    <workflow-findings
      title="å·¥ä½œæµåˆ†æå‘ç°"
      subtitle="AI è¯Šæ–­è¿‡ç¨‹å…³é”®å‘ç°"
      workflowStages="{{workflowResults.workflow_stages}}"
      summary="{{workflowResults.summary}}"
      expandAll="{{false}}"
      expandedStage="{{expandedWorkflowStage}}"
      bind:stagetoggle="onWorkflowStageToggle"
    ></workflow-findings>
  </view>

  <!-- ç¬¬äºŒæ®µï¼šæ ¸å¿ƒé—®é¢˜è¯Šæ–­åˆ†æ -->
  <view class="section">
    <view class="section-header">
      <view class="section-title">
        <text class="title-icon">ğŸ“Š</text>
        <text class="title-text">æ ¸å¿ƒé—®é¢˜è¯Šæ–­åˆ†æ</text>
      </view>
      <view class="section-subtitle">å…± {{questionCards.length}} ä¸ªé—®é¢˜</view>
    </view>

    <view class="question-list">
      <block wx:for="{{questionCards}}" wx:key="index">
        <view class="question-card {{item.riskLevel || item.risk_level || 'safe'}}" bindtap="goToQuestionDetail" data-index="{{index}}">
          <view class="q-header">
            <view class="q-number {{item.riskLevel || item.risk_level || 'safe'}}">Q{{index + 1}}</view>
            <text class="q-text">{{item.text || item.question_text}}</text>
            <view class="risk-badge {{item.riskLevel || item.risk_level || 'safe'}}">
              <text class="risk-icon">{{item.riskLevel === 'critical' || item.risk_level === 'critical' ? 'ğŸ”´' : item.riskLevel === 'warning' || item.risk_level === 'warning' ? 'ğŸŸ ' : item.riskLevel === 'high' || item.risk_level === 'high' ? 'ğŸŸ¡' : item.riskLevel === 'mid' || item.risk_level === 'mid' ? 'ğŸ”µ' : 'ğŸŸ¢'}}</text>
            </view>
          </view>

          <view class="q-body">
            <view class="q-metrics">
              <view class="q-metric">
                <text class="q-metric-label">å¹³å‡æ’å</text>
                <text class="q-metric-value {{(item.avgRank || item.avg_rank) === 'æœªå…¥æ¦œ' ? 'unranked' : ''}}">{{item.avgRank || item.avg_rank}}</text>
              </view>
              <view class="q-metric">
                <text class="q-metric-label">æåŠç‡</text>
                <text class="q-metric-value">{{item.mentionCount || 0}}/{{item.totalModels || 0}}</text>
                <text class="q-metric-percent">{{item.mentionRate || item.mention_rate || 0}}%</text>
              </view>
              <view class="q-metric">
                <text class="q-metric-label">æƒ…æ„Ÿ</text>
                <text class="q-metric-value {{(item.avgSentiment || item.avg_sentiment) >= 0.3 ? 'positive' : (item.avgSentiment || item.avg_sentiment) <= -0.3 ? 'negative' : 'neutral'}}">{{item.avgSentiment || item.avg_sentiment}}</text>
              </view>
            </view>

            <view class="q-status {{item.riskLevel || item.risk_level || 'safe'}}">
              <text class="status-icon">{{item.riskLevel === 'critical' || item.risk_level === 'critical' ? 'ğŸš¨' : item.riskLevel === 'warning' || item.risk_level === 'warning' ? 'âš ï¸' : item.riskLevel === 'high' || item.risk_level === 'high' ? 'âš¡' : item.riskLevel === 'mid' || item.risk_level === 'mid' ? 'ğŸ“Š' : 'âœ…'}}</text>
              <text class="status-text">{{item.riskLevelText || item.risk_level_text || 'å®‰å…¨'}}</text>
            </view>
          </view>

          <!-- ç«å“æ‹¦æˆªè¯¦æƒ… -->
          <view class="q-footer" wx:if="{{item.key_competitor || (item.intercepted_by && item.intercepted_by.length > 0)}}">
            <view class="interception-banner">
              <view class="interception-header">
                <text class="interception-icon">ğŸ¯</text>
                <text class="interception-title">ç«å“æ‹¦æˆªåˆ†æ</text>
              </view>
              <view class="key-competitor" wx:if="{{item.key_competitor}}">
                <text class="competitor-label">ä¸»è¦æ‹¦æˆª:</text>
                <text class="competitor-name">{{item.key_competitor}}</text>
                <text class="competitor-count">({{item.interceptCount || 0}} æ¬¡)</text>
              </view>
              <view class="competitor-list" wx:if="{{item.intercepted_by && item.intercepted_by.length > 1}}">
                <block wx:for="{{item.intercepted_by}}" wx:key="*this" wx:for-item="competitor">
                  <view class="competitor-tag" wx:if="{{competitor !== item.key_competitor}}">
                    <text>{{competitor}}</text>
                  </view>
                </block>
              </view>
            </view>
          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- ç¬¬ä¸‰æ®µï¼šé«˜é£é™©è´Ÿé¢ä¿¡æº -->
  <view class="section" wx:if="{{toxicSources && toxicSources.length > 0}}">
    <view class="section-header">
      <view class="section-title">
        <text class="title-icon">ğŸš¨</text>
        <text class="title-text">é«˜é£é™©è´Ÿé¢ä¿¡æº</text>
      </view>
      <view class="section-subtitle">å…± {{toxicSources.length}} ä¸ªå±é™©ä¿¡æº</view>
    </view>

    <view class="toxic-sources-list">
      <block wx:for="{{toxicSources}}" wx:key="url">
        <view class="toxic-source-card threat-{{item.threatLevel || item.threat_level || 'safe'}}" bindtap="onSourceTap" data-source="{{item}}">
          <view class="ts-header">
            <view class="ts-site">
              <text class="ts-site-name">{{item.site_name || item.site}}</text>
              <view class="threat-score-badge {{item.threatLevel || item.threat_level || 'safe'}}">
                <text class="threat-score-label">å¨èƒåº¦</text>
                <text class="threat-score-value">{{item.threat_score || item.threatScore || 0}}</text>
              </view>
            </view>
            <view class="ts-tag negative">è´Ÿé¢</view>
          </view>
          <view class="ts-url">{{item.url}}</view>
          <view class="ts-footer">
            <text class="ts-model">æåŠ {{item.totalMentions || item.total_mentions || 0}} æ¬¡</text>
            <text class="ts-impact">å½±å“æ’å</text>
            <text class="ts-copy">ğŸ“‹ å¤åˆ¶é“¾æ¥</text>
          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!toxicSources || toxicSources.length === 0}}">
    <view class="empty-icon">âœ…</view>
    <view class="empty-text">æœªå‘ç°é«˜é£é™©è´Ÿé¢ä¿¡æº</view>
    <view class="empty-sub">å“ç‰Œå£°èª‰çŠ¶å†µè‰¯å¥½</view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar">
    <button class="btn-secondary" bindtap="viewHistory">ğŸ“‹ å†å²è®°å½•</button>
    <button class="btn-primary" bindtap="exportReport">å¯¼å‡ºæŠ¥å‘Š</button>
  </view>
</view>

<!-- åŠ è½½ä¸­çŠ¶æ€ -->
<view class="loading-container" wx:elif="{{!loadError}}">
  <view class="loading-spinner"></view>
  <view class="loading-text">æ­£åœ¨ç”Ÿæˆæˆ˜ç•¥çœ‹æ¿...</view>
</view>

<!-- é”™è¯¯çŠ¶æ€ -->
<view class="error-container" wx:else>
  <view class="error-icon">âš ï¸</view>
  <view class="error-title">{{errorType === 'network' ? 'ç½‘ç»œè¿æ¥å¤±è´¥' : errorType === 'timeout' ? 'è¯·æ±‚è¶…æ—¶' : 'æ•°æ®åŠ è½½å¤±è´¥'}}</view>
  <view class="error-text">{{loadError}}</view>
  <view class="error-actions">
    <button class="btn-retry" bindtap="retry">é‡æ–°åŠ è½½</button>
    <button class="btn-home" bindtap="goHome">è¿”å›é¦–é¡µ</button>
  </view>
</view>
