<!--pages/report/history/history.wxml-->
<!--
  æŠ¥å‘Šå†å²é¡µ
  åŠŸèƒ½:
  - å±•ç¤ºæ‰€æœ‰å†å²è¯Šæ–­æŠ¥å‘Š
  - æ”¯æŒæŒ‰æ—¶é—´ã€å“ç‰Œç­›é€‰
  - æ”¯æŒè·³è½¬åˆ°æŠ¥å‘Šè¯¦æƒ…
  - æ”¯æŒä¸‹æ‹‰åˆ·æ–°
-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <skeleton type="list"></skeleton>
  </view>

  <!-- æ•°æ®å†…å®¹ -->
  <view wx:else-if="{{!loading && reports.length > 0}}" class="content-wrapper">
    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <view class="stats-bar">
      <text class="stats-text">å…± {{reports.length}} ä»½è¯Šæ–­æŠ¥å‘Š</text>
      <text class="stats-hint">æŒ‰æ—¶é—´å€’åº</text>
    </view>

    <!-- ç­›é€‰æ  -->
    <view class="filter-bar">
      <view class="filter-item {{sortBy === 'time' ? 'active' : ''}}" bindtap="changeSort" data-sort="time">
        <text class="filter-icon">ğŸ“…</text>
        <text class="filter-text">æ—¶é—´</text>
      </view>
      <view class="filter-item {{sortBy === 'score' ? 'active' : ''}}" bindtap="changeSort" data-sort="score">
        <text class="filter-icon">ğŸ“Š</text>
        <text class="filter-text">è¯„åˆ†</text>
      </view>
      <view class="filter-item {{sortBy === 'brand' ? 'active' : ''}}" bindtap="changeSort" data-sort="brand">
        <text class="filter-icon">ğŸ·ï¸</text>
        <text class="filter-text">å“ç‰Œ</text>
      </view>
    </view>

    <!-- æŠ¥å‘Šåˆ—è¡¨ -->
    <view class="reports-list">
      <view
        class="report-card"
        wx:for="{{reports}}"
        wx:key="executionId"
        bindtap="viewDetail"
        data-item="{{item}}"
      >
        <!-- å¡ç‰‡å¤´éƒ¨ -->
        <view class="card-header">
          <view class="brand-info">
            <text class="brand-name">{{item.brandName || item.brand || 'å“ç‰Œè¯Šæ–­'}}</text>
            <text class="report-date">{{item.diagnoseTime || item.createdAt || 'æœªçŸ¥æ—¶é—´'}}</text>
          </view>
          <view class="report-badge {{item.healthScore >= 80 ? 'excellent' : item.healthScore >= 60 ? 'good' : 'normal'}}">
            <text class="badge-score">{{item.healthScore || 0}}</text>
            <text class="badge-label">åˆ†</text>
          </view>
        </view>

        <!-- å¡ç‰‡å†…å®¹ -->
        <view class="card-body">
          <!-- æ ¸å¿ƒæŒ‡æ ‡ -->
          <view class="metrics-row">
            <view class="metric-item">
              <text class="metric-icon">ğŸ“¢</text>
              <text class="metric-value">{{item.sov || 0}}%</text>
              <text class="metric-label">AI å£°é‡</text>
            </view>
            <view class="metric-divider"></view>
            <view class="metric-item">
              <text class="metric-icon">ğŸ’¬</text>
              <text class="metric-value {{item.avgSentiment >= 0.3 ? 'positive' : item.avgSentiment <= -0.3 ? 'negative' : 'normal'}}">{{item.avgSentiment || 0}}</text>
              <text class="metric-label">æƒ…æ„Ÿ</text>
            </view>
            <view class="metric-divider"></view>
            <view class="metric-item">
              <text class="metric-icon">â“</text>
              <text class="metric-value">{{item.questionCount || 0}}</text>
              <text class="metric-label">é—®é¢˜æ•°</text>
            </view>
          </view>

          <!-- æ‰§è¡Œ IDï¼ˆç”¨äºè°ƒè¯•ï¼‰ -->
          <view class="execution-id" wx:if="{{showExecutionId}}">
            <text class="id-label">ID:</text>
            <text class="id-value">{{item.executionId}}</text>
          </view>
        </view>

        <!-- å¡ç‰‡åº•éƒ¨ -->
        <view class="card-footer">
          <view class="view-detail-btn">
            <text>æŸ¥çœ‹è¯¦æƒ…</text>
            <text class="arrow-icon">â€º</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:else-if="{{!loading && reports.length === 0}}" class="empty-state">
    <view class="empty-icon">ğŸ“‹</view>
    <view class="empty-title">æš‚æ— å†å²æŠ¥å‘Š</view>
    <view class="empty-subtitle">å®Œæˆé¦–æ¬¡å“ç‰Œè¯Šæ–­åï¼ŒæŠ¥å‘Šå°†è‡ªåŠ¨ä¿å­˜åœ¨è¿™é‡Œ</view>
    <button class="go-home-btn" bindtap="goHome">å»è¯Šæ–­</button>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view wx:else-if="{{error}}" class="error-state">
    <view class="error-icon">âš ï¸</view>
    <view class="error-text">{{error}}</view>
    <button class="retry-btn" bindtap="retry">é‡æ–°åŠ è½½</button>
  </view>
</view>
