<view class="container">
  <!-- 动态背景 -->
  <canvas type="2d" id="particle-canvas" class="particle-canvas" disable-scroll="true"></canvas>

  <!-- 吸顶效果：当滚动时显示的总分栏 -->
  <view class="sticky-header {{isSticky ? 'sticky' : ''}}">
    <view class="score-summary">
      <text class="score-label">总分</text>
      <text class="score-value number-font">{{calculateTotalScore()}}</text>
      <text class="score-trend">{{getTrendIndicator()}}</text>
    </view>
  </view>

  <view class="content-wrapper">
    <!-- 标题 -->
    <view class="title-section">
      <text class="main-title">AI搜索品牌影响力监测</text>
      <text class="subtitle">驾驭AI，重塑品牌影响力</text>
    </view>

    <!-- 战术布局区 -->
    <view class="battlefield-section">
      <!-- 我方阵营 -->
      <view class="camp-section my-brand-camp">
        <view class="camp-title">我方品牌</view>
        <view class="brand-input-wrapper">
          <input class="brand-input" placeholder="输入品牌名称" value="{{brandName}}" bindinput="onBrandNameInput"/>
        </view>
      </view>

      <view class="vs-icon">VS</view>

      <!-- 敌方阵营 -->
      <view class="camp-section competitor-camp">
        <view class="camp-title">竞争品牌</view>
        <view class="brand-input-wrapper">
          <input class="brand-input" placeholder="添加竞品" value="{{currentCompetitor}}" bindinput="onCompetitorInput" bindconfirm="addCompetitor"/>
          <view class="add-icon-btn" bindtap="addCompetitor">+</view>
        </view>
        <view class="competitor-list">
          <view class="competitor-card" wx:for="{{competitorBrands}}" wx:key="index">
            <text class="competitor-name">{{item}}</text>
            <view class="remove-icon" bindtap="removeCompetitor" data-index="{{index}}">×</view>
          </view>
        </view>
      </view>
    </view>

    <!-- 高级设置开关 -->
    <view class="advanced-toggle" bindtap="toggleAdvancedSettings">
      <text class="setting-icon icon-settings"></text>
      <text>高级设置</text>
      <view class="arrow {{showAdvancedSettings ? 'expanded' : ''}}">›</view>
    </view>

    <!-- 高级设置 -->
    <view class="advanced-settings-section {{showAdvancedSettings ? 'visible' : ''}}">
      <!-- 保存配置按钮 -->
      <view class="setting-block">
        <button class="save-config-btn" bindtap="showSaveConfigModal">💾 保存当前配置</button>
      </view>

      <!-- 自定义问题输入 -->
      <view class="setting-block">
        <view class="setting-title">
          <text>自定义诊断问题</text>
          <text class="setting-subtitle">更精准地探测AI认知</text>
        </view>
        <view class="questions-container">
          <view class="question-item" wx:for="{{customQuestions}}" wx:key="index" wx:if="{{item.show !== false}}">
            <view class="question-input-wrapper">
              <input
                class="question-input"
                placeholder="问题 {{index + 1}} (例如：XX服务哪家好？)"
                value="{{item.text}}"
                bindinput="onCustomQuestionInput"
                data-index="{{index}}"
              />
              <view class="remove-question-btn" bindtap="removeCustomQuestion" data-index="{{index}}">×</view>
            </view>
          </view>
          <view class="add-question-btn" bindtap="addCustomQuestion">
            <text>+ 添加问题</text>
          </view>
        </view>
      </view>

      <!-- AI模型选择 -->
      <view class="setting-block">
        <view class="setting-title">
          <text>AI平台矩阵</text>
          <text class="setting-subtitle">选择您想诊断的AI平台</text>
        </view>
        <view class="ai-model-selection">
          <!-- 国内AI模型 -->
          <view class="ai-category">
            <view class="category-header">
              <text class="category-title">国内AI平台</text>
              <button class="select-all-btn" bindtap="selectAllModels" data-type="domestic">全选</button>
            </view>
            <view class="model-grid">
              <view class="model-chip-pro {{item.checked ? 'checked' : ''}} {{item.disabled ? 'disabled' : ''}}" wx:for="{{domesticAiModels}}" wx:key="name" bindtap="toggleModelSelection" data-type="domestic" data-index="{{index}}">
                <view class="logo-placeholder">{{item.logo || item.name.substring(0,2)}}</view>
                <text class="model-name">{{item.name}}</text>
                <view class="tag-list">
                  <text class="tag" wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this">{{tag}}</text>
                </view>
                <view class="check-icon">✓</view>
              </view>
            </view>
          </view>
          <!-- 海外AI模型 -->
          <view class="ai-category">
            <view class="category-header">
              <text class="category-title">海外AI平台</text>
              <button class="select-all-btn" bindtap="selectAllModels" data-type="overseas">全选</button>
            </view>
            <view class="model-grid">
              <view class="model-chip-pro {{item.checked ? 'checked' : ''}}" wx:for="{{overseasAiModels}}" wx:key="name" bindtap="toggleModelSelection" data-type="overseas" data-index="{{index}}">
                <view class="logo-placeholder">{{item.logo || item.name.substring(0,2)}}</view>
                <text class="model-name">{{item.name}}</text>
                <view class="tag-list">
                  <text class="tag" wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this">{{tag}}</text>
                </view>
                <view class="check-icon">✓</view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 保存配置模态框 -->
    <view class="modal-overlay" wx:if="{{showSaveModal}}">
      <view class="modal-content">
        <view class="modal-header">
          <text>保存当前配置</text>
          <text class="close-btn" bindtap="hideSaveConfigModal">✕</text>
        </view>
        <view class="modal-body">
          <input class="config-name-input" placeholder="请输入配置名称" value="{{configName}}" bindinput="onConfigNameInput"/>
        </view>
        <view class="modal-footer">
          <button class="modal-cancel-btn" bindtap="hideSaveConfigModal">取消</button>
          <button class="modal-confirm-btn" bindtap="saveCurrentConfig">保存</button>
        </view>
      </view>
    </view>

    <!-- 主操作按钮 -->
    <view class="main-action-section">
      <button class="scan-button" bindtap="startBrandTest" disabled="{{isTesting}}">
        <text wx:if="{{!isTesting}}">AI品牌战略诊断</text>
        <text wx:else>诊断中...</text>
      </button>
    </view>

    <!-- Zone A: 决策驾驶舱 (The Commander View) -->
    <!-- 分析卡片：显示当前任务状态 -->
    <analysis-card
      title="AI品牌认知诊断"
      subtitle="实时监控AI对品牌的认知状态"
      status="{{currentStage}}"
      progress="{{testProgress}}"
      data="{{reportData}}"
      loading="{{isTesting}}"
      wx:if="{{isTesting || reportData}}">
    </analysis-card>

    <!-- Zone B: 维度雷达 (The Analyst View) -->
    <!-- 新增：综合分析图表组件 -->
    <analysis-charts
      radar-data="{{scoreData}}"
      trend-data="{{trendChartData}}"
      loading="{{isTesting}}"
      wx:if="{{reportData}}">
    </analysis-charts>

    <!-- 评分雷达图：展示多维度评分 (备用) -->
    <score-radar
      title="品牌认知评分雷达图"
      scores="{{scoreData}}"
      loading="{{isTesting}}"
      wx:if="{{reportData && !analysisChartsEnabled}}">
    </score-radar>

    <!-- 趋势图表：展示品牌认知趋势 (备用) -->
    <trend-chart
      title="品牌认知趋势分析"
      chart-data="{{trendChartData}}"
      prediction-data="{{predictionData}}"
      loading="{{isTesting}}"
      wx:if="{{reportData && !analysisChartsEnabled}}">
    </trend-chart>

    <!-- Zone C: 战场态势 (The Battlefield) -->
    <!-- 竞品攻防矩阵：展示品牌占位情况 -->
    <competitor-matrix
      competition-data="{{competitionData}}"
      loading="{{isTesting}}"
      wx:if="{{reportData}}">
    </competitor-matrix>

    <!-- Zone D: 证据链 (The Evidence) -->
    <!-- 信源卡片：展示数据来源 -->
    <source-card
      title="证据链 (Source of Truth)"
      sources="{{sourceListData}}"
      loading="{{isTesting}}"
      wx:if="{{reportData}}">
    </source-card>

    <!-- 内容区域入场动画包装 -->
    <view class="content-animation-wrapper {{contentVisible ? 'visible' : ''}}" wx:if="{{reportData}}">
      <!-- 战略战局中心入口 -->
      <view class="strategic-war-room-entry">
        <button class="war-room-btn" bindtap="navigateToDetail">
          <text>战略战局中心</text>
          <text class="btn-arrow">›</text>
        </button>
      </view>
    </view>

    <!-- Debug 区域：显示后端返回的原始 JSON -->
    <view class="debug-section" wx:if="{{debugJson && isTesting}}">
      <view class="debug-header">
        <text class="debug-title">Debug 信息</text>
      </view>
      <view class="debug-content">
        <text class="debug-json">{{debugJson}}</text>
      </view>
    </view>

    <!-- 配置管理入口 -->
    <view class="config-manager-link-section" wx:if="{{!isTesting}}">
      <view class="config-manager-link" bindtap="viewConfigManager">
        <text>管理保存的配置</text>
        <text class="arrow-right">›</text>
      </view>
    </view>

    <!-- 权限管理入口 -->
    <view class="permission-manager-link-section" wx:if="{{!isTesting}}">
      <view class="permission-manager-link" bindtap="viewPermissionManager">
        <text>权限管理</text>
        <text class="arrow-right">›</text>
      </view>
    </view>

    <!-- 数据管理入口 -->
    <view class="data-manager-link-section" wx:if="{{!isTesting}}">
      <view class="data-manager-link" bindtap="viewDataManager">
        <text>数据管理</text>
        <text class="arrow-right">›</text>
      </view>
    </view>

    <!-- 使用指南入口 -->
    <view class="user-guide-link-section" wx:if="{{!isTesting}}">
      <view class="user-guide-link" bindtap="viewUserGuide">
        <text>使用指南</text>
        <text class="arrow-right">›</text>
      </view>
    </view>

    <!-- 历史记录入口 -->
    <view class="history-link-section" wx:if="{{!isTesting}}">
      <view class="history-link" bindtap="viewHistory">
        <text>查看历史诊断报告</text>
        <text class="arrow-right">›</text>
      </view>
    </view>

    <!-- 服务器设置入口 -->
    <view class="server-setting-section" wx:if="{{!isTesting}}">
      <view class="server-setting-link" bindtap="setCustomServerUrl">
        <text>设置API服务器地址</text>
        <text class="arrow-right">›</text>
      </view>
    </view>
  </view>
</view>