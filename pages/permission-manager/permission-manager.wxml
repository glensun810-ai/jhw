<!-- æƒé™ç®¡ç†é¡µ - P1 çº§ç©ºç¼ºä¿®å¤ -->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½æƒé™æ•°æ®ä¸­...</text>
  </view>

  <!-- æ•°æ®å†…å®¹ -->
  <view wx:else-if="{{!loading && permissionsData}}" class="content-wrapper">
    <!-- å½“å‰ç”¨æˆ·æƒé™æ‘˜è¦ -->
    <view class="summary-card">
      <view class="summary-header">
        <text class="summary-title">æˆ‘çš„æƒé™</text>
        <text class="summary-user-id">{{userId}}</text>
      </view>
      
      <view class="summary-tags">
        <view class="tag role-tag" wx:for="{{permissionsData.role_names}}" wx:key="*this">
          ğŸ·ï¸ {{item}}
        </view>
        <view class="tag permission-tag" wx:for="{{permissionsData.permission_names}}" wx:key="*this">
          âœ… {{item}}
        </view>
      </view>
    </view>

    <!-- æ‰€æœ‰æƒé™åˆ—è¡¨ -->
    <view class="section">
      <view class="section-header">
        <text class="section-title">æ‰€æœ‰æƒé™</text>
        <text class="section-count">{{allPermissions.length}} ä¸ª</text>
      </view>
      
      <view class="permission-list">
        <view class="permission-item" wx:for="{{allPermissions}}" wx:key="id">
          <view class="permission-info">
            <text class="permission-name">{{item.name}}</text>
            <text class="permission-desc">{{item.description}}</text>
          </view>
          <view class="permission-status">
            <text class="status-badge {{hasPermission(item.id) ? 'active' : 'inactive'}}">
              {{hasPermission(item.id) ? 'å·²æ‹¥æœ‰' : 'æœªæ‹¥æœ‰'}}
            </text>
          </view>
        </view>
      </view>
    </view>

    <!-- è§’è‰²åˆ—è¡¨ -->
    <view class="section">
      <view class="section-header">
        <text class="section-title">æ‰€æœ‰è§’è‰²</text>
        <text class="section-count">{{allRoles.length}} ä¸ª</text>
      </view>
      
      <view class="role-list">
        <view class="role-item" wx:for="{{allRoles}}" wx:key="id">
          <view class="role-info">
            <view class="role-header">
              <text class="role-name">ğŸ·ï¸ {{item.name}}</text>
              <text class="role-permission-count">{{item.permission_count}} æƒé™</text>
            </view>
            <text class="role-desc">{{item.description}}</text>
            <text class="role-user-count">å·²åˆ†é… {{item.user_count}} äºº</text>
          </view>
          <view class="role-actions" wx:if="{{hasRole('admin')}}">
            <button class="action-btn" bindtap="onAssignRole" data-role="{{item}}">åˆ†é…</button>
          </view>
        </view>
      </view>
    </view>

    <!-- æˆäºˆæƒé™è¡¨å• (ä»…ç®¡ç†å‘˜) -->
    <view class="section" wx:if="{{hasRole('admin')}}">
      <view class="section-header">
        <text class="section-title">æˆäºˆæƒé™</text>
      </view>
      
      <view class="grant-form">
        <view class="form-item">
          <text class="form-label">ç”¨æˆ· ID</text>
          <input class="form-input" placeholder="è¾“å…¥ç”¨æˆ· ID" value="{{grantForm.userId}}" bindinput="onGrantUserIdInput"/>
        </view>
        
        <view class="form-item">
          <text class="form-label">é€‰æ‹©æƒé™</text>
          <picker class="form-picker" range="{{allPermissions}}" range-key="name" value="{{grantForm.permissionIndex}}" bindchange="onGrantPermissionChange">
            <text class="form-picker-value">{{grantForm.permissionIndex >= 0 ? allPermissions[grantForm.permissionIndex].name : 'è¯·é€‰æ‹©æƒé™'}}</text>
          </picker>
        </view>
        
        <view class="form-item">
          <text class="form-label">æˆæƒåŸå› </text>
          <textarea class="form-textarea" placeholder="è¯·è¾“å…¥æˆæƒåŸå› " value="{{grantForm.reason}}" bindinput="onGrantReasonInput"/>
        </view>
        
        <view class="form-item">
          <text class="form-label">è¿‡æœŸå¤©æ•°</text>
          <input class="form-input" type="number" placeholder="ç•™ç©ºè¡¨ç¤ºæ°¸ä¸è¿‡æœŸ" value="{{grantForm.expiresDays}}" bindinput="onGrantExpiresInput"/>
        </view>
        
        <button class="grant-btn" bindtap="onGrantPermission">æˆäºˆæƒé™</button>
      </view>
    </view>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view wx:if="{{error}}" class="error-container">
    <text class="error-icon">âš ï¸</text>
    <text class="error-text">{{error}}</text>
    <button class="retry-btn" bindtap="retry">é‡æ–°åŠ è½½</button>
  </view>
</view>
