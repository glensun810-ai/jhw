<view class="page-container detail-container">
  <!-- åŠ¨æ€èƒŒæ™¯ -->
  <canvas type="2d" id="particle-canvas" class="particle-canvas" disable-scroll="true"></canvas>

  <view class="content-wrapper">
    <!-- æˆ˜ç•¥æˆ˜å±€ä¸­å¿ƒæ ‡é¢˜ -->
    <view class="title-section">
      <text class="main-title">{{customQuestion || 'å“ç‰ŒGEOæˆ˜ç•¥å¯¹é˜µä¸­å¿ƒ'}}</text>
      <text class="subtitle">é«˜ä¿¡æ¯å¯†åº¦å†³ç­–ä»ªè¡¨ç›˜</text>
    </view>

    <!-- æ—¶é—´é¢„ä¼°ä¸è¿›åº¦æ˜¾ç¤º -->
    <view class="time-estimation-section" wx:if="{{isLoading}}">
      <!-- å–æ¶ˆè¯Šæ–­æŒ‰é’® -->
      <view class="cancel-diagnosis-btn" bindtap="cancelDiagnosis">
        <text class="cancel-icon">âŒ</text>
        <text class="cancel-text">å–æ¶ˆè¯Šæ–­</text>
      </view>

      <!-- è®¢é˜…æ¶ˆæ¯æŒ‰é’® -->
      <view class="subscribe-btn {{isSubscribed ? 'subscribed' : ''}}" bindtap="requestMessageSubscription" wx:if="{{!isSubscribed}}">
        <text class="subscribe-icon">ğŸ””</text>
        <text class="subscribe-text">è®¢é˜…å®Œæˆé€šçŸ¥</text>
      </view>
      <view class="time-estimate">
        <text class="estimate-label">ğŸ“Š æ·±åº¦ç ”åˆ¤å¯åŠ¨ï¼š</text>
        <text class="estimate-value number-font">é¢„è®¡è€—æ—¶ {{estimatedTime}}s</text>
      </view>

      <!-- è¿›åº¦æ¡å®¹å™¨ -->
      <view class="progress-container">
        <view class="progress-inner" style="width: {{progress}}%; background: {{getProgressColor(progress)}};"></view>
      </view>

      <!-- è¿›åº¦æ–‡æœ¬ -->
      <view class="progress-text-container">
        <text class="progress-text">{{progressText}}</text>
        <text class="progress-percentage number-font">{{progress}}%</text>
      </view>
      
      <!--ã€P0 æ–°å¢ã€‘è¯¦ç»†è¿›åº¦æ˜¾ç¤º -->
      <view class="progress-detail-container" wx:if="{{progressDetail}}">
        <text class="progress-detail">{{progressDetail}}</text>
      </view>

      <!--ã€P0 æ–°å¢ã€‘Insight Pulse æ™ºèƒ½çŸ¥è¯†è·‘é©¬ç¯ -->
      <view class="insight-pulse-container" wx:if="{{currentTip}}">
        <view class="insight-pulse-header">
          <text class="pulse-icon">ğŸ’¡</text>
          <text class="pulse-title">Insight Pulse Â· å•†ä¸šæ´å¯Ÿ</text>
        </view>
        <view class="insight-pulse-content">
          <text class="insight-text">{{currentTip}}</text>
        </view>
      </view>
      
      <!--ã€é˜¶æ®µ 1ã€‘å®æ—¶ç»Ÿè®¡æ˜¾ç¤º -->
      <view class="realtime-stats-container" wx:if="{{realtimeStats && realtimeStats.completed > 0}}">
        <view class="stats-header">
          <text class="stats-title">ğŸ“Š å®æ—¶ç»Ÿè®¡</text>
          <text class="stats-subtitle">å·²å¤„ç† {{realtimeStats.completed}}/{{realtimeStats.total}}</text>
        </view>
        
        <view class="stats-grid">
          <view class="stat-item">
            <text class="stat-value highlight">{{realtimeSov}}%</text>
            <text class="stat-label">SOV</text>
          </view>
          <view class="stat-item">
            <text class="stat-value {{realtimeSentiment >= 0.5 ? 'positive' : realtimeSentiment >= 0.3 ? 'neutral' : 'negative'}}">{{realtimeSentiment}}</text>
            <text class="stat-label">æƒ…æ„Ÿ</text>
          </view>
          <view class="stat-item">
            <text class="stat-value">{{brandRankings.length}}</text>
            <text class="stat-label">å“ç‰Œå·²æ’å</text>
          </view>
        </view>
        
        <!-- å“ç‰Œå®æ—¶æ’å -->
        <view class="brand-rankings-container" wx:if="{{brandRankings.length > 0}}">
          <text class="rankings-title">ğŸ† å“ç‰Œå®æ—¶æ’å</text>
          <view class="rankings-list">
            <block wx:for="{{brandRankings}}" wx:key="brand">
              <view class="ranking-item {{item.is_main_brand ? 'main-brand' : ''}}">
                <view class="ranking-left">
                  <text class="ranking-rank">#{{item.rank}}</text>
                  <text class="ranking-brand">{{item.brand}}</text>
                  <text class="ranking-main" wx:if="{{item.is_main_brand}}">ä¸»å“ç‰Œ</text>
                </view>
                <view class="ranking-right">
                  <text class="ranking-responses">{{item.responses}}å“åº”</text>
                  <text class="ranking-sentiment">æƒ…æ„Ÿ{{item.avg_sentiment}}</text>
                </view>
              </view>
            </block>
          </view>
        </view>
      </view>
      
      <!--ã€é˜¶æ®µ 2ã€‘èšåˆç»“æœæ˜¾ç¤º -->
      <view class="aggregated-results-container" wx:if="{{aggregatedResults && aggregatedResults.summary}}">
        <view class="results-header">
          <text class="results-title">ğŸ“ˆ èšåˆåˆ†æç»“æœ</text>
          <text class="results-subtitle">å¥åº·åº¦ï¼š{{healthScore}}åˆ†</text>
        </view>
        
        <view class="results-grid">
          <view class="result-item">
            <view class="result-value {{healthScore >= 80 ? 'excellent' : healthScore >= 60 ? 'good' : 'warning'}}">{{healthScore}}</view>
            <text class="result-label">å¥åº·åº¦</text>
          </view>
          <view class="result-item">
            <view class="result-value">{{aggregatedResults.summary.sov}}%</view>
            <text class="result-label">SOV</text>
          </view>
          <view class="result-item">
            <view class="result-value">{{aggregatedResults.summary.avgSentiment}}</view>
            <text class="result-label">æƒ…æ„Ÿ</text>
          </view>
          <view class="result-item">
            <view class="result-value">{{aggregatedResults.summary.successRate}}%</view>
            <text class="result-label">æˆåŠŸç‡</text>
          </view>
        </view>
        
        <!-- å“ç‰Œæ’åè¯¦æƒ… -->
        <view class="brand-rankings-detail" wx:if="{{aggregatedResults.brand_rankings && aggregatedResults.brand_rankings.length > 0}}">
          <text class="rankings-detail-title">ğŸ† å“ç‰Œæ’åè¯¦æƒ…</text>
          <view class="rankings-detail-list">
            <block wx:for="{{aggregatedResults.brand_rankings}}" wx:key="brand">
              <view class="ranking-detail-item {{item.is_main_brand ? 'main-brand' : ''}}">
                <view class="ranking-detail-header">
                  <text class="ranking-detail-rank">#{{item.rank}}</text>
                  <text class="ranking-detail-brand">{{item.brand}}</text>
                  <text class="ranking-detail-main" wx:if="{{item.is_main_brand}}">ä¸»å“ç‰Œ</text>
                </view>
                <view class="ranking-detail-stats">
                  <view class="detail-stat">
                    <text class="detail-stat-label">å“åº”æ•°</text>
                    <text class="detail-stat-value">{{item.responses}}</text>
                  </view>
                  <view class="detail-stat">
                    <text class="detail-stat-label">SOV</text>
                    <text class="detail-stat-value">{{item.sov_share}}%</text>
                  </view>
                  <view class="detail-stat">
                    <text class="detail-stat-label">æƒ…æ„Ÿ</text>
                    <text class="detail-stat-value">{{item.avg_sentiment}}</text>
                  </view>
                  <view class="detail-stat" wx:if="{{item.avg_rank > 0}}">
                    <text class="detail-stat-label">å¹³å‡æ’å</text>
                    <text class="detail-stat-value">{{item.avg_rank}}</text>
                  </view>
                </view>
              </view>
            </block>
          </view>
        </view>
      </view>

      <!-- ã€P0 æ–°å¢ã€‘é¢„è®¡å‰©ä½™æ—¶é—´ -->
      <view class="remaining-time" wx:if="{{remainingTime > 0 || smoothedRemainingTime}}">
        <text class="remaining-label">â±ï¸ é¢„è®¡å‰©ä½™ï¼š</text>
        <text class="remaining-value number-font">{{smoothedRemainingTime || formatTime(remainingTime)}}</text>
      </view>

      <!-- ã€P1-4 æ–°å¢ã€‘è¿›åº¦è­¦å‘Š -->
      <view class="progress-warning" wx:if="{{progressWarnings.length > 0}}">
        <text class="warning-icon">âš ï¸</text>
        <text class="warning-text" wx:for="{{progressWarnings}}" wx:key="*this">{{item}}</text>
      </view>

      <!-- ã€P1-6 æ–°å¢ã€‘é˜¶æ®µè¯´æ˜ -->
      <view class="stage-description" wx:if="{{stageDescription}}">
        <text class="stage-label">ğŸ“ å½“å‰é˜¶æ®µï¼š</text>
        <text class="stage-value">{{stageDescription}}</text>
      </view>

      <!-- ã€P0 æ–°å¢ã€‘ä»»åŠ¡çŠ¶æ€è¯¦æƒ… -->
      <view class="task-status-section">
        <view class="status-row completed" wx:if="{{completedTasks > 0}}">
          <text class="status-icon">âœ…</text>
          <text class="status-label">å·²å®Œæˆï¼š</text>
          <text class="status-value">{{completedTasks}}/{{totalTasks}}</text>
        </view>
        <view class="status-row current" wx:if="{{currentTask}}">
          <text class="status-icon">ğŸ”„</text>
          <text class="status-label">è¿›è¡Œä¸­ï¼š</text>
          <text class="status-value">{{currentTask}}</text>
        </view>
        <view class="status-row pending" wx:if="{{pendingTasks > 0}}">
          <text class="status-icon">â³</text>
          <text class="status-label">å¾…æ‰§è¡Œï¼š</text>
          <text class="status-value">{{pendingTasks}} ä»»åŠ¡</text>
        </view>
      </view>

      <!-- æƒŠå–œæ¶ˆæ¯ -->
      <view class="surprise-message" wx:if="{{showSurpriseMessage}}">
        <text class="surprise-text">{{surpriseMessage}}</text>
      </view>

      <!-- æ•°æ®æµåŠ¨ç”» -->
      <view class="data-flow-animation">
        <view class="dot"></view>
        <view class="dot"></view>
        <view class="dot"></view>
      </view>
    </view>

    <!-- é¡¶éƒ¨è§†å›¾åˆ‡æ¢å™¨ (ViewSwitcher) -->
    <view-switcher
      current-view="{{currentView}}"
      bind:viewChange="onViewChange">
    </view-switcher>

    <!-- å“ç‰Œé€‰æ‹©å™¨ï¼ˆä»…åœ¨æ¨¡å‹å¯¹é˜µè§†å›¾ä¸‹æ˜¾ç¤ºï¼‰ -->
    <view class="selector-container" wx:if="{{currentView === 'model'}}">
      <picker
        range="{{brandNames}}"
        value="{{selectedBrandIndex}}"
        bindchange="onBrandSelect">
        <view class="picker-view">
          <text class="picker-label">é€‰æ‹©å“ç‰Œ:</text>
          <text class="picker-value">{{brandNames[selectedBrandIndex]}}</text>
          <text class="picker-icon">â–¼</text>
        </view>
      </picker>
    </view>

    <!-- å¯¹é˜µçŸ©é˜µ (BattlefieldMatrix) -->
    <view class="battlefield-matrix-container">
      <!-- éª¨æ¶å± -->
      <skeleton type="paragraph" rows="10" loading="{{isLoading}}">
        <scroll-view class="matrix-scroll" scroll-x="{{true}}" scroll-y="{{true}}" enable-flex="true" wx:if="{{!isLoading && gridData && gridData.headers && gridData.rows && gridData.headers.length > 0 && gridData.rows.length > 0}}">
          <!-- è¡¨æ ¼å®¹å™¨ -->
          <view class="matrix-grid">
            <!-- è¡¨å¤´è¡Œ -->
            <view class="grid-header">
              <!-- å·¦ä¸Šè§’ç©ºç™½å•å…ƒæ ¼ -->
              <view class="cell corner-cell">
                {{currentView === 'model' ? 'é—®é¢˜' : 'é—®é¢˜'}}
              </view>

              <!-- å“ç‰Œ/æ¨¡å‹å¤´éƒ¨ -->
              <view
                class="cell header-cell brand-label"
                wx:for="{{gridData.headers.slice(1)}}"
                wx:key="index">
                {{item}}
              </view>
            </view>

            <!-- æ•°æ®è¡Œ -->
            <view class="grid-body">
              <view
                class="grid-row"
                wx:for="{{gridData.rows}}"
                wx:key="index">

                <!-- é—®é¢˜åˆ—ï¼ˆå›ºå®šï¼‰ -->
                <view class="cell question-cell sticky-left brand-label">
                  <text class="question-text">{{item[0]}}</text>
                </view>

                <!-- è¯„åˆ†å•å…ƒæ ¼ -->
                <view
                  class="cell score-cell brand-label"
                  wx:for="{{item.slice(1)}}"
                  wx:for-item="score"
                  wx:key="index2"
                  style="background: {{getScoreBgColor(score.score)}};"
                  data-brand="{{currentView === 'model' ? brandNames[selectedBrandIndex] : gridData.headers[index2+1]}}"
                  data-question="{{item[0]}}"
                  data-model="{{currentView === 'model' ? gridData.headers[index2+1] : 'All Models'}}"
                  data-score="{{score.score}}"
                  bindtap="showScoreTip">

                  <text class="score-number number-font">{{score.score || '-'}}</text>
                </view>
              </view>
            </view>
          </view>
        </scroll-view>

        <!-- æ— æ•°æ®æç¤º -->
        <view wx:else class="no-data-message">
          <text>æš‚æ— æ•°æ®</text>
        </view>
      </skeleton>
    </view>

    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
    <view class="stats-overview" wx:if="{{matrixData && !isLoading}}">
      <view class="stat-card">
        <text class="stat-label">å‚æµ‹å“ç‰Œ</text>
        <text class="stat-value number-font">{{matrixData.headers.length - 1}}</text>
      </view>
      <view class="stat-card">
        <text class="stat-label">è¯Šæ–­é—®é¢˜</text>
        <text class="stat-value number-font">{{matrixData.rows.length}}</text>
      </view>
      <view class="stat-card">
        <text class="stat-label">æ•°æ®å¯†åº¦</text>
        <text class="stat-value number-font">{{getMatrixDensity()}}%</text>
      </view>
    </view>
  </view>

  <!-- æƒ…æŠ¥æŠ½å±‰ -->
  <intelligence-drawer
    visible="{{showIntelligenceDrawer}}"
    data="{{intelligenceData}}"
    bind:close="onCloseIntelligenceDrawer">
  </intelligence-drawer>
</view>