# AI 平台区域一致性验证功能实现

## 功能说明

为了防止因网络连接问题导致的 AI 平台调用失败，系统现在要求用户在选择 AI 平台时，**不能同时选择国内和海外平台**。

## 实现细节

### 1. 平台区域分类 (`wechat_backend/ai_adapters/base_adapter.py`)

新增了以下代码：

- **`PlatformRegion` 枚举类**：定义平台区域类型
  - `DOMESTIC` (国内)
  - `OVERSEAS` (海外)

- **`PLATFORM_REGION_MAP` 映射表**：定义各平台所属区域

  **国内平台**：
  - deepseek (深度求索)
  - deepseekr1 (深度求索 R1)
  - qwen (通义千问 - 阿里)
  - wenxin (文心一言 - 百度)
  - doubao (豆包 - 字节)
  - kimi (月之暗面)
  - yuanbao (腾讯元宝)
  - spark (讯飞星火)
  - zhipu (智谱 AI)

  **海外平台**：
  - chatgpt (OpenAI)
  - claude (Anthropic)
  - gemini (Google)
  - openai (OpenAI)
  - anthropic (Anthropic)
  - google (Google)

- **`validate_model_region_consistency()` 函数**：验证所选模型是否来自同一区域

### 2. 验证逻辑集成 (`wechat_backend/views/diagnosis_views.py`)

在 `/api/perform-brand-test` 接口的输入验证阶段，添加了区域一致性检查：

```python
# P0- 新增：验证所选模型是否来自同一区域（国内或海外）
model_names = [model["name"] if isinstance(model, dict) else model for model in selected_models]
normalized_model_names = [AIAdapterFactory.get_normalized_model_name(name) for name in model_names]

is_valid, error_msg = validate_model_region_consistency(normalized_model_names)
if not is_valid:
    api_logger.warning(f"Model region consistency check failed: {error_msg}")
    return jsonify({
        "status": "error",
        "error": error_msg,
        "code": 400
    }), 400
```

## 错误提示

当用户同时选择国内和海外平台时，系统会返回如下错误：

```json
{
  "status": "error",
  "error": "不能同时选择国内和海外 AI 平台。国内平台：deepseek, qwen；海外平台：chatgpt, gemini。由于网络连接问题，请只选择国内平台或只选择海外平台。",
  "code": 400
}
```

## 验证流程

```
用户提交请求
    ↓
解析 selectedModels
    ↓
模型名称标准化
    ↓
平台可用性检查
    ↓
API Key 配置检查
    ↓
【新增】区域一致性检查 ←
    ↓
问题安全性验证
    ↓
执行测试
```

## 影响范围

- **主要接口**: `/api/perform-brand-test`
- **间接影响**: `regenerate_report` 接口（通过调用 `execute_nxm_test` 自动获得验证）
- **前端需要**: 在用户选择 AI 平台时，提供区域分组提示或限制

## 建议的前端改进

1. **分组展示**: 将 AI 平台按"国内"和"海外"分组展示
2. **互斥选择**: 当用户已选择国内平台时，禁用海外平台选项（反之亦然）
3. **清晰提示**: 在选择前明确告知用户"由于网络连接原因，只能选择同一区域的平台"

## 测试建议

1. 测试只选择国内平台（应通过）
2. 测试只选择海外平台（应通过）
3. 测试同时选择国内和海外平台（应失败，返回明确错误信息）
4. 测试混合对象和字符串格式的 selectedModels
