<!--
  æƒ…æŠ¥æµæ°´çº¿ç»„ä»¶ - å¢å¼ºç‰ˆ
  åŠŸèƒ½ï¼šå®æ—¶æ˜¾ç¤º AI è¯Šæ–­æƒ…æŠ¥æµï¼Œæ”¯æŒ SSE å®æ—¶æ›´æ–°
-->
<view class="intelligence-pipeline {{collapsed ? 'collapsed' : ''}} {{sseConnected ? 'sse-connected' : ''}}">
  <!-- å¤´éƒ¨ -->
  <view class="pipeline-header" bindtap="toggleCollapse">
    <view class="pipeline-title">
      <view class="pipeline-icon-wrapper {{isLive ? 'live' : ''}}">
        <text class="pipeline-icon">âš¡</text>
      </view>
      <text class="pipeline-text">æƒ…æŠ¥æµæ°´çº¿</text>
      <view class="live-indicator" wx:if="{{isLive}}">
        <view class="live-dot"></view>
        <text class="live-text">LIVE</text>
      </view>
      <view class="sse-status" wx:if="{{sseConnected}}">
        <text class="sse-icon">ğŸ“¡</text>
        <text class="sse-text">å®æ—¶</text>
      </view>
    </view>
    <view class="pipeline-actions">
      <view class="pipeline-count-wrapper">
        <text class="pipeline-count">{{completedCount}}/{{totalCount}}</text>
        <text class="count-label">å®Œæˆ</text>
      </view>
      <view class="collapse-icon-wrapper {{collapsed ? 'collapsed' : ''}}">
        <text class="collapse-icon">â–¼</text>
      </view>
    </view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="pipeline-content" wx:if="{{!collapsed}}">
    <!-- æƒ…æŠ¥åˆ—è¡¨ -->
    <scroll-view
      class="pipeline-scroll"
      scroll-y
      enhanced
      show-scrollbar="{{false}}"
      scroll-into-view="{{scrollIntoView}}"
      scroll-with-animation="true"
      bindscroll="onScroll"
    >
      <view class="pipeline-list">
        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-state" wx:if="{{items.length === 0 && !isLoading}}">
          <view class="empty-animation">
            <view class="empty-icon-wrapper">
              <text class="empty-icon">ğŸ“¡</text>
            </view>
            <text class="empty-text">ç­‰å¾…æƒ…æŠ¥æ•°æ®...</text>
            <text class="empty-sub">æ­£åœ¨è¿æ¥ AI æ¨¡å‹é›†ç¾¤</text>
            <view class="empty-loading">
              <view class="loading-ring"></view>
            </view>
          </view>
        </view>

        <!-- åŠ è½½ä¸­çŠ¶æ€ -->
        <view class="loading-state" wx:if="{{isLoading}}">
          <view class="loading-spinner-wrapper">
            <view class="loading-spinner"></view>
            <text class="loading-text">æ­£åœ¨è·å–æƒ…æŠ¥...</text>
          </view>
        </view>

        <!-- æƒ…æŠ¥é¡¹ -->
        <view
          class="intelligence-item item-{{item.status}}"
          wx:for="{{items}}"
          wx:key="id"
          id="item-{{item.id}}"
          data-item="{{item}}"
          bindtap="onItemTap"
        >
          <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
          <view class="item-status-wrapper">
            <view class="item-status status-{{item.status}}">
              <view class="status-ring" wx:if="{{item.status === 'processing'}}"></view>
              <text class="status-icon" wx:if="{{item.status === 'success'}}">âœ“</text>
              <text class="status-icon" wx:if="{{item.status === 'error'}}">!</text>
            </view>
            <view class="status-line"></view>
          </view>

          <!-- å†…å®¹å¡ç‰‡ -->
          <view class="item-card">
            <!-- å¤´éƒ¨ï¼šé—®é¢˜å’Œæ ‡ç­¾ -->
            <view class="item-header">
              <view class="item-question-wrapper">
                <text class="item-question">{{item.question}}</text>
              </view>
              <view class="item-badges">
                <view class="item-badge model-badge">
                  <text class="badge-icon">{{getModelIcon(item.model)}}</text>
                  <text class="badge-text">{{item.model}}</text>
                </view>
                <view class="item-badge status-badge status-{{item.status}}">
                  <text class="badge-text">{{statusText[item.status]}}</text>
                </view>
              </view>
            </view>

            <!-- å…ƒä¿¡æ¯ -->
            <view class="item-meta">
              <view class="item-meta-item">
                <text class="meta-icon">ğŸ•</text>
                <text class="meta-text">{{item.time}}</text>
              </view>
              <view class="item-meta-item" wx:if="{{item.latency}}">
                <text class="meta-icon">âš¡</text>
                <text class="meta-text">{{item.latency}}ms</text>
              </view>
              <view class="item-meta-item" wx:if="{{item.brand}}">
                <text class="meta-icon">ğŸ·ï¸</text>
                <text class="meta-text">{{item.brand}}</text>
              </view>
              <view class="item-meta-item" wx:if="{{item.metadata && item.metadata.tokens_used}}">
                <text class="meta-icon">ğŸ“Š</text>
                <text class="meta-text">{{item.metadata.tokens_used}} tokens</text>
              </view>
            </view>

            <!-- å“åº”é¢„è§ˆï¼ˆæˆåŠŸçŠ¶æ€ï¼‰ -->
            <view class="item-preview" wx:if="{{item.status === 'success' && item.preview}}">
              <view class="preview-label">
                <text class="label-icon">âœ¨</text>
                <text class="label-text">AI å“åº”</text>
              </view>
              <text class="preview-text">{{item.preview}}</text>
            </view>

            <!-- é”™è¯¯ä¿¡æ¯ï¼ˆé”™è¯¯çŠ¶æ€ï¼‰ -->
            <view class="item-error" wx:if="{{item.status === 'error' && item.error}}">
              <view class="error-wrapper">
                <text class="error-icon">âš ï¸</text>
                <text class="error-text">{{item.error}}</text>
              </view>
              <button class="retry-btn" bindtap="onRetryTap" data-item="{{item}}">
                <text>ğŸ”„</text>
                <text>é‡è¯•</text>
              </button>
            </view>
          </view>
        </view>

        <!-- åº•éƒ¨åŠ è½½æŒ‡ç¤ºå™¨ -->
        <view class="bottom-loading" wx:if="{{isLoading && items.length > 0}}">
          <view class="loading-dots">
            <view class="dot"></view>
            <view class="dot"></view>
            <view class="dot"></view>
          </view>
        </view>
      </view>
    </scroll-view>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="pipeline-footer">
      <view class="footer-stats">
        <view class="stat-item success">
          <view class="stat-value">{{successCount}}</view>
          <view class="stat-label">æˆåŠŸ</view>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item processing">
          <view class="stat-value">{{processingCount}}</view>
          <view class="stat-label">è¿›è¡Œä¸­</view>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item error">
          <view class="stat-value">{{errorCount}}</view>
          <view class="stat-label">å¤±è´¥</view>
        </view>
      </view>
      <view class="footer-actions">
        <button class="action-btn clear-btn" bindtap="clearItems" wx:if="{{items.length > 0}}">
          <text class="btn-icon">ğŸ—‘ï¸</text>
          <text class="btn-text">æ¸…ç©º</text>
        </button>
      </view>
    </view>
  </view>
</view>
