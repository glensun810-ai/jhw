<view class="detail-container">
  <!-- åŠ¨æ€èƒŒæ™¯ -->
  <canvas type="2d" id="particle-canvas" class="particle-canvas" disable-scroll="true"></canvas>

  <view class="content-wrapper">
    <!-- æˆ˜ç•¥æˆ˜å±€ä¸­å¿ƒæ ‡é¢˜ -->
    <view class="title-section">
      <text class="main-title">{{customQuestion || 'å“ç‰ŒGEOæˆ˜ç•¥å¯¹é˜µä¸­å¿ƒ'}}</text>
      <text class="subtitle">é«˜ä¿¡æ¯å¯†åº¦å†³ç­–ä»ªè¡¨ç›˜</text>
    </view>

    <!-- æ—¶é—´é¢„ä¼°ä¸è¿›åº¦æ˜¾ç¤º -->
    <view class="time-estimation-section" wx:if="{{isLoading}}">
      <view class="time-estimate">
        <text class="estimate-label">ğŸ“Š æ·±åº¦ç ”åˆ¤å¯åŠ¨ï¼š</text>
        <text class="estimate-value number-font">é¢„è®¡è€—æ—¶ {{estimatedTime}}s</text>
      </view>

      <!-- è¿›åº¦æ¡å®¹å™¨ -->
      <view class="progress-container">
        <view class="progress-inner" style="width: {{progress}}%; background: {{getProgressColor(progress)}};"></view>
      </view>

      <!-- è¿›åº¦æ–‡æœ¬ -->
      <view class="progress-text-container">
        <text class="progress-text">{{progressText}}</text>
        <text class="progress-percentage number-font">{{Math.min(100, Math.round(progress))}}%</text>
      </view>

      <!-- æƒŠå–œæ¶ˆæ¯ -->
      <view class="surprise-message" wx:if="{{showSurpriseMessage}}">
        <text class="surprise-text">{{surpriseMessage}}</text>
      </view>

      <!-- æ•°æ®æµåŠ¨ç”» -->
      <view class="data-flow-animation">
        <view class="dot"></view>
        <view class="dot"></view>
        <view class="dot"></view>
      </view>
    </view>

    <!-- é¡¶éƒ¨è§†å›¾åˆ‡æ¢å™¨ (ViewSwitcher) -->
    <view-switcher
      current-view="{{currentView}}"
      bind:viewChange="onViewChange">
    </view-switcher>

    <!-- å“ç‰Œé€‰æ‹©å™¨ï¼ˆä»…åœ¨æ¨¡å‹å¯¹é˜µè§†å›¾ä¸‹æ˜¾ç¤ºï¼‰ -->
    <view class="selector-container" wx:if="{{currentView === 'model'}}">
      <picker
        range="{{brandNames}}"
        value="{{selectedBrandIndex}}"
        bindchange="onBrandSelect">
        <view class="picker-view">
          <text class="picker-label">é€‰æ‹©å“ç‰Œ:</text>
          <text class="picker-value">{{brandNames[selectedBrandIndex]}}</text>
          <text class="picker-icon">â–¼</text>
        </view>
      </picker>
    </view>

    <!-- å¯¹é˜µçŸ©é˜µ (BattlefieldMatrix) -->
    <view class="battlefield-matrix-container">
      <!-- éª¨æ¶å± -->
      <skeleton type="paragraph" rows="10" loading="{{isLoading}}">
        <scroll-view class="matrix-scroll" scroll-x="{{true}}" scroll-y="{{true}}" enable-flex="true" wx:if="{{!isLoading && gridData && gridData.headers && gridData.rows && gridData.headers.length > 0 && gridData.rows.length > 0}}">
          <!-- è¡¨æ ¼å®¹å™¨ -->
          <view class="matrix-grid">
            <!-- è¡¨å¤´è¡Œ -->
            <view class="grid-header">
              <!-- å·¦ä¸Šè§’ç©ºç™½å•å…ƒæ ¼ -->
              <view class="cell corner-cell">
                {{currentView === 'model' ? 'é—®é¢˜' : 'é—®é¢˜'}}
              </view>

              <!-- å“ç‰Œ/æ¨¡å‹å¤´éƒ¨ -->
              <view
                class="cell header-cell brand-label"
                wx:for="{{gridData.headers.slice(1)}}"
                wx:key="index">
                {{item}}
              </view>
            </view>

            <!-- æ•°æ®è¡Œ -->
            <view class="grid-body">
              <view
                class="grid-row"
                wx:for="{{gridData.rows}}"
                wx:key="index">

                <!-- é—®é¢˜åˆ—ï¼ˆå›ºå®šï¼‰ -->
                <view class="cell question-cell sticky-left brand-label">
                  <text class="question-text">{{item[0]}}</text>
                </view>

                <!-- è¯„åˆ†å•å…ƒæ ¼ -->
                <view
                  class="cell score-cell brand-label"
                  wx:for="{{item.slice(1)}}"
                  wx:for-item="score"
                  wx:key="index2"
                  style="background: {{getScoreBgColor(score.score)}};"
                  data-brand="{{currentView === 'model' ? brandNames[selectedBrandIndex] : gridData.headers[index2+1]}}"
                  data-question="{{item[0]}}"
                  data-model="{{currentView === 'model' ? gridData.headers[index2+1] : 'All Models'}}"
                  data-score="{{score.score}}"
                  bindtap="showScoreTip">

                  <text class="score-number number-font">{{score.score || '-'}}</text>
                </view>
              </view>
            </view>
          </view>
        </scroll-view>

        <!-- æ— æ•°æ®æç¤º -->
        <view wx:else class="no-data-message">
          <text>æš‚æ— æ•°æ®</text>
        </view>
      </skeleton>
    </view>

    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
    <view class="stats-overview" wx:if="{{matrixData && !isLoading}}">
      <view class="stat-card">
        <text class="stat-label">å‚æµ‹å“ç‰Œ</text>
        <text class="stat-value number-font">{{matrixData.headers.length - 1}}</text>
      </view>
      <view class="stat-card">
        <text class="stat-label">è¯Šæ–­é—®é¢˜</text>
        <text class="stat-value number-font">{{matrixData.rows.length}}</text>
      </view>
      <view class="stat-card">
        <text class="stat-label">æ•°æ®å¯†åº¦</text>
        <text class="stat-value number-font">{{getMatrixDensity()}}%</text>
      </view>
    </view>
  </view>

  <!-- æƒ…æŠ¥æŠ½å±‰ -->
  <intelligence-drawer
    visible="{{showIntelligenceDrawer}}"
    data="{{intelligenceData}}"
    bind:close="onCloseIntelligenceDrawer">
  </intelligence-drawer>
</view>