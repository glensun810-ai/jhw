<view class="container" wx:if="{{!isLoading}}">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <text class="page-title">å“ç‰ŒAIæ´å¯ŸæŠ¥å‘Š</text>
    <text class="page-subtitle">é’ˆå¯¹â€œ{{targetBrand}}â€çš„AIè®¤çŸ¥ä¸å¸‚åœºæ ¼å±€åˆ†æ</text>
  </view>

  <!-- ç¬¬ä¸€å±‚ï¼šé«˜ç®¡æ‘˜è¦ (Executive Summary) -->
  <view class="section executive-summary-section">
    <view class="section-header">
      <text class="section-title">æˆ˜å†µå¤§ç›˜</text>
      <view class="overall-grade-display" wx:if="{{competitiveAnalysis.brandScores[targetBrand]}}">
        <text class="grade-label">ç»¼åˆè¯„çº§</text>
        <text class="grade-value {{competitiveAnalysis.brandScores[targetBrand].overallGrade}}">{{competitiveAnalysis.brandScores[targetBrand].overallGrade}}</text>
      </view>
    </view>

    <!-- ç«äº‰æ ¼å±€çƒ­åŠ›å›¾ -->
    <view class="score-matrix">
      <view class="matrix-row matrix-header-row">
        <view class="matrix-cell brand-header"></view>
        <view class="matrix-cell ai-header" wx:for="{{matrixHeaders}}" wx:key="*this">{{item}}</view>
      </view>
      <view class="matrix-row" wx:for="{{scoreMatrix}}" wx:for-item="row" wx:key="brand">
        <view class="matrix-cell brand-name {{row.brand === targetBrand ? 'is-target-brand' : ''}}">{{row.brand}}</view>
        <view class="matrix-cell score-cell"
              wx:for="{{matrixHeaders}}"
              wx:for-item="aiModel"
              wx:key="*this"
              style="background-color: {{tools.getHeatmapColor(row.scores[aiModel])}};">
          {{row.scores[aiModel] || '-'}}
        </view>
      </view>
    </view>

    <!-- æ ¸å¿ƒæ´å¯Ÿæ‘˜è¦ -->
    <view class="insight-summary">
      <view class="insight-item" wx:if="{{executiveSummary.mainThreat}}">
        <text class="insight-icon">ğŸš¨</text>
        <text class="insight-text">ä¸»è¦å¨èƒï¼š{{executiveSummary.mainThreat}}</text>
      </view>
      <view class="insight-item" wx:if="{{executiveSummary.mainOpportunity}}">
        <text class="insight-icon">ğŸš€</text>
        <text class="insight-text">å¢é•¿æœºä¼šï¼š{{executiveSummary.mainOpportunity}}</text>
      </view>
    </view>
  </view>

  <!-- ç¬¬äºŒå±‚ï¼šå¤šç»´åˆ†æ (Multi-dimensional Analysis) -->
  <view class="section analysis-section">
    <view class="section-header">
      <text class="section-title">å¤šç»´åˆ†æ</text>
    </view>

    <!-- Tab å¯¼èˆª -->
    <view class="tabs-nav">
      <view class="tab-item {{activeTab === 'byPlatform' ? 'active' : ''}}" data-tab="byPlatform" bindtap="switchTab">æŒ‰å¹³å°åˆ†æ</view>
      <view class="tab-item {{activeTab === 'byBrand' ? 'active' : ''}}" data-tab="byBrand" bindtap="switchTab">æŒ‰å“ç‰Œåˆ†æ</view>
      <view class="tab-item {{activeTab === 'byProblem' ? 'active' : ''}}" data-tab="byProblem" bindtap="switchTab">é—®é¢˜è¯Šæ–­</view>
    </view>

    <!-- Tab å†…å®¹ -->
    <view class="tab-content">
      <!-- æŒ‰å¹³å°åˆ†æ -->
      <view class="tab-pane" wx:if="{{activeTab === 'byPlatform'}}">
        <view wx:for="{{dataByPlatform}}" wx:for-item="platformResults" wx:for-index="platformName" wx:key="platformName">
          <view class="platform-group-title">{{platformName}}</view>
          <view class="result-card {{item.brand === targetBrand ? 'brand-card' : 'competitor-card'}}" wx:for="{{platformResults}}" wx:key="index" wx:for-item="item" wx:for-index="index">
            <template is="resultCardTemplate" data="{{item, targetBrand, type: 'platform', platform: platformName, index}}"/>
          </view>
        </view>
      </view>

      <!-- æŒ‰å“ç‰Œåˆ†æ -->
      <view class="tab-pane" wx:if="{{activeTab === 'byBrand'}}">
        <view wx:for="{{dataByBrand}}" wx:for-item="brandResults" wx:for-index="brandName" wx:key="brandName">
          <view class="brand-group-title {{brandName === targetBrand ? 'is-target-brand' : ''}}">{{brandName}}</view>
          <view class="result-card {{item.brand === targetBrand ? 'brand-card' : 'competitor-card'}}" wx:for="{{brandResults}}" wx:key="index" wx:for-item="item" wx:for-index="index">
            <template is="resultCardTemplate" data="{{item, targetBrand, type: 'brand', brand: brandName, index}}"/>
          </view>
        </view>
      </view>

      <!-- é—®é¢˜è¯Šæ–­ -->
      <view class="tab-pane" wx:if="{{activeTab === 'byProblem'}}">
        <view wx:if="{{problemList.length === 0}}" class="no-problems">
          <text>ğŸ‰ æ­å–œï¼æœªæ£€æµ‹åˆ°é‡å¤§é—®é¢˜ã€‚</text>
        </view>
        <view class="result-card {{problem.item.brand === targetBrand ? 'brand-card' : 'competitor-card'}}" wx:for="{{problemList}}" wx:key="index" wx:for-item="problem" wx:for-index="index">
          <template is="resultCardTemplate" data="{{item: problem.item, targetBrand, type: 'problem', index}}"/>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œåŒº -->
  <view class="footer-actions">
    <button class="btn-primary" bindtap="goHome">è¿”å›é¦–é¡µ</button>
  </view>
</view>

<!-- åŠ è½½çŠ¶æ€ -->
<view class="loading-state" wx:if="{{isLoading}}">
  <text>æ­£åœ¨åŠ è½½å†å²æŠ¥å‘Š...</text>
</view>

<!-- WXS æ¨¡å—ï¼Œç”¨äºåœ¨ WXML ä¸­è°ƒç”¨å‡½æ•° -->
<wxs module="tools">
  var getHeatmapColor = function(score) {
    if (score === undefined || score === null) return 'rgba(255, 255, 255, 0.05)';
    if (score >= 85) return 'rgba(0, 245, 160, 0.8)'; // ä¼˜
    if (score >= 70) return 'rgba(0, 245, 160, 0.5)'; // è‰¯
    if (score >= 50) return 'rgba(255, 140, 0, 0.6)'; // ä¸­
    return 'rgba(255, 77, 79, 0.6)'; // å·®
  }
  module.exports.getHeatmapColor = getHeatmapColor;
</wxs>

<!-- æ¨¡æ¿ï¼šGEO æ™ºèƒ½æ´å¯Ÿå¡ç‰‡ -->
<template name="resultCardTemplate">
  <view class="card-header" bindtap="toggleExpand" data-type="{{type}}" data-platform="{{platform}}" data-brand="{{brand}}" data-index="{{index}}">
    <view class="header-left">
      <view class="brand-tag {{item.brand === targetBrand ? 'tag-primary' : 'tag-secondary'}}">
        {{item.brand}}
      </view>
      <view class="model-info">
        <text class="model-name">{{item.aiModel}}</text>
        <view class="source-dot {{item.category === 'å›½å†…' ? 'dot-red' : 'dot-blue'}}"></view>
      </view>
    </view>

    <view class="header-right">
      <view class="score-display">
        <text class="score-num {{item.score >= 80 ? 'text-green' : (item.score >= 60 ? 'text-orange' : 'text-red')}}">{{item.score}}</text>
        <text class="score-label">åˆ†</text>
      </view>
      <view class="grade-badge-small {{item.score >= 85 ? 'grade-A' : (item.score >= 70 ? 'grade-B' : (item.score >= 50 ? 'grade-C' : 'grade-D'))}}">
        {{item.score >= 85 ? 'A' : (item.score >= 70 ? 'B' : (item.score >= 50 ? 'C' : 'D'))}}
      </view>
      <view class="expand-arrow {{item.expanded ? 'expanded' : ''}}">âŒ„</view>
    </view>
  </view>

  <!-- å¡ç‰‡æ‘˜è¦ (å§‹ç»ˆæ˜¾ç¤º) -->
  <view class="card-summary" bindtap="toggleExpand" data-type="{{type}}" data-platform="{{platform}}" data-brand="{{brand}}" data-index="{{index}}">
    <view class="mini-progress-group">
      <view class="mini-progress-item">
        <text class="mp-label">æƒå¨</text>
        <progress percent="{{item.authority_score}}" stroke-width="4" color="#00A9FF" border-radius="2" class="mp-bar"/>
        <text class="mp-val">{{item.authority_score}}</text>
      </view>
      <view class="mini-progress-item">
        <text class="mp-label">å¯è§</text>
        <progress percent="{{item.visibility_score}}" stroke-width="4" color="#00F5A0" border-radius="2" class="mp-bar"/>
        <text class="mp-val">{{item.visibility_score}}</text>
      </view>
      <view class="mini-progress-item">
        <text class="mp-label">å¥½æ„Ÿ</text>
        <progress percent="{{item.sentiment_score}}" stroke-width="4" color="#FF8C00" border-radius="2" class="mp-bar"/>
        <text class="mp-val">{{item.sentiment_score}}</text>
      </view>
    </view>
  </view>

  <!-- å¡ç‰‡è¯¦æƒ… (å±•å¼€æ˜¾ç¤º) -->
  <view class="card-details" wx:if="{{item.expanded}}">

    <!-- æ¿å— A: AI åŸå£° -->
    <view class="detail-section ai-voice-section">
      <view class="section-label">ğŸ¤– AI åŸå£°</view>
      <view class="ai-quote">
        <text class="quote-content">{{item.response}}</text>
      </view>
    </view>

    <!-- æ¿å— B: æ·±åº¦è¯Šæ–­ -->
    <view class="detail-section diagnostic-section">
      <view class="section-label">ğŸ©º æ·±åº¦è¯Šæ–­</view>

      <!-- 5ç»´å¾—åˆ†ç½‘æ ¼ -->
      <view class="score-grid">
        <view class="score-grid-item">
          <text class="sg-label">çº¯å‡€åº¦</text>
          <text class="sg-val">{{item.purity_score}}</text>
        </view>
        <view class="score-grid-item">
          <text class="sg-label">ä¸€è‡´æ€§</text>
          <text class="sg-val">{{item.consistency_score}}</text>
        </view>
      </view>

      <!-- é¢„è­¦æ¨¡å— -->
      <view class="alerts-container">
        <!-- è¯­ä¹‰åç§» -->
        <view class="alert-item alert-warning" wx:if="{{item.authority_score < 60 && item.visibility_score > 60}}">
          <view class="alert-icon">âš ï¸</view>
          <view class="alert-content">
            <text class="alert-title">è¯­ä¹‰åç§»é¢„è­¦</text>
            <text class="alert-desc">AI è®¤çŸ¥å­˜åœ¨åå·®ï¼Œé«˜å¯è§åº¦ä½†ä½æƒå¨åº¦ï¼Œå¯èƒ½æºäºé”™è¯¯ä¿¡æºã€‚</text>
          </view>
        </view>

        <!-- è´Ÿé¢æƒ…æ„Ÿ -->
        <view class="alert-item alert-danger" wx:if="{{item.sentiment_score < 50}}">
          <view class="alert-icon">â›”</view>
          <view class="alert-content">
            <text class="alert-title">è´Ÿé¢æƒ…æ„Ÿé¢„è­¦</text>
            <text class="alert-desc">æ£€æµ‹åˆ°æ˜æ˜¾çš„è´Ÿé¢è¯„ä»·å€¾å‘ï¼Œå»ºè®®ç«‹å³æ’æŸ¥èˆ†æƒ…ã€‚</text>
          </view>
        </view>

        <!-- ç«å“å¹²æ‰° -->
        <view class="alert-item alert-info" wx:if="{{item.purity_score < 70}}">
          <view class="alert-icon">ğŸ”</view>
          <view class="alert-content">
            <text class="alert-title">ç«å“å¹²æ‰°æ£€æµ‹</text>
            <text class="alert-desc">å›ç­”ä¸­åŒ…å«ç«å“ä¿¡æ¯ï¼Œå“ç‰Œçº¯å‡€åº¦å—æŸã€‚</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ¿å— C: ä¼˜åŒ–å»ºè®® -->
    <view class="detail-section action-section" wx:if="{{item.suggestions && item.suggestions.length > 0}}">
      <view class="section-label">ğŸ’¡ ä¼˜åŒ–ç­–ç•¥</view>
      <view class="action-list">
        <view class="action-item" wx:for="{{item.suggestions}}" wx:key="s_idx" wx:for-item="sug">
          <view class="action-icon">âœ“</view>
          <text class="action-text">{{sug.content}}</text>
        </view>
      </view>
    </view>

  </view>
</template>