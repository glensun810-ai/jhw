核心架构逻辑：NxM 执行矩阵
我们将逻辑从“单次问答”重构为“Query(Q) × Model(M) 矩阵”。

输入：1个品牌 + N个竞品 + M个问题。

执行：每个问题在每个模型下独立运行，捕捉该模型在该问题下的“品牌偏好”。

第一阶段：数据协议与后端核心逻辑 (The Core Engine)
优先级：最高 (P0)
目标：确立新的数据契约，实现从“文本”到“结构化洞察”的飞跃。

1.1 数据结构定义 (Data Contract)
定义新的 TaskResult 对象。每一个问题请求必须返回以下结构：

Visibility: 品牌是否出现？（Boolean）

Rank: 品牌出现的位次（Integer, -1为未出现）。

Sentiment: 情感分值（-1 到 1）。

Sources: 提取引用的 URL 列表及该信源对品牌的态度（Positive/Negative/Competitor_Support）。

1.2 并发执行引擎重构
任务拆解：后端 Scheduler 接收问题数组，不再合并，而是将 (Question, Model) 组合成独立的子任务。

归因分析逻辑：在 AI 返回文本后，增加一层“LLM 自审”：“请根据上述回答，提取 [品牌名] 的排名、提到的优点、缺点，并列出其引用的所有网址。”

第二阶段：前端架构拆分与数据聚合 (The Skeleton)
优先级：高 (P1)
目标：建立“1+N”页面体系，解决加载卡顿与逻辑混乱。

2.1 页面路径重组
/pages/report/dashboard (新页面)：作为战略汇总页。

/pages/report/detail (重构页)：作为针对“特定问题”的深度钻取页。

2.2 前端聚合服务 (reportAggregator.js)
开发统一的聚合函数，将后端返回的矩阵数据进行维度转换：

品牌声量占比 (SOV)：所有回答中品牌出现的频率。

平均排名趋势：跨模型、跨问题的排名加权。

信源黑榜：统计哪些网站经常输出品牌负面信息。

第三阶段：详情页 UI 重构与 GEO 功能实现 (The Dashboard)
优先级：中 (P2)
目标：实现“麦肯锡风格”的可视化看板。

3.1 战略看板 (Dashboard) 实现
模块一：品牌健康度仪表盘。显示总分、各模型对品牌的好感度对比（雷达图）。

模块二：问题穿透卡片。列出用户输入的所有问题。每个问题卡片显示：该问题的平均排名、主要的竞争对手、风险等级。

3.2 深度诊断页 (Problem Detail) 实现
排名归因：展示不同模型对该问题的评价差异。

信源侦探：展示“为什么我排在这里？”——点击信源链接，显示该网页内容如何影响了 AI。

竞品拦截分析：展示 AI 在回答此问题时是否跳过你而推荐了竞品。

第四阶段：性能优化与防御性编程 (The Polish)
优先级：持续进行

分片渲染 (Chunked Rendering)：针对详情页中的长文本对话，采用分片加载，确保滚动不卡顿。

错误降级：若某模型 API 挂掉，Dashboard 应能自动重新计算加权分，不影响整体报告输出。

🤖 给 AI Coding 的分阶段任务指令 (Prompt)
Task 1: 后端逻辑矩阵化 (逻辑重构起点)
"请重构后端 run_async_test 逻辑。不再合并 customQuestions，而是遍历问题数组，为每个问题和每个选定模型创建一个独立请求任务。要求 AI 在返回结果中通过 Prompt 强制包含 JSON 格式的元数据：{rank: int, sentiment: float, sources: array}。确保结果按问题 ID 存储。"

Task 2: 前端聚合引擎开发 (数据桥梁)
"请创建 services/reportAggregator.js。编写逻辑将后端的 NxM 矩阵结果转化为：1. 品牌在各维度的平均分；2. 跨模型的关键词共识；3. 竞品拦截频率。该服务将为 Dashboard 提供数据支撑。"

Task 3: 看板与详情页拆分 (UI 重构)
"请在小程序中新建 pages/report/dashboard 作为首位入口，展示品牌得分和问题列表卡片。原有详情页重写为 pages/report/detail，进入时需携带 questionIndex，展示该特定问题在各模型下的排名、信源分析及 AI 原文。实现分片加载逻辑以支持长文本预览。"

💡 专家点评
这套方案的核心价值在于： 它把 AI 从一个“黑盒”变成了“可解释的工具”。
当你的客户看到**“我的排名较低是因为 AI 引用了这三篇负面新闻”时，他得到的不仅是数据，而是解决问题的行动指南**。这才是顶级系统专家的核心竞争力。