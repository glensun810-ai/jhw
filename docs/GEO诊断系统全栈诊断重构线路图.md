************************************
总体方案
************************************
核心架构逻辑：NxM 执行矩阵
我们将逻辑从“单次问答”重构为“Query(Q) × Model(M) 矩阵”。

输入：1个品牌 + N个竞品 + M个问题。

执行：每个问题在每个模型下独立运行，捕捉该模型在该问题下的“品牌偏好”。

第一阶段：数据协议与后端核心逻辑 (The Core Engine)
优先级：最高 (P0)
目标：确立新的数据契约，实现从“文本”到“结构化洞察”的飞跃。

1.1 数据结构定义 (Data Contract)
定义新的 TaskResult 对象。每一个问题请求必须返回以下结构：

Visibility: 品牌是否出现？（Boolean）

Rank: 品牌出现的位次（Integer, -1为未出现）。

Sentiment: 情感分值（-1 到 1）。

Sources: 提取引用的 URL 列表及该信源对品牌的态度（Positive/Negative/Competitor_Support）。

1.2 并发执行引擎重构
任务拆解：后端 Scheduler 接收问题数组，不再合并，而是将 (Question, Model) 组合成独立的子任务。

归因分析逻辑：在 AI 返回文本后，增加一层“LLM 自审”：“请根据上述回答，提取 [品牌名] 的排名、提到的优点、缺点，并列出其引用的所有网址。”

第二阶段：前端架构拆分与数据聚合 (The Skeleton)
优先级：高 (P1)
目标：建立“1+N”页面体系，解决加载卡顿与逻辑混乱。

2.1 页面路径重组
/pages/report/dashboard (新页面)：作为战略汇总页。

/pages/report/detail (重构页)：作为针对“特定问题”的深度钻取页。

2.2 前端聚合服务 (reportAggregator.js)
开发统一的聚合函数，将后端返回的矩阵数据进行维度转换：

品牌声量占比 (SOV)：所有回答中品牌出现的频率。

平均排名趋势：跨模型、跨问题的排名加权。

信源黑榜：统计哪些网站经常输出品牌负面信息。

第三阶段：详情页 UI 重构与 GEO 功能实现 (The Dashboard)
优先级：中 (P2)
目标：实现“麦肯锡风格”的可视化看板。

3.1 战略看板 (Dashboard) 实现
模块一：品牌健康度仪表盘。显示总分、各模型对品牌的好感度对比（雷达图）。

模块二：问题穿透卡片。列出用户输入的所有问题。每个问题卡片显示：该问题的平均排名、主要的竞争对手、风险等级。

3.2 深度诊断页 (Problem Detail) 实现
排名归因：展示不同模型对该问题的评价差异。

信源侦探：展示“为什么我排在这里？”——点击信源链接，显示该网页内容如何影响了 AI。

竞品拦截分析：展示 AI 在回答此问题时是否跳过你而推荐了竞品。

第四阶段：性能优化与防御性编程 (The Polish)
优先级：持续进行

分片渲染 (Chunked Rendering)：针对详情页中的长文本对话，采用分片加载，确保滚动不卡顿。

错误降级：若某模型 API 挂掉，Dashboard 应能自动重新计算加权分，不影响整体报告输出。

🤖 给 AI Coding 的分阶段任务指令 (Prompt)
Task 1: 后端逻辑矩阵化 (逻辑重构起点)
"请重构后端 run_async_test 逻辑。不再合并 customQuestions，而是遍历问题数组，为每个问题和每个选定模型创建一个独立请求任务。要求 AI 在返回结果中通过 Prompt 强制包含 JSON 格式的元数据：{rank: int, sentiment: float, sources: array}。确保结果按问题 ID 存储。"

Task 2: 前端聚合引擎开发 (数据桥梁)
"请创建 services/reportAggregator.js。编写逻辑将后端的 NxM 矩阵结果转化为：1. 品牌在各维度的平均分；2. 跨模型的关键词共识；3. 竞品拦截频率。该服务将为 Dashboard 提供数据支撑。"

Task 3: 看板与详情页拆分 (UI 重构)
"请在小程序中新建 pages/report/dashboard 作为首位入口，展示品牌得分和问题列表卡片。原有详情页重写为 pages/report/detail，进入时需携带 questionIndex，展示该特定问题在各模型下的排名、信源分析及 AI 原文。实现分片加载逻辑以支持长文本预览。"

💡 专家点评
这套方案的核心价值在于： 它把 AI 从一个“黑盒”变成了“可解释的工具”。
当你的客户看到**“我的排名较低是因为 AI 引用了这三篇负面新闻”时，他得到的不仅是数据，而是解决问题的行动指南**。这才是顶级系统专家的核心竞争力。

************************************
************************************

你好！我是你的首席系统架构师。既然“发令枪”已经响了，我们将摒弃所有过时的文档碎片，直接进入**“逻辑重构+视觉进化”一体化**的实战阶段。

这份方案是为 AI Coding 量身定制的全栈重构指令集，它将系统从“问答工具”彻底拉升到**“GEO（AI搜索优化）战略监测平台”**的高度。

🟢 第一阶段：后端核心——NxM 任务矩阵与归因引擎 (P0)
目标：打破“问题合并”的错误逻辑，建立以“问题”为原子单位的监测体系。

1.1 任务调度器逻辑重构 (Backend Scheduler)
指令：修改 run_async_test 函数。

逻辑：

矩阵化执行：不再将 customQuestions 合并。遍历 Questions 数组与 SelectedModels 数组，生成 len(Q) * len(M) 个独立子任务。

上下文注入：为每个子任务构建专属 Prompt。

示例：“请分析 [品牌A] 在 [问题Q] 下的表现。对比 [竞品B, C]。请回答后，以固定的 JSON 格式总结：排名、情感、引用的信源 URL。”

数据存储：在数据库中，每个 task_id 下的 results 必须以 question_id 为一级索引，而不是模型。

1.2 结构化归因分析 (Data Enrichment)
任务：在 API 响应后增加一层 Parser（解析层）。

提取字段：

rank: 品牌在当前回答中的出现位次（1-10，未出现为 -1）。

sentiment_score: 语义正负面评分（-1 到 1）。

source_nodes: 正则匹配或模型自查出的信源列表，标注其对品牌的态度（Support / Critical / Competitor_Only）。

🟡 第二阶段：前端服务——战略聚合引擎 (P1)
目标：在 services/ 目录下创建一个“大脑”，将后端碎片化的矩阵数据合成“战略洞察”。

2.1 新增 reportAggregator.js
模块 A：SOV (声量占比) 计算：统计在所有问题中，品牌被提及的百分比。

模块 B：竞品拦截率分析：统计在你的品牌相关问题中，竞品被 AI 推荐的频率。

模块 C：信源黑榜 (Toxic Sources)：提取导致排名降低或负面评价的高频引用网址。

模块 D：品牌共识云：跨模型提取 AI 对品牌的共识性描述（如 4 个模型中有 3 个提到了“高科技”，则为核心标签）。

🔵 第三阶段：页面重构——麦肯锡战略看板 (P1)
目标：分离“概览”与“详情”，实现 1+N 的跳转架构。

3.1 导航逻辑修改
动作：将 index.js 的跳转终点改为 pages/report/dashboard/index。不再通过 URL 传递巨型字符串，改为写入 app.globalData。

3.2 页面 A：战略看板 (Dashboard)
UI 布局：

总览区：品牌 GEO 健康得分（雷达图：涵盖可见度、美誉度、信源权重、防御力）。

问题监控墙 (Question Wall)：卡片式列出所有输入的问题。

卡片显示：问题文本 + 综合排名（各模型平均） + 风险预警（如某问题下全是负面，标红）。

竞品对抗区：柱状图对比你与竞品在 AI 端的“被推荐率”。

3.3 页面 B：问题深度诊断 (Problem Detail)
核心逻辑：点击 Dashboard 中的某个问题卡片，进入此页。

展示内容：

模型差异对比：DeepSeek 把你排第一，豆包把你排第五，为什么？

信源溯源 (Source Radar)：【核心功能】 展示这个问题的信源列表。

标记哪些信源是“由于它，你的排名提升了”。

标记哪些信源是“由于它，AI 正在推荐你的竞品”。

原始对话 (Chunked View)：底部折叠展示 4 个模型的原始回答，点击展开，支持分片渲染以保证流畅。

🔴 第四阶段：功能优化与防御性加固 (P2)
目标：确保在大数据量、长响应时间下的系统稳定性。

分片渲染组件 (Performance)：封装一个文本渲染组件，针对 AI 返回的长文本，每隔 50ms 渲染一段，解决小程序 setData 阻塞 UI 的问题。

数据兜底 (Error Handling)：若某个问题在所有模型中均未提到品牌，自动生成“品牌心智真空”警告，并给出“建议覆盖核心信源”的行动指南。

结果导出 (Growth)：增加一键生成“长图报告”功能，方便用户在微信群中直接汇报诊断结果。

🤖 给 AI Coding 的第一步启动指令 (Prompt)
请将此指令复制到你的 AI 工具中：

“任务启动：GEO 系统逻辑与页面彻底重构。

Step 1 (后端逻辑矩阵化)：请修改 run_async_test。遍历 customQuestions 数组，针对每个问题分别向选定的 AI 模型发起请求。确保返回结果按 question_id 分组。

Step 2 (解析引擎)：在结果返回后，利用正则表达式或 LLM 提取以下元数据：品牌排名 (Rank)、情感倾向 (Sentiment)、引用信源 (Citations)。

Step 3 (前端骨架)：在小程序中创建 pages/report/dashboard 和 pages/report/detail。修改 index.js 的任务完成回调，将完整结果存入全局变量并跳转至 dashboard。

请先为我展示重构后的后端任务调度逻辑（Python 代码）。”

专家点评：这套方案直接切中了企业级用户的痛点——“不仅告诉我结果，还要告诉我为什么是这个结果，以及我该去哪里改”。通过将“问题”独立化和“信源”显性化，你的产品将具备极高的商业壁垒。