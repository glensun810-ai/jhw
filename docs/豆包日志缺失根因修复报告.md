# 豆包日志缺失根因修复报告

**实施日期**: 2026 年 2 月 19 日  
**修复内容**: 在 NXM 执行引擎异常处理块中添加日志记录  
**状态**: ✅ 已完成  
**测试**: ✅ 15/15 回归测试通过

---

## 问题根因

### 用户报告

> 输入了 2 个问题和选择了 4 个 AI 平台，应该有 8 条 API 请求结果输出，但 ai_responses.jsonl 中只有 5 条，且没有豆包。

### 分析发现

**问题位置**: `wechat_backend/nxm_execution_engine.py` 第 246-254 行

**问题代码**:
```python
except Exception as e:
    error_traceback = traceback.format_exc()
    api_logger.error(
        f"Error on [Q:{q_idx+1}] [MainBrand:{main_brand}] [Model:{model_name}]: "
        f"{str(e)}\n{error_traceback}"
    )
    result_item.update({
        "status": "failed",
        "error": str(e)
    })
    # ❌ 缺少 log_ai_response() 调用！
```

**问题说明**:
当适配器调用抛出异常时（如豆包 API 调用失败），只在 `app.log` 中记录了错误，但**没有调用 `log_ai_response()` 记录到 `ai_responses.jsonl`**。

### 日志记录路径对比

| 情况 | 日志记录位置 | 状态 |
|------|------------|------|
| 成功响应 | `ai_responses.jsonl` ✅ | 正常 |
| API 返回错误 | `ai_responses.jsonl` ✅ | 正常 |
| **适配器异常** | `app.log` only ❌ | **缺失** |

---

## 修复方案

### 修改文件

`wechat_backend/nxm_execution_engine.py` 第 246-254 行

### 修改内容

**修改前**:
```python
except Exception as e:
    error_traceback = traceback.format_exc()
    api_logger.error(...)
    result_item.update({...})
    # 缺少日志记录
```

**修改后**:
```python
except Exception as e:
    error_traceback = traceback.format_exc()
    api_logger.error(...)
    result_item.update({...})
    
    # ✅ 记录异常调用到日志文件（确保所有平台包括豆包都被记录）
    try:
        from utils.ai_response_logger_v2 import log_ai_response
        log_ai_response(
            question=geo_prompt,
            response="",
            platform=normalized_model_name,
            model=model_id,
            brand=main_brand,
            latency_ms=int((time.time() - start_time) * 1000),
            success=False,
            error_message=str(e),
            error_type="exception",
            execution_id=execution_id,
            question_index=q_idx + 1,
            total_questions=len(raw_questions) * len(selected_models),
            metadata={"source": "nxm_execution_engine", "error_phase": "adapter_call"}
        )
        api_logger.info(f"[AIResponseLogger] Exception logged for [Q:{q_idx+1}] [Model:{model_name}]")
    except Exception as log_error:
        api_logger.warning(f"[AIResponseLogger] Failed to log exception: {log_error}")
```

---

## 验证结果

### 1. 代码验证

```bash
✓ NXM 执行引擎导入成功
✓ 异常处理块中已添加日志记录
✓ 成功响应日志记录：1 处
✓ 失败响应日志记录：2 处 (API 错误 + 异常)
```

### 2. 回归测试

```bash
======================= 15 passed, 17 warnings in 4.91s ========================
```

### 3. 日志记录完整性

修复后，所有情况都会记录到 `ai_responses.jsonl`：

| 情况 | 日志记录 | 字段 |
|------|---------|------|
| 成功响应 | ✅ `ai_responses.jsonl` | `success=True` |
| API 返回错误 | ✅ `ai_responses.jsonl` | `success=False, error_phase=api_call` |
| 适配器异常 | ✅ `ai_responses.jsonl` | `success=False, error_phase=adapter_call` |

---

## 预期效果

### 修复前

```
执行：2 问题 * 4 平台 = 8 次调用

假设豆包在第 3 次调用时抛出异常：

ai_responses.jsonl (5 条):
  1. deepseek - Q1 ✓
  2. qwen - Q1 ✓
  3. zhipu - Q1 ✓
  4. deepseek - Q2 ✓
  5. qwen - Q2 ✓
  ❌ zhipu - Q2 (异常，未记录)
  ❌ doubao - Q1 (异常，未记录)
  ❌ doubao - Q2 (异常，未记录)

app.log:
  - 有异常错误日志
  - 但没有结构化记录
```

### 修复后

```
执行：2 问题 * 4 平台 = 8 次调用

ai_responses.jsonl (8 条):
  1. deepseek - Q1 ✓ success=True
  2. qwen - Q1 ✓ success=True
  3. zhipu - Q1 ✓ success=True
  4. doubao - Q1 ✓ success=True (或 success=False)
  5. deepseek - Q2 ✓ success=True
  6. qwen - Q2 ✓ success=True
  7. zhipu - Q2 ✓ success=True (或 success=False)
  8. doubao - Q2 ✓ success=True (或 success=False)

所有 8 条记录都完整！
```

---

## 完整的日志记录逻辑

现在 NXM 执行引擎有 3 处日志记录：

### 1. 成功响应 (第 166-189 行)

```python
if ai_response.success:
    log_ai_response(
        success=True,
        question_index=q_idx + 1,
        ...
    )
```

### 2. API 返回错误 (第 226-243 行)

```python
else:  # ai_response.success == False
    log_ai_response(
        success=False,
        error_message=ai_response.error_message,
        error_phase="api_call",
        ...
    )
```

### 3. 适配器异常 (第 250-273 行) ✅ **新增**

```python
except Exception as e:
    log_ai_response(
        success=False,
        error_message=str(e),
        error_type="exception",
        error_phase="adapter_call",
        ...
    )
```

---

## 豆包日志流程

### 修复前

```
DoubaoAdapter.send_prompt()
       ↓
   抛出异常
       ↓
NXM except Exception as e:
       ↓
记录到 app.log ❌
       ↓
没有记录到 ai_responses.jsonl ❌
```

### 修复后

```
DoubaoAdapter.send_prompt()
       ↓
   抛出异常
       ↓
NXM except Exception as e:
       ↓
记录到 app.log ✓
       ↓
记录到 ai_responses.jsonl ✓
       ↓
metadata.error_phase = "adapter_call"
```

---

## 验证步骤

### 1. 执行包含豆包的测试

```bash
cd backend_python
python3 test_doubao_brand_diagnosis.py
```

### 2. 检查日志记录

```bash
tail -10 data/ai_responses/ai_responses.jsonl | python3 -c "
import sys, json
for line in sys.stdin:
    r = json.loads(line)
    p = r.get('platform', 'Unknown')
    if isinstance(p, dict): p = p.get('name', 'Unknown')
    success = r.get('status', {}).get('success', False)
    phase = r.get('metadata', {}).get('error_phase', 'N/A')
    print(f'{p:12} | success={success} | error_phase={phase}')
"
```

**期望输出**:
```
deepseek     | success=True | error_phase=N/A
qwen         | success=True | error_phase=N/A
zhipu        | success=True | error_phase=N/A
doubao       | success=True | error_phase=N/A  ✅
...
```

### 3. 验证 N*M 对应关系

```bash
python3 analyze_ai_logs.py
```

**期望输出**:
```
【Execution: xxx...】
  问题数：2
  涉及平台数：4
    豆包：2 个问题  ✅
    DeepSeek: 2 个问题
    通义千问：2 个问题
    智谱 AI: 2 个问题
```

---

## 总结

### 修复内容

- ✅ 在 NXM 执行引擎异常处理块中添加 `log_ai_response()` 调用
- ✅ 确保所有平台（包括豆包）的异常都被记录到 `ai_responses.jsonl`
- ✅ 添加 `error_phase="adapter_call"` 标识异常来源

### 测试验证

- ✅ 15/15 回归测试通过
- ✅ 代码导入验证通过
- ✅ 日志记录逻辑验证通过

### 预期改进

- ✅ 2 问题*4 平台 = 8 条记录全部完整
- ✅ 豆包日志与其他平台保持一致
- ✅ 便于问题排查和数据分析

---

**报告人**: AI 系统架构师  
**日期**: 2026 年 2 月 19 日  
**优先级**: P1 - 高
