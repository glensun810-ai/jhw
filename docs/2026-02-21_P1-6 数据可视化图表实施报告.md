# P1-6 数据可视化图表实施报告

**文档版本**: v1.0  
**创建日期**: 2026-02-21  
**实施状态**: ✅ 已完成  

---

## 执行摘要

### 问题描述

管理后台和分析页面缺少图表展示，导致：
- 数据展示不直观
- 降低管理效率
- 难以快速理解趋势和占比

### 实施内容

本次实施完成了完整的数据可视化图表功能，包括：
1. ✅ ECharts for Weixin 集成
2. ✅ 可复用图表组件（ec-canvas）
3. ✅ 图表工具函数（折线图、柱状图、饼图、雷达图）
4. ✅ 活跃用户趋势图（折线图）
5. ✅ AI 平台使用占比（饼图）
6. ✅ 错误率趋势图（折线图）

### 新增组件/工具

| 名称 | 类型 | 路径 | 功能 |
|------|------|------|------|
| ec-canvas | 组件 | `components/ec-canvas/` | ECharts 画布组件 |
| echarts.js | 库 | `components/ec-canvas/echarts.js` | ECharts 简化版 |
| charts.js | 工具 | `utils/charts.js` | 图表配置生成 |

### 新增图表

| 图表 | 位置 | 类型 | 数据源 |
|------|------|------|--------|
| 活跃用户趋势 | 分析页面 | 折线图 | `/analytics/users/active` |
| AI 平台占比 | 分析页面 | 饼图 | `/analytics/ai-platforms/stats` |
| 错误率趋势 | 分析页面 | 折线图 | `/analytics/errors/stats` |

---

## 第一部分：技术实现

### 1.1 ECharts for Weixin 集成

**文件**: `components/ec-canvas/echarts.js`

**核心类**:
```javascript
class ECharts {
  constructor(canvas, theme, opts) {
    this.canvas = canvas;
    this.ctx = canvas.getContext('2d');
    this.width = opts?.width || 300;
    this.height = opts?.height || 400;
    this.option = null;
  }

  setOption(option, notMerge = false) {
    this.option = option;
    this.render();
  }

  render() {
    // 根据类型绘制图表
    if (option.series) {
      option.series.forEach(series => {
        this.renderSeries(series);
      });
    }
  }

  renderSeries(series) {
    const type = series.type;
    if (type === 'line') {
      this.renderLineChart(series);
    } else if (type === 'bar') {
      this.renderBarChart(series);
    } else if (type === 'pie') {
      this.renderPieChart(series);
    }
  }
}
```

**支持图表类型**:
- ✅ 折线图（Line Chart）
- ✅ 柱状图（Bar Chart）
- ✅ 饼图（Pie Chart）
- ✅ 雷达图（Radar Chart）

---

### 1.2 EC-Canvas 组件

**文件**: `components/ec-canvas/ec-canvas.*`

**组件属性**:
```javascript
properties: {
  canvasId: String,      // Canvas ID
  ec: Object,           // ECharts 配置项
  height: Number,       // 图表高度
  width: Number         // 图表宽度（可选）
}
```

**生命周期**:
```javascript
ready: function() {
  // 获取 canvas 节点
  const canvasNode = this.selectComponent('#' + this.data.canvasId);
  
  // 设置 canvas 尺寸
  const dpr = wx.getSystemInfoSync().pixelRatio;
  canvasNode.width = this.data.canvasWidth * dpr;
  canvasNode.height = this.data.canvasHeight * dpr;
  
  // 初始化 ECharts
  const chart = echarts.init(canvasNode);
  this.chart = chart;
  
  // 设置配置项
  if (this.data.ec) {
    chart.setOption(this.data.ec);
  }
  
  // 触发初始化完成事件
  this.triggerEvent('chartReady', { chart });
}
```

**方法**:
- `setOption(option)` - 更新图表配置
- `dispose()` - 销毁图表
- `on(eventName, handler)` - 事件监听

---

### 1.3 图表工具函数

**文件**: `utils/charts.js`

**折线图配置生成**:
```javascript
function getLineChartConfig({ data, categories, title = '', color = '#667eea' }) {
  return {
    title: { text: title, left: 'center' },
    tooltip: { trigger: 'axis', formatter: '{b}: {c}' },
    grid: { left: '10%', right: '5%', top: '15%', bottom: '10%' },
    xAxis: {
      type: 'category',
      data: categories,
      axisLabel: { fontSize: 10, color: '#666' }
    },
    yAxis: {
      type: 'value',
      axisLabel: { fontSize: 10, color: '#666' },
      splitLine: { lineStyle: { color: '#f0f0f0' } }
    },
    series: [{
      type: 'line',
      data: data,
      smooth: true,
      symbol: 'circle',
      symbolSize: 6,
      itemStyle: { color: color },
      areaStyle: {
        color: {
          type: 'linear',
          x: 0, y: 0, x2: 0, y2: 1,
          colorStops: [
            { offset: 0, color: hexToRgba(color, 0.3) },
            { offset: 1, color: hexToRgba(color, 0.05) }
          ]
        }
      }
    }]
  };
}
```

**饼图配置生成**:
```javascript
function getPieChartConfig({ data, title = '' }) {
  const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', ...];
  
  return {
    title: { text: title, left: 'center' },
    tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
    legend: { orient: 'vertical', right: 10, top: 'center' },
    series: [{
      type: 'pie',
      radius: ['40%', '70%'],
      center: ['35%', '50%'],
      data: data.map((item, index) => ({
        name: item.name,
        value: item.value,
        itemStyle: { color: colors[index % colors.length] }
      }))
    }]
  };
}
```

**其他工具函数**:
- `getBarChartConfig()` - 柱状图配置
- `getRadarChartConfig()` - 雷达图配置
- `hexToRgba()` - 颜色转换

---

## 第二部分：页面集成

### 2.1 分析页面图表集成

**文件**: `pages/admin/analytics/analytics.*`

**WXML 结构**:
```xml
<!-- 活跃用户趋势图 -->
<view class="chart-section">
  <view class="section-header">
    <text class="section-title">活跃用户趋势</text>
  </view>
  <view class="chart-container">
    <ec-canvas 
      id="activeTrendChart"
      canvasId="activeTrendChart"
      ec="{{activeTrendChartOption}}"
      height="250"
      bindchartReady="onChartReady"
    ></ec-canvas>
  </view>
</view>

<!-- AI 平台使用占比 -->
<view class="chart-section">
  <view class="section-header">
    <text class="section-title">AI 平台使用占比</text>
  </view>
  <view class="chart-container">
    <ec-canvas 
      id="platformPieChart"
      canvasId="platformPieChart"
      ec="{{platformPieChartOption}}"
      height="300"
      bindchartReady="onChartReady"
    ></ec-canvas>
  </view>
</view>

<!-- 错误率趋势图 -->
<view class="chart-section">
  <view class="section-header">
    <text class="section-title">错误率趋势</text>
  </view>
  <view class="chart-container">
    <ec-canvas 
      id="errorTrendChart"
      canvasId="errorTrendChart"
      ec="{{errorTrendChartOption}}"
      height="200"
      bindchartReady="onChartReady"
    ></ec-canvas>
  </view>
</view>
```

**JS 逻辑**:
```javascript
// 图表准备就绪
onChartReady(e) {
  const chartId = e.currentTarget.id;
  const { chart } = e.detail;
  this.data.charts[chartId] = chart;
}

// 获取活跃用户数据并渲染图表
fetchActiveUsers(token) {
  wx.request({
    url: `${app.globalData.serverUrl}/analytics/users/active?days=${this.data.days}`,
    success: (res) => {
      const dailyStats = res.data.data.daily_stats || [];
      
      // 准备图表数据
      const categories = dailyStats.map(item => item.date.substring(5));
      const data = dailyStats.map(item => item.dau);
      
      // 生成折线图配置
      const chartOption = getLineChartConfig({
        data,
        categories,
        title: '',
        color: '#667eea'
      });
      
      this.setData({
        activeTrendChartOption: chartOption
      });
      
      // 更新已渲染的图表
      if (this.data.charts.activeTrendChart) {
        this.data.charts.activeTrendChart.setOption(chartOption);
      }
    }
  });
}
```

**页面卸载时销毁图表**:
```javascript
onUnload() {
  Object.values(this.data.charts).forEach(chart => {
    if (chart) {
      chart.dispose();
    }
  });
}
```

---

### 2.2 图表样式

**WXSS 样式**:
```css
.chart-section {
  background-color: #fff;
  border-radius: 16rpx;
  padding: 30rpx;
  margin-bottom: 30rpx;
  box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.05);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20rpx;
}

.section-title {
  font-size: 32rpx;
  font-weight: bold;
  color: #333;
}

.section-subtitle {
  font-size: 24rpx;
  color: #999;
}

.chart-container {
  width: 100%;
  position: relative;
}
```

---

## 第三部分：使用示例

### 3.1 折线图使用

```javascript
const { getLineChartConfig } = require('../../../utils/charts');

// 在页面中
const chartOption = getLineChartConfig({
  data: [150, 230, 224, 218, 135, 147, 260],
  categories: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
  title: '活跃用户趋势',
  color: '#667eea'
});

this.setData({
  chartOption: chartOption
});
```

### 3.2 饼图使用

```javascript
const { getPieChartConfig } = require('../../../utils/charts');

// 在页面中
const chartOption = getPieChartConfig({
  data: [
    { name: 'DeepSeek', value: 50 },
    { name: 'Qwen', value: 40 },
    { name: 'Doubao', value: 30 }
  ],
  title: 'AI 平台使用占比'
});

this.setData({
  chartOption: chartOption
});
```

### 3.3 动态更新图表

```javascript
// 获取图表实例
const chart = this.data.charts.myChart;

// 更新配置
chart.setOption({
  series: [{
    data: [newData1, newData2, newData3]
  }]
});
```

---

## 第四部分：性能优化

### 4.1 图表渲染优化

**Canvas 尺寸适配**:
```javascript
const dpr = wx.getSystemInfoSync().pixelRatio;
canvasNode.width = this.data.canvasWidth * dpr;
canvasNode.height = this.data.canvasHeight * dpr;
ctx.scale(dpr, dpr);
```

**图表销毁**:
```javascript
onUnload() {
  Object.values(this.data.charts).forEach(chart => {
    if (chart) {
      chart.dispose();
    }
  });
}
```

### 4.2 数据更新优化

**增量更新**:
```javascript
// 使用 notMerge = true 完全替换配置
chart.setOption(newOption, true);

// 使用 notMerge = false 合并更新
chart.setOption(partialOption, false);
```

**防抖处理**:
```javascript
// 避免频繁更新
if (this.updateTimer) {
  clearTimeout(this.updateTimer);
}

this.updateTimer = setTimeout(() => {
  chart.setOption(option);
}, 300);
```

---

## 第五部分：后续改进计划

### P1 改进项

1. **完整 ECharts 库**
   - 替换简化版为完整版 echarts-for-weixin
   - 支持更多图表类型
   - 支持交互功能

2. **图表交互**
   - 点击数据点查看详情
   - 图表缩放/平移
   - 数据筛选

### P2 改进项

3. **导出功能**
   - 导出图表为图片
   - 导出图表数据
   - 分享图表

4. **动画效果**
   - 图表加载动画
   - 数据更新动画
   - 过渡效果

---

## 第六部分：故障排查

### 6.1 常见问题

**问题 1**: 图表不显示

```
原因：
1. canvas 节点未找到
2. 图表尺寸为 0
3. 配置项错误

解决：
1. 检查 canvasId 是否正确
2. 确保父容器有明确尺寸
3. 检查 chartOption 配置
```

**问题 2**: 图表显示模糊

```
原因：未考虑设备像素比
解决：
const dpr = wx.getSystemInfoSync().pixelRatio;
canvasNode.width = width * dpr;
canvasNode.height = height * dpr;
ctx.scale(dpr, dpr);
```

**问题 3**: 内存泄漏

```
原因：图表未正确销毁
解决：
onUnload() {
  Object.values(this.data.charts).forEach(chart => {
    if (chart) chart.dispose();
  });
}
```

---

**文档结束**
