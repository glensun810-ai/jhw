# 前端状态管理使用指南

**创建日期**: 2026-02-22  
**版本**: v1.0

---

## 一、快速开始

### 1.1 导入 Store

```javascript
import store from '../../store/index';
import { observer, useStore } from '../../utils/observer';
```

### 1.2 读取状态

```javascript
// 读取单个状态
const executionId = store.getState('diagnosis.currentExecutionId');
const status = store.getState('diagnosis.status');

// 读取完整状态
const fullState = store.getFullState();
```

### 1.3 更新状态

```javascript
// 更新单个状态
store.setState('diagnosis.status', 'running');

// 批量更新
store.batchSetState({
  'diagnosis.status': 'completed',
  'diagnosis.progress': 100
});

// 持久化保存
store.setState('user.openid', 'xxx', true);
```

### 1.4 订阅状态变化

```javascript
// 订阅状态变化
const unsubscribe = store.subscribe('diagnosis.status', (newValue, oldValue) => {
  console.log('诊断状态变化:', newValue);
});

// 取消订阅
unsubscribe();
```

---

## 二、在页面中使用

### 2.1 基础用法

```javascript
// pages/index/index.js
import store from '../../store/index';
import { observer } from '../../utils/observer';

Page({
  data: {
    diagnosisStatus: 'idle',
    progress: 0
  },

  onLoad() {
    // 从 Store 初始化数据
    this.setData({
      diagnosisStatus: store.getState('diagnosis.status'),
      progress: store.getState('diagnosis.progress')
    });

    // 创建观察者
    this.storeObserver = observer(this, [
      'diagnosis.status',
      'diagnosis.progress'
    ]);
  },

  onUnload() {
    // 清理观察者
    this.storeObserver.dispose();
  },

  startDiagnosis() {
    // 更新 Store 状态
    store.diagnosis.start('execution-123');
    
    // 显示加载提示
    store.ui.showLoading('正在启动诊断...');
  }
});
```

### 2.2 在 results 页面使用

```javascript
// pages/results/results.js
import store from '../../store/index';
import { observer } from '../../utils/observer';

Page({
  data: {
    diagnosisResults: null,
    status: 'idle'
  },

  onLoad(options) {
    // 从 Store 获取诊断结果
    const results = store.getState('diagnosis.results');
    const status = store.getState('diagnosis.status');

    if (results && status === 'completed') {
      this.setData({ diagnosisResults: results });
    }

    // 观察状态变化
    this.storeObserver = observer(this, [
      'diagnosis.status',
      'diagnosis.results'
    ]);
  },

  onUnload() {
    this.storeObserver.dispose();
  }
});
```

---

## 三、便捷方法

### 3.1 诊断状态方法

```javascript
// 开始诊断
store.diagnosis.start(executionId);

// 更新进度
store.diagnosis.updateProgress(50, 'ai_fetching');

// 完成诊断
store.diagnosis.complete(results);

// 诊断失败
store.diagnosis.fail(new Error('网络错误'));

// 重置状态
store.diagnosis.reset();
```

### 3.2 UI 状态方法

```javascript
// 显示加载
store.ui.showLoading('加载中...');

// 隐藏加载
store.ui.hideLoading();

// 显示成功提示
store.ui.showToast('操作成功');

// 显示错误提示
store.ui.showError('操作失败');
```

---

## 四、状态结构

```javascript
{
  // 用户状态
  user: {
    openid: '',
    userInfo: null,
    permissions: [],
    isLoggedIn: false,
    token: null
  },

  // 诊断状态
  diagnosis: {
    currentExecutionId: null,
    status: 'idle', // idle | running | completed | failed
    progress: 0,
    stage: 'init',
    results: null,
    error: null
  },

  // UI 状态
  ui: {
    loading: false,
    error: null,
    theme: 'light',
    toast: null
  },

  // 缓存数据
  cache: {
    lastDiagnosticResults: null,
    lastUpdateTime: null
  }
}
```

---

## 五、最佳实践

### 5.1 观察者生命周期

```javascript
Page({
  onLoad() {
    // 创建观察者
    this.storeObserver = observer(this, ['diagnosis.status']);
  },

  onUnload() {
    // 必须清理观察者，避免内存泄漏
    this.storeObserver.dispose();
  }
});
```

### 5.2 状态持久化

```javascript
// 用户登录成功后，持久化用户状态
store.setState('user.isLoggedIn', true, true);
store.setState('user.openid', 'xxx', true);

// 下次启动时自动加载
store.loadPersistedState();
```

### 5.3 批量更新

```javascript
// 使用批量更新，避免多次 setData
store.batchSetState({
  'diagnosis.status': 'completed',
  'diagnosis.progress': 100,
  'diagnosis.results': results
});
```

---

## 六、注意事项

### 6.1 避免的问题

1. **不要忘记清理观察者**
   ```javascript
   // ❌ 错误
   Page({
     onLoad() {
       observer(this, ['diagnosis.status']);
     }
     // 没有 onUnload 清理
   });

   // ✅ 正确
   Page({
     onLoad() {
       this.storeObserver = observer(this, ['diagnosis.status']);
     },
     onUnload() {
       this.storeObserver.dispose();
     }
   });
   ```

2. **不要直接修改状态对象**
   ```javascript
   // ❌ 错误
   const user = store.getState('user');
   user.openid = 'xxx';

   // ✅ 正确
   store.setState('user.openid', 'xxx');
   ```

3. **不要频繁更新状态**
   ```javascript
   // ❌ 错误 - 频繁触发更新
   for (let i = 0; i < 100; i++) {
     store.setState('diagnosis.progress', i);
   }

   // ✅ 正确 - 使用防抖或批量更新
   let progress = 0;
   setInterval(() => {
     progress += 10;
     if (progress >= 100) {
       store.diagnosis.complete(results);
     } else {
       store.diagnosis.updateProgress(progress);
     }
   }, 1000);
   ```

---

## 七、迁移指南

### 7.1 从 Storage 迁移到 Store

**迁移前**:
```javascript
// 读取
const executionId = wx.getStorageSync('currentExecutionId');

// 写入
wx.setStorageSync('diagnosisStatus', 'running');
```

**迁移后**:
```javascript
// 读取
const executionId = store.getState('diagnosis.currentExecutionId');

// 写入
store.setState('diagnosis.status', 'running');
```

### 7.2 逐步迁移策略

1. **第一步**: 在新功能中使用 Store
2. **第二步**: 逐步迁移现有功能
3. **第三步**: 保留 Storage 作为备份
4. **第四步**: 完全迁移到 Store

---

**文档版本**: v1.0  
**最后更新**: 2026-02-22
