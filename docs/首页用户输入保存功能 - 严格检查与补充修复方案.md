# 首页用户输入保存功能 - 严格检查与补充修复方案

**检查日期**: 2026-02-21
**优先级**: P0 (最紧急)
**状态**: ⚠️ 发现严重遗漏

---

## 一、严格检查结果

### 1.1 当前实际状态（逐行验证）

#### ✅ 已实现功能
| 功能 | 代码位置 | 状态 | 验证 |
|------|---------|------|------|
| 品牌名称保存 | `saveCurrentInput()` 345 行 | ✅ 存在 | 已验证 |
| 竞品列表保存 | `saveCurrentInput()` 345 行 | ✅ 存在 | 已验证 |
| 品牌名称恢复 | `restoreDraft()` 361 行 | ✅ 存在 | 已验证 |
| 竞品列表恢复 | `restoreDraft()` 361 行 | ✅ 存在 | 已验证 |
| AI 平台偏好加载 | `loadUserPlatformPreferences()` 392 行 | ✅ 存在 | 已验证 |
| AI 平台偏好保存 | `saveUserPlatformPreferences()` 461 行 | ✅ 存在 | 已验证 |

#### ❌ 缺失功能（严格验证后确认）
| 功能 | 代码位置 | 状态 | 说明 |
|------|---------|------|------|
| **customQuestions 保存** | `saveCurrentInput()` 345 行 | ❌ **未实现** | 第 347 行只获取了 brandName, currentCompetitor, competitorBrands |
| **customQuestions 恢复** | `restoreDraft()` 361 行 | ❌ **未实现** | 第 372-375 行只恢复了 brandName, currentCompetitor, competitorBrands |
| **问题输入保存触发** | `onCustomQuestionInput()` 517 行 | ❌ **未实现** | 无 saveCurrentInput 调用 |
| **添加问题保存触发** | `addCustomQuestion()` 526 行 | ❌ **未实现** | 无 saveCurrentInput 调用 |
| **删除问题保存触发** | `removeCustomQuestion()` 533 行 | ❌ **未实现** | 无 saveCurrentInput 调用 |
| **AI 平台选择保存触发** | `toggleModelSelection()` 561 行 | ❌ **未实现** | 无 saveUserPlatformPreferences 调用 |
| **全选平台保存触发** | `selectAllModels()` 576 行 | ❌ **未实现** | 无 saveUserPlatformPreferences 调用 |
| **清空/重置功能** | 全局搜索 | ❌ **未实现** | 仅有 clearSystemCache（清理缓存，非重置输入） |

---

## 二、代码证据

### 2.1 saveCurrentInput 未保存 customQuestions

**当前代码（第 345-357 行）**:
```javascript
saveCurrentInput: function() {
  const { brandName, currentCompetitor, competitorBrands } = this.data;
  // ↑ 未获取 customQuestions

  wx.setStorageSync('draft_diagnostic_input', {
    brandName: brandName || '',
    currentCompetitor: currentCompetitor || '',
    competitorBrands: competitorBrands || [],
    updatedAt: Date.now()
    // ↑ 未保存 customQuestions
  });

  console.log('草稿已自动保存', { brandName, currentCompetitor });
  // ↑ 日志中也未提及 customQuestions
}
```

**结论**: ❌ **customQuestions 未被保存**

---

### 2.2 restoreDraft 未恢复 customQuestions

**当前代码（第 361-383 行）**:
```javascript
restoreDraft: function() {
  const draft = wx.getStorageSync('draft_diagnostic_input');
  
  if (draft && (draft.brandName || draft.competitorBrands?.length > 0)) {
    const now = Date.now();
    const draftAge = now - draft.updatedAt;
    const sevenDays = 7 * 24 * 60 * 60 * 1000;

    if (draftAge < sevenDays) {
      this.setData({
        brandName: draft.brandName || '',
        currentCompetitor: draft.currentCompetitor || '',
        competitorBrands: draft.competitorBrands || []
        // ↑ 未恢复 customQuestions
      });
      console.log('草稿已恢复', draft);
    } else {
      wx.removeStorageSync('draft_diagnostic_input');
      console.log('草稿已过期，已清除');
    }
  }
}
```

**结论**: ❌ **customQuestions 未被恢复**

---

### 2.3 toggleModelSelection 未触发保存

**当前代码（第 561-574 行）**:
```javascript
toggleModelSelection: function(e) {
  const { type, index } = e.currentTarget.dataset;
  const key = type === 'domestic' ? 'domesticAiModels' : 'overseasAiModels';
  const models = this.data[key];

  if (models[index].disabled) {
    wx.showToast({ title: '该模型暂未配置', icon: 'none' });
    return;
  }

  models[index].checked = !models[index].checked;
  this.setData({ [key]: models });
  this.updateSelectedModelCount();
  // ↑ 无 this.saveUserPlatformPreferences() 调用
}
```

**结论**: ❌ **AI 平台选择变更后未触发保存**

---

### 2.4 清空/重置功能完全缺失

**全局搜索结果**:
- ✅ 有 `clearSystemCache()` (第 1461 行) - 但这是清理系统缓存，不是重置用户输入
- ❌ **无** `resetInput()` 或 `clearInput()` 函数
- ❌ **无** 清空品牌、竞品、自定义问题的功能
- ❌ **无** 重置 AI 平台到默认选择的按钮

**结论**: ❌ **用户无法手动清空/重置输入**

---

## 三、完整修复方案（补充版）

### 3.1 P0 必须修复项（9 项）

| 序号 | 修复项 | 位置 | 修复内容 | 优先级 |
|------|--------|------|---------|--------|
| 1 | `saveCurrentInput` 保存 customQuestions | 345 行 | 添加 customQuestions 字段 | P0 |
| 2 | `restoreDraft` 恢复 customQuestions | 361 行 | 添加 customQuestions 恢复 | P0 |
| 3 | `onCustomQuestionInput` 触发保存 | 517 行 | 添加防抖保存 | P0 |
| 4 | `addCustomQuestion` 触发保存 | 526 行 | 添加保存调用 | P0 |
| 5 | `removeCustomQuestion` 触发保存 | 533 行 | 添加保存调用 | P0 |
| 6 | `toggleModelSelection` 触发保存 | 561 行 | 添加保存调用 | P0 |
| 7 | `selectAllModels` 触发保存 | 576 行 | 添加保存调用 | P0 |
| 8 | **新增 `resetAllInput` 函数** | 新增 | **清空所有输入并恢复默认** | **P0** |
| 9 | **新增"清空重置"按钮** | WXML | **在界面添加重置按钮** | **P0** |

---

### 3.2 新增功能：清空/重置功能

#### 3.2.1 新增 resetAllInput 函数

**位置**: `saveCurrentInput` 函数之后

**功能**:
- 清空品牌名称
- 清空竞品列表
- 重置自定义问题为默认 3 个空问题
- 重置 AI 平台为默认选择（DeepSeek、豆包、通义千问、智谱 AI）
- 清除本地存储的草稿

**代码**:
```javascript
/**
 * P0 新增：清空所有输入并恢复默认
 */
resetAllInput: function() {
  wx.showModal({
    title: '确认清空',
    content: '确定要清空所有输入吗？这将清空品牌、竞品、自定义问题和 AI 平台选择。',
    confirmText: '确定清空',
    confirmColor: '#e74c3c',
    success: (res) => {
      if (res.confirm) {
        // 1. 清空品牌和竞品
        this.setData({
          brandName: '',
          currentCompetitor: '',
          competitorBrands: [],
          // 2. 重置自定义问题为默认 3 个空问题
          customQuestions: [{text: '', show: true}, {text: '', show: true}, {text: '', show: true}],
          selectedQuestionCount: 0
        });
        
        // 3. 重置 AI 平台为默认选择
        this.resetAIPlatformsToDefault();
        
        // 4. 清除本地存储的草稿
        wx.removeStorageSync('draft_diagnostic_input');
        
        // 5. 清除 AI 平台偏好（下次使用默认配置）
        wx.removeStorageSync(STORAGE_KEY_PLATFORM_PREFS);
        
        console.log('所有输入已清空并恢复默认');
        
        wx.showToast({
          title: '已清空并恢复默认',
          icon: 'success'
        });
      }
    }
  });
},

/**
 * P0 新增：重置 AI 平台为默认选择
 */
resetAIPlatformsToDefault: function() {
  // 重置国内平台为默认选中
  const updatedDomestic = this.data.domesticAiModels.map(model => ({
    ...model,
    checked: DEFAULT_AI_PLATFORMS.domestic.includes(model.name) && !model.disabled
  }));
  
  // 重置海外平台为默认不选中
  const updatedOverseas = this.data.overseasAiModels.map(model => ({
    ...model,
    checked: DEFAULT_AI_PLATFORMS.overseas.includes(model.name)
  }));
  
  this.setData({
    domesticAiModels: updatedDomestic,
    overseasAiModels: updatedOverseas,
    selectedModelCount: DEFAULT_AI_PLATFORMS.domestic.length
  });
  
  console.log('AI 平台已恢复默认选择');
}
```

---

#### 3.2.2 在 WXML 添加"清空重置"按钮

**位置**: `pages/index/index.wxml` 高级设置区域或主操作按钮附近

**代码**:
```xml
<!-- 清空重置按钮 -->
<view class="reset-section">
  <button class="btn-reset" bindtap="resetAllInput">
    <text class="reset-icon">🗑️</text>
    <text class="reset-text">清空所有输入</text>
  </button>
</view>
```

**样式 (index.wxss)**:
```css
/* 清空重置按钮样式 */
.reset-section {
  margin: 20rpx 0;
  text-align: center;
}

.btn-reset {
  display: inline-flex;
  align-items: center;
  gap: 8rpx;
  padding: 16rpx 32rpx;
  background: rgba(231, 76, 60, 0.1);
  border: 1px solid rgba(231, 76, 60, 0.3);
  border-radius: 8rpx;
  color: #e74c3c;
  font-size: 26rpx;
  font-weight: 500;
}

.btn-reset:active {
  background: rgba(231, 76, 60, 0.2);
}

.reset-icon {
  font-size: 28rpx;
}
```

---

### 3.3 默认配置逻辑

#### 3.3.1 默认 AI 平台配置

**当前配置（第 19-27 行）**:
```javascript
const DEFAULT_AI_PLATFORMS = {
  // 国内平台默认选中（已验证可用）
  domestic: ['DeepSeek', '豆包', '通义千问', '智谱 AI'],
  // 海外平台默认不选中（网络延迟高，需手动开启）
  overseas: []
};
```

**逻辑**:
- ✅ 国内已验证平台：DeepSeek、豆包、通义千问、智谱 AI
- ✅ 海外平台：默认不选中
- ✅ 新增平台时：
  - 国内平台 → 自动加入默认列表
  - 海外平台 → 不加入默认列表，用户手动选择

---

### 3.4 用户输入优先级逻辑

**严格优先级**:
```
用户上一次输入 > 默认配置

具体规则:
1. 如果用户输入过品牌 → 恢复用户品牌
2. 如果用户未输入 → 显示空值（非默认品牌）
3. 如果用户选择过 AI 平台 → 恢复用户选择
4. 如果用户未选择 → 使用默认配置（DeepSeek、豆包、通义千问、智谱 AI）
```

**实现位置**:
- `restoreDraft()` - 恢复品牌、竞品、自定义问题
- `loadUserPlatformPreferences()` - 恢复 AI 平台选择

---

## 四、修复后行为说明

### 4.1 首次使用用户

**行为**:
1. 进入首页 → 显示空品牌、空竞品、3 个空问题
2. AI 平台默认选中：DeepSeek、豆包、通义千问、智谱 AI
3. 用户输入后 → 自动保存
4. 退出后重新进入 → 恢复用户输入

### 4.2 有过输入的用户

**行为**:
1. 进入首页 → 自动恢复上次的品牌、竞品、自定义问题
2. AI 平台恢复用户上次选择
3. 用户可以继续修改
4. 点击"清空所有输入" → 清空并恢复默认

### 4.3 点击"清空所有输入"后

**行为**:
1. 品牌名称 → 清空
2. 竞品列表 → 清空
3. 自定义问题 → 重置为 3 个空问题
4. AI 平台 → 恢复默认（DeepSeek、豆包、通义千问、智谱 AI）
5. 本地草稿 → 清除
6. AI 平台偏好 → 清除（下次使用默认配置）

---

## 五、验证清单

### 5.1 自定义问题保存验证

- [ ] 输入自定义问题"华为性价比如何？"
- [ ] 退出小程序
- [ ] 重新进入
- [ ] **预期**: 问题"华为性价比如何？"仍然存在

### 5.2 AI 平台选择保存验证

- [ ] 取消"豆包"，选中"Kimi"
- [ ] 退出小程序
- [ ] 重新进入
- [ ] **预期**: "豆包"未选中，"Kimi"选中

### 5.3 清空重置功能验证

- [ ] 输入品牌"华为"、竞品"苹果"、问题"华为 vs 苹果"
- [ ] 选择"Kimi"
- [ ] 点击"清空所有输入"
- [ ] 确认清空
- [ ] **预期**: 
  - 品牌名称为空
  - 竞品列表为空
  - 自定义问题为 3 个空问题
  - AI 平台恢复默认（DeepSeek、豆包、通义千问、智谱 AI）

### 5.4 默认配置验证

- [ ] 清空所有缓存
- [ ] 首次进入首页
- [ ] **预期**:
  - 品牌名称为空
  - 竞品列表为空
  - 自定义问题为 3 个空问题
  - AI 平台选中：DeepSeek、豆包、通义千问、智谱 AI

---

## 六、总结

### 6.1 当前状态

**已完成**:
- ✅ 品牌名称保存/恢复
- ✅ 竞品列表保存/恢复
- ✅ AI 平台偏好加载函数
- ✅ AI 平台偏好保存函数

**严重缺失**:
- ❌ customQuestions 保存/恢复
- ❌ 问题输入保存触发（3 处）
- ❌ AI 平台选择保存触发（2 处）
- ❌ **清空/重置功能完全缺失**

### 6.2 修复优先级

**P0 (必须修复)**:
1. customQuestions 保存/恢复
2. 问题输入保存触发（3 处）
3. AI 平台选择保存触发（2 处）
4. **新增清空/重置功能**

**P1 (建议修复)**:
- 无（所有 P0 修复完成后即为完整）

### 6.3 预计工作量

- 代码修改：约 20 分钟
- 测试验证：约 10 分钟
- **总计**: 约 30 分钟

---

**分析人**: AI Assistant
**审核状态**: ⏳ 待审核
**建议**: 立即实施 P0 修复，特别是清空/重置功能
