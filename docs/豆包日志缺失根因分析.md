# è±†åŒ…æ—¥å¿—ç¼ºå¤±æ ¹å› åˆ†ææŠ¥å‘Š

**åˆ†ææ—¥æœŸ**: 2026 å¹´ 2 æœˆ 19 æ—¥  
**é—®é¢˜**: æœ€æ–° 20 æ¡ ai_responses.jsonl è®°å½•ä¸­æ²¡æœ‰è±†åŒ…æ—¥å¿—

---

## æ‰§è¡Œæ‘˜è¦

### ğŸ”´ æ ¹æœ¬åŸå› ï¼š**è±†åŒ… API Key æœªé…ç½®**

**å…³é”®æ—¥å¿—è¯æ®**:
```
2026-02-19 13:45:00,408 - wechat_backend.api - WARNING - 
Adapter doubao has no API key configured, skipping warm-up
```

**å½±å“**:
- NXM æ‰§è¡Œå¼•æ“åœ¨è°ƒç”¨è±†åŒ…å‰æ£€æŸ¥ API Key
- ç”±äºæœªé…ç½®ï¼Œç›´æ¥è·³è¿‡è±†åŒ…å¹³å°
- å¯¼è‡´ ai_responses.jsonl ä¸­æ²¡æœ‰è±†åŒ…çš„æ‰§è¡Œè®°å½•

---

## è¯¦ç»†åˆ†æ

### 1. æœ€æ–° 20 æ¡æ—¥å¿—å¹³å°åˆ†å¸ƒ

```
å¹³å°åˆ†å¸ƒ:
  deepseek: 9 æ¡
  zhipu:    6 æ¡
  qwen:     5 æ¡
  è±†åŒ…ï¼š0 æ¡  âŒ
```

### 2. æ‰§è¡Œæµç¨‹åˆ†æ

**NXM æ‰§è¡Œå¼•æ“æµç¨‹** (`wechat_backend/nxm_execution_engine.py`):

```python
# ç¬¬ 116-120 è¡Œ
normalized_model_name = AIAdapterFactory.get_normalized_model_name(model_name)

# æ£€æŸ¥å¹³å°æ˜¯å¦å¯ç”¨
if not AIAdapterFactory.is_platform_available(normalized_model_name):
    raise ValueError(f"Model {model_name} not registered or not configured")

# è·å– API Key (ç¬¬ 124-126 è¡Œ)
api_key_value = config_manager.get_api_key(normalized_model_name)
if not api_key_value:
    raise ValueError(f"API key not configured for model {model_name}")
```

**é—®é¢˜ç‚¹**: 
- ç¬¬ 116 è¡Œæ£€æŸ¥å¹³å°æ˜¯å¦å¯ç”¨
- ç¬¬ 124-126 è¡Œæ£€æŸ¥ API Key æ˜¯å¦é…ç½®
- **å¦‚æœ API Key æœªé…ç½®ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œè·³è¿‡è¯¥å¹³å°**

### 3. is_platform_available() æ£€æŸ¥é€»è¾‘

**å·¥å‚ç±»æ£€æŸ¥** (`wechat_backend/ai_adapters/factory.py` ç¬¬ 183-196 è¡Œ):

```python
@classmethod
def is_platform_available(cls, platform_type: Union[AIPlatformType, str]) -> bool:
    """
    æ£€æŸ¥å¹³å°æ˜¯å¦å¯ç”¨ï¼ˆå·²æ³¨å†Œä¸” API å¯†é’¥å·²é…ç½®ï¼‰
    """
    if isinstance(platform_type, str):
        # å…ˆå°†è¾“å…¥åç§°é€šè¿‡ MODEL_NAME_MAP è½¬æ¢
        normalized_platform_type = cls.get_normalized_model_name(platform_type)
        try:
            platform_type = AIPlatformType(normalized_platform_type)
        except ValueError:
            return False

    return platform_type in cls._adapters
```

**æ³¨æ„**: è¿™ä¸ªæ–¹æ³•**åªæ£€æŸ¥å¹³å°æ˜¯å¦å·²æ³¨å†Œ**ï¼Œä¸æ£€æŸ¥ API Key æ˜¯å¦é…ç½®ã€‚

### 4. create() æ–¹æ³•çš„ API Key æ£€æŸ¥

**å·¥å‚ç±»åˆ›å»º** (`wechat_backend/ai_adapters/factory.py` ç¬¬ 198-225 è¡Œ):

```python
@classmethod
def create(cls, platform_type, api_key=None, model_name=None, **kwargs):
    # ...
    
    # If API key is not provided, try to get it from config
    if not api_key:
        from ..config_manager import config_manager
        api_key = config_manager.get_api_key(platform_type.value)
        if not api_key:
            raise ValueError(f"No API key provided or configured for platform: {platform_type.value}")
```

**è¿™é‡Œä¼šæ£€æŸ¥ API Key**ï¼Œå¦‚æœæœªé…ç½®åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚

### 5. äº¤å‰éªŒè¯ app.log

**å…³é”®æ—¥å¿—**:
```
2026-02-19 13:45:00,408 - WARNING - Adapter doubao has no API key configured, skipping warm-up
```

**è¯´æ˜**:
- åº”ç”¨å¯åŠ¨æ—¶è¿›è¡Œ adapter warm-up
- è±†åŒ… adapter å› ä¸º API Key æœªé…ç½®è¢«è·³è¿‡
- è¿™ç¡®è®¤äº†è±†åŒ… API Key ç¡®å®æœªé…ç½®

---

## é—®é¢˜å®šä½

### é—®é¢˜é“¾è·¯

```
1. NXM æ‰§è¡Œå¼•æ“é€‰æ‹©å¹³å°
       â†“
2. è°ƒç”¨ AIAdapterFactory.is_platform_available('doubao')
       â†“  (è¿”å› Trueï¼Œå› ä¸º adapter å·²æ³¨å†Œ)
3. è°ƒç”¨ config_manager.get_api_key('doubao')
       â†“  (è¿”å› Noneï¼Œå› ä¸ºæœªé…ç½®)
4. æŠ›å‡º ValueError: "API key not configured for model doubao"
       â†“
5. è·³è¿‡è±†åŒ…å¹³å°ï¼Œä¸æ‰§è¡Œè°ƒç”¨
       â†“
6. ai_responses.jsonl ä¸­æ²¡æœ‰è±†åŒ…è®°å½• âœ…
```

### ä¸ºä»€ä¹ˆå…¶ä»–å¹³å°æœ‰è®°å½•ï¼Ÿ

| å¹³å° | API Key é…ç½® | ç»“æœ |
|------|------------|------|
| deepseek | âœ… å·²é…ç½® | æ­£å¸¸æ‰§è¡Œï¼Œæœ‰æ—¥å¿— |
| zhipu | âœ… å·²é…ç½® | æ­£å¸¸æ‰§è¡Œï¼Œæœ‰æ—¥å¿— |
| qwen | âœ… å·²é…ç½® | æ­£å¸¸æ‰§è¡Œï¼Œæœ‰æ—¥å¿— |
| doubao | âŒ æœªé…ç½® | è·³è¿‡æ‰§è¡Œï¼Œæ— æ—¥å¿— |

---

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: é…ç½®è±†åŒ… API Key (æ¨è)

**æ­¥éª¤**:

1. è·å–è±†åŒ… API Key
   - è®¿é—®ï¼šhttps://console.volcengine.com/ark
   - åˆ›å»ºæˆ–è·å– API Key

2. é…ç½®åˆ°ç¯å¢ƒå˜é‡
   ```bash
   # .env æ–‡ä»¶
   DOUBAO_API_KEY=your_doubao_api_key_here
   
   # æˆ–è€…ä½¿ç”¨ ARK_API_KEY (å…¼å®¹æ ¼å¼)
   ARK_API_KEY=your_doubao_api_key_here
   ```

3. é‡å¯åº”ç”¨
   ```bash
   cd backend_python
   python3 main.py
   ```

4. éªŒè¯é…ç½®
   ```bash
   python3 -c "
   from wechat_backend.config_manager import config_manager
   key = config_manager.get_api_key('doubao')
   print(f'Doubao API Key configured: {bool(key)}')
   "
   ```

### æ–¹æ¡ˆ 2: ä¿®æ”¹æ‰§è¡Œé€»è¾‘ (ä¸´æ—¶æ–¹æ¡ˆ)

å¦‚æœæš‚æ—¶æ— æ³•è·å–è±†åŒ… API Keyï¼Œå¯ä»¥ä¿®æ”¹æ‰§è¡Œé€»è¾‘ï¼Œè·³è¿‡æœªé…ç½®çš„å¹³å°è€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼š

```python
# nxm_execution_engine.py ç¬¬ 124-126 è¡Œ
api_key_value = config_manager.get_api_key(normalized_model_name)
if not api_key_value:
    # ä¿®æ”¹ä¸ºï¼šè·³è¿‡è€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸
    api_logger.warning(f"Skipping {model_name}: API key not configured")
    continue  # è·³è¿‡å½“å‰å¹³å°ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª
```

---

## éªŒè¯æ­¥éª¤

### 1. æ£€æŸ¥å½“å‰é…ç½®çŠ¶æ€

```bash
cd backend_python
python3 -c "
from wechat_backend.config_manager import config_manager

platforms = ['doubao', 'deepseek', 'qwen', 'zhipu']
for p in platforms:
    key = config_manager.get_api_key(p)
    print(f'{p}: {\"âœ“ å·²é…ç½®\" if key else \"âœ— æœªé…ç½®\"}')"
```

æœŸæœ›è¾“å‡ºï¼ˆå½“å‰ï¼‰:
```
doubao: âœ— æœªé…ç½®
deepseek: âœ“ å·²é…ç½®
qwen: âœ“ å·²é…ç½®
zhipu: âœ“ å·²é…ç½®
```

### 2. é…ç½®åéªŒè¯

é…ç½®è±†åŒ… API Key åï¼Œé‡æ–°æ‰§è¡Œæµ‹è¯•ï¼š

```bash
# è¿è¡Œ NXM æ‰§è¡Œå¼•æ“
python3 wechat_backend/nxm_execution_engine.py

# æ£€æŸ¥æ—¥å¿—
tail -20 data/ai_responses/ai_responses.jsonl | python3 -c "
import sys, json
from collections import Counter
platforms = Counter()
for line in sys.stdin:
    r = json.loads(line)
    p = r.get('platform', 'Unknown')
    if isinstance(p, dict): p = p.get('name', 'Unknown')
    platforms[p] += 1
for p, c in platforms.most_common():
    print(f'{p}: {c}')"
```

æœŸæœ›è¾“å‡ºï¼ˆé…ç½®åï¼‰:
```
doubao: X æ¡
deepseek: X æ¡
qwen: X æ¡
zhipu: X æ¡
```

---

## ç»“è®º

### âœ… é—®é¢˜ç¡®è®¤

**è±†åŒ…æ—¥å¿—ç¼ºå¤±çš„åŸå› **: **è±†åŒ… API Key æœªé…ç½®**

**ä¸æ˜¯ä»¥ä¸‹é—®é¢˜**:
- âŒ ä¸æ˜¯æ—¥å¿—è®°å½•é—æ¼
- âŒ ä¸æ˜¯ NXM æ‰§è¡Œå¼•æ“ bug
- âŒ ä¸æ˜¯ ai_response_logger_v2 é—®é¢˜
- âŒ ä¸æ˜¯å¹³å°æ³¨å†Œé—®é¢˜

### ğŸ”§ ä¿®å¤æ–¹æ³•

**é…ç½®è±†åŒ… API Key å³å¯è§£å†³**:
```bash
export DOUBAO_API_KEY=your_api_key_here
# æˆ–
export ARK_API_KEY=your_api_key_here
```

### ğŸ“Š é¢„æœŸæ•ˆæœ

é…ç½®åï¼ŒNXM æ‰§è¡Œå¼•æ“å°†ï¼š
1. æ­£å¸¸è°ƒç”¨è±†åŒ… API
2. è·å–è±†åŒ…è¿”å›çš„å“åº”
3. è®°å½•åˆ° ai_responses.jsonl
4. å®ç° N ä¸ªé—®é¢˜*M ä¸ªå¹³å°çš„å®Œæ•´çŸ©é˜µ

---

**æŠ¥å‘Šäºº**: AI ç³»ç»Ÿæ¶æ„å¸ˆ  
**æ—¥æœŸ**: 2026 å¹´ 2 æœˆ 19 æ—¥
