# P0-1 用户注册流程实施报告

**文档版本**: v1.0  
**创建日期**: 2026-02-21  
**实施状态**: ✅ 已完成  

---

## 执行摘要

### 问题描述

前端注册页面已存在，但后端接口仅为 mock 实现，导致：
- 新用户无法通过手机号注册
- 只能依赖微信登录，限制用户增长渠道

### 实施内容

本次实施完成了完整的用户注册流程，包括：
1. ✅ 数据库 schema 扩展（支持 phone/password）
2. ✅ 验证码发送端点（含 mock SMS）
3. ✅ 用户注册端点（bcrypt 密码加密）
4. ✅ 手机号登录端点
5. ✅ 前端认证工具增强

### 新增 API 端点

| 端点 | 方法 | 功能 | 状态 |
|------|------|------|------|
| `/api/send-verification-code` | POST | 发送短信验证码 | ✅ 完成 |
| `/api/register` | POST | 用户注册 | ✅ 完成 |
| `/api/login/phone` | POST | 手机号密码登录 | ✅ 完成 |

---

## 第一部分：后端实现

### 1.1 依赖安装

**文件**: `backend_python/requirements.txt`

```text
bcrypt>=4.0.0         # 用于密码加密
```

**安装命令**:
```bash
pip install bcrypt>=4.0.0
```

---

### 1.2 数据库 Schema 扩展

**文件**: `backend_python/wechat_backend/database.py`

**变更**: users 表新增字段

```sql
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    openid TEXT UNIQUE,          -- 微信 openid（可选）
    phone TEXT UNIQUE,           -- 手机号（新增）
    password_hash TEXT,          -- 密码哈希（新增）
    nickname TEXT,
    avatar_url TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

**新增函数**:

```python
def save_verification_code(phone: str, code: str):
    """保存验证码（内存存储，生产环境应使用 Redis）"""

def verify_code(phone: str, code: str) -> bool:
    """验证验证码"""

def create_user_with_phone(phone: str, password_hash: str, nickname: str = None) -> int:
    """创建手机号用户"""

def get_user_by_phone(phone: str) -> dict:
    """通过手机号查询用户"""

def get_user_by_id(user_id: int) -> dict:
    """通过 ID 查询用户"""
```

---

### 1.3 API 端点实现

**文件**: `backend_python/wechat_backend/views.py`

#### 1.3.1 发送验证码端点

```python
@wechat_bp.route('/api/send-verification-code', methods=['POST'])
@rate_limit(limit=5, window=60, per='ip')
def send_verification_code():
    """Send verification code to user"""
    
    # 1. 验证手机号格式
    phone = data.get('phone')
    phone_pattern = r'^1[3-9]\d{9}$'
    
    # 2. 生成 6 位验证码
    verification_code = f"{random.randint(100000, 999999)}"
    
    # 3. 保存验证码（5 分钟有效期）
    save_verification_code(phone, verification_code)
    
    # 4. 返回验证码（开发环境，生产环境应移除 mock_code）
    return jsonify({
        'status': 'success',
        'message': 'Verification code sent successfully',
        'phone': phone,
        'mock_code': verification_code  # 生产环境移除！
    })
```

**特性**:
- ✅ 手机号格式验证
- ✅ 限流保护（5 次/分钟/IP）
- ✅ 验证码 5 分钟有效期
- ✅ 最多 5 次验证尝试

**生产环境建议**:
```python
# 替换为真实 SMS 服务
from aliyun_sms import send_sms
send_sms(phone, verification_code)
```

---

#### 1.3.2 用户注册端点

```python
@wechat_bp.route('/api/register', methods=['POST'])
@rate_limit(limit=5, window=60, per='ip')
def register_user():
    """Register new user with phone and password"""
    
    # 1. 验证必填字段
    phone = data.get('phone')
    verification_code = data.get('verificationCode')
    password = data.get('password')
    
    # 2. 验证手机号格式
    phone_pattern = r'^1[3-9]\d{9}$'
    
    # 3. 验证密码强度（至少 6 位）
    if len(password) < 6:
        return jsonify({'error': 'Password must be at least 6 characters long'}), 400
    
    # 4. 验证验证码
    if not verify_code(phone, verification_code):
        return jsonify({'error': 'Invalid or expired verification code'}), 400
    
    # 5. 检查手机号是否已注册
    existing_user = get_user_by_phone(phone)
    if existing_user:
        return jsonify({'error': 'Phone number already registered'}), 409
    
    # 6. bcrypt 密码加密
    password_hash = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt()).decode('utf-8')
    
    # 7. 创建用户
    user_id = create_user_with_phone(phone, password_hash)
    
    # 8. 生成 JWT token
    token = jwt_manager.generate_token(str(user_id), expires_delta=timedelta(hours=24))
    
    return jsonify({
        'status': 'success',
        'message': 'User registered successfully',
        'user_id': user_id,
        'token': token,
        'expires_in': 86400  # 24 hours
    })
```

**安全特性**:
- ✅ 密码 bcrypt 加密（加盐）
- ✅ 验证码验证
- ✅ 手机号唯一性检查
- ✅ 限流保护
- ✅ JWT token 生成

---

#### 1.3.3 手机号登录端点

```python
@wechat_bp.route('/api/login/phone', methods=['POST'])
@rate_limit(limit=10, window=60, per='ip')
def login_by_phone():
    """Login with phone and password"""
    
    # 1. 获取用户
    user = get_user_by_phone(phone)
    if not user:
        return jsonify({'error': 'Invalid phone or password'}), 401
    
    # 2. 验证密码
    if not bcrypt.checkpw(password.encode('utf-8'), user['password_hash'].encode('utf-8')):
        return jsonify({'error': 'Invalid phone or password'}), 401
    
    # 3. 生成 JWT token
    token = jwt_manager.generate_token(str(user['id']), expires_delta=timedelta(hours=24))
    
    return jsonify({
        'status': 'success',
        'message': 'Login successful',
        'user_id': user['id'],
        'token': token,
        'expires_in': 86400,
        'profile': {
            'phone': user['phone'],
            'nickname': user['nickname'],
            'avatar_url': user['avatar_url']
        }
    })
```

---

### 1.4 验证码存储机制

**当前实现**: 内存存储（开发环境）

```python
_verification_codes = {}

def save_verification_code(phone: str, code: str):
    expiration_time = datetime.now() + timedelta(minutes=5)
    _verification_codes[phone] = {
        'code': code,
        'expires_at': expiration_time,
        'attempts': 0
    }
```

**生产环境建议**: 使用 Redis

```python
import redis

redis_client = redis.Redis(host='localhost', port=6379, db=0)

def save_verification_code(phone: str, code: str):
    key = f'verification_code:{phone}'
    redis_client.setex(key, 300, code)  # 5 分钟过期

def verify_code(phone: str, code: str) -> bool:
    key = f'verification_code:{phone}'
    stored_code = redis_client.get(key)
    return stored_code and stored_code.decode() == code
```

---

## 第二部分：前端实现

### 2.1 配置文件更新

**文件**: `utils/config.js`

```javascript
const API_ENDPOINTS = {
  AUTH: {
    LOGIN: '/api/login',
    LOGIN_PHONE: '/api/login/phone',     // 新增：手机号密码登录
    VALIDATE_TOKEN: '/api/validate-token',
    REFRESH_TOKEN: '/api/refresh-token',
    SEND_VERIFICATION_CODE: '/api/send-verification-code',
    REGISTER: '/api/register'
  }
};
```

---

### 2.2 认证工具增强

**文件**: `utils/auth-enhanced.js`（新增）

```javascript
/**
 * 手机号密码登录
 */
const phoneLogin = (loginData) => {
  return new Promise((resolve, reject) => {
    post(API_ENDPOINTS.AUTH.LOGIN_PHONE, loginData)
      .then((userData) => {
        // 保存 token 和用户信息
        wx.setStorageSync('token', userData.token);
        wx.setStorageSync('user_id', userData.user_id);
        if (userData.profile) {
          wx.setStorageSync('userInfo', userData.profile);
        }
        resolve(userData);
      })
      .catch(reject);
  });
};

/**
 * 统一登录入口（支持微信登录和手机号登录）
 */
const login = (loginData) => {
  if (loginData && loginData.phone && loginData.password) {
    // 手机号密码登录
    return phoneLogin(loginData);
  } else {
    // 微信登录
    return wxLogin();
  }
};
```

---

### 2.3 注册页面更新

**文件**: `pages/register/register.js`

**变更**:
1. 引入增强版认证工具
2. 优化注册成功后的处理逻辑

```javascript
const { login } = require('../../utils/auth-enhanced.js');
const { sendVerificationCode, registerUser } = require('../../api/auth.js');

// 注册处理函数
async onRegister() {
  const { phone, verificationCode, password, confirmPassword } = this.data;

  // 验证逻辑...

  const res = await registerUser({
    phone: phone,
    verificationCode: verificationCode,
    password: password
  });

  if (res && res.status === 'success') {
    // 保存 token 和用户信息
    if (res.token) {
      wx.setStorageSync('token', res.token);
      wx.setStorageSync('user_id', res.user_id);
      wx.setStorageSync('isLoggedIn', true);
    }

    // 自动登录并跳转
    setTimeout(() => {
      wx.reLaunch({
        url: '/pages/index/index'
      });
    }, 1000);
  }
}
```

---

## 第三部分：测试验证

### 3.1 测试脚本

**文件**: `test_registration_flow.py`

**测试用例**:

| 测试项 | 描述 | 预期结果 | 状态 |
|--------|------|----------|------|
| 发送验证码 | 向有效手机号发送验证码 | 返回 200 + mock_code | ✅ |
| 用户注册 | 使用有效验证码注册 | 返回 200 + token | ✅ |
| 手机号登录 | 使用注册的手机号登录 | 返回 200 + token | ✅ |
| 无效手机号 | 发送验证码到无效格式手机号 | 返回 400 | ✅ |
| 弱密码 | 使用少于 6 位的密码注册 | 返回 400 | ✅ |
| 无效验证码 | 使用错误验证码注册 | 返回 400 | ✅ |

---

### 3.2 测试步骤

**运行测试**:
```bash
# 1. 启动后端服务
cd backend_python
python app.py

# 2. 运行测试脚本
python test_registration_flow.py
```

**预期输出**:
```
============================================================
品牌 AI 诊断系统 - 用户注册流程测试
============================================================

==================================================
测试 1: 发送验证码
==================================================
请求：POST /api/send-verification-code
手机号：13812345678
状态码：200
响应：{
  "status": "success",
  "message": "Verification code sent successfully",
  "phone": "13812345678",
  "mock_code": "123456"
}
✅ 验证码发送成功

==================================================
测试 2: 用户注册
==================================================
请求：POST /api/register
状态码：200
响应：{
  "status": "success",
  "message": "User registered successfully",
  "user_id": 1,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expires_in": 86400
}
✅ 用户注册成功

==================================================
测试 3: 手机号登录
==================================================
请求：POST /api/login/phone
状态码：200
响应：{
  "status": "success",
  "message": "Login successful",
  "user_id": 1,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expires_in": 86400,
  "profile": {
    "phone": "13812345678",
    "nickname": null,
    "avatar_url": null
  }
}
✅ 登录成功

✅ 所有测试通过！
============================================================
```

---

## 第四部分：安全考虑

### 4.1 密码安全

**当前实现**: bcrypt 加密（加盐）

```python
password_hash = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt())
```

**特性**:
- ✅ 自动加盐
- ✅ 抗彩虹表攻击
- ✅ 计算成本高（抗暴力破解）

---

### 4.2 验证码安全

**当前实现**:
- ✅ 6 位随机数字
- ✅ 5 分钟有效期
- ✅ 最多 5 次验证尝试
- ✅ 验证成功后立即销毁

**生产环境建议**:
- 使用 Redis 存储（分布式）
- 增加 IP 限流
- 增加图形验证码（防刷）

---

### 4.3 JWT Token

**配置**:
```python
token = jwt_manager.generate_token(str(user_id), expires_delta=timedelta(hours=24))
```

**特性**:
- ✅ 24 小时有效期
- ✅ HS256 签名算法
- ✅ 包含用户 ID 声明

**生产环境建议**:
- 使用环境变量存储 SECRET_KEY
- 实现 token 刷新机制
- 添加 token 黑名单

---

## 第五部分：生产环境部署清单

### 5.1 必须完成项

- [ ] 接入真实 SMS 服务（阿里云/腾讯云）
- [ ] 使用 Redis 存储验证码
- [ ] 移除 `/api/send-verification-code` 返回的 `mock_code`
- [ ] 配置环境变量 `SECRET_KEY`（JWT 签名）
- [ ] 配置 HTTPS（生产环境强制）
- [ ] 增加图形验证码（防刷）
- [ ] 实现 token 刷新端点 `/api/refresh-token`

### 5.2 建议完成项

- [ ] 密码强度策略（大小写 + 数字 + 特殊字符）
- [ ] 手机号归属地验证
- [ ] 用户协议/隐私政策确认
- [ ] 注册成功邮件通知
- [ ] 登录失败次数限制

---

## 第六部分：API 使用示例

### 6.1 发送验证码

```bash
curl -X POST http://127.0.0.1:5000/api/send-verification-code \
  -H "Content-Type: application/json" \
  -d '{"phone": "13812345678"}'
```

**响应**:
```json
{
  "status": "success",
  "message": "Verification code sent successfully",
  "phone": "13812345678",
  "mock_code": "123456"
}
```

---

### 6.2 用户注册

```bash
curl -X POST http://127.0.0.1:5000/api/register \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13812345678",
    "verificationCode": "123456",
    "password": "test123456"
  }'
```

**响应**:
```json
{
  "status": "success",
  "message": "User registered successfully",
  "user_id": 1,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expires_in": 86400
}
```

---

### 6.3 手机号登录

```bash
curl -X POST http://127.0.0.1:5000/api/login/phone \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13812345678",
    "password": "test123456"
  }'
```

**响应**:
```json
{
  "status": "success",
  "message": "Login successful",
  "user_id": 1,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expires_in": 86400,
  "profile": {
    "phone": "13812345678",
    "nickname": null,
    "avatar_url": null
  }
}
```

---

## 第七部分：故障排查

### 7.1 常见问题

**问题 1**: 验证码发送失败

```
错误：Invalid phone number format
原因：手机号格式不正确
解决：确保手机号符合 ^1[3-9]\d{9}$ 格式
```

**问题 2**: 注册失败 - 验证码无效

```
错误：Invalid or expired verification code
原因：
  1. 验证码已过期（>5 分钟）
  2. 验证码错误
  3. 验证尝试超过 5 次
解决：重新发送验证码
```

**问题 3**: 注册失败 - 手机号已注册

```
错误：Phone number already registered (HTTP 409)
原因：手机号已被使用
解决：使用其他手机号或走登录流程
```

**问题 4**: 登录失败

```
错误：Invalid phone or password
原因：
  1. 手机号未注册
  2. 密码错误
解决：检查手机号和密码，或重新注册
```

---

### 7.2 日志查看

**后端日志**:
```bash
# 查看应用日志
tail -f logs/app.log | grep -E "register|login|verification"
```

**关键日志**:
```
INFO - User registration endpoint accessed
INFO - Verification code sent to 13812345678 (mock: 123456)
INFO - User registered successfully: 13812345678, user_id: 1
INFO - Phone login endpoint accessed
INFO - User logged in successfully: 13812345678, user_id: 1
```

---

## 第八部分：后续改进计划

### P1 改进项

1. **SMS 服务集成**
   - 接入阿里云 SMS
   - 接入腾讯云 SMS
   - 实现服务商切换

2. **Redis 存储**
   - 验证码分布式存储
   - 支持多实例部署

3. **Token 刷新**
   - 实现 `/api/refresh-token` 端点
   - 双 token 机制（access + refresh）

### P2 改进项

4. **安全增强**
   - 图形验证码（防刷）
   - 密码强度策略
   - 登录失败锁定

5. **用户体验**
   - 注册进度提示
   - 密码强度指示器
   - 手机号归属地显示

---

**文档结束**
