# å“ç‰Œè¯Šæ–­ç³»ç»Ÿ - éƒ¨ç½²å’Œè¿ç»´æ‰‹å†Œ

**ç‰ˆæœ¬**: v1.0
**ç”Ÿæˆæ—¥æœŸ**: 2026-02-23
**é€‚ç”¨ç¯å¢ƒ**: ç”Ÿäº§ç¯å¢ƒ

---

## ä¸€ã€éƒ¨ç½²å‰å‡†å¤‡

### 1.1 ç³»ç»Ÿè¦æ±‚

**æœåŠ¡å™¨é…ç½®**:
- CPU: 2 æ ¸+
- å†…å­˜ï¼š4GB+
- ç£ç›˜ï¼š20GB+
- æ“ä½œç³»ç»Ÿï¼šmacOS / Linux

**è½¯ä»¶è¦æ±‚**:
- Python 3.10+
- Node.js 16+
- Git

### 1.2 ç¯å¢ƒå˜é‡é…ç½®

**å¤åˆ¶ç¤ºä¾‹æ–‡ä»¶**:
```bash
cd /Users/sgl/PycharmProjects/PythonProject
cp .env.example .env
```

**ç¼–è¾‘ .env æ–‡ä»¶**:
```bash
# AI Platform API Keys
ARK_API_KEY=your-doubao-api-key
DEEPSEEK_API_KEY=your-deepseek-api-key
QWEN_API_KEY=your-qwen-api-key
ZHIPU_API_KEY=your-zhipu-api-key

# æ•°æ®åŠ å¯†å¯†é’¥ï¼ˆæ–°å¢ï¼‰
DATA_ENCRYPTION_KEY=your-32-byte-base64-encoded-key

# è¿è¡Œç¯å¢ƒ
APP_ENV=production  # production, staging, development
FLASK_DEBUG=0

# å¾®ä¿¡å°ç¨‹åºé…ç½®
WECHAT_APP_ID=your-app-id
WECHAT_APP_SECRET=your-app-secret
```

**ç”ŸæˆåŠ å¯†å¯†é’¥**:
```bash
cd backend_python
python3 -c "
from cryptography.fernet import Fernet
key = Fernet.generate_key().decode()
print(f'DATA_ENCRYPTION_KEY={key}')
"
```

### 1.3 æ•°æ®åº“å¤‡ä»½

**å¤‡ä»½ç°æœ‰æ•°æ®åº“**:
```bash
cd backend_python
cp database.db database.db.backup.$(date +%Y%m%d_%H%M%S)
```

---

## äºŒã€éƒ¨ç½²æ­¥éª¤

### 2.1 ä»£ç éƒ¨ç½²

**æ–¹æ³• A: Git éƒ¨ç½²ï¼ˆæ¨èï¼‰**
```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /Users/sgl/PycharmProjects/PythonProject

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# æ£€æŸ¥ä»£ç çŠ¶æ€
git status
git log -1
```

**æ–¹æ³• B: æœ¬åœ°éƒ¨ç½²**
```bash
# ç¡®è®¤æœ¬åœ°ä»£ç å·²æäº¤
git add .
git commit -m "éƒ¨ç½²å…¨æ ˆä¿®å¤"
```

### 2.2 ä¾èµ–å®‰è£…

**Python ä¾èµ–**:
```bash
cd backend_python
pip3 install -r requirements.txt

# éªŒè¯å®‰è£…
python3 -c "
import flask
import sqlite3
from cryptography.fernet import Fernet
print('âœ… Python ä¾èµ–å®‰è£…æˆåŠŸ')
"
```

**Node.js ä¾èµ–** (å¦‚æœ‰):
```bash
cd /Users/sgl/PycharmProjects/PythonProject
npm install
```

### 2.3 æœåŠ¡å¯åŠ¨

**å¯åŠ¨åç«¯æœåŠ¡**:
```bash
cd backend_python

# åœæ­¢æ—§æœåŠ¡
pkill -f "python.*run.py"

# å¯åŠ¨æ–°æœåŠ¡
nohup python3 run.py > /tmp/flask.log 2>&1 &

# éªŒè¯å¯åŠ¨
sleep 3
ps aux | grep "python.*run.py" | grep -v grep
```

**æŸ¥çœ‹æ—¥å¿—**:
```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f /tmp/flask.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep ERROR /tmp/flask.log | tail -20
```

### 2.4 æœåŠ¡éªŒè¯

**å¥åº·æ£€æŸ¥**:
```bash
# API æµ‹è¯•
curl http://127.0.0.1:5000/api/test
# åº”è¿”å›ï¼š{"message": "Backend is working correctly!", "status": "success"}

# å¥åº·æ£€æŸ¥
curl http://127.0.0.1:5000/health
# åº”è¿”å›ï¼š{"status": "healthy", "timestamp": "..."}
```

**è¿è¡ŒéªŒè¯è„šæœ¬**:
```bash
cd /Users/sgl/PycharmProjects/PythonProject
python3 final_verification.py
# åº”æ˜¾ç¤ºï¼šé€šè¿‡ç‡ï¼š100.0%
```

---

## ä¸‰ã€è¿ç»´ç›‘æ§

### 3.1 æ—¥å¸¸æ£€æŸ¥æ¸…å•

**æ¯æ—¥æ£€æŸ¥**:
- [ ] æŸ¥çœ‹é”™è¯¯æ—¥å¿—
- [ ] æ£€æŸ¥ API å“åº”æ—¶é—´
- [ ] éªŒè¯æœåŠ¡è¿è¡ŒçŠ¶æ€
- [ ] æ£€æŸ¥ç£ç›˜ç©ºé—´

**æ¯å‘¨æ£€æŸ¥**:
- [ ] æŸ¥çœ‹é™æµç›‘æ§ç»Ÿè®¡
- [ ] æ£€æŸ¥æ•°æ®åº“å¤§å°
- [ ] å®¡æŸ¥äº‹åŠ¡ç»Ÿè®¡
- [ ] å¤‡ä»½æ•°æ®åº“

**æ¯æœˆæ£€æŸ¥**:
- [ ] æ€§èƒ½è¶‹åŠ¿åˆ†æ
- [ ] å®‰å…¨å®¡è®¡
- [ ] å®¹é‡è§„åˆ’
- [ ] æ—¥å¿—å½’æ¡£

### 3.2 ç›‘æ§å‘½ä»¤

**æœåŠ¡çŠ¶æ€**:
```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
ps aux | grep "python.*run.py" | grep -v grep

# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :5000

# æ£€æŸ¥è¿›ç¨‹èµ„æºä½¿ç”¨
top -pid $(pgrep -f "python.*run.py")
```

**æ—¥å¿—åˆ†æ**:
```bash
# æŸ¥çœ‹ä»Šæ—¥é”™è¯¯æ•°
grep "$(date +%Y-%m-%d)" backend_python/logs/app.log | grep ERROR | wc -l

# æŸ¥çœ‹æœ€é¢‘ç¹çš„é”™è¯¯
grep ERROR backend_python/logs/app.log | sort | uniq -c | sort -rn | head -10

# æŸ¥çœ‹æ…¢æŸ¥è¯¢
grep "æŸ¥è¯¢è€—æ—¶" backend_python/logs/app.log | tail -20
```

**æ•°æ®åº“ç›‘æ§**:
```bash
cd backend_python
python3 -c "
import sqlite3
conn = sqlite3.connect('database.db')
cursor = conn.cursor()

# æ•°æ®åº“å¤§å°
cursor.execute('PRAGMA database_size')
size = cursor.fetchone()[0] * 1024
print(f'æ•°æ®åº“å¤§å°ï¼š{size/1024/1024:.2f} MB')

# å„è¡¨è®°å½•æ•°
tables = ['test_records', 'sync_results', 'task_statuses', 'users']
for table in tables:
    cursor.execute(f'SELECT COUNT(*) FROM {table}')
    count = cursor.fetchone()[0]
    print(f'{table}: {count} æ¡è®°å½•')

conn.close()
"
```

### 3.3 é™æµç›‘æ§

**æŸ¥çœ‹ç»Ÿè®¡**:
```bash
cd backend_python
python3 -c "
import json
from pathlib import Path

stats_file = Path('monitoring_data/rate_limit_stats.json')
if stats_file.exists():
    with open(stats_file) as f:
        stats = json.load(f)
    
    print('é™æµç»Ÿè®¡:')
    print(f'  æ€»è¯·æ±‚æ•°ï¼š{stats.get(\"total_requests\", 0)}')
    print(f'  æ€»é™æµæ•°ï¼š{stats.get(\"total_limited\", 0)}')
    print(f'  é™æµç‡ï¼š{stats.get(\"limit_rate\", \"N/A\")}')
    
    if 'top_limited_endpoints' in stats:
        print('\nTop é™æµç«¯ç‚¹:')
        for endpoint, count in stats['top_limited_endpoints'][:5]:
            print(f'  {endpoint}: {count}')
else:
    print('é™æµç»Ÿè®¡æ–‡ä»¶ä¸å­˜åœ¨')
"
```

### 3.4 æ•°æ®æ¸…ç†

**æ‰‹åŠ¨æ¸…ç†**:
```bash
cd backend_python
python3 -c "
from wechat_backend.database.data_retention import cleanup_expired_data

# é¢„è§ˆæ¨¡å¼ï¼ˆä¸å®é™…åˆ é™¤ï¼‰
print('é¢„è§ˆæ¸…ç†ç»“æœ:')
stats = cleanup_expired_data(dry_run=True)
print(f'  é¢„è®¡åˆ é™¤ï¼š{stats[\"deleted_count\"]} æ¡è®°å½•')

# å®é™…æ¸…ç†ï¼ˆç§»é™¤ dry_run=Trueï¼‰
# stats = cleanup_expired_data()
"
```

**è‡ªåŠ¨æ¸…ç†** (éœ€é…ç½®):
```python
# åœ¨ run.py ä¸­æ·»åŠ 
from wechat_backend.database.data_retention import schedule_daily_cleanup

scheduler = schedule_daily_cleanup()
```

---

## å››ã€æ•…éšœæ’æŸ¥

### 4.1 å¸¸è§é—®é¢˜

**é—®é¢˜ 1: æœåŠ¡æ— æ³•å¯åŠ¨**

ç—‡çŠ¶:
```
Address already in use
Port 5000 is in use by another program
```

è§£å†³æ–¹æ¡ˆ:
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -i :5000

# åœæ­¢å ç”¨è¿›ç¨‹
kill -9 <PID>

# æˆ–ä½¿ç”¨ä¸åŒç«¯å£
export PORT=5001
python3 run.py
```

**é—®é¢˜ 2: æ•°æ®åº“è¿æ¥å¤±è´¥**

ç—‡çŠ¶:
```
sqlite3.OperationalError: unable to open database file
```

è§£å†³æ–¹æ¡ˆ:
```bash
# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la backend_python/database.db

# ä¿®å¤æƒé™
chmod 644 backend_python/database.db

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h
```

**é—®é¢˜ 3: å†…å­˜æ³„æ¼**

ç—‡çŠ¶:
```
è¿›ç¨‹å†…å­˜æŒç»­å¢é•¿
ç³»ç»Ÿå“åº”å˜æ…¢
```

è§£å†³æ–¹æ¡ˆ:
```bash
# é‡å¯æœåŠ¡
pkill -f "python.*run.py"
nohup python3 run.py > /tmp/flask.log 2>&1 &

# ç›‘æ§å†…å­˜ä½¿ç”¨
watch -n 1 'ps aux | grep "python.*run.py" | grep -v grep'
```

### 4.2 æ—¥å¿—çº§åˆ«è°ƒæ•´

**å¼€å‘ç¯å¢ƒ** (DEBUG):
```bash
# .env
APP_ENV=development
LOG_LEVEL=DEBUG
```

**ç”Ÿäº§ç¯å¢ƒ** (WARNING):
```bash
# .env
APP_ENV=production
LOG_LEVEL=WARNING
```

**ä¸´æ—¶è°ƒæ•´**:
```bash
# é‡å¯æœåŠ¡ç”Ÿæ•ˆ
pkill -f "python.*run.py"
nohup python3 run.py > /tmp/flask.log 2>&1 &
```

---

## äº”ã€å¤‡ä»½å’Œæ¢å¤

### 5.1 æ•°æ®åº“å¤‡ä»½

**æ‰‹åŠ¨å¤‡ä»½**:
```bash
cd backend_python
cp database.db database.db.backup.$(date +%Y%m%d_%H%M%S)

# å‹ç¼©å¤‡ä»½
tar -czf database.db.backup.$(date +%Y%m%d_%H%M%S).tar.gz database.db
```

**è‡ªåŠ¨å¤‡ä»½** (cron):
```bash
# ç¼–è¾‘ crontab
crontab -e

# æ·»åŠ æ¯æ—¥å¤‡ä»½ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨ 2 ç‚¹ï¼‰
0 2 * * * cd /Users/sgl/PycharmProjects/PythonProject/backend_python && cp database.db database.db.backup.$(date +\%Y\%m\%d)
```

### 5.2 æ•°æ®æ¢å¤

**ä»å¤‡ä»½æ¢å¤**:
```bash
cd backend_python

# åœæ­¢æœåŠ¡
pkill -f "python.*run.py"

# æ¢å¤æ•°æ®åº“
cp database.db.backup.20260223 database.db

# é‡å¯æœåŠ¡
nohup python3 run.py > /tmp/flask.log 2>&1 &
```

**éªŒè¯æ¢å¤**:
```bash
python3 -c "
import sqlite3
conn = sqlite3.connect('database.db')
cursor = conn.cursor()
cursor.execute('SELECT COUNT(*) FROM test_records')
count = cursor.fetchone()[0]
print(f'æ¢å¤æˆåŠŸï¼Œtest_records è¡¨æœ‰ {count} æ¡è®°å½•')
conn.close()
"
```

---

## å…­ã€æ€§èƒ½ä¼˜åŒ–

### 6.1 æ•°æ®åº“ä¼˜åŒ–

**å®šæœŸæ¸…ç†**:
```bash
# æ¯å‘¨æ‰§è¡Œä¸€æ¬¡
cd backend_python
python3 -c "
from wechat_backend.database.data_retention import cleanup_expired_data
cleanup_expired_data()
"
```

**ç´¢å¼•ä¼˜åŒ–**:
```bash
# æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
python3 -c "
import sqlite3
conn = sqlite3.connect('database.db')
cursor = conn.cursor()
cursor.execute(\"SELECT name, sql FROM sqlite_master WHERE type='index'\")
for row in cursor.fetchall():
    print(f'{row[0]}: {row[1]}')
conn.close()
"
```

### 6.2 ç¼“å­˜ä¼˜åŒ–

**æ¸…ç†ç¼“å­˜**:
```bash
cd backend_python
rm -f cache.db
```

**ç¼“å­˜ç›‘æ§**:
```bash
python3 -c "
import sqlite3
conn = sqlite3.connect('cache.db')
cursor = conn.cursor()
cursor.execute('SELECT COUNT(*) FROM cache_entries')
count = cursor.fetchone()[0]
print(f'ç¼“å­˜æ¡ç›®æ•°ï¼š{count}')
conn.close()
"
```

---

## ä¸ƒã€å®‰å…¨åŠ å›º

### 7.1 è®¿é—®æ§åˆ¶

**é˜²ç«å¢™é…ç½®**:
```bash
# åªå…è®¸æœ¬åœ°è®¿é—®
sudo pfctl -f /etc/pf.conf

# æˆ–ä½¿ç”¨ iptables (Linux)
sudo iptables -A INPUT -p tcp --dport 5000 -s 127.0.0.1 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 5000 -j DROP
```

**API é™æµ**:
```python
# å·²åœ¨ä»£ç ä¸­å®ç°
# æŸ¥çœ‹é…ç½®ï¼šwechat_backend/security/rate_limiting.py
```

### 7.2 æ•°æ®åŠ å¯†

**å¯†é’¥ç®¡ç†**:
```bash
# å®šæœŸæ›´æ¢åŠ å¯†å¯†é’¥ï¼ˆå»ºè®®æ¯å­£åº¦ï¼‰
python3 -c "
from cryptography.fernet import Fernet
key = Fernet.generate_key().decode()
print(f'æ–°å¯†é’¥ï¼š{key}')
print('è¯·æ›´æ–° .env æ–‡ä»¶ä¸­çš„ DATA_ENCRYPTION_KEY')
"
```

**æ•°æ®è„±æ•**:
```python
# åœ¨æ—¥å¿—ä¸­è‡ªåŠ¨è„±æ•æ•æ„Ÿæ•°æ®
# å·²é…ç½®ï¼šwechat_backend/logging_config.py
```

---

## å…«ã€åº”æ€¥æ–¹æ¡ˆ

### 8.1 æœåŠ¡æ•…éšœ

**å¿«é€Ÿå›æ»š**:
```bash
# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
git checkout HEAD~1 -- backend_python/wechat_backend/
git checkout HEAD~1 -- services/
git checkout HEAD~1 -- utils/

# é‡å¯æœåŠ¡
pkill -f "python.*run.py"
nohup python3 run.py > /tmp/flask.log 2>&1 &
```

**ç´§æ€¥åœæœº**:
```bash
# åœæ­¢æœåŠ¡
pkill -f "python.*run.py"

# å¤‡ä»½æ•°æ®åº“
cd backend_python
cp database.db database.db.emergency.$(date +%Y%m%d_%H%M%S)
```

### 8.2 è”ç³»äºº

| è§’è‰² | è”ç³»æ–¹å¼ | èŒè´£ |
|-----|---------|------|
| ç³»ç»Ÿæ¶æ„å¸ˆ | AI | æ¶æ„å†³ç­–ã€æŠ€æœ¯æŒ‡å¯¼ |
| å…¨æ ˆå·¥ç¨‹å¸ˆ | AI | ä»£ç ä¿®å¤ã€é—®é¢˜æ’æŸ¥ |
| è¿ç»´å·¥ç¨‹å¸ˆ | AI | æœåŠ¡éƒ¨ç½²ã€ç›‘æ§ |

---

## ä¹ã€é™„å½•

### 9.1 å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# æœåŠ¡ç®¡ç†
pkill -f "python.*run.py"
nohup python3 run.py > /tmp/flask.log 2>&1 &
ps aux | grep "python.*run.py"

# æ—¥å¿—æŸ¥çœ‹
tail -f /tmp/flask.log
grep ERROR /tmp/flask.log | tail -20

# å¥åº·æ£€æŸ¥
curl http://127.0.0.1:5000/api/test
curl http://127.0.0.1:5000/health

# éªŒè¯è„šæœ¬
python3 final_verification.py

# æ•°æ®åº“å¤‡ä»½
cp backend_python/database.db backend_python/database.db.backup.$(date +%Y%m%d)

# æ¸…ç†ç¼“å­˜
rm -f backend_python/cache.db
```

### 9.2 é…ç½®æ–‡ä»¶ä½ç½®

| æ–‡ä»¶ | è·¯å¾„ | è¯´æ˜ |
|-----|------|------|
| .env | /Users/sgl/PycharmProjects/PythonProject/.env | ç¯å¢ƒå˜é‡ |
| run.py | backend_python/run.py | å¯åŠ¨è„šæœ¬ |
| views.py | backend_python/wechat_backend/views.py | API è·¯ç”± |
| database.db | backend_python/database.db | æ•°æ®åº“ |

---

**æ‰‹å†Œç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-02-23
**ä¸‹æ¬¡å®¡æŸ¥**: 2026-03-23

**éƒ¨ç½²å’Œè¿ç»´æ‰‹å†Œç¼–åˆ¶å®Œæˆï¼** ğŸ“–
