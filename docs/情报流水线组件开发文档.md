# æƒ…æŠ¥æµæ°´çº¿ç»„ä»¶å¼€å‘æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æƒ…æŠ¥æµæ°´çº¿ï¼ˆIntelligence Pipelineï¼‰æ˜¯ä¸€ä¸ªå®æ—¶æ˜¾ç¤º AI è¯Šæ–­æƒ…æŠ¥æµçš„ç»„ä»¶ï¼Œæ”¯æŒå®æ—¶æ›´æ–°ã€ç»Ÿè®¡åˆ†æå’Œå¯è§†åŒ–å±•ç¤ºã€‚

## ğŸ¨ ç»„ä»¶ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- âœ… **å®æ—¶æƒ…æŠ¥æµ**: æ˜¾ç¤º AI è¯Šæ–­è¿‡ç¨‹ä¸­çš„å®æ—¶æƒ…æŠ¥æ•°æ®
- âœ… **çŠ¶æ€è¿½è¸ª**: æ”¯æŒ pending/processing/success/error å››ç§çŠ¶æ€
- âœ… **ç»Ÿè®¡åˆ†æ**: è‡ªåŠ¨è®¡ç®—æˆåŠŸ/å¤±è´¥/è¿›è¡Œä¸­æ•°é‡
- âœ… **SSE å®æ—¶æ›´æ–°**: æ”¯æŒ Server-Sent Events å®æ—¶æ¨é€ï¼ˆå°ç¨‹åºä½¿ç”¨è½®è¯¢æ›¿ä»£ï¼‰
- âœ… **è‡ªåŠ¨æ»šåŠ¨**: æ–°æƒ…æŠ¥è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
- âœ… **å¯æŠ˜å è®¾è®¡**: æ”¯æŒå±•å¼€/æŠ˜å åˆ‡æ¢
- âœ… **éº¦è‚¯é”¡é£æ ¼ UI**: ä¸“ä¸šã€é«˜ç«¯ã€ç§‘æŠ€æ„Ÿè§†è§‰è®¾è®¡

### è§†è§‰ç‰¹æ€§
- ğŸ¨ ç»ç’ƒæ€è®¾è®¡ï¼ˆbackdrop-filter blurï¼‰
- ğŸ¨ åŠ¨æ€çŠ¶æ€æŒ‡ç¤ºç¯
- ğŸ¨ å¹³æ»‘åŠ¨ç”»è¿‡æ¸¡
- ğŸ¨ å“åº”å¼äº¤äº’åé¦ˆ

## ğŸ“ æ–‡ä»¶ç»“æ„

```
components/IntelligencePipeline/
â”œâ”€â”€ IntelligencePipeline.wxml    # ç»„ä»¶æ¨¡æ¿
â”œâ”€â”€ IntelligencePipeline.wxss    # ç»„ä»¶æ ·å¼
â”œâ”€â”€ IntelligencePipeline.js      # ç»„ä»¶é€»è¾‘
â””â”€â”€ IntelligencePipeline.json    # ç»„ä»¶é…ç½®

backend_python/wechat_backend/
â””â”€â”€ views_intelligence.py        # åç«¯ API æ¥å£
```

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### 1. åœ¨é¡µé¢ä¸­å¼•å…¥ç»„ä»¶

**é¡µé¢ JSON é…ç½®** (`pages/report/dashboard/index.json`):
```json
{
  "usingComponents": {
    "intelligence-pipeline": "/components/IntelligencePipeline/IntelligencePipeline"
  }
}
```

**é¡µé¢ WXML** (`pages/report/dashboard/index.wxml`):
```xml
<intelligence-pipeline
  executionId="{{executionId}}"
  brandName="{{dashboardData.summary.brandName}}"
  enableSSE="{{true}}"
  autoScroll="{{true}}"
  collapsed="{{false}}"
  bind:loaded="onPipelineLoaded"
  bind:update="onPipelineUpdate"
  bind:error="onPipelineError"
  bind:itemtap="onPipelineItemTap"
></intelligence-pipeline>
```

### 2. ç»„ä»¶å±æ€§

| å±æ€§ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `items` | Array | [] | æƒ…æŠ¥é¡¹åˆ—è¡¨ï¼ˆå¯é€‰ï¼Œé€šå¸¸ç”± executionId è‡ªåŠ¨åŠ è½½ï¼‰ |
| `executionId` | String | '' | æ‰§è¡Œ IDï¼ˆå¿…å¡«ï¼Œç”¨äºè·å–æ•°æ®ï¼‰ |
| `brandName` | String | '' | å“ç‰Œåç§° |
| `isLoading` | Boolean | false | æ˜¯å¦æ­£åœ¨åŠ è½½ |
| `isLive` | Boolean | true | æ˜¯å¦å®æ—¶æ¨¡å¼ |
| `collapsed` | Boolean | false | æ˜¯å¦æŠ˜å  |
| `totalCount` | Number | 0 | æ€»æ•° |
| `enableSSE` | Boolean | true | æ˜¯å¦å¯ç”¨ SSE å®æ—¶æ›´æ–° |
| `autoScroll` | Boolean | true | æ˜¯å¦è‡ªåŠ¨æ»šåŠ¨ |

### 3. ç»„ä»¶äº‹ä»¶

| äº‹ä»¶ | å›è°ƒå‚æ•° | è¯´æ˜ |
|------|----------|------|
| `bind:loaded` | `{items, stats, metadata}` | æ•°æ®åŠ è½½å®Œæˆ |
| `bind:update` | `{items, addedCount}` | æ•°æ®æ›´æ–° |
| `bind:error` | `{type, error}` | å‘ç”Ÿé”™è¯¯ |
| `bind:itemtap` | `{item}` | æƒ…æŠ¥é¡¹è¢«ç‚¹å‡» |
| `bind:collapse` | `{collapsed}` | æŠ˜å çŠ¶æ€æ”¹å˜ |
| `bind:clear` | `{executionId}` | æ¸…ç©ºæƒ…æŠ¥åˆ—è¡¨ |
| `bind:change` | `{items, action, ...}` | æ•°æ®å˜åŒ– |
| `bind:scroll` | `{scrollTop}` | æ»šåŠ¨äº‹ä»¶ |

## ğŸ“¡ åç«¯ API

### API ç«¯ç‚¹

æ‰€æœ‰ API ç«¯ç‚¹éƒ½åœ¨ `/api/intelligence/*` è·¯å¾„ä¸‹ï¼š

#### 1. è·å–æµæ°´çº¿æ•°æ®
```
GET /api/intelligence/pipeline?executionId={id}&brandName={name}&limit=50
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "status": "success",
  "data": {
    "executionId": "test123",
    "items": [
      {
        "id": "1234567890",
        "question": "å“ç‰Œçš„æ ¸å¿ƒç«äº‰ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ",
        "model": "doubao",
        "status": "success",
        "time": "14:30:25",
        "latency": 850,
        "brand": "Nike",
        "preview": "AI åˆ†æç»“æœ...",
        "metadata": {
          "tokens_used": 320
        }
      }
    ],
    "stats": {
      "totalCount": 10,
      "successCount": 8,
      "processingCount": 1,
      "errorCount": 1,
      "successRate": 88.89
    },
    "metadata": {
      "totalCount": 10,
      "lastUpdated": "2026-02-21T14:30:25",
      "brandName": "Nike"
    }
  }
}
```

#### 2. æ·»åŠ æƒ…æŠ¥é¡¹
```
POST /api/intelligence/add
Content-Type: application/json

{
  "executionId": "test123",
  "question": "å“ç‰Œå®šä½å¦‚ä½•ï¼Ÿ",
  "model": "qwen",
  "status": "processing",
  "brand": "Nike"
}
```

#### 3. æ›´æ–°æƒ…æŠ¥é¡¹çŠ¶æ€
```
POST /api/intelligence/update
Content-Type: application/json

{
  "executionId": "test123",
  "itemId": "1234567890",
  "status": "success",
  "preview": "AI å“åº”å†…å®¹",
  "latency": 920
}
```

#### 4. æ¸…ç©ºæµæ°´çº¿
```
POST /api/intelligence/clear
Content-Type: application/json

{
  "executionId": "test123"
}
```

#### 5. SSE å®æ—¶æµï¼ˆå°ç¨‹åºä½¿ç”¨è½®è¯¢æ›¿ä»£ï¼‰
```
GET /api/intelligence/stream?executionId={id}
```

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### åœ¨ AI è¯Šæ–­è¿‡ç¨‹ä¸­æ·»åŠ æƒ…æŠ¥

**JavaScript ä»£ç **:
```javascript
// 1. å¼€å§‹è¯Šæ–­æ—¶æ·»åŠ  pending çŠ¶æ€çš„æƒ…æŠ¥
const addItem = (question, model) => {
  const pipeline = this.selectComponent('#intelligence-pipeline');
  pipeline.addItem({
    question: question,
    model: model,
    status: 'pending',
    brand: this.data.brandName
  });
};

// 2. å¼€å§‹å¤„ç†æ—¶æ›´æ–°çŠ¶æ€
const updateProcessing = (itemId) => {
  const pipeline = this.selectComponent('#intelligence-pipeline');
  pipeline.updateItemStatus(itemId, 'processing');
};

// 3. å®Œæˆæ—¶æ›´æ–°çŠ¶æ€å’Œç»“æœ
const updateSuccess = (itemId, preview, latency) => {
  const pipeline = this.selectComponent('#intelligence-pipeline');
  pipeline.updateItemStatus(itemId, 'success', {
    preview: preview,
    latency: latency
  });
};

// 4. é”™è¯¯æ—¶æ›´æ–°çŠ¶æ€
const updateError = (itemId, errorMessage) => {
  const pipeline = this.selectComponent('#intelligence-pipeline');
  pipeline.updateItemStatus(itemId, 'error', {
    error: errorMessage
  });
};
```

### åœ¨å“ç‰Œè¯Šæ–­æµç¨‹ä¸­é›†æˆ

```javascript
// pages/report/dashboard/index.js
Page({
  data: {
    executionId: '',
    brandName: ''
  },

  // å¼€å§‹è¯Šæ–­
  async startDiagnosis() {
    const executionId = Date.now().toString();
    this.setData({ executionId });

    // è°ƒç”¨åç«¯å¼€å§‹è¯Šæ–­
    const result = await request({
      url: '/api/perform-brand-test',
      method: 'POST',
      data: {
        executionId,
        brand_list: [this.data.brandName],
        selectedModels: ['doubao', 'qwen', 'deepseek']
      }
    });

    // æƒ…æŠ¥æµæ°´çº¿ä¼šè‡ªåŠ¨é€šè¿‡ executionId è·å–æ•°æ®
  },

  // ç›‘å¬æƒ…æŠ¥æ›´æ–°
  onPipelineUpdate(event) {
    const { items, addedCount } = event.detail;
    console.log(`æ–°å¢ ${addedCount} æ¡æƒ…æŠ¥ï¼Œæ€»è®¡ ${items.length} æ¡`);
  },

  // å¤„ç†æƒ…æŠ¥é¡¹ç‚¹å‡»
  onPipelineItemTap(event) {
    const { item } = event.detail;
    if (item.status === 'success') {
      // æ˜¾ç¤ºå®Œæ•´å“åº”
      this.showFullResponse(item);
    }
  }
});
```

## ğŸ¨ æ ·å¼å®šåˆ¶

### ä¿®æ”¹ä¸»é¢˜è‰²

åœ¨ `IntelligencePipeline.wxss` ä¸­ä¿®æ”¹ CSS å˜é‡ï¼š

```css
.intelligence-pipeline {
  --primary-bg: rgba(255, 255, 255, 0.03);
  --accent-color: #0f3460;      /* ä¸»è‰²è°ƒ */
  --highlight-color: #e94560;   /* é«˜äº®è‰² */
  --success-color: #10b981;     /* æˆåŠŸè‰² */
  --error-color: #ef4444;       /* é”™è¯¯è‰² */
}
```

### è°ƒæ•´æœ€å¤§é«˜åº¦

```css
.pipeline-scroll {
  max-height: 560rpx;  /* ä¿®æ”¹æ­¤å€¼è°ƒæ•´æœ€å¤§é«˜åº¦ */
}
```

## ğŸ“Š æ•°æ®ç»“æ„

### æƒ…æŠ¥é¡¹ç»“æ„

```typescript
interface IntelligenceItem {
  id: string;              // å”¯ä¸€æ ‡è¯†
  question: string;        // é—®é¢˜å†…å®¹
  model: string;           // AI æ¨¡å‹åç§°
  status: 'pending' | 'processing' | 'success' | 'error';
  time: string;            // æ—¶é—´å­—ç¬¦ä¸²
  timestamp: number;       // æ—¶é—´æˆ³
  latency?: number;        // å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
  brand?: string;          // å“ç‰Œåç§°
  preview?: string;        // å“åº”é¢„è§ˆ
  error?: string;          // é”™è¯¯ä¿¡æ¯
  metadata?: {
    tokens_used?: number;
    platform?: string;
    [key: string]: any;
  };
}
```

### ç»Ÿè®¡æ•°æ®ç»“æ„

```typescript
interface PipelineStats {
  totalCount: number;
  successCount: number;
  processingCount: number;
  errorCount: number;
  pendingCount: number;
  completedCount: number;
  avgLatency: number;
  successRate: number;
}
```

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. å¼€å¯ç»„ä»¶æ—¥å¿—

åœ¨ `IntelligencePipeline.js` ä¸­ï¼š
```javascript
const logger = require('../../../utils/logger');

// ç»„ä»¶æ–¹æ³•ä¸­ä¼šè‡ªåŠ¨è®°å½•æ—¥å¿—
// æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºäº†è§£ç»„ä»¶çŠ¶æ€
```

### 2. æ‰‹åŠ¨è§¦å‘æ•°æ®åŠ è½½

```javascript
// åœ¨é¡µé¢ä¸­è°ƒç”¨
const pipeline = this.selectComponent('#intelligence-pipeline');
pipeline.loadPipelineData();
```

### 3. æ£€æŸ¥ SSE è¿æ¥çŠ¶æ€

```javascript
const pipeline = this.selectComponent('#intelligence-pipeline');
console.log('SSE Connected:', pipeline.data.sseConnected);
console.log('Polling Active:', !!pipeline.pollingTimer);
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **executionId æ˜¯å¿…å¡«é¡¹**: ç»„ä»¶ä¾èµ– executionId æ¥è·å–å’Œè¿½è¸ªæ•°æ®
2. **SSE åœ¨å°ç¨‹åºä¸­ä½¿ç”¨è½®è¯¢æ›¿ä»£**: å¾®ä¿¡å°ç¨‹åºä¸æ”¯æŒåŸç”Ÿ SSEï¼Œç»„ä»¶è‡ªåŠ¨ä½¿ç”¨ 3 ç§’è½®è¯¢
3. **è‡ªåŠ¨æ»šåŠ¨**: æ–°æ•°æ®æ·»åŠ æ—¶ä¼šè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œå¯é€šè¿‡ `autoScroll="{{false}}"` ç¦ç”¨
4. **å†…å­˜ç®¡ç†**: ç»„ä»¶ detached æ—¶ä¼šè‡ªåŠ¨æ¸…ç†è½®è¯¢å®šæ—¶å™¨
5. **åç«¯ä¾èµ–**: ç¡®ä¿åç«¯ `views_intelligence.py` å·²æ­£ç¡®æ³¨å†Œå¹¶è¿è¡Œ

## ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **é™åˆ¶æ•°æ®é‡**: ä½¿ç”¨ `limit` å‚æ•°é™åˆ¶è¿”å›æ•°é‡ï¼ˆå»ºè®® 50-100 æ¡ï¼‰
2. **è°ƒæ•´è½®è¯¢é—´éš”**: æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´è½®è¯¢é—´éš”ï¼ˆé»˜è®¤ 3 ç§’ï¼‰
3. **æŒ‰éœ€å¯ç”¨ SSE**: ä¸éœ€è¦å®æ—¶æ›´æ–°æ—¶å¯è®¾ç½® `enableSSE="{{false}}"`
4. **æŠ˜å çŠ¶æ€**: åˆå§‹çŠ¶æ€è®¾ä¸ºæŠ˜å å¯å‡å°‘é¦–å±æ¸²æŸ“æ—¶é—´

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (2026-02-21)
- âœ… åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- âœ… æ”¯æŒå®æ—¶æƒ…æŠ¥æµæ˜¾ç¤º
- âœ… æ”¯æŒ SSE/è½®è¯¢å®æ—¶æ›´æ–°
- âœ… éº¦è‚¯é”¡é£æ ¼ UI è®¾è®¡
- âœ… å®Œæ•´çš„ç»Ÿè®¡åŠŸèƒ½
- âœ… åç«¯ API æ¥å£å®ç°

## ğŸ¤ è´¡çŒ®æŒ‡å—

å¦‚éœ€æ”¹è¿›ç»„ä»¶ï¼Œè¯·éµå¾ªä»¥ä¸‹è§„èŒƒï¼š
1. ä¿æŒéº¦è‚¯é”¡é£æ ¼è®¾è®¡è¯­è¨€
2. ç¡®ä¿ä»£ç ç¬¦åˆå¾®ä¿¡å°ç¨‹åºæœ€ä½³å®è·µ
3. æ·»åŠ å¿…è¦çš„é”™è¯¯å¤„ç†
4. æ›´æ–°æœ¬æ–‡æ¡£

---

**å¼€å‘å›¢é˜Ÿ**: GEO å“ç‰Œè¯Šæ–­ç³»ç»Ÿç»„  
**æœ€åæ›´æ–°**: 2026-02-21
