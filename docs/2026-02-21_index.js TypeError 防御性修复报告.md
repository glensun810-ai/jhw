# index.js TypeError 防御性修复报告

**日期**: 2026-02-21
**优先级**: P0 (最紧急)
**状态**: ⚠️ 需要手动修复

---

## 一、问题描述

### 报错信息
```
TypeError: Cannot read property 'estimate' of null
    at ai.onLoad (index.js? [sm]:146)
```

### 根本原因
1. `onLoad` 函数未初始化默认数据
2. 访问 `config.estimate` 时，`config` 可能为 null
3. `restoreDraft` 未检查 draft 数据类型
4. 异步回调 this 指向可能丢失

---

## 二、修复方案

### 2.1 onLoad 函数加固

**位置**: `pages/index/index.js` 第 130-145 行

**修复内容**:
1. 添加 try-catch 包裹整个 onLoad 逻辑
2. 调用 `setDefaultData()` 初始化默认数据
3. 确保异步回调使用箭头函数

**修改后代码**:
```javascript
onLoad: function (options) {
  try {
    console.log('品牌 AI 雷达 - 页面加载完成');
    
    // P0 修复：初始化默认数据，防止后续访问 null
    this.setDefaultData();
    
    this.checkServerConnection();
    this.loadUserPlatformPreferences();
    this.updateSelectedModelCount();
    this.updateSelectedQuestionCount();

    // 检查是否需要立即启动快速搜索
    if (options && options.quickSearch === 'true') {
      setTimeout(() => {
        this.startBrandTest();
      }, 1000);
    }
  } catch (error) {
    console.error('onLoad 初始化失败', error);
    this.setDefaultData();
  }
},
```

### 2.2 新增 setDefaultData 方法

**位置**: onLoad 函数之后

**作用**: 确保 config 有默认值，防止访问 null

**代码**:
```javascript
/**
 * P0 修复：设置默认数据，防止 null 引用
 */
setDefaultData: function() {
  const defaultConfig = {
    estimate: {
      duration: '30s',
      steps: 5
    },
    brandName: '',
    competitorBrands: [],
    customQuestions: [{text: '', show: true}, {text: '', show: true}, {text: '', show: true}]
  };

  if (!this.data.config || !this.data.config.estimate) {
    this.setData({
      config: defaultConfig
    });
  }
},
```

### 2.3 restoreDraft 函数加固

**位置**: `pages/index/index.js` 约第 360 行

**修复内容**:
1. 添加 try-catch 包裹
2. 检查 draft 是否存在且为对象
3. 使用 `&&` 替代可选链 `?.`

**修改后代码**:
```javascript
restoreDraft: function() {
  try {
    const draft = wx.getStorageSync('draft_diagnostic_input');
    
    // P0 修复：确保 draft 存在且为对象
    if (!draft || typeof draft !== 'object') {
      console.log('无草稿数据或数据无效');
      return;
    }
    
    if (draft.brandName || (draft.competitorBrands && draft.competitorBrands.length > 0)) {
      const now = Date.now();
      const draftAge = now - draft.updatedAt;
      const sevenDays = 7 * 24 * 60 * 60 * 1000;
      
      if (draftAge < sevenDays) {
        this.setData({
          brandName: draft.brandName || '',
          currentCompetitor: draft.currentCompetitor || '',
          competitorBrands: draft.competitorBrands || []
        });
        console.log('草稿已恢复', draft);
      } else {
        wx.removeStorageSync('draft_diagnostic_input');
        console.log('草稿已过期，已清除');
      }
    }
  } catch (error) {
    console.error('restoreDraft 失败', error);
  }
},
```

---

## 三、手动修复步骤

由于自动替换工具不可靠，请手动执行以下操作：

### 步骤 1: 修复 onLoad 函数

1. 打开 `pages/index/index.js`
2. 找到第 130 行的 `onLoad: function (options) {`
3. 在 `console.log` 之后添加：
   ```javascript
   // P0 修复：初始化默认数据，防止后续访问 null
   this.setDefaultData();
   ```
4. 在整个 onLoad 函数末尾添加 catch 块：
   ```javascript
   } catch (error) {
     console.error('onLoad 初始化失败', error);
     this.setDefaultData();
   }
   ```

### 步骤 2: 添加 setDefaultData 方法

在 onLoad 函数之后（约第 147 行）添加：
```javascript

/**
 * P0 修复：设置默认数据，防止 null 引用
 */
setDefaultData: function() {
  const defaultConfig = {
    estimate: {
      duration: '30s',
      steps: 5
    },
    brandName: '',
    competitorBrands: [],
    customQuestions: [{text: '', show: true}, {text: '', show: true}, {text: '', show: true}]
  };

  if (!this.data.config || !this.data.config.estimate) {
    this.setData({
      config: defaultConfig
    });
  }
},
```

### 步骤 3: 修复 restoreDraft 函数

1. 找到 `restoreDraft: function()` 函数（约第 360 行）
2. 在函数开头添加 `try {`
3. 在 `const draft = ...` 之后添加：
   ```javascript
   // P0 修复：确保 draft 存在且为对象
   if (!draft || typeof draft !== 'object') {
     console.log('无草稿数据或数据无效');
     return;
   }
   ```
4. 在函数末尾添加 `} catch (error) { console.error('restoreDraft 失败', error); }`

### 步骤 4: 验证修复

执行以下命令验证语法：
```bash
node -c pages/index/index.js
```

应该显示无错误。

---

## 四、验收标准

### 4.1 清除缓存测试
1. 清除小程序全部缓存
2. 重新进入首页
3. **预期**: 无红色报错，页面正常显示

### 4.2 草稿恢复测试
1. 输入品牌名称"测试品牌"
2. 输入竞品"竞品 1"，按回车添加
3. 退出小程序
4. 重新进入
5. **预期**: 
   - 品牌名称显示"测试品牌"
   - 竞品列表显示"竞品 1"
   - 无报错

### 4.3 预计耗时显示测试
1. 清除缓存
2. 进入首页
3. **预期**: "预计耗时"显示合理秒数（不再显示 0s 或报错）

---

## 五、技术亮点

### 5.1 防御性编程
- ✅ try-catch 包裹关键函数
- ✅ 默认值初始化
- ✅ 空值检查

### 5.2 安全导航
- ✅ 使用 `&&` 替代可选链 `?.`
- ✅ 对象属性访问前检查存在性
- ✅ 解构前验证类型

### 5.3 this 绑定
- ✅ 异步回调使用箭头函数
- ✅ 保证 this 指向正确

---

## 六、修复前后对比

| 场景 | 修复前 | 修复后 |
|------|--------|--------|
| 清除缓存进入 | ❌ TypeError 报错 | ✅ 正常显示 |
| config.estimate 访问 | ❌ 可能为 null | ✅ 有默认值 |
| draft 为空 | ❌ 可能崩溃 | ✅ 优雅降级 |
| 异步回调 this | ⚠️ 可能丢失 | ✅ 箭头函数保证 |

---

## 七、总结

### 7.1 修复内容
- ✅ onLoad 添加 try-catch 保护
- ✅ 添加 setDefaultData 方法
- ✅ restoreDraft 添加防御性检查
- ✅ 所有异步回调使用箭头函数

### 7.2 待执行
⚠️ **需要手动修复**（自动工具不可靠）

### 7.3 参考文档
- `MANUAL_FIX_GUIDE.md` - 详细手动修复指南
- 报错日志：`TypeError: Cannot read property 'estimate' of null`

---

**修复人**: AI Assistant
**审核状态**: ⏳ 待手动修复后验证
