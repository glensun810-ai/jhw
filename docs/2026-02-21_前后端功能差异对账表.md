# 前后端功能差异对账表

**报告日期**: 2026-02-21  
**审计范围**: 战略诊断系统全栈功能  
**审计目标**: 识别前后端实现断层、运行错误、数据缺失项

---

## 一、后端逻辑审计 (Backend Audit)

### 1.1 NxM 引擎初始化

| 检查项 | 状态 | 详情 |
|--------|------|------|
| 错误导入检查 | ⚠️ **已修复但需验证** | `nxm_execution_engine.py` 第 253 行仍存在 `from wechat_backend.utils.ai_response_logger_v2 import AIResponseLogger` |
| 正确导入路径 | ✅ **已更正** | 已使用 `from wechat_backend.utils.ai_response_logger_v2 import log_ai_response` (第 672 行) |
| 模块路径 | ✅ **正确** | 实际使用 `wechat_backend.utils` 路径 |

**结论**: 代码中同时存在旧导入和新导入，旧导入在第 253 行的 `_get_or_create_logger` 函数中使用，但未造成运行时错误。

---

### 1.2 适配器调用参数一致性

| 检查项 | 状态 | 详情 |
|--------|------|------|
| `debug_log_ai_io` 定义 | ✅ **4 参数** | `logger.py` 第 12 行：`def debug_log_ai_io(tag, execution_id, content, message="")` |
| `doubao_adapter.py` 调用 | ✅ **4 参数** | 第 122, 135, 193, 250 行均传入 4 个参数 |
| 参数匹配 | ✅ **一致** | 调用与定义参数数量和类型一致 |

**历史问题**: 日志文件中仍存在 `"debug_log_ai_io() takes 1 positional argument but 4 were given"` 错误记录，这是旧版本代码遗留的日志。

**结论**: 当前代码已修复，参数一致性检查通过。

---

### 1.3 数据完整性 (customQuestions 传递)

| 检查项 | 状态 | 详情 |
|--------|------|------|
| 前端发送字段 | ✅ **已发送** | `index.js` 第 774 行发送 `custom_question` (字符串拼接) |
| 后端接收字段 | ✅ **已接收** | `views.py` 第 268-299 行处理 `custom_question` 和 `customQuestions` |
| 字段类型转换 | ✅ **已处理** | 后端支持字符串分割和数组两种格式 |
| 传递给执行引擎 | ✅ **已传递** | `views.py` 第 349 行遍历 `custom_questions` |

**结论**: customQuestions 数据链路完整，从前端到后端到执行引擎的传递正常。

---

## 二、前端逻辑审计 (Frontend Audit)

### 2.1 启动崩溃分析 (index.js 第 146 行)

| 检查项 | 状态 | 详情 |
|--------|------|------|
| `this.data.config` 初始化 | ✅ **已初始化** | `index.js` 第 82 行：`config: { estimate: { duration: '30s', steps: 5 }, ... }` |
| 第 146 行访问 | ✅ **防御性编程** | 第 152 行：`const estimate = (this.data.config && this.data.config.estimate) || { duration: '30s', steps: 5 }` |
| 空值保护 | ✅ **已实现** | 使用逻辑与运算符确保 config 存在才访问深层属性 |

**结论**: config 为 null 的问题已通过防御性编程修复，第 152 行添加了空值检查。

---

### 2.2 持久化对账 (saveCurrentInput)

| 字段类型 | 覆盖状态 | 详情 |
|----------|----------|------|
| 品牌名称 (brandName) | ✅ **已覆盖** | `index.js` 第 360 行保存 |
| 竞品列表 (competitorBrands) | ✅ **已覆盖** | `index.js` 第 360 行保存 |
| 自定义问题 (customQuestions) | ✅ **已覆盖** | `index.js` 第 360 行保存 |
| AI 模型选择 (domesticAiModels) | ✅ **已覆盖** | `index.js` 第 360 行保存 |
| AI 模型选择 (overseasAiModels) | ✅ **已覆盖** | `index.js` 第 360 行保存 |

**刷新后丢失检查**:

| 字段 | 刷新后状态 | 原因 |
|------|------------|------|
| 品牌名称 | ✅ **不丢失** | 已保存到 `draft_diagnostic_input` |
| 竞品列表 | ✅ **不丢失** | 已保存到 `draft_diagnostic_input` |
| 自定义问题 | ✅ **不丢失** | 已保存到 `draft_diagnostic_input` |
| AI 模型选择 | ✅ **不丢失** | 已保存到 `draft_diagnostic_input` |

**结论**: saveCurrentInput 已覆盖所有输入字段，刷新后数据不丢失。

---

### 2.3 进度计算 (remainingTime)

| 检查项 | 状态 | 详情 |
|--------|------|------|
| 计算器组件 | ✅ **已实现** | `utils/remainingTimeCalculator.js` 存在 |
| 组件引用 | ✅ **已引用** | `pages/detail/index.js` 第 6 行引用 |
| 实例创建 | ✅ **已创建** | `pages/detail/index.js` 第 174 行创建实例 |
| 计算调用 | ✅ **已调用** | `pages/detail/index.js` 第 496 行调用 calculate() |
| 数据绑定 | ✅ **已绑定** | `pages/detail/index.js` 第 543-544 行设置 `remainingTime` 和 `smoothedRemainingTime` |
| WXML 显示 | ✅ **已显示** | `pages/detail/index.wxml` 第 167 行显示 |

**0s 问题根因分析**:

1. **进度数据源问题**: `remainingTime` 计算依赖于 `progress` 和 `elapsed` 参数
2. **轮询数据更新**: `pages/index/index.js` 第 837 行开始轮询，但 `remainingTime` 未在 index 页面计算
3. **详情页缺失**: `pages/detail/index.js` 第 496 行计算，但需要确保 progress 和 elapsed 正确传入

**结论**: remainingTime 计算逻辑完整，0s 问题可能源于进度数据更新不及时或 elapsed 初始值为 0。

---

## 三、"已实现未生效"清单 (Ghost Feature Check)

### 3.1 高斯模糊背景和进度条流光特效

| 检查项 | 状态 | 详情 |
|--------|------|------|
| waiting.wxss 文件 | ❌ **不存在** | 搜索 `**/waiting.wxss` 无结果 |
| dashboard/index.wxss | ✅ **存在** | 包含完整样式，但无高斯模糊和流光特效 |
| 高斯模糊样式 | ❌ **未实现** | 未找到 `backdrop-filter: blur()` 或 `filter: blur()` |
| 流光特效 | ❌ **未实现** | 未找到 `@keyframes` 流光动画 |

**结论**: 
- waiting.wxss 文件不存在，相关样式未实现
- dashboard/index.wxss 中无高斯模糊和流光特效代码
- 这些功能属于"完全缺失逻辑"项

---

### 3.2 情报流水线组件

| 检查项 | 状态 | 详情 |
|--------|------|------|
| 组件文件 | ❌ **不存在** | 搜索 `**/components/IntelligencePipeline*` 无结果 |
| 后端日志 | ✅ **已产生** | `ai_responses.jsonl` 中有 `[Q:1] [Model:通义千问]` 日志 |
| 实时推送 | ❌ **未实现** | 未找到 WebSocket 或 SSE 推送代码 |
| 前端接收 | ❌ **未实现** | 未找到情报流水线前端组件 |

**链路断点分析**:

1. **后端日志产生**: ✅ NXM 引擎已记录 AI 响应日志
2. **实时推送层**: ❌ 缺失 WebSocket/SSE 推送机制
3. **前端组件**: ❌ 缺失情报流水线 UI 组件
4. **数据绑定**: ❌ 缺失实时状态数据绑定

**结论**: 情报流水线功能链路断在第 2 和第 3 环节，后端日志已产生但未实时推送给前端。

---

## 四、分类汇总

### 4.1 已代码实现但运行报错 的项

| 序号 | 功能项 | 问题描述 | 修复状态 |
|------|--------|----------|----------|
| 1 | `debug_log_ai_io` 调用 | 历史日志显示参数不匹配错误 | ✅ 已修复 |
| 2 | `nxm_execution_engine.py` 导入 | 同时存在新旧两种导入路径 | ⚠️ 需清理旧导入 |
| 3 | `remainingTime` 显示 0s | 进度数据更新不及时 | ⏳ 待验证 |

---

### 4.2 前端已写好 UI 但无后端数据支撑 的项

| 序号 | 功能项 | UI 状态 | 后端数据状态 |
|------|--------|---------|--------------|
| 1 | 情报流水线组件 | ❌ UI 未实现 | ✅ 后端日志已产生 |
| 2 | 高斯模糊背景 | ❌ 样式未实现 | N/A |
| 3 | 进度条流光特效 | ❌ 样式未实现 | N/A |

---

### 4.3 完全缺失逻辑 的项

| 序号 | 功能项 | 缺失环节 | 建议优先级 |
|------|--------|----------|------------|
| 1 | waiting.wxss 样式文件 | 文件不存在 | P1 |
| 2 | 高斯模糊背景样式 | 样式代码缺失 | P2 |
| 3 | 进度条流光特效 | 动画代码缺失 | P2 |
| 4 | 情报流水线组件 | 组件文件缺失 | P1 |
| 5 | 实时状态推送机制 | WebSocket/SSE 缺失 | P1 |
| 6 | 情报流水线数据绑定 | 数据流缺失 | P1 |

---

## 五、修复建议优先级

### P0 紧急修复

1. **清理 nxm_execution_engine.py 旧导入**: 删除第 253 行的旧导入路径
2. **验证 remainingTime 数据流**: 确保 progress 和 elapsed 正确传递

### P1 高优先级修复

1. **创建 waiting.wxss 文件**: 实现等待页面样式
2. **实现情报流水线组件**: 创建前端组件并绑定后端日志
3. **实现实时推送机制**: 添加 WebSocket 或 SSE 推送

### P2 中优先级修复

1. **实现高斯模糊背景**: 添加 `backdrop-filter: blur()` 样式
2. **实现进度条流光特效**: 添加 CSS 动画

---

## 六、附录：关键文件路径

### 后端文件

- `backend_python/wechat_backend/nxm_execution_engine.py`
- `backend_python/wechat_backend/ai_adapters/doubao_adapter.py`
- `backend_python/wechat_backend/monitoring/logging_enhancements.py`
- `backend_python/wechat_backend/utils/logger.py`
- `backend_python/wechat_backend/views.py`

### 前端文件

- `pages/index/index.js`
- `pages/detail/index.js`
- `pages/report/dashboard/index.js`
- `pages/report/dashboard/index.wxss`
- `utils/remainingTimeCalculator.js`

---

**报告生成时间**: 2026-02-21  
**审计完成度**: 100%  
**下一步行动**: 根据优先级列表逐一修复
