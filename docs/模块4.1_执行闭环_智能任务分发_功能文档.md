# 模块 4.1：执行闭环——智能任务分发 功能文档

## 概述

智能任务分发系统实现了工作流管理功能，当用户在UI点击"处理"某条负面证据时，系统自动打包该片段的归因数据，并通过Webhook机制推送到预设的第三方API或企业通知渠道。

## 核心组件

### WorkflowManager 类

工作流管理器是整个系统的核心，负责任务创建、分发和状态管理。

#### 主要方法

1. `create_task_package()` - 创建标准化JSON任务包
2. `dispatch_task()` - 分发任务到指定Webhook URL
3. `get_task_status()` - 获取任务状态
4. `_send_webhook_request()` - 发送Webhook请求
5. `_schedule_retry()` - 安排重试机制

### 数据结构

#### WorkflowTask
- `task_id`: 任务唯一标识符
- `evidence_fragment`: 证据片段
- `intervention_script`: 纠偏建议脚本
- `source_meta`: 源元数据
- `status`: 任务状态
- `retry_count`: 重试次数

#### TaskStatus 枚举
- `PENDING`: 等待处理
- `PROCESSING`: 处理中
- `COMPLETED`: 已完成
- `FAILED`: 已失败
- `RETRYING`: 重试中

## 功能特性

### 1. 标准化任务包生成

系统自动生成包含以下字段的标准化JSON任务包：
- `task_id`: 任务唯一标识
- `payload`: 包含证据片段、纠偏建议和源数据
- `webhook_url`: 目标Webhook地址
- `delivery_attempts`: 投递尝试次数

### 2. Webhook 机制

- 支持推送任务到任意第三方API端点
- 支持企业通知渠道（如钉钉、企业微信等）
- 异步发送以避免阻塞主线程
- 支持自定义HTTP头和认证

### 3. 重试机制

- 指数退避策略（60秒基础延迟，每次翻倍）
- 最大重试次数限制（默认3次）
- 超时处理（30秒默认超时）
- 连接错误处理

## API 接口

### POST /workflow/tasks

创建并分发工作流任务

**请求体**:
```json
{
  "evidence_fragment": "负面证据片段内容",
  "associated_url": "关联URL",
  "source_name": "信源名称",
  "risk_level": "High|Medium|Low",
  "brand_name": "品牌名称",
  "intervention_script": "纠偏建议脚本",
  "source_meta": {
    "platform": "平台名称",
    "category": "分类",
    "importance": "重要性等级"
  },
  "webhook_url": "https://hooks.example.com/webhook"
}
```

**响应**:
```json
{
  "status": "success",
  "task_id": "wf_1234567890_1234",
  "message": "Workflow task created and dispatched successfully",
  "webhook_url": "https://hooks.example.com/webhook"
}
```

### GET /workflow/tasks/{task_id}

获取指定任务状态

**响应**:
```json
{
  "status": "success",
  "task_info": {
    "task_id": "wf_1234567890_1234",
    "status": "completed",
    "retry_count": 0,
    "max_retries": 3,
    "created_at": "2023-01-01T10:00:00Z",
    "updated_at": "2023-01-01T10:00:00Z",
    "next_retry_at": null
  }
}
```

## 使用场景

### 场景1: 负面舆情处理
当系统检测到负面证据时，自动创建任务包并推送到公关处理系统：
```json
{
  "evidence_fragment": "该品牌智能锁存在安全隐患",
  "intervention_script": "我们已注意到相关反馈，正在紧急核查...",
  "webhook_url": "https://company-pr-system.com/api/incidents"
}
```

### 场景2: 信源攻坚任务
将高影响力信源的攻坚任务推送到运营系统：
```json
{
  "evidence_fragment": "知乎上关于产品的负面讨论较多",
  "intervention_script": "安排内容团队在知乎发布正面内容",
  "webhook_url": "https://marketing-system.com/api/tasks"
}
```

## 错误处理

### 客户端错误 (4xx)
- `400 Bad Request`: 请求参数缺失或无效
- `404 Not Found`: 任务ID不存在

### 服务端错误 (5xx)
- `500 Internal Server Error`: 服务器内部错误

## 配置选项

- `webhook_timeout`: Webhook请求超时时间（默认30秒）
- `retry_delay_base`: 重试延迟基数（默认60秒）
- `max_retries`: 最大重试次数（默认3次）

## 性能指标

- **任务创建**: <10ms
- **Webhook发送**: <1000ms (取决于目标服务器响应)
- **状态查询**: <5ms

## 安全考虑

- 输入参数验证和清理
- Webhook URL格式验证
- 防止SSRF攻击
- 速率限制保护

## 监控和日志

系统记录以下关键事件：
- 任务创建和分发
- Webhook发送成功/失败
- 重试事件
- 任务状态变更

## 故障排除

### Webhook持续失败
1. 检查目标URL可达性
2. 验证目标服务器SSL证书
3. 确认目标服务器接受POST请求
4. 检查防火墙设置

### 任务状态异常
1. 使用GET /workflow/tasks/{task_id}检查具体状态
2. 查看应用日志获取详细错误信息
3. 验证重试机制是否正常工作