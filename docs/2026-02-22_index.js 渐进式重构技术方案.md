# index.js 渐进式重构技术方案

**文档版本**: v1.0  
**创建日期**: 2026-02-22  
**重构目标**: 将 2276 行单文件分拆为可维护的模块化结构  
**核心原则**: 分阶段执行、每步可验证、不影响现有功能

---

## 一、代码结构分析

### 1.1 当前代码职责分布

| 模块 | 行号范围 | 行数 | 职责 | 迁移目标 |
|-----|---------|------|------|---------|
| **生命周期** | 140-280, 1840-1850 | ~130 行 | 页面生命周期管理 | 保留在 index.js |
| **数据初始化** | 200-400, 600-750 | ~350 行 | 默认值、连接检查、偏好加载 | services/initService.js |
| **输入处理** | 450-600, 500-580 | ~230 行 | 品牌/竞品输入、草稿恢复 | services/draftService.js |
| **AI 模型选择** | 750-900 | ~150 行 | 模型切换、计数更新 | 保留在 index.js (UI 交互) |
| **问题管理** | 680-750 | ~70 行 | 自定义问题 CRUD | 保留在 index.js (UI 交互) |
| **竞品管理** | 650-680 | ~30 行 | 竞品 CRUD | 保留在 index.js (UI 交互) |
| **诊断执行** | 940-1100 | ~160 行 | startBrandTest、轮询 | services/brandTestService.js |
| **数据处理** | 1200-1500, 1550-1700 | ~450 行 | 数据提取、格式化、防御 | services/dataProcessorService.js |
| **配置管理** | 1700-1840 | ~140 行 | 保存/加载配置 | services/configService.js |
| **导航跳转** | 1650-1700, 2100-2200 | ~150 行 | 页面跳转、Storage 保存 | services/navigationService.js |
| **UI 交互** | 350-450, 1950-2000 | ~150 行 | 粒子动画、吸顶效果 | 保留在 index.js |
| **工具方法** | 1900-2000 | ~100 行 | 分数计算、缓存清理 | utils/helperUtils.js |

### 1.2 代码依赖关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                        index.js (2276 行)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  onLoad ──► initializeDefaults ──► checkServerConnection       │
│    │                                                               │
│    ├─► loadUserPlatformPreferences ──► restoreDraft             │
│    │                                                               │
│    └─► startBrandTest ──► callBackendBrandTest ──► pollTestProgress │
│                              │                                      │
│                              └─► processReportData               │
│                                    │                              │
│                                    ├─► extractScoreData          │
│                                    ├─► extractCompetitionData    │
│                                    ├─► extractPredictionData     │
│                                    └─► generateDashboardData     │
│                                          │                        │
│                                          └─► navigateToDashboard │
│                                                                 │
│  saveCurrentConfig ◄─── onConfigNameInput                       │
│  loadSavedConfig                                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、重构阶段规划

### 阶段总览

| 阶段 | 主题 | 预计工时 | 风险等级 | 回滚难度 |
|-----|------|---------|---------|---------|
| **阶段 0** | 准备与基线测试 | 2h | ✅ 无风险 | N/A |
| **阶段 1** | 工具函数提取 | 3h | ✅ 低风险 | 容易 |
| **阶段 2** | 数据处理服务提取 | 4h | ⚠️ 中风险 | 中等 |
| **阶段 3** | 诊断执行服务提取 | 4h | ⚠️ 中风险 | 中等 |
| **阶段 4** | 草稿与配置服务提取 | 3h | ✅ 低风险 | 容易 |
| **阶段 5** | 导航服务提取 | 2h | ✅ 低风险 | 容易 |
| **阶段 6** | 初始化服务提取 | 3h | ⚠️ 中风险 | 中等 |
| **阶段 7** | 最终清理与验证 | 2h | ✅ 低风险 | N/A |

**总工时**: 约 23 小时  
**建议节奏**: 每天 1-2 个阶段，共 4-5 天完成

---

## 三、详细执行步骤

### 阶段 0：准备与基线测试（2 小时）

#### 步骤 0.1：创建 Git 分支

```bash
# 创建重构分支
git checkout -b refactor/index-js-modularization

# 创建备份标签
git tag backup/index-js-before-refactor-$(date +%Y%m%d)
```

#### 步骤 0.2：功能基线测试清单

在执行任何重构前，先验证当前功能正常：

| 测试项 | 操作步骤 | 预期结果 | 状态 |
|-------|---------|---------|------|
| T0.1 | 输入品牌名称，启动诊断 | 成功创建任务，显示进度条 | ☐ |
| T0.2 | 添加 2 个竞品 | 竞品列表显示 2 项 | ☐ |
| T0.3 | 选择 3 个 AI 模型 | 模型选中状态正确 | ☐ |
| T0.4 | 添加 2 个自定义问题 | 问题列表正确显示 | ☐ |
| T0.5 | 刷新页面后恢复草稿 | 品牌、竞品、问题已恢复 | ☐ |
| T0.6 | 保存配置并重新加载 | 配置正确加载 | ☐ |
| T0.7 | 诊断完成后跳转结果页 | 结果页显示诊断数据 | ☐ |

#### 步骤 0.3：创建目标目录结构

```bash
# 创建新目录
mkdir -p services
mkdir -p utils

# 创建空文件（占位）
touch services/initService.js
touch services/draftService.js
touch services/brandTestService.js
touch services/dataProcessorService.js
touch services/configService.js
touch services/navigationService.js
touch utils/helperUtils.js
```

---

### 阶段 1：工具函数提取（3 小时）

#### 步骤 1.1：创建 utils/helperUtils.js

**提取内容**: 纯工具函数（无副作用）

```javascript
// ==================== utils/helperUtils.js ====================
/**
 * 辅助工具函数
 * 从 pages/index/index.js 提取的纯工具函数
 */

/**
 * 计算总分
 * @param {Object} scoreData - 评分数据
 * @returns {number} 平均分
 */
const calculateTotalScore = (scoreData) => {
  if (!scoreData) {
    return 0;
  }

  const scores = scoreData;
  const total = (scores.accuracy || 0) +
                (scores.completeness || 0) +
                (scores.relevance || 0) +
                (scores.security || 0) +
                (scores.sentiment || 0) +
                (scores.competitiveness || 0) +
                (scores.authority || 0);

  return Math.round(total / 7);
};

/**
 * 获取趋势指示器
 * @param {Object} scoreData - 评分数据
 * @returns {string} 趋势符号
 */
const getTrendIndicator = (scoreData) => {
  if (!scoreData) {
    return '→';
  }

  const currentScore = calculateTotalScore(scoreData);

  if (currentScore > 80) {
    return '↑';
  } else if (currentScore < 60) {
    return '↓';
  } else {
    return '→';
  }
};

/**
 * 获取完成时间文本
 * @returns {string} 格式化时间
 */
const getCompletedTimeText = () => {
  const now = new Date();
  const hours = now.getHours().toString().padStart(2, '0');
  const minutes = now.getMinutes().toString().padStart(2, '0');
  return `完成于 ${hours}:${minutes}`;
};

/**
 * 获取平台显示名称
 * @param {string} platform - 平台标识
 * @returns {string} 显示名称
 */
const getPlatformDisplayName = (platform) => {
  const platformNames = {
    'deepseek': 'DeepSeek',
    'qwen': '通义千问',
    'zhipu': '智谱 AI',
    'doubao': '豆包'
  };
  return platformNames[platform] || platform;
};

/**
 * 获取风险类型名称
 * @param {string} type - 风险类型
 * @returns {string} 风险名称
 */
const getRiskTypeName = (type) => {
  const riskTypes = {
    'visibility': '可见度拦截',
    'sentiment': '情感风险',
    'accuracy': '准确性风险',
    'purity': '纯净度风险'
  };
  return riskTypes[type] || type;
};

module.exports = {
  calculateTotalScore,
  getTrendIndicator,
  getCompletedTimeText,
  getPlatformDisplayName,
  getRiskTypeName
};
```

#### 步骤 1.2：修改 index.js 引入工具函数

在 index.js 顶部添加：

```javascript
// 在文件顶部，其他 require 之后添加
const {
  calculateTotalScore,
  getTrendIndicator,
  getCompletedTimeText
} = require('../../utils/helperUtils');
```

#### 步骤 1.3：删除 index.js 中的旧函数

删除以下函数（已被工具函数替代）：

- `calculateTotalScore` (约 15 行)
- `getTrendIndicator` (约 20 行)
- `getCompletedTimeText` (约 10 行)

#### 步骤 1.4：验证测试

| 测试项 | 操作 | 预期 |
|-------|------|------|
| V1.1 | 编译项目 | 无错误 |
| V1.2 | 启动诊断并完成 | 分数计算正确 |
| V1.3 | 查看完成时间 | 时间格式正确 |

---

### 阶段 2：数据处理服务提取（4 小时）

#### 步骤 2.1：创建 services/dataProcessorService.js

```javascript
// ==================== services/dataProcessorService.js ====================
/**
 * 数据处理服务
 * 负责报告数据的提取、格式化、防御性处理
 */

/**
 * 处理报告数据，应用数据防御机制
 * @param {Object} reportData - 原始报告数据
 * @returns {Object} 处理后的报告数据
 */
const processReportData = (reportData) => {
  if (!reportData || typeof reportData !== 'object') {
    console.warn('报告数据无效，返回默认结构');
    return getDefaultReportStructure();
  }

  return {
    prediction: defensiveGet(reportData, 'prediction', {}) || {},
    scores: defensiveGet(reportData, 'scores', {}) || {},
    competition: defensiveGet(reportData, 'competition', {}) || {},
    sources: defensiveGet(reportData, 'sources', []) || [],
    trends: defensiveGet(reportData, 'trends', {}) || {},
    results: defensiveGet(reportData, 'results', []) || [],
    original: reportData
  };
};

/**
 * 安全获取对象属性，防止 null/undefined 错误
 * @param {Object} obj - 源对象
 * @param {String} prop - 属性路径
 * @param {*} defaultValue - 默认值
 * @returns {*} 属性值或默认值
 */
const defensiveGet = (obj, prop, defaultValue = null) => {
  try {
    if (!obj || typeof obj !== 'object') {
      return defaultValue;
    }

    const props = prop.split('.');
    let result = obj;

    for (const p of props) {
      if (result == null || typeof result !== 'object') {
        return defaultValue;
      }
      result = result[p];

      if (result == null) {
        return defaultValue;
      }
    }

    if (Array.isArray(defaultValue) && Array.isArray(result) && result.length === 0) {
      return defaultValue;
    }

    return result;
  } catch (error) {
    console.error(`获取属性 ${prop} 时出错:`, error);
    return defaultValue;
  }
};

/**
 * 获取默认报告结构
 * @returns {Object} 默认报告结构
 */
const getDefaultReportStructure = () => {
  return {
    prediction: {
      forecast_points: [],
      confidence: 0,
      trend: 'neutral'
    },
    scores: {
      accuracy: 0,
      completeness: 0,
      relevance: 0,
      security: 0,
      sentiment: 0,
      competitiveness: 0
    },
    competition: {
      brand_keywords: [],
      shared_keywords: [],
      competitor_keywords: [],
      competitors: []
    },
    sources: [],
    trends: {
      historical: [],
      projected: []
    },
    results: [],
    original: {}
  };
};

/**
 * 提取预测数据
 * @param {Object} reportData - 报告数据
 * @returns {Object} 预测数据
 */
const extractPredictionData = (reportData) => {
  if (!reportData || typeof reportData !== 'object') {
    console.warn('报告数据无效，无法提取预测数据');
    return { forecast_points: [], confidence: 0, trend: 'neutral' };
  }

  try {
    if (reportData.prediction) {
      return {
        forecast_points: reportData.prediction.forecast_points || reportData.prediction.forecastPoints || [],
        confidence: reportData.prediction.confidence || 0,
        trend: reportData.prediction.trend || 'neutral'
      };
    } else if (reportData.results && Array.isArray(reportData.results) && reportData.results.length > 0) {
      const firstResult = reportData.results[0];
      if (firstResult.prediction) {
        return {
          forecast_points: firstResult.prediction.forecast_points || firstResult.prediction.forecastPoints || [],
          confidence: firstResult.prediction.confidence || 0,
          trend: firstResult.prediction.trend || 'neutral'
        };
      }
    }

    return { forecast_points: [], confidence: 0, trend: 'neutral' };
  } catch (error) {
    console.error('提取预测数据失败:', error);
    return { forecast_points: [], confidence: 0, trend: 'neutral' };
  }
};

/**
 * 提取评分数据
 * @param {Object} reportData - 报告数据
 * @returns {Object} 评分数据
 */
const extractScoreData = (reportData) => {
  if (!reportData || typeof reportData !== 'object') {
    console.warn('报告数据无效，无法提取评分数据');
    return {
      accuracy: 0, completeness: 0, relevance: 0,
      security: 0, sentiment: 0, competitiveness: 0, authority: 0
    };
  }

  try {
    if (reportData.scores) {
      return {
        accuracy: reportData.scores.accuracy || reportData.scores.Accuracy || 0,
        completeness: reportData.scores.completeness || reportData.scores.Completeness || 0,
        relevance: reportData.scores.relevance || reportData.scores.Relevance || 0,
        security: reportData.scores.security || reportData.scores.Security || 0,
        sentiment: reportData.scores.sentiment || reportData.scores.Sentiment || 0,
        competitiveness: reportData.scores.competitiveness || reportData.scores.Competitiveness || 0,
        authority: reportData.scores.authority || reportData.scores.Authority || 0
      };
    } else if (reportData.results && Array.isArray(reportData.results) && reportData.results.length > 0) {
      const firstResult = reportData.results[0];
      if (firstResult.scores) {
        return {
          accuracy: firstResult.scores.accuracy || firstResult.scores.Accuracy || 0,
          completeness: firstResult.scores.completeness || firstResult.scores.Completeness || 0,
          relevance: firstResult.scores.relevance || firstResult.scores.Relevance || 0,
          security: firstResult.scores.security || firstResult.scores.Security || 0,
          sentiment: firstResult.scores.sentiment || firstResult.scores.Sentiment || 0,
          competitiveness: firstResult.scores.competitiveness || firstResult.scores.Competitiveness || 0,
          authority: firstResult.scores.authority || firstResult.scores.Authority || 0
        };
      }
    }

    return {
      accuracy: 0, completeness: 0, relevance: 0,
      security: 0, sentiment: 0, competitiveness: 0, authority: 0
    };
  } catch (error) {
    console.error('提取评分数据失败:', error);
    return {
      accuracy: 0, completeness: 0, relevance: 0,
      security: 0, sentiment: 0, competitiveness: 0, authority: 0
    };
  }
};

/**
 * 提取竞争分析数据
 * @param {Object} reportData - 报告数据
 * @returns {Object} 竞争分析数据
 */
const extractCompetitionData = (reportData) => {
  if (!reportData || typeof reportData !== 'object') {
    console.warn('报告数据无效，无法提取竞争分析数据');
    return { brand_keywords: [], shared_keywords: [], competitors: [] };
  }

  try {
    if (reportData.competition) {
      return {
        brand_keywords: reportData.competition.brand_keywords || reportData.competition.brandKeywords || [],
        shared_keywords: reportData.competition.shared_keywords || reportData.competition.sharedKeywords || [],
        competitors: reportData.competition.competitors || []
      };
    } else if (reportData.competitive_analysis) {
      return {
        brand_keywords: reportData.competitive_analysis.brand_keywords || reportData.competitive_analysis.brandKeywords || [],
        shared_keywords: reportData.competitive_analysis.shared_keywords || reportData.competitive_analysis.sharedKeywords || [],
        competitors: reportData.competitive_analysis.competitors || []
      };
    } else if (reportData.results && Array.isArray(reportData.results) && reportData.results.length > 0) {
      const firstResult = reportData.results[0];
      if (firstResult.competition) {
        return {
          brand_keywords: firstResult.competition.brand_keywords || firstResult.competition.brandKeywords || [],
          shared_keywords: firstResult.competition.shared_keywords || firstResult.competition.sharedKeywords || [],
          competitors: firstResult.competition.competitors || []
        };
      } else if (firstResult.competitive_analysis) {
        return {
          brand_keywords: firstResult.competitive_analysis.brand_keywords || firstResult.competitive_analysis.brandKeywords || [],
          shared_keywords: firstResult.competitive_analysis.shared_keywords || firstResult.competitive_analysis.sharedKeywords || [],
          competitors: firstResult.competitive_analysis.competitors || []
        };
      }
    }

    return { brand_keywords: [], shared_keywords: [], competitors: [] };
  } catch (error) {
    console.error('提取竞争分析数据失败:', error);
    return { brand_keywords: [], shared_keywords: [], competitors: [] };
  }
};

/**
 * 提取信源列表数据
 * @param {Object} reportData - 报告数据
 * @returns {Array} 信源列表
 */
const extractSourceListData = (reportData) => {
  if (!reportData || typeof reportData !== 'object') {
    console.warn('报告数据无效，无法提取信源列表');
    return [];
  }

  try {
    if (reportData.sources && Array.isArray(reportData.sources)) {
      return reportData.sources.map(source => ({
        title: source.title || source.name || '未知信源',
        url: source.url || source.link || '',
        score: source.score || source.confidence || 0,
        type: source.type || '未知类型'
      }));
    } else if (reportData.results && Array.isArray(reportData.results)) {
      const sources = [];
      reportData.results.forEach(result => {
        if (result.sources && Array.isArray(result.sources)) {
          result.sources.forEach(source => {
            sources.push({
              title: source.title || source.name || '未知信源',
              url: source.url || source.link || '',
              score: source.score || source.confidence || 0,
              type: source.type || '未知类型'
            });
          });
        }
      });
      return sources;
    }

    return [
      { title: '品牌官网', url: 'https://brand.example.com', score: 95, type: '官方' },
      { title: '行业报告', url: 'https://industry-report.com', score: 87, type: '第三方' },
      { title: '社交媒体', url: 'https://social-media.com', score: 78, type: 'UGC' }
    ];
  } catch (error) {
    console.error('提取信源列表数据失败:', error);
    return [];
  }
};

/**
 * 生成趋势图表数据
 * @param {Object} reportData - 报告数据
 * @returns {Object} 图表配置对象
 */
const generateTrendChartData = (reportData) => {
  if (!reportData || typeof reportData !== 'object') {
    console.warn('报告数据无效，无法生成趋势图表');
    return { dates: [], values: [], predictions: [] };
  }

  try {
    if (reportData.timeSeries && Array.isArray(reportData.timeSeries)) {
      const timeSeries = reportData.timeSeries;
      const dates = timeSeries.map(item => item.period || item.date || '未知时间');
      const values = timeSeries.map(item => item.value || 0);

      const predictions = reportData.prediction && Array.isArray(reportData.prediction.forecast_points)
        ? reportData.prediction.forecast_points.map(point => point.value || 0)
        : [];

      return { dates, values, predictions };
    }

    return {
      dates: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
      values: [30, 45, 60, 75, 80, 85, 90],
      predictions: [88, 92, 95, 97, 98, 99, 100]
    };
  } catch (error) {
    console.error('生成趋势图表数据失败:', error);
    return { dates: [], values: [], predictions: [] };
  }
};

module.exports = {
  processReportData,
  defensiveGet,
  getDefaultReportStructure,
  extractPredictionData,
  extractScoreData,
  extractCompetitionData,
  extractSourceListData,
  generateTrendChartData
};
```

#### 步骤 2.2：修改 index.js 引入数据处理服务

在 index.js 顶部添加：

```javascript
const {
  processReportData,
  extractPredictionData,
  extractScoreData,
  extractCompetitionData,
  extractSourceListData,
  generateTrendChartData
} = require('../../services/dataProcessorService');
```

#### 步骤 2.3：删除 index.js 中的旧函数

删除以下函数：
- `processReportData` (约 30 行)
- `defensiveGet` (约 40 行)
- `getDefaultReportStructure` (约 30 行)
- `extractPredictionData` (约 40 行)
- `extractScoreData` (约 50 行)
- `extractCompetitionData` (约 50 行)
- `extractSourceListData` (约 50 行)
- `generateTrendChartData` (约 40 行)

**共计删除约 330 行**

#### 步骤 2.4：验证测试

| 测试项 | 操作 | 预期 |
|-------|------|------|
| V2.1 | 编译项目 | 无错误 |
| V2.2 | 启动诊断并完成 | 数据提取正确 |
| V2.3 | 查看结果页 | 所有字段显示正确 |
| V2.4 | 模拟空数据 | 默认值正确显示 |

---

### 阶段 3：诊断执行服务提取（4 小时）

#### 步骤 3.1：创建 services/brandTestService.js

```javascript
// ==================== services/brandTestService.js ====================
/**
 * 品牌诊断执行服务
 * 负责诊断任务的启动、轮询、状态管理
 */

const { startBrandTestApi, getTaskStatusApi } = require('../api/home');
const { parseTaskStatus } = require('./taskStatusService');
const { aggregateReport } = require('./reportAggregator');

/**
 * 验证输入数据
 * @param {Object} inputData - 输入数据
 * @returns {Object} 验证结果
 */
const validateInput = (inputData) => {
  const { brandName, selectedModels, customQuestions } = inputData;

  if (!brandName || brandName.trim() === '') {
    return { valid: false, message: '请输入您的品牌名称' };
  }

  if (!selectedModels || selectedModels.length === 0) {
    return { valid: false, message: '请选择至少一个 AI 模型' };
  }

  return { valid: true };
};

/**
 * 构建请求载荷
 * @param {Object} inputData - 输入数据
 * @returns {Object} 请求载荷
 */
const buildPayload = (inputData) => {
  const { brandName, competitorBrands, selectedModels, customQuestions } = inputData;

  const brand_list = [brandName, ...(competitorBrands || [])];

  const processedSelectedModels = selectedModels.map(item => {
    if (typeof item === 'object' && item !== null) {
      return item.id || item.value || item.name || '';
    }
    return item;
  }).filter(id => id !== '');

  const custom_question = (customQuestions || []).join(' ');

  return {
    brand_list,
    selectedModels: processedSelectedModels,
    custom_question
  };
};

/**
 * 启动品牌诊断
 * @param {Object} inputData - 输入数据
 * @param {Function} onProgress - 进度回调
 * @param {Function} onComplete - 完成回调
 * @param {Function} onError - 错误回调
 * @returns {Promise<string>} executionId
 */
const startDiagnosis = async (inputData, onProgress, onComplete, onError) => {
  const validation = validateInput(inputData);
  if (!validation.valid) {
    throw new Error(validation.message);
  }

  const payload = buildPayload(inputData);

  console.log('Sending request to API:', payload);

  try {
    const res = await startBrandTestApi(payload);
    const responseData = res.data || res;
    const executionId = responseData.execution_id || responseData.id || (responseData.data && responseData.data.execution_id);

    if (!executionId) {
      throw new Error('未能从响应中提取有效 ID');
    }

    console.log('✅ 诊断任务创建成功，执行 ID:', executionId);
    return executionId;
  } catch (error) {
    console.error('启动诊断失败:', error);
    throw error;
  }
};

/**
 * 创建轮询控制器
 * @param {string} executionId - 执行 ID
 * @param {Function} onProgress - 进度回调
 * @param {Function} onComplete - 完成回调
 * @param {Function} onError - 错误回调
 * @returns {Object} 轮询控制器
 */
const createPollingController = (executionId, onProgress, onComplete, onError) => {
  let pollInterval = null;
  let isStopped = false;
  const maxDuration = 5 * 60 * 1000; // 5 分钟超时
  const startTime = Date.now();

  const stop = () => {
    if (pollInterval) {
      clearInterval(pollInterval);
      pollInterval = null;
      isStopped = true;
    }
  };

  const start = (interval = 2000) => {
    pollInterval = setInterval(async () => {
      // 超时检查
      if (Date.now() - startTime > maxDuration) {
        stop();
        console.error('轮询超时');
        if (onError) onError(new Error('诊断超时'));
        return;
      }

      // 已停止检查
      if (isStopped) {
        stop();
        return;
      }

      try {
        const res = await getTaskStatusApi(executionId);

        if (res && (res.progress !== undefined || res.stage)) {
          const parsedStatus = parseTaskStatus(res);

          if (onProgress) {
            onProgress(parsedStatus);
          }

          // 终止条件
          if (parsedStatus.stage === 'completed' || parsedStatus.stage === 'failed') {
            stop();

            if (parsedStatus.stage === 'completed' && onComplete) {
              onComplete(parsedStatus);
            } else if (parsedStatus.stage === 'failed' && onError) {
              onError(new Error(parsedStatus.error || '诊断失败'));
            }
          }
        } else {
          console.error('获取任务状态失败:', res);
        }
      } catch (err) {
        console.error('轮询异常:', err);
        if (onError) onError(err);
      }
    }, interval);
  };

  return { start, stop, isStopped: () => isStopped };
};

/**
 * 生成战略看板数据
 * @param {Object} processedReportData - 处理后的报告数据
 * @param {Object} pageContext - 页面上下文（用于获取 brandName 等）
 * @returns {Object} 看板数据
 */
const generateDashboardData = (processedReportData, pageContext) => {
  try {
    const rawResults = Array.isArray(processedReportData)
      ? processedReportData
      : (processedReportData.detailed_results || processedReportData.results || []);

    if (!rawResults || rawResults.length === 0) {
      console.warn('没有可用的原始结果数据');
      return null;
    }

    const brandName = pageContext.brandName;
    const competitors = pageContext.competitorBrands || [];

    const additionalData = {
      semantic_drift_data: processedReportData.semantic_drift_data || null,
      semantic_contrast_data: processedReportData.semantic_contrast_data || null,
      recommendation_data: processedReportData.recommendation_data || null,
      negative_sources: processedReportData.negative_sources || null,
      brand_scores: processedReportData.brand_scores || null,
      competitive_analysis: processedReportData.competitive_analysis || null,
      overall_score: processedReportData.overall_score || null
    };

    const dashboardData = aggregateReport(rawResults, brandName, competitors, additionalData);

    // 保存到全局存储
    const app = getApp();
    app.globalData.lastReport = {
      raw: rawResults,
      dashboard: dashboardData,
      competitors: competitors
    };

    return dashboardData;
  } catch (error) {
    console.error('生成战略看板数据失败:', error);
    return null;
  }
};

module.exports = {
  validateInput,
  buildPayload,
  startDiagnosis,
  createPollingController,
  generateDashboardData
};
```

#### 步骤 3.2：修改 index.js 引入诊断服务

在 index.js 顶部添加：

```javascript
const {
  validateInput,
  buildPayload,
  startDiagnosis,
  createPollingController,
  generateDashboardData
} = require('../../services/brandTestService');
```

#### 步骤 3.3：重构 startBrandTest 和 pollTestProgress

将原有的复杂逻辑替换为服务调用：

```javascript
// 重构后的 startBrandTest
startBrandTest: function() {
  const brandName = this.data.brandName.trim();
  if (!brandName) {
    wx.showToast({ title: '请输入您的品牌名称', icon: 'error' });
    return;
  }

  let selectedModels = [...this.data.domesticAiModels, ...this.data.overseasAiModels].filter(model => model.checked && !model.disabled);
  let customQuestions = this.getValidQuestions();

  if (selectedModels.length === 0) {
    wx.showToast({ title: '请选择至少一个 AI 模型', icon: 'error' });
    return;
  }
  if (customQuestions.length === 0) {
    customQuestions = ["介绍一下{brandName}", "{brandName} 的主要产品是什么"];
  }

  this.setData({
    isTesting: true,
    testProgress: 0,
    progressText: '正在启动 AI 认知诊断...',
    testCompleted: false,
    completedTime: null
  });

  // 使用服务启动诊断
  this.callBackendBrandTest(brandName, selectedModels, customQuestions);
},

callBackendBrandTest: async function(brandName, selectedModels, customQuestions) {
  wx.showLoading({ title: '启动诊断...' });

  try {
    const inputData = {
      brandName,
      competitorBrands: this.data.competitorBrands,
      selectedModels,
      customQuestions
    };

    const executionId = await startDiagnosis(
      inputData,
      // onProgress 回调
      (parsedStatus) => {
        this.setData({
          testProgress: parsedStatus.progress,
          progressText: parsedStatus.statusText,
          currentStage: parsedStatus.stage
        });
      },
      // onComplete 回调
      (parsedStatus) => {
        wx.hideLoading();
        this.handleDiagnosisComplete(parsedStatus, executionId);
      },
      // onError 回调
      (error) => {
        wx.hideLoading();
        this.handleDiagnosisError(error);
      }
    );

    // 启动轮询
    this.pollingController = createPollingController(
      executionId,
      // onProgress 回调
      (parsedStatus) => {
        this.setData({
          testProgress: parsedStatus.progress,
          progressText: parsedStatus.statusText,
          currentStage: parsedStatus.stage
        });
      },
      // onComplete 回调
      (parsedStatus) => {
        wx.hideLoading();
        this.handleDiagnosisComplete(parsedStatus, executionId);
      },
      // onError 回调
      (error) => {
        wx.hideLoading();
        this.handleDiagnosisError(error);
      }
    );

    this.pollingController.start();

  } catch (err) {
    wx.hideLoading();
    this.handleDiagnosisError(err);
  }
},

handleDiagnosisComplete: function(parsedStatus, executionId) {
  // 处理诊断完成逻辑
  const reportData = parsedStatus.detailed_results || parsedStatus.results;
  const processedReportData = processReportData(reportData);

  const dashboardData = generateDashboardData(processedReportData, {
    brandName: this.data.brandName,
    competitorBrands: this.data.competitorBrands
  });

  this.setData({
    reportData: processedReportData,
    isTesting: false,
    testCompleted: true,
    completedTime: getCompletedTimeText(),
    progressText: '诊断完成，正在生成报告...',
    dashboardData: dashboardData
  });

  wx.showToast({ title: '诊断完成', icon: 'success' });
  this.renderReport();

  // 保存数据并跳转
  this.saveAndNavigateToResults(parsedStatus, executionId);
},

handleDiagnosisError: function(error) {
  console.error('诊断错误:', error);

  let extractedError = error.message || error.errMsg || '任务创建失败';

  if (extractedError.includes('request:fail') || extractedError.includes('network')) {
    extractedError = '网络连接失败，请检查网络设置或稍后重试';
  }

  wx.showModal({
    title: '启动失败',
    content: String(extractedError),
    showCancel: false
  });

  this.setData({ isTesting: false });
},

saveAndNavigateToResults: function(parsedStatus, executionId) {
  const resultsToSave = parsedStatus.detailed_results || parsedStatus.results || [];
  const competitiveAnalysisToSave = parsedStatus.competitive_analysis || this.data.latestCompetitiveAnalysis || {};
  const brandScoresToSave = parsedStatus.brand_scores || (competitiveAnalysisToSave && competitiveAnalysisToSave.brandScores) || {};

  wx.setStorageSync('last_diagnostic_results', {
    results: resultsToSave,
    competitiveAnalysis: competitiveAnalysisToSave,
    brandScores: brandScoresToSave,
    targetBrand: this.data.brandName,
    executionId: executionId,
    timestamp: Date.now()
  });

  wx.setStorageSync('latestTestResults_' + executionId, resultsToSave);
  wx.setStorageSync('latestCompetitiveAnalysis_' + executionId, competitiveAnalysisToSave);
  wx.setStorageSync('latestBrandScores_' + executionId, brandScoresToSave);
  wx.setStorageSync('latestTargetBrand', this.data.brandName);

  wx.navigateTo({
    url: `/pages/results/results?executionId=${executionId}&brandName=${encodeURIComponent(this.data.brandName)}`
  });
},

onUnload: function() {
  if (this.data.particleAnimateId) {
    cancelAnimationFrame(this.data.particleAnimateId);
  }
  // 停止轮询
  if (this.pollingController) {
    this.pollingController.stop();
  }
}
```

#### 步骤 3.4：验证测试

| 测试项 | 操作 | 预期 |
|-------|------|------|
| V3.1 | 编译项目 | 无错误 |
| V3.2 | 启动完整诊断流程 | 进度条正常更新 |
| V3.3 | 诊断完成 | 正确跳转结果页 |
| V3.4 | 网络错误 | 显示友好错误提示 |
| V3.5 | 页面卸载 | 轮询正确停止 |

---

### 阶段 4：草稿与配置服务提取（3 小时）

#### 步骤 4.1：创建 services/draftService.js

```javascript
// ==================== services/draftService.js ====================
/**
 * 草稿管理服务
 * 负责用户输入的保存、恢复、清理
 */

const STORAGE_KEY = 'draft_diagnostic_input';
const DRAFT_EXPIRY = 7 * 24 * 60 * 60 * 1000; // 7 天

/**
 * 保存草稿
 * @param {Object} inputData - 输入数据
 */
const saveDraft = (inputData) => {
  try {
    const draft = {
      brandName: inputData.brandName || '',
      currentCompetitor: inputData.currentCompetitor || '',
      competitorBrands: inputData.competitorBrands || [],
      customQuestions: inputData.customQuestions || [],
      selectedModels: inputData.selectedModels || {
        domestic: [],
        overseas: []
      },
      updatedAt: Date.now()
    };

    wx.setStorageSync(STORAGE_KEY, draft);
    console.log('草稿已自动保存', {
      brandName: draft.brandName,
      competitorCount: draft.competitorBrands.length,
      questionCount: draft.customQuestions.length
    });
  } catch (error) {
    console.error('保存草稿失败:', error);
  }
};

/**
 * 恢复草稿
 * @returns {Object|null} 草稿数据，如果不存在或过期则返回 null
 */
const restoreDraft = () => {
  try {
    const draft = wx.getStorageSync(STORAGE_KEY);

    if (!draft || !draft.brandName) {
      return null;
    }

    // 检查是否过期
    const now = Date.now();
    const draftAge = now - (draft.updatedAt || 0);

    if (draftAge >= DRAFT_EXPIRY) {
      console.log('草稿已过期，已清除');
      wx.removeStorageSync(STORAGE_KEY);
      return null;
    }

    console.log('草稿已恢复', draft);
    return draft;
  } catch (error) {
    console.error('恢复草稿失败:', error);
    return null;
  }
};

/**
 * 清除草稿
 */
const clearDraft = () => {
  try {
    wx.removeStorageSync(STORAGE_KEY);
    console.log('草稿已清除');
  } catch (error) {
    console.error('清除草稿失败:', error);
  }
};

/**
 * 验证草稿数据
 * @param {Object} draft - 草稿数据
 * @returns {boolean} 是否有效
 */
const validateDraft = (draft) => {
  if (!draft || typeof draft !== 'object') {
    return false;
  }

  if (!draft.brandName || typeof draft.brandName !== 'string') {
    return false;
  }

  if (!Array.isArray(draft.competitorBrands)) {
    return false;
  }

  if (!Array.isArray(draft.customQuestions)) {
    return false;
  }

  return true;
};

/**
 * 检查草稿是否过期
 * @returns {boolean} 是否过期
 */
const isDraftExpired = () => {
  try {
    const draft = wx.getStorageSync(STORAGE_KEY);

    if (!draft || !draft.updatedAt) {
      return true;
    }

    const now = Date.now();
    const draftAge = now - draft.updatedAt;

    return draftAge >= DRAFT_EXPIRY;
  } catch (error) {
    console.error('检查草稿过期失败:', error);
    return true;
  }
};

/**
 * 格式化草稿问题数据
 * @param {Array} customQuestions - 自定义问题数组
 * @returns {Array} 格式化后的问题
 */
const formatDraftQuestions = (customQuestions) => {
  if (!Array.isArray(customQuestions) || customQuestions.length === 0) {
    return [
      { text: '', show: true },
      { text: '', show: true },
      { text: '', show: true }
    ];
  }

  return customQuestions.map(q => ({
    text: (q && q.text) || '',
    show: (q && q.show !== undefined) ? q.show : true
  }));
};

/**
 * 格式化草稿 AI 模型数据
 * @param {Array} currentModels - 当前模型数组
 * @param {Object} savedModels - 保存的模型选择
 * @returns {Array} 格式化后的模型
 */
const formatDraftModels = (currentModels, savedModels) => {
  if (!Array.isArray(currentModels)) {
    return [];
  }

  const selectedModels = savedModels?.domestic || [];

  return currentModels.map(model => ({
    ...model,
    checked: selectedModels.includes(model.name) && !model.disabled
  }));
};

module.exports = {
  saveDraft,
  restoreDraft,
  clearDraft,
  validateDraft,
  isDraftExpired,
  formatDraftQuestions,
  formatDraftModels,
  STORAGE_KEY,
  DRAFT_EXPIRY
};
```

#### 步骤 4.2：创建 services/configService.js

```javascript
// ==================== services/configService.js ====================
/**
 * 配置管理服务
 * 负责保存的搜索配置的 CRUD
 */

const STORAGE_KEY = 'savedSearchConfigs';

/**
 * 保存配置
 * @param {Object} config - 配置对象
 * @returns {boolean} 是否成功
 */
const saveConfig = (config) => {
  try {
    if (!config || !config.name) {
      console.error('配置名称不能为空');
      return false;
    }

    let savedConfigs = wx.getStorageSync(STORAGE_KEY) || [];

    // 检查是否已存在同名配置
    const existingIndex = savedConfigs.findIndex(c => c.name === config.name);

    if (existingIndex !== -1) {
      savedConfigs[existingIndex] = config;
      console.log('配置已更新:', config.name);
    } else {
      savedConfigs.push(config);
      console.log('配置已保存:', config.name);
    }

    wx.setStorageSync(STORAGE_KEY, savedConfigs);
    return true;
  } catch (error) {
    console.error('保存配置失败:', error);
    return false;
  }
};

/**
 * 加载配置
 * @param {string} configName - 配置名称
 * @returns {Object|null} 配置对象
 */
const loadConfig = (configName) => {
  try {
    const savedConfigs = wx.getStorageSync(STORAGE_KEY) || [];
    const config = savedConfigs.find(c => c.name === configName);

    if (!config) {
      console.warn('配置不存在:', configName);
      return null;
    }

    console.log('配置已加载:', configName);
    return config;
  } catch (error) {
    console.error('加载配置失败:', error);
    return null;
  }
};

/**
 * 删除配置
 * @param {string} configName - 配置名称
 * @returns {boolean} 是否成功
 */
const deleteConfig = (configName) => {
  try {
    let savedConfigs = wx.getStorageSync(STORAGE_KEY) || [];
    const filteredConfigs = savedConfigs.filter(c => c.name !== configName);

    if (filteredConfigs.length === savedConfigs.length) {
      console.warn('配置不存在，无法删除:', configName);
      return false;
    }

    wx.setStorageSync(STORAGE_KEY, filteredConfigs);
    console.log('配置已删除:', configName);
    return true;
  } catch (error) {
    console.error('删除配置失败:', error);
    return false;
  }
};

/**
 * 获取所有配置
 * @returns {Array} 配置列表
 */
const getAllConfigs = () => {
  try {
    return wx.getStorageSync(STORAGE_KEY) || [];
  } catch (error) {
    console.error('获取配置列表失败:', error);
    return [];
  }
};

/**
 * 检查配置是否存在
 * @param {string} configName - 配置名称
 * @returns {boolean} 是否存在
 */
const configExists = (configName) => {
  try {
    const savedConfigs = wx.getStorageSync(STORAGE_KEY) || [];
    return savedConfigs.some(c => c.name === configName);
  } catch (error) {
    console.error('检查配置存在失败:', error);
    return false;
  }
};

module.exports = {
  saveConfig,
  loadConfig,
  deleteConfig,
  getAllConfigs,
  configExists,
  STORAGE_KEY
};
```

#### 步骤 4.3：修改 index.js 引入服务

在 index.js 顶部添加：

```javascript
const {
  saveDraft,
  restoreDraft,
  clearDraft,
  formatDraftQuestions,
  formatDraftModels
} = require('../../services/draftService');

const {
  saveConfig,
  loadConfig,
  deleteConfig,
  getAllConfigs,
  configExists
} = require('../../services/configService');
```

#### 步骤 4.4：重构草稿和配置相关方法

```javascript
// 重构 restoreDraft
restoreDraft: function() {
  const draft = restoreDraft(); // 调用服务函数

  if (draft) {
    const formattedQuestions = formatDraftQuestions(draft.customQuestions);
    const updatedDomestic = formatDraftModels(this.data.domesticAiModels, draft.selectedModels);
    const updatedOverseas = formatDraftModels(this.data.overseasAiModels, draft.selectedModels);

    this.setData({
      brandName: draft.brandName || '',
      currentCompetitor: draft.currentCompetitor || '',
      competitorBrands: draft.competitorBrands || [],
      customQuestions: formattedQuestions,
      domesticAiModels: updatedDomestic,
      overseasAiModels: updatedOverseas
    });

    this.updateSelectedModelCount();
    this.updateSelectedQuestionCount();
  }
},

// 重构 saveCurrentInput
saveCurrentInput: function() {
  const { brandName, currentCompetitor, competitorBrands, customQuestions, domesticAiModels, overseasAiModels } = this.data;

  const selectedDomestic = domesticAiModels
    .filter(model => model.checked)
    .map(model => model.name);

  const selectedOverseas = overseasAiModels
    .filter(model => model.checked)
    .map(model => model.name);

  saveDraft({
    brandName: brandName || '',
    currentCompetitor: currentCompetitor || '',
    competitorBrands: competitorBrands || [],
    customQuestions: customQuestions || [],
    selectedModels: {
      domestic: selectedDomestic,
      overseas: selectedOverseas
    },
    updatedAt: Date.now()
  });
},

// 重构 saveCurrentConfig
saveCurrentConfig: function() {
  const configName = this.data.configName.trim();

  if (!configName) {
    wx.showToast({ title: '请输入配置名称', icon: 'none' });
    return;
  }

  const validQuestions = this.data.customQuestions
    .filter(questionObj => questionObj.show !== false && questionObj.text && questionObj.text.trim() !== '');

  const currentConfig = {
    name: configName,
    brandName: this.data.brandName,
    competitorBrands: this.data.competitorBrands,
    customQuestions: validQuestions,
    domesticAiModels: this.data.domesticAiModels.map(model => ({
      name: model.name,
      checked: model.checked
    })),
    overseasAiModels: this.data.overseasAiModels.map(model => ({
      name: model.name,
      checked: model.checked
    }))
  };

  if (configExists(configName)) {
    wx.showModal({
      title: '配置已存在',
      content: `配置 "${configName}" 已存在，是否覆盖？`,
      success: (res) => {
        if (res.confirm) {
          saveConfig(currentConfig);
          wx.showToast({ title: '配置已更新', icon: 'success' });
          this.hideSaveConfigModal();
        }
      }
    });
  } else {
    saveConfig(currentConfig);
    wx.showToast({ title: '配置已保存', icon: 'success' });
    this.hideSaveConfigModal();
  }
},

// 重构 loadSavedConfig
loadSavedConfig: function(configName) {
  const config = loadConfig(configName);

  if (!config) {
    wx.showToast({ title: '配置不存在', icon: 'none' });
    return;
  }

  this.setData({
    brandName: config.brandName,
    competitorBrands: config.competitorBrands,
    customQuestions: config.customQuestions,
    domesticAiModels: this.data.domesticAiModels.map(model => {
      const savedModel = config.domesticAiModels.find(saved => saved.name === model.name);
      return {
        ...model,
        checked: savedModel ? savedModel.checked : false
      };
    }),
    overseasAiModels: this.data.overseasAiModels.map(model => {
      const savedModel = config.overseasAiModels.find(saved => saved.name === model.name);
      return {
        ...model,
        checked: savedModel ? savedModel.checked : false
      };
    })
  });

  wx.showToast({ title: '配置已加载', icon: 'success' });
}
```

#### 步骤 4.5：验证测试

| 测试项 | 操作 | 预期 |
|-------|------|------|
| V4.1 | 输入品牌后刷新 | 草稿正确恢复 |
| V4.2 | 保存配置 | 配置成功保存 |
| V4.3 | 加载配置 | 配置正确加载 |
| V4.4 | 7 天后草稿 | 草稿自动过期 |

---

### 阶段 5：导航服务提取（2 小时）

#### 步骤 5.1：创建 services/navigationService.js

```javascript
// ==================== services/navigationService.js ====================
/**
 * 导航服务
 * 负责页面跳转和 Storage 数据保存
 */

/**
 * 保存到 Storage 并跳转到结果页
 * @param {Object} resultData - 结果数据
 * @param {string} executionId - 执行 ID
 * @param {string} brandName - 品牌名称
 */
const saveAndNavigateToResults = (resultData, executionId, brandName) => {
  try {
    const resultsToSave = resultData.detailed_results || resultData.results || [];
    const competitiveAnalysisToSave = resultData.competitive_analysis || {};
    const brandScoresToSave = resultData.brand_scores || (competitiveAnalysisToSave && competitiveAnalysisToSave.brandScores) || {};

    // 保存到统一 Storage
    wx.setStorageSync('last_diagnostic_results', {
      results: resultsToSave,
      competitiveAnalysis: competitiveAnalysisToSave,
      brandScores: brandScoresToSave,
      targetBrand: brandName,
      executionId: executionId,
      timestamp: Date.now()
    });

    // 兼容旧逻辑
    wx.setStorageSync('latestTestResults_' + executionId, resultsToSave);
    wx.setStorageSync('latestCompetitiveAnalysis_' + executionId, competitiveAnalysisToSave);
    wx.setStorageSync('latestBrandScores_' + executionId, brandScoresToSave);
    wx.setStorageSync('latestTargetBrand', brandName);

    console.log('✅ 数据已保存到本地存储:', {
      resultsCount: resultsToSave.length,
      hasCompetitiveAnalysis: Object.keys(competitiveAnalysisToSave).length > 0,
      hasBrandScores: Object.keys(brandScoresToSave).length > 0
    });

    // 跳转
    wx.navigateTo({
      url: `/pages/results/results?executionId=${executionId}&brandName=${encodeURIComponent(brandName)}`,
      success: () => {
        console.log('✅ 已跳转到结果页');
      },
      fail: (err) => {
        console.error('跳转失败:', err);
        wx.showToast({ title: '跳转失败，请重试', icon: 'none' });
      }
    });
  } catch (error) {
    console.error('保存并跳转失败:', error);
    wx.showToast({ title: '保存失败', icon: 'none' });
  }
};

/**
 * 跳转到战略看板
 * @param {Object} reportData - 报告数据
 * @param {string} brandName - 品牌名称
 */
const navigateToDashboard = (reportData, brandName) => {
  try {
    const executionId = reportData?.executionId || Date.now().toString();

    if (reportData) {
      wx.setStorageSync('lastReport', reportData);

      const detailedResults = reportData.detailed_results || reportData.results || [];
      if (detailedResults && detailedResults.length > 0) {
        wx.setStorageSync('latestTestResults_' + executionId, detailedResults);
        wx.setStorageSync('latestTestResults', detailedResults);
      }

      wx.setStorageSync('latestTargetBrand', brandName || reportData.brand_name || '品牌');

      const competitiveAnalysis = reportData.competitiveAnalysis || {
        brandScores: {},
        firstMentionByPlatform: {},
        interceptionRisks: []
      };
      wx.setStorageSync('latestCompetitiveAnalysis_' + executionId, competitiveAnalysis);
      wx.setStorageSync('latestCompetitiveAnalysis', competitiveAnalysis);

      const brandScores = reportData.brand_scores ||
                         (reportData.competitiveAnalysis && reportData.competitiveAnalysis.brandScores) ||
                         {};
      if (brandScores && Object.keys(brandScores).length > 0) {
        wx.setStorageSync('latestBrandScores_' + executionId, brandScores);
        wx.setStorageSync('latestBrandScores', brandScores);
      }
    }

    setTimeout(() => {
      wx.redirectTo({
        url: `/pages/results/results?executionId=${executionId}&brandName=${encodeURIComponent(brandName || '品牌')}`,
        success: () => {
          console.log('✅ 诊断完成，已跳转到结果页');
        },
        fail: (err) => {
          console.error('跳转失败:', err);
          wx.showToast({ title: '请前往"我的"查看报告', icon: 'none' });
        }
      });
    }, 500);
  } catch (error) {
    console.error('导航失败:', error);
  }
};

/**
 * 跳转到报告详情页
 * @param {Object} reportData - 报告数据
 */
const navigateToReportDetail = (reportData) => {
  try {
    if (reportData) {
      const executionId = reportData.executionId || '';
      wx.setStorageSync('lastReport', reportData);

      wx.navigateTo({
        url: `/pages/report/dashboard/index?executionId=${executionId}`,
        fail: (err) => {
          console.error('跳转报告页面失败:', err);
          wx.showToast({ title: '跳转失败', icon: 'none' });
        }
      });
    } else {
      wx.showToast({ title: '暂无报告数据', icon: 'none' });
    }
  } catch (error) {
    console.error('跳转报告失败:', error);
  }
};

/**
 * 跳转到历史记录
 */
const navigateToHistory = () => {
  wx.navigateTo({
    url: '/pages/personal-history/personal-history',
    fail: (err) => {
      console.error('跳转历史失败:', err);
    }
  });
};

/**
 * 跳转到配置管理
 */
const navigateToConfigManager = () => {
  wx.navigateTo({
    url: '/pages/config-manager/config-manager',
    fail: (err) => {
      console.error('跳转配置管理失败:', err);
    }
  });
};

/**
 * 跳转到权限管理
 */
const navigateToPermissionManager = () => {
  wx.navigateTo({
    url: '/pages/permission-manager/permission-manager',
    fail: (err) => {
      console.error('跳转权限管理失败:', err);
    }
  });
};

/**
 * 跳转到数据管理
 */
const navigateToDataManager = () => {
  wx.navigateTo({
    url: '/pages/data-manager/data-manager',
    fail: (err) => {
      console.error('跳转数据管理失败:', err);
    }
  });
};

/**
 * 跳转到用户指南
 */
const navigateToUserGuide = () => {
  wx.navigateTo({
    url: '/pages/user-guide/user-guide',
    fail: (err) => {
      console.error('跳转用户指南失败:', err);
    }
  });
};

module.exports = {
  saveAndNavigateToResults,
  navigateToDashboard,
  navigateToReportDetail,
  navigateToHistory,
  navigateToConfigManager,
  navigateToPermissionManager,
  navigateToDataManager,
  navigateToUserGuide
};
```

#### 步骤 5.2：修改 index.js 引入导航服务

```javascript
const {
  saveAndNavigateToResults,
  navigateToDashboard,
  navigateToReportDetail,
  navigateToHistory,
  navigateToConfigManager,
  navigateToPermissionManager,
  navigateToDataManager,
  navigateToUserGuide
} = require('../../services/navigationService');
```

#### 步骤 5.3：替换导航方法

将原有的导航方法替换为服务调用，每方法约 20-30 行，共删除约 150 行。

#### 步骤 5.4：验证测试

| 测试项 | 操作 | 预期 |
|-------|------|------|
| V5.1 | 诊断完成跳转 | 正确跳转结果页 |
| V5.2 | 点击查看报告 | 正确跳转报告页 |
| V5.3 | 点击查看历史 | 正确跳转历史页 |

---

### 阶段 6：初始化服务提取（3 小时）

#### 步骤 6.1：创建 services/initService.js

```javascript
// ==================== services/initService.js ====================
/**
 * 初始化服务
 * 负责页面初始化相关的业务逻辑
 */

const { checkServerConnectionApi } = require('../api/home');

/**
 * 初始化默认值
 * @param {Object} pageContext - 页面上下文
 */
const initializeDefaults = (pageContext) => {
  if (!pageContext || !pageContext.setData) {
    console.warn('initializeDefaults: pageContext is invalid');
    return;
  }

  // 确保 config 和 diagnosticConfig 始终有默认值
  const config = pageContext.data?.config;
  const hasConfigEstimate = config && typeof config === 'object' && config.estimate && typeof config.estimate === 'object';

  if (!hasConfigEstimate) {
    pageContext.setData({
      config: {
        estimate: { duration: '30s', steps: 5 },
        brandName: '',
        competitorBrands: [],
        customQuestions: [{ text: '', show: true }, { text: '', show: true }, { text: '', show: true }]
      }
    });
  }

  const diagnosticConfig = pageContext.data?.diagnosticConfig;
  const hasDiagnosticEstimate = diagnosticConfig && typeof diagnosticConfig === 'object' && diagnosticConfig.estimate && typeof diagnosticConfig.estimate === 'object';

  if (!hasDiagnosticEstimate) {
    pageContext.setData({
      diagnosticConfig: {
        estimate: { duration: '30s', steps: 5 }
      }
    });
  }
};

/**
 * 检查服务器连接
 * @param {Object} pageContext - 页面上下文
 * @returns {Promise<boolean>} 是否连接成功
 */
const checkServerConnection = async (pageContext) => {
  try {
    await checkServerConnectionApi();
    if (pageContext && pageContext.setData) {
      pageContext.setData({ serverStatus: '已连接' });
    }
    return true;
  } catch (err) {
    console.error('服务器连接失败:', err);
    if (pageContext && pageContext.setData) {
      pageContext.setData({ serverStatus: '连接失败' });
    }
    wx.showToast({ title: '后端服务未启动', icon: 'error' });
    return false;
  }
};

/**
 * 加载用户 AI 平台偏好
 * @param {Object} pageContext - 页面上下文
 * @returns {Object} 偏好数据
 */
const loadUserPlatformPreferences = (pageContext) => {
  try {
    const STORAGE_KEY_PLATFORM_PREFS = 'user_ai_platform_preferences';
    const userPrefs = wx.getStorageSync(STORAGE_KEY_PLATFORM_PREFS);

    const DEFAULT_AI_PLATFORMS = {
      domestic: ['DeepSeek', '豆包', '通义千问', '智谱 AI'],
      overseas: []
    };

    let selectedDomestic = [];
    let selectedOverseas = [];

    if (userPrefs && typeof userPrefs === 'object') {
      selectedDomestic = userPrefs.domestic || [];
      selectedOverseas = userPrefs.overseas || [];
      console.log('加载用户 AI 平台偏好', userPrefs);
    } else {
      selectedDomestic = DEFAULT_AI_PLATFORMS.domestic;
      selectedOverseas = DEFAULT_AI_PLATFORMS.overseas;
      console.log('使用默认 AI 平台配置', selectedDomestic);
    }

    const domesticAiModels = pageContext.data?.domesticAiModels || [];
    const overseasAiModels = pageContext.data?.overseasAiModels || [];

    const updatedDomestic = domesticAiModels.map(model => ({
      ...model,
      checked: selectedDomestic.includes(model.name) && !model.disabled
    }));

    const updatedOverseas = overseasAiModels.map(model => ({
      ...model,
      checked: selectedOverseas.includes(model.name)
    }));

    if (pageContext && pageContext.setData) {
      pageContext.setData({
        domesticAiModels: updatedDomestic,
        overseasAiModels: updatedOverseas
      });
    }

    return { domestic: selectedDomestic, overseas: selectedOverseas };
  } catch (error) {
    console.error('加载用户平台偏好失败', error);
    return null;
  }
};

/**
 * 保存用户 AI 平台偏好
 * @param {Object} preferences - 偏好数据
 */
const saveUserPlatformPreferences = (preferences) => {
  try {
    const STORAGE_KEY_PLATFORM_PREFS = 'user_ai_platform_preferences';

    const userPrefs = {
      domestic: preferences.domestic || [],
      overseas: preferences.overseas || [],
      updatedAt: Date.now()
    };

    wx.setStorageSync(STORAGE_KEY_PLATFORM_PREFS, userPrefs);
    console.log('用户 AI 平台偏好已保存', userPrefs);
  } catch (error) {
    console.error('保存用户平台偏好失败', error);
  }
};

module.exports = {
  initializeDefaults,
  checkServerConnection,
  loadUserPlatformPreferences,
  saveUserPlatformPreferences
};
```

#### 步骤 6.2：修改 index.js 引入初始化服务

```javascript
const {
  initializeDefaults,
  checkServerConnection,
  loadUserPlatformPreferences,
  saveUserPlatformPreferences
} = require('../../services/initService');
```

#### 步骤 6.3：重构 onLoad 和相关方法

```javascript
onLoad: function (options) {
  try {
    console.log('品牌 AI 雷达 - 页面加载完成');

    // 1. 初始化默认值
    initializeDefaults(this);

    // 2. 检查服务器连接（异步）
    checkServerConnection(this);

    // 3. 加载用户 AI 平台偏好
    const prefs = loadUserPlatformPreferences(this);
    this.updateSelectedModelCount();
    this.updateSelectedQuestionCount();

    // 4. 检查是否需要立即启动快速搜索
    if (options && options.quickSearch === 'true') {
      setTimeout(() => {
        this.startBrandTest();
      }, 1000);
    }
  } catch (error) {
    console.error('onLoad 初始化失败:', error);

    this.setData({
      serverStatus: '初始化失败',
      config: {
        estimate: { duration: '30s', steps: 5 },
        brandName: '',
        competitorBrands: [],
        customQuestions: [{ text: '', show: true }, { text: '', show: true }, { text: '', show: true }]
      },
      diagnosticConfig: {
        estimate: { duration: '30s', steps: 5 }
      }
    });

    wx.showToast({
      title: '初始化失败，请刷新重试',
      icon: 'none',
      duration: 2000
    });
  }
},

onShow: function() {
  const app = getApp();
  if (app.globalData && app.globalData.tempConfig) {
    this.applyConfig(app.globalData.tempConfig);
    app.globalData.tempConfig = null;
  }

  this.restoreDraft();
  this.checkLatestDiagnosis();
}
```

#### 步骤 6.4：验证测试

| 测试项 | 操作 | 预期 |
|-------|------|------|
| V6.1 | 首次加载页面 | 默认值正确 |
| V6.2 | 刷新页面 | 偏好正确加载 |
| V6.3 | 后端未启动 | 显示错误提示 |

---

### 阶段 7：最终清理与验证（2 小时）

#### 步骤 7.1：删除 index.js 中已迁移的函数

确认以下函数已删除：

| 函数 | 迁移目标 | 行数 |
|-----|---------|------|
| `calculateTotalScore` | utils/helperUtils.js | 15 |
| `getTrendIndicator` | utils/helperUtils.js | 20 |
| `getCompletedTimeText` | utils/helperUtils.js | 10 |
| `processReportData` | services/dataProcessorService.js | 30 |
| `defensiveGet` | services/dataProcessorService.js | 40 |
| `getDefaultReportStructure` | services/dataProcessorService.js | 30 |
| `extractPredictionData` | services/dataProcessorService.js | 40 |
| `extractScoreData` | services/dataProcessorService.js | 50 |
| `extractCompetitionData` | services/dataProcessorService.js | 50 |
| `extractSourceListData` | services/dataProcessorService.js | 50 |
| `generateTrendChartData` | services/dataProcessorService.js | 40 |
| `saveDraft` 相关 | services/draftService.js | 80 |
| `saveConfig` 相关 | services/configService.js | 70 |
| 导航方法 | services/navigationService.js | 150 |
| `initializeDefaults` | services/initService.js | 50 |
| `checkServerConnection` | services/initService.js | 20 |
| `loadUserPlatformPreferences` | services/initService.js | 40 |

**预计删除约 885 行**

#### 步骤 7.2：保留在 index.js 的内容

保留的核心内容（约 400 行）：

- `data` 对象定义
- 生命周期方法（简化版）
- UI 交互方法（粒子动画、吸顶效果）
- 事件处理函数（输入、切换、点击）
- 问题/竞品管理方法

#### 步骤 7.3：完整功能验证

执行完整的测试清单：

| 测试项 | 操作 | 预期 | 状态 |
|-------|------|------|------|
| FVT.1 | 输入品牌、竞品、问题 | 输入正常 | ☐ |
| FVT.2 | 选择 AI 模型 | 选中状态正确 | ☐ |
| FVT.3 | 保存草稿后刷新 | 草稿恢复 | ☐ |
| FVT.4 | 保存配置并加载 | 配置正确 | ☐ |
| FVT.5 | 启动诊断 | 任务创建成功 | ☐ |
| FVT.6 | 进度轮询 | 进度条更新 | ☐ |
| FVT.7 | 诊断完成 | 跳转结果页 | ☐ |
| FVT.8 | 查看结果 | 数据完整 | ☐ |
| FVT.9 | 网络错误 | 友好提示 | ☐ |
| FVT.10 | 页面卸载 | 轮询停止 | ☐ |

#### 步骤 7.4：代码质量检查

```bash
# 使用微信开发者工具的编译检查
# 确保 0 错误、0 警告

# 检查文件大小
wc -l pages/index/index.js
# 目标：约 400-500 行

# 检查新文件
wc -l services/*.js utils/*.js
```

#### 步骤 7.5：提交重构成果

```bash
# 添加所有更改
git add pages/index/index.js
git add services/*.js
git add utils/*.js

# 提交
git commit -m "refactor: index.js 模块化重构

- 将 2276 行单文件分拆为 6 个服务模块
- 提取工具函数到 utils/helperUtils.js
- 提取数据处理到 services/dataProcessorService.js
- 提取诊断执行到 services/brandTestService.js
- 提取草稿管理到 services/draftService.js
- 提取配置管理到 services/configService.js
- 提取导航服务到 services/navigationService.js
- 提取初始化到 services/initService.js

重构后 index.js 约 400 行，缩减 82%"
```

---

## 四、回滚方案

### 回滚步骤

如果重构后发现问题，可以快速回滚：

```bash
# 1. 放弃当前更改
git checkout refactor/index-js-modularization
git reset --hard backup/index-js-before-refactor-$(date +%Y%m%d)

# 2. 或者恢复到重构前的提交
git log --oneline | grep "before refactor"
git reset --hard <commit-hash>
```

### 分阶段回滚

如果某个阶段出现问题，可以单独回滚该阶段：

```bash
# 例如，阶段 2 出现问题
git checkout HEAD -- pages/index/index.js
git rm services/dataProcessorService.js

# 然后重新执行阶段 2
```

---

## 五、重构后文件清单

### 新增文件

| 文件 | 行数 | 职责 |
|-----|------|------|
| `utils/helperUtils.js` | ~100 行 | 纯工具函数 |
| `services/initService.js` | ~150 行 | 初始化逻辑 |
| `services/draftService.js` | ~150 行 | 草稿管理 |
| `services/configService.js` | ~120 行 | 配置管理 |
| `services/brandTestService.js` | ~200 行 | 诊断执行 |
| `services/dataProcessorService.js` | ~350 行 | 数据处理 |
| `services/navigationService.js` | ~180 行 | 导航服务 |

### 修改文件

| 文件 | 重构前 | 重构后 | 缩减率 |
|-----|-------|-------|--------|
| `pages/index/index.js` | 2276 行 | ~400 行 | 82% ↓ |

---

## 六、验收标准

### 功能验收

- [ ] 所有基线测试通过（T0.1-T0.7）
- [ ] 所有阶段验证通过（V1.1-V6.3）
- [ ] 所有功能验证通过（FVT.1-FVT.10）

### 代码质量验收

- [ ] 微信开发者工具编译 0 错误、0 警告
- [ ] index.js 行数 < 500 行
- [ ] 每个服务文件有清晰的 JSDoc 注释
- [ ] 所有导出函数有参数说明

### 性能验收

- [ ] 页面加载时间无明显增加
- [ ] 诊断流程响应时间无明显增加
- [ ] Storage 操作无性能问题

---

**文档生成时间**: 2026-02-22  
**执行负责人**: 待定  
**预计完成日期**: 2026-02-26
