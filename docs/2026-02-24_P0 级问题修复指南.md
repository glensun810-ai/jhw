# P0 级问题立即修复指南

**修复日期**: 2026-02-24  
**优先级**: P0（阻塞性）  
**状态**: 进行中  

---

## P0-010: 应用异常处理装饰器

### 问题
异常处理装饰器已实现但未应用到实际路由函数。

### 修复步骤

**文件**: `backend_python/wechat_backend/views/diagnosis_views.py`

**步骤 1**: 确认导入（已完成）
```python
from wechat_backend.error_handler import handle_api_exceptions
```

**步骤 2**: 在 `perform_brand_test` 函数上添加装饰器

找到第 86-90 行：
```python
@wechat_bp.route('/api/perform-brand-test', methods=['POST', 'OPTIONS'])
@require_auth_optional  # 恢复认证装饰器
@rate_limit(limit=5, window=60, per='endpoint')
@monitored_endpoint('/api/perform-brand-test', require_auth=False, validate_inputs=True)
def perform_brand_test():
```

修改为：
```python
@wechat_bp.route('/api/perform-brand-test', methods=['POST', 'OPTIONS'])
@handle_api_exceptions  # P0-010 新增：统一异常处理
@require_auth_optional
@rate_limit(limit=5, window=60, per='endpoint')
@monitored_endpoint('/api/perform-brand-test', require_auth=False, validate_inputs=True)
def perform_brand_test():
```

### 验证

```bash
# 测试验证错误
curl -X POST http://127.0.0.1:5001/api/perform-brand-test \
  -H "Content-Type: application/json" \
  -d '{}'

# 预期响应（统一格式）
{
  "error": "缺少品牌列表参数",
  "code": "VALIDATION_ERROR",
  "status_code": 400,
  "details": {...}
}
```

---

## P0-011: 统一前端轮询逻辑

### 问题
`pages/index/index.js` 中存在两处轮询，浪费 50% 网络资源。

### 修复步骤

**文件**: `pages/index/index.js`

**步骤 1**: 找到 `callBackendBrandTest` 函数（约第 935 行）

**步骤 2**: 修改 `startDiagnosis` 调用

修复前：
```javascript
const executionId = await startDiagnosis(
  inputData,
  (parsedStatus) => {
    this.setData({
      testProgress: parsedStatus.progress,
      progressText: parsedStatus.statusText,
      currentStage: parsedStatus.stage
    });
  },
  (parsedStatus) => {
    wx.hideLoading();
    this.handleDiagnosisComplete(parsedStatus, executionId);
  },
  (error) => {
    wx.hideLoading();
    this.handleDiagnosisError(error);
  }
);
```

修复后：
```javascript
// P0-011 修复：只启动诊断，不轮询
const executionId = await startDiagnosis(inputData);
```

**步骤 3**: 保留 `pollingController` 轮询

```javascript
this.pollingController = createPollingController(
  executionId,
  (parsedStatus) => {
    this.setData({
      testProgress: parsedStatus.progress,
      progressText: parsedStatus.statusText,
      currentStage: parsedStatus.stage,
      debugJson: JSON.stringify(parsedStatus, null, 2)
    });
  },
  (parsedStatus) => {
    wx.hideLoading();
    this.handleDiagnosisComplete(parsedStatus, executionId);
  },
  (error) => {
    wx.hideLoading();
    this.handleDiagnosisError(error);
  }
);

this.pollingController.start(800, true);
```

### 验证

打开微信开发者工具控制台：
- 修复前：每个进度更新有 2 个请求
- 修复后：每个进度更新只有 1 个请求

---

## P0-012: 展示部分完成警告

### 问题
后端记录了部分完成警告，但前端未展示，用户可能被误导。

### 修复步骤

**文件 1**: `services/dataLoaderService.js`

**步骤 1**: 确保提取 warning 字段（第 100 行左右）

修复前：
```javascript
const data = {
  results: res.detailed_results || res.results || [],
  competitive_analysis: res.competitive_analysis || {},
  brand_scores: res.brand_scores || {},
  // ...
};
```

修复后：
```javascript
const data = {
  results: res.detailed_results || res.results || [],
  competitive_analysis: res.competitive_analysis || {},
  brand_scores: res.brand_scores || {},
  // P0-012 新增：提取警告和质量评分
  warning: res.warning || null,
  missing_count: res.missing_count || 0,
  quality_score: res.quality_score || null,
  quality_level: res.quality_level || null
};
```

**文件 2**: `pages/results/results.js`

**步骤 2**: 在 onLoad 函数中显示警告（约第 120 行）

添加代码：
```javascript
// 显示警告（如果有）
if (result.data.warning) {
  wx.showModal({
    title: '诊断提示',
    content: `诊断部分完成：${result.data.warning}\n\n已获取 ${result.data.results.length} 条有效结果`,
    showCancel: false,
    confirmText: '查看结果'
  });
}
```

**文件 3**: `pages/results/results.wxml`

**步骤 3**: 添加质量评分展示

在页面头部添加：
```html
<!-- 质量评分徽章 -->
<view class="quality-badge" wx:if="{{qualityScore}}">
  <text class="quality-score">报告质量：{{qualityScore}}分</text>
  <text class="quality-level">{{qualityLevelText}}</text>
</view>
```

### 验证

1. 运行诊断，故意让部分 AI 失败
2. 查看是否弹出警告提示
3. 检查结果页是否显示质量评分

---

## 完成标准

- [ ] P0-010: 装饰器已应用，错误响应格式统一
- [ ] P0-011: 轮询请求减少 50%
- [ ] P0-012: 部分完成时显示警告提示

---

**修复负责人**: AI Assistant  
**预计完成时间**: 2 小时  
**状态**: 进行中
