# 首页用户输入保存功能深度分析与修复方案

**分析日期**: 2026-02-21
**优先级**: P1
**状态**: ⏳ 待修复

---

## 一、现状分析

### 1.1 已实现功能 ✅

| 功能 | 状态 | 实现位置 |
|------|------|---------|
| 品牌名称保存 | ✅ 已实现 | `saveCurrentInput()` |
| 竞品列表保存 | ✅ 已实现 | `saveCurrentInput()` |
| 品牌名称恢复 | ✅ 已实现 | `restoreDraft()` |
| 竞品列表恢复 | ✅ 已实现 | `restoreDraft()` |
| AI 平台偏好加载 | ✅ 已实现 | `loadUserPlatformPreferences()` |
| AI 平台偏好保存 | ✅ 已实现 | `saveUserPlatformPreferences()` |

### 1.2 缺失功能 ❌

| 功能 | 状态 | 说明 |
|------|------|------|
| **自定义问题保存** | ❌ **缺失** | 用户输入的问题未保存 |
| **自定义问题恢复** | ❌ **缺失** | 重新进入后问题丢失 |
| **AI 平台选择保存触发** | ❌ **缺失** | `toggleModelSelection` 未调用保存 |
| **自定义问题保存触发** | ❌ **缺失** | `onCustomQuestionInput` 未调用保存 |

---

## 二、问题定位

### 2.1 自定义问题未保存

#### 问题代码位置
```javascript
// pages/index/index.js:517-524
onCustomQuestionInput: function(e) {
  const index = e.currentTarget.dataset.index;
  const value = e.detail.value;
  let customQuestions = this.data.customQuestions;
  customQuestions[index].text = value;
  this.setData({ customQuestions: customQuestions });
  this.updateSelectedQuestionCount();
  // ❌ 缺失：this.saveCurrentInput();
}
```

**同样问题存在于**:
- `addCustomQuestion()` (第 526 行)
- `removeCustomQuestion()` (第 533 行)

#### 根本原因
- ✅ 有输入处理函数
- ✅ 有数据更新逻辑
- ❌ **无保存触发调用**

---

### 2.2 AI 平台选择保存未触发

#### 问题代码位置
```javascript
// pages/index/index.js:561-573
toggleModelSelection: function(e) {
  const { type, index } = e.currentTarget.dataset;
  const key = type === 'domestic' ? 'domesticAiModels' : 'overseasAiModels';
  const models = this.data[key];

  if (models[index].disabled) {
    wx.showToast({ title: '该模型暂未配置', icon: 'none' });
    return;
  }

  models[index].checked = !models[index].checked;
  this.setData({ [key]: models });
  this.updateSelectedModelCount();
  // ❌ 缺失：this.saveUserPlatformPreferences();
}
```

**同样问题存在于**:
- `selectAllModels()` (第 576 行)

#### 根本原因
- ✅ 有选择切换函数
- ✅ 有数据更新逻辑
- ✅ 有独立的保存函数 `saveUserPlatformPreferences()`
- ❌ **但切换函数未调用保存函数**

---

### 2.3 restoreDraft 未恢复自定义问题

#### 问题代码位置
```javascript
// pages/index/index.js:361-383
restoreDraft: function() {
  const draft = wx.getStorageSync('draft_diagnostic_input');
  
  if (draft && (draft.brandName || draft.competitorBrands?.length > 0)) {
    // ... 检查时间
    
    if (draftAge < sevenDays) {
      this.setData({
        brandName: draft.brandName || '',
        currentCompetitor: draft.currentCompetitor || '',
        competitorBrands: draft.competitorBrands || []
        // ❌ 缺失：customQuestions: draft.customQuestions || [...]
      });
      console.log('草稿已恢复', draft);
    }
  }
}
```

#### 根本原因
- ✅ 有草稿恢复函数
- ✅ 恢复品牌和竞品数据
- ❌ **未恢复 customQuestions 字段**

---

### 2.4 saveCurrentInput 未保存自定义问题

#### 问题代码位置
```javascript
// pages/index/index.js:345-358
saveCurrentInput: function() {
  const { brandName, currentCompetitor, competitorBrands } = this.data;

  wx.setStorageSync('draft_diagnostic_input', {
    brandName: brandName || '',
    currentCompetitor: currentCompetitor || '',
    competitorBrands: competitorBrands || [],
    updatedAt: Date.now()
    // ❌ 缺失：customQuestions: customQuestions
  });

  console.log('草稿已自动保存', { brandName, currentCompetitor });
}
```

#### 根本原因
- ✅ 有保存函数
- ✅ 保存品牌和竞品
- ❌ **未保存 customQuestions 字段**

---

## 三、修复方案

### 3.1 修复 saveCurrentInput 函数

**位置**: `pages/index/index.js` 第 345 行

**修复内容**:
```javascript
saveCurrentInput: function() {
  const { brandName, currentCompetitor, competitorBrands, customQuestions } = this.data;

  wx.setStorageSync('draft_diagnostic_input', {
    brandName: brandName || '',
    currentCompetitor: currentCompetitor || '',
    competitorBrands: competitorBrands || [],
    customQuestions: customQuestions || [],  // ← 新增
    updatedAt: Date.now()
  });

  console.log('草稿已自动保存', { brandName, currentCompetitor, customQuestions });
}
```

---

### 3.2 修复 restoreDraft 函数

**位置**: `pages/index/index.js` 第 361 行

**修复内容**:
```javascript
restoreDraft: function() {
  const draft = wx.getStorageSync('draft_diagnostic_input');
  
  if (draft && (draft.brandName || draft.competitorBrands?.length > 0)) {
    const now = Date.now();
    const draftAge = now - draft.updatedAt;
    const sevenDays = 7 * 24 * 60 * 60 * 1000;

    if (draftAge < sevenDays) {
      this.setData({
        brandName: draft.brandName || '',
        currentCompetitor: draft.currentCompetitor || '',
        competitorBrands: draft.competitorBrands || [],
        customQuestions: draft.customQuestions || [{text: '', show: true}, {text: '', show: true}, {text: '', show: true}]  // ← 新增
      });
      console.log('草稿已恢复', draft);
    } else {
      wx.removeStorageSync('draft_diagnostic_input');
      console.log('草稿已过期，已清除');
    }
  }
}
```

---

### 3.3 在问题输入函数中添加保存触发

#### 3.3.1 onCustomQuestionInput

**位置**: `pages/index/index.js` 第 517 行

**修复内容**:
```javascript
onCustomQuestionInput: function(e) {
  const index = e.currentTarget.dataset.index;
  const value = e.detail.value;
  let customQuestions = this.data.customQuestions;
  customQuestions[index].text = value;
  this.setData({ customQuestions: customQuestions });
  this.updateSelectedQuestionCount();
  
  // ← 新增：防抖保存
  clearTimeout(this.saveInputTimer);
  this.saveInputTimer = setTimeout(() => {
    this.saveCurrentInput();
  }, 500);
}
```

#### 3.3.2 addCustomQuestion

**位置**: `pages/index/index.js` 第 526 行

**修复内容**:
```javascript
addCustomQuestion: function() {
  let customQuestions = this.data.customQuestions;
  customQuestions.push({text: '', show: true});
  this.setData({ customQuestions: customQuestions });
  this.updateSelectedQuestionCount();
  
  // ← 新增
  this.saveCurrentInput();
}
```

#### 3.3.3 removeCustomQuestion

**位置**: `pages/index/index.js` 第 533 行

**修复内容**:
```javascript
removeCustomQuestion: function(e) {
  const index = e.currentTarget.dataset.index;
  let customQuestions = this.data.customQuestions;

  if (customQuestions.length === 1) {
    customQuestions[0].text = '';
    this.setData({ customQuestions: customQuestions });
  } else {
    customQuestions.splice(index, 1);
    this.setData({ customQuestions: customQuestions });
  }

  this.updateSelectedQuestionCount();
  
  // ← 新增
  this.saveCurrentInput();
}
```

---

### 3.4 在 AI 平台选择函数中添加保存触发

#### 3.4.1 toggleModelSelection

**位置**: `pages/index/index.js` 第 561 行

**修复内容**:
```javascript
toggleModelSelection: function(e) {
  const { type, index } = e.currentTarget.dataset;
  const key = type === 'domestic' ? 'domesticAiModels' : 'overseasAiModels';
  const models = this.data[key];

  if (models[index].disabled) {
    wx.showToast({ title: '该模型暂未配置', icon: 'none' });
    return;
  }

  models[index].checked = !models[index].checked;
  this.setData({ [key]: models });
  this.updateSelectedModelCount();
  
  // ← 新增
  this.saveUserPlatformPreferences();
}
```

#### 3.4.2 selectAllModels

**位置**: `pages/index/index.js` 第 576 行

**修复内容**:
```javascript
selectAllModels: function(e) {
  const { type } = e.currentTarget.dataset;
  const key = type === 'domestic' ? 'domesticAiModels' : 'overseasAiModels';
  const models = this.data[key].map(model => ({
    ...model,
    checked: !model.disabled
  }));
  this.setData({ [key]: models });
  this.updateSelectedModelCount();
  
  // ← 新增
  this.saveUserPlatformPreferences();
}
```

---

### 3.5 onShow 中添加 AI 平台偏好加载

**位置**: `pages/index/index.js` 第 150 行

**当前代码**:
```javascript
onShow: function() {
  if (app.globalData && app.globalData.tempConfig) {
    this.applyConfig(app.globalData.tempConfig);
    app.globalData.tempConfig = null;
  }

  this.restoreDraft();
}
```

**修复内容**:
```javascript
onShow: function() {
  if (app.globalData && app.globalData.tempConfig) {
    this.applyConfig(app.globalData.tempConfig);
    app.globalData.tempConfig = null;
  }

  this.restoreDraft();
  this.loadUserPlatformPreferences();  // ← 新增：确保每次显示都加载偏好
}
```

---

## 四、修复清单

### 4.1 必须修复项 (P0)

| 序号 | 修复项 | 影响 | 工作量 |
|------|--------|------|--------|
| 1 | `saveCurrentInput` 添加 customQuestions | 高 | 2 分钟 |
| 2 | `restoreDraft` 添加 customQuestions 恢复 | 高 | 2 分钟 |
| 3 | `onCustomQuestionInput` 添加保存触发 | 高 | 3 分钟 |
| 4 | `addCustomQuestion` 添加保存触发 | 中 | 1 分钟 |
| 5 | `removeCustomQuestion` 添加保存触发 | 中 | 1 分钟 |
| 6 | `toggleModelSelection` 添加保存触发 | 高 | 1 分钟 |
| 7 | `selectAllModels` 添加保存触发 | 中 | 1 分钟 |

### 4.2 建议修复项 (P1)

| 序号 | 修复项 | 影响 | 工作量 |
|------|--------|------|--------|
| 8 | `onShow` 添加 loadUserPlatformPreferences | 中 | 1 分钟 |
| 9 | 添加保存成功提示 | 低 | 2 分钟 |
| 10 | 添加自定义问题数量限制提示 | 低 | 3 分钟 |

---

## 五、测试验证

### 5.1 自定义问题保存测试

**步骤**:
1. 输入品牌名称"测试品牌"
2. 输入竞品"竞品 1"
3. **输入自定义问题**："华为性价比如何？"
4. **添加第二个问题**："小米和 OPPO 哪个更好？"
5. 退出小程序
6. 重新进入

**预期结果**:
- ✅ 品牌名称显示"测试品牌"
- ✅ 竞品列表显示"竞品 1"
- ✅ **自定义问题显示"华为性价比如何？"和"小米和 OPPO 哪个更好？"**

### 5.2 AI 平台选择保存测试

**步骤**:
1. 取消"豆包"
2. 选中"Kimi"
3. 选中"文心一言"
4. 退出小程序
5. 重新进入

**预期结果**:
- ✅ "豆包"未选中
- ✅ "Kimi"选中
- ✅ "文心一言"选中
- ✅ "DeepSeek"、"通义千问"、"智谱 AI"保持选中（默认）

### 5.3 混合场景测试

**步骤**:
1. 输入品牌"华为"
2. 添加竞品"苹果"、"三星"
3. 修改自定义问题为"华为 vs 苹果哪个好？"
4. 取消"豆包"，选中"Kimi"
5. 退出小程序
6. 重新进入
7. **再次修改**自定义问题为"华为手机性价比如何？"
8. 再次退出
9. 第三次进入

**预期结果**:
- ✅ 所有数据正确恢复
- ✅ 第二次修改的问题也正确保存
- ✅ 无数据丢失

---

## 六、风险评估

### 6.1 潜在风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|---------|
| 存储数据过大 | 低 | 中 | 限制问题数量（最多 10 个） |
| 频繁写入存储 | 中 | 低 | 使用防抖（500ms） |
| 旧数据兼容性 | 低 | 低 | 提供默认值 |

### 6.2 兼容性考虑

- ✅ 旧用户无 customQuestions 字段 → 使用默认值
- ✅ 旧用户无 AI 平台偏好 → 使用默认配置
- ✅ 存储 key 变更 → 使用新 key，旧数据自然过期

---

## 七、总结

### 7.1 核心问题
1. ❌ `saveCurrentInput` 未保存 customQuestions
2. ❌ `restoreDraft` 未恢复 customQuestions
3. ❌ 问题输入函数未触发保存
4. ❌ AI 平台选择函数未触发保存

### 7.2 修复优先级
- **P0**: 1-7 项（必须修复）
- **P1**: 8-10 项（建议修复）

### 7.3 预计工作量
- **总工作量**: 约 15 分钟
- **修复文件**: 1 个 (`pages/index/index.js`)
- **修复函数**: 7 个

### 7.4 修复后效果
- ✅ 自定义问题自动保存和恢复
- ✅ AI 平台选择自动保存和恢复
- ✅ 用户输入完整保留
- ✅ 用户体验显著提升

---

**分析人**: AI Assistant
**审核状态**: ⏳ 待审核
**建议操作**: 审核通过后，按修复方案逐项实施
