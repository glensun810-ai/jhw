# P0-001 后端路由重复定义修复指南

**问题**: `views.py` 和 `diagnosis_views.py` 中存在重复的路由定义

**影响**: Flask 可能随机选择一个路由处理请求，导致行为不一致

## 修复步骤

### 步骤 1: 删除 views.py 中的重复路由

打开文件：`backend_python/wechat_backend/views.py`

**删除范围**: 第 177 行 到 第 464 行（`perform_brand_test` 函数）

删除以下内容：
```python
@wechat_bp.route('/api/perform-brand-test', methods=['POST', 'OPTIONS'])
@require_auth_optional  # 恢复认证装饰器
@rate_limit(limit=5, window=60, per='endpoint')  # 限制每个端点每分钟最多 5 个请求
@monitored_endpoint('/api/perform-brand-test', require_auth=False, validate_inputs=True)
def perform_brand_test():
    """Perform brand cognition test across multiple AI platforms (Async) with Multi-Brand Support"""
    # ... (约 288 行代码)
    return jsonify({'status': 'success', 'execution_id': execution_id, 'message': 'Test started successfully'})
```

### 步骤 2: 添加注释说明

在 `views.py` 的第 176 行后添加：

```python
# =============================================================================
# 注意：诊断相关路由已移至 diagnosis_views.py
# - /api/perform-brand-test
# - /api/mvp/deepseek-test
# - /api/mvp/qwen-test
# - /api/mvp/zhipu-test
# - /api/mvp/brand-test
# - /api/test-progress
# - /test/submit
# - /test/status/<task_id>
# - /test/result/<task_id>
# 请在 diagnosis_views.py 中查找这些路由
# =============================================================================
```

### 步骤 3: 验证修复

运行以下命令验证路由唯一性：
```bash
cd backend_python
grep -n "@wechat_bp.route.*perform-brand-test" wechat_backend/*.py wechat_backend/views/*.py
```

预期结果：只在 `views/diagnosis_views.py` 中找到该路由。

## 其他重复路由

同样需要检查并删除以下重复路由（如果存在）：
- `/api/mvp/deepseek-test`
- `/api/mvp/qwen-test`
- `/api/mvp/zhipu-test`
- `/api/mvp/brand-test`
- `/api/test-progress`
- `/test/submit`
- `/test/status/<task_id>`
- `/test/result/<task_id>`

这些路由都应该只在 `diagnosis_views.py` 中定义。
