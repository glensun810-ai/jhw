# P2-1 管理后台实施报告

**文档版本**: v1.0  
**创建日期**: 2026-02-21  
**实施状态**: ✅ 已完成  

---

## 执行摘要

### 问题描述

无管理员界面，导致：
- 无法查看系统整体状态
- 无法管理用户和权限
- 无法查看系统日志
- 缺乏运营监控手段

### 实施内容

本次实施完成了完整的管理后台系统，包括：
1. ✅ 后端管理 API（用户管理、权限分配、系统监控、日志查看）
2. ✅ 管理员仪表盘页面
3. ✅ 用户管理页面
4. ✅ 测试记录管理页面
5. ✅ 系统监控页面
6. ✅ 日志查看页面

### 新增 API 端点

| 端点 | 方法 | 功能 | 权限 |
|------|------|------|------|
| `/admin/dashboard` | GET | 管理员仪表盘数据 | 管理员 |
| `/admin/users` | GET | 用户列表 | 管理员 |
| `/admin/users/<id>` | GET | 用户详情 | 管理员 |
| `/admin/users/<id>/roles` | POST | 分配用户角色 | 管理员 |
| `/admin/tests` | GET | 测试记录列表 | 管理员 |
| `/admin/system/status` | GET | 系统状态 | 管理员 |
| `/admin/system/logs` | GET | 系统日志 | 管理员 |
| `/admin/platforms` | GET | AI 平台配置状态 | 管理员 |

### 新增页面

| 页面 | 路径 | 功能 |
|------|------|------|
| 仪表盘 | `/pages/admin/dashboard/dashboard` | 系统概览、快捷入口 |
| 用户管理 | `/pages/admin/users/users` | 用户列表、权限管理 |
| 测试记录 | `/pages/admin/tests/tests` | 测试记录查询 |
| 系统监控 | `/pages/admin/system/system` | 系统资源监控 |
| 日志查看 | `/pages/admin/logs/logs` | 系统日志查看 |

---

## 第一部分：后端实现

### 1.1 管理员权限检查

**文件**: `backend_python/wechat_backend/views_admin.py`

```python
def require_admin(f):
    """装饰器：要求管理员权限"""
    from functools import wraps
    
    @wraps(f)
    def decorated_function(*args, **kwargs):
        user_id = get_current_user_id()
        
        # 检查是否为管理员
        if not is_admin_user(user_id):
            return jsonify({'error': 'Admin access required'}), 403
        
        return f(*args, **kwargs)
    
    return decorated_function


def is_admin_user(user_id):
    """检查用户是否为管理员"""
    # 从数据库检查用户角色
    cursor.execute('''
        SELECT r.role_name FROM user_roles ur
        JOIN roles r ON ur.role_id = r.id
        WHERE ur.user_id = ? AND r.role_name = 'admin'
    ''', (user_id,))
    
    return cursor.fetchone() is not None
```

**特性**:
- ✅ 基于角色的权限检查
- ✅ 从数据库动态读取角色
- ✅ 统一的 403 错误返回

---

### 1.2 仪表盘 API

**端点**: `GET /admin/dashboard`

**返回数据**:
```json
{
  "status": "success",
  "data": {
    "overview": {
      "total_users": 150,
      "new_users_today": 5,
      "total_tests": 1200,
      "tests_today": 25
    },
    "pending_tasks": {
      "ai_fetching": 3,
      "ranking_analysis": 2
    },
    "recent_activities": [
      {
        "user_id": "123",
        "brand_name": "测试品牌",
        "test_date": "2026-02-21T10:00:00",
        "overall_score": 85
      }
    ]
  }
}
```

---

### 1.3 用户管理 API

**端点**: `GET /admin/users`

**查询参数**:
- `page`: 页码（默认 1）
- `page_size`: 每页数量（默认 20）
- `search`: 搜索关键词（手机号/昵称）

**返回数据**:
```json
{
  "status": "success",
  "data": {
    "users": [
      {
        "id": "123",
        "phone": "138****5678",
        "nickname": "用户昵称",
        "avatar_url": "",
        "created_at": "2026-02-20T10:00:00"
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 150,
      "total_pages": 8
    }
  }
}
```

**端点**: `POST /admin/users/<user_id>/roles`

**请求体**:
```json
{
  "role": "admin",
  "action": "grant"  // 或 "revoke"
}
```

---

### 1.4 系统监控 API

**端点**: `GET /admin/system/status`

**返回数据**:
```json
{
  "status": "success",
  "data": {
    "system": {
      "platform": "Linux",
      "platform_version": "5.4.0",
      "python_version": "3.9.0"
    },
    "resources": {
      "cpu_percent": 25.5,
      "memory_percent": 60.2,
      "memory_total_gb": 16,
      "memory_used_gb": 9.6,
      "disk_percent": 45.0,
      "disk_total_gb": 500,
      "disk_used_gb": 225
    }
  }
}
```

**依赖**: `psutil` 库（可选）

---

### 1.5 日志查看 API

**端点**: `GET /admin/system/logs`

**查询参数**:
- `level`: 日志级别（ERROR, WARNING, INFO, ALL）
- `lines`: 行数（默认 100）

**返回数据**:
```json
{
  "status": "success",
  "data": {
    "logs": [
      "2026-02-21 10:00:00 - ERROR - Some error message",
      "2026-02-21 10:01:00 - INFO - Some info message"
    ],
    "level": "ERROR",
    "count": 50
  }
}
```

---

## 第二部分：前端实现

### 2.1 仪表盘页面

**文件**: `pages/admin/dashboard/dashboard.*`

**功能**:
- ✅ 概览卡片（用户数、测试数）
- ✅ 待处理任务列表
- ✅ 最近活动列表
- ✅ 功能快捷入口

**UI 布局**:
```
┌─────────────────────────────────────┐
│  管理后台                            │
│  系统监控与管理                      │
├─────────────────────────────────────┤
│  ┌──────┐ ┌──────┐                 │
│  │ 用户  │ │ 今日  │                 │
│  │ 150  │ │ +5   │                 │
│  └──────┘ └──────┘                 │
│  ┌──────┐ ┌──────┐                 │
│  │ 测试  │ │ 今日  │                 │
│  │ 1200 │ │ +25  │                 │
│  └──────┘ └──────┘                 │
├─────────────────────────────────────┤
│  待处理任务                          │
│  - AI 获取中：3                      │
│  - 排名分析：2                       │
├─────────────────────────────────────┤
│  最近活动                            │
│  - 测试品牌 (用户 123) 评分：85      │
├─────────────────────────────────────┤
│  [用户] [测试] [系统] [日志]         │
└─────────────────────────────────────┘
```

---

### 2.2 用户管理页面

**文件**: `pages/admin/users/users.*`

**功能**:
- ✅ 用户列表展示
- ✅ 搜索功能（手机号/昵称）
- ✅ 分页导航
- ✅ 用户详情查看
- ✅ 权限管理入口

---

### 2.3 系统监控页面

**功能**:
- ✅ CPU 使用率
- ✅ 内存使用情况
- ✅ 磁盘使用情况
- ✅ 系统信息

---

### 2.4 日志查看页面

**功能**:
- ✅ 日志级别筛选
- ✅ 日志列表展示
- ✅ 实时刷新
- ✅ 日志搜索

---

## 第三部分：安全考虑

### 3.1 访问控制

- ✅ 所有管理端点需要认证（@require_auth）
- ✅ 所有管理端点需要管理员角色（@require_admin）
- ✅ 基于数据库的角色检查
- ✅ 统一的 403 错误处理

### 3.2 数据安全

- ✅ 手机号脱敏展示（138****5678）
- ✅ 分页防止数据泄露
- ✅ 搜索输入验证
- ✅ SQL 注入防护

### 3.3 权限管理

**授予管理员权限**:
```sql
INSERT INTO user_roles (user_id, role_id)
SELECT ?, id FROM roles WHERE role_name = 'admin';
```

**撤销管理员权限**:
```sql
DELETE FROM user_roles
WHERE user_id = ? AND role_id = (
  SELECT id FROM roles WHERE role_name = 'admin'
);
```

---

## 第四部分：部署指南

### 4.1 初始化管理员

**方法 1: 直接插入数据库**
```sql
-- 1. 确保 admin 角色存在
INSERT OR IGNORE INTO roles (role_name, description) 
VALUES ('admin', 'System Administrator');

-- 2. 授予用户管理员角色
INSERT INTO user_roles (user_id, role_id)
SELECT 'user_id', id FROM roles WHERE role_name = 'admin';
```

**方法 2: 使用 API**
```bash
curl -X POST http://127.0.0.1:5000/admin/users/<user_id>/roles \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{"role": "admin", "action": "grant"}'
```

### 4.2 依赖安装

**可选依赖（系统监控）**:
```bash
pip install psutil
```

---

## 第五部分：使用示例

### 5.1 查看仪表盘

```javascript
// 小程序中访问
wx.navigateTo({
  url: '/pages/admin/dashboard/dashboard'
});
```

### 5.2 查看用户列表

```javascript
const token = wx.getStorageSync('token');

wx.request({
  url: 'http://127.0.0.1:5000/admin/users?page=1&page_size=20',
  header: {
    'Authorization': `Bearer ${token}`
  },
  success: (res) => {
    console.log('用户列表:', res.data.data.users);
  }
});
```

### 5.3 授予管理员权限

```javascript
wx.request({
  url: 'http://127.0.0.1:5000/admin/users/123/roles',
  method: 'POST',
  header: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  data: {
    'role': 'admin',
    'action': 'grant'
  },
  success: (res) => {
    console.log('权限授予成功');
  }
});
```

### 5.4 查看系统日志

```javascript
wx.request({
  url: 'http://127.0.0.1:5000/admin/system/logs?level=ERROR&lines=50',
  header: {
    'Authorization': `Bearer ${token}`
  },
  success: (res) => {
    console.log('错误日志:', res.data.data.logs);
  }
});
```

---

## 第六部分：后续改进计划

### P1 改进项

1. **数据可视化**
   - 用户增长趋势图
   - 测试量统计图表
   - 平台使用率分析

2. **批量操作**
   - 批量授予权限
   - 批量导出用户数据
   - 批量删除测试记录

### P2 改进项

3. **审计日志**
   - 记录管理员操作
   - 操作日志查询
   - 异常操作告警

4. **告警系统**
   - 系统资源告警
   - 错误率告警
   - 异常登录告警

### P3 改进项

5. **Web 管理后台**
   - 独立的 Web 管理界面
   - 更丰富的图表展示
   - 更便捷的操作体验

---

## 第七部分：故障排查

### 7.1 常见问题

**问题 1**: 403 Admin access required

```
原因：用户没有管理员角色
解决：
1. 检查用户是否有 admin 角色
2. 使用 SQL 授予管理员权限
3. 确认 token 有效
```

**问题 2**: 日志文件不存在

```
原因：logs/app.log 文件不存在
解决：
1. 创建日志目录：mkdir -p logs
2. 检查日志配置
3. 重启后端服务
```

**问题 3**: psutil 导入失败

```
原因：未安装 psutil 库
解决：pip install psutil
或：忽略系统资源监控功能
```

---

**文档结束**
