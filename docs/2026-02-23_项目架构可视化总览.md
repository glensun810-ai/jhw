# 项目架构可视化总览

**生成时间**: 2026-02-23T16:39:24.249424

**文件统计**: {'total_api_endpoints': 148, 'total_functions': 822, 'total_classes': 100, 'total_data_models': 6, 'total_import_relationships': 83}

# 项目架构总览

```mermaid
graph TB
    classDef api fill:#e1f5ff,stroke:#0066cc
    classDef service fill:#fff4e1,stroke:#ff9900
    classDef model fill:#f0e1ff,stroke:#9900cc
    classDef frontend fill:#e1ffe1,stroke:#00cc00
    classDef backend fill:#ffe1e1,stroke:#cc0000

    subgraph Frontend[前端 - 微信小程序]
        Pages[pages/ - 页面层]
        Services[services/ - 服务层]
        API[api/ - API 调用]
        Utils[utils/ - 工具函数]
    end

    subgraph Backend[后端 - Flask API]
        Views[views.py - API 路由层]
        Adapters[ai_adapters/ - AI 适配器]
        Services[services/ - 业务服务]
        Models[models/ - 数据模型]
        Database[database/ - 数据库]
    end

    subgraph External[外部服务]
        Doubao[豆包 AI API]
        DeepSeek[DeepSeek API]
        Qwen[通义千问 API]
        WeChat[微信小程序 API]
    end

    %% 前端调用关系
    Pages --> Services
    Services --> API
    API -->|HTTP/HTTPS| Views

    %% 后端内部调用
    Views --> Adapters
    Views --> Services
    Services --> Models
    Models --> Database

    %% 后端调用外部服务
    Adapters --> Doubao
    Adapters --> DeepSeek
    Adapters --> Qwen

    %% 样式应用
    class Pages,Services,API,Utils frontend
    class Views,Adapters,Services,Models,Database backend
    class Doubao,DeepSeek,Qwen,WeChat service
```

## 诊断功能数据流

```mermaid
sequenceDiagram
    participant User as 用户
    participant Frontend as 前端小程序
    participant API as 后端 API
    participant NxM as NxM 引擎
    participant Adapter as AI 适配器
    participant AI as AI 平台
    participant DB as 数据库

    User->>Frontend: 输入品牌名称
    Frontend->>Frontend: 选择 AI 模型
    Frontend->>API: POST /api/perform-brand-test
    API->>API: 验证输入参数
    API->>API: 生成 execution_id
    API->>NxM: 启动异步任务
    API-->>Frontend: 返回 execution_id

    loop 轮询状态 (800ms)
        Frontend->>API: GET /test/status/{execution_id}
        API-->>Frontend: 返回进度状态
    end

    NxM->>NxM: 解析问题模板
    NxM->>Adapter: 创建 AI 客户端
    Adapter->>Adapter: 构建 Prompt
    Note over Adapter: brand_name, competitors, question
    Adapter->>AI: 发送 API 请求
    AI-->>Adapter: 返回 AI 响应
    Adapter->>Adapter: 解析 GEO JSON
    Adapter->>NxM: 返回结果

    NxM->>DB: 保存测试结果
    NxM->>API: 更新 execution_store
    API-->>Frontend: 返回完成状态
    Frontend->>Frontend: 跳转结果页
```

## 核心参数传递流程

```mermaid
graph LR
    subgraph FrontendParams[前端参数]
        FP1[brandName: 品牌名称]
        FP2[competitorBrands: 竞品列表]
        FP3[selectedModels: AI 模型]
        FP4[customQuestions: 自定义问题]
    end

    subgraph APIParams[API 参数]
        AP1[brand_list: Array]
        AP2[selectedModels: Array]
        AP3[custom_question: String]
    end

    subgraph NxMParams[NxM 引擎参数]
        NP1[main_brand: String]
        NP2[competitor_brands: Array]
        NP3[selected_models: Array]
        NP4[raw_questions: Array]
    end

    subgraph TemplateParams[模板参数]
        TP1[brand_name: String ✅]
        TP2[competitors: String ✅]
        TP3[question: String ✅]
    end

    FP1 --> AP1
    FP2 --> AP1
    FP3 --> AP2
    FP4 --> AP3
    AP1 --> NP1
    AP1 --> NP2
    AP2 --> NP3
    AP3 --> NP4
    NP1 --> TP1
    NP2 --> TP2
    NP4 --> TP3

    classDef frontend fill:#e1ffe1,stroke:#00cc00
    classDef api fill:#e1f5ff,stroke:#0066cc
    classDef nxm fill:#fff4e1,stroke:#ff9900
    classDef template fill:#f0e1ff,stroke:#9900cc
    class FP1,FP2,FP3,FP4 frontend
    class AP1,AP2,AP3 api
    class NP1,NP2,NP3,NP4 nxm
    class TP1,TP2,TP3 template
```