# 端到端联调打通分析报告

**报告日期**: 2026-02-23  
**分析人**: 首席测试专家 (AI)  
**分析目标**: 从用户输入到拿到真实 AI 品牌影响力诊断结果的端到端打通

---

## 一、报错分析

### 1.1 错误现象

从截图可见：
- **错误标题**: "诊断启动失败"
- **错误信息**: "服务接口不存在，请：1.检查后端服务是否已启动 2.确认 API 路径配置是否正确 3.联系开发人员修复"
- **触发场景**: 用户点击"AI 品牌战略诊断"按钮
- **错误类型**: 404 Not Found（服务接口不存在）

### 1.2 错误根因

通过代码分析，问题出在**前端请求的 API 端点与后端路由不匹配**：

**前端配置** (`utils/config.js`):
```javascript
BRAND: {
  TEST: '/api/perform-brand-test',  // ✅ 正确
  PROGRESS: '/api/test-progress',
  STATUS: '/test/status'
}
```

**后端路由** (`wechat_backend/views/diagnosis_views.py`):
```python
@wechat_bp.route('/api/perform-brand-test', methods=['POST', 'OPTIONS'])
def perform_brand_test():
    # ✅ 路由已定义
```

**问题**: 路由已定义，但返回 404，说明**蓝图未正确注册或应用未启动**

---

## 二、端到端链路梳理

### 2.1 完整数据流

```
用户输入
  ↓
[pages/index/index.js] startBrandTest()
  ↓
[api/home.js] startBrandTestApi(payload)
  ↓
[utils/request.js] post('/api/perform-brand-test', payload)
  ↓
[后端] wechat_backend/views/diagnosis_views.py::perform_brand_test()
  ↓
[NxM 执行引擎] execute_nxm_test()
  ↓
[AI 平台调用] AIAdapterFactory.createClient()
  ↓
[结果聚合] aggregateReport()
  ↓
[进度轮询] getTaskStatusApi(executionId)
  ↓
[结果展示] pages/results/results.js
```

### 2.2 关键节点检查

| 节点 | 文件 | 状态 | 问题 |
|-----|------|------|------|
| 前端请求 | `api/home.js` | ✅ | 无 |
| 请求工具 | `utils/request.js` | ⚠️ | 需检查 baseURL 配置 |
| 后端路由 | `diagnosis_views.py` | ✅ | 无 |
| 蓝图注册 | `wechat_backend/views/__init__.py` | ✅ | 无 |
| 应用启动 | `wechat_backend/app.py` | ✅ | 无 |
| 服务运行 | `run.py` | ❓ | **需确认是否启动** |

---

## 三、问题清单

### 3.1 必须修复的 Bug (P0)

| 编号 | 问题 | 影响 | 修复方案 |
|-----|------|------|---------|
| **P0-1** | 后端服务未启动 | 所有 API 请求 404 | 启动后端服务 |
| **P0-2** | 端口不匹配 | 前端请求错误端口 | 统一使用 5000 端口 |
| **P0-3** | CORS 配置问题 | OPTIONS 预检失败 | 检查 CORS 配置 |

### 3.2 需要联调打通的功能 (P1)

| 编号 | 功能 | 前端 | 后端 | 状态 |
|-----|------|------|------|------|
| **P1-1** | 品牌诊断 API | `startBrandTestApi()` | `perform_brand_test()` | ⚠️ 需联调 |
| **P1-2** | 进度轮询 API | `getTaskStatusApi()` | `test/status/<task_id>` | ⚠️ 需联调 |
| **P1-3** | 结果获取 API | `getTestProgressApi()` | `test-progress` | ⚠️ 需联调 |
| **P1-4** | AI 平台调用 | - | `AIAdapterFactory` | ⚠️ 需配置 API Key |

### 3.3 必须增加的功能 (P2)

| 编号 | 功能 | 说明 | 优先级 |
|-----|------|------|--------|
| **P2-1** | 错误重试机制 | 网络错误自动重试 | P2 |
| **P2-2** | 加载状态优化 | 显示详细的加载进度 | P2 |
| **P2-3** | 结果缓存 | 避免重复诊断 | P2 |
| **P2-4** | 诊断历史 | 查看历史诊断记录 | P2 |

---

## 四、修复方案

### 4.1 P0-1: 启动后端服务

**步骤**:

1. **检查后端服务状态**
```bash
# 检查端口 5000 是否被占用
lsof -i :5000

# 如果没有输出，说明服务未启动
```

2. **启动后端服务**
```bash
cd /Users/sgl/PycharmProjects/PythonProject/backend_python
python run.py
```

3. **验证服务启动**
```bash
# 健康检查
curl http://127.0.0.1:5000/health

# 预期输出：{"status": "ok"}
```

4. **测试诊断 API**
```bash
curl -X POST http://127.0.0.1:5000/api/perform-brand-test \
  -H "Content-Type: application/json" \
  -d '{
    "brand_list": ["测试品牌"],
    "selectedModels": [{"name": "DeepSeek", "checked": true}],
    "custom_question": "介绍一下测试品牌"
  }'
```

### 4.2 P0-2: 统一端口配置

**前端配置** (`utils/config.js`):
```javascript
develop: {
  baseURL: 'http://127.0.0.1:5000',  // ✅ 确保使用 5000 端口
  timeout: 30000,
  env: 'dev'
}
```

**后端配置** (`run.py`):
```python
if __name__ == '__main__':
    port = int(os.environ.get('PORT', 5000))  # ✅ 确保使用 5000 端口
    app.run(host='127.0.0.1', port=port)
```

### 4.3 P0-3: CORS 配置检查

**后端 CORS 配置** (`wechat_backend/app.py`):
```python
CORS(app,
     supports_credentials=True,
     resources={
         r"/api/*": {
             "origins": "*",
             "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
             "allow_headers": ["Content-Type", "Authorization", "X-WX-OpenID"],
         }
     })
```

**验证 OPTIONS 预检**:
```bash
curl -X OPTIONS http://127.0.0.1:5000/api/perform-brand-test \
  -H "Origin: http://localhost" \
  -i
```

预期响应头：
```
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: POST,OPTIONS
Access-Control-Allow-Headers: Content-Type
```

---

## 五、联调测试计划

### 5.1 第一阶段：基础连通性测试

**测试用例**:

| 用例 | 端点 | 方法 | 预期 | 状态 |
|-----|------|------|------|------|
| 健康检查 | `/health` | GET | 200 OK | ⏳ |
| 首页访问 | `/` | GET | 200 OK | ⏳ |
| API 测试 | `/api/test` | GET | 200 OK | ⏳ |
| CORS 预检 | `/api/perform-brand-test` | OPTIONS | 200 OK | ⏳ |

**执行命令**:
```bash
cd /Users/sgl/PycharmProjects/PythonProject/backend_python/tests
python quick_test.py
```

### 5.2 第二阶段：诊断 API 测试

**测试用例**:

| 用例 | 端点 | 方法 | 参数 | 预期 | 状态 |
|-----|------|------|------|------|------|
| 启动诊断 | `/api/perform-brand-test` | POST | brand_list, selectedModels | 200 + executionId | ⏳ |
| 查询状态 | `/test/status/{id}` | GET | executionId | 200 + progress | ⏳ |
| 获取进度 | `/api/test-progress` | GET | executionId | 200 + results | ⏳ |

**测试脚本**:
```bash
cd /Users/sgl/PycharmProjects/PythonProject/backend_python/tests
python test_startup.py
```

### 5.3 第三阶段：端到端集成测试

**测试流程**:

1. 前端输入品牌名称和 AI 平台选择
2. 点击"AI 品牌战略诊断"按钮
3. 前端调用 `startBrandTestApi()`
4. 后端执行 NxM 测试
5. 前端轮询进度
6. 后端返回诊断结果
7. 前端展示结果页面

**验证点**:
- ✅ 前端能正确发送请求
- ✅ 后端能接收并处理请求
- ✅ AI 平台调用成功
- ✅ 结果正确返回
- ✅ 前端正确展示结果

---

## 六、功能完善清单

### 6.1 必须增加的前端功能

| 功能 | 说明 | 优先级 | 工作量 |
|-----|------|--------|--------|
| **加载状态优化** | 显示详细的诊断进度（0-100%） | P1 | 2h |
| **错误重试** | 网络错误自动重试 3 次 | P1 | 1h |
| **结果缓存** | 缓存诊断结果，避免重复请求 | P2 | 2h |
| **诊断历史** | 查看历史诊断记录 | P2 | 4h |
| **进度推送** | 使用 SSE 实时推送进度 | P2 | 4h |

### 6.2 必须增加的后端功能

| 功能 | 说明 | 优先级 | 工作量 |
|-----|------|--------|--------|
| **SSE 推送** | Server-Sent Events 实时推送进度 | P1 | 4h |
| **任务队列** | Celery 异步任务队列 | P1 | 8h |
| **结果缓存** | Redis 缓存诊断结果 | P2 | 4h |
| **限流升级** | 基于用户的限流策略 | P2 | 2h |
| **日志优化** | 结构化日志，便于调试 | P2 | 2h |

### 6.3 配置优化

| 配置项 | 当前值 | 建议值 | 说明 |
|-------|--------|--------|------|
| 超时时间 | 30s | 120s | 诊断任务耗时较长 |
| 重试次数 | 0 | 3 | 网络错误自动重试 |
| 缓存时间 | 无 | 24h | 诊断结果缓存 24 小时 |
| 并发限制 | 5 次/分 | 10 次/分 | 提高并发能力 |

---

## 七、端到端打通检查清单

### 7.1 后端检查项

- [ ] **服务启动**: 后端服务运行在 5000 端口
- [ ] **路由注册**: `/api/perform-brand-test` 路由已注册
- [ ] **CORS 配置**: 支持 OPTIONS 预检请求
- [ ] **数据库连接**: 数据库连接正常
- [ ] **AI 平台配置**: API Key 已配置
- [ ] **日志记录**: 请求日志正常输出

### 7.2 前端检查项

- [ ] **API 配置**: baseURL 配置正确
- [ ] **请求发送**: startBrandTestApi() 能正确发送请求
- [ ] **错误处理**: handleException() 能正确处理错误
- [ ] **进度轮询**: getTaskStatusApi() 能正确轮询
- [ ] **结果展示**: 结果页面能正确展示数据

### 7.3 联调检查项

- [ ] **连通性**: 前端能访问后端 API
- [ ] **诊断 API**: 能成功启动诊断任务
- [ ] **进度轮询**: 能正确获取进度信息
- [ ] **结果获取**: 能正确获取诊断结果
- [ ] **结果展示**: 前端能正确展示结果

---

## 八、执行步骤

### 8.1 立即执行（P0）

```bash
# 1. 启动后端服务
cd /Users/sgl/PycharmProjects/PythonProject/backend_python
python run.py

# 2. 验证服务启动
curl http://127.0.0.1:5000/health

# 3. 测试诊断 API
curl -X POST http://127.0.0.1:5000/api/perform-brand-test \
  -H "Content-Type: application/json" \
  -d '{
    "brand_list": ["测试品牌"],
    "selectedModels": [{"name": "DeepSeek", "checked": true}],
    "custom_question": "介绍一下测试品牌"
  }'
```

### 8.2 短期优化（P1）

1. **增加加载状态优化** (2h)
2. **增加错误重试机制** (1h)
3. **配置 AI 平台 API Key** (1h)
4. **端到端集成测试** (2h)

### 8.3 中期完善（P2）

1. **实现 SSE 推送** (4h)
2. **实现结果缓存** (4h)
3. **实现诊断历史** (4h)
4. **性能优化** (4h)

---

## 九、风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|-----|------|------|---------|
| 后端服务不稳定 | 中 | 高 | 增加健康检查和自动重启 |
| AI 平台 API 限流 | 高 | 高 | 增加缓存和限流策略 |
| 网络超时 | 中 | 中 | 增加重试机制 |
| 数据库连接泄漏 | 低 | 高 | 增加连接池监控 |

---

## 十、总结

### 10.1 核心问题

**当前报错的根本原因是后端服务未启动或端口配置不匹配**，导致前端请求返回 404 错误。

### 10.2 修复优先级

1. **P0**: 启动后端服务，统一端口配置
2. **P1**: 联调诊断 API，增加加载状态
3. **P2**: 完善功能，增加 SSE 推送和缓存

### 10.3 预期效果

修复后，用户能够：
- ✅ 顺利启动品牌诊断
- ✅ 实时查看诊断进度
- ✅ 获取真实的 AI 品牌影响力诊断结果
- ✅ 获得良好的用户体验

---

**报告生成时间**: 2026-02-23  
**分析人**: 首席测试专家 (AI)  
**审核状态**: ⏳ 待执行  
**建议行动**: 立即启动后端服务并验证
