# 端到端测试缺口实施计划

**制定日期**: 2026-02-23  
**制定人**: 首席测试专家 (AI)  
**目标**: 完成从用户输入到真实 AI 诊断结果的端到端验证

---

## 一、已完成测试总结

### 1.1 已通过的测试

| 测试类别 | 测试项 | 状态 | 通过率 |
|---------|--------|------|--------|
| **P0 级修复验证** | 后端服务配置 | ✅ | 100% |
| | 端口统一配置 | ✅ | 100% |
| | CORS 配置修复 | ✅ | 100% |
| **P1 级联调** | 诊断 API 联调 | ✅ | 100% |
| | 进度轮询 API | ✅ | 100% |
| | API Key 配置 | ✅ | 100% |
| **P2 级优化** | 加载状态优化 | ✅ | 100% |
| | 错误重试机制 | ✅ | 100% |
| | 结果缓存 | ✅ | 100% |
| **端到端连通性** | 健康检查 | ✅ (200, 2ms) | - |
| | 首页访问 | ✅ (200) | - |
| | API 测试端点 | ✅ (200) | - |
| | CORS 预检 | ✅ (200, CORS=✓) | - |
| | 诊断 API 快速测试 | ✅ (200) | - |

**当前通过率**: 83.3% (5/6 端到端测试通过)

### 1.2 未通过的测试

| 测试项 | 失败原因 | 影响 | 优先级 |
|-------|---------|------|--------|
| AI 平台列表 (404) | 路由未注册或名称不匹配 | 中 | P1 |

---

## 二、剩余测试清单

### 2.1 第一阶段：后端 API 深度测试（未完成）

| 编号 | 测试项 | 端点 | 方法 | 状态 | 优先级 |
|-----|--------|------|------|------|--------|
| **T1.1** | AI 平台列表 | `/api/ai-platforms` | GET | ❌ 404 | P1 |
| **T1.2** | 平台状态查询 | `/api/platform-status` | GET | ⏳ 未测 | P1 |
| **T1.3** | 诊断任务提交 | `/api/perform-brand-test` | POST | ✅ 200 | - |
| **T1.4** | 任务状态查询 | `/test/status/{id}` | GET | ⏳ 未测 | P0 |
| **T1.5** | 任务进度查询 | `/api/test-progress` | GET | ⏳ 未测 | P0 |
| **T1.6** | 诊断结果获取 | `/test/result/{id}` | GET | ⏳ 未测 | P0 |

### 2.2 第二阶段：真实 AI 调用测试（未完成）

| 编号 | 测试项 | AI 平台 | 状态 | 优先级 |
|-----|--------|--------|------|--------|
| **T2.1** | DeepSeek 调用 | DeepSeek | ⏳ 未测 | P0 |
| **T2.2** | 豆包调用 | Doubao | ⏳ 未测 | P0 |
| **T2.3** | 通义千问调用 | Qwen | ⏳ 未测 | P0 |
| **T2.4** | 智谱 AI 调用 | Zhipu | ⏳ 未测 | P1 |
| **T2.5** | ChatGPT 调用 | ChatGPT | ⏳ 未测 | P2 |
| **T2.6** | Gemini 调用 | Gemini | ⏳ 未测 | P2 |

### 2.3 第三阶段：端到端完整流程测试（未完成）

| 编号 | 测试场景 | 步骤 | 状态 | 优先级 |
|-----|---------|------|------|--------|
| **T3.1** | 单品牌单模型诊断 | 输入→提交→轮询→结果 | ⏳ 未测 | P0 |
| **T3.2** | 单品牌多模型诊断 | 输入→提交→轮询→聚合 | ⏳ 未测 | P0 |
| **T3.3** | 多品牌多模型诊断 | 输入→提交→轮询→对比 | ⏳ 未测 | P1 |
| **T3.4** | 缓存命中测试 | 重复输入→使用缓存 | ⏳ 未测 | P1 |
| **T3.5** | 错误重试测试 | 断网→重试→恢复 | ⏳ 未测 | P1 |

### 2.4 第四阶段：前端页面联调测试（未完成）

| 编号 | 测试项 | 页面 | 状态 | 优先级 |
|-----|--------|------|------|--------|
| **T4.1** | 首页输入 | pages/index | ⏳ 未测 | P0 |
| **T4.2** | 结果展示 | pages/results | ⏳ 未测 | P0 |
| **T4.3** | 进度显示 | pages/index | ⏳ 未测 | P1 |
| **T4.4** | 错误提示 | pages/index | ⏳ 未测 | P1 |
| **T4.5** | 缓存提示 | pages/index | ⏳ 未测 | P2 |

---

## 三、测试实施步骤

### 3.1 第一步：修复 AI 平台列表 API（P1）

**问题**: `/api/ai-platforms` 返回 404

**可能原因**:
1. 路由未注册
2. 蓝图导入问题
3. 路由名称不匹配

**修复步骤**:
```bash
# 1. 检查路由是否注册
cd /Users/sgl/PycharmProjects/PythonProject/backend_python
python3 -c "from wechat_backend.app import app; print([str(r) for r in app.url_map.iter_rules() if 'ai-platform' in str(r)])"

# 2. 如果未注册，检查 analytics_views.py
# 3. 确保 views/__init__.py 导入了 analytics_views
```

**预期结果**: `/api/ai-platforms` 返回 200

---

### 3.2 第二步：执行后端 API 深度测试（P0）

**测试脚本**: `backend_python/tests/test_api_depth.py` (新建)

**测试内容**:
```python
#!/usr/bin/env python3
"""
后端 API 深度测试
测试所有诊断相关 API
"""

import requests
import time

BASE_URL = "http://127.0.0.1:5000"

def test_all_apis():
    """测试所有 API 端点"""
    
    # 1. AI 平台列表
    print("\n1. 测试 AI 平台列表...")
    response = requests.get(f"{BASE_URL}/api/ai-platforms", timeout=10)
    print(f"   状态码：{response.status_code}")
    if response.status_code == 200:
        platforms = response.json()
        print(f"   可用平台：{len(platforms)} 个")
    
    # 2. 平台状态查询
    print("\n2. 测试平台状态查询...")
    response = requests.get(f"{BASE_URL}/api/platform-status", timeout=10)
    print(f"   状态码：{response.status_code}")
    
    # 3. 诊断任务提交
    print("\n3. 测试诊断任务提交...")
    payload = {
        "brand_list": ["测试品牌"],
        "selectedModels": [{"name": "DeepSeek", "checked": True}],
        "custom_question": "介绍一下测试品牌"
    }
    response = requests.post(
        f"{BASE_URL}/api/perform-brand-test",
        json=payload,
        timeout=30
    )
    print(f"   状态码：{response.status_code}")
    if response.status_code == 200:
        data = response.json()
        execution_id = data.get('execution_id')
        print(f"   执行 ID: {execution_id}")
        return execution_id
    
    return None

if __name__ == '__main__':
    test_all_apis()
```

---

### 3.3 第三步：执行真实 AI 调用测试（P0）

**测试脚本**: `backend_python/tests/test_real_ai_call.py` (新建)

**测试内容**:
```python
#!/usr/bin/env python3
"""
真实 AI 调用测试
测试实际调用 AI 平台并获取响应
"""

import requests
import time

BASE_URL = "http://127.0.0.1:5000"

def test_real_ai_call(platform_name):
    """测试真实 AI 调用"""
    
    print(f"\n测试 {platform_name} 调用...")
    
    payload = {
        "brand_list": ["测试品牌"],
        "selectedModels": [{"name": platform_name, "checked": True}],
        "custom_question": "介绍一下测试品牌"
    }
    
    # 1. 提交任务
    response = requests.post(
        f"{BASE_URL}/api/perform-brand-test",
        json=payload,
        timeout=30
    )
    
    if response.status_code != 200:
        print(f"   ❌ 任务提交失败：{response.status_code}")
        return None
    
    execution_id = response.json().get('execution_id')
    print(f"   ✅ 任务提交成功，执行 ID: {execution_id}")
    
    # 2. 轮询进度
    max_retries = 30
    for i in range(max_retries):
        time.sleep(2)
        
        status_response = requests.get(
            f"{BASE_URL}/test/status/{execution_id}",
            timeout=10
        )
        
        if status_response.status_code == 200:
            status_data = status_response.json()
            stage = status_data.get('stage', 'unknown')
            progress = status_data.get('progress', 0)
            
            print(f"   进度：{progress}% - {stage}")
            
            if stage == 'completed':
                print(f"   ✅ AI 调用完成")
                return True
            elif stage == 'failed':
                print(f"   ❌ AI 调用失败")
                return False
    
    print(f"   ⏱️ 轮询超时")
    return None

if __name__ == '__main__':
    # 测试主要平台
    platforms = ['deepseek', 'qwen', 'doubao']
    
    results = {}
    for platform in platforms:
        results[platform] = test_real_ai_call(platform)
    
    # 打印总结
    print("\n" + "="*60)
    print("测试总结")
    print("="*60)
    for platform, result in results.items():
        status = "✅" if result else "❌" if result is False else "⏱️"
        print(f"  {status} {platform}: {result}")
```

---

### 3.4 第四步：执行端到端完整流程测试（P0）

**测试脚本**: `backend_python/tests/test_e2e_full_flow.py` (新建)

**测试内容**:
```python
#!/usr/bin/env python3
"""
端到端完整流程测试
模拟真实用户从输入到获取结果的完整流程
"""

import requests
import time

BASE_URL = "http://127.0.0.1:5000"

def test_full_flow():
    """测试完整诊断流程"""
    
    print("\n" + "="*60)
    print("端到端完整流程测试")
    print("="*60)
    
    # 步骤 1: 用户输入
    print("\n1. 用户输入...")
    brand_name = "测试品牌"
    competitor_brands = ["竞品 A", "竞品 B"]
    selected_models = [
        {"name": "DeepSeek", "checked": True},
        {"name": "Qwen", "checked": True}
    ]
    custom_questions = ["介绍一下测试品牌", "测试品牌的优势是什么"]
    
    print(f"   品牌：{brand_name}")
    print(f"   竞品：{competitor_brands}")
    print(f"   模型：{[m['name'] for m in selected_models]}")
    print(f"   问题：{custom_questions}")
    
    # 步骤 2: 提交诊断
    print("\n2. 提交诊断...")
    payload = {
        "brand_list": [brand_name] + competitor_brands,
        "selectedModels": selected_models,
        "custom_question": " ".join(custom_questions)
    }
    
    response = requests.post(
        f"{BASE_URL}/api/perform-brand-test",
        json=payload,
        timeout=30
    )
    
    if response.status_code != 200:
        print(f"   ❌ 提交失败：{response.status_code}")
        return False
    
    execution_id = response.json().get('execution_id')
    print(f"   ✅ 提交成功，执行 ID: {execution_id}")
    
    # 步骤 3: 轮询进度
    print("\n3. 轮询进度...")
    max_retries = 60  # 最多等待 2 分钟
    last_stage = ''
    
    for i in range(max_retries):
        time.sleep(2)
        
        status_response = requests.get(
            f"{BASE_URL}/test/status/{execution_id}",
            timeout=10
        )
        
        if status_response.status_code == 200:
            status_data = status_response.json()
            stage = status_data.get('stage', 'unknown')
            progress = status_data.get('progress', 0)
            
            # 只在阶段变化时打印
            if stage != last_stage:
                print(f"   阶段：{stage} ({progress}%)")
                last_stage = stage
            
            if stage == 'completed':
                print(f"   ✅ 诊断完成")
                break
            elif stage == 'failed':
                error = status_data.get('error', '未知错误')
                print(f"   ❌ 诊断失败：{error}")
                return False
    else:
        print(f"   ⏱️ 轮询超时")
        return False
    
    # 步骤 4: 获取结果
    print("\n4. 获取结果...")
    result_response = requests.get(
        f"{BASE_URL}/test/result/{execution_id}",
        timeout=30
    )
    
    if result_response.status_code == 200:
        result_data = result_response.json()
        print(f"   ✅ 获取结果成功")
        print(f"   结果数据：{len(str(result_data))} 字节")
        
        # 验证结果结构
        if 'results' in result_data:
            print(f"   ✅ 结果包含 results 字段")
            print(f"   结果数量：{len(result_data['results'])}")
        else:
            print(f"   ⚠️  结果缺少 results 字段")
        
        return True
    else:
        print(f"   ❌ 获取结果失败：{result_response.status_code}")
        return False

if __name__ == '__main__':
    success = test_full_flow()
    
    print("\n" + "="*60)
    print("测试结论")
    print("="*60)
    if success:
        print("✅ 端到端流程测试通过")
        print("   - 前端输入正常")
        print("   - 后端处理正常")
        print("   - AI 调用正常")
        print("   - 结果返回正常")
    else:
        print("❌ 端到端流程测试失败")
        print("   请检查失败步骤")
```

---

### 3.5 第五阶段：前端页面联调测试（P1）

**测试方式**: 微信小程序开发者工具手动测试

**测试清单**:
```markdown
## 前端页面联调测试清单

### 首页测试 (pages/index)

- [ ] 品牌名称输入
- [ ] 竞品添加/删除
- [ ] AI 模型选择
- [ ] 自定义问题输入
- [ ] 启动诊断按钮点击
- [ ] 加载进度显示 (0-100%)
- [ ] 阶段提示文字
- [ ] 错误提示弹窗
- [ ] 缓存命中提示

### 结果页测试 (pages/results)

- [ ] 结果数据加载
- [ ] 评分雷达图显示
- [ ] 趋势图表显示
- [ ] 竞争分析显示
- [ ] 信源列表显示
- [ ] 返回按钮
- [ ] 重新诊断按钮
```

---

## 四、测试时间表

| 阶段 | 测试内容 | 预计时间 | 状态 |
|-----|---------|---------|------|
| **第一阶段** | 后端 API 深度测试 | 1h | ⏳ 待执行 |
| **第二阶段** | 真实 AI 调用测试 | 2h | ⏳ 待执行 |
| **第三阶段** | 端到端完整流程 | 2h | ⏳ 待执行 |
| **第四阶段** | 前端页面联调 | 1h | ⏳ 待执行 |
| **总计** | - | **6h** | - |

---

## 五、风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|-----|------|------|---------|
| AI API Key 无效 | 高 | 高 | 使用测试密钥或 Mock |
| 后端服务不稳定 | 中 | 高 | 增加健康检查 |
| 网络超时 | 中 | 中 | 增加重试机制 |
| 前端兼容性问题 | 低 | 中 | 多设备测试 |

---

## 六、成功标准

### 6.1 必须达到（P0）

- [x] 后端服务正常运行
- [x] 诊断 API 可访问
- [x] CORS 配置正确
- [ ] 真实 AI 调用成功
- [ ] 端到端流程打通

### 6.2 建议达到（P1）

- [ ] 所有后端 API 可访问
- [ ] 进度轮询正常
- [ ] 前端页面正常展示
- [ ] 错误处理完善

### 6.3 争取达到（P2）

- [ ] 缓存命中率 >30%
- [ ] 重试成功率 >80%
- [ ] 响应时间 <5 秒

---

**计划制定时间**: 2026-02-23  
**制定人**: 首席测试专家 (AI)  
**审核状态**: ⏳ 待执行  
**建议行动**: 按顺序执行各阶段测试
