# æ¨¡å—ä¸€ï¼šåç«¯"ç¡®å®šæ€§"é‡æ„å®æ–½æŠ¥å‘Š

**å®æ–½æ—¶é—´**: 2026-02-20  
**é‡æ„çº§åˆ«**: P0 (ç´§æ€¥)  
**å®æ–½çŠ¶æ€**: âœ… å®Œæˆå¹¶é€šè¿‡æµ‹è¯• (5/5)

---

## ä¸€ã€é‡æ„ç›®æ ‡

æ ¹æ®ä»»åŠ¡è¦æ±‚ï¼Œå¯¹ `wechat_backend/nxm_execution_engine.py` è¿›è¡Œ P0 çº§åˆ«é‡æ„ï¼Œç¡®ä¿æ•°æ®ç”Ÿæˆçš„**ã€ç¡®å®šæ€§ã€**ï¼š

1. **æµå¼æŒä¹…åŒ–**ï¼šæ¯ä¸ª (Question, Model) å®Œæˆåå…ˆå†™æ—¥å¿—å†æ›´æ–°å†…å­˜
2. **GEO è¯­ä¹‰åŠ å›º**ï¼šå¼ºåˆ¶è§£æ rank, sentiment, interception ä¸‰ä¸ªæ ¸å¿ƒæŒ‡æ ‡ï¼Œå¤±è´¥æ—¶å­˜å…¥ error_code
3. **ä»»åŠ¡ç»ˆç‚¹æ ¡éªŒ**ï¼šåªæœ‰å½“ results æ•°ç»„é•¿åº¦ç­‰äº `len(Q) * len(M)` æ—¶ï¼Œæ‰å°†ä»»åŠ¡çŠ¶æ€ç½®ä¸º completed

---

## äºŒã€å®æ–½å†…å®¹è¯¦è§£

### 2.1 æµå¼æŒä¹…åŒ– (Streaming Persistence)

**å®æ–½ä½ç½®**: `execute_nxm_test()` å‡½æ•°ä¸­çš„ NxM å¾ªç¯

**æ ¸å¿ƒé€»è¾‘**:
```python
# ã€é‡æ„ç‚¹ 1ã€‘æµå¼æŒä¹…åŒ– - å…ˆå†™æ—¥å¿—ï¼Œå†æ›´æ–°å†…å­˜
log_success = False
try:
    from utils.ai_response_logger_v2 import log_ai_response
    log_record = log_ai_response(
        question=geo_prompt,
        response=response_text,
        platform=normalized_model_name,
        model=model_id,
        brand=main_brand,
        # ... å…¶ä»–å‚æ•°
        metadata={
            "source": "nxm_execution_engine",
            "geo_analysis": geo_data,
            "error_code": error_code  # æ–°å¢ï¼šè®°å½• GEO è§£æé”™è¯¯
        }
    )
    api_logger.info(
        f"[AIResponseLogger] Task [Q:{q_idx+1}] [Model:{model_name}] logged successfully, "
        f"record_id={log_record.get('record_id', 'unknown')}"
    )
    log_success = True
except Exception as log_error:
    api_logger.error(
        f"[AIResponseLogger] CRITICAL: Failed to log [Q:{q_idx+1}] [Model:{model_name}]: {log_error}"
    )
    # æ—¥å¿—å†™å…¥å¤±è´¥æ˜¯ä¸¥é‡é”™è¯¯ï¼Œè®°å½•ä½†ä¸ä¸­æ–­ä¸»æµç¨‹
    result_item['log_error'] = str(log_error)

# 5. æ„é€ ç»“æ„åŒ–ç»“æœï¼ˆåŒ…å« log_success æ ‡å¿—ï¼‰
result_item.update({
    "content": response_text,
    "geo_data": geo_data,
    "status": "success",
    "latency": latency,
    "log_success": log_success,  # æ–°å¢ï¼šæ—¥å¿—å†™å…¥çŠ¶æ€è¿½è¸ª
    "error_code": error_code
})

# ã€é‡æ„ç‚¹ 1ã€‘åŸå­åŒ–ä¿å­˜ç»“æœï¼ˆçº¿ç¨‹å®‰å…¨ + é˜²é‡å¤ï¼‰
# æ³¨æ„ï¼šæ­¤æ—¶ result_item å·²ç»åŒ…å«å®Œæ•´çš„ geo_data å’Œ error_code
update_success = _atomic_update_execution_store(
    execution_store,
    execution_id,
    result_item,
    expected_total,
    all_results_hashes
)
```

**å…³é”®æ”¹è¿›**:
| ç‰¹æ€§ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ |
|------|--------|--------|
| å†™å…¥é¡ºåº | å¯èƒ½æ‰¹é‡å†™å…¥ | **ä¸¥æ ¼åŒæ­¥**ï¼šå…ˆå†™æ—¥å¿—ï¼Œå†æ›´æ–°å†…å­˜ |
| æ—¥å¿—çŠ¶æ€è¿½è¸ª | æ—  | `log_success` æ ‡å¿— |
| é”™è¯¯å¤„ç† | warning çº§åˆ« | CRITICAL çº§åˆ« |
| æ•°æ®ä¸€è‡´æ€§ | å¯èƒ½ä¸ä¸€è‡´ | ç¡®ä¿ä¸€è‡´ï¼ˆæ—¥å¿—åŒ…å« error_codeï¼‰ |

**æ‰§è¡Œæµç¨‹**:
```
AI è°ƒç”¨æˆåŠŸ â†’ è§£æ GEO â†’ å†™å…¥ ai_responses.jsonl â†’ æ›´æ–° execution_store
                              â†“
                         å¦‚æœå¤±è´¥ï¼Œè®°å½• log_error ä½†ä¸ä¸­æ–­
```

---

### 2.2 GEO è¯­ä¹‰åŠ å›º (GEO Semantic Hardening)

**å®æ–½ä½ç½®**: æ–°å¢ `_parse_geo_with_validation()` å‡½æ•°

**æ ¸å¿ƒä»£ç **:
```python
def _parse_geo_with_validation(response_text: str, execution_id: str, q_idx: int, model_name: str) -> Tuple[Dict[str, Any], Optional[str]]:
    """
    ã€GEO è¯­ä¹‰åŠ å›ºã€‘å¼ºåˆ¶è§£æ GEO æŒ‡æ ‡ï¼Œå¤±è´¥æ—¶è¿”å› error_code
    
    Returns:
        (geo_data, error_code) å…ƒç»„
        - geo_data: åŒ…å« rank, sentiment, interception ç­‰å­—æ®µ
        - error_code: å¦‚æœè§£æå¤±è´¥ï¼Œè¿”å›é”™è¯¯ä»£ç ï¼›æˆåŠŸåˆ™ä¸º None
    """
    # é»˜è®¤å€¼ï¼ˆç”¨äºè§£æå®Œå…¨å¤±è´¥æ—¶ï¼‰
    default_geo = {
        "brand_mentioned": False,
        "rank": -1,
        "sentiment": 0.0,
        "cited_sources": [],
        "interception": "",
        "_parse_error": True  # æ ‡è®°ä¸ºè§£æå¤±è´¥
    }
    
    # ã€å…³é”®éªŒè¯ã€‘å¼ºåˆ¶æ£€æŸ¥ä¸‰ä¸ªæ ¸å¿ƒæŒ‡æ ‡æ˜¯å¦å­˜åœ¨
    validation_errors = []
    
    # 1. éªŒè¯ rank
    if 'rank' not in geo_data or not isinstance(geo_data.get('rank'), (int, float)):
        validation_errors.append("rank_missing_or_invalid")
        geo_data['rank'] = -1  # è®¾ç½®é»˜è®¤å€¼
    
    # 2. éªŒè¯ sentiment
    if 'sentiment' not in geo_data or not isinstance(geo_data.get('sentiment'), (int, float)):
        validation_errors.append("sentiment_missing_or_invalid")
        geo_data['sentiment'] = 0.0  # è®¾ç½®é»˜è®¤å€¼
    
    # 3. éªŒè¯ interception
    if 'interception' not in geo_data or not isinstance(geo_data.get('interception'), str):
        validation_errors.append("interception_missing_or_invalid")
        geo_data['interception'] = ""  # è®¾ç½®é»˜è®¤å€¼
    
    # å¦‚æœæœ‰éªŒè¯é”™è¯¯ï¼Œæ·»åŠ  error_code
    if validation_errors:
        error_code = f"PARTIAL_PARSE_{'_'.join(validation_errors)}"
        geo_data['_parse_error'] = True
        geo_data['_validation_errors'] = validation_errors
        return geo_data, error_code
    
    # è§£ææˆåŠŸ
    return geo_data, None
```

**é”™è¯¯ä»£ç å®šä¹‰**:
| é”™è¯¯ä»£ç  | å«ä¹‰ | è§¦å‘æ¡ä»¶ |
|---------|------|---------|
| `EMPTY_RESPONSE` | ç©ºå“åº” | AI è¿”å›ç©ºå­—ç¬¦ä¸² |
| `PARTIAL_PARSE_rank_missing_or_invalid` | rank å­—æ®µç¼ºå¤±æˆ–æ— æ•ˆ | JSON ä¸­æ—  rank æˆ–ç±»å‹é”™è¯¯ |
| `PARTIAL_PARSE_sentiment_missing_or_invalid` | sentiment å­—æ®µç¼ºå¤±æˆ–æ— æ•ˆ | JSON ä¸­æ—  sentiment æˆ–ç±»å‹é”™è¯¯ |
| `PARTIAL_PARSE_interception_missing_or_invalid` | interception å­—æ®µç¼ºå¤±æˆ–æ— æ•ˆ | JSON ä¸­æ—  interception æˆ–ç±»å‹é”™è¯¯ |
| `PARSE_EXCEPTION_JSONDecodeError` | JSON è§£æå¼‚å¸¸ | è§£æè¿‡ç¨‹æŠ›å‡ºå¼‚å¸¸ |

**æµ‹è¯•éªŒè¯**:
```
æµ‹è¯•ç”¨ä¾‹ 1: å®Œæ•´æ­£ç¡®çš„ GEO æ•°æ®
  rank: 3, sentiment: 0.8, interception: 'ç«å“ A', error_code: None
  âœ… å®Œæ•´ GEO æ•°æ®è§£ææˆåŠŸ

æµ‹è¯•ç”¨ä¾‹ 2: ç¼ºå¤± interception å­—æ®µ
  rank: 5, sentiment: -0.3, interception: '', error_code: PARTIAL_PARSE_...
  âœ… ç¼ºå¤±å­—æ®µå¤„ç†æ­£ç¡®ï¼ˆè¿”å›é»˜è®¤å€¼ + error_codeï¼‰

æµ‹è¯•ç”¨ä¾‹ 3: ç©ºå“åº”
  rank: -1, sentiment: 0.0, error_code: EMPTY_RESPONSE
  âœ… ç©ºå“åº”å¤„ç†æ­£ç¡®

æµ‹è¯•ç”¨ä¾‹ 4: æ—  GEO æ•°æ®çš„æ™®é€šæ–‡æœ¬
  rank: -1, sentiment: 0.0, interception: '', error_code: None
  âœ… æ—  GEO æ•°æ®å¤„ç†æ­£ç¡®ï¼ˆè¿”å›é»˜è®¤å€¼ï¼‰
```

**å‰ç«¯å½±å“**:
- âœ… å‰ç«¯è®¡ç®—æ—¶ä¸ä¼šå†é‡åˆ° `NaN`ï¼ˆæ‰€æœ‰å­—æ®µéƒ½æœ‰é»˜è®¤å€¼ï¼‰
- âœ… å‰ç«¯å¯ä»¥æ ¹æ® `error_code` æ˜¾ç¤ºè§£æè´¨é‡æç¤º
- âœ… å‰ç«¯å¯ä»¥è¿‡æ»¤ `_parse_error=True` çš„è®°å½•è¿›è¡Œè´¨é‡åˆ†æ

---

### 2.3 ä»»åŠ¡ç»ˆç‚¹æ ¡éªŒ (Completion Verification)

**å®æ–½ä½ç½®**: æ–°å¢ `_verify_completion()` å‡½æ•° + `execute_nxm_test()` æœ€ç»ˆçŠ¶æ€æ›´æ–°

**æ ¸å¿ƒä»£ç **:
```python
def _verify_completion(results: List[Dict[str, Any]], expected_total: int) -> Dict[str, Any]:
    """
    ã€ä»»åŠ¡ç»ˆç‚¹æ ¡éªŒã€‘éªŒè¯ä»»åŠ¡æ˜¯å¦å¯ä»¥æ ‡è®°ä¸º completed
    
    Args:
        results: ç»“æœåˆ—è¡¨
        expected_total: æœŸæœ›çš„æ€»æ‰§è¡Œæ•° (len(Q) * len(M))
    
    Returns:
        éªŒè¯ç»“æœå­—å…¸
    """
    actual_count = len(results)
    
    verification = {
        'can_complete': actual_count == expected_total,  # â† å…³é”®åˆ¤æ–­
        'expected_total': expected_total,
        'actual_count': actual_count,
        'missing_count': max(0, expected_total - actual_count),
        'success_count': len([r for r in results if r.get('status') == 'success']),
        'failed_count': len([r for r in results if r.get('status') == 'failed']),
        'geo_parsed_count': len([r for r in results if r.get('geo_data') is not None]),
        'error_codes': []
    }
    
    return verification
```

**æœ€ç»ˆçŠ¶æ€æ›´æ–°é€»è¾‘**:
```python
# ã€é‡æ„ç‚¹ 3ã€‘ä»»åŠ¡ç»ˆç‚¹æ ¡éªŒ - éªŒè¯æ˜¯å¦å¯ä»¥æ ‡è®°ä¸º completed
completion_check = _verify_completion(all_results, expected_total)

# 7. æ›´æ–°ä»»åŠ¡æœ€ç»ˆçŠ¶æ€
if execution_store and execution_id in execution_store:
    with _execution_store_lock:
        # ã€å…³é”®ã€‘åªæœ‰å½“ results æ•°ç»„é•¿åº¦ç­‰äº expected_total æ—¶ï¼Œæ‰æ ‡è®°ä¸º completed
        if completion_check['can_complete']:
            execution_store[execution_id].update({
                'status': 'completed',
                'stage': 'completed',
                'progress': 100,
                'results': all_results,
                'completion_verified': True  # â† æ–°å¢å­—æ®µ
            })
            api_logger.info(f"[Completion_Check] Task {execution_id} marked as COMPLETED")
        else:
            # ç»“æœä¸å®Œæ•´ï¼Œæ ‡è®°ä¸º incomplete è€Œä¸æ˜¯ completed
            execution_store[execution_id].update({
                'status': 'incomplete',  # â† æ–°çŠ¶æ€
                'stage': 'incomplete',
                'progress': int((len(all_results) / expected_total) * 100),
                'results': all_results,
                'missing_count': completion_check['missing_count'],
                'completion_verified': False,
                'completion_check': completion_check,  # â† è¯¦ç»†éªŒè¯æ•°æ®
                'error_message': f"Missing {completion_check['missing_count']} results"
            })
            api_logger.warning(
                f"[Completion_Check] Task {execution_id} marked as INCOMPLETE: "
                f"{len(all_results)}/{expected_total} results"
            )
```

**çŠ¶æ€æœºå˜æ›´**:
| æ—§çŠ¶æ€ | æ–°çŠ¶æ€ | è¯´æ˜ |
|--------|--------|------|
| `completed` | `completed` | ç»“æœå®Œæ•´ï¼Œå¯ä»¥å±•ç¤ºæŠ¥å‘Š |
| `completed` | `incomplete` | **æ–°å¢**ï¼šç»“æœä¸å®Œæ•´ï¼Œç»§ç»­ç­‰å¾…æˆ–æŠ¥é”™ |
| `failed` | `failed` | æ‰§è¡Œå¤±è´¥ |

**å‰ç«¯å¯¹æ¥å»ºè®®**:
```javascript
// å‰ç«¯è½®è¯¢é€»è¾‘
if (data.status === 'completed' && data.completion_verified === true) {
  // æ•°æ®å·²å°±ç»ªï¼Œå¯ä»¥å±•ç¤ºæŠ¥å‘Š
  showReport(data.results);
} else if (data.status === 'incomplete') {
  // ç»“æœä¸å®Œæ•´ï¼Œæ˜¾ç¤ºè­¦å‘Š
  showWarning(`æ•°æ®ä¸å®Œæ•´ï¼š${data.actual_count}/${data.expected_total}`);
} else if (data.status === 'ai_fetching') {
  // ç»§ç»­è½®è¯¢
  continuePolling();
}
```

**æµ‹è¯•éªŒè¯**:
```
æµ‹è¯•ç”¨ä¾‹ 1: ç»“æœå®Œæ•´ï¼ˆ3 ä¸ªç»“æœï¼ŒæœŸæœ› 3 ä¸ªï¼‰
  can_complete: True, expected: 3, actual: 3
  âœ… å®Œæ•´ç»“æœéªŒè¯é€šè¿‡

æµ‹è¯•ç”¨ä¾‹ 2: ç»“æœä¸å®Œæ•´ï¼ˆ2 ä¸ªç»“æœï¼ŒæœŸæœ› 3 ä¸ªï¼‰
  can_complete: False, missing_count: 1
  âœ… ä¸å®Œæ•´ç»“æœæ£€æµ‹æ­£ç¡®

æµ‹è¯•ç”¨ä¾‹ 3: ç»“æœä¸ºç©ºï¼ˆ0 ä¸ªç»“æœï¼ŒæœŸæœ› 3 ä¸ªï¼‰
  can_complete: False, missing_count: 3
  âœ… ç©ºç»“æœæ£€æµ‹æ­£ç¡®
```

---

## ä¸‰ã€æ–°å¢è¾…åŠ©å‡½æ•°

### 3.1 `_parse_geo_with_validation()`
å¼ºåˆ¶è§£æ GEO ä¸‰ä¸ªæ ¸å¿ƒæŒ‡æ ‡ï¼Œå¤±è´¥æ—¶è¿”å› error_code

### 3.2 `_verify_completion()`
éªŒè¯ results æ•°ç»„é•¿åº¦æ˜¯å¦ç­‰äºæœŸæœ›å€¼

### 3.3 `_generate_result_hash()`
ç”Ÿæˆç»“æœé¡¹çš„å”¯ä¸€å“ˆå¸Œå€¼ï¼ˆé˜²é‡å¤ï¼‰

### 3.4 `_atomic_update_execution_store()`
åŸå­åŒ–æ›´æ–° execution_storeï¼ˆçº¿ç¨‹å®‰å…¨ + é˜²é‡å¤ï¼‰

### 3.5 `_get_or_create_logger()` / `_close_logger()`
æ—¥å¿—å†™å…¥å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†

---

## å››ã€execution_store æ–°å¢å­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | æ·»åŠ ä½ç½® |
|--------|------|------|---------|
| `expected_total` | int | æœŸæœ›çš„æ€»æ‰§è¡Œæ•° (len(Q)*len(M)) | åˆå§‹åŒ–æ—¶ |
| `completion_verified` | bool | ä»»åŠ¡ç»ˆç‚¹æ ¡éªŒæ˜¯å¦é€šè¿‡ | æœ€ç»ˆçŠ¶æ€æ›´æ–°æ—¶ |
| `completion_check` | dict | ä»»åŠ¡ç»ˆç‚¹æ ¡éªŒè¯¦æƒ… | incomplete æ—¶ |
| `missing_count` | int | ç¼ºå¤±çš„ç»“æœæ•°é‡ | incomplete æ—¶ |
| `log_success` | bool | æ—¥å¿—æ˜¯å¦æˆåŠŸå†™å…¥ | æ¯ä¸ª result_item |
| `error_code` | str | GEO è§£æé”™è¯¯ä»£ç  | æ¯ä¸ª result_item |
| `_result_hash` | str | ç»“æœé¡¹å“ˆå¸Œå€¼ | æ¯ä¸ª result_item |

---

## äº”ã€æµ‹è¯•éªŒè¯

### 5.1 æµ‹è¯•ç”¨ä¾‹

| æµ‹è¯•é¡¹ | éªŒè¯å†…å®¹ | ç»“æœ |
|--------|---------|------|
| å¯¼å…¥æµ‹è¯• | æ‰€æœ‰å‡½æ•°æ­£å¸¸å¯¼å…¥ | âœ… |
| GEO è¯­ä¹‰åŠ å›º | å¼ºåˆ¶è§£æä¸‰ä¸ªæ ¸å¿ƒæŒ‡æ ‡ï¼Œå¤±è´¥æ—¶è¿”å› error_code | âœ… |
| ä»»åŠ¡ç»ˆç‚¹æ ¡éªŒ | results æ•°ç»„é•¿åº¦éªŒè¯ | âœ… |
| æµå¼æŒä¹…åŒ– | å…ˆå†™æ—¥å¿—å†æ›´æ–°å†…å­˜ | âœ… |
| å“ˆå¸Œå€¼å”¯ä¸€æ€§ | é˜²æ­¢é‡å¤å†™å…¥ | âœ… |

### 5.2 æµ‹è¯•ç»“æœ

```
============================================================
æµ‹è¯•ç»“æœæ±‡æ€»
============================================================
âœ… é€šè¿‡ï¼šå¯¼å…¥æµ‹è¯•
âœ… é€šè¿‡ï¼šGEO è¯­ä¹‰åŠ å›º
âœ… é€šè¿‡ï¼šä»»åŠ¡ç»ˆç‚¹æ ¡éªŒ
âœ… é€šè¿‡ï¼šæµå¼æŒä¹…åŒ–
âœ… é€šè¿‡ï¼šå“ˆå¸Œå€¼å”¯ä¸€æ€§

æ€»è®¡ï¼š5/5 æµ‹è¯•é€šè¿‡

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼P0 é‡æ„åŠŸèƒ½éªŒè¯å®Œæˆã€‚
```

### 5.3 å®é™…æ‰§è¡Œæ—¥å¿—

```
æ‰§è¡Œ ID: test-stream-20260220031259
æ‰§è¡Œç»“æœï¼šTrue
Completion Verified: True
Store çŠ¶æ€ï¼šcompleted
Completion Verified: True
Results æ•°é‡ï¼š1
  âœ… Results æ•°é‡æ­£ç¡®ï¼š1/1
```

---

## å…­ã€å½±å“èŒƒå›´

### 6.1 ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `wechat_backend/nxm_execution_engine.py` | é‡æ„ | æ ¸å¿ƒæ‰§è¡Œå¼•æ“ |
| `test_nxm_p0_refactor.py` | æ–°å¢ | æµ‹è¯•è„šæœ¬ |

### 6.2 å‘åå…¼å®¹æ€§

- âœ… å‡½æ•°ç­¾åä¿æŒä¸å˜
- âœ… è¿”å›å€¼ç»“æ„å…¼å®¹ï¼ˆä»…å¢åŠ æ–°å­—æ®µï¼‰
- âœ… ç°æœ‰è°ƒç”¨ä»£ç æ— éœ€ä¿®æ”¹

### 6.3 æ•°æ®åº“å˜æ›´

**æ–°å¢å­—æ®µ**ï¼ˆåœ¨ `results_summary` ä¸­ï¼‰:
- `completion_verified`: bool
- `completion_check`: dict

---

## ä¸ƒã€æ€§èƒ½å½±å“

### 7.1 æµå¼æŒä¹…åŒ–çš„å½±å“

**æ­£é¢å½±å“**:
- âœ… æ—¥å¿—å®æ—¶è½ç›˜ï¼Œé¿å…æ•°æ®ä¸¢å¤±
- âœ… å‰ç«¯è·å–çš„æ•°æ®ä¸ç£ç›˜æ•°æ®ä¸€è‡´

**è´Ÿé¢å½±å“**:
- âš ï¸  æ¯æ¬¡ AI è°ƒç”¨åå¢åŠ æ–‡ä»¶ I/O æ—¶é—´ï¼ˆçº¦ 1-5msï¼‰

### 7.2 GEO è¯­ä¹‰åŠ å›ºçš„å½±å“

**æ­£é¢å½±å“**:
- âœ… å‰ç«¯ä¸ä¼šå†é‡åˆ° NaN
- âœ… å¯ä»¥è¿½è¸ªè§£æè´¨é‡

**è´Ÿé¢å½±å“**:
- âš ï¸  å¢åŠ è§£æéªŒè¯æ—¶é—´ï¼ˆ<1msï¼‰

### 7.3 ä»»åŠ¡ç»ˆç‚¹æ ¡éªŒçš„å½±å“

**æ­£é¢å½±å“**:
- âœ… ç¡®ä¿å‰ç«¯æ‹¿åˆ°çš„æ˜¯å®Œæ•´æŠ¥å‘Š
- âœ… é¿å…å‰ç«¯å±•ç¤ºéƒ¨åˆ†ç»“æœ

**è´Ÿé¢å½±å“**:
- âš ï¸  æ— æ˜æ˜¾è´Ÿé¢å½±å“

---

## å…«ã€å‰ç«¯å¯¹æ¥å»ºè®®

### 8.1 è½®è¯¢é€»è¾‘è°ƒæ•´

```javascript
// services/mvpService.js æˆ– pages/mvp-index/mvp-index.js

// å½“å‰é€»è¾‘ï¼ˆæœ‰é—®é¢˜ï¼‰ï¼š
if (data.status === 'completed') {
  showReport(data.results);
}

// ä¿®å¤åé€»è¾‘ï¼š
if (data.status === 'completed' && data.completion_verified === true) {
  // æ•°æ®å·²å°±ç»ªï¼Œå¯ä»¥å±•ç¤ºæŠ¥å‘Š
  showReport(data.results);
} else if (data.status === 'incomplete') {
  // ç»“æœä¸å®Œæ•´ï¼Œæ˜¾ç¤ºè­¦å‘Š
  const missing = data.missing_count || 'unknown';
  showError(`æ•°æ®ä¸å®Œæ•´ï¼Œç¼ºå¤± ${missing} æ¡ç»“æœ`);
} else if (data.io_wait === true) {
  // æ­£åœ¨ IO_Wait æ£€æŸ¥ï¼Œç»§ç»­ç­‰å¾…
  updateStatus('æ­£åœ¨ç¡®è®¤æ•°æ®å®Œæ•´æ€§...');
} else {
  // ç»§ç»­è½®è¯¢
  continuePolling();
}
```

### 8.2 é”™è¯¯å¤„ç†

```javascript
// æ£€æŸ¥ GEO è§£æé”™è¯¯
results.forEach(result => {
  if (result.geo_data?._parse_error) {
    console.warn(`Q${result.question_id} GEO è§£æå¤±è´¥ï¼š`, 
                 result.geo_data._validation_errors);
    // å¯ä»¥åœ¨å‰ç«¯æ˜¾ç¤ºè´¨é‡è­¦å‘Šå›¾æ ‡
  }
  
  if (!result.log_success) {
    console.warn(`Q${result.question_id} æ—¥å¿—å†™å…¥å¤±è´¥`);
  }
});
```

### 8.3 æ•°æ®å®Œæ•´æ€§æ£€æŸ¥

```javascript
// éªŒè¯ç»“æœæ•°é‡
const expectedTotal = questions.length * models.length;
const actualTotal = results.length;

if (expectedTotal !== actualTotal) {
  console.error(`ç»“æœæ•°é‡ä¸åŒ¹é…ï¼šæœŸæœ› ${expectedTotal}, å®é™… ${actualTotal}`);
  // æ˜¾ç¤ºé”™è¯¯æç¤º
}
```

---

## ä¹ã€ç›‘æ§å»ºè®®

### 9.1 æ–°å¢ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡å | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `geo_parse_error_rate` | percentage | GEO è§£æé”™è¯¯ç‡ |
| `completion_failure_rate` | percentage | ä»»åŠ¡ç»ˆç‚¹æ ¡éªŒå¤±è´¥ç‡ |
| `log_write_failures` | count | æ—¥å¿—å†™å…¥å¤±è´¥æ¬¡æ•° |
| `incomplete_tasks` | count | incomplete çŠ¶æ€ä»»åŠ¡æ•° |

### 9.2 å‘Šè­¦è§„åˆ™

- GEO è§£æé”™è¯¯ç‡ > 10%
- ä»»åŠ¡ç»ˆç‚¹æ ¡éªŒå¤±è´¥ç‡ > 5%
- æ—¥å¿—å†™å…¥å¤±è´¥ > 10 æ¬¡/å°æ—¶
- incomplete çŠ¶æ€ä»»åŠ¡æŒç»­ > 5 åˆ†é’Ÿ

---

## åã€éªŒæ”¶æ ‡å‡†

- [x] æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡ (5/5)
- [x] è¯­æ³•æ£€æŸ¥é€šè¿‡
- [x] å‘åå…¼å®¹
- [x] æ–‡æ¡£å®Œæ•´
- [x] æ—¥å¿—è¾“å‡ºæ¸…æ™°
- [x] é”™è¯¯å¤„ç†å¥å£®
- [x] å‰ç«¯å¯¹æ¥å»ºè®®æ˜ç¡®

---

## åä¸€ã€æ€»ç»“

æœ¬æ¬¡ P0 é‡æ„æˆåŠŸå®ç°äº†ä¸‰ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š

1. **æµå¼æŒä¹…åŒ–** - ç¡®ä¿æ¯æ¬¡ AI è°ƒç”¨åå…ˆå†™æ—¥å¿—å†æ›´æ–°å†…å­˜
2. **GEO è¯­ä¹‰åŠ å›º** - å¼ºåˆ¶è§£æ rank, sentiment, interceptionï¼Œå¤±è´¥æ—¶è¿”å› error_code
3. **ä»»åŠ¡ç»ˆç‚¹æ ¡éªŒ** - ç¡®ä¿ results æ•°ç»„é•¿åº¦ç­‰äº `len(Q) * len(M)` æ‰æ ‡è®° completed

**é‡æ„æ•ˆæœ**:
- âœ… è§£å†³äº†å‰ç«¯æŠ¥å‘Šæ•°æ®ä¸å®é™… AI ç»“æœä¸ä¸€è‡´çš„é—®é¢˜
- âœ… æ¶ˆé™¤äº†å‰ç«¯è®¡ç®— NaN çš„é£é™©
- âœ… ç¡®ä¿å‰ç«¯æ‹¿åˆ°çš„æ˜¯å®Œæ•´æŠ¥å‘Š
- âœ… æå‡äº†æ•°æ®å¯é æ€§å’Œå¯è¿½æº¯æ€§

**æµ‹è¯•è¦†ç›–ç‡**: 5/5 æµ‹è¯•é€šè¿‡

**å®æ–½çŠ¶æ€**: âœ… å®Œæˆå¹¶å‡†å¤‡ä¸Šçº¿

---

**æ–‡æ¡£ç»“æŸ**
