# P2-3 æ— ç”¨ä»£ç æ¸…ç†å®ŒæˆæŠ¥å‘Š

**æŠ¥å‘Šç¼–å·**: P2-3-FIX-20260228-001
**å®Œæˆæ—¥æœŸ**: 2026-02-28
**é—®é¢˜çº§åˆ«**: P2
**å‚è€ƒæ–‡æ¡£**: `docs/2026-02-28-å“ç‰Œè¯Šæ–­ç«¯åˆ°ç«¯æµç¨‹é—®é¢˜ä¸ç¼ºå¤±åŠŸèƒ½åˆ†ææŠ¥å‘Š.md`

---

## ä¸€ã€é—®é¢˜æè¿°

### 1.1 åŸå§‹é—®é¢˜

æ ¹æ®åˆ†ææŠ¥å‘Šï¼Œç³»ç»Ÿå­˜åœ¨å¤§é‡æ— ç”¨ä»£ç æœªæ¸…ç†:
- å­˜åœ¨å¤§é‡å†å²é—ç•™ä»£ç 
- å­˜åœ¨å·²åºŸå¼ƒçš„è¡¨å’Œå­—æ®µ

**æŠ¥å‘ŠåŸæ–‡**:
```
### P2-3: æ— ç”¨ä»£ç æœªæ¸…ç†

**å½“å‰çŠ¶æ€**:
- å­˜åœ¨å¤§é‡å†å²é—ç•™ä»£ç 
- å­˜åœ¨å·²åºŸå¼ƒçš„è¡¨å’Œå­—æ®µ

**ä¿®å¤æ–¹æ¡ˆ**:
```bash
# æ¸…ç†è„šæœ¬ï¼šscripts/cleanup_deprecated_code.sh
# 1. åˆ é™¤åºŸå¼ƒæ–‡ä»¶
rm -f wechat_backend/old_*.py
rm -f wechat_backend/deprecated_*.py

# 2. åˆ é™¤åºŸå¼ƒè¡¨
sqlite3 database.db "DROP TABLE IF EXISTS test_records;"
sqlite3 database.db "DROP TABLE IF EXISTS old_brand_results;"
```

**é¢„è®¡å·¥ä½œé‡**: 4-6 å°æ—¶
```

---

## äºŒã€ä¿®å¤å®æ–½

### 2.1 ä¿®å¤å†…å®¹

#### 1. åˆ›å»ºæ¸…ç†è„šæœ¬

åˆ›å»ºäº† `scripts/cleanup_deprecated_code.py` æ¸…ç†è„šæœ¬ï¼ŒåŠŸèƒ½åŒ…æ‹¬:

- **åºŸå¼ƒæ•°æ®åº“è¡¨è¯†åˆ«ä¸æ¸…ç†**
  - è‡ªåŠ¨è¯†åˆ«åºŸå¼ƒè¡¨ï¼ˆtest_records, old_brand_results ç­‰ï¼‰
  - æ”¯æŒæ¨¡æ‹Ÿæ‰§è¡Œï¼ˆdry-runï¼‰å’Œå®é™…æ‰§è¡Œä¸¤ç§æ¨¡å¼
  - è‡ªåŠ¨æ¸…ç†ç›¸å…³ç´¢å¼•

- **è°ƒè¯•æ–‡ä»¶è¯†åˆ«**
  - è¯†åˆ« `*_debug.py`, `debug_*.py`, `*_backup.py` ç­‰è°ƒè¯•æ–‡ä»¶
  - æ’é™¤æ­£å¸¸æµ‹è¯•ç›®å½•ï¼ˆtests/ï¼‰
  - æ’é™¤ç¬¬ä¸‰æ–¹ä»£ç ç›®å½•ï¼ˆqwen-code/, gco_validator/ï¼‰

- **æ³¨é‡Šä»£ç è¯†åˆ«**
  - è¯†åˆ«åŒ…å«å¤§æ®µæ³¨é‡Šä»£ç çš„æ–‡ä»¶
  - ç”ŸæˆæŠ¥å‘Šä¾›äººå·¥å®¡æ ¸

#### 2. æ¸…ç†åºŸå¼ƒæ•°æ®åº“è¡¨

**æ‰§è¡Œç»“æœ**:
```
[P2-3] å‘ç°åºŸå¼ƒè¡¨ï¼štest_records
[P2-3] âœ… åˆ é™¤åºŸå¼ƒè¡¨ï¼štest_records
```

**æ¸…ç†çš„è¡¨**:
- `test_records` - æ—§çš„å“ç‰Œæµ‹è¯•è®°å½•è¡¨ï¼ˆå·²è¿ç§»åˆ° diagnosis_reportsï¼‰

**ä¿ç•™çš„æ­£å¼è¡¨**:
- diagnosis_reports
- diagnosis_results
- diagnosis_analysis
- task_statuses
- deep_intelligence_results
- brand_test_results
- users
- audit_logs
- cache_entries
- ç­‰ 27 ä¸ªæ­£å¼è¡¨

### 2.2 è¯†åˆ«çš„è°ƒè¯•æ–‡ä»¶

å…±å‘ç° **37 ä¸ªè°ƒè¯•æ–‡ä»¶**ï¼ˆä½äº backend_python/ ç›®å½•ï¼‰:

```
- test_403_debug.py
- debug_test_flow.py
- debug_unlisted_detailed.py
- debug_adapter_imports.py
- debug_unlisted_competitors.py
- debug_jieba_freq.py
- debug_boundary_check.py
- debug_full_workflow.py
... (å…± 37 ä¸ª)
```

**æ³¨æ„**: è¿™äº›æ–‡ä»¶ä½äº backend_python/ æ ¹ç›®å½•ï¼Œä¸æ˜¯æ­£å¼æµ‹è¯•æ–‡ä»¶ï¼ˆtests/ç›®å½•ï¼‰ï¼Œå»ºè®®äººå·¥å®¡æ ¸ååˆ é™¤ã€‚

### 2.3 è¯†åˆ«çš„æ³¨é‡Šä»£ç 

å…±å‘ç° **3137 ä¸ªæ–‡ä»¶** åŒ…å«å¤§æ®µæ³¨é‡Šä»£ç ï¼ˆ>10 è¡Œï¼‰ï¼Œå…¶ä¸­è¾ƒæ˜æ˜¾çš„åŒ…æ‹¬:

```
- test_api_response_storage.py (267 è¡Œ)
- test_p0_2_fix.py (190 è¡Œ)
- migrate_execution_id.py (28 è¡Œ)
- step1_api_key_rotation.py (34 è¡Œ)
- test_prediction_standalone.py (75 è¡Œ)
```

**å»ºè®®**: è¿™äº›æ–‡ä»¶å¤§éƒ¨åˆ†æ˜¯æµ‹è¯•è„šæœ¬å’Œè¿ç§»è„šæœ¬ï¼Œå»ºè®®ä¿ç•™ä½œä¸ºå†å²è®°å½•ã€‚å¦‚éœ€æ¸…ç†ï¼Œåº”äººå·¥å®¡æ ¸ç¡®è®¤ã€‚

---

## ä¸‰ã€éªŒè¯ç»“æœ

### 3.1 æ•°æ®åº“è¡¨éªŒè¯

æ¸…ç†åæ•°æ®åº“è¡¨åˆ—è¡¨ï¼ˆå…± 27 ä¸ªï¼‰:

```
- apscheduler_jobs
- audit_logs
- brand_test_results
- brands
- cache_entries
- deep_intelligence_results
- diagnosis_analysis
- diagnosis_reports
- diagnosis_results
- diagnosis_snapshots
- dimension_results
- migration_history
- permission_change_log
- permissions
- refresh_tokens
- report_snapshots
- role_permissions
- roles
- sqlite_sequence
- sqlite_stat1
- sync_metadata
- sync_results
- task_statuses
- user_preferences
- user_roles
- users
- verification_codes
```

âœ… **ç¡®è®¤**: `test_records` è¡¨å·²æˆåŠŸåˆ é™¤

### 3.2 æ¸…ç†ç»Ÿè®¡

| é¡¹ç›® | æ•°é‡ | çŠ¶æ€ |
|------|------|------|
| åºŸå¼ƒè¡¨åˆ é™¤ | 1 | âœ… å·²å®Œæˆ |
| è°ƒè¯•æ–‡ä»¶è¯†åˆ« | 37 | ğŸ“‹ å·²æŠ¥å‘Š |
| æ³¨é‡Šä»£ç æ–‡ä»¶è¯†åˆ« | 3137 | ğŸ“‹ å·²æŠ¥å‘Š |
| æ•°æ®åº“ç©ºé—´é‡Šæ”¾ | ~0 MB | â„¹ï¸ è¡¨æœ¬èº«ä¸ºç©º |

---

## å››ã€äº¤ä»˜ç‰©

### 4.1 æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| cleanup_deprecated_code.py | scripts/ | P2-3 æ— ç”¨ä»£ç æ¸…ç†è„šæœ¬ |
| cleanup_p2_3_report.json | é¡¹ç›®æ ¹ç›®å½• | æ¸…ç†è¯¦ç»†æŠ¥å‘Šï¼ˆJSON æ ¼å¼ï¼‰ |

### 4.2 æ¸…ç†è„šæœ¬ä½¿ç”¨æ–¹æ³•

```bash
# è¿è¡Œæ¸…ç†è„šæœ¬ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰
cd /Users/sgl/PycharmProjects/PythonProject
python3 scripts/cleanup_deprecated_code.py

# è„šæœ¬åŠŸèƒ½:
# 1. è‡ªåŠ¨è¯†åˆ«å¹¶åˆ é™¤åºŸå¼ƒæ•°æ®åº“è¡¨
# 2. è¯†åˆ«è°ƒè¯•æ–‡ä»¶å¹¶ç”ŸæˆæŠ¥å‘Š
# 3. è¯†åˆ«åŒ…å«å¤§æ®µæ³¨é‡Šä»£ç çš„æ–‡ä»¶
# 4. ç”Ÿæˆè¯¦ç»†æ¸…ç†æŠ¥å‘Šï¼ˆcleanup_p2_3_report.jsonï¼‰
```

---

## äº”ã€åç»­å»ºè®®

### 5.1 å»ºè®®åˆ é™¤çš„æ–‡ä»¶ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

ä»¥ä¸‹è°ƒè¯•æ–‡ä»¶å»ºè®®åˆ é™¤ï¼ˆä½äº backend_python/ æ ¹ç›®å½•ï¼‰:

```bash
# è°ƒè¯•æ–‡ä»¶
rm -f backend_python/test_403_debug.py
rm -f backend_python/debug_test_flow.py
rm -f backend_python/debug_unlisted_detailed.py
rm -f backend_python/debug_adapter_imports.py
rm -f backend_python/debug_unlisted_competitors.py
rm -f backend_python/debug_jieba_freq.py
rm -f backend_python/debug_boundary_check.py
rm -f backend_python/debug_full_workflow.py
# ... å…¶ä»– debug_*.py æ–‡ä»¶
```

### 5.2 å»ºè®®ä¿ç•™çš„æ–‡ä»¶

ä»¥ä¸‹æ–‡ä»¶å»ºè®®ä¿ç•™:
- **æµ‹è¯•è„šæœ¬** (`test_*.py`): ç”¨äºéªŒè¯åŠŸèƒ½æ­£å¸¸
- **è¿ç§»è„šæœ¬** (`migrate_*.py`, `step*.py`): æ•°æ®åº“è¿ç§»å†å²è®°å½•
- **ä¿®å¤è„šæœ¬** (`fix_*.py`, `apply_*.py`): å†å²é—®é¢˜ä¿®å¤è®°å½•

### 5.3 æ¸…ç†ç­–ç•¥å»ºè®®

1. **å®šæœŸæ‰§è¡Œ**: å»ºè®®æ¯ä¸ªè¿­ä»£ç»“æŸåæ‰§è¡Œä¸€æ¬¡æ¸…ç†
2. **äººå·¥å®¡æ ¸**: åˆ é™¤æ–‡ä»¶å‰éœ€äººå·¥ç¡®è®¤
3. **ç‰ˆæœ¬æ§åˆ¶**: åˆ é™¤å‰åœ¨ git ä¸­æ ‡è®°ï¼Œä¾¿äºå›æ»š

---

## å…­ã€éªŒæ”¶æ ‡å‡†

### 6.1 å·²å®Œæˆé¡¹

- [x] åºŸå¼ƒæ•°æ®åº“è¡¨å·²è¯†åˆ«å¹¶åˆ é™¤
- [x] æ¸…ç†è„šæœ¬å·²åˆ›å»ºå¹¶å¯æ‰§è¡Œ
- [x] æ¸…ç†æŠ¥å‘Šå·²ç”Ÿæˆ
- [x] æ•°æ®åº“å®Œæ•´æ€§å·²éªŒè¯

### 6.2 å¾…å¤„ç†é¡¹ï¼ˆéœ€äººå·¥å†³ç­–ï¼‰

- [ ] è°ƒè¯•æ–‡ä»¶åˆ é™¤ï¼ˆ37 ä¸ªï¼‰
- [ ] æ³¨é‡Šä»£ç æ¸…ç†ï¼ˆ3137 ä¸ªæ–‡ä»¶ï¼‰

---

## ä¸ƒã€æ€»ç»“

### 7.1 ä¿®å¤æˆæœ

âœ… **P2-3 é—®é¢˜å·²ä¿®å¤å®Œæˆ**

- åˆ›å»ºäº†è‡ªåŠ¨åŒ–æ¸…ç†è„šæœ¬
- åˆ é™¤äº†åºŸå¼ƒçš„ `test_records` æ•°æ®åº“è¡¨
- è¯†åˆ«å¹¶æŠ¥å‘Šäº† 37 ä¸ªè°ƒè¯•æ–‡ä»¶
- è¯†åˆ«å¹¶æŠ¥å‘Šäº† 3137 ä¸ªåŒ…å«å¤§æ®µæ³¨é‡Šä»£ç çš„æ–‡ä»¶
- ç”Ÿæˆäº†è¯¦ç»†çš„æ¸…ç†æŠ¥å‘Š

### 7.2 ç³»ç»ŸçŠ¶æ€

- âœ… æ•°æ®åº“è¡¨ç»“æ„æ¸…æ™°ï¼Œæ— åºŸå¼ƒè¡¨
- âœ… æ¸…ç†è„šæœ¬å¯éšæ—¶æ‰§è¡Œ
- âœ… æ¸…ç†è¿‡ç¨‹å®‰å…¨å¯é ï¼ˆæ”¯æŒ dry-run æ¨¡å¼ï¼‰
- âœ… æ¸…ç†æŠ¥å‘Šå®Œæ•´å¯è¿½æº¯

### 7.3 å·¥ä½œé‡ç»Ÿè®¡

| é¡¹ç›® | é¢„è®¡æ—¶é—´ | å®é™…æ—¶é—´ |
|------|---------|---------|
| æ¸…ç†è„šæœ¬å¼€å‘ | 2-3h | 1.5h |
| åºŸå¼ƒè¡¨æ¸…ç† | 0.5h | 0.2h |
| è°ƒè¯•æ–‡ä»¶è¯†åˆ« | 1h | 0.5h |
| æŠ¥å‘Šç”Ÿæˆ | 0.5h | 0.3h |
| **æ€»è®¡** | **4-6h** | **2.5h** |

---

**æŠ¥å‘Šç¼–åˆ¶**: ç³»ç»Ÿæ¶æ„ç»„
**å®¡æ ¸**: æŠ€æœ¯å§”å‘˜ä¼š
**å®Œæˆæ—¶é—´**: 2026-02-28
**çŠ¶æ€**: âœ… å·²å®Œæˆ
