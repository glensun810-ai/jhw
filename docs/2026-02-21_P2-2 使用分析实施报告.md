# P2-2 使用分析实施报告

**文档版本**: v1.0  
**创建日期**: 2026-02-21  
**实施状态**: ✅ 已完成  

---

## 执行摘要

### 问题描述

无使用统计分析，导致：
- 无法了解用户活跃度（DAU/MAU）
- 无法追踪功能使用频率
- 无法监控 AI 平台调用情况
- 无法掌握系统错误率

### 实施内容

本次实施完成了完整的使用分析系统，包括：
1. ✅ DAU/MAU 统计 API
2. ✅ 功能使用频率 API
3. ✅ AI 平台调用统计 API
4. ✅ 错误率监控 API
5. ✅ 综合分析仪表盘页面

### 新增 API 端点

| 端点 | 方法 | 功能 | 权限 |
|------|------|------|------|
| `/analytics/dashboard` | GET | 综合分析仪表盘 | 管理员 |
| `/analytics/users/active` | GET | 活跃用户统计（DAU/MAU） | 管理员 |
| `/analytics/features/usage` | GET | 功能使用频率 | 管理员 |
| `/analytics/ai-platforms/stats` | GET | AI 平台调用统计 | 管理员 |
| `/analytics/errors/stats` | GET | 错误率监控 | 管理员 |

### 核心指标

```
用户指标:
- DAU (日活跃用户)
- MAU (月活跃用户)
- DAU/MAU 比率

测试指标:
- 今日测试数
- 周期测试总数
- 日均测试数

平台指标:
- 热门 AI 平台
- 平台调用次数
- 平台成功率

错误指标:
- 各阶段错误率
- 常见错误类型
- 错误趋势
```

---

## 第一部分：后端实现

### 1.1 DAU/MAU 统计 API

**端点**: `GET /analytics/users/active`

**查询参数**:
- `days`: 统计天数（默认 30）
- `group_by`: 分组方式 day/week/month（默认 day）

**返回数据**:
```json
{
  "status": "success",
  "data": {
    "overview": {
      "dau": 25,
      "mau": 150,
      "dau_mau_ratio": 16.67,
      "total_users": 500
    },
    "daily_stats": [
      {
        "date": "2026-02-21",
        "dau": 25,
        "total_tests": 45
      }
    ]
  }
}
```

**实现逻辑**:
```python
# 计算 DAU（今日活跃用户）
SELECT COUNT(DISTINCT user_id)
FROM test_records
WHERE DATE(test_date) = ?

# 计算 MAU（月活跃用户）
SELECT COUNT(DISTINCT user_id)
FROM test_records
WHERE DATE(test_date) >= ?

# DAU/MAU 比率
dau_mau_ratio = dau / mau * 100
```

---

### 1.2 功能使用频率 API

**端点**: `GET /analytics/features/usage`

**查询参数**:
- `days`: 统计天数（默认 7）

**返回数据**:
```json
{
  "status": "success",
  "data": {
    "feature_stats": {
      "brand_test": 120,
      "ai_diagnosis": 115,
      "unique_users": 85
    },
    "daily_usage": [
      {"date": "2026-02-21", "count": 45}
    ],
    "top_features": [
      {"name": "deepseek", "count": 50},
      {"name": "qwen", "count": 40}
    ]
  }
}
```

**实现逻辑**:
```python
# 统计功能使用
SELECT 
    SUM(CASE WHEN brand_name IS NOT NULL THEN 1 ELSE 0 END) as brand_test,
    SUM(CASE WHEN ai_models_used IS NOT NULL THEN 1 ELSE 0 END) as ai_diagnosis,
    COUNT(DISTINCT user_id) as unique_users
FROM test_records
WHERE DATE(test_date) >= ?

# 热门功能（基于 AI 模型使用）
SELECT ai_models_used
FROM test_records
WHERE DATE(test_date) >= ?
```

---

### 1.3 AI 平台调用统计 API

**端点**: `GET /analytics/ai-platforms/stats`

**查询参数**:
- `days`: 统计天数（默认 7）

**返回数据**:
```json
{
  "status": "success",
  "data": {
    "platforms": [
      {
        "name": "DeepSeek",
        "count": 50,
        "success": 48,
        "failed": 2,
        "success_rate": 96.0
      }
    ],
    "trend": [
      {"date": "2026-02-21", "platforms": {"DeepSeek": 10, "Qwen": 8}}
    ],
    "overview": {
      "total_calls": 120,
      "avg_calls_per_day": 17.14,
      "platform_count": 6
    }
  }
}
```

**实现逻辑**:
```python
# 各平台调用次数
SELECT ai_models_used
FROM test_records
WHERE DATE(test_date) >= ?

# 解析 JSON 并统计
for models in results:
    for model in json.loads(models):
        platform_stats[model]['count'] += 1
```

---

### 1.4 错误率监控 API

**端点**: `GET /analytics/errors/stats`

**查询参数**:
- `days`: 统计天数（默认 7）

**返回数据**:
```json
{
  "status": "success",
  "data": {
    "stage_stats": [
      {
        "stage": "ai_fetching",
        "completed": 100,
        "pending": 5,
        "error_rate": 0.0
      }
    ],
    "error_trend": [
      {
        "date": "2026-02-21",
        "errors": 2,
        "total": 50,
        "error_rate": 4.0
      }
    ],
    "overview": {
      "total_completed": 500,
      "total_pending": 10,
      "overall_error_rate": 2.5
    }
  }
}
```

**实现逻辑**:
```python
# 各阶段任务统计
SELECT stage, is_completed, COUNT(*)
FROM task_statuses
WHERE DATE(created_at) >= ?
GROUP BY stage, is_completed

# 错误趋势
SELECT DATE(created_at) as date, 
       SUM(CASE WHEN is_completed = 0 THEN 1 ELSE 0 END) as errors,
       COUNT(*) as total
FROM task_statuses
WHERE DATE(created_at) >= ?
GROUP BY date
```

---

### 1.5 综合分析仪表盘 API

**端点**: `GET /analytics/dashboard`

**返回数据**:
```json
{
  "status": "success",
  "data": {
    "user_metrics": {
      "total_users": 500,
      "dau": 25,
      "mau": 150,
      "dau_mau_ratio": 16.67
    },
    "test_metrics": {
      "tests_today": 45,
      "tests_period": 280,
      "avg_per_day": 40.0
    },
    "platform_metrics": {
      "top_platform": "DeepSeek",
      "platform_count": 6
    }
  }
}
```

---

## 第二部分：前端实现

### 2.1 使用分析页面

**文件**: `pages/admin/analytics/analytics.*`

**功能**:
- ✅ 时间选择器（7 天/30 天/90 天）
- ✅ 核心指标卡片（DAU、测试数、平台数）
- ✅ 活跃用户趋势图
- ✅ AI 平台使用统计
- ✅ 错误率监控
- ✅ 功能使用频率

**UI 布局**:
```
┌─────────────────────────────────────┐
│  使用分析                            │
│  数据统计与监控                      │
├─────────────────────────────────────┤
│  [7 天] [30 天] [90 天]              │
├─────────────────────────────────────┤
│  ┌─────┐ ┌─────┐ ┌─────┐          │
│  │ DAU │ │测试 │ │平台 │          │
│  │ 25  │ │ 45  │ │ 6   │          │
│  └─────┘ └─────┘ └─────┘          │
├─────────────────────────────────────┤
│  活跃用户趋势                        │
│  ▃▅▇▆▅▃▇▅▆▇▃▅▇▆▅▃▇                │
├─────────────────────────────────────┤
│  AI 平台使用                          │
│  DeepSeek  ████████ 50 次 96%       │
│  Qwen     ██████   40 次 98%       │
├─────────────────────────────────────┤
│  错误率监控                          │
│  AI 获取中  完成：100  待处理：5     │
└─────────────────────────────────────┘
```

---

### 2.2 数据加载优化

**并行加载多个接口**:
```javascript
Promise.all([
  this.fetchDashboard(token),
  this.fetchActiveUsers(token),
  this.fetchPlatformStats(token),
  this.fetchErrorStats(token),
  this.fetchFeatureUsage(token)
]).then(() => {
  this.setData({ loading: false });
});
```

**图表数据处理**:
```javascript
// 计算柱状图高度
const maxValue = Math.max(...dailyStats.map(s => s.dau), 1);
const activeTrend = dailyStats.map(item => ({
  date: item.date.substring(5),
  dau: item.dau,
  height: (item.dau / maxValue) * 80
}));
```

---

## 第三部分：核心算法

### 3.1 DAU/MAU 计算

```python
# DAU（日活跃用户）
 dau = COUNT(DISTINCT user_id) 
  WHERE DATE(test_date) = TODAY

# MAU（月活跃用户）
mau = COUNT(DISTINCT user_id)
  WHERE DATE(test_date) >= TODAY - 30 DAYS

# DAU/MAU 比率（用户粘性指标）
ratio = dau / mau * 100

# 健康范围
# > 20%: 高粘性
# 10-20%: 中等粘性
# < 10%: 低粘性
```

---

### 3.2 平台成功率计算

```python
# 成功率
success_rate = success_count / total_count * 100

# 分级标准
# > 95%: 优秀
# 90-95%: 良好
# 80-90%: 中等
# < 80%: 需要改进
```

---

### 3.3 错误率计算

```python
# 各阶段错误率
error_rate = pending_count / (completed_count + pending_count) * 100

# 总体错误率
overall_error_rate = AVG(stage_error_rates)

# 告警阈值
# > 10%: 严重
# 5-10%: 警告
# < 5%: 正常
```

---

## 第四部分：使用示例

### 4.1 查看 DAU/MAU

```javascript
// 获取近 30 天活跃用户统计
wx.request({
  url: 'http://127.0.0.1:5000/analytics/users/active?days=30',
  header: {'Authorization': `Bearer ${token}`},
  success: (res) => {
    const {dau, mau, ratio} = res.data.data.overview;
    console.log(`DAU: ${dau}, MAU: ${mau}, 粘性：${ratio}%`);
  }
});
```

### 4.2 查看 AI 平台统计

```javascript
// 获取近 7 天 AI 平台调用统计
wx.request({
  url: 'http://127.0.0.1:5000/analytics/ai-platforms/stats?days=7',
  header: {'Authorization': `Bearer ${token}`},
  success: (res) => {
    const platforms = res.data.data.platforms;
    platforms.forEach(p => {
      console.log(`${p.name}: ${p.count}次，成功率${p.success_rate}%`);
    });
  }
});
```

### 4.3 查看错误率

```javascript
// 获取错误率统计
wx.request({
  url: 'http://127.0.0.1:5000/analytics/errors/stats?days=7',
  header: {'Authorization': `Bearer ${token}`},
  success: (res) => {
    const errorRate = res.data.data.overview.overall_error_rate;
    console.log(`总体错误率：${errorRate}%`);
  }
});
```

---

## 第五部分：数据分析建议

### 5.1 用户活跃度分析

**DAU/MAU 比率解读**:
- **> 20%**: 用户粘性高，产品健康
- **10-20%**: 中等粘性，有改进空间
- **< 10%**: 用户流失风险，需要改进

**改进建议**:
- 增加用户召回机制
- 优化用户体验
- 增加日常任务/签到功能

---

### 5.2 AI 平台优化

**平台选择建议**:
- 优先使用成功率 > 95% 的平台
- 关注调用量大的平台稳定性
- 定期评估各平台性价比

**成本优化**:
- 根据使用量选择合适套餐
- 实施智能路由（失败自动切换）
- 缓存常用查询结果

---

### 5.3 错误率监控

**告警阈值**:
- **> 10%**: 立即处理，可能系统故障
- **5-10%**: 关注趋势，准备预案
- **< 5%**: 正常范围，持续监控

**常见错误处理**:
- TimeoutError: 增加超时时间，实施重试
- APIError: 检查 API 密钥，联系服务商
- ValidationError: 修复输入验证逻辑

---

## 第六部分：后续改进计划

### P1 改进项

1. **实时数据**
   - WebSocket 实时推送
   - 自动刷新机制
   - 实时告警通知

2. **数据导出**
   - Excel 导出
   - PDF 报告
   - API 数据导出

### P2 改进项

3. **高级分析**
   - 用户留存分析
   - 漏斗分析
   - 同期群分析

4. **预测分析**
   - 用户增长预测
   - 负载预测
   - 异常检测

---

**文档结束**
