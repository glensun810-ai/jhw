# ç»“æœé¡µæ•°æ®åŠ è½½å¤±è´¥æ ¹å› åˆ†ææŠ¥å‘Š

**æŠ¥å‘Šç¼–å·**: ROOT-CAUSE-LOAD-FAIL-2026-0222-001  
**åˆ†ææ—¥æœŸ**: 2026-02-22  
**é—®é¢˜çº§åˆ«**: ğŸ”´ P0 - ä¸¥é‡

---

## ğŸ” é”™è¯¯æ—¥å¿—åˆ†æ

```
results.js? [sm]:81 ğŸ“¥ ä» executionId åŠ è½½æ•°æ®ï¼š361573c9... åä¸º
results.js? [sm]:132 âš ï¸ æœ¬åœ°å­˜å‚¨æ— æ•°æ®ï¼Œå°è¯•ä» URL å‚æ•°åŠ è½½
results.js? [sm]:244 è§£æç»“æœæ•°æ®å¤±è´¥ TypeError: Cannot read property 'competitiveAnalysis' of undefined
```

---

## ğŸ”¬ æ ¹å› å®šä½

### é—®é¢˜ 1: é¦–é¡µè·³è½¬æœªä¼ é€’å®Œæ•´æ•°æ® âŒ

**é¦–é¡µè·³è½¬é€»è¾‘** (`pages/index/index.js` ç¬¬ 1130 è¡Œ):

```javascript
// è‡ªåŠ¨è·³è½¬åˆ°ç»“æœé¡µ
wx.navigateTo({
  url: `/pages/results/results?executionId=${executionId}&brandName=${encodeURIComponent(this.data.brandName)}`
});
```

**é—®é¢˜**: åªä¼ é€’äº† `executionId` å’Œ `brandName`ï¼Œ**æ²¡æœ‰ä¼ é€’ `results` å’Œ `competitiveAnalysis`**

---

### é—®é¢˜ 2: æœ¬åœ°å­˜å‚¨åŠ è½½å¤±è´¥ âŒ

**ç»“æœé¡µåŠ è½½é€»è¾‘** (`pages/results/results.js`):

```javascript
const cachedResults = wx.getStorageSync('latestTestResults_' + executionId);
if (cachedResults && Array.isArray(cachedResults) && cachedResults.length > 0) {
  // ä½¿ç”¨ç¼“å­˜
} else {
  console.warn('âš ï¸ æœ¬åœ°å­˜å‚¨æ— æ•°æ®ï¼Œå°è¯•ä» URL å‚æ•°åŠ è½½');
  this.loadFromUrlParams(options);
}
```

**é—®é¢˜**: 
1. é¦–é¡µæœªä¿å­˜ `latestTestResults_{executionId}`
2. ç»“æœé¡µ fallback åˆ° URL å‚æ•°åŠ è½½

---

### é—®é¢˜ 3: URL å‚æ•°è§£æå¤±è´¥ âŒ

**ç»“æœé¡µ URL å‚æ•°åŠ è½½** (`loadFromUrlParams`):

```javascript
let competitiveAnalysis;
if (options.competitiveAnalysis) {
  competitiveAnalysis = JSON.parse(decodeURIComponent(options.competitiveAnalysis));
} else {
  competitiveAnalysis = results.competitiveAnalysis || null;  // âŒ results ä¸º undefined
}

if (!competitiveAnalysis && results && typeof results === 'object') {
  // ...
} else if (!competitiveAnalysis) {
  competitiveAnalysis = {  // âŒ è¿™é‡Œè®¾ç½®ä¸ºç©ºå¯¹è±¡
    brandScores: {},
    firstMentionByPlatform: {},
    interceptionRisks: {}
  };
}
```

**é—®é¢˜**: 
1. URL å‚æ•°æ²¡æœ‰ `competitiveAnalysis`
2. `results` ä¸º undefined
3. `competitiveAnalysis` è¢«è®¾ç½®ä¸ºç©ºå¯¹è±¡
4. åç»­ä»£ç è®¿é—® `competitiveAnalysis.brandScores` æ—¶æŠ¥é”™

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆè®¾è®¡åŸåˆ™

1. **å¤šå±‚é™çº§ç­–ç•¥**: URL å‚æ•° â†’ æœ¬åœ°å­˜å‚¨ â†’ åç«¯ API
2. **æ•°æ®å®Œæ•´æ€§æ£€æŸ¥**: ç¡®ä¿å…³é”®å­—æ®µå­˜åœ¨
3. **é˜²å¾¡æ€§ç¼–ç¨‹**: æ‰€æœ‰è®¿é—®åŠ é»˜è®¤å€¼
4. **è¯¦ç»†æ—¥å¿—**: ä¾¿äºé—®é¢˜æ’æŸ¥

---

### ä¿®å¤ 1: é¦–é¡µè·³è½¬ä¼ é€’å®Œæ•´æ•°æ®

**æ–‡ä»¶**: `pages/index/index.js`

```javascript
// è¯Šæ–­å®Œæˆåè·³è½¬
if (parsedStatus.stage === 'completed') {
  // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
  const resultsToSave = parsedStatus.detailed_results || parsedStatus.results || [];
  const competitiveAnalysisToSave = parsedStatus.competitive_analysis || 
                                    this.data.latestCompetitiveAnalysis || {};
  const brandScoresToSave = parsedStatus.brand_scores || 
                           (competitiveAnalysisToSave && competitiveAnalysisToSave.brandScores) || {};
  
  // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
  wx.setStorageSync('latestTestResults_' + executionId, resultsToSave);
  wx.setStorageSync('latestCompetitiveAnalysis_' + executionId, competitiveAnalysisToSave);
  wx.setStorageSync('latestBrandScores_' + executionId, brandScoresToSave);
  wx.setStorageSync('latestTargetBrand', this.data.brandName);
  
  // è·³è½¬åˆ°ç»“æœé¡µï¼ˆä¼ é€’å®Œæ•´æ•°æ®ï¼‰
  wx.navigateTo({
    url: `/pages/results/results?executionId=${executionId}&brandName=${encodeURIComponent(this.data.brandName)}&results=${encodeURIComponent(JSON.stringify(resultsToSave))}&competitiveAnalysis=${encodeURIComponent(JSON.stringify(competitiveAnalysisToSave))}`
  });
}
```

---

### ä¿®å¤ 2: ç»“æœé¡µåŠ å¼ºæ•°æ®åŠ è½½

**æ–‡ä»¶**: `pages/results/results.js`

```javascript
onLoad: function(options) {
  console.log('ğŸ“¥ ç»“æœé¡µåŠ è½½ options:', options);
  
  const executionId = decodeURIComponent(options.executionId || '');
  const brandName = decodeURIComponent(options.brandName || '');
  
  // ã€å¤šå±‚é™çº§ç­–ç•¥ã€‘
  // 1. ä¼˜å…ˆä»æœ¬åœ°å­˜å‚¨åŠ è½½
  const cachedResults = wx.getStorageSync('latestTestResults_' + executionId);
  const cachedCompetitiveAnalysis = wx.getStorageSync('latestCompetitiveAnalysis_' + executionId);
  const cachedBrandScores = wx.getStorageSync('latestBrandScores_' + executionId);
  const cachedBrand = wx.getStorageSync('latestTargetBrand');
  
  console.log('ğŸ“¦ æœ¬åœ°å­˜å‚¨æ•°æ®:', {
    hasResults: !!cachedResults && cachedResults.length > 0,
    hasCompetitiveAnalysis: !!cachedCompetitiveAnalysis,
    hasBrandScores: !!cachedBrandScores
  });
  
  // 2. ä» URL å‚æ•°åŠ è½½ï¼ˆé™çº§ï¼‰
  let results = null;
  let competitiveAnalysis = null;
  
  if (cachedResults && cachedResults.length > 0) {
    results = cachedResults;
  } else if (options.results) {
    try {
      results = JSON.parse(decodeURIComponent(options.results));
    } catch (e) {
      console.error('è§£æ URL results å¤±è´¥:', e);
    }
  }
  
  if (cachedCompetitiveAnalysis) {
    competitiveAnalysis = cachedCompetitiveAnalysis;
  } else if (options.competitiveAnalysis) {
    try {
      competitiveAnalysis = JSON.parse(decodeURIComponent(options.competitiveAnalysis));
    } catch (e) {
      console.error('è§£æ URL competitiveAnalysis å¤±è´¥:', e);
    }
  }
  
  // 3. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
  if (!competitiveAnalysis || !competitiveAnalysis.brandScores) {
    if (cachedBrandScores) {
      competitiveAnalysis = {
        brandScores: cachedBrandScores,
        firstMentionByPlatform: {},
        interceptionRisks: []
      };
    } else {
      competitiveAnalysis = {
        brandScores: {},
        firstMentionByPlatform: {},
        interceptionRisks: []
      };
    }
  }
  
  // 4. åˆå§‹åŒ–é¡µé¢
  if (results && results.length > 0) {
    this.initializePageWithData(
      results,
      brandName || cachedBrand || '',
      [],
      competitiveAnalysis,
      null, null, null
    );
  } else {
    console.error('âŒ æ— æœ‰æ•ˆæ•°æ®ï¼ŒåŠ è½½ç¼“å­˜');
    this.loadFromCache();
  }
}
```

---

### ä¿®å¤ 3: loadFromUrlParams é˜²å¾¡æ€§ç¼–ç¨‹

**æ–‡ä»¶**: `pages/results/results.js`

```javascript
loadFromUrlParams: function(options) {
  try {
    console.log('ğŸ“¥ loadFromUrlParams options:', options);
    
    // å®‰å…¨è§£æ results
    let results = null;
    if (options.results) {
      try {
        results = JSON.parse(decodeURIComponent(options.results));
      } catch (e) {
        console.error('è§£æ results å¤±è´¥:', e);
        results = null;
      }
    }
    
    // å®‰å…¨è§£æ competitiveAnalysis
    let competitiveAnalysis = null;
    if (options.competitiveAnalysis) {
      try {
        competitiveAnalysis = JSON.parse(decodeURIComponent(options.competitiveAnalysis));
      } catch (e) {
        console.error('è§£æ competitiveAnalysis å¤±è´¥:', e);
        competitiveAnalysis = null;
      }
    }
    
    // æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
    if (!competitiveAnalysis || !competitiveAnalysis.brandScores) {
      competitiveAnalysis = {
        brandScores: {},
        firstMentionByPlatform: {},
        interceptionRisks: []
      };
    }
    
    const targetBrand = options.targetBrand || '';
    
    console.log('âœ… è§£ææˆåŠŸ:', { targetBrand, hasResults: !!results });
    
    // ... åç»­å¤„ç†
  } catch (e) {
    console.error('âŒ loadFromUrlParams å¤±è´¥:', e);
    this.loadFromCache();
  }
}
```

---

## ğŸ“Š æ•°æ®æµå›¾

```
è¯Šæ–­å®Œæˆ
   â†“
é¦–é¡µ pollTestProgress
   â†“
parsedStatus.detailed_results (âœ… æœ‰æ•°æ®)
   â†“
ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨:
  - latestTestResults_{id}
  - latestCompetitiveAnalysis_{id}
  - latestBrandScores_{id}
   â†“
è·³è½¬åˆ°ç»“æœé¡µ (ä¼ é€’ URL å‚æ•°)
   â†“
ç»“æœé¡µ onLoad
   â†“
ä¼˜å…ˆä»æœ¬åœ°å­˜å‚¨åŠ è½½ âœ…
   â†“
é™çº§åˆ° URL å‚æ•° âœ…
   â†“
æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ âœ…
   â†“
initializePageWithData âœ…
   â†“
é¡µé¢æ˜¾ç¤ºæ­£å¸¸ âœ…
```

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-02-22 18:00:00  
**æ ¹å› **: é¦–é¡µè·³è½¬æœªä¼ é€’å®Œæ•´æ•°æ®ï¼Œç»“æœé¡µæœ¬åœ°å­˜å‚¨åŠ è½½å¤±è´¥  
**ä¿®å¤çŠ¶æ€**: â³ å¾…æ‰§è¡Œ

---

*ç»“æœé¡µæ•°æ®åŠ è½½å¤±è´¥æ ¹å› åˆ†ææŠ¥å‘Šï¼Œå¤šå±‚é™çº§ç­–ç•¥ç¡®ä¿æ•°æ®åŠ è½½æˆåŠŸ*
