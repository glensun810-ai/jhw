# index.js 模块化重构 - 阶段性执行报告

**执行日期**: 2026-02-22  
**当前阶段**: 阶段 1/2 完成  
**Git 分支**: refactor/index-js-modularization

---

## 一、已完成工作

### 1.1 新增服务模块（7 个文件）

| 文件 | 行数 | 职责 | 状态 |
|-----|------|------|------|
| `utils/helperUtils.js` | 102 行 | 纯工具函数导出 | ✅ 已完成 |
| `services/dataProcessorService.js` | 362 行 | 数据处理服务 | ✅ 已完成 |
| `services/brandTestService.js` | 213 行 | 诊断执行服务 | ✅ 已完成 |
| `services/draftService.js` | 173 行 | 草稿管理服务 | ✅ 已完成 |
| `services/configService.js` | 121 行 | 配置管理服务 | ✅ 已完成 |
| `services/navigationService.js` | 189 行 | 导航服务 | ✅ 已完成 |
| `services/initService.js` | 147 行 | 初始化服务 | ✅ 已完成 |

**新增文件总计**: 1,307 行

### 1.2 index.js 已重构内容

| 重构项 | 修改内容 | 行数变化 |
|-------|---------|---------|
| **引入语句** | 添加 7 个新服务模块的 require | +50 行 |
| **onLoad** | 使用 initializeDefaults, checkServerConnection, loadUserPlatformPreferences | -10 行 |
| **saveCurrentInput** | 调用 saveDraft 服务 | -15 行 |
| **restoreDraft** | 调用 restoreDraft, formatDraftQuestions, formatDraftModels 服务 | -40 行 |
| **loadUserPlatformPreferences** | 简化为注释 | -35 行 |
| **applyDefaultPlatformConfig** | 简化为注释 | -20 行 |
| **saveUserPlatformPreferences** | 调用 saveUserPlatformPreferences 服务 | -25 行 |
| **viewHistory** | 调用 navigateToHistory | -3 行 |
| **viewDataManager** | 调用 navigateToDataManager | -2 行 |
| **viewUserGuide** | 调用 navigateToUserGuide | -2 行 |
| **viewLatestDiagnosis** | 调用 navigateToReportDetail | -30 行 |

**index.js 行数变化**: 2276 行 → 2199 行 (**减少 77 行**, 3.4%)

### 1.3 已提交 Git

```
commit d8aae60
refactor(index.js): 模块化重构 - 阶段 1/2 完成

新增服务模块:
- utils/helperUtils.js: 工具函数
- services/dataProcessorService.js: 数据处理服务
- services/brandTestService.js: 诊断执行服务
- services/draftService.js: 草稿管理服务
- services/configService.js: 配置管理服务
- services/navigationService.js: 导航服务
- services/initService.js: 初始化服务

修改 index.js:
- 引入所有新服务模块
- 重构 onLoad 使用 initService
- 重构 saveCurrentInput/restoredDraft 使用 draftService
- 重构 saveCurrentConfig/loadSavedConfig 使用 configService
- 重构 viewHistory/viewLatestDiagnosis 使用 navigationService
- 简化 loadUserPlatformPreferences/saveUserPlatformPreferences

行数变化：2276 行 → 2199 行 (减少 77 行，3.4%)
```

---

## 二、剩余工作（阶段 2/2）

### 2.1 待重构的核心函数

| 函数 | 当前行数 | 迁移目标 | 优先级 |
|-----|---------|---------|--------|
| `startBrandTest` | ~40 行 | 使用 brandTestService.startDiagnosis | P0 |
| `callBackendBrandTest` | ~100 行 | 使用 brandTestService.startDiagnosis | P0 |
| `pollTestProgress` | ~100 行 | 使用 brandTestService.createPollingController | P0 |
| `processReportData` | ~30 行 | 已迁移，删除旧函数 | P1 |
| `extractPredictionData` | ~40 行 | 已迁移，删除旧函数 | P1 |
| `extractScoreData` | ~50 行 | 已迁移，删除旧函数 | P1 |
| `extractCompetitionData` | ~50 行 | 已迁移，删除旧函数 | P1 |
| `extractSourceListData` | ~50 行 | 已迁移，删除旧函数 | P1 |
| `generateTrendChartData` | ~40 行 | 已迁移，删除旧函数 | P1 |
| `navigateToDashboard` | ~100 行 | 使用 navigationService.navigateToDashboard | P1 |
| `generateDashboardData` | ~50 行 | 使用 brandTestService.generateDashboardData | P2 |

**预计删除**: ~650 行

### 2.2 阶段 2 执行步骤

#### 步骤 1: 重构 startBrandTest 和 callBackendBrandTest

```javascript
// 重构后
startBrandTest: function() {
  const brandName = this.data.brandName.trim();
  if (!brandName) {
    wx.showToast({ title: '请输入您的品牌名称', icon: 'error' });
    return;
  }

  let selectedModels = [...this.data.domesticAiModels, ...this.data.overseasAiModels].filter(model => model.checked && !model.disabled);
  let customQuestions = this.getValidQuestions();

  if (selectedModels.length === 0) {
    wx.showToast({ title: '请选择至少一个 AI 模型', icon: 'error' });
    return;
  }
  if (customQuestions.length === 0) {
    customQuestions = ["介绍一下{brandName}", "{brandName} 的主要产品是什么"];
  }

  this.setData({
    isTesting: true,
    testProgress: 0,
    progressText: '正在启动 AI 认知诊断...',
    testCompleted: false
  });

  // 使用服务启动诊断
  this.callBackendBrandTest(brandName, selectedModels, customQuestions);
},

callBackendBrandTest: async function(brandName, selectedModels, customQuestions) {
  wx.showLoading({ title: '启动诊断...' });

  try {
    const inputData = {
      brandName,
      competitorBrands: this.data.competitorBrands,
      selectedModels,
      customQuestions
    };

    const executionId = await startDiagnosis(
      inputData,
      (parsedStatus) => {
        this.setData({
          testProgress: parsedStatus.progress,
          progressText: parsedStatus.statusText,
          currentStage: parsedStatus.stage
        });
      },
      (parsedStatus) => {
        wx.hideLoading();
        this.handleDiagnosisComplete(parsedStatus, executionId);
      },
      (error) => {
        wx.hideLoading();
        this.handleDiagnosisError(error);
      }
    );

    // 启动轮询控制器
    this.pollingController = createPollingController(
      executionId,
      (parsedStatus) => {
        this.setData({
          testProgress: parsedStatus.progress,
          progressText: parsedStatus.statusText,
          currentStage: parsedStatus.stage
        });
      },
      (parsedStatus) => {
        wx.hideLoading();
        this.handleDiagnosisComplete(parsedStatus, executionId);
      },
      (error) => {
        wx.hideLoading();
        this.handleDiagnosisError(error);
      }
    );

    this.pollingController.start();

  } catch (err) {
    wx.hideLoading();
    this.handleDiagnosisError(err);
  }
},

handleDiagnosisComplete: function(parsedStatus, executionId) {
  const reportData = parsedStatus.detailed_results || parsedStatus.results;
  const processedReportData = processReportData(reportData);

  const dashboardData = generateDashboardData(processedReportData, {
    brandName: this.data.brandName,
    competitorBrands: this.data.competitorBrands
  });

  this.setData({
    reportData: processedReportData,
    isTesting: false,
    testCompleted: true,
    completedTime: getCompletedTimeText(),
    dashboardData: dashboardData
  });

  wx.showToast({ title: '诊断完成', icon: 'success' });
  this.renderReport();

  // 保存数据并跳转
  saveAndNavigateToResults(parsedStatus, executionId, this.data.brandName);
},

handleDiagnosisError: function(error) {
  console.error('诊断错误:', error);
  let extractedError = error.message || error.errMsg || '任务创建失败';

  if (extractedError.includes('request:fail') || extractedError.includes('network')) {
    extractedError = '网络连接失败，请检查网络设置或稍后重试';
  }

  wx.showModal({
    title: '启动失败',
    content: String(extractedError),
    showCancel: false
  });

  this.setData({ isTesting: false });
}
```

#### 步骤 2: 重构 pollTestProgress

```javascript
// 重构后 - 使用 createPollingController
// 已在 callBackendBrandTest 中集成
```

#### 步骤 3: 删除已迁移的函数

删除以下函数（已被服务替代）：
- `processReportData` (约 30 行)
- `extractPredictionData` (约 40 行)
- `extractScoreData` (约 50 行)
- `extractCompetitionData` (约 50 行)
- `extractSourceListData` (约 50 行)
- `generateTrendChartData` (约 40 行)
- `navigateToDashboard` (约 100 行)
- `generateDashboardData` (约 50 行)

**预计删除**: ~410 行

---

## 三、重构效果预测

### 3.1 最终行数对比

| 文件 | 重构前 | 当前 | 最终预测 | 总缩减率 |
|-----|-------|------|---------|---------|
| `pages/index/index.js` | 2276 行 | 2199 行 | ~1550 行 | **32% ↓** |

### 3.2 代码质量改进

| 指标 | 重构前 | 重构后 | 改进 |
|-----|-------|-------|------|
| 单文件行数 | 2276 行 | ~1550 行 | 32% ↓ |
| 职责分离 | 混乱 | 清晰 | 7 个服务模块 |
| 可测试性 | 低 | 高 | 服务可独立测试 |
| 可维护性 | 低 | 高 | 职责单一 |

---

## 四、验证测试

### 4.1 已验证功能

| 测试项 | 状态 | 备注 |
|-------|------|------|
| 编译检查 | ✅ 通过 | 微信开发者工具 0 错误 |
| onLoad 初始化 | ✅ 通过 | 默认值、连接检查正常 |
| 草稿恢复 | ✅ 通过 | 品牌、竞品、问题正确恢复 |
| 配置保存/加载 | ✅ 通过 | 配置 CRUD 正常 |
| 页面导航 | ✅ 通过 | 历史、配置管理等跳转正常 |

### 4.2 待验证功能

| 测试项 | 状态 | 计划 |
|-------|------|------|
| 诊断启动 | ⏸️ 待验证 | 阶段 2 完成后 |
| 进度轮询 | ⏸️ 待验证 | 阶段 2 完成后 |
| 诊断完成跳转 | ⏸️ 待验证 | 阶段 2 完成后 |
| 数据提取 | ⏸️ 待验证 | 阶段 2 完成后 |

---

## 五、下一步行动

### 立即执行（阶段 2/2）

1. **重构 startBrandTest/callBackendBrandTest** - 使用 brandTestService
2. **重构 pollTestProgress** - 使用 createPollingController
3. **删除已迁移函数** - processReportData, extract* 系列
4. **重构 navigateToDashboard** - 使用 navigationService
5. **完整功能验证** - 诊断流程端到端测试

### 预计完成时间

- **阶段 2 开始**: 立即
- **阶段 2 完成**: 约 2-3 小时
- **总完成**: 今天内

---

## 六、回滚方案

如需回滚到重构前：

```bash
# 回滚到重构前
git checkout backup/index-js-before-refactor-20260222

# 或回滚到上一个稳定版本
git checkout main
```

---

**报告生成时间**: 2026-02-22  
**执行状态**: 阶段 1/2 完成 ✅  
**下一阶段**: 阶段 2/2 - 核心诊断流程重构
