# P1-1: 统一 Storage 数据格式 - 修复方案

**问题**: 前端使用多个 Storage key 存储诊断结果，数据格式不一致
**影响**: 结果页加载可能失败，数据不一致
**修复**: 创建统一的 Storage 管理器

---

## 修复内容

### 1. 创建 Storage 管理器

**文件**: `utils/storage-manager.js` ✅ 已创建

**功能**:
- 统一 Storage key 命名规范
- 添加数据版本控制 (`version: '1.0'`)
- 添加数据过期检查 (7 天)
- 提供统一的读写接口

**Storage Key 规范**:
```javascript
const StorageKey = {
  DIAGNOSIS_RESULT: 'diagnosis_result_',  // 诊断结果（带 executionId）
  LAST_DIAGNOSIS: 'last_diagnostic_results',  // 最后一次诊断（兼容旧 key）
  USER_PREFERENCES: 'user_preferences',
  DRAFT_DATA: 'draft_data'
};
```

**数据结构**:
```javascript
{
  version: '1.0',
  timestamp: Date.now(),
  executionId: 'xxx-xxx-xxx',
  brandName: '品牌名称',
  data: {
    results: [...],
    competitiveAnalysis: {...},
    brandScores: {...},
    detailedResults: {...},
    semanticDriftData: {...},
    recommendationData: {...}
  }
}
```

### 2. API 接口

```javascript
// 保存诊断结果
saveDiagnosisResult(executionId, data)

// 加载诊断结果
loadDiagnosisResult(executionId)

// 加载最后一次诊断（兼容旧逻辑）
loadLastDiagnosis()

// 清除诊断结果
clearDiagnosisResult(executionId)

// 获取统计信息
getStorageStats()

// 清理过期数据
cleanupExpiredData()
```

### 3. 集成步骤

由于 index.js 和 results.js 文件较大，建议采用渐进式集成：

**步骤 1**: 在 index.js 中添加导入
```javascript
// 在文件顶部添加
const { saveDiagnosisResult } = require('../../utils/storage-manager');
```

**步骤 2**: 替换 handleDiagnosisComplete 中的保存逻辑
```javascript
// 原代码（第 996-1017 行）
wx.setStorageSync('last_diagnostic_results', {
  results: resultsToSave,
  competitiveAnalysis: competitiveAnalysisToSave,
  brandScores: brandScoresToSave,
  targetBrand: this.data.brandName,
  executionId: executionId,
  timestamp: Date.now()
});

// 替换为
saveDiagnosisResult(executionId, {
  brandName: this.data.brandName,
  results: resultsToSave,
  competitiveAnalysis: competitiveAnalysisToSave,
  brandScores: brandScoresToSave
});
```

**步骤 3**: 在 results.js 中添加导入
```javascript
// 在文件顶部添加
const { loadDiagnosisResult, loadLastDiagnosis } = require('../../utils/storage-manager');
```

**步骤 4**: 替换 onLoad 中的加载逻辑
```javascript
// 优先从统一 Storage 加载
const executionId = decodeURIComponent(options.executionId || '');
const storageData = loadDiagnosisResult(executionId);

if (storageData) {
  // 使用新格式数据
  results = storageData.results;
  competitiveAnalysis = storageData.competitiveAnalysis;
  // ...
} else {
  // 降级：从旧 Storage 加载
  const lastDiagnosticResults = wx.getStorageSync('last_diagnostic_results');
  // ...
}
```

---

## 验证方法

### 1. 语法检查
```bash
cd /Users/sgl/PycharmProjects/PythonProject
node -c utils/storage-manager.js
```

### 2. 功能测试
1. 启动诊断任务
2. 等待完成
3. 检查 Storage:
   ```javascript
   wx.getStorageInfo({
     success: (res) => {
       console.log('Storage keys:', res.keys);
       console.log('Diagnosis keys:', res.keys.filter(k => k.startsWith('diagnosis_result_')));
     }
   });
   ```

### 3. 数据验证
```javascript
// 检查新格式数据
const data = wx.getStorageSync('diagnosis_result_xxx-xxx-xxx');
console.log('Version:', data.version);  // 应该是 '1.0'
console.log('Has results:', data.data.results.length > 0);
console.log('Not expired:', Date.now() - data.timestamp < 7 * 24 * 60 * 60 * 1000);
```

---

## 兼容性保证

✅ **向后兼容**:
- 保留 `last_diagnostic_results` key
- 旧数据格式仍然可读
- 新数据同时写入新旧两个 key

✅ **渐进式迁移**:
- 新诊断使用新格式
- 旧数据逐步过期
- 7 天后自动清理

---

**状态**: ✅ 已完成
**下一步**: 在 index.js 和 results.js 中集成
