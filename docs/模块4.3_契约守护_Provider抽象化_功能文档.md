# 模块 4.3：契约守护——Provider 抽象化 功能文档

## 概述

本模块实现了AI平台适配器的契约化重构，通过抽象化Provider架构实现多平台标准化接入。系统现在支持通过ProviderFactory统一管理不同AI平台的提供者实例，并能够处理负面证据的自动任务分发。

## 核心组件

### 1. BaseAIProvider 抽象基类

定义了AI平台提供者的标准化接口契约：

#### 标准方法

1. `ask_question(prompt)` - 发送请求的标准方法，返回AI平台的原生响应
2. `extract_citations(raw_response)` - 从原生响应中提取引用链接
3. `to_standard_format(raw_response)` - 将结果转换为exposure_analysis草稿格式

#### 实现类

- `DoubaoProvider` - 豆包平台提供者
- `DeepSeekProvider` - DeepSeek平台提供者（支持R1推理链提取）

### 2. ProviderFactory 工厂类

用于创建和管理不同AI平台的提供者实例：

#### 主要方法

- `register(platform_name, provider_class)` - 注册AI提供者类
- `create(platform_name, api_key, model_name, **kwargs)` - 创建AI提供者实例
- `get_available_providers()` - 获取所有可用的提供者

## 功能特性

### 1. 契约化接口

所有AI平台提供者都必须实现BaseAIProvider定义的接口契约，确保：
- 统一的调用方式
- 一致的错误处理
- 标准化的响应格式

### 2. 推理链监控（DeepSeek R1）

DeepSeekProvider专门针对R1的推理能力优化，能够：
- 捕获AI的思考过程（reasoning content）
- 分析AI在得出结论前如何"联想"到竞品
- 提取推理步骤和逻辑链条

### 3. OpenAI协议对齐

所有适配器遵循OpenAI API协议格式：
- 统一的请求格式 (`/chat/completions`)
- 标准的响应结构
- 兼容的参数（model, messages, temperature, max_tokens等）

### 4. 引用提取功能

系统能够从AI响应中自动提取引用链接：
- 提取URL链接
- 提取Markdown格式链接
- 去重处理

### 5. 标准格式转换

将各平台的响应转换为标准化的exposure_analysis格式：
- 排名列表
- 品牌详情
- 未列出的竞争品牌

## API 接口

### POST /workflow/tasks

当用户在UI点击"处理"某条负面证据时，系统自动打包该片段的归因数据。

#### 请求参数

```json
{
  "evidence_fragment": "负面证据片段内容",
  "associated_url": "https://example.com/source",
  "source_name": "信源名称",
  "risk_level": "High",
  "brand_name": "品牌名称",
  "intervention_script": "干预脚本内容",
  "source_meta": {
    "platform": "信源平台",
    "category": "内容类别"
  },
  "webhook_url": "https://hooks.example.com/webhook",
  "priority": "medium"
}
```

#### 响应结构

```json
{
  "status": "success",
  "task_id": "wf_1234567890_a1b2c3d4",
  "message": "Workflow task created and dispatched successfully",
  "webhook_url": "https://hooks.example.com/webhook"
}
```

## 配置选项

### 环境变量

```bash
DOUBAO_API_KEY=your_doubao_api_key
DEEPSEEK_API_KEY=your_deepseek_api_key
```

### 支持的平台

- 豆包 (doubao) - 通过DoubaoProvider
- DeepSeek (deepseek) - 通过DeepSeekProvider，支持R1推理链提取
- 以及其他通过工厂模式支持的平台

## 部署说明

### 1. 依赖安装

```bash
pip install requests
pip install apscheduler  # 如果需要调度功能
```

### 2. 配置API密钥

在环境变量或配置文件中设置相应平台的API密钥。

### 3. 验证集成

通过API端点验证各平台提供者是否正常工作。

## 安全考虑

- 所有API调用都经过安全验证
- 输入数据经过净化处理
- 防止SSRF攻击
- API密钥加密存储

## 扩展性

新平台接入只需：

1. 继承BaseAIProvider类
2. 实现三个标准方法（ask_question, extract_citations, to_standard_format）
3. 注册到ProviderFactory
4. 无需修改后端解析逻辑

## 推理链分析

### DeepSeek R1 推理链提取

系统能够从DeepSeek R1的响应中提取推理链内容：

1. **推理内容字段**: 从 `reasoning`, `thoughts`, `thinking_process` 等字段提取
2. **模式匹配**: 从内容中分离推理过程和最终答案
3. **竞品关联分析**: 分析AI在推理过程中如何"联想"到竞品

### 示例推理链分析

```json
{
  "reasoning_content": "首先分析市场数据，发现德施曼在高端市场有一定份额；然后对比竞品，小米在性价比方面更优，华为在稳定性方面表现好；最后评估德施曼的优势在于技术实力和安全性。",
  "has_reasoning": true,
  "potential_competitor_mentions": ["小米", "华为"]
}
```

## Webhook 机制

### 任务分发

系统将打包后的任务通过Webhook推送到第三方API或企业通知渠道：

1. **标准化任务包**: 包含证据片段、干预脚本、信源元数据
2. **重试机制**: 指数退避算法处理失败的Webhook调用
3. **电路断路器**: 防止对不可用服务的持续请求

### 重试逻辑

- **基础延迟**: 60秒
- **指数增长**: 每次重试延迟翻倍
- **随机抖动**: 避免雷同请求
- **最大延迟**: 1小时
- **最大重试次数**: 3次

## 故障排除

### 常见问题

1. **API密钥错误**: 验证API密钥是否正确设置
2. **网络连接问题**: 检查网络连接和防火墙设置
3. **响应格式错误**: 确认AI平台响应格式符合预期
4. **推理链提取失败**: 检查DeepSeek R1 API是否返回推理内容

### 日志检查

系统记录以下关键事件：
- API调用和响应
- 错误类型和堆栈跟踪
- 性能指标
- 重试机制触发情况
- 推理链提取结果