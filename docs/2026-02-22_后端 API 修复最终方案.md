# åç«¯ API ä¿®å¤ - æœ€ç»ˆæ–¹æ¡ˆ

**æ–‡ä»¶**: `backend_python/wechat_backend/views.py`  
**å‡½æ•°**: `get_task_status_api` (ç¬¬ 2543 è¡Œ)

ç”±äºè‡ªåŠ¨ç¼–è¾‘å·¥å…·é‡åˆ°è¯­æ³•é—®é¢˜ï¼Œè¯·**æ‰‹åŠ¨ç¼–è¾‘**ä»¥ä¸‹ä»£ç ï¼š

---

## ä¿®å¤æ­¥éª¤

### æ­¥éª¤ 1: æ‰“å¼€æ–‡ä»¶

```bash
cd /Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend
open views.py  # macOS
# æˆ–ä½¿ç”¨å…¶ä»–ç¼–è¾‘å™¨
```

### æ­¥éª¤ 2: æ‰¾åˆ°ç¬¬ 2543 è¡Œ

æ‰¾åˆ° `get_task_status_api` å‡½æ•°ã€‚

### æ­¥éª¤ 3: ä¿®æ”¹ç¬¬ 2558 è¡Œ

**åŸä»£ç **:
```python
'results': task_status.get('results', []),
```

**ä¿®æ”¹ä¸º**:
```python
'results': task_status.get('results', []),
'detailed_results': task_status.get('results', []),  # ã€P0 ä¿®å¤ã€‘æ·»åŠ  detailed_results
```

### æ­¥éª¤ 4: ä¿®æ”¹ç¬¬ 2570-2571 è¡Œ

**åŸä»£ç **:
```python
from wechat_backend.models import get_task_status as get_db_task_status, get_deep_intelligence_result

db_task_status = get_db_task_status(task_id)
```

**ä¿®æ”¹ä¸º**:
```python
from wechat_backend.models import get_task_status as get_db_task_status, get_deep_intelligence_result
from wechat_backend.database_core import get_connection
import gzip, json

db_task_status = get_db_task_status(task_id)
```

### æ­¥éª¤ 5: åœ¨ç¬¬ 2585 è¡Œåæ·»åŠ ä»£ç 

æ‰¾åˆ°ç¬¬ 2585 è¡Œï¼š
```python
'message': 'Task found in database (server restarted)'
```

**åœ¨è¿™è¡Œåé¢ï¼ˆç¬¬ 2586 è¡Œï¼‰æ·»åŠ **:
```python
}

# ã€P0 ä¿®å¤ã€‘ä»æ•°æ®åº“è·å–å®Œæ•´çš„ results_summary
conn = get_connection()
cursor = conn.cursor()
cursor.execute("""
    SELECT results_summary, is_summary_compressed
    FROM test_records
    WHERE id = (
        SELECT MAX(id) FROM test_records 
        WHERE json_extract(results_summary, '$.execution_id') = ?
    )
""", (task_id,))
db_row = cursor.fetchone()
conn.close()

# è§£æ results_summary
if db_row:
    summary_raw, summary_comp = db_row
    try:
        if summary_comp and summary_raw:
            summary = json.loads(gzip.decompress(summary_raw).decode('utf-8'))
        elif summary_raw:
            summary = json.loads(summary_raw)
        else:
            summary = {}
        
        # æå–å…³é”®å­—æ®µ
        response_data['detailed_results'] = summary.get('detailed_results', [])
        response_data['brand_scores'] = summary.get('brand_scores', {})
        response_data['competitive_analysis'] = summary.get('competitive_analysis', {})
        response_data['negative_sources'] = summary.get('negative_sources', [])
        response_data['semantic_drift_data'] = summary.get('semantic_drift_data', {})
        response_data['recommendation_data'] = summary.get('recommendation_data', {})
        response_data['overall_score'] = summary.get('overall_score', 0)
        api_logger.info(f'âœ… ä»æ•°æ®åº“åŠ è½½ results_summary: {len(summary)} å­—æ®µ')
    except Exception as e:
        api_logger.error(f'âŒ è§£æ results_summary å¤±è´¥ï¼š{e}')
        response_data['detailed_results'] = []
        response_data['brand_scores'] = {}
        response_data['competitive_analysis'] = {}

# å¦‚æœä»»åŠ¡å·²å®Œæˆï¼Œå°è¯•è·å–ç»“æœ
if db_task_status.is_completed:
```

### æ­¥éª¤ 6: åˆ é™¤æ—§ä»£ç 

**åˆ é™¤ä»¥ä¸‹ä»£ç **ï¼ˆåŸç¬¬ 2588-2591 è¡Œï¼‰:
```python
# å¦‚æœä»»åŠ¡å·²å®Œæˆï¼Œå°è¯•è·å–ç»“æœ
if db_task_status.is_completed:
    deep_result = get_deep_intelligence_result(task_id)
    if deep_result:
        response_data['has_result'] = True
```

### æ­¥éª¤ 7: éªŒè¯è¯­æ³•

```bash
cd /Users/sgl/PycharmProjects/PythonProject/backend_python
python3 -m py_compile wechat_backend/views.py
```

### æ­¥éª¤ 8: é‡å¯åç«¯æœåŠ¡

```bash
# åœæ­¢å½“å‰æœåŠ¡ï¼ˆCtrl+Cï¼‰
# é‡æ–°å¯åŠ¨
python3 wechat_backend/app.py
```

---

## éªŒè¯

åœ¨å°ç¨‹åºä¸­è¿è¡Œè¯Šæ–­æµ‹è¯•ï¼ŒæŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼š

**é¢„æœŸæ—¥å¿—**:
```
âœ… ä»æ•°æ®åº“åŠ è½½ results_summary: X å­—æ®µ
ğŸ“¦ æœ¬åœ°å­˜å‚¨æ•°æ®ï¼š{hasResults: true, ...}
âœ… ä»æœ¬åœ°å­˜å‚¨åŠ è½½æˆåŠŸ
```

---

*åç«¯ API ä¿®å¤æŒ‡å—ï¼Œæ‰‹åŠ¨ç¼–è¾‘ views.py è¿”å›å®Œæ•´ results_summary æ•°æ®*
