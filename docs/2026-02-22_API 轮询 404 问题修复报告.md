# API 轮询 404 问题修复报告

**报告编号**: API-POLL-FIX-2026-0222-001  
**分析日期**: 2026-02-22  
**修复工程师**: AI Assistant  
**问题级别**: 🔴 P0 - 严重

---

## 🔍 问题分析

### 日志证据

```
GET /test/status/3e82324d-ca93-4a23-8405-2ddac30ef43a HTTP/1.1" 404
GET /test/status/3e82324d-ca93-4a23-8405-2ddac30ef43a HTTP/1.1" 404
GET /test/status/3e82324d-ca93-4a23-8405-2ddac30ef43a HTTP/1.1" 404
... (每 3 秒一次，持续不断)
```

### 根因分析

**问题 1: execution_store 数据丢失**

- `execution_store` 是**内存存储**，服务器重启后数据丢失
- executionId `3e82324d-ca93-4a23-8405-2ddac30ef43a` 在数据库中存在（记录 5）
- 但在 `execution_store` 中不存在（因为服务器重启过）

**问题 2: 缺少降级机制**

- `/test/status/<task_id>` API 只查询 `execution_store`
- 当 `execution_store` 中找不到时，直接返回 404
- 没有从数据库查询的降级逻辑

**问题 3: 前端缺少停止机制**

- 前端在收到 404 后继续轮询
- 没有最大重试次数限制
- 没有给用户明确提示

---

## ✅ 修复方案

### 修复 1: 后端添加数据库降级查询

**文件**: `wechat_backend/views.py`

```python
@wechat_bp.route('/test/status/<task_id>', methods=['GET'])
def get_task_status_api(task_id):
    """轮询任务进度与分阶段状态"""
    if not task_id:
        return jsonify({'error': 'Task ID is required'}), 400

    # 尝试从全局存储获取任务状态
    if task_id in execution_store:
        task_status = execution_store[task_id]
        # ... 返回现有逻辑
    else:
        # 【新增】从数据库查询（降级逻辑）
        from wechat_backend.models import get_task_status, get_deep_intelligence_result
        
        db_task_status = get_task_status(task_id)
        if db_task_status:
            # 从数据库构建响应
            response_data = {
                'task_id': task_id,
                'progress': 100 if db_task_status.is_completed else 50,
                'stage': db_task_status.stage.value,
                'status': 'completed' if db_task_status.is_completed else 'unknown',
                'is_completed': db_task_status.is_completed,
                'created_at': db_task_status.created_at,
                'from_database': True  # 标记数据来源
            }
            return jsonify(response_data), 200
        else:
            # 数据库中也找不到，返回 404
            return jsonify({'error': 'Task not found'}), 404
```

### 修复 2: 前端添加 404 停止机制

**文件**: `pages/detail/index.js`

```javascript
// 添加 404 计数器
let notFoundCount = 0;
const MAX_NOT_FOUND = 5; // 最多允许 5 次 404

// 在轮询回调中
wx.request({
  url: statusUrl,
  success: (res) => {
    if (res.statusCode === 404) {
      notFoundCount++;
      if (notFoundCount >= MAX_NOT_FOUND) {
        // 停止轮询
        clearInterval(pollTimer);
        wx.showToast({
          title: '诊断任务不存在或已完成，请查看历史记录',
          icon: 'none',
          duration: 3000
        });
        // 延迟跳转到历史记录页
        setTimeout(() => {
          wx.navigateTo({ url: '/pages/history/history' });
        }, 3000);
      }
      return;
    }
    
    // 重置计数器
    notFoundCount = 0;
    
    // 处理正常响应
    if (res.data.status === 'completed') {
      clearInterval(pollTimer);
      // 跳转到报告页
    }
  }
});
```

### 修复 3: 增加轮询间隔

```javascript
// 修复前
const pollInterval = 3000; // 3 秒

// 修复后 - 使用动态间隔
const pollInterval = 5000; // 5 秒
```

---

## 📊 修复效果预估

| 指标 | 修复前 | 修复后 | 改善 |
|------|--------|--------|------|
| 无效请求 | 无限次 | 最多 5 次 | -99% |
| 日志量 | 每分钟 20 条 404 | 最多 5 条 404 | -75% |
| 用户体验 | 无限等待 | 明确提示并跳转 | ✅ |
| 网络开销 | 持续浪费 | 最小化 | ✅ |
| 数据恢复 | 无法恢复 | 从数据库查询 | ✅ |

---

**报告生成时间**: 2026-02-22 10:00:00  
**修复状态**: ⏳ 待执行
