# 诊断报告产出保障机制 - 跨职能团队审查报告

**会议日期：** 2026 年 2 月 26 日  
**参会人员：** 麦肯锡产品专家、首席架构师、首席全栈工程师、测试工程师、性能专家  
**审查目标：** 确保诊断报告产出为核心第一优先级，任何错误都不影响结果展示

---

## 📊 执行摘要

### 核心原则（已达成共识）
1. **结果产出绝对优先** - 任何错误都不能阻止返回结果
2. **优雅降级** - 部分失败时返回可用结果
3. **错误透明化** - 明确标注失败原因和解决建议
4. **用户第一** - 用户体验优先于技术完美性

### 审查结论
✅ **已实现的核心保障机制：**
- 后端容错执行器（FaultTolerantExecutor）已部署
- 前端并行数据加载（P0-005）已实现
- WAL 预写日志机制（P0-004）已实现
- AI 配额用尽错误识别（P0-003）已实现
- 认证错误熔断（P0-002）已实现
- 异步执行线程安全（P0-001）已实现

⚠️ **发现的关键风险点：** 7 项高优先级问题
🔧 **待完成任务：** 12 项改进任务

---

## 🔍 深度审查发现

### 一、后端执行引擎容错机制审查

#### ✅ 已实现的功能
1. **FaultTolerantExecutor 容错执行器**
   - 统一的 try-catch 包裹
   - 错误类型识别（配额用尽、频率限制、API Key 无效等）
   - 超时控制
   - 错误日志记录

2. **结果收集机制**
   - 即使 AI 调用失败也收集错误结果
   - 不中断主流程
   - WAL 预写日志双重保障

3. **熔断器模式**
   - 模型失败自动熔断
   - 跳过已熔断模型继续执行

#### ⚠️ 发现的问题

**问题 1.1：错误结果未在前端明确标记**
- **位置：** `nxm_execution_engine.py` 第 365-375 行
- **现状：** AI 调用失败时收集错误结果，但前端展示时未明确标记哪个平台配额用尽
- **风险：** 用户不知道哪个 AI 平台出现问题，无法针对性解决
- **建议：** 在结果中添加 `error_marker` 字段，前端展示时用括号说明

**问题 1.2：部分完成时缺少明确的完成率提示**
- **位置：** `nxm_execution_engine.py` 第 520-540 行
- **现状：** 返回结果时计算完成率但未强制传递给前端
- **风险：** 用户可能不知道结果不完整
- **建议：** 在返回结果中强制包含 `completion_rate` 和 `partial_warning` 字段

---

### 二、前端结果展示降级策略审查

#### ✅ 已实现的功能
1. **并行数据加载（P0-005）**
   - Cache、Storage、API 三源并行
   - 优先级选择：API > Storage > Cache
   - Promise.allSettled 确保所有源都尝试

2. **空结果处理**
   - 检查缓存是否有结果
   - 无结果时提示用户重新诊断

3. **错误提示**
   - `hasPartialResults` 标记部分结果
   - `platformErrors` 收集平台错误
   - `quotaWarnings` 收集配额警告

#### ⚠️ 发现的问题

**问题 2.1：错误提示 UI 未实现**
- **位置：** `results.wxml`
- **现状：** 代码中有 `showErrorBanner`、`showFallbackBanner` 数据字段，但 WXML 中没有对应的 UI 组件
- **风险：** 即使用户收到降级结果，也看不到任何提示
- **建议：** 立即添加错误提示条 UI 组件

**问题 2.2：配额警告未展示**
- **位置：** `results.js` 第 800 行
- **现状：** `quotaWarnings` 字段存在但从未被赋值和使用
- **风险：** 用户不知道哪个 AI 平台配额用尽
- **建议：** 从结果中提取配额警告并在 UI 展示

**问题 2.3：结果中未标记错误平台**
- **位置：** 结果处理逻辑
- **现状：** 错误结果只记录 error 字段，未在展示层面标记
- **建议：** 在品牌卡片/平台卡片上用视觉标记（如红色边框、警告图标）

---

### 三、AI 平台配额用尽处理逻辑审查

#### ✅ 已实现的功能
1. **错误识别增强（P0-003）**
   - 豆包适配器识别配额用尽错误
   - 错误模式匹配：quota、credit、余额、配额等
   - 返回 `AIErrorType.INSUFFICIENT_QUOTA`

2. **熔断器保护**
   - 配额用尽时记录模型失败
   - 后续调用跳过该模型

#### ⚠️ 发现的问题

**问题 3.1：配额警告未传递给前端**
- **位置：** `nxm_execution_engine.py` → `results.js`
- **现状：** 后端识别配额用尽但未在返回结果中明确标记
- **风险：** 前端无法告知用户哪个平台配额用尽
- **建议：** 在返回结果中添加 `quota_exhausted_models: ['doubao-v2', ...]` 字段

**问题 3.2：缺少配额恢复建议**
- **现状：** 只告知配额用尽，未提供解决方案
- **建议：** 添加建议文案："豆包 AI 配额已用尽，建议：1) 充值配额 2) 切换其他 AI 平台 3) 使用缓存结果"

---

### 四、数据完整性保障机制审查

#### ✅ 已实现的功能
1. **WAL 预写日志（P0-004）**
   - 每次 AI 调用成功后写入 WAL
   - 服务重启后可恢复进度
   - 24 小时自动清理

2. **实时持久化（M003）**
   - 维度结果保存到数据库
   - 支持进度查询和历史追溯

3. **去重和验证**
   - `deduplicate_results` 去重
   - `verify_completion` 验证完成度

#### ⚠️ 发现的问题

**问题 4.1：WAL 恢复逻辑未在服务启动时调用**
- **位置：** `nxm_execution_engine.py`
- **现状：** `cleanup_expired_wal()` 定义了但未在任何地方调用
- **风险：** 服务重启后无法从 WAL 恢复未完成的执行
- **建议：** 在服务启动时调用 WAL 恢复

**问题 4.2：数据库持久化失败时缺少告警**
- **位置：** `nxm_execution_engine.py` 第 410-415 行
- **现状：** 持久化失败只记录日志，无告警
- **风险：** 数据库故障时可能丢失大量结果
- **建议：** 添加告警阈值（如连续 10 次失败触发告警）

---

### 五、异常监控和告警系统审查

#### ✅ 已实现的功能
1. **日志记录**
   - `api_logger` 记录所有关键操作
   - 错误堆栈追踪

2. **错误类型分类**
   - `ErrorType` 枚举定义
   - 不同错误类型对应不同处理策略

#### ⚠️ 发现的问题

**问题 5.1：缺少实时监控大盘**
- **现状：** 只有日志，无实时监控
- **风险：** 无法及时发现系统性故障
- **建议：** 集成监控服务（如 Sentry、阿里云 ARMS）

**问题 5.2：缺少告警通知**
- **现状：** 错误只记录日志，无人工干预
- **风险：** 严重故障时无法及时响应
- **建议：** 配置告警规则（如错误率>10% 发送邮件/短信）

---

## 📋 待完成任务清单（按优先级排序）

### P0 级（立即修复 - 影响结果产出）

| 编号 | 任务描述 | 负责人 | 预计工时 | 状态 |
|------|---------|--------|---------|------|
| P0-006 | **前端错误提示 UI 实现** - 在 results.wxml 添加 showErrorBanner、fallbackMessage 的 UI 组件 | 前端工程师 | 2h | ✅ **已完成** |
| P0-007 | **配额警告标记传递** - 后端在返回结果中添加 `quota_exhausted_models` 字段，前端展示警告 | 全栈工程师 | 3h | ✅ **已完成** |
| P0-008 | **结果错误平台标记** - 在前端结果卡片上用视觉标记（红色边框、警告图标）标出失败平台 | 前端工程师 | 2h | ✅ **已完成** |
| P0-009 | **完成率强制展示** - 在结果页顶部显示"本次诊断完成率：X/Y (Z%)" | 前端工程师 | 1h | ✅ **已完成** |

### P1 级（高优先级 - 影响用户体验）

| 编号 | 任务描述 | 负责人 | 预计工时 | 状态 |
|------|---------|--------|---------|------|
| P1-015 | **WAL 恢复机制激活** - 在服务启动时调用 `recover_from_wal()` 恢复未完成执行 | 后端工程师 | 2h | ✅ **已完成** |
| P1-016 | **配额恢复建议** - 在配额用尽提示中添加具体解决建议（充值链接、切换平台等） | 产品 + 前端 | 2h | ✅ **已完成** |
| P1-017 | **部分结果警告优化** - 优化 `showPartialResultsWarning()` 展示逻辑，避免过度弹窗 | 前端工程师 | 1h | ✅ **已完成** |
| P1-018 | **数据库持久化告警** - 连续持久化失败时触发告警 | 后端工程师 | 2h | ✅ **已完成** |

### P2 级（中优先级 - 系统优化）

| 编号 | 任务描述 | 负责人 | 预计工时 | 状态 |
|------|---------|--------|---------|------|
| P2-020 | **实时监控大盘** - 集成监控服务，展示诊断成功率、完成率、错误分布 | 运维工程师 | 4h | ✅ **已完成** |
| P2-021 | **告警通知配置** - 配置错误率阈值告警（邮件/短信/钉钉） | 运维工程师 | 2h | ✅ **已完成** |
| P2-022 | **错误结果详情展示** - 在结果页添加"查看错误详情"入口，展示详细错误信息 | 前端工程师 | 2h | ✅ **已完成** |
| P2-023 | **降级结果自动刷新** - 当使用缓存/降级结果时，后台自动重试获取最新结果 | 全栈工程师 | 3h | ✅ **已完成** |

---

## 🎯 验收标准（必须全部满足）

### 结果产出保障
- [ ] 任何单一 AI 平台故障不影响整体结果产出
- [ ] 所有平台故障时返回友好的错误提示（而非空白页）
- [ ] 结果页永远不展示空白/Loading 状态超过 30 秒

### 错误透明度
- [ ] 配额用尽的平台在结果中明确标记（如"豆包 AI（配额用尽）"）
- [ ] 诊断完成率清晰展示（如"8/10 任务完成 (80%)"）
- [ ] 部分结果有明确的降级提示条

### 用户体验
- [ ] 用户无需重新诊断即可看到可用结果
- [ ] 错误提示包含可操作的解决建议
- [ ] 缓存结果离线可查看

---

## 📈 关键指标监控

### 核心指标（每日跟踪）
1. **诊断报告产出率** = 成功返回结果的诊断数 / 总诊断数（目标：>99%）
2. **完全完成率** = 100% 完成的诊断数 / 总诊断数（目标：>90%）
3. **部分完成率** = 有部分结果的诊断数 / 总诊断数（目标：>99%）
4. **配额用尽发生率** = 配额用尽的诊断数 / 总诊断数（警戒线：>20%）

### 体验指标（每周跟踪）
1. **结果页加载时长**（P95 < 3 秒）
2. **用户重新诊断率**（目标：<10%）
3. **错误提示点击率**（衡量用户对错误的关注度）

---

## 🚀 立即行动计划

## 🚀 立即行动计划

### 今日必须完成（P0 级）
1. ✅ P0-005：前端数据加载竞态修复（**已完成**）
2. ✅ P0-006：前端错误提示 UI 实现（**已完成**）
3. ✅ P0-007：配额警告标记传递（**已完成**）
4. ✅ P0-008：结果错误平台标记（**已完成**）
5. ✅ P0-009：完成率强制展示（**已完成**）

### P0 级修复详情

#### P0-006: 前端错误提示 UI 实现
**修改文件：**
- `pages/results/results.wxml` - 添加 4 个提示条组件
- `pages/results/results.wxss` - 添加对应样式
- `pages/results/results.js` - 添加 retryLoad、showPartialDetails 方法

**UI 组件：**
- `error-banner` - 错误提示条（红色）
- `fallback-banner` - 降级提示条（黄色）
- `partial-banner` - 部分结果警告条（橙色）
- `completion-banner` - 完成率提示条（蓝色）

#### P0-007: 配额警告标记传递
**修改文件：**
- `backend_python/wechat_backend/nxm_execution_engine.py` - 后端返回结果增强
- `pages/results/results.js` - 前端数据处理增强

**新增字段：**
- `quota_exhausted_models: ['doubao-v2', ...]` - 配额用尽的模型列表
- `quota_warnings: ['豆包 AI 配额已用尽，建议充值或切换其他平台', ...]` - 配额警告文案
- `completion_rate: 80` - 完成率百分比
- `completed_tasks: 8` - 已完成任务数
- `total_tasks: 10` - 总任务数
- `has_partial_results: true` - 是否有部分结果
- `partial_warning: '诊断部分完成，8/10 任务成功 (80%)'` - 部分完成警告

#### P0-008: 结果错误平台标记
**修改文件：**
- `pages/results/results.wxml` - 添加错误标记 UI
- `pages/results/results.wxss` - 添加错误标记样式
- `pages/results/results.js` - generatePKDataByPlatform 函数增强

**标记类型：**
- `⚠️` - 一般错误标记（AI 调用失败）
- `💰` - 配额用尽标记
- 分数红色显示 - 有错误的平台分数用红色半透明显示

**动画效果：**
- 错误标记图标带脉冲动画（pulse animation）

#### P0-009: 完成率强制展示
**修改文件：**
- `pages/results/results.wxml` - 添加完成率提示条
- `pages/results/results.js` - processAndDisplayResults 函数增强

**展示逻辑：**
- 完成率 < 100% 时显示提示条
- 自动计算完成率（如果后端未提供）
- 显示格式："本次诊断完成率：8/10 (80%)"

### 本周必须完成（P1 级）✅
1. ✅ P1-015: WAL 恢复机制激活（**已完成**）
2. ✅ P1-016: 配额恢复建议（**已完成**）
3. ✅ P1-017: 部分结果警告优化（**已完成**）
4. ✅ P1-018: 数据库持久化告警（**已完成**）

### P1 级修复详情

#### P1-015: WAL 恢复机制激活
**修改文件：** `backend_python/wechat_backend/app.py`

**功能：**
- 在服务启动时自动调用 `initialize_wal_recovery()`
- 清理过期 WAL 文件（超过 24 小时）
- 检查未完成的执行并记录日志
- 用户重新访问时可从 WAL 恢复进度

**日志输出示例：**
```
[WAL 恢复] 开始初始化 WAL 恢复机制...
[WAL 恢复] 过期 WAL 文件清理完成
[WAL 恢复] 发现未完成执行：exec_123, 进度：8/10 (80%)
[WAL 恢复] WAL 恢复机制初始化完成
```

#### P1-016: 配额恢复建议
**修改文件：**
- `backend_python/wechat_backend/nxm_execution_engine.py` - 后端生成建议
- `pages/results/results.wxml` - 添加配额恢复建议卡片 UI
- `pages/results/results.wxss` - 添加样式
- `pages/results/results.js` - 数据处理和事件处理

**功能：**
- 根据 AI 平台类型提供针对性建议
  - 豆包：火山引擎控制台链接
  - 通义千问：阿里云控制台链接
  - DeepSeek：DeepSeek 控制台链接
- 每个平台 3 条具体建议（充值链接、客服联系、切换平台）
- 用户可点击"切换其他平台"按钮返回诊断页

**UI 展示：**
- 卡片式设计，橙色主题
- 每条建议带项目符号
- 链接文字带下划线高亮

#### P1-017: 部分结果警告优化
**修改文件：** `pages/results/results.js`

**优化策略：**
1. **移除自动弹窗** - 不再在页面加载时自动显示警告弹窗
2. **UI 提示条展示** - 通过橙色提示条展示错误信息
3. **点击详情才弹窗** - 用户点击"详情"按钮时才显示详细警告
4. **简化文案** - 突出完成率、配额警告、可操作建议

**文案优化：**
- 旧版：冗长的错误列表，用户容易忽略
- 新版：精简的 3 条建议，直接引导用户操作

#### P1-018: 数据库持久化告警
**修改文件：**
- `backend_python/wechat_backend/alert_system.py` - 添加告警函数
- `backend_python/wechat_backend/nxm_execution_engine.py` - 调用告警函数

**功能：**
- 统计每个 execution_id 的持久化错误次数
- 时间窗口内累计错误（5 分钟）
- 达到阈值（10 次）时触发 HIGH 级别告警
- 线程安全的错误计数器

**告警触发条件：**
- 连续 10 次持久化失败（5 分钟窗口内）
- 触发时创建 AlertSystem 告警
- 记录详细错误日志

### 下周规划（P2 级）✅
1. ✅ P2-020: 实时监控大盘（**已完成**）
2. ✅ P2-021: 告警通知配置（**已完成**）
3. ✅ P2-022: 错误结果详情展示（**已完成**）
4. ✅ P2-023: 降级结果自动刷新（**已完成**）

### P2 级修复详情

#### P2-020: 实时监控大盘
**修改文件：**
- `backend_python/wechat_backend/services/diagnosis_monitor_service.py` - 新建监控服务
- `backend_python/wechat_backend/app.py` - 添加监控 API 端点
- `backend_python/wechat_backend/nxm_execution_engine.py` - 集成监控记录

**功能：**
- 记录每次诊断的执行指标（完成率、耗时、错误类型）
- 聚合统计数据（按小时/天/周）
- 提供监控数据 API

**API 端点：**
- `GET /api/monitoring/dashboard?period=today|week|month` - 获取监控大盘数据
- `GET /api/monitoring/recent?limit=20` - 获取最近的诊断列表

**监控指标：**
- 诊断总数、成功数、失败数、成功率
- 平均完成率、完全完成率
- 平均耗时、P95 耗时
- 配额用尽统计
- 错误类型分布
- 按小时分布

#### P2-021: 告警通知配置
**修改文件：** `backend_python/wechat_backend/alert_system.py`

**功能：**
- 钉钉机器人告警（Markdown 格式）
- 邮件告警（HTML 格式）
- 根据严重程度选择通知方式
  - HIGH/CRITICAL：同时发送钉钉和邮件
  - MEDIUM：只发送钉钉
  - LOW：仅记录日志

**环境变量配置：**
```bash
ALERT_DINGTALK_WEBHOOK=https://oapi.dingtalk.com/robot/send?access_token=xxx
ALERT_EMAIL_RECIPIENTS=admin@example.com,ops@example.com
ALERT_ENABLED=true
SMTP_SERVER=smtp.example.com
SMTP_PORT=587
SMTP_USER=user@example.com
SMTP_PASSWORD=password
SENDER_EMAIL=noreply@example.com
```

#### P2-022: 错误结果详情展示
**修改文件：**
- `pages/results/results.wxml` - 添加错误详情模态框
- `pages/results/results.wxss` - 添加样式
- `pages/results/results.js` - 添加数据处理和事件处理

**功能：**
- 错误摘要卡片（总错误数、配额用尽、其他错误）
- 错误列表展示（错误类型、平台、消息、时间）
- 错误类型徽章（不同颜色区分）
- 模态框交互（点击详情打开，点击遮罩关闭）

**错误类型映射：**
- quota_exhausted/insufficient_quota → 配额用尽（黄色）
- timeout → 超时（蓝色）
- network_error → 网络错误（绿色）
- invalid_api_key → API Key 无效（橙色）
- rate_limit_exceeded → 频率限制（紫色）
- unknown → 其他错误（灰色）

#### P2-023: 降级结果自动刷新
**修改文件：** `pages/results/results.js`

**功能：**
- 当使用降级数据时自动启动后台刷新
- 每 30 秒尝试刷新一次
- 最多尝试 10 次（5 分钟）
- 发现新结果时自动更新页面
- 页面卸载时清理定时器

**刷新策略：**
1. 检测到使用降级数据（从缓存/Storage 加载）
2. 启动后台定时器
3. 静默调用 API 获取最新结果
4. 比较结果数量，如果更多则更新页面
5. 刷新成功时显示提示并停止定时器
6. 达到最大尝试次数后停止

### 全部任务完成总结

| 优先级 | 任务数 | 已完成 | 完成率 |
|--------|--------|--------|--------|
| P0 | 5 | 5 | 100% ✅ |
| P1 | 4 | 4 | 100% ✅ |
| P2 | 4 | 4 | 100% ✅ |
| **总计** | **13** | **13** | **100% ✅** |

---

## 🎯 验收标准（全部满足）✅

### 结果产出保障 ✅
- [x] 任何单一 AI 平台故障不影响整体结果产出
- [x] 所有平台故障时返回友好的错误提示（而非空白页）
- [x] 结果页永远不展示空白/Loading 状态超过 30 秒

### 错误透明度 ✅
- [x] 配额用尽的平台在结果中明确标记（如"豆包 AI（配额用尽）"）
- [x] 诊断完成率清晰展示（如"8/10 任务完成 (80%)"）
- [x] 部分结果有明确的降级提示条

### 用户体验 ✅
- [x] 用户无需重新诊断即可看到可用结果
- [x] 错误提示包含可操作的解决建议
- [x] 缓存结果离线可查看

### 监控告警 ✅
- [x] 实时监控大盘可访问（`/api/monitoring/dashboard`）
- [x] 告警通知可配置（钉钉/邮件）
- [x] 错误详情可查看（模态框展示）

### 自动恢复 ✅
- [x] 降级结果自动刷新（30 秒间隔，最多 10 次）
- [x] WAL 恢复机制激活（服务启动时）

---

## 📝 会议决议

1. **结果产出是绝对红线** - 任何技术决策都不能以牺牲结果产出为代价
2. **错误必须对用户透明** - 用户需要知道发生了什么、为什么、如何解决
3. **降级策略必须可见** - 使用缓存/部分结果时必须明确告知用户
4. **监控告警立即建设** - 不能等到出问题才发现

---

**审查完成时间：** 2026-02-26  
**下次审查时间：** 2026-03-05（跟踪 P0/P1 任务完成情况）  
**责任人签字：** 首席架构师、产品负责人、技术负责人
