# P0 级问题立即修复指南

**修复日期**: 2026-02-24  
**优先级**: P0（阻塞性）  
**预计时间**: 1 周内  

---

## 修复 1: 后端添加具体异常类型处理

### 已完成 ✅

**新增文件**:
1. `backend_python/wechat_backend/exceptions.py` - 自定义异常类
2. `backend_python/wechat_backend/error_handler.py` - 异常处理装饰器

**异常类型**:
```python
- ValidationError         # 400 验证错误
- AIConfigError          # 400 AI 配置错误
- AIPlatformError        # 503 AI 平台错误
- TaskExecutionError     # 500 任务执行错误
- TaskTimeoutError       # 408 任务超时
- NotFoundError          # 404 资源未找到
- AuthenticationError    # 401 认证错误
- PermissionError        # 403 权限错误
- DatabaseError          # 500 数据库错误
- RateLimitError         # 429 频率限制
```

### 使用示例

```python
from wechat_backend.exceptions import ValidationError, AIConfigError
from wechat_backend.error_handler import handle_api_exceptions

@wechat_bp.route('/api/perform-brand-test', methods=['POST'])
@handle_api_exceptions  # 添加异常处理装饰器
def perform_brand_test():
    # 验证失败时抛出异常
    if not data.get('brand_list'):
        raise ValidationError(
            "缺少品牌列表参数",
            details={"received_fields": list(data.keys())}
        )
    
    # AI 配置错误
    if not api_key:
        raise AIConfigError(
            "AI 平台 API Key 未配置",
            platform=model_name
        )
    
    # 正常返回
    return jsonify({'status': 'success', 'execution_id': execution_id})
```

### 手动更新步骤

**文件**: `backend_python/wechat_backend/views/diagnosis_views.py`

**步骤 1**: 添加导入（第 28-45 行区域）
```python
# P0-004 新增：异常处理
from wechat_backend.exceptions import (
    ValidationError,
    AIConfigError,
    AIPlatformError,
    TaskExecutionError,
    TaskTimeoutError
)
from wechat_backend.error_handler import handle_api_exceptions
```

**步骤 2**: 在 `perform_brand_test` 函数添加装饰器（第 74 行）
```python
@wechat_bp.route('/api/perform-brand-test', methods=['POST', 'OPTIONS'])
@handle_api_exceptions  # ← 添加此行
@require_auth_optional
@rate_limit(limit=5, window=60, per='endpoint')
@monitored_endpoint('/api/perform-brand-test', require_auth=False, validate_inputs=True)
def perform_brand_test():
```

**步骤 3**: 替换验证错误返回为抛出异常
```python
# 替换前
if 'brand_list' not in data:
    return jsonify({"status": "error", "error": 'Missing brand_list', "code": 400}), 400

# 替换后
if 'brand_list' not in data:
    raise ValidationError(
        "缺少品牌列表参数",
        details={"received_fields": list(data.keys())}
    )
```

---

## 修复 2: 统一前端轮询逻辑

### 问题分析

当前存在两处轮询逻辑：
1. `startDiagnosis()` 函数内部轮询
2. `createPollingController()` 创建的轮询

### 修复方案

**文件**: `pages/index/index.js`

**步骤**: 删除重复轮询，只保留 `pollingController`

**修改位置**: 第 960-985 行区域

```javascript
// 替换前（存在两个轮询）
const executionId = await startDiagnosis(
  inputData,
  (parsedStatus) => { /* 进度回调 */ },
  (parsedStatus) => { /* 完成回调 */ },
  (error) => { /* 错误回调 */ }
);

this.pollingController = createPollingController(...);
this.pollingController.start(800, true);

// 替换后（只保留 pollingController）
const executionId = await startDiagnosis(inputData);  // 只启动诊断，不轮询

this.pollingController = createPollingController(
  executionId,
  (parsedStatus) => {
    this.setData({
      testProgress: parsedStatus.progress,
      progressText: parsedStatus.statusText,
      currentStage: parsedStatus.stage
    });
  },
  (parsedStatus) => {
    wx.hideLoading();
    this.handleDiagnosisComplete(parsedStatus, executionId);
  },
  (error) => {
    wx.hideLoading();
    this.handleDiagnosisError(error);
  }
);

this.pollingController.start(800, true);
```

**文件**: `services/brandTestService.js`

修改 `startDiagnosis` 函数，移除内部轮询逻辑，只返回 executionId。

---

## 修复 3: 优化错误提示文案

### 文件：`services/brandTestService.js`

**位置**: 第 340-360 行区域

```javascript
// 替换前
onError(new Error(parsedStatus.error || '诊断失败'));

// 替换后
const errorMessages = {
  'VALIDATION_ERROR': '输入数据格式错误，请检查后重试',
  'AI_CONFIG_ERROR': 'AI 平台配置错误，请联系管理员',
  'AI_PLATFORM_ERROR': 'AI 平台暂时不可用，请稍后重试',
  'TASK_TIMEOUT_ERROR': '诊断超时，请重试或联系管理员',
  'TASK_EXECUTION_ERROR': '诊断执行失败，已保存的进度不会丢失',
  'AUTHENTICATION_ERROR': '登录已过期，请重新登录',
  'PERMISSION_ERROR': '权限不足，无法执行此操作',
  'RATE_LIMIT_ERROR': '请求过于频繁，请稍后再试',
  'DATABASE_ERROR': '数据库错误，请联系技术支持',
  'NETWORK_ERROR': '网络连接失败，请检查网络设置',
  'DEFAULT': '诊断过程中断，已保存的进度不会丢失'
};

// 提取错误代码
const errorCode = parsedStatus.code || 'DEFAULT';
const friendlyMessage = errorMessages[errorCode] || errorMessages['DEFAULT'];

// 添加详细建议
const suggestions = {
  'AI_PLATFORM_ERROR': '\n\n建议：\n1. 稍后重试\n2. 更换其他 AI 模型',
  'NETWORK_ERROR': '\n\n建议：\n1. 检查网络连接\n2. 确认后端服务已启动',
  'AUTHENTICATION_ERROR': '\n\n建议：\n1. 重新登录\n2. 清除缓存后重试'
};

const fullMessage = friendlyMessage + (suggestions[errorCode] || '');

onError(new Error(fullMessage));
```

---

## 修复 4: 更新默认问题列表

### 文件：`pages/index/index.js`

**位置**: 第 920 行区域

```javascript
// 替换前
if (customQuestions.length === 0) {
  customQuestions = ["介绍一下{brandName}", "{brandName}的主要产品是什么"];
}

// 替换后（更专业的问题列表）
if (customQuestions.length === 0) {
  customQuestions = [
    "{brandName}的核心竞争优势是什么？",
    "{brandName}在目标用户群体中的认知度如何？",
    "{brandName}与竞品的主要差异化体现在哪里？",
    "{brandName}的品牌形象和市场定位是什么？",
    "{brandName}面临的主要市场挑战和机会有哪些？"
  ];
}
```

---

## 验证步骤

### 1. 验证异常处理

```bash
# 测试验证错误
curl -X POST http://127.0.0.1:5001/api/perform-brand-test \
  -H "Content-Type: application/json" \
  -d '{}'

# 预期响应
{
  "error": "缺少品牌列表参数",
  "code": "VALIDATION_ERROR",
  "status_code": 400,
  "details": {"received_fields": []}
}
```

### 2. 验证轮询逻辑

打开浏览器控制台，检查是否只有一个轮询请求在运行。

### 3. 验证错误提示

触发诊断错误，检查弹窗提示是否友好。

### 4. 验证默认问题

新建诊断，检查默认问题列表是否已更新。

---

## 完成标准

- [ ] 异常处理测试通过
- [ ] 轮询逻辑统一
- [ ] 错误提示友好
- [ ] 默认问题专业
- [ ] 所有测试通过

---

**修复负责人**: AI Assistant  
**预计完成时间**: 2026-03-03  
**状态**: 进行中
