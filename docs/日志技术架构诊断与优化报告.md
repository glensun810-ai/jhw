# æ—¥å¿—ä¿å­˜æŠ€æœ¯æ¶æ„æ·±åº¦è¯Šæ–­ä¸ä¼˜åŒ–æ–¹æ¡ˆ

**æŠ¥å‘Šæ—¥æœŸ**: 2026 å¹´ 2 æœˆ 19 æ—¥  
**æŠ¥å‘Šç±»å‹**: æŠ€æœ¯æ¶æ„è¯Šæ–­ä¸ä¼˜åŒ–æ–¹æ¡ˆ  
**ä¼˜å…ˆçº§**: P0 - å…³é”®åŸºç¡€è®¾æ–½ä¼˜åŒ–

---

## æ‰§è¡Œæ‘˜è¦

å½“å‰é¡¹ç›®çš„æ—¥å¿—ç³»ç»Ÿå­˜åœ¨**æ¶æ„ç¢ç‰‡åŒ–ã€æ€§èƒ½ç“¶é¢ˆã€å¯ç»´æŠ¤æ€§é£é™©**ä¸‰å¤§æ ¸å¿ƒé—®é¢˜ã€‚ç³»ç»ŸåŒæ—¶è¿è¡Œ 5 å¥—ç‹¬ç«‹çš„æ—¥å¿—è®°å½•æœºåˆ¶ï¼Œç¼ºä¹ç»Ÿä¸€æ²»ç†ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹å­˜åœ¨ä¸¥é‡çš„æ€§èƒ½éšæ‚£å’Œæ•°æ®ä¸€è‡´æ€§é£é™©ã€‚

### æ ¸å¿ƒé—®é¢˜æ¦‚è§ˆ

| é—®é¢˜ç±»åˆ« | é—®é¢˜æè¿° | é£é™©ç­‰çº§ | ä¼˜å…ˆçº§ |
|---------|---------|---------|-------|
| æ¶æ„ç¢ç‰‡åŒ– | 5 å¥—ç‹¬ç«‹æ—¥å¿—ç³»ç»Ÿï¼Œæ— ç»Ÿä¸€é…ç½®ä¸­å¿ƒ | ğŸ”´ é«˜ | P0 |
| åŒæ­¥é˜»å¡å†™å…¥ | ä¸»çº¿ç¨‹é˜»å¡ï¼Œé«˜å¹¶å‘ä¸‹æ€§èƒ½åŠ£åŒ– | ğŸ”´ é«˜ | P0 |
| é”ç«äº‰ç“¶é¢ˆ | å…¨å±€å†™é”å¯¼è‡´çº¿ç¨‹ç«äº‰ | ğŸŸ¡ ä¸­ | P1 |
| print() åæ¨¡å¼ | ä½¿ç”¨ print è€Œéæ ‡å‡† logging | ğŸŸ¡ ä¸­ | P1 |
| ç¡¬ç¼–ç è·¯å¾„ | å¤šç¯å¢ƒéƒ¨ç½²å›°éš¾ | ğŸŸ¡ ä¸­ | P2 |
| æ— å¤–éƒ¨é›†æˆ | é›¶é›†æˆ ELK/Sentry/Prometheus | ğŸŸ¡ ä¸­ | P2 |

---

## ä¸€ã€å½“å‰æŠ€æœ¯æ¶æ„ç›˜ç‚¹

### 1.1 æ—¥å¿—ç³»ç»Ÿæ¶æ„ç°çŠ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å½“å‰æ—¥å¿—æ¶æ„ï¼ˆç¢ç‰‡åŒ–ï¼‰                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ logging_config  â”‚  â”‚logging_enhance  â”‚  â”‚ai_response_log  â”‚          â”‚
â”‚  â”‚ æ ‡å‡† Python æ—¥å¿—   â”‚  â”‚ ç»“æ„åŒ– JSON æ—¥å¿—   â”‚  â”‚ AI å“åº” JSONL æ—¥å¿— â”‚          â”‚
â”‚  â”‚ logs/app.log    â”‚  â”‚ å®¡è®¡/å®‰å…¨/API     â”‚  â”‚ data/ai_responsesâ”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚           â”‚                    â”‚                    â”‚                     â”‚
â”‚           â–¼                    â–¼                    â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   logger.py     â”‚  â”‚  debug_manager  â”‚  â”‚ gco_validator   â”‚          â”‚
â”‚  â”‚ print() è°ƒè¯•æ—¥å¿— â”‚  â”‚  è°ƒè¯•çŠ¶æ€è¿½è¸ª    â”‚  â”‚ ç‹¬ç«‹æ—¥å¿—ç³»ç»Ÿ    â”‚          â”‚
â”‚  â”‚  stdout         â”‚  â”‚  ä¸´æ—¶æ–‡ä»¶       â”‚  â”‚  logs/app.log   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                          â”‚
â”‚  âŒ æ— ç»Ÿä¸€é…ç½®ä¸­å¿ƒ  âŒ æ— ç»Ÿä¸€è¾“å‡ºæ ¼å¼  âŒ æ— ç»Ÿä¸€èšåˆå±‚                      â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ—¥å¿—æ–‡ä»¶åˆ†å¸ƒ

| æ—¥å¿—ç±»å‹ | å­˜å‚¨è·¯å¾„ | æ ¼å¼ | è½®è½¬ç­–ç•¥ |
|---------|---------|------|---------|
| åº”ç”¨æ—¥å¿— | `logs/app.log` | æ–‡æœ¬ | 10MB/5 å¤‡ä»½ |
| AI å“åº”æ—¥å¿— | `data/ai_responses/ai_responses.jsonl` | JSONL | 100MB |
| å¢å¼º AI æ—¥å¿— | `data/ai_responses_enhanced/users/{user_id}/` | JSONL | 30 å¤© +GZIP |
| æ¸…ç†è°ƒåº¦æ—¥å¿— | `logs/cleanup_scheduler.log` | æ–‡æœ¬ | æ— æ˜ç¡®ç­–ç•¥ |
| GCO éªŒè¯å™¨æ—¥å¿— | `gco_validator/logs/app.log` | æ–‡æœ¬ | ç‹¬ç«‹é…ç½® |

### 1.3 ç°æœ‰æ—¥å¿—ç³»ç»Ÿæ¸…å•

| æ¨¡å—æ–‡ä»¶ | ç»å¯¹è·¯å¾„ | åŠŸèƒ½æè¿° |
|---------|---------|---------|
| logging_config.py | `backend_python/wechat_backend/logging_config.py` | æ ‡å‡† Python logging é…ç½® |
| logging_enhancements.py | `backend_python/wechat_backend/monitoring/logging_enhancements.py` | ç»“æ„åŒ– JSON æ—¥å¿—ï¼ˆå®¡è®¡/å®‰å…¨ï¼‰ |
| ai_response_logger_enhanced.py | `backend_python/utils/ai_response_logger_enhanced.py` | AI å“åº”ä¸“ç”¨ JSONL æ—¥å¿— |
| ai_response_logger_v2.py | `backend_python/utils/ai_response_logger_v2.py` | AI å“åº”æ—¥å¿— V2 ç‰ˆæœ¬ |
| logger.py | `backend_python/utils/logger.py` | print() è°ƒè¯•æ—¥å¿— |
| debug_manager.py | `backend_python/utils/debug_manager.py` | è°ƒè¯•çŠ¶æ€è¿½è¸ª |
| gco_validator/core/logging.py | `backend_python/gco_validator/core/logging.py` | GCO éªŒè¯å™¨ç‹¬ç«‹æ—¥å¿— |

---

## äºŒã€æ ¸å¿ƒæŠ€æœ¯é—®é¢˜è¯Šæ–­

### 2.1 æ¶æ„å±‚é¢é—®é¢˜ï¼ˆä¸¥é‡ï¼‰

#### é—®é¢˜ 1ï¼šæ—¥å¿—ç³»ç»Ÿç¢ç‰‡åŒ– - **é£é™©ç­‰çº§ï¼šğŸ”´ é«˜**

```python
# 5 å¥—ç‹¬ç«‹æ—¥å¿—ç³»ç»Ÿï¼Œæ— ç»Ÿä¸€æ²»ç†
â”œâ”€â”€ logging_config.py          # ç³»ç»Ÿ 1: æ ‡å‡† Python logging
â”œâ”€â”€ logging_enhancements.py    # ç³»ç»Ÿ 2: ç»“æ„åŒ– JSON logging
â”œâ”€â”€ ai_response_logger_enhanced.py  # ç³»ç»Ÿ 3: AI å“åº”ä¸“ç”¨
â”œâ”€â”€ logger.py                  # ç³»ç»Ÿ 4: print() è°ƒè¯•
â””â”€â”€ gco_validator/core/logging.py   # ç³»ç»Ÿ 5: GCO ç‹¬ç«‹ç³»ç»Ÿ
```

**å½±å“åˆ†æï¼š**
- **è¿ç»´å¤æ‚åº¦**: 5 å¥—é…ç½®ã€5 å¥—æ ¼å¼ã€5 å¥—è½®è½¬ç­–ç•¥
- **æ—¥å¿—å…³è”å›°éš¾**: æ— æ³•è·¨ç³»ç»Ÿè¿½è¸ªå•æ¬¡è¯·æ±‚é“¾è·¯
- **èµ„æºæµªè´¹**: é‡å¤çš„æ–‡ä»¶ IO æ“ä½œï¼Œé‡å¤çš„åºåˆ—åŒ–å¼€é”€

#### é—®é¢˜ 2ï¼šåŒæ­¥é˜»å¡å¼æ—¥å¿—å†™å…¥ - **é£é™©ç­‰çº§ï¼šğŸ”´ é«˜**

```python
# ai_response_logger_enhanced.py:158-163
def log_response(self, question: str, response: str, ...):
    # ... æ„å»º record ...
    
    # âŒ åŒæ­¥æ–‡ä»¶å†™å…¥ï¼Œé˜»å¡ä¸»çº¿ç¨‹
    with self.write_lock:
        with open(log_file, 'a', encoding='utf-8') as f:
            f.write(json.dumps(record, ensure_ascii=False) + '\n')
```

**æ€§èƒ½å½±å“é‡åŒ–ï¼š**

| åœºæ™¯ | å•æ¬¡å†™å…¥è€—æ—¶ | å¹¶å‘ 100 è¯·æ±‚å½±å“ |
|------|------------|-----------------|
| ç©ºé—²çŠ¶æ€ | ~2-5ms | å¯æ¥å— |
| é«˜å¹¶å‘ | ~50-200msï¼ˆé”ç«äº‰ï¼‰ | **è¯·æ±‚å»¶è¿Ÿå¢åŠ  40%** |
| ç£ç›˜ IO é«˜å³° | ~500ms+ | **å¯èƒ½è§¦å‘è¶…æ—¶** |

#### é—®é¢˜ 3ï¼šé”ç«äº‰å¯¼è‡´çš„æ€§èƒ½ç“¶é¢ˆ - **é£é™©ç­‰çº§ï¼šğŸŸ¡ ä¸­**

```python
# å…¨å±€å†™é”ï¼Œæ‰€æœ‰çº¿ç¨‹ç«äº‰
self.write_lock = threading.Lock()

# ä»»ä½•æ—¥å¿—å†™å…¥éƒ½éœ€è¦è·å–åŒä¸€æŠŠé”
with self.write_lock:
    # ä¸´ç•ŒåŒºåŒ…å«æ–‡ä»¶ IOï¼ˆæ…¢æ“ä½œï¼‰
    with open(log_file, 'a', encoding='utf-8') as f:
        f.write(...)
```

**é—®é¢˜æœ¬è´¨**: å°†æ…¢æ“ä½œï¼ˆæ–‡ä»¶ IOï¼‰æ”¾å…¥ä¸´ç•ŒåŒºï¼Œå¯¼è‡´é”æŒæœ‰æ—¶é—´è¿‡é•¿ã€‚

### 2.2 ä»£ç è´¨é‡å•é¡Œï¼ˆä¸­ç­‰ï¼‰

#### é—®é¢˜ 4ï¼šprint() åæ¨¡å¼ - **é£é™©ç­‰çº§ï¼šğŸŸ¡ ä¸­**

```python
# logger.py:13-17
def debug_log(module_name, execution_id=None, message=""):
    if not ENABLE_DEBUG_AI_CODE:
        return
    # âŒ ä½¿ç”¨ print è€Œéæ ‡å‡† logging
    print(formatted_message)
    sys.stdout.flush()  # æ‰‹åŠ¨åˆ·æ–°
```

**å±å®³ï¼š**
- æ— æ³•æ§åˆ¶è¾“å‡ºçº§åˆ«å’Œç›®çš„åœ°
- ç”Ÿäº§ç¯å¢ƒå¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯
- æ— æ³•ä¸æ—¥å¿—èšåˆç³»ç»Ÿé›†æˆ

#### é—®é¢˜ 5ï¼šç¡¬ç¼–ç è·¯å¾„ - **é£é™©ç­‰çº§ï¼šğŸŸ¡ ä¸­**

```python
# å¤šå¤„ç¡¬ç¼–ç 
DEFAULT_LOG_DIR = Path(__file__).parent.parent / "data" / "ai_responses"
logs_dir = Path(__file__).parent.parent / 'logs'
```

**å½±å“**: å®¹å™¨åŒ–éƒ¨ç½²ã€å¤šç¯å¢ƒé…ç½®å›°éš¾ã€‚

#### é—®é¢˜ 6ï¼šå¼‚å¸¸å¤„ç†ä¸ä¸€è‡´ - **é£é™©ç­‰çº§ï¼šğŸŸ¡ ä¸­**

```python
# éƒ¨åˆ†æ—¥å¿—å™¨é™é»˜å¤±è´¥
try:
    with open(log_file, 'a', encoding='utf-8') as f:
        f.write(json.dumps(record, ensure_ascii=False) + '\n')
except Exception as e:
    # âŒ ç”¨ print æŠ¥å‘Šæ—¥å¿—é”™è¯¯ï¼Œè®½åˆº
    print(f"[EnhancedAIResponseLogger] è­¦å‘Šï¼šå†™å…¥æ—¥å¿—å¤±è´¥ï¼š{e}")
```

### 2.3 è¿ç»´å±‚é¢é—®é¢˜ï¼ˆä¸­ç­‰ï¼‰

#### é—®é¢˜ 7ï¼šæ— å¤–éƒ¨æ—¥å¿—æœåŠ¡é›†æˆ - **é£é™©ç­‰çº§ï¼šğŸŸ¡ ä¸­**

å½“å‰é¡¹ç›®**é›¶é›†æˆ**ä»»ä½•å¤–éƒ¨æ—¥å¿—æœåŠ¡ï¼š

```
âŒ Sentry      - æ— é”™è¯¯è¿½è¸ª
âŒ ELK Stack   - æ— é›†ä¸­æ£€ç´¢
âŒ Prometheus  - æ— æŒ‡æ ‡ç›‘æ§
âŒ Grafana     - æ— å¯è§†åŒ–
âŒ CloudWatch  - æ— äº‘åŸç”Ÿæ”¯æŒ
```

#### é—®é¢˜ 8ï¼šæ—¥å¿—é‡‡æ ·ä¸é™æµç¼ºå¤± - **é£é™©ç­‰çº§ï¼šğŸŸ¡ ä¸­**

é«˜é¢‘åœºæ™¯ï¼ˆå¦‚ AI æ‰¹é‡å¤„ç†ï¼‰å¯èƒ½äº§ç”Ÿï¼š
- ç£ç›˜ç©ºé—´å¿«é€Ÿè€—å°½
- IO å¸¦å®½é¥±å’Œ
- æ—¥å¿—æ£€ç´¢å›°éš¾ï¼ˆå™ªéŸ³è¿‡å¤šï¼‰

---

## ä¸‰ã€ä¼˜åŒ–æŠ€æœ¯æ–¹æ¡ˆ

### 3.1 ç›®æ ‡æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç»Ÿä¸€æ—¥å¿—æ¶æ„ï¼ˆæ¨èï¼‰                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚   åº”ç”¨å±‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚  API æ¨¡å—   â”‚  AI æœåŠ¡    â”‚  æ•°æ®åº“å±‚   â”‚  ä¸šåŠ¡é€»è¾‘   â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚          â”‚            â”‚            â”‚            â”‚                        â”‚
â”‚          â–¼            â–¼            â–¼            â–¼                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚              ç»Ÿä¸€æ—¥å¿—é—¨é¢ (Logging Facade)               â”‚           â”‚
â”‚   â”‚  â€¢ ç»Ÿä¸€é…ç½®ä¸­å¿ƒ  â€¢ ç»Ÿä¸€æ ¼å¼  â€¢ ç»Ÿä¸€çº§åˆ«  â€¢ é“¾è·¯è¿½è¸ª ID    â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                              â”‚                                           â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚          â–¼                   â–¼                   â–¼                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚ å¼‚æ­¥é˜Ÿåˆ—å±‚  â”‚    â”‚  è¿‡æ»¤/é‡‡æ ·  â”‚    â”‚  æŒ‡æ ‡é‡‡é›†   â”‚                 â”‚
â”‚   â”‚ (Queue)    â”‚    â”‚  (Sampler)  â”‚    â”‚  (Metrics)  â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚          â”‚                                     â”‚                        â”‚
â”‚          â–¼                                     â–¼                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚                    Handler åˆ†å‘å±‚                        â”‚           â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚
â”‚   â”‚ Console     â”‚ File(Rotate)â”‚ HTTP(ELK)   â”‚ Buffer(Async)â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                              â”‚                                          â”‚
â”‚                              â–¼                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚                    å­˜å‚¨å±‚                                â”‚           â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚
â”‚   â”‚ æœ¬åœ°æ–‡ä»¶    â”‚ GZIP å½’æ¡£    â”‚ å¤–éƒ¨æœåŠ¡    â”‚ å¯¹è±¡å­˜å‚¨    â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒä¼˜åŒ–ç­–ç•¥

#### ç­–ç•¥ 1ï¼šå¼‚æ­¥é˜Ÿåˆ—æ—¥å¿—å†™å…¥

```python
# æ¨èå®ç°ï¼šåŸºäº queue.Queue çš„å¼‚æ­¥æ—¥å¿—
import queue
import threading
from logging.handlers import QueueHandler, QueueListener

class AsyncLoggingFactory:
    def __init__(self, queue_size=10000, num_workers=2):
        self.log_queue = queue.Queue(maxsize=queue_size)
        self.num_workers = num_workers
    
    def setup_async_logging(self):
        # åˆ›å»ºå¼‚æ­¥å¤„ç†å™¨
        handlers = [
            logging.handlers.RotatingFileHandler('logs/app.log', maxBytes=10*1024*1024, backupCount=5),
            logging.StreamHandler()
        ]
        
        # å¯åŠ¨åå°ç›‘å¬å™¨
        self.listener = QueueListener(self.log_queue, *handlers, respect_handler_level=True)
        self.listener.start()
        
        # è¿”å›é˜Ÿåˆ—å¤„ç†å™¨ï¼ˆåº”ç”¨ä½¿ç”¨ï¼‰
        return QueueHandler(self.log_queue)
    
    def shutdown(self):
        self.listener.stop()
```

**æ€§èƒ½æå‡é¢„æœŸï¼š**

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|-------|-------|
| è¯·æ±‚å»¶è¿Ÿï¼ˆP99ï¼‰ | 200ms | <10ms |
| æ—¥å¿—å†™å…¥ååé‡ | 100/s | 10000/s |
| ä¸»çº¿ç¨‹é˜»å¡ | æ˜¯ | å¦ |

#### ç­–ç•¥ 2ï¼šç»Ÿä¸€æ—¥å¿—é…ç½®ä¸­å¿ƒ

```yaml
# config/logging.yaml
version: 1
disable_existing_loggers: false

formatters:
  standard:
    format: '%(asctime)s - %(name)s - %(levelname)s - [%(filename)s:%(lineno)d] - %(message)s'
  json:
    class: pythonjsonlogger.jsonlogger.JsonFormatter
    format: '%(asctime)s %(name)s %(levelname)s %(message)s %(pathname)s %(lineno)d %(threadName)s'

handlers:
  console:
    class: logging.StreamHandler
    level: INFO
    formatter: standard
    stream: ext://sys.stdout
  
  async_file:
    class: logging.handlers.RotatingFileHandler
    level: DEBUG
    formatter: json
    filename: logs/app.log
    maxBytes: 10485760
    backupCount: 7
    encoding: utf8
  
  ai_responses:
    class: backend_python.logging.handlers.AIRotatingFileHandler
    level: INFO
    formatter: json
    base_path: data/ai_responses
    maxBytes: 104857600
    backupCount: 30
    compression: gzip

loggers:
  wechat_backend:
    level: DEBUG
    handlers: [console, async_file]
    propagate: false
  
  wechat_backend.ai:
    level: INFO
    handlers: [async_file, ai_responses]
    propagate: false
  
  security:
    level: WARNING
    handlers: [async_file]
    propagate: false

root:
  level: INFO
  handlers: [console, async_file]
```

#### ç­–ç•¥ 3ï¼šç»“æ„åŒ–æ—¥å¿— + é“¾è·¯è¿½è¸ª

```python
# ç»Ÿä¸€æ—¥å¿—é—¨é¢
class UnifiedLogger:
    def __init__(self, name: str):
        self.logger = logging.getLogger(name)
        self.context = contextvars.ContextVar('log_context', default={})
    
    def _inject_context(self, message: str, **kwargs) -> dict:
        """æ³¨å…¥ä¸Šä¸‹æ–‡ä¿¡æ¯"""
        return {
            'message': message,
            'trace_id': self.context.get().get('trace_id', str(uuid.uuid4())),
            'span_id': self.context.get().get('span_id', str(uuid.uuid4())[:8]),
            'service': 'wechat_backend',
            'timestamp': datetime.utcnow().isoformat(),
            **kwargs
        }
    
    def info(self, message: str, **kwargs):
        self.logger.info(json.dumps(self._inject_context(message, **kwargs)))
    
    def error(self, message: str, exc_info: bool = False, **kwargs):
        self.logger.error(json.dumps(self._inject_context(message, **kwargs)), exc_info=exc_info)

# ä½¿ç”¨ç¤ºä¾‹
logger = UnifiedLogger('wechat_backend.api')

# è®¾ç½®é“¾è·¯è¿½è¸ªä¸Šä¸‹æ–‡
logger.context.set({'trace_id': 'abc123', 'span_id': 'xyz789'})
logger.info('API è¯·æ±‚', endpoint='/api/ai/chat', user_id='user_001')
```

#### ç­–ç•¥ 4ï¼šæ™ºèƒ½æ—¥å¿—é‡‡æ ·

```python
class SamplingFilter(logging.Filter):
    """æ™ºèƒ½é‡‡æ ·è¿‡æ»¤å™¨"""
    
    def __init__(self, sample_rate: float = 0.1, level_threshold: int = logging.ERROR):
        self.sample_rate = sample_rate  # DEBUG/INFO é‡‡æ ·ç‡
        self.level_threshold = level_threshold  # è¶…è¿‡æ­¤çº§åˆ«ä¸é‡‡æ ·
    
    def filter(self, record: logging.LogRecord) -> bool:
        # ERROR åŠä»¥ä¸Šçº§åˆ«å…¨éƒ¨è®°å½•
        if record.levelno >= self.level_threshold:
            return True
        
        # DEBUG/INFO æŒ‰é‡‡æ ·ç‡è®°å½•
        return random.random() < self.sample_rate

# é…ç½®
sampling_filter = SamplingFilter(sample_rate=0.1)  # 10% é‡‡æ ·
logger.addFilter(sampling_filter)
```

#### ç­–ç•¥ 5ï¼šæ—¥å¿—å½’æ¡£ä¸ç”Ÿå‘½å‘¨æœŸç®¡ç†

```python
class LogLifecycleManager:
    """æ—¥å¿—ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨"""
    
    def __init__(self, base_path: str, retention_days: int = 30):
        self.base_path = Path(base_path)
        self.retention_days = retention_days
    
    def daily_rotation(self):
        """æ¯æ—¥è½®è½¬ä»»åŠ¡"""
        # 1. å‹ç¼©æ˜¨æ—¥æ—¥å¿—
        yesterday = datetime.now() - timedelta(days=1)
        self._compress_logs(yesterday)
        
        # 2. åˆ é™¤è¿‡æœŸæ—¥å¿—
        self._cleanup_expired_logs()
        
        # 3. ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨ï¼ˆå¯é€‰ï¼‰
        self._upload_to_s3()
    
    def _compress_logs(self, date: datetime):
        """GZIP å‹ç¼©"""
        pattern = f"app.log.{date.strftime('%Y-%m-%d')}*"
        for log_file in self.base_path.glob(pattern):
            if not log_file.name.endswith('.gz'):
                self._gzip_file(log_file)
    
    def _cleanup_expired_logs(self):
        """æ¸…ç†è¿‡æœŸæ—¥å¿—"""
        cutoff = datetime.now() - timedelta(days=self.retention_days)
        for log_file in self.base_path.glob('**/*.gz'):
            if datetime.fromtimestamp(log_file.stat().st_mtime) < cutoff:
                log_file.unlink()
```

### 3.3 å®æ–½è·¯çº¿å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å®æ–½è·¯çº¿å›¾                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  é˜¶æ®µ 1 (Week 1-2): åŸºç¡€æ¶æ„ç»Ÿä¸€                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â–¡ åˆ›å»ºç»Ÿä¸€æ—¥å¿—é…ç½®ä¸­å¿ƒ (config/logging.yaml)                     â”‚   â”‚
â”‚  â”‚ â–¡ å®ç°å¼‚æ­¥é˜Ÿåˆ—æ—¥å¿—å†™å…¥ (QueueHandler + QueueListener)           â”‚   â”‚
â”‚  â”‚ â–¡ ç»Ÿä¸€æ—¥å¿—æ ¼å¼ä¸ºæ ‡å‡† JSON                                        â”‚   â”‚
â”‚  â”‚ â–¡ è¿ç§» print() è°ƒè¯•æ—¥å¿—åˆ°æ ‡å‡† logging                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â–¼                                            â”‚
â”‚  é˜¶æ®µ 2 (Week 3-4): å¯è§‚æµ‹æ€§å¢å¼º                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â–¡ å®ç°é“¾è·¯è¿½è¸ª ID (trace_id, span_id)                           â”‚   â”‚
â”‚  â”‚ â–¡ æ·»åŠ æ—¥å¿—é‡‡æ ·ç­–ç•¥                                               â”‚   â”‚
â”‚  â”‚ â–¡ é›†æˆæŒ‡æ ‡é‡‡é›† (Prometheus metrics)                             â”‚   â”‚
â”‚  â”‚ â–¡ å®ç°æ—¥å¿—ç”Ÿå‘½å‘¨æœŸç®¡ç† (è½®è½¬ + å‹ç¼© + æ¸…ç†)                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â–¼                                            â”‚
â”‚  é˜¶æ®µ 3 (Week 5-6): å¤–éƒ¨é›†æˆ                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â–¡ é›†æˆ Sentry é”™è¯¯è¿½è¸ª                                          â”‚   â”‚
â”‚  â”‚ â–¡ é…ç½® ELK/Loki æ—¥å¿—èšåˆ                                        â”‚   â”‚
â”‚  â”‚ â–¡ å®ç°å‘Šè­¦è§„åˆ™ (é”™è¯¯ç‡é˜ˆå€¼ã€å»¶è¿Ÿé˜ˆå€¼)                            â”‚   â”‚
â”‚  â”‚ â–¡ Grafana å¯è§†åŒ–ä»ªè¡¨æ¿                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å››ã€å…³é”®ä»£ç å®ç°

### 4.1 ç»Ÿä¸€æ—¥å¿—å·¥å‚ï¼ˆæ ¸å¿ƒï¼‰

```python
# backend_python/logging/unified_logger.py

import logging
import logging.handlers
import queue
import json
import uuid
from pathlib import Path
from datetime import datetime
from typing import Optional, Dict, Any
import contextvars

# é“¾è·¯è¿½è¸ªä¸Šä¸‹æ–‡
trace_context = contextvars.ContextVar('trace_context', default={})


class JSONFormatter(logging.Formatter):
    """JSON æ ¼å¼åŒ–å™¨"""
    
    def format(self, record: logging.LogRecord) -> str:
        log_data = {
            'timestamp': datetime.utcnow().isoformat(),
            'level': record.levelname,
            'logger': record.name,
            'message': record.getMessage(),
            'module': record.module,
            'function': record.funcName,
            'line': record.lineno,
            'thread': record.threadName,
            'process': record.process,
        }
        
        # æ³¨å…¥è¿½è¸ªä¸Šä¸‹æ–‡
        context = trace_context.get()
        if context:
            log_data['trace_id'] = context.get('trace_id')
            log_data['span_id'] = context.get('span_id')
        
        # æ·»åŠ é¢å¤–å­—æ®µ
        for key, value in record.__dict__.items():
            if key not in ['name', 'msg', 'args', 'created', 'filename', 'funcName',
                          'levelname', 'levelno', 'lineno', 'module', 'msecs',
                          'pathname', 'process', 'processName', 'relativeCreated',
                          'stack_info', 'exc_info', 'exc_text', 'thread', 'threadName']:
                log_data[key] = value
        
        # å¼‚å¸¸ä¿¡æ¯
        if record.exc_info:
            log_data['exception'] = self.formatException(record.exc_info)
        
        return json.dumps(log_data, ensure_ascii=False, default=str)


class UnifiedLoggerFactory:
    """ç»Ÿä¸€æ—¥å¿—å·¥å‚"""
    
    _instance = None
    _initialized = False
    
    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
        return cls._instance
    
    def initialize(self, config_path: Optional[str] = None):
        if self._initialized:
            return
        
        # åˆ›å»ºæ—¥å¿—ç›®å½•
        log_dir = Path('logs')
        log_dir.mkdir(exist_ok=True)
        
        # åˆ›å»ºå¼‚æ­¥é˜Ÿåˆ—
        self.log_queue = queue.Queue(maxsize=10000)
        
        # åˆ›å»ºå¤„ç†å™¨
        handlers = self._create_handlers(log_dir)
        
        # å¯åŠ¨åå°ç›‘å¬å™¨
        self.listener = logging.handlers.QueueListener(
            self.log_queue, *handlers, respect_handler_level=True
        )
        self.listener.start()
        
        # é…ç½®æ ¹æ—¥å¿—å™¨
        self._configure_root_logger()
        
        self._initialized = True
    
    def _create_handlers(self, log_dir: Path) -> list:
        """åˆ›å»ºæ—¥å¿—å¤„ç†å™¨"""
        handlers = []
        
        # æ§åˆ¶å°å¤„ç†å™¨
        console = logging.StreamHandler()
        console.setLevel(logging.INFO)
        console.setFormatter(JSONFormatter())
        handlers.append(console)
        
        # æ–‡ä»¶å¤„ç†å™¨ï¼ˆå¼‚æ­¥è½®è½¬ï¼‰
        file_handler = logging.handlers.RotatingFileHandler(
            log_dir / 'app.log',
            maxBytes=10 * 1024 * 1024,  # 10MB
            backupCount=7,
            encoding='utf-8'
        )
        file_handler.setLevel(logging.DEBUG)
        file_handler.setFormatter(JSONFormatter())
        handlers.append(file_handler)
        
        # AI å“åº”ä¸“ç”¨å¤„ç†å™¨
        ai_handler = logging.handlers.RotatingFileHandler(
            log_dir / 'ai_responses.log',
            maxBytes=100 * 1024 * 1024,  # 100MB
            backupCount=30,
            encoding='utf-8'
        )
        ai_handler.setLevel(logging.INFO)
        ai_handler.setFormatter(JSONFormatter())
        ai_handler.addFilter(lambda r: 'ai' in r.name.lower())
        handlers.append(ai_handler)
        
        return handlers
    
    def _configure_root_logger(self):
        """é…ç½®æ ¹æ—¥å¿—å™¨"""
        root = logging.getLogger()
        root.setLevel(logging.DEBUG)
        
        # æ·»åŠ é˜Ÿåˆ—å¤„ç†å™¨ï¼ˆéé˜»å¡ï¼‰
        queue_handler = logging.handlers.QueueHandler(self.log_queue)
        root.addHandler(queue_handler)
        
        # é…ç½®ç‰¹å®šæ—¥å¿—å™¨
        logging.getLogger('wechat_backend').setLevel(logging.DEBUG)
        logging.getLogger('wechat_backend.api').setLevel(logging.INFO)
        logging.getLogger('wechat_backend.database').setLevel(logging.WARNING)
    
    def get_logger(self, name: str) -> 'UnifiedLogger':
        """è·å–ç»Ÿä¸€æ—¥å¿—å™¨"""
        return UnifiedLogger(name, self.log_queue)
    
    def shutdown(self):
        """å…³é—­æ—¥å¿—ç³»ç»Ÿ"""
        self.listener.stop()
        logging.shutdown()


class UnifiedLogger:
    """ç»Ÿä¸€æ—¥å¿—å™¨"""
    
    def __init__(self, name: str, log_queue: queue.Queue):
        self.logger = logging.getLogger(name)
        self.log_queue = log_queue
    
    def set_trace_context(self, trace_id: str = None, span_id: str = None):
        """è®¾ç½®è¿½è¸ªä¸Šä¸‹æ–‡"""
        context = {
            'trace_id': trace_id or str(uuid.uuid4()),
            'span_id': span_id or str(uuid.uuid4())[:8]
        }
        trace_context.set(context)
        return context
    
    def log(self, level: int, message: str, **kwargs):
        """è®°å½•æ—¥å¿—"""
        extra = {**trace_context.get(), **kwargs}
        self.logger.log(level, message, extra=extra)
    
    def info(self, message: str, **kwargs):
        self.log(logging.INFO, message, **kwargs)
    
    def warning(self, message: str, **kwargs):
        self.log(logging.WARNING, message, **kwargs)
    
    def error(self, message: str, exc_info: bool = False, **kwargs):
        if exc_info:
            self.logger.error(message, exc_info=True, extra={**trace_context.get(), **kwargs})
        else:
            self.log(logging.ERROR, message, **kwargs)
    
    def debug(self, message: str, **kwargs):
        self.log(logging.DEBUG, message, **kwargs)
```

### 4.2 ä½¿ç”¨ç¤ºä¾‹

```python
# åˆå§‹åŒ–ï¼ˆåº”ç”¨å¯åŠ¨æ—¶ï¼‰
from backend_python.logging.unified_logger import UnifiedLoggerFactory

logger_factory = UnifiedLoggerFactory()
logger_factory.initialize()

# ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨
logger = logger_factory.get_logger('wechat_backend.api.ai')

# è®¾ç½®é“¾è·¯è¿½è¸ª
trace = logger.set_trace_context()

logger.info(
    'AI è¯·æ±‚å¤„ç†',
    endpoint='/api/ai/chat',
    user_id='user_001',
    model='gpt-4',
    latency_ms=234
)

try:
    response = call_ai_api(...)
    logger.info('AI å“åº”æˆåŠŸ', tokens=response.usage.total_tokens)
except Exception as e:
    logger.error('AI è°ƒç”¨å¤±è´¥', error=str(e), exc_info=True)
```

---

## äº”ã€é¢„æœŸæ”¶ç›Š

| ç»´åº¦ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|-------|-------|------|
| **è¯·æ±‚å»¶è¿Ÿ** | 200ms (P99) | <10ms (P99) | **95%** |
| **æ—¥å¿—ååé‡** | 100 æ¡/s | 10000 æ¡/s | **100x** |
| **ç£ç›˜å ç”¨** | æ— å‹ç¼© | GZIP å‹ç¼© | **70%** |
| **é—®é¢˜å®šä½æ—¶é—´** | 30+ åˆ†é’Ÿ | <5 åˆ†é’Ÿ | **83%** |
| **é…ç½®å¤æ‚åº¦** | 5 å¥—é…ç½® | 1 å¥—é…ç½® | **80%** |

---

## å…­ã€é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|---------|
| é˜Ÿåˆ—æ»¡å¯¼è‡´æ—¥å¿—ä¸¢å¤± | ä¸­ | è®¾ç½®åˆç†é˜Ÿåˆ—å¤§å° + é™çº§ç­–ç•¥ |
| è¿ç§»æœŸé—´æ—¥å¿—ä¸ä¸€è‡´ | ä½ | åŒå†™æ¨¡å¼ + ç°åº¦åˆ‡æ¢ |
| å¤–éƒ¨æœåŠ¡ä¾èµ–æ•…éšœ | ä¸­ | æœ¬åœ°ç¼“å­˜ + é‡è¯•æœºåˆ¶ |
| æ€§èƒ½å›å½’ | ä½ | å‹æµ‹éªŒè¯ + ç›‘æ§å‘Šè­¦ |

---

## ä¸ƒã€æ€»ç»“ä¸å»ºè®®

### æ ¸å¿ƒé—®é¢˜æ€»ç»“
1. **æ¶æ„ç¢ç‰‡åŒ–** - 5 å¥—ç‹¬ç«‹æ—¥å¿—ç³»ç»Ÿï¼Œç¼ºä¹ç»Ÿä¸€æ²»ç†
2. **åŒæ­¥é˜»å¡å†™å…¥** - ä¸»çº¿ç¨‹é˜»å¡ï¼Œé«˜å¹¶å‘ä¸‹æ€§èƒ½åŠ£åŒ–ä¸¥é‡
3. **å¯è§‚æµ‹æ€§ä¸è¶³** - æ— é“¾è·¯è¿½è¸ªã€æ— å¤–éƒ¨é›†æˆã€æ— ç»Ÿä¸€æ£€ç´¢

### ä¼˜å…ˆçº§å»ºè®®
```
ğŸ”´ P0: å¼‚æ­¥é˜Ÿåˆ—æ—¥å¿—å†™å…¥ï¼ˆè§£å†³æ€§èƒ½ç“¶é¢ˆï¼‰
ğŸ”´ P0: ç»Ÿä¸€æ—¥å¿—é…ç½®ä¸­å¿ƒï¼ˆè§£å†³æ¶æ„ç¢ç‰‡åŒ–ï¼‰
ğŸŸ¡ P1: ç»“æ„åŒ–æ—¥å¿— + é“¾è·¯è¿½è¸ªï¼ˆæå‡å¯è§‚æµ‹æ€§ï¼‰
ğŸŸ¡ P1: æ—¥å¿—ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆé™ä½è¿ç»´æˆæœ¬ï¼‰
ğŸŸ¢ P2: å¤–éƒ¨æœåŠ¡é›†æˆï¼ˆSentry/ELK/Prometheusï¼‰
```

---

## é™„å½• Aï¼šæœ¯è¯­è¡¨

| æœ¯è¯­ | è§£é‡Š |
|------|------|
| JSONL | JSON Linesï¼Œæ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡çš„æ—¥å¿—æ ¼å¼ |
| QueueHandler | Python æ ‡å‡†åº“ä¸­çš„é˜Ÿåˆ—æ—¥å¿—å¤„ç†å™¨ |
| QueueListener | åå°çº¿ç¨‹ç›‘å¬å™¨ï¼Œå¼‚æ­¥æ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ—¥å¿— |
| é“¾è·¯è¿½è¸ª | é€šè¿‡ trace_id/span_id è¿½è¸ªè¯·æ±‚åœ¨ç³»ç»Ÿä¸­çš„å®Œæ•´è·¯å¾„ |
| æ—¥å¿—é‡‡æ · | æŒ‰ä¸€å®šæ¯”ä¾‹è®°å½•æ—¥å¿—ï¼Œé™ä½å­˜å‚¨å’Œ IO å‹åŠ› |

## é™„å½• Bï¼šå‚è€ƒèµ„æ–™

1. [Python Logging Cookbook](https://docs.python.org/3/howto/logging-cookbook.html)
2. [QueueHandler Documentation](https://docs.python.org/3/library/logging.handlers.html#queuehandler)
3. [12-Factor App - Logs](https://12factor.net/logs)
4. [Google Cloud Logging Best Practices](https://cloud.google.com/logging/docs/best-practices)
