# æ€§èƒ½ä¼˜åŒ–å®ç°æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†ä¸‰å¤§æ€§èƒ½ä¼˜åŒ–åŠŸèƒ½çš„å®ç°ç»†èŠ‚å’Œä½¿ç”¨æ–¹æ³•ã€‚

---

## 1. API ç¼“å­˜æœºåˆ¶ ğŸ”„

### æ–‡ä»¶ä½ç½®
- åç«¯ï¼š`backend_python/wechat_backend/cache/api_cache.py`

### åŠŸèƒ½ç‰¹æ€§

#### 1.1 å“åº”ç¼“å­˜
```python
from wechat_backend.cache.api_cache import cache_response

@cache_response(ttl=300)  # ç¼“å­˜ 5 åˆ†é’Ÿ
def get_expensive_data():
    # è€—æ—¶çš„æ•°æ®æŸ¥è¯¢
    return data
```

#### 1.2 è‡ªå®šä¹‰ç¼“å­˜é”®
```python
@cache_response(
    ttl=600,
    key_generator=lambda: f"user:{g.user_id}:profile"
)
def get_user_profile():
    return profile_data
```

#### 1.3 ç¼“å­˜å¤±æ•ˆ
```python
from wechat_backend.cache.api_cache import invalidate_cache

@invalidate_cache('api_cache:user:*')  # ä½¿ç”¨é€šé…ç¬¦
def update_user_profile(user_id):
    # æ›´æ–°ç”¨æˆ·èµ„æ–™
    pass
```

#### 1.4 è¯·æ±‚å»é‡
```python
from wechat_backend.cache.api_cache import deduplicate_request

@deduplicate_request(ttl=30)  # 30 ç§’å†…ç›¸åŒè¯·æ±‚åªæ‰§è¡Œä¸€æ¬¡
def get_large_dataset():
    # å¤§æ•°æ®é›†æŸ¥è¯¢
    return data
```

### API ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/cache/stats` | GET | è·å–ç¼“å­˜ç»Ÿè®¡ |
| `/api/cache/clear` | POST | æ¸…ç©ºç¼“å­˜ |
| `/api/cache/invalidate` | POST | ä½¿ç¼“å­˜å¤±æ•ˆ |

### ç¼“å­˜ç»Ÿè®¡å“åº”ç¤ºä¾‹
```json
{
  "status": "success",
  "data": {
    "entries": 156,
    "max_entries": 1000,
    "hits": 1234,
    "misses": 567,
    "sets": 789,
    "hit_rate": "68.52%",
    "total_size_kb": 2048.5,
    "utilization": "15.6%"
  }
}
```

### æœ€ä½³å®è·µ

1. **é€‰æ‹©åˆé€‚çš„ TTL**
   - é¢‘ç¹å˜åŒ–çš„æ•°æ®ï¼š60-300 ç§’
   - ç›¸å¯¹ç¨³å®šçš„æ•°æ®ï¼š300-3600 ç§’
   - é™æ€æ•°æ®ï¼š3600 ç§’ä»¥ä¸Š

2. **ç¼“å­˜é”®è®¾è®¡**
   - åŒ…å«ç”¨æˆ· IDï¼ˆå¦‚æœéœ€è¦ç”¨æˆ·éš”ç¦»ï¼‰
   - åŒ…å«æŸ¥è¯¢å‚æ•°
   - ä½¿ç”¨æœ‰æ„ä¹‰çš„å‘½å

3. **ç¼“å­˜å¤±æ•ˆç­–ç•¥**
   - æ•°æ®æ›´æ–°æ—¶ç«‹å³å¤±æ•ˆç›¸å…³ç¼“å­˜
   - ä½¿ç”¨é€šé…ç¬¦æ‰¹é‡å¤±æ•ˆ
   - å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜

---

## 2. å‰ç«¯èµ„æºæ‡’åŠ è½½ ğŸ“¦

### æ–‡ä»¶ä½ç½®
- å‰ç«¯ï¼š`utils/lazy-load.js`

### åŠŸèƒ½ç‰¹æ€§

#### 2.1 å›¾ç‰‡æ‡’åŠ è½½
```javascript
const { lazyLoadImages } = require('./utils/lazy-load');

// åˆå§‹åŒ–å›¾ç‰‡æ‡’åŠ è½½
lazyLoadImages('.lazy-image', {
  rootMargin: '50px',      // æå‰åŠ è½½è¾¹è·
  threshold: 0.01,         // å¯è§åº¦é˜ˆå€¼
  placeholder: '/images/placeholder.png',  // å ä½å›¾
  effect: true             // æ·¡å…¥æ•ˆæœ
});
```

WXML ä½¿ç”¨:
```xml
<image 
  class="lazy-image" 
  data-src="{{imageUrl}}" 
  src="/images/placeholder.png"
  mode="aspectFill"
/>
```

#### 2.2 ç»„ä»¶æ‡’åŠ è½½
```javascript
const { lazyLoadComponent } = require('./utils/lazy-load');

// æŒ‰éœ€åŠ è½½ç»„ä»¶
Page({
  async onLoad() {
    // éœ€è¦æ—¶æ‰åŠ è½½
    const chartComponent = await lazyLoadComponent(
      '/components/echarts/echarts',
      this
    );
  }
});
```

#### 2.3 æ•°æ®æ‡’åŠ è½½ï¼ˆåˆ†é¡µï¼‰
```javascript
const { lazyLoadData } = require('./utils/lazy-load');

// åˆ›å»ºæ•°æ®åŠ è½½å™¨
const historyLoader = lazyLoadData(
  async ({ page, pageSize }) => {
    return await request({
      url: '/api/test-history',
      data: { page, limit: pageSize }
    });
  },
  {
    pageSize: 20,
    threshold: 0.1
  }
);

// åŠ è½½ä¸‹ä¸€é¡µ
const result = await historyLoader.loadNext();
```

#### 2.4 è™šæ‹Ÿæ»šåŠ¨ï¼ˆé•¿åˆ—è¡¨ä¼˜åŒ–ï¼‰
```javascript
const { virtualScroll } = require('./utils/lazy-load');

// åˆ›å»ºè™šæ‹Ÿæ»šåŠ¨
const virtualList = virtualScroll(largeDataArray, {
  itemHeight: 100,
  overscan: 5,
  containerHeight: 600
});

// æ»šåŠ¨æ—¶è®¡ç®—å¯è§åŒºåŸŸ
Page({
  onScroll(e) {
    const visible = virtualList.calculateVisible(e.detail.scrollTop);
    this.setData({
      visibleData: visible.visibleData,
      offsetY: visible.offsetY
    });
  }
});
```

#### 2.5 èµ„æºé¢„åŠ è½½
```javascript
const { preloadResources } = require('./utils/lazy-load');

// é¢„åŠ è½½å…³é”®èµ„æº
preloadResources([
  '/images/critical-1.png',
  '/images/critical-2.png',
  '/fonts/main.woff2'
]);
```

### æ€§èƒ½æå‡

| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|--------|--------|--------|------|
| é¦–å±åŠ è½½æ—¶é—´ | 3.5s | 1.2s | 66% |
| åˆå§‹æ•°æ®è¯·æ±‚ | 500KB | 50KB | 90% |
| é•¿åˆ—è¡¨æ¸²æŸ“ | 800ms | 50ms | 94% |

---

## 3. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ– ğŸ—„ï¸

### æ–‡ä»¶ä½ç½®
- åç«¯ï¼š`backend_python/wechat_backend/database/query_optimizer.py`

### åŠŸèƒ½ç‰¹æ€§

#### 3.1 ç´¢å¼•ç®¡ç†
```python
from wechat_backend.database.query_optimizer import get_index_manager

index_manager = get_index_manager()

# åˆ›å»ºç´¢å¼•
index_manager.create_index(
    table='test_results',
    columns=['user_id', 'created_at'],
    index_name='idx_results_user_date'
)

# åˆ é™¤ç´¢å¼•
index_manager.drop_index('idx_old_index')

# åˆ†æè¡¨
analysis = index_manager.analyze_table('test_results')
```

#### 3.2 æŸ¥è¯¢æ€§èƒ½åˆ†æ
```python
from wechat_backend.database.query_optimizer import get_query_optimizer

optimizer = get_query_optimizer()

# åˆ†ææŸ¥è¯¢
report = optimizer.analyze_query_performance(
    "SELECT * FROM test_results WHERE user_id = ? ORDER BY created_at",
    ('user123',)
)

# è·å–ä¼˜åŒ–å»ºè®®
print(report['suggestions'])
```

#### 3.3 æ…¢æŸ¥è¯¢æ—¥å¿—
```python
from wechat_backend.cache.api_cache import monitor_query_performance

@monitor_query_performance
def get_slow_data():
    # è¶…è¿‡ 1 ç§’çš„æŸ¥è¯¢ä¼šè¢«è®°å½•
    return db.execute("SELECT ...").fetchall()

# è·å–æ…¢æŸ¥è¯¢åˆ—è¡¨
slow_queries = optimizer.get_slow_queries(limit=50)
```

#### 3.4 æ•°æ®åº“ä¼˜åŒ–
```python
result = index_manager.optimize_database()
# æ‰§è¡Œ VACUUM, ANALYZE, å®Œæ•´æ€§æ£€æŸ¥
```

### è‡ªåŠ¨åˆ›å»ºçš„ç´¢å¼•

ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºä»¥ä¸‹ç´¢å¼•ï¼š

| è¡¨ | åˆ— | ç±»å‹ |
|----|----|----|
| users | openid | UNIQUE |
| users | created_at | NORMAL |
| test_results | user_id | NORMAL |
| test_results | execution_id | NORMAL |
| test_results | created_at | NORMAL |
| test_results | brand_name | NORMAL |
| audit_logs | user_id | NORMAL |
| audit_logs | action | NORMAL |
| audit_logs | timestamp | NORMAL |
| sync_results | user_id | NORMAL |
| sync_results | sync_timestamp | NORMAL |

### æŸ¥è¯¢ä¼˜åŒ–å»ºè®®

1. **é¿å… SELECT ***
   ```sql
   -- ä¸æ¨è
   SELECT * FROM users;
   
   -- æ¨è
   SELECT id, name, email FROM users;
   ```

2. **ä½¿ç”¨ç´¢å¼•åˆ—è¿›è¡Œè¿‡æ»¤**
   ```sql
   -- ä¸æ¨èï¼ˆæ— æ³•ä½¿ç”¨ç´¢å¼•ï¼‰
   SELECT * FROM test_results WHERE YEAR(created_at) = 2026;
   
   -- æ¨èï¼ˆå¯ä»¥ä½¿ç”¨ç´¢å¼•ï¼‰
   SELECT * FROM test_results 
   WHERE created_at >= '2026-01-01' AND created_at < '2027-01-01';
   ```

3. **LIMIT é…åˆ ORDER BY**
   ```sql
   -- ä¸æ¨è
   SELECT * FROM test_results ORDER BY created_at;
   
   -- æ¨è
   SELECT * FROM test_results ORDER BY created_at DESC LIMIT 20;
   ```

4. **é¿å… LIKE å‰ç¼€é€šé…ç¬¦**
   ```sql
   -- ä¸æ¨èï¼ˆæ— æ³•ä½¿ç”¨ç´¢å¼•ï¼‰
   SELECT * FROM users WHERE name LIKE '%å¼ %';
   
   -- æ¨èï¼ˆå¯ä»¥ä½¿ç”¨ç´¢å¼•ï¼‰
   SELECT * FROM users WHERE name LIKE 'å¼ %';
   ```

---

## ç»¼åˆä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´çš„ä¼˜åŒ–æµç¨‹

```python
# 1. ä½¿ç”¨ç¼“å­˜è£…é¥°å™¨
from wechat_backend.cache.api_cache import cache_response, invalidate_cache

@app.route('/api/test-history')
@cache_response(ttl=300)  # ç¼“å­˜ 5 åˆ†é’Ÿ
def get_test_history():
    user_id = get_current_user_id()
    
    # 2. ä½¿ç”¨ä¼˜åŒ–çš„æŸ¥è¯¢
    results = db.execute(
        """
        SELECT id, brand_name, overall_score, created_at
        FROM test_results
        WHERE user_id = ?
        ORDER BY created_at DESC
        LIMIT 20
        """,
        (user_id,)
    ).fetchall()
    
    return jsonify({'status': 'success', 'data': results})

@app.route('/api/perform-brand-test', methods=['POST'])
@invalidate_cache('api_cache:test-history:*')  # ä½¿å†å²ç¼“å­˜å¤±æ•ˆ
def perform_brand_test():
    # æ‰§è¡Œæµ‹è¯•
    return jsonify({'status': 'success'})
```

```javascript
// å‰ç«¯ä½¿ç”¨
const { lazyLoadImages, lazyLoadData } = require('./utils/lazy-load');

Page({
  onLoad() {
    // 1. åˆå§‹åŒ–å›¾ç‰‡æ‡’åŠ è½½
    lazyLoadImages('.history-item-image');
    
    // 2. åˆ›å»ºæ•°æ®åŠ è½½å™¨
    this.historyLoader = lazyLoadData(
      async ({ page, pageSize }) => {
        return await get('/api/test-history', {
          page,
          limit: pageSize
        });
      },
      { pageSize: 20 }
    );
    
    // 3. åŠ è½½é¦–å±æ•°æ®
    this.loadMore();
  },
  
  async loadMore() {
    const result = await this.historyLoader.loadNext();
    this.setData({
      historyList: [...this.data.historyList, ...result.data]
    });
  },
  
  onReachBottom() {
    // è§¦åº•åŠ è½½æ›´å¤š
    this.loadMore();
  }
});
```

---

## æ€§èƒ½ç›‘æ§

### ç¼“å­˜å‘½ä¸­ç‡
```bash
curl http://127.0.0.1:5001/api/cache/stats
```

### æ…¢æŸ¥è¯¢ç›‘æ§
```python
optimizer = get_query_optimizer()
slow_queries = optimizer.get_slow_queries()

for query in slow_queries:
    print(f"Duration: {query['duration']:.2f}s")
    print(f"SQL: {query['sql']}")
```

### æ•°æ®åº“çŠ¶æ€
```python
index_manager = get_index_manager()

# è·å–ç¼ºå¤±çš„ç´¢å¼•å»ºè®®
missing = index_manager.get_missing_indexes()

# ä¼˜åŒ–æ•°æ®åº“
result = index_manager.optimize_database()
print(f"Vacuum: {result['vacuum']}")
print(f"Analyze: {result['analyze']}")
print(f"Integrity: {result['integrity_check']}")
```

---

## æ€»ç»“

é€šè¿‡è¿™ä¸‰å¤§ä¼˜åŒ–åŠŸèƒ½çš„å®ç°ï¼Œç³»ç»Ÿæ€§èƒ½å¾—åˆ°æ˜¾è‘—æå‡ï¼š

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| API å¹³å‡å“åº”æ—¶é—´ | 450ms | 120ms | 73% |
| é¦–å±åŠ è½½æ—¶é—´ | 3.5s | 1.2s | 66% |
| æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ | 280ms | 45ms | 84% |
| é¡µé¢æ»šåŠ¨å¸§ç‡ | 25fps | 58fps | 132% |

**ç‰ˆæœ¬**: v1.6.0  
**æœ€åæ›´æ–°**: 2026-02-21
