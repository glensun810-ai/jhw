# ã€å“ç‰Œ AI è¯Šæ–­ç³»ç»Ÿã€‘å…¨æ ˆæ·±åº¦æ¶æ„å®¡è®¡æŠ¥å‘Š

**å®¡è®¡ç‰ˆæœ¬**: v2.0  
**å®¡è®¡æ—¥æœŸ**: 2026-02-22  
**å®¡è®¡èŒƒå›´**: å¾®ä¿¡å°ç¨‹åºå‰ç«¯ + Flask åç«¯  
**å®¡è®¡äºº**: AI ç³»ç»Ÿæ¶æ„å¸ˆ

---

## æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šå¯¹å“ç‰Œ AI è¯Šæ–­ç³»ç»Ÿè¿›è¡Œäº†å…¨æ ˆæ·±åº¦æ¶æ„å®¡è®¡ï¼Œä»**ç³»ç»Ÿæ¶æ„å¸ˆ**ã€**é«˜çº§å…¨æ ˆå·¥ç¨‹å¸ˆ**ã€**æ•°æ®åˆ†æå¸ˆ**ä¸‰ä¸ªè§’è‰²è§†è§’ï¼Œå¯¹ç³»ç»Ÿçš„æ•°æ®æµè½¬ã€ä¸šåŠ¡é€»è¾‘ã€å®¹é”™æœºåˆ¶ã€ä»£ç è´¨é‡è¿›è¡Œäº†å…¨é¢ç›˜ç‚¹ã€‚

### æ ¸å¿ƒå‘ç°

| ç»´åº¦ | ç°çŠ¶è¯„ä¼° | é£é™©ç­‰çº§ | æ”¹è¿›ä¼˜å…ˆçº§ |
|-----|---------|---------|-----------|
| æ•°æ®æµè½¬ | é“¾è·¯å®Œæ•´ï¼ŒStorage ä¼ é€’å¤§æ•°æ®å·²ä¿®å¤ | âœ… ä½ | P2 |
| ä¸šåŠ¡é€»è¾‘ | æ ¸å¿ƒåŠŸèƒ½å®Œæ•´ï¼Œé”™è¯¯å¤„ç†è¾ƒå®Œå–„ | âš ï¸ ä¸­ | P1 |
| å®¹é”™æœºåˆ¶ | åŸºç¡€å¼‚å¸¸æ•è·å­˜åœ¨ï¼Œç¼ºå°‘ç³»ç»ŸåŒ–è®¾è®¡ | âš ï¸ ä¸­ | P0 |
| ä»£ç è´¨é‡ | å•æ–‡ä»¶ 2000+ è¡Œï¼ŒèŒè´£ä¸æ¸… | ğŸ”´ é«˜ | P0 |

---

## ç»´åº¦ä¸€ï¼šæ•°æ®æµè½¬å…¨æ™¯ï¼ˆData Lifecycleï¼‰

### 1.1 æ•°æ®æµè½¬ Mermaid æµç¨‹å›¾

```mermaid
flowchart TB
    subgraph InputLayer["è¾“å…¥å±‚"]
        A[ç”¨æˆ·è¾“å…¥ brandName] --> B[ç«å“åˆ—è¡¨ competitorBrands]
        A --> C[è‡ªå®šä¹‰é—®é¢˜ customQuestions]
        A --> D[AI æ¨¡å‹é€‰æ‹© selectedModels]
        B --> E[è¾“å…¥éªŒè¯ä¸æ ¼å¼åŒ–]
        C --> E
        D --> E
        E --> F[æœ¬åœ°è‰ç¨¿å­˜å‚¨ draft_diagnostic_input]
    end

    subgraph StorageLayer["å­˜å‚¨å±‚ Storage"]
        F --> G[wx.setStorageSync]
        G --> H[draft_diagnostic_input]
        G --> I[user_ai_platform_preferences]
        G --> J[last_diagnostic_results]
        G --> K[latestTestResults_{executionId}]
    end

    subgraph TransportLayer["ä¼ è¾“å±‚ API/Auth"]
        L[startBrandTestApi] --> M[POST /api/perform-brand-test]
        M --> N[Bearer Token è®¤è¯]
        N --> O[X-Device-ID æ ‡è¯†]
        O --> P[X-User-OpenID ç”¨æˆ·è¿½è¸ª]
        P --> Q[getTaskStatusApi è½®è¯¢]
        Q --> R[GET /test/status/{id}]
    end

    subgraph ExecutionLayer["æ‰§è¡Œå±‚ NxM å¼•æ“"]
        R --> S[åç«¯ä»»åŠ¡è°ƒåº¦å™¨]
        S --> T[AI é€‚é…å™¨ DeepSeek/è±†åŒ…/...]
        T --> U[å¹¶è¡Œæ‰§è¡Œ N ä¸ªå“ç‰Œ Ã— M ä¸ªé—®é¢˜]
        U --> V[è¯­ä¹‰ä¸€è‡´æ€§æ£€æµ‹]
        V --> W[å“ç‰Œçº¯å‡€åº¦è¯„ä¼°]
        W --> X[ç«äº‰æƒ…æŠ¥èšåˆ]
    end

    subgraph ResultLayer["ç»“æœå±‚"]
        X --> Y[è¯¦ç»†ç»“æœ detailed_results]
        X --> Z[ç«äº‰åˆ†æ competitive_analysis]
        X --> AA[å“ç‰Œåˆ†æ•° brand_scores]
        Y --> AB[Storage æŒä¹…åŒ–]
        Z --> AB
        AA --> AB
        AB --> AC[results é¡µé¢å¯¼èˆª]
        AC --> AD[ECharts å›¾è¡¨æ¸²æŸ“]
        AD --> AE[é›·è¾¾å›¾/è¯äº‘/è¶‹åŠ¿å›¾]
    end

    InputLayer --> StorageLayer
    StorageLayer --> TransportLayer
    TransportLayer --> ExecutionLayer
    ExecutionLayer --> ResultLayer
    
    style InputLayer fill:#e1f5fe
    style StorageLayer fill:#fff3e0
    style TransportLayer fill:#f3e5f5
    style ExecutionLayer fill:#e8f5e9
    style ResultLayer fill:#fce4ec
```

### 1.2 å…³é”®æ•°æ®èŠ‚ç‚¹è¯´æ˜

| å­˜å‚¨ Key | æ•°æ®ç±»å‹ | ç”Ÿå‘½å‘¨æœŸ | ç”¨é€” |
|---------|---------|---------|------|
| `draft_diagnostic_input` | Object | 7 å¤© | è¾“å…¥è‰ç¨¿æ¢å¤ |
| `user_ai_platform_preferences` | Object | æ°¸ä¹… | AI å¹³å°åå¥½è®°å¿† |
| `last_diagnostic_results` | Object | å•æ¬¡ä¼šè¯ | æœ€æ–°è¯Šæ–­ç»“æœç¼“å­˜ |
| `latestTestResults_{id}` | Array | æ°¸ä¹… | å†å²ç»“æœç´¢å¼• |
| `access_token` | String | 2 å°æ—¶ | JWT è®¿é—®ä»¤ç‰Œ |
| `refreshToken` | String | 30 å¤© | JWT åˆ·æ–°ä»¤ç‰Œ |

### 1.3 æ•°æ®æµè½¬å…³é”®è·¯å¾„

```
ç”¨æˆ·è¾“å…¥ â†’ æœ¬åœ°éªŒè¯ â†’ Storage è‰ç¨¿ â†’ API è¯·æ±‚ â†’ åç«¯ NxM å¼•æ“ 
â†’ AI å¹¶è¡Œæ‰§è¡Œ â†’ ç»“æœèšåˆ â†’ Storage æŒä¹…åŒ– â†’ é¡µé¢å¯¼èˆª â†’ ECharts æ¸²æŸ“
```

---

## ç»´åº¦äºŒï¼šæ ¸å¿ƒåŠŸèƒ½ç‚¹ä¸ä¸šåŠ¡é€»è¾‘ï¼ˆBusiness Logicï¼‰

### 2.1 æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è¡¨æ ¼

| åŠŸèƒ½æ¨¡å— | è§¦å‘æ¡ä»¶ | ä¾èµ–æ•°æ® | æ½œåœ¨é£é™© | ç¼“è§£æªæ–½ |
|---------|---------|---------|---------|---------|
| **startBrandTest** | ç”¨æˆ·ç‚¹å‡»"å¯åŠ¨è¯Šæ–­"æŒ‰é’® | `brandName`, `competitorBrands[]`, `selectedModels[]`, `customQuestions[]` | 1. ç½‘ç»œè¶…æ—¶ (30s)<br>2. 400 AI æ¨¡å‹æœªé…ç½®<br>3. Token å¤±æ•ˆ (401)<br>4. åç«¯æœåŠ¡æœªå¯åŠ¨ | 1. `wx.showLoading` äº¤äº’åé¦ˆ<br>2. é”™è¯¯ä¿¡æ¯æå– `err.data?.error`<br>3. è‡ªåŠ¨åˆ·æ–° Token æœºåˆ¶<br>4. è¿æ¥æ£€æŸ¥ `checkServerConnectionApi` |
| **pollTestProgress** | `startBrandTest` æˆåŠŸåè‡ªåŠ¨å¯åŠ¨ | `executionId` (ä»å“åº”æå–) | 1. è½®è¯¢é—´éš”è¿‡çŸ­ (2s)<br>2. æ¥å£è·¯å¾„é”™è¯¯<br>3. çŠ¶æ€è§£æå¼‚å¸¸<br>4. æ— é™è½®è¯¢ | 1. å›ºå®š 2s é—´éš”<br>2. `/test/status/{id}` ç¡¬ç¼–ç <br>3. `parseTaskStatus` é˜²å¾¡æ€§è§£æ<br>4. `completed` çŠ¶æ€ç»ˆæ­¢ |
| **restoreDraft** | `onShow` ç”Ÿå‘½å‘¨æœŸé’©å­ | `draft_diagnostic_input` (Storage) | 1. æ•°æ®æ ¼å¼ä¸ä¸€è‡´<br>2. è‰ç¨¿è¿‡æœŸ (7 å¤©)<br>3. Storage è¯»å–å¼‚å¸¸<br>4. setData é¢‘ç¹è°ƒç”¨ | 1. æ ¼å¼åŒ–æ ¡éªŒ `formattedQuestions`<br>2. `draftAge < sevenDays` æ£€æŸ¥<br>3. try-catch åŒ…è£¹<br>4. åˆå¹¶ setData è°ƒç”¨ |
| **fetchResultsFromServer** | results é¡µ `onLoad` æ—  Storage æ•°æ® | `executionId`, `brandName`, `access_token` | 1. 403 Token è¿‡æœŸ<br>2. 404 ç»“æœä¸å­˜åœ¨<br>3. ç½‘ç»œé”™è¯¯<br>4. URL ç¼–ç è¶…é™ (2KB) | 1. è‡ªåŠ¨åˆ·æ–° Token é‡è¯•<br>2. å‹å¥½æç¤º `showNoDataModal`<br>3. é‡è¯•æœºåˆ¶ `fetchResultsFromServer`<br>4. Storage ä¼ é€’å¤§æ•°æ® |
| **initializePageWithData** | Storage/åç«¯æ•°æ®åŠ è½½å®Œæˆ | `results[]`, `competitiveAnalysis`, `targetBrand` | 1. æ•°æ®æ ¼å¼ä¸å…¼å®¹<br>2. ECharts æœªæŒ‚è½½<br>3. Canvas å°ºå¯¸å¼‚å¸¸<br>4. æ¸²æŸ“æ—¶åºé—®é¢˜ | 1. å¤šå±‚é™çº§ç­–ç•¥<br>2. `wx.nextTick` å»¶è¿Ÿæ¸²æŸ“<br>3. åŠ¨æ€ Canvas å°ºå¯¸è®¡ç®—<br>4. `setTimeout 300ms` ç¼“å†² |

### 2.2 å…³é”®é€»è¾‘ä¼ªä»£ç 

```javascript
// ==================== startBrandTest æ ¸å¿ƒé€»è¾‘ ====================
async startBrandTest() {
  // 1. è¾“å…¥éªŒè¯
  if (!brandName) { wx.showToast(); return; }
  if (selectedModels.length === 0) { wx.showToast(); return; }
  
  // 2. çŠ¶æ€åˆå§‹åŒ–
  this.setData({ isTesting: true, testProgress: 0 });
  
  // 3. API è°ƒç”¨
  const res = await startBrandTestApi({
    brand_list: [brandName, ...competitorBrands],
    selectedModels: processedSelectedModels,  // å¯¹è±¡â†’å­—ç¬¦ä¸²é™ç»´
    custom_question: customQuestions.join(' ') // æ•°ç»„â†’å­—ç¬¦ä¸²
  });
  
  // 4. æå– executionId
  const executionId = res.data?.execution_id || res.data?.id;
  
  // 5. å¯åŠ¨è½®è¯¢
  this.pollTestProgress(executionId);
}

// ==================== pollTestProgress æ ¸å¿ƒé€»è¾‘ ====================
pollTestProgress(executionId) {
  const pollInterval = setInterval(async () => {
    try {
      const res = await getTaskStatusApi(executionId);
      const parsedStatus = parseTaskStatus(res);
      
      // æ›´æ–° UI
      this.setData({
        testProgress: parsedStatus.progress,
        progressText: parsedStatus.statusText,
        currentStage: parsedStatus.stage
      });
      
      // ç»ˆæ­¢æ¡ä»¶
      if (parsedStatus.stage === 'completed') {
        clearInterval(pollInterval);
        // ä¿å­˜æ•°æ®åˆ° Storage
        wx.setStorageSync('last_diagnostic_results', {...});
        // å¯¼èˆªåˆ°ç»“æœé¡µ
        wx.navigateTo({ url: `/pages/results/results?executionId=${executionId}` });
      }
    } catch (err) {
      console.error('è½®è¯¢å¼‚å¸¸', err);
    }
  }, 2000);  // 2 ç§’è½®è¯¢é—´éš”
}

// ==================== restoreDraft æ ¸å¿ƒé€»è¾‘ ====================
restoreDraft() {
  try {
    const draft = wx.getStorageSync('draft_diagnostic_input');
    
    // æœ‰æ•ˆæ€§æ ¡éªŒ
    if (!draft || !draft.brandName) return;
    
    // è¿‡æœŸæ£€æŸ¥ (7 å¤©)
    const draftAge = Date.now() - (draft.updatedAt || 0);
    if (draftAge >= 7 * 24 * 60 * 60 * 1000) {
      wx.removeStorageSync('draft_diagnostic_input');
      return;
    }
    
    // æ ¼å¼åŒ–æ¢å¤æ•°æ®
    const formattedQuestions = draft.customQuestions.map(q => ({
      text: (q && q.text) || '',
      show: (q && q.show !== undefined) ? q.show : true
    }));
    
    // åˆå¹¶ setData
    this.setData({
      brandName: draft.brandName,
      competitorBrands: draft.competitorBrands || [],
      customQuestions: formattedQuestions,
      domesticAiModels: updatedDomestic,
      overseasAiModels: updatedOverseas
    });
  } catch (error) {
    console.error('æ¢å¤è‰ç¨¿å¤±è´¥:', error);
  }
}
```

---

## ç»´åº¦ä¸‰ï¼šçŠ¶æ€ç®¡ç†ä¸å®¹é”™æœºåˆ¶ï¼ˆRobustnessï¼‰

### 3.1 å¼‚å¸¸æ•è·ä¸é‡è¯•æœºåˆ¶ï¼ˆç†æƒ³åŒ–ä¼ªä»£ç ï¼‰

```javascript
// ==================== ç½‘ç»œå¼‚å¸¸å¤„ç† ====================
const requestWithRetry = async (options, maxRetries = 3) => {
  let lastError = null;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const response = await wx.request({
        ...options,
        timeout: options.timeout || 30000,
      });
      
      // 401 æœªæˆæƒï¼šå°è¯•åˆ·æ–° Token
      if (response.statusCode === 401) {
        if (!options.url.includes('/api/refresh-token')) {
          const newToken = await refreshToken();
          options.header.Authorization = `Bearer ${newToken}`;
          continue;  // é‡è¯•
        }
        throw new Error('è®¤è¯å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•');
      }
      
      // 403 ç¦æ­¢è®¿é—®ï¼šToken è¿‡æœŸ
      if (response.statusCode === 403) {
        if (attempt < maxRetries && app.globalData.refreshToken) {
          await app.globalData.refreshToken();
          continue;  // é‡è¯•
        }
        throw new Error('ç™»å½•å·²è¿‡æœŸ');
      }
      
      // 5xx æœåŠ¡å™¨é”™è¯¯ï¼šæŒ‡æ•°é€€é¿é‡è¯•
      if (response.statusCode >= 500) {
        lastError = new Error(`æœåŠ¡å™¨é”™è¯¯ï¼š${response.statusCode}`);
        await sleep(Math.pow(2, attempt) * 1000);  // æŒ‡æ•°é€€é¿
        continue;
      }
      
      return response.data;
      
    } catch (error) {
      lastError = error;
      
      // ç½‘ç»œé”™è¯¯ï¼šç›´æ¥é‡è¯•
      if (error.errMsg?.includes('request:fail')) {
        if (attempt < maxRetries) {
          await sleep(1000 * attempt);
          continue;
        }
      }
      
      // Storage è¶…é™ï¼šæ¸…ç†åé‡è¯•
      if (error.errMsg?.includes('maximum size limit exceeded')) {
        await clearStorageRecursive();
        continue;
      }
      
      break;  // éé‡è¯•é”™è¯¯ï¼Œé€€å‡ºå¾ªç¯
    }
  }
  
  throw lastError;
};

// ==================== Token åˆ·æ–°æœºåˆ¶ ====================
const refreshToken = async () => {
  if (isRefreshing) {
    // å·²åœ¨åˆ·æ–°ï¼ŒåŠ å…¥é˜Ÿåˆ—
    return new Promise((resolve, reject) => {
      refreshQueue.push({ resolve, reject });
    });
  }
  
  isRefreshing = true;
  
  try {
    const refreshToken = wx.getStorageSync('refreshToken');
    if (!refreshToken) throw new Error('No refresh token');
    
    const response = await wx.request({
      url: `${getBaseUrl()}/api/refresh-token`,
      method: 'POST',
      data: { refresh_token: refreshToken },
    });
    
    if (response.statusCode === 200) {
      const newToken = response.data.token;
      wx.setStorageSync('access_token', newToken);
      wx.setStorageSync('refreshToken', response.data.refresh_token);
      
      // æ‰§è¡Œåˆ·æ–°é˜Ÿåˆ—
      executeRefreshQueue(newToken);
      return newToken;
    }
    
    throw new Error('Token refresh failed');
  } finally {
    isRefreshing = false;
    refreshQueue = [];
  }
};

// ==================== ECharts èŠ‚ç‚¹æœªæŒ‚è½½å¤„ç† ====================
const renderChartWithFallback = (chartId, chartOption, fallbackStrategy = 'retry') => {
  const query = wx.createSelectorQuery();
  
  return new Promise((resolve, reject) => {
    query.select(`#${chartId}`)
      .fields({ node: true, size: true })
      .exec((res) => {
        // èŠ‚ç‚¹æœªæŒ‚è½½
        if (!res[0] || !res[0].node) {
          console.error(`ECharts èŠ‚ç‚¹ #${chartId} æœªæŒ‚è½½`);
          
          if (fallbackStrategy === 'retry') {
            // ç­–ç•¥ 1: å»¶è¿Ÿé‡è¯•
            setTimeout(() => {
              renderChartWithFallback(chartId, chartOption, 'skip')
                .then(resolve)
                .catch(reject);
            }, 500);
          } else {
            // ç­–ç•¥ 2: è·³è¿‡æ¸²æŸ“
            console.warn(`è·³è¿‡å›¾è¡¨ #${chartId} æ¸²æŸ“`);
            resolve(null);
          }
          return;
        }
        
        const canvas = res[0].node;
        const ctx = canvas.getContext('2d');
        const dpr = wx.getSystemInfoSync().pixelRatio;
        
        // è®¾ç½® Canvas å°ºå¯¸
        canvas.width = res[0].width * dpr;
        canvas.height = res[0].height * dpr;
        ctx.scale(dpr, dpr);
        
        // åˆå§‹åŒ– ECharts
        try {
          const chart = echarts.init(canvas, null, {
            renderer: 'canvas',
            devicePixelRatio: dpr
          });
          
          chart.setOption(chartOption);
          resolve(chart);
        } catch (error) {
          console.error(`ECharts åˆå§‹åŒ–å¤±è´¥ï¼š${error.message}`);
          reject(error);
        }
      });
  });
};

// ==================== è½®è¯¢ç»ˆæ­¢æœºåˆ¶ ====================
const createPollingController = (maxDuration = 300000) => {
  const startTime = Date.now();
  let intervalId = null;
  let isStopped = false;
  
  return {
    start: (pollFn, interval = 2000) => {
      intervalId = setInterval(async () => {
        // è¶…æ—¶æ£€æŸ¥
        if (Date.now() - startTime > maxDuration) {
          this.stop();
          console.error('è½®è¯¢è¶…æ—¶');
          return;
        }
        
        // å·²åœæ­¢æ£€æŸ¥
        if (isStopped) {
          this.stop();
          return;
        }
        
        try {
          const result = await pollFn();
          if (result.shouldStop) {
            this.stop();
          }
        } catch (error) {
          console.error('è½®è¯¢æ‰§è¡Œå¤±è´¥:', error);
        }
      }, interval);
    },
    
    stop: () => {
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
        isStopped = true;
      }
    },
    
    isStopped: () => isStopped
  };
};
```

### 3.2 è¾¹ç¼˜æƒ…å†µå¤„ç†çŸ©é˜µ

| è¾¹ç¼˜åœºæ™¯ | å½“å‰å¤„ç† | å»ºè®®æ”¹è¿› |
|---------|---------|---------|
| **ç½‘ç»œè¶…æ—¶** | `timeout: 30000` | æŒ‡æ•°é€€é¿é‡è¯• + ç¦»çº¿æ¨¡å¼ |
| **Token å¤±æ•ˆ** | 401 è‡ªåŠ¨åˆ·æ–° | åˆ·æ–°é˜Ÿåˆ— + å¹¶å‘æ§åˆ¶ |
| **Storage è¶…é™** | `clearStorageRecursive` | åˆ†ç‰‡å­˜å‚¨ + LRU æ·˜æ±° |
| **ECharts æœªæŒ‚è½½** | `wx.nextTick` å»¶è¿Ÿ | èŠ‚ç‚¹æ£€æµ‹ + é™çº§é™æ€å›¾ |
| **è½®è¯¢æ— é™å¾ªç¯** | `completed` çŠ¶æ€ç»ˆæ­¢ | è¶…æ—¶ä¿æŠ¤ (5min) + æœ€å¤§è½®è¯¢æ¬¡æ•° |
| **å¤§æ•°æ®ä¼ è¾“** | Storage æ›¿ä»£ URL | åˆ†å—ä¼ è¾“ + åç«¯ä¸´æ—¶æ–‡ä»¶ |
| **å¹¶å‘è¯·æ±‚å†²çª** | `isRefreshing` é” | è¯·æ±‚é˜Ÿåˆ— + å–æ¶ˆæœºåˆ¶ |

---

## ç»´åº¦å››ï¼šä»£ç è´¨é‡ä¸é‡æ„å»ºè®®ï¼ˆCode Healthï¼‰

### 4.1 å½“å‰é—®é¢˜è¯Šæ–­

| æ–‡ä»¶ | è¡Œæ•° | é—®é¢˜ | å¤æ‚åº¦ |
|-----|------|------|--------|
| `pages/index/index.js` | 2276 è¡Œ | å•ä¸€æ–‡ä»¶æ‰¿æ‹…è¿‡å¤šèŒè´£ | âš ï¸ æé«˜ |
| `pages/results/results.js` | 2123 è¡Œ | å›¾è¡¨æ¸²æŸ“ä¸æ•°æ®é€»è¾‘è€¦åˆ | âš ï¸ æé«˜ |
| `services/homeService.js` | ~150 è¡Œ | ç›¸å¯¹åˆç† | âœ… ä½ |
| `utils/request.js` | ~200 è¡Œ | å·¥å…·å‡½æ•°é›†ä¸­ | âœ… ä¸­ |

### 4.2 é‡æ„åˆ†æ‹†æ–¹æ¡ˆ

```
é¡¹ç›®ç»“æ„é‡æ„å»ºè®®ï¼š

src/
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ index/
â”‚   â”‚   â”œâ”€â”€ index.js          # ä»…ä¿ç•™é¡µé¢ç”Ÿå‘½å‘¨æœŸä¸ UI äº¤äº’
â”‚   â”‚   â”œâ”€â”€ index.wxml
â”‚   â”‚   â””â”€â”€ index.wxss
â”‚   â””â”€â”€ results/
â”‚       â”œâ”€â”€ results.js        # ä»…ä¿ç•™é¡µé¢ç”Ÿå‘½å‘¨æœŸä¸ UI äº¤äº’
â”‚       â”œâ”€â”€ results.wxml
â”‚       â””â”€â”€ results.wxss
â”‚
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ brandTestService.js   # å“ç‰Œè¯Šæ–­æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ pollingService.js     # è½®è¯¢çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ draftService.js       # è‰ç¨¿æ¢å¤é€»è¾‘
â”‚   â”œâ”€â”€ resultService.js      # ç»“æœæ•°æ®å¤„ç†
â”‚   â””â”€â”€ reportAggregator.js   # æŠ¥å‘Šèšåˆ (å·²æœ‰)
â”‚
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ request.js            # è¯·æ±‚å·¥å…· (ä¿ç•™)
â”‚   â”œâ”€â”€ config.js             # é…ç½®æ–‡ä»¶ (ä¿ç•™)
â”‚   â”œâ”€â”€ chartRenderer.js      # ECharts æ¸²æŸ“å·¥å…·
â”‚   â”œâ”€â”€ storageManager.js     # Storage å°è£…
â”‚   â””â”€â”€ dataFormatter.js      # æ•°æ®æ ¼å¼åŒ–å·¥å…·
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ProgressMonitor/      # è¿›åº¦ç›‘æ§ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ProgressMonitor.js
â”‚   â”‚   â””â”€â”€ ProgressMonitor.wxml
â”‚   â”œâ”€â”€ ResultCard/           # ç»“æœå¡ç‰‡ç»„ä»¶
â”‚   â”œâ”€â”€ ChartContainer/       # å›¾è¡¨å®¹å™¨ç»„ä»¶
â”‚   â””â”€â”€ AuthWrapper/          # è®¤è¯åŒ…è£…ç»„ä»¶ (å·²æœ‰)
â”‚
â””â”€â”€ constants/
    â”œâ”€â”€ taskStatus.js         # ä»»åŠ¡çŠ¶æ€å¸¸é‡ (å·²æœ‰)
    â”œâ”€â”€ brandTest.js          # å“ç‰Œæµ‹è¯•å¸¸é‡ (å·²æœ‰)
    â””â”€â”€ chartConfig.js        # å›¾è¡¨é…ç½®å¸¸é‡
```

### 4.3 æ¨¡å—èŒè´£åˆ’åˆ†

| æ¨¡å— | èŒè´£ | åº”åŒ…å«çš„å‡½æ•°/é€»è¾‘ |
|-----|------|------------------|
| **pages/index/index.js** | UI äº¤äº’ä¸ç”Ÿå‘½å‘¨æœŸ | `onLoad`, `onShow`, äº‹ä»¶å¤„ç†å‡½æ•° |
| **services/brandTestService.js** | è¯Šæ–­ä¸šåŠ¡é€»è¾‘ | `startDiagnosis`, `validateInput`, `buildPayload` |
| **services/pollingService.js** | è½®è¯¢çŠ¶æ€ç®¡ç† | `createPollingController`, `parseTaskStatus`, `handlePollingError` |
| **services/draftService.js** | è‰ç¨¿ç®¡ç† | `saveDraft`, `restoreDraft`, `clearDraft`, `validateDraft` |
| **utils/chartRenderer.js** | å›¾è¡¨æ¸²æŸ“ | `renderRadarChart`, `renderWordCloud`, `renderTrendChart` |
| **utils/storageManager.js** | Storage å°è£… | `setWithExpiry`, `getWithExpiry`, `clearExpired`, `getStorageSize` |
| **components/ProgressMonitor** | è¿›åº¦ç›‘æ§ UI | è¿›åº¦æ¡ã€çŠ¶æ€æ–‡æœ¬ã€é˜¶æ®µæŒ‡ç¤ºå™¨ |

### 4.4 é‡æ„ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | é¢„ä¼°å·¥æ—¶ | é£é™© |
|-------|------|---------|------|
| **P0** | æå– `pollTestProgress` åˆ° `pollingService.js` | 2h | ä½ |
| **P0** | æå– `restoreDraft` åˆ° `draftService.js` | 1h | ä½ |
| **P1** | åˆ›å»º `ProgressMonitor` ç»„ä»¶ | 4h | ä¸­ |
| **P1** | æå–å›¾è¡¨æ¸²æŸ“é€»è¾‘åˆ° `chartRenderer.js` | 3h | ä¸­ |
| **P2** | åˆ›å»º `storageManager.js` ç»Ÿä¸€å°è£… | 2h | ä½ |
| **P2** | æ•°æ®æ ¼å¼åŒ–é€»è¾‘ç§»è‡³ `dataFormatter.js` | 2h | ä½ |

### 4.5 ä»£ç è´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰å€¼ | ç›®æ ‡å€¼ | æ”¹è¿›æªæ–½ |
|-----|-------|-------|---------|
| å•æ–‡ä»¶æœ€å¤§è¡Œæ•° | 2276 è¡Œ | <500 è¡Œ | æ¨¡å—åˆ†æ‹† |
| å‡½æ•°æœ€å¤§è¡Œæ•° | ~200 è¡Œ | <50 è¡Œ | å‡½æ•°æ‹†åˆ† |
| åœˆå¤æ‚åº¦ | é«˜ | <10 | æ¡ä»¶åˆ†æ”¯æå– |
| é‡å¤ä»£ç ç‡ | ~15% | <5% | å·¥å…·å‡½æ•°æå– |
| æµ‹è¯•è¦†ç›–ç‡ | 0% | >70% | å•å…ƒæµ‹è¯•ç¼–å†™ |

---

## æ€»ç»“ä¸è¡ŒåŠ¨å»ºè®®

### ç³»ç»Ÿç“¶é¢ˆå®šä½

#### 1. æ€§èƒ½ç“¶é¢ˆ

- [ ] è½®è¯¢é—´éš”å›ºå®š 2sï¼Œæ— æ³•åŠ¨æ€è°ƒæ•´
- [ ] å¤§æ•°æ®é€šè¿‡ URL ä¼ é€’ (å·²ä¿®å¤ä¸º Storage)
- [ ] ECharts æ¸²æŸ“æ—¶åºä¾èµ– `setTimeout` ç¡¬ç¼–ç 

#### 2. æ¶æ„ç“¶é¢ˆ

- [ ] å•æ–‡ä»¶ 2000+ è¡Œï¼ŒèŒè´£ä¸æ¸…
- [ ] é¡µé¢çº§ç»„ä»¶æ‰¿æ‹…æœåŠ¡å±‚é€»è¾‘
- [ ] ç¼ºå°‘ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ä¸­é—´ä»¶

#### 3. å¯ç»´æŠ¤æ€§ç“¶é¢ˆ

- [ ] ç¡¬ç¼–ç å­—ç¬¦ä¸²æ•£è½åœ¨å¤šå¤„
- [ ] ç¼ºå°‘ç±»å‹å®šä¹‰ä¸æ¥å£å¥‘çº¦
- [ ] æ—¥å¿—ç³»ç»Ÿä¸å®Œå–„

### çŸ­æœŸè¡ŒåŠ¨é¡¹ (1 å‘¨)

- [ ] åˆ›å»º `pollingService.js` æå–è½®è¯¢é€»è¾‘
- [ ] åˆ›å»º `draftService.js` æå–è‰ç¨¿ç®¡ç†
- [ ] æ·»åŠ è½®è¯¢è¶…æ—¶ä¿æŠ¤æœºåˆ¶
- [ ] ç»Ÿä¸€é”™è¯¯å¤„ç†ä¸­é—´ä»¶

### ä¸­æœŸè¡ŒåŠ¨é¡¹ (1 æœˆ)

- [ ] å®Œæˆ `ProgressMonitor` ç»„ä»¶å¼€å‘
- [ ] å®Œæˆå›¾è¡¨æ¸²æŸ“å·¥å…·å°è£…
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒé€»è¾‘
- [ ] å®Œå–„æ—¥å¿—è¿½è¸ªç³»ç»Ÿ

### é•¿æœŸè¡ŒåŠ¨é¡¹ (1 å­£)

- [ ] å¼•å…¥ TypeScript è¿›è¡Œç±»å‹æ£€æŸ¥
- [ ] å®ç° SSR æœåŠ¡ç«¯æ¸²æŸ“
- [ ] æ„å»º CI/CD è‡ªåŠ¨åŒ–æµç¨‹
- [ ] æ€§èƒ½ç›‘æ§ä¸å‘Šè­¦ç³»ç»Ÿ

---

## é™„å½•

### A. ç›¸å…³æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `pages/index/index.js` | é¦–é¡µå…¥å£ï¼Œ2276 è¡Œ |
| `pages/results/results.js` | ç»“æœé¡µå…¥å£ï¼Œ2123 è¡Œ |
| `api/home.js` | é¦–é¡µ API æ¥å£ |
| `services/homeService.js` | é¦–é¡µä¸šåŠ¡é€»è¾‘ |
| `services/DiagnosisService.js` | è¯Šæ–­æœåŠ¡ |
| `utils/request.js` | ç»Ÿä¸€è¯·æ±‚å·¥å…· |
| `utils/config.js` | ç»Ÿä¸€é…ç½®æ–‡ä»¶ |
| `constants/taskStatus.js` | ä»»åŠ¡çŠ¶æ€å¸¸é‡ |

### B. API ç«¯ç‚¹æ¸…å•

| ç«¯ç‚¹ | æ–¹æ³• | ç”¨é€” |
|-----|------|------|
| `/api/perform-brand-test` | POST | å¯åŠ¨å“ç‰Œè¯Šæ–­ |
| `/test/status/{id}` | GET | è·å–ä»»åŠ¡çŠ¶æ€ |
| `/api/test-progress` | GET | è·å–æµ‹è¯•è¿›åº¦ |
| `/api/refresh-token` | POST | åˆ·æ–° Token |

### C. æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|-----|------|
| NxM å¼•æ“ | N ä¸ªå“ç‰Œ Ã— M ä¸ªé—®é¢˜çš„å¹¶è¡Œæ‰§è¡Œå¼•æ“ |
| Storage | å¾®ä¿¡å°ç¨‹åºæœ¬åœ°å­˜å‚¨ (wx.setStorageSync) |
| ECharts | ç™¾åº¦å¼€æºçš„å¯è§†åŒ–å›¾è¡¨åº“ |
| JWT | JSON Web Tokenï¼Œè®¤è¯ä»¤ç‰Œ |

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-02-22  
**æŠ¥å‘Šç‰ˆæœ¬**: v1.0  
**ä¿å¯†çº§åˆ«**: å†…éƒ¨å…¬å¼€
