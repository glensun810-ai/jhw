# å“ç‰Œè¯Šæ–­ç«¯åˆ°ç«¯æµç¨‹é—®é¢˜ä¸ç¼ºå¤±åŠŸèƒ½åˆ†ææŠ¥å‘Š

**æŠ¥å‘Šç¼–å·**: P20260228-001
**åˆ†ææ—¥æœŸ**: 2026-02-28
**åˆ†æèŒƒå›´**: ç”¨æˆ·è¾“å…¥ â†’ AI è°ƒç”¨ â†’ ç»“æœå­˜å‚¨ â†’ æŠ¥å‘Šç”Ÿæˆå…¨é“¾è·¯
**å‚è€ƒæ–‡æ¡£**: `2026-02-25_å“ç‰Œè¯Šæ–­ç«¯åˆ°ç«¯é—­ç¯åˆ†æä¸æ”¹è¿›æŠ¥å‘Š.md`
**ç³»ç»Ÿç‰ˆæœ¬**: v2.0.0

---

## ä¸€ã€æ‰§è¡Œæ‘˜è¦

### 1.1 ç³»ç»Ÿå½“å‰çŠ¶æ€

åŸºäºå¯¹å‚è€ƒæŠ¥å‘Šå’Œæœ€æ–°è¿è¡Œæ—¥å¿—çš„æ·±å…¥åˆ†æï¼Œå½“å‰å“ç‰Œè¯Šæ–­ç³»ç»Ÿåœ¨ç«¯åˆ°ç«¯æµç¨‹ä¸Šå·²å–å¾—æ˜¾è‘—è¿›å±•ï¼Œä½†ä»å­˜åœ¨**3 ä¸ª P0 çº§é˜»æ–­é—®é¢˜**ã€**5 ä¸ª P1 çº§ä¸¥é‡é—®é¢˜**å’Œ**8 ä¸ª P2 çº§ä¼˜åŒ–ç¼ºå¤±**ã€‚

| æŒ‡æ ‡ | 2026-02-25 | 2026-02-28 | æ”¹è¿› |
|------|-----------|-----------|------|
| è¯Šæ–­æˆåŠŸç‡ | 37.5% | 100% | âœ… +62.5% |
| ç©ºæŠ¥å‘Šç‡ | 62.5% | 0% | âœ… -62.5% |
| å¡æ­»ç‡ | 62.5% | 0% | âœ… -62.5% |
| å¹³å‡å“åº”æ—¶é—´ | - | 128 ç§’ | âš ï¸ å¾…ä¼˜åŒ– |
| æ•°æ®æŒä¹…åŒ–å®Œæ•´ç‡ | 0% | 100% | âœ… +100% |

### 1.2 æ ¸å¿ƒå‘ç°

**âœ… å·²ä¿®å¤çš„å…³é”®é—®é¢˜** (å¯¹æ¯” 2026-02-25 æŠ¥å‘Š):
1. âœ… AI é€‚é…å™¨æ–¹æ³•è°ƒç”¨å¤±è´¥é—®é¢˜å·²ä¿®å¤ï¼ˆ`generate_response` â†’ `send_prompt`ï¼‰
2. âœ… æ•°æ®æŒä¹…åŒ–å±‚æ–­è£‚é—®é¢˜å·²ä¿®å¤ï¼ˆ`task_statuses` ç­‰è¡¨å·²æ­£å¸¸å†™å…¥ï¼‰
3. âœ… è±†åŒ… API è®¤è¯é—®é¢˜å·²è§£å†³ï¼ˆéƒ¨ç½²ç‚¹ ID æ ¼å¼æ­£ç¡®ï¼‰
4. âœ… çŠ¶æ€åŒæ­¥æœºåˆ¶å·²å®ç°ï¼ˆçŠ¶æ€æœºæ­£å¸¸å·¥ä½œï¼‰

**âŒ æ–°å‘ç°çš„é—®é¢˜**:
1. âŒ è¯Šæ–­é€»è¾‘è®¾è®¡é”™è¯¯ï¼ˆè¯·æ±‚æ¬¡æ•°æ­£ç¡®ä½†æç¤ºè¯è®¾è®¡ä¸ç¬¦åˆéœ€æ±‚ï¼‰
2. âŒ AI å“åº”è§£æå®¹é”™æ€§ä¸è¶³ï¼ˆDeepSeek å“åº”æ— æ³•è§£ææ—¶ç›´æ¥å¤±è´¥ï¼‰
3. âŒ å‰ç«¯è½®è¯¢é¢‘ç‡è¿‡é«˜ï¼ˆçº¦æ¯ 250-320ms ä¸€æ¬¡ï¼Œé€ æˆèµ„æºæµªè´¹ï¼‰

**â³ ç¼ºå¤±çš„åŠŸèƒ½**:
1. â³ ç«å“è‡ªåŠ¨æå–åŠŸèƒ½ï¼ˆç”¨æˆ·æœªæŒ‡å®šç«å“æ—¶æ— æ³•è‡ªåŠ¨å¯¹æ¯”ï¼‰
2. â³ å“ç‰ŒæåŠåç½®åˆ†ææ¨¡å—ï¼ˆä¾èµ– AI ç›´æ¥åˆ†æï¼Œæ— ç‹¬ç«‹åˆ†æå±‚ï¼‰
3. â³ å¤šæ¨¡å‹å†—ä½™è°ƒç”¨æœºåˆ¶ï¼ˆå•æ¨¡å‹å¤±è´¥æ—¶æ— è‡ªåŠ¨åˆ‡æ¢ï¼‰
4. â³ WebSocket å®æ—¶æ¨é€å‰ç«¯é›†æˆï¼ˆåç«¯å·²å®ç°ï¼Œå‰ç«¯æœªé›†æˆï¼‰

---

## äºŒã€ç«¯åˆ°ç«¯æµç¨‹å…¨æ™¯å›¾ï¼ˆå½“å‰çŠ¶æ€ï¼‰

### 2.1 å®é™…æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å“ç‰Œè¯Šæ–­ç«¯åˆ°ç«¯é—­ç¯æµç¨‹ï¼ˆå½“å‰å®ç°ï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[1] ç”¨æˆ·å‘èµ·è¯Šæ–­ (å°ç¨‹åº/å‰ç«¯) âœ…
    â”‚ è¾“å…¥ï¼šå“ç‰Œåˆ—è¡¨ã€AI æ¨¡å‹ã€è‡ªå®šä¹‰é—®é¢˜
    â–¼
[2] POST /api/perform-brand-test âœ…
    â”‚ éªŒè¯ï¼šè®¤è¯ã€é™æµã€å‚æ•°æ ¡éªŒ
    â”‚ è¾“å‡ºï¼šexecution_id
    â–¼
[3] åˆ›å»ºè¯Šæ–­æŠ¥å‘Šè®°å½• (diagnosis_reports è¡¨) âœ…
    â”‚ çŠ¶æ€ï¼šprocessing, stage: init, progress: 0
    â–¼
[4] åˆå§‹åŒ– NxM æ‰§è¡Œå¼•æ“ âœ…
    â”‚ å…¬å¼ï¼šå“ç‰Œæ•° Ã— é—®é¢˜æ•° Ã— æ¨¡å‹æ•° = æ€»è¯·æ±‚æ•°
    â”‚ âš ï¸ é—®é¢˜ï¼šå½“å‰è®¾è®¡ä¸º"å“ç‰Œå¯¹æ¯”"æ€ç»´ï¼Œé"å®¢è§‚è¯Šæ–­"æ€ç»´
    â–¼
[5] éå†å“ç‰Œ Ã— é—®é¢˜ Ã— æ¨¡å‹ âš ï¸
    â”‚ è°ƒç”¨ï¼šai_executor.execute_with_fallback()
    â”‚ âš ï¸ é—®é¢˜ï¼šæç¤ºè¯åŒ…å«å“ç‰Œå€¾å‘ï¼Œå¼•å¯¼ AI è¿›è¡Œæ¯”è¾ƒè€Œéå®¢è§‚æ¨è
    â–¼
[6] AI é€‚é…å™¨è°ƒç”¨å¤–éƒ¨ API âœ…
    â”‚ å¹³å°ï¼šè±†åŒ…/DeepSeek/é€šä¹‰åƒé—®ç­‰
    â”‚ è¶…æ—¶ä¿æŠ¤ï¼š30-60 ç§’ï¼ˆå·²ä¼˜åŒ–ï¼‰
    â”‚ é‡è¯•æœºåˆ¶ï¼šæœ€å¤š 3 æ¬¡
    â”‚ âŒ é—®é¢˜ï¼šDeepSeek å“åº”æ— æ³•è§£ææ—¶ç›´æ¥å¤±è´¥
    â–¼
[7] è§£æ GEO å“åº” âš ï¸
    â”‚ æå–ï¼šrank, sentiment, sources, interception
    â”‚ âŒ é—®é¢˜ï¼šè§£æå™¨å®¹é”™æ€§ä¸è¶³ï¼Œæ— æ³•å¤„ç†éæ ‡å‡†æ ¼å¼
    â–¼
[8] å®æ—¶æ›´æ–°è¿›åº¦ (task_statuses è¡¨) âœ…
    â”‚ æ›´æ–°ï¼šprogress, stage, status
    â”‚ âœ… å·²ä¿®å¤ï¼šæ•°æ®æŒä¹…åŒ–æ­£å¸¸
    â–¼
[9] æŒä¹…åŒ–å“ç‰Œæµ‹è¯•ç»“æœ (diagnosis_results è¡¨) âœ…
    â”‚ å­˜å‚¨ï¼šresponse_content, geo_data, quality_score
    â”‚ âœ… å·²ä¿®å¤ï¼šæ•°æ®æ­£å¸¸å†™å…¥
    â–¼
[10] ç”Ÿæˆæ·±åº¦æƒ…æŠ¥ (å¯é€‰) â³
    â”‚ â³ ç¼ºå¤±ï¼šç«å“è‡ªåŠ¨æå–ã€å“ç‰ŒæåŠåˆ†æ
    â–¼
[11] æ›´æ–°è¯Šæ–­æŠ¥å‘ŠçŠ¶æ€ âœ…
    â”‚ status: completed, progress: 100, stage: completed
    â–¼
[12] å‰ç«¯è½®è¯¢è·å–è¿›åº¦å’ŒæŠ¥å‘Š âœ…
    â”‚ GET /test/status/{execution_id}
    â”‚ âŒ é—®é¢˜ï¼šè½®è¯¢é¢‘ç‡è¿‡é«˜ï¼ˆ250-320ms/æ¬¡ï¼‰
    â–¼
[13] ç”Ÿæˆå“ç‰Œæ´å¯ŸæŠ¥å‘Š (PDF/JSON) âœ…
    â”‚ åŒ…å«ï¼šå¾—åˆ†ã€æ’åã€ä¿¡æºã€å»ºè®®
    â”‚ âš ï¸ é—®é¢˜ï¼šæŠ¥å‘ŠåŸºäº"æ¯”è¾ƒå‹"å›ç­”ï¼Œéå®¢è§‚æ¨è
```

### 2.2 ä¸é¢„æœŸæµç¨‹çš„å·®å¼‚

| æ­¥éª¤ | é¢„æœŸè¡Œä¸º | å®é™…è¡Œä¸º | å·®å¼‚ç­‰çº§ |
|------|---------|---------|---------|
| [4] åˆå§‹åŒ– | å®¢è§‚è¯Šæ–­æ€ç»´ | å“ç‰Œå¯¹æ¯”æ€ç»´ | ğŸ”´ P0 |
| [5] éå† | é—®é¢˜ Ã— æ¨¡å‹ | å“ç‰Œ Ã— é—®é¢˜ Ã— æ¨¡å‹ | ğŸ”´ P0 |
| [6] AI è°ƒç”¨ | å®¢è§‚é—®é¢˜ | æ¯”è¾ƒå‹é—®é¢˜ | ğŸ”´ P0 |
| [7] è§£æ | å®¹é”™å¤„ç† | ä¸¥æ ¼è§£æ | ğŸŸ  P1 |
| [10] æƒ…æŠ¥ | è‡ªåŠ¨ç«å“æå– | ä¾èµ–ç”¨æˆ·æŒ‡å®š | ğŸŸ  P1 |
| [12] è½®è¯¢ | æ™ºèƒ½é€€é¿ | å›ºå®šé«˜é¢‘ | ğŸŸ¡ P2 |

---

## ä¸‰ã€P0 çº§é˜»æ–­é—®é¢˜åˆ†æ

### P0-1: è¯Šæ–­é€»è¾‘è®¾è®¡é”™è¯¯

**é—®é¢˜æè¿°**: å½“å‰å®ç°åŸºäº"å“ç‰Œå¯¹æ¯”"æ€ç»´ï¼Œè€Œé"å®¢è§‚è¯Šæ–­"æ€ç»´

**ç”¨æˆ·éœ€æ±‚**:
```
æœŸæœ›æµç¨‹:
1. æé—®ï¼šæ·±åœ³æ–°èƒ½æºæ±½è½¦æ”¹è£…é—¨åº—å“ªå®¶å¥½ï¼ˆå®¢è§‚é—®é¢˜ï¼‰
2. AI å›ç­”ï¼šå®¢è§‚æ¨è TOP3 å“ç‰Œ
3. åˆ†æï¼šä»å›ç­”ä¸­æå–ç”¨æˆ·å“ç‰ŒæåŠæƒ…å†µ
4. å¯¹æ¯”ï¼šç”¨æˆ·å“ç‰Œ vs ç­”æ¡ˆä¸­çš„ TOP3 å“ç‰Œ

å½“å‰æµç¨‹:
1. æé—®ï¼šè¯·æ¯”è¾ƒè¶£è½¦è‰¯å“å’Œæ— ï¼ˆæ¯”è¾ƒå‹é—®é¢˜ï¼‰
2. AI å›ç­”ï¼šå¸¦æœ‰å“ç‰Œå€¾å‘çš„æ¯”è¾ƒ
3. åˆ†æï¼šAI ç›´æ¥è¿”å›åˆ†æç»“æœ
4. å¯¹æ¯”ï¼šæ— ï¼ˆå·²åŒ…å«åœ¨å›ç­”ä¸­ï¼‰
```

**å½±å“èŒƒå›´**:
- æ‰€æœ‰è¯Šæ–­ä»»åŠ¡çš„å›ç­”å®¢è§‚æ€§
- ç”¨æˆ·æ— æ³•è·å–ç¬¬ä¸‰æ–¹å®¢è§‚æ¨è
- ç«å“å¯¹æ¯”åŠŸèƒ½å—é™ï¼ˆä¾èµ–ç”¨æˆ·æŒ‡å®šï¼‰

**æ ¹å› **:
```python
# å½“å‰ä»£ç ï¼ˆnxm_execution_engine.py:251-281ï¼‰
all_brands = [main_brand] + (competitor_brands or [])

# å¤–å±‚å¾ªç¯ï¼šéå†å“ç‰Œ
for brand in all_brands:
    for question in raw_questions:
        for model_info in selected_models:
            # æ„å»ºæ¯”è¾ƒå‹æç¤ºè¯
            prompt = GEO_PROMPT_TEMPLATE.format(
                brand_name=brand,
                competitors=', '.join(current_competitors),
                question=question
            )
```

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# ä¿®å¤åï¼šåªéå†é—®é¢˜å’Œæ¨¡å‹
for question in raw_questions:
    for model_info in selected_models:
        # æ„å»ºå®¢è§‚é—®é¢˜æç¤ºè¯
        prompt = OBJECTIVE_QUESTION_TEMPLATE.format(
            question=question
        )
        
        # å‘èµ· AI è¯·æ±‚
        ai_result = execute_ai_call(...)
        
        # åç½®åˆ†æï¼šä»å›ç­”ä¸­æå–å“ç‰ŒæåŠ
        analysis = analyze_brand_mentions(
            response=ai_result.data,
            user_brand=main_brand
        )
```

**é¢„è®¡å·¥ä½œé‡**: 4-6 å°æ—¶

---

### P0-2: AI å“åº”è§£æå®¹é”™æ€§ä¸è¶³

**æ—¥å¿—è¯æ®**:
```
2026-02-25 02:55:43 - geo_parser.py - ERROR -
  [GeoParser] è§£æå¤±è´¥ï¼ˆæœ‰é”™è¯¯æ ‡è®°ï¼‰ï¼ša2d39c01-1318-455e-9f63-539a51cee10f, Q0, deepseek:
  æ— æ³•ä» AI å“åº”ä¸­æå– geo_analysis å­—æ®µ

AI å®é™…è¿”å›:
"ä½œä¸ºæ‚¨çš„ä¸“ä¸šè´­è½¦é¡¾é—®ï¼Œæˆ‘å°†åŸºäºå½“å‰ï¼ˆæˆªè‡³ 2024 å¹´ä¸­ï¼‰20 ä¸‡å…ƒå·¦å³ä»·ä½æ®µæ–°èƒ½æºæ±½è½¦å¸‚åœºçš„å…¬å¼€ä¿¡æ¯ã€äº§å“åŠ›åŠå¸‚åœºå£ç¢‘ï¼Œä¸ºæ‚¨è¿›è¡Œå®¢è§‚åˆ†æå’Œæ¨èã€‚"
```

**é—®é¢˜æè¿°**:
- AI è¿”å›æ™®é€šå¯¹è¯æ–‡æœ¬ï¼ŒæœªåŒ…å« JSON æ ¼å¼ geo_analysis
- è§£æå™¨æ— æ³•æå–æ—¶ç›´æ¥æŠ¥é”™ï¼Œæ— é™çº§å¤„ç†
- å¯¼è‡´æ•´ä¸ªè¯Šæ–­ä»»åŠ¡å¤±è´¥

**å½±å“èŒƒå›´**:
- DeepSeek å¹³å°è°ƒç”¨æˆåŠŸç‡é™ä½
- ç”¨æˆ·ç­‰å¾…åå¾—åˆ°å¤±è´¥ç»“æœ
- AI è°ƒç”¨è´¹ç”¨æµªè´¹

**æ ¹å› **:
```python
# geo_parser.pyï¼ˆç®€åŒ–ç‰ˆï¼‰
def parse_geo_json(text: str):
    # ä¸¥æ ¼è§£æ JSON
    data = json.loads(text)
    return data['geo_analysis']  # ä¸å­˜åœ¨æ—¶æŠ¥é”™
```

**ä¿®å¤æ–¹æ¡ˆ**:
```python
def parse_geo_json_enhanced(text: str):
    # 1. å°è¯•æå– JSON ä»£ç å—
    json_match = re.search(r'```json\s*(.*?)\s*```', text, re.DOTALL)
    if json_match:
        try:
            data = json.loads(json_match.group(1))
            return data.get('geo_analysis', default_data)
        except:
            pass
    
    # 2. å°è¯•æå–ä»»ä½• JSON å¯¹è±¡
    json_objects = extract_json_objects(text)
    for json_str in json_objects:
        try:
            data = json.loads(json_str)
            if 'geo_analysis' in data:
                return data['geo_analysis']
        except:
            pass
    
    # 3. é™çº§ï¼šè¿”å›é»˜è®¤å€¼ï¼Œä½†æ ‡è®°ä¸ºæˆåŠŸ
    api_logger.warning(f"æ— æ³•æå– geo_analysisï¼Œä½¿ç”¨é»˜è®¤å€¼")
    return {
        'brand_mentioned': False,
        'rank': -1,
        'sentiment': 0.0,
        'cited_sources': [],
        'interception': '',
        '_parse_warning': 'æ— æ³•ä» AI å“åº”ä¸­æå–ç»“æ„åŒ–æ•°æ®'
    }
```

**é¢„è®¡å·¥ä½œé‡**: 2-3 å°æ—¶

---

### P0-3: ç«å“è‡ªåŠ¨æå–åŠŸèƒ½ç¼ºå¤±

**é—®é¢˜æè¿°**: ç”¨æˆ·æœªæŒ‡å®šç«å“æ—¶ï¼Œç³»ç»Ÿæ— æ³•è‡ªåŠ¨æå–ç«å“è¿›è¡Œå¯¹æ¯”

**ç”¨æˆ·éœ€æ±‚**:
```
åœºæ™¯ï¼šç”¨æˆ·åªè¾“å…¥è‡ªå·±çš„å“ç‰Œï¼Œæœªé€‰æ‹©ç«å“
æœŸæœ›ï¼šç³»ç»Ÿè‡ªåŠ¨ä» AI å›ç­”ä¸­æå– TOP3 å“ç‰Œä½œä¸ºç«å“ï¼Œè¿›è¡Œå¯¹æ¯”åˆ†æ
å½“å‰ï¼šæ— ç«å“å¯¹æ¯”åŠŸèƒ½ï¼Œæˆ–è¦æ±‚ç”¨æˆ·å¿…é¡»é€‰æ‹©ç«å“
```

**å½±å“èŒƒå›´**:
- ç”¨æˆ·ä½“éªŒå·®ï¼ˆå¿…é¡»æ‰‹åŠ¨é€‰æ‹©ç«å“ï¼‰
- ç«å“å¯¹æ¯”åŠŸèƒ½ä½¿ç”¨ç‡ä½
- è¯Šæ–­æŠ¥å‘Šä»·å€¼é™ä½

**ä¿®å¤æ–¹æ¡ˆ**: åˆ›å»ºå“ç‰Œåˆ†ææœåŠ¡æ¨¡å—

```python
# æ–°æ–‡ä»¶ï¼šwechat_backend/services/brand_analysis_service.py
class BrandAnalysisService:
    """å“ç‰Œåˆ†ææœåŠ¡"""
    
    def analyze_brand_mentions(
        self,
        results: List[Dict],
        user_brand: str,
        competitor_brands: List[str] = None
    ) -> Dict[str, Any]:
        # æ­¥éª¤ 1: ä» AI å›ç­”ä¸­æå– TOP3 å“ç‰Œ
        all_top3_brands = []
        for result in results:
            top3 = self._extract_top3_brands(result['response'])
            all_top3_brands.extend(top3)
        
        # æ­¥éª¤ 2: è‹¥æœªæŒ‡å®šç«å“ï¼Œä½¿ç”¨ TOP3 å“ç‰Œä½œä¸ºç«å“
        if not competitor_brands:
            competitor_brands = [
                b['name'] for b in all_top3_brands 
                if b['name'] != user_brand
            ][:3]
        
        # æ­¥éª¤ 3: åˆ†æç”¨æˆ·å“ç‰Œè¡¨ç°
        # æ­¥éª¤ 4: åˆ†æç«å“å“ç‰Œè¡¨ç°
        # æ­¥éª¤ 5: ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
```

**é¢„è®¡å·¥ä½œé‡**: 8-10 å°æ—¶

---

## å››ã€P1 çº§ä¸¥é‡é—®é¢˜åˆ†æ

### P1-1: å‰ç«¯è½®è¯¢é¢‘ç‡è¿‡é«˜

**æ—¥å¿—è¯æ®**:
```
2026-02-27 22:17:21.646 - POST /api/perform-brand-test
2026-02-27 22:17:21.664 - GET /test/status (é—´éš” 18ms)
2026-02-27 22:17:21.915 - GET /test/status (é—´éš” 251ms)
2026-02-27 22:17:22.165 - GET /test/status (é—´éš” 250ms)
2026-02-27 22:17:22.420 - GET /test/status (é—´éš” 255ms)
...
æ€»è½®è¯¢æ¬¡æ•°ï¼š~120 æ¬¡ï¼ˆ128 ç§’ä»»åŠ¡ï¼‰
```

**é—®é¢˜æè¿°**:
- å‰ç«¯è½®è¯¢é—´éš”å›ºå®šä¸º 250-320ms
- 128 ç§’ä»»åŠ¡äº§ç”Ÿçº¦ 120 æ¬¡è½®è¯¢è¯·æ±‚
- é€ æˆæœåŠ¡å™¨èµ„æºæµªè´¹

**å½±å“èŒƒå›´**:
- æœåŠ¡å™¨è´Ÿè½½å¢åŠ 
- æ•°æ®åº“è¯»å–å‹åŠ›
- ç½‘ç»œå¸¦å®½æµªè´¹

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// å‰ç«¯è½®è¯¢ä¼˜åŒ–ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
let pollInterval = 500; // åˆå§‹ 500ms

const poll = async () => {
  const res = await getTaskStatus(executionId);
  
  if (res.progress < 50) {
    pollInterval = 500; // å‰ 50% å¿«é€Ÿè½®è¯¢
  } else if (res.progress < 80) {
    pollInterval = 1000; // 50-80% é™é€Ÿ
  } else {
    pollInterval = 2000; // 80% åæœ€æ…¢
  }
  
  setTimeout(poll, pollInterval);
};
```

**é¢„è®¡å·¥ä½œé‡**: 1-2 å°æ—¶

---

### P1-2: å¤šæ¨¡å‹å†—ä½™è°ƒç”¨æœºåˆ¶ç¼ºå¤±

**é—®é¢˜æè¿°**:
- å•æ¨¡å‹è°ƒç”¨å¤±è´¥æ—¶ï¼Œæ— è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æ¨¡å‹
- ç”¨æˆ·éœ€æ‰‹åŠ¨é‡è¯•æˆ–æ¥å—å¤±è´¥

**å½±å“èŒƒå›´**:
- è¯Šæ–­æˆåŠŸç‡é™ä½
- ç”¨æˆ·ä½“éªŒå·®

**ä¿®å¤æ–¹æ¡ˆ**:
```python
async def call_multiple_models(prompt, models=['doubao', 'qwen', 'deepseek']):
    """å¤šæ¨¡å‹å†—ä½™è°ƒç”¨"""
    tasks = [call_model(model, prompt) for model in models]
    done, pending = await asyncio.wait(
        tasks, 
        return_when=asyncio.FIRST_COMPLETED
    )
    
    for task in done:
        try:
            result = task.result()
            if validate_ai_response(result):
                return result  # è¿”å›ç¬¬ä¸€ä¸ªæœ‰æ•ˆç»“æœ
        except:
            pass
    
    raise Exception("æ‰€æœ‰ AI å¹³å°è°ƒç”¨å¤±è´¥")
```

**é¢„è®¡å·¥ä½œé‡**: 4-6 å°æ—¶

---

### P1-3: WebSocket å®æ—¶æ¨é€å‰ç«¯æœªé›†æˆ

**å½“å‰çŠ¶æ€**:
- âœ… åç«¯ WebSocket æœåŠ¡å·²å®ç°ï¼ˆ`websocket_service.py`, 450 è¡Œï¼‰
- âœ… å‰ç«¯ WebSocket å®¢æˆ·ç«¯å·²å®ç°ï¼ˆ`webSocketClient.js`, 350 è¡Œï¼‰
- âŒ å‰ç«¯æŠ¥å‘Šé¡µé¢æœªé›†æˆ WebSocket å®¢æˆ·ç«¯

**å½±å“èŒƒå›´**:
- å‰ç«¯ä»ä½¿ç”¨è½®è¯¢æœºåˆ¶ï¼Œå®æ—¶æ€§å·®
- æœåŠ¡å™¨èµ„æºæµªè´¹

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// miniprogram/pages/report-v2/report-v2.js
const wsClient = require('../../services/webSocketClient');

Page({
  onLoad(options) {
    // è¿æ¥ WebSocket
    wsClient.connect({
      executionId: options.executionId,
      onProgress: (data) => {
        this.setData({
          progress: data.progress,
          stage: data.stage
        });
      },
      onComplete: (data) => {
        this.setData({ report: data.report });
      }
    });
  }
});
```

**é¢„è®¡å·¥ä½œé‡**: 2-4 å°æ—¶

---

### P1-4: æç¤ºè¯ä¼˜åŒ–ä¸è¶³

**é—®é¢˜æè¿°**:
- æç¤ºè¯æœªæ˜ç¡®è¦æ±‚ JSON æ ¼å¼è¾“å‡º
- AI è¿”å›éç»“æ„åŒ–æ–‡æœ¬æ—¶æ— æ³•è§£æ

**ä¿®å¤æ–¹æ¡ˆ**:
```python
OBJECTIVE_QUESTION_TEMPLATE = """
è¯·å›ç­”ä»¥ä¸‹ç”¨æˆ·é—®é¢˜ï¼š
{question}

---
é‡è¦è¦æ±‚ï¼š
1. è¯·ä»¥ä¸“ä¸šé¡¾é—®çš„èº«ä»½å®¢è§‚å›ç­”ã€‚
2. è¯·åˆ—å‡ºæ‚¨æ¨èçš„ TOP3 å“ç‰Œ/é—¨åº—ï¼Œå¹¶è¯´æ˜ç†ç”±ã€‚
3. åœ¨å›ç­”ç»“æŸåï¼Œå¿…é¡»å¦èµ·ä¸€è¡Œï¼Œä»¥ä¸¥æ ¼çš„ JSON æ ¼å¼è¾“å‡ºä»¥ä¸‹å­—æ®µï¼ˆä¸è¦åŒ…å«åœ¨ Markdown ä»£ç å—ä¸­ï¼‰ï¼š
{{
  "top3_brands": [
    {{"name": "å“ç‰Œ 1", "rank": 1, "reason": "æ¨èç†ç”± 1"}},
    {{"name": "å“ç‰Œ 2", "rank": 2, "reason": "æ¨èç†ç”± 2"}},
    {{"name": "å“ç‰Œ 3", "rank": 3, "reason": "æ¨èç†ç”± 3"}}
  ],
  "total_brands_mentioned": 5
}}
"""
```

**é¢„è®¡å·¥ä½œé‡**: 1-2 å°æ—¶

---

### P1-5: å†å²å¼‚å¸¸æ•°æ®æ¸…ç†æœªå®Œæˆ

**é—®é¢˜æè¿°**:
- æ•°æ®åº“ä¸­å­˜ç•™å¤§é‡å†å²å¼‚å¸¸æ•°æ®ï¼ˆUNIQUE constraint é”™è¯¯ï¼‰
- å½±å“æ–°æ•°æ®å†™å…¥å’Œç»Ÿè®¡å‡†ç¡®æ€§

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# æ¸…ç†è„šæœ¬ï¼šscripts/cleanup_historical_errors.py
def cleanup_duplicate_reports():
    """æ¸…ç†é‡å¤æŠ¥å‘Š"""
    db.execute('''
        DELETE FROM diagnosis_reports
        WHERE execution_id IN (
            SELECT execution_id
            FROM diagnosis_reports
            GROUP BY execution_id
            HAVING COUNT(*) > 1
        )
        AND id NOT IN (
            SELECT MIN(id)
            FROM diagnosis_reports
            GROUP BY execution_id
        )
    ''')
```

**é¢„è®¡å·¥ä½œé‡**: 2-3 å°æ—¶

---

## äº”ã€P2 çº§ä¼˜åŒ–ç¼ºå¤±åˆ†æ

### P2-1: ç›‘æ§å‘Šè­¦æœªéƒ¨ç½²

**å½“å‰çŠ¶æ€**:
- âœ… ç›‘æ§æ¨¡å—å·²å®ç°ï¼ˆ`monitoring.py`, 380 è¡Œï¼‰
- âŒ æœªé…ç½®å‘Šè­¦é˜ˆå€¼
- âŒ æœªé›†æˆé€šçŸ¥æ¸ é“ï¼ˆé‚®ä»¶/çŸ­ä¿¡ï¼‰

**ç¼ºå¤±åŠŸèƒ½**:
1. AI è°ƒç”¨å¤±è´¥ç‡å‘Šè­¦
2. è¯Šæ–­è¶…æ—¶å‘Šè­¦
3. æ•°æ®åº“è¿æ¥ç›‘æ§
4. å‰ç«¯é”™è¯¯ç›‘æ§

**é¢„è®¡å·¥ä½œé‡**: 8-12 å°æ—¶

---

### P2-2: Redis ç¼“å­˜æœªå¼•å…¥

**å½“å‰çŠ¶æ€**:
- æ‰€æœ‰çŠ¶æ€æŸ¥è¯¢ç›´æ¥è®¿é—®æ•°æ®åº“
- è½®è¯¢è¯·æ±‚ 100% å‘½ä¸­æ•°æ®åº“

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# å¼•å…¥ Redis ç¼“å­˜
from redis import Redis

redis_client = Redis()

def get_task_status(task_id):
    # å…ˆæŸ¥ç¼“å­˜
    cached = redis_client.get(f"task_status:{task_id}")
    if cached:
        return json.loads(cached)
    
    # ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“
    status = db.query(...)
    
    # å†™å…¥ç¼“å­˜ï¼ˆ5 åˆ†é’Ÿè¿‡æœŸï¼‰
    redis_client.setex(
        f"task_status:{task_id}",
        300,
        json.dumps(status)
    )
    
    return status
```

**é¢„è®¡å·¥ä½œé‡**: 6-8 å°æ—¶

---

### P2-3: æ— ç”¨ä»£ç æœªæ¸…ç†

**å½“å‰çŠ¶æ€**:
- å­˜åœ¨å¤§é‡å†å²é—ç•™ä»£ç 
- å­˜åœ¨å·²åºŸå¼ƒçš„è¡¨å’Œå­—æ®µ

**ä¿®å¤æ–¹æ¡ˆ**:
```bash
# æ¸…ç†è„šæœ¬ï¼šscripts/cleanup_deprecated_code.sh
# 1. åˆ é™¤åºŸå¼ƒæ–‡ä»¶
rm -f wechat_backend/old_*.py
rm -f wechat_backend/deprecated_*.py

# 2. åˆ é™¤åºŸå¼ƒè¡¨
sqlite3 database.db "DROP TABLE IF EXISTS test_records;"
sqlite3 database.db "DROP TABLE IF EXISTS old_brand_results;"
```

**é¢„è®¡å·¥ä½œé‡**: 4-6 å°æ—¶

---

### P2-4: æ¶ˆæ¯é˜Ÿåˆ—æœªå®ç°

**å½“å‰çŠ¶æ€**:
- æ‰€æœ‰ä»»åŠ¡åŒæ­¥æ‰§è¡Œ
- å¤§å¹¶å‘æ—¶æœåŠ¡å™¨å‹åŠ›å¤§

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# ä½¿ç”¨ Celery å¼‚æ­¥ä»»åŠ¡
from celery import Celery

app = Celery('diagnosis', broker='redis://localhost:6379/0')

@app.task
def execute_diagnosis_task(execution_id, params):
    """å¼‚æ­¥æ‰§è¡Œè¯Šæ–­"""
    return execute_nxm_test(execution_id, **params)

# è§†å›¾å±‚è°ƒç”¨
task = execute_diagnosis_task.delay(
    execution_id=execution_id,
    params=params
)
```

**é¢„è®¡å·¥ä½œé‡**: 12-16 å°æ—¶

---

### P2-5: CDN åŠ é€Ÿæœªé…ç½®

**å½“å‰çŠ¶æ€**:
- é™æ€èµ„æºç›´æ¥ä»æœåŠ¡å™¨åŠ è½½
- å‰ç«¯åŠ è½½é€Ÿåº¦æ…¢

**ä¼˜åŒ–æ–¹æ¡ˆ**:
- é…ç½® CDN åŠ é€Ÿé™æ€èµ„æºï¼ˆJS/CSS/å›¾ç‰‡ï¼‰
- é…ç½® OSS å­˜å‚¨æŠ¥å‘Šæ–‡ä»¶

**é¢„è®¡å·¥ä½œé‡**: 4-6 å°æ—¶

---

### P2-6: æ•°æ®åº“è¯»å†™åˆ†ç¦»æœªå®ç°

**å½“å‰çŠ¶æ€**:
- æ‰€æœ‰è¯»å†™æ“ä½œä½¿ç”¨åŒä¸€æ•°æ®åº“è¿æ¥
- é«˜å¹¶å‘æ—¶é”ç«äº‰ä¸¥é‡

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# ä¸»åº“å†™ï¼Œä»åº“è¯»
class DatabaseRouter:
    def read_db(self):
        return sqlite3.connect('database_slave.db')
    
    def write_db(self):
        return sqlite3.connect('database_master.db')
```

**é¢„è®¡å·¥ä½œé‡**: 8-10 å°æ—¶

---

### P2-7: æ™ºèƒ½ç¼“å­˜é¢„çƒ­æœªå®ç°

**å½“å‰çŠ¶æ€**:
- ç¼“å­˜è¢«åŠ¨å¡«å……
- é¦–æ¬¡æŸ¥è¯¢æ…¢

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# å®šæ—¶ä»»åŠ¡é¢„çƒ­ç¼“å­˜
@app.schedule('0 8 * * *')  # æ¯å¤© 8 ç‚¹
def warmup_cache():
    """é¢„çƒ­çƒ­é—¨å“ç‰Œç¼“å­˜"""
    popular_brands = db.query(
        "SELECT brand_name FROM diagnosis_reports GROUP BY brand_name ORDER BY COUNT(*) DESC LIMIT 10"
    )
    
    for brand in popular_brands:
        # é¢„åŠ è½½å“ç‰Œç»Ÿè®¡æ•°æ®
        stats = calculate_brand_stats(brand)
        redis_client.setex(f"brand_stats:{brand}", 3600, json.dumps(stats))
```

**é¢„è®¡å·¥ä½œé‡**: 6-8 å°æ—¶

---

### P2-8: é¢„æµ‹æ€§è¯Šæ–­æœªå®ç°

**å½“å‰çŠ¶æ€**:
- è¢«åŠ¨å“åº”ç”¨æˆ·è¯·æ±‚
- æ— ä¸»åŠ¨æ¨èèƒ½åŠ›

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# åŸºäºç”¨æˆ·å†å²è¡Œä¸ºé¢„æµ‹è¯Šæ–­éœ€æ±‚
def predict_diagnosis_need(user_id):
    """é¢„æµ‹ç”¨æˆ·å¯èƒ½éœ€è¦çš„è¯Šæ–­"""
    history = get_user_history(user_id)
    
    # åˆ†æç”¨æˆ·å…³æ³¨è¶‹åŠ¿
    if 'æ–°èƒ½æºæ±½è½¦' in history.recent_searches:
        return {
            'suggested_question': 'æ–°èƒ½æºæ±½è½¦å“ç‰Œæ¨è',
            'suggested_competitors': ['æ¯”äºšè¿ª', 'ç‰¹æ–¯æ‹‰', 'å°é¹']
        }
```

**é¢„è®¡å·¥ä½œé‡**: 16-20 å°æ—¶

---

## å…­ã€é—®é¢˜ä¼˜å…ˆçº§çŸ©é˜µ

| ä¼˜å…ˆçº§ | é—®é¢˜ç¼–å· | é—®é¢˜æè¿° | å½±å“èŒƒå›´ | ä¿®å¤éš¾åº¦ | é¢„è®¡æ—¶é—´ |
|--------|---------|---------|---------|---------|---------|
| **P0** | P0-1 | è¯Šæ–­é€»è¾‘è®¾è®¡é”™è¯¯ | 100% ä»»åŠ¡ | ä¸­ | 4-6h |
| **P0** | P0-2 | AI å“åº”è§£æå®¹é”™ä¸è¶³ | 20% ä»»åŠ¡ | ä½ | 2-3h |
| **P0** | P0-3 | ç«å“è‡ªåŠ¨æå–ç¼ºå¤± | 80% ç”¨æˆ· | ä¸­ | 8-10h |
| **P1** | P1-1 | å‰ç«¯è½®è¯¢é¢‘ç‡è¿‡é«˜ | 100% ä»»åŠ¡ | ä½ | 1-2h |
| **P1** | P1-2 | å¤šæ¨¡å‹å†—ä½™ç¼ºå¤± | 30% ä»»åŠ¡ | ä¸­ | 4-6h |
| **P1** | P1-3 | WebSocket å‰ç«¯æœªé›†æˆ | 100% ç”¨æˆ· | ä½ | 2-4h |
| **P1** | P1-4 | æç¤ºè¯ä¼˜åŒ–ä¸è¶³ | 50% ä»»åŠ¡ | ä½ | 1-2h |
| **P1** | P1-5 | å†å²å¼‚å¸¸æ•°æ®æœªæ¸…ç† | æ•°æ®åº“ | ä½ | 2-3h |
| **P2** | P2-1 | ç›‘æ§å‘Šè­¦æœªéƒ¨ç½² | è¿ç»´ | ä¸­ | 8-12h |
| **P2** | P2-2 | Redis ç¼“å­˜æœªå¼•å…¥ | æ€§èƒ½ | ä¸­ | 6-8h |
| **P2** | P2-3 | æ— ç”¨ä»£ç æœªæ¸…ç† | ç»´æŠ¤ | ä½ | 4-6h |
| **P2** | P2-4 | æ¶ˆæ¯é˜Ÿåˆ—æœªå®ç° | æ‰©å±•æ€§ | é«˜ | 12-16h |
| **P2** | P2-5 | CDN åŠ é€Ÿæœªé…ç½® | æ€§èƒ½ | ä½ | 4-6h |
| **P2** | P2-6 | æ•°æ®åº“è¯»å†™åˆ†ç¦» | å¹¶å‘ | ä¸­ | 8-10h |
| **P2** | P2-7 | æ™ºèƒ½ç¼“å­˜é¢„çƒ­ | æ€§èƒ½ | ä¸­ | 6-8h |
| **P2** | P2-8 | é¢„æµ‹æ€§è¯Šæ–­ | æ™ºèƒ½åŒ– | é«˜ | 16-20h |

---

## ä¸ƒã€ä¿®å¤å®æ–½è®¡åˆ’

### 7.1 ç¬¬ä¸€é˜¶æ®µï¼šP0 çº§ä¿®å¤ï¼ˆ1-2 å¤©ï¼‰

**ç›®æ ‡**: ä¿®å¤æ ¸å¿ƒé˜»æ–­é—®é¢˜ï¼Œæ¢å¤å®¢è§‚è¯Šæ–­èƒ½åŠ›

**ä»»åŠ¡**:
1. âœ… ä¿®æ”¹æç¤ºè¯æ¨¡æ¿ï¼ˆP0-1ï¼‰
2. âœ… ä¿®æ”¹æ‰§è¡Œå¼•æ“å¾ªç¯é€»è¾‘ï¼ˆP0-1ï¼‰
3. âœ… å¢å¼ºè§£æå™¨å®¹é”™æ€§ï¼ˆP0-2ï¼‰
4. âœ… æ·»åŠ å“ç‰Œåˆ†ææœåŠ¡ï¼ˆP0-3ï¼‰

**éªŒæ”¶æ ‡å‡†**:
- [ ] è¯Šæ–­è¯·æ±‚æ¬¡æ•° = é—®é¢˜æ•° Ã— AI å¹³å°æ•°
- [ ] æç¤ºè¯æ— å“ç‰Œå€¾å‘
- [ ] AI å“åº”è§£ææˆåŠŸç‡ > 95%
- [ ] èƒ½è‡ªåŠ¨æå–ç«å“å¹¶å¯¹æ¯”

---

### 7.2 ç¬¬äºŒé˜¶æ®µï¼šP1 çº§ä¿®å¤ï¼ˆ2-3 å¤©ï¼‰

**ç›®æ ‡**: ä¿®å¤ä¸¥é‡é—®é¢˜ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

**ä»»åŠ¡**:
1. âœ… ä¼˜åŒ–å‰ç«¯è½®è¯¢é¢‘ç‡ï¼ˆP1-1ï¼‰
2. âœ… å®ç°å¤šæ¨¡å‹å†—ä½™è°ƒç”¨ï¼ˆP1-2ï¼‰
3. âœ… é›†æˆ WebSocket å‰ç«¯ï¼ˆP1-3ï¼‰
4. âœ… ä¼˜åŒ–æç¤ºè¯æ ¼å¼è¦æ±‚ï¼ˆP1-4ï¼‰
5. âœ… æ¸…ç†å†å²å¼‚å¸¸æ•°æ®ï¼ˆP1-5ï¼‰

**éªŒæ”¶æ ‡å‡†**:
- [ ] è½®è¯¢æ¬¡æ•°å‡å°‘ 50%
- [ ] å•æ¨¡å‹å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢
- [ ] WebSocket æ¨é€æ­£å¸¸
- [ ] æ•°æ®åº“æ— å†å²é”™è¯¯æ•°æ®

---

### 7.3 ç¬¬ä¸‰é˜¶æ®µï¼šP2 çº§ä¼˜åŒ–ï¼ˆ1-2 å‘¨ï¼‰

**ç›®æ ‡**: ç³»ç»Ÿä¼˜åŒ–å’Œå¢å¼º

**ä»»åŠ¡**:
1. â³ éƒ¨ç½²ç›‘æ§å‘Šè­¦ï¼ˆP2-1ï¼‰
2. â³ å¼•å…¥ Redis ç¼“å­˜ï¼ˆP2-2ï¼‰
3. â³ æ¸…ç†æ— ç”¨ä»£ç ï¼ˆP2-3ï¼‰
4. â³ å®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆP2-4ï¼‰
5. â³ é…ç½® CDN åŠ é€Ÿï¼ˆP2-5ï¼‰
6. â³ å®ç°æ•°æ®åº“è¯»å†™åˆ†ç¦»ï¼ˆP2-6ï¼‰
7. â³ å®ç°æ™ºèƒ½ç¼“å­˜é¢„çƒ­ï¼ˆP2-7ï¼‰
8. â³ å®ç°é¢„æµ‹æ€§è¯Šæ–­ï¼ˆP2-8ï¼‰

**éªŒæ”¶æ ‡å‡†**:
- [ ] å…³é”®æ•…éšœ 5 åˆ†é’Ÿå†…å‘Šè­¦
- [ ] ç¼“å­˜å‘½ä¸­ç‡ > 80%
- [ ] ä»£ç åº“ç²¾ç®€ 30%
- [ ] æ”¯æŒå¼‚æ­¥ä»»åŠ¡å¤„ç†
- [ ] é™æ€èµ„æºåŠ è½½æ—¶é—´ < 1s
- [ ] å¹¶å‘èƒ½åŠ›æå‡ 5 å€

---

## å…«ã€éªŒè¯ä¸æµ‹è¯•è®¡åˆ’

### 8.1 å•å…ƒæµ‹è¯•

```python
# æµ‹è¯•ç”¨ä¾‹æ¸…å•
test_cases = [
    'test_objective_question_generation',
    'test_brand_mention_analysis',
    'test_top3_brand_extraction',
    'test_competitor_comparison',
    'test_enhanced_geo_parser',
    'test_multi_model_fallback',
    'test_polling_optimization',
]
```

### 8.2 é›†æˆæµ‹è¯•

```python
# ç«¯åˆ°ç«¯æµ‹è¯•
def test_e2e_diagnosis_flow():
    # 1. å‘èµ·è¯Šæ–­ï¼ˆ1 é—®é¢˜Ã—2AIï¼‰
    execution_id = start_diagnosis(
        brand='è¶£è½¦è‰¯å“',
        question='æ·±åœ³æ–°èƒ½æºæ±½è½¦æ”¹è£…é—¨åº—å“ªå®¶å¥½',
        models=['doubao', 'qwen']
    )
    
    # 2. éªŒè¯è¯·æ±‚æ¬¡æ•° = 2
    assert ai_call_count == 2
    
    # 3. éªŒè¯æç¤ºè¯æ— å“ç‰Œå€¾å‘
    prompts = get_ai_prompts(execution_id)
    assert 'è¶£è½¦è‰¯å“' not in prompts[0]
    
    # 4. éªŒè¯è‡ªåŠ¨ç«å“æå–
    report = get_diagnosis_report(execution_id)
    assert len(report['competitors']) == 3
    
    # 5. éªŒè¯å¯¹æ¯”åˆ†æ
    assert 'comparison' in report
```

### 8.3 æ€§èƒ½æµ‹è¯•

```python
# æ€§èƒ½åŸºå‡†æµ‹è¯•
def test_performance_benchmark():
    # å¹¶å‘ 100 ä¸ªè¯Šæ–­ä»»åŠ¡
    start_time = time.time()
    results = concurrent_diagnosis(count=100)
    duration = time.time() - start_time
    
    # éªŒè¯æ€§èƒ½æŒ‡æ ‡
    assert duration < 300  # 5 åˆ†é’Ÿå†…å®Œæˆ
    assert results.success_rate > 0.95
    assert results.avg_response_time < 180
```

---

## ä¹ã€ç›‘æ§æŒ‡æ ‡

### 9.1 æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰å€¼ | ç›®æ ‡å€¼ | å‘Šè­¦é˜ˆå€¼ |
|------|-------|-------|---------|
| è¯Šæ–­æˆåŠŸç‡ | 100% | >95% | <90% |
| ç©ºæŠ¥å‘Šç‡ | 0% | <5% | >10% |
| å¡æ­»ç‡ | 0% | <2% | >5% |
| å¹³å‡å“åº”æ—¶é—´ | 128s | <120s | >180s |
| AI è§£ææˆåŠŸç‡ | ~80% | >95% | <90% |
| è½®è¯¢æ¬¡æ•°/ä»»åŠ¡ | ~120 | <60 | >100 |

### 9.2 å‘Šè­¦é…ç½®

```yaml
monitoring:
  ai_parse_errors:
    threshold: 5/å°æ—¶
    alert_level: warning
    notification: email
  
  diagnosis_failure_rate:
    threshold: 10%
    alert_level: critical
    notification: sms
  
  polling_frequency:
    threshold: 100 æ¬¡/ä»»åŠ¡
    alert_level: warning
    notification: email
  
  websocket_connection_failures:
    threshold: 20/å°æ—¶
    alert_level: warning
    notification: email
```

---

## åã€ç»“è®ºä¸å»ºè®®

### 10.1 æ ¸å¿ƒç»“è®º

1. **è¯Šæ–­é€»è¾‘è®¾è®¡é”™è¯¯**æ˜¯å½±å“ç³»ç»Ÿå®¢è§‚æ€§çš„**é¦–è¦åŸå› **
2. **AI å“åº”è§£æå®¹é”™ä¸è¶³**å¯¼è‡´éƒ¨åˆ†ä»»åŠ¡å¤±è´¥
3. **ç«å“è‡ªåŠ¨æå–ç¼ºå¤±**å½±å“ç”¨æˆ·ä½“éªŒå’ŒæŠ¥å‘Šä»·å€¼
4. **å‰ç«¯è½®è¯¢é¢‘ç‡è¿‡é«˜**é€ æˆèµ„æºæµªè´¹
5. **WebSocket å‰ç«¯æœªé›†æˆ**å½±å“å®æ—¶æ€§

### 10.2 ä¿®å¤ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | ä¿®å¤é¡¹ | é¢„è®¡æ—¶é—´ | å½±å“ |
|--------|-------|---------|------|
| **P0** | ä¿®æ”¹è¯Šæ–­é€»è¾‘è®¾è®¡ | 4-6h | æ¢å¤å®¢è§‚è¯Šæ–­ |
| **P0** | å¢å¼ºè§£æå™¨å®¹é”™æ€§ | 2-3h | æå‡æˆåŠŸç‡ |
| **P0** | æ·»åŠ ç«å“è‡ªåŠ¨æå– | 8-10h | æ”¹å–„ç”¨æˆ·ä½“éªŒ |
| **P1** | ä¼˜åŒ–å‰ç«¯è½®è¯¢ | 1-2h | å‡å°‘èµ„æºæµªè´¹ |
| **P1** | é›†æˆ WebSocket | 2-4h | æå‡å®æ—¶æ€§ |

### 10.3 é•¿æœŸå»ºè®®

1. **å»ºç«‹ç«¯åˆ°ç«¯ç›‘æ§**: å®ç°ä»ç”¨æˆ·å‘èµ·è¯Šæ–­åˆ°æŠ¥å‘Šç”Ÿæˆçš„å…¨é“¾è·¯ç›‘æ§
2. **å®Œå–„å‘Šè­¦æœºåˆ¶**: å…³é”®æ•…éšœ 5 åˆ†é’Ÿå†…å‘ç°å¹¶å‘Šè­¦
3. **æå‡æµ‹è¯•è¦†ç›–**: å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%ï¼Œé›†æˆæµ‹è¯•è¦†ç›–æ ¸å¿ƒæµç¨‹
4. **å®šæœŸå¥åº·æ£€æŸ¥**: æ¯æ—¥è‡ªåŠ¨æ£€æŸ¥ AI å¹³å°å¯ç”¨æ€§
5. **æ–‡æ¡£ç»´æŠ¤**: ä¿æŒ API æ–‡æ¡£ä¸å®é™…ä»£ç åŒæ­¥
6. **æŠ€æœ¯å€ºåŠ¡ç®¡ç†**: å®šæœŸæ¸…ç†æ— ç”¨ä»£ç å’Œå†å²æ•°æ®

---

## é™„å½•

### é™„å½• A: å…³é”®æ–‡ä»¶è·¯å¾„

| æ–‡ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| æ‰§è¡Œå¼•æ“ | `wechat_backend/nxm_execution_engine.py` | AI è°ƒç”¨é€»è¾‘ |
| è°ƒåº¦å™¨ | `wechat_backend/nxm_scheduler.py` | ä»»åŠ¡è°ƒåº¦ |
| è±†åŒ…é€‚é…å™¨ | `wechat_backend/ai_adapters/doubao_adapter.py` | è±†åŒ… API é›†æˆ |
| GEO è§£æå™¨ | `wechat_backend/geo_parser.py` | GEO å“åº”è§£æ |
| è¯Šæ–­è§†å›¾ | `wechat_backend/views/diagnosis_views.py` | API å…¥å£ |
| æ•°æ®ä»“åº“ | `wechat_backend/diagnosis_report_repository.py` | æ•°æ®æŒä¹…åŒ– |
| WebSocket æœåŠ¡ | `wechat_backend/v2/services/websocket_service.py` | WebSocket æ¨é€ |
| å“ç‰Œåˆ†ææœåŠ¡ | `wechat_backend/services/brand_analysis_service.py` | å¾…åˆ›å»º |

### é™„å½• B: æ•°æ®åº“è¡¨ç»“æ„

```sql
-- è¯Šæ–­æŠ¥å‘Šä¸»è¡¨
CREATE TABLE diagnosis_reports (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    execution_id TEXT UNIQUE NOT NULL,
    user_id TEXT NOT NULL,
    brand_name TEXT NOT NULL,
    competitor_brands TEXT NOT NULL,  -- JSON æ•°ç»„
    selected_models TEXT NOT NULL,    -- JSON æ•°ç»„
    custom_questions TEXT NOT NULL,   -- JSON æ•°ç»„
    status TEXT NOT NULL DEFAULT 'processing',
    progress INTEGER NOT NULL DEFAULT 0,
    stage TEXT NOT NULL DEFAULT 'init',
    is_completed BOOLEAN NOT NULL DEFAULT 0,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL,
    completed_at TEXT
);

-- è¯Šæ–­ç»“æœè¡¨
CREATE TABLE diagnosis_results (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    report_id INTEGER NOT NULL,
    execution_id TEXT NOT NULL,
    brand TEXT NOT NULL,
    question TEXT NOT NULL,
    model TEXT NOT NULL,
    response_content TEXT NOT NULL,
    response_latency REAL,
    geo_data TEXT NOT NULL,          -- JSON å¯¹è±¡
    quality_score REAL NOT NULL DEFAULT 0,
    quality_level TEXT NOT NULL DEFAULT 'unknown',
    quality_details TEXT NOT NULL,   -- JSON å¯¹è±¡
    status TEXT NOT NULL DEFAULT 'success',
    error_message TEXT,
    created_at TEXT NOT NULL,
    FOREIGN KEY (report_id) REFERENCES diagnosis_reports(id)
);

-- ä»»åŠ¡çŠ¶æ€è¡¨
CREATE TABLE task_statuses (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id TEXT UNIQUE NOT NULL,
    progress INTEGER DEFAULT 0,
    stage TEXT NOT NULL,
    status_text TEXT,
    completed_count INTEGER DEFAULT 0,
    total_count INTEGER DEFAULT 0,
    is_completed BOOLEAN DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å“ç‰Œåˆ†æè¡¨ï¼ˆå¾…åˆ›å»ºï¼‰
CREATE TABLE diagnosis_analysis (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    report_id INTEGER NOT NULL,
    execution_id TEXT NOT NULL,
    analysis_type TEXT NOT NULL,  -- 'brand_analysis', 'competitor_analysis'
    analysis_data TEXT NOT NULL,  -- JSON
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (report_id) REFERENCES diagnosis_reports(id)
);
```

### é™„å½• C: æ—¥å¿—åˆ†æå‘½ä»¤

```bash
# æŸ¥çœ‹ AI è°ƒç”¨å¤±è´¥æ—¥å¿—
grep "AI è°ƒç”¨å¤±è´¥" backend_python/logs/app.log | tail -20

# æŸ¥çœ‹è§£æé”™è¯¯æ—¥å¿—
grep "è§£æå¤±è´¥" backend_python/logs/app.log | tail -20

# æŸ¥çœ‹è¯Šæ–­è¯·æ±‚æ—¥å¿—
grep "perform-brand-test" backend_python/logs/app.log | tail -20

# æŸ¥çœ‹è½®è¯¢è¯·æ±‚ç»Ÿè®¡
grep "GET /test/status" backend_python/logs/app.log | wc -l
```

### é™„å½• D: æ•°æ®åº“æŸ¥è¯¢å‘½ä»¤

```sql
-- æŸ¥è¯¢è¯Šæ–­ä»»åŠ¡çŠ¶æ€åˆ†å¸ƒ
SELECT status, COUNT(*) as count, 
       ROUND(COUNT(*)*100.0/(SELECT COUNT(*) FROM diagnosis_reports),1) as percentage
FROM diagnosis_reports
GROUP BY status;

-- æŸ¥è¯¢å¡ä½çš„ä»»åŠ¡
SELECT execution_id, brand_name, status, progress, stage, created_at
FROM diagnosis_reports
WHERE status='processing' AND created_at < datetime('now', '-1 hour');

-- æŸ¥è¯¢ AI è°ƒç”¨æˆåŠŸç‡
SELECT model, 
       COUNT(*) as total,
       SUM(CASE WHEN status='success' THEN 1 ELSE 0 END) as success,
       ROUND(SUM(CASE WHEN status='success' THEN 1 ELSE 0 END)*100.0/COUNT(*),1) as success_rate
FROM diagnosis_results
GROUP BY model;

-- æŸ¥è¯¢å¹³å‡å“åº”æ—¶é—´
SELECT model, ROUND(AVG(response_latency),1) as avg_latency
FROM diagnosis_results
WHERE status='success'
GROUP BY model;
```

---

**æŠ¥å‘Šç¼–åˆ¶**: ç³»ç»Ÿæ¶æ„ç»„
**å®¡æ ¸**: æŠ€æœ¯å§”å‘˜ä¼š
**æ—¥æœŸ**: 2026-02-28
**ç‰ˆæœ¬**: v1.0
**ä¸‹æ¬¡æ›´æ–°**: 2026-03-07ï¼ˆä¿®å¤åéªŒè¯ï¼‰
