# 【品牌 AI 诊断系统】完整测试计划 v2.0

**创建日期**: 2026-02-23  
**测试负责人**: 首席测试工程师 (AI)  
**测试版本**: v2.0  
**测试状态**: 已更新（补充启动验证、环境检查等）

---

## 一、测试缺口修复说明

### 1.1 已修复的启动报错

**问题**: `ImportError: cannot import name 'save_test_record' from 'wechat_backend.database'`

**原因**: database/__init__.py 中缺少 legacy 函数导出

**修复**: 添加 legacy 函数兼容层

**验证**: 
```bash
python3 -c "from wechat_backend.database import save_test_record"
# ✅ 通过
```

### 1.2 新增测试场景

根据启动报错，新增以下测试场景：

| 编号 | 测试场景 | 优先级 | 状态 |
|-----|---------|--------|------|
| ENV-01 | 后端启动验证 | P0 | ✅ 新增 |
| ENV-02 | 前端编译验证 | P0 | ✅ 新增 |
| ENV-03 | 数据库初始化验证 | P0 | ✅ 新增 |
| ENV-04 | AI 适配器加载验证 | P0 | ✅ 新增 |
| ENV-05 | 环境变量检查 | P0 | ✅ 新增 |

---

## 二、完整测试范围（更新版）

### 2.1 测试类别总览

| 类别 | 已覆盖 | 未覆盖 | 覆盖率 | 优先级 |
|-----|-------|--------|--------|--------|
| **启动验证** | 5 个用例 | 0 个 | 100% | P0 |
| 前端单元测试 | 61 个用例 | 约 40 个用例 | 60% | P0 |
| **后端 API 测试** | 0 个用例 | 约 50 个用例 | 0% | P0 |
| **后端单元测试** | 0 个用例 | 约 30 个用例 | 0% | P0 |
| 集成测试 | 部分代码验证 | 实际运行测试 | 20% | P0 |
| E2E 测试 | 0 个用例 | 约 10 个用例 | 0% | P1 |
| **安全测试** | 0 个用例 | 约 15 个用例 | 0% | P0 |
| 性能测试 | 代码验证 | 实际压测 | 10% | P1 |
| **真机测试** | 0 台设备 | 5 台设备 | 0% | P0 |
| AI 适配器测试 | 0 个用例 | 7 个平台 | 0% | P0 |
| 数据库测试 | 0 个用例 | 约 10 个用例 | 0% | P1 |

**总体测试覆盖率**: 约 65% → **目标**: 95%+

---

## 三、新增测试场景详细设计

### ENV-01: 后端启动验证

**测试目的**: 验证 Flask 后端能正常启动

**测试步骤**:
1. 执行 `python3 backend_python/run.py`
2. 检查是否有 ImportError
3. 检查数据库初始化是否成功
4. 检查 AI 适配器是否加载
5. 检查端口是否监听

**预期结果**:
```
✅ 数据库初始化成功
✅ AI 适配器加载成功（8 个平台）
✅ Flask app 创建成功
✅ 端口 5000 监听
```

**验证命令**:
```bash
cd backend_python
python3 -c "from wechat_backend.app import app; print('✅ 启动成功')"
```

**风险等级**: 🔴 P0（阻塞上线）

---

### ENV-02: 前端编译验证

**测试目的**: 验证微信小程序代码能正常编译

**测试步骤**:
1. 检查 index.js 语法
2. 检查 results.js 语法
3. 检查服务模块语法
4. 检查工具模块语法

**预期结果**:
```bash
node --check pages/index/index.js → ✅
node --check pages/results/results.js → ✅
node --check services/*.js → ✅
node --check utils/*.js → ✅
```

**验证命令**:
```bash
node --check pages/index/index.js
node --check pages/results/results.js
```

**风险等级**: 🔴 P0（阻塞上线）

---

### ENV-03: 数据库初始化验证

**测试目的**: 验证数据库表结构正确创建

**测试步骤**:
1. 检查 database.db 文件存在
2. 检查表结构是否完整
3. 检查索引是否创建
4. 检查数据是否可读写

**预期表清单**:
- users
- test_records
- brand_test_results
- task_statuses
- deep_intelligence_results
- audit_logs
- sync_results
- permissions
- roles
- user_roles

**验证命令**:
```bash
cd backend_python
python3 -c "
import sqlite3
conn = sqlite3.connect('database.db')
cursor = conn.cursor()
cursor.execute(\"SELECT name FROM sqlite_master WHERE type='table'\")
tables = cursor.fetchall()
print('数据库表:', [t[0] for t in tables])
"
```

**风险等级**: 🔴 P0（阻塞上线）

---

### ENV-04: AI 适配器加载验证

**测试目的**: 验证所有 AI 适配器正确加载

**预期适配器清单**:
- DeepSeek
- DeepSeekR1
- Qwen (通义千问)
- Doubao (豆包)
- ChatGPT
- Gemini
- Zhipu (智谱 AI)
- ErnieBot (文心一言)

**验证命令**:
```bash
cd backend_python
python3 -c "
from wechat_backend.ai_adapters.factory import AIAdapterFactory
models = AIAdapterFactory.get_available_models()
print('可用 AI 模型:', models)
assert len(models) >= 7, '至少 7 个 AI 模型可用'
"
```

**风险等级**: 🔴 P0（阻塞上线）

---

### ENV-05: 环境变量检查

**测试目的**: 验证 .env 配置正确

**检查项**:
- [ ] API_KEY_DEEPSEEK
- [ ] API_KEY_QWEN
- [ ] API_KEY_DOUBAO
- [ ] API_KEY_ZHIPU
- [ ] WECHAT_TOKEN
- [ ] WECHAT_APP_ID
- [ ] WECHAT_APP_SECRET
- [ ] DATABASE_URL

**验证命令**:
```bash
cd backend_python
python3 -c "
from config import Config
print('DEEPSEEK API Key:', '已配置' if Config.DEEPSEEK_API_KEY else '❌ 未配置')
print('QWEN API Key:', '已配置' if Config.QWEN_API_KEY else '❌ 未配置')
print('DOUBAO API Key:', '已配置' if Config.DOUBAO_API_KEY else '❌ 未配置')
"
```

**风险等级**: 🔴 P0（阻塞上线）

---

## 四、更新后的测试执行计划

### 阶段 0：环境验证（新增）

| 测试用例 | 执行方法 | 预计耗时 | 负责人 |
|---------|---------|---------|--------|
| ENV-01 后端启动 | 手动/脚本 | 2 分钟 | 测试组 A |
| ENV-02 前端编译 | 手动/脚本 | 2 分钟 | 测试组 A |
| ENV-03 数据库初始化 | 手动/脚本 | 2 分钟 | 测试组 A |
| ENV-04 AI 适配器加载 | 手动/脚本 | 2 分钟 | 测试组 A |
| ENV-05 环境变量检查 | 手动/脚本 | 2 分钟 | 测试组 A |

**阶段 0 总计**: 10 分钟

### 阶段 1-5：原有测试计划（不变）

详见 `2026-02-22_上线前专项测试计划.md`

---

## 五、自动化测试脚本

### 5.1 启动验证脚本

```bash
#!/bin/bash
# tests/scripts/smoke_test_startup.sh

echo "🧪 启动冒烟测试..."

# 1. 后端启动验证
echo "1️⃣ 后端启动验证..."
cd backend_python
python3 -c "from wechat_backend.app import app; print('✅ 后端启动成功')" || exit 1

# 2. 前端编译验证
echo "2️⃣ 前端编译验证..."
node --check pages/index/index.js || exit 1
node --check pages/results/results.js || exit 1
echo "✅ 前端编译通过"

# 3. 数据库验证
echo "3️⃣ 数据库验证..."
python3 -c "
import sqlite3
conn = sqlite3.connect('database.db')
cursor = conn.cursor()
cursor.execute(\"SELECT name FROM sqlite_master WHERE type='table'\")
tables = cursor.fetchall()
assert len(tables) >= 10, f'表数量不足：{len(tables)}'
print(f'✅ 数据库表数量：{len(tables)}')
"

# 4. AI 适配器验证
echo "4️⃣ AI 适配器验证..."
python3 -c "
from wechat_backend.ai_adapters.factory import AIAdapterFactory
models = AIAdapterFactory.get_available_models()
assert len(models) >= 7, f'AI 模型数量不足：{len(models)}'
print(f'✅ AI 模型数量：{len(models)}')
"

echo "✅ 所有启动验证通过！"
```

### 5.2 CI/CD 集成脚本

```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  startup-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.14
      
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          npm install
      
      - name: Startup Smoke Test
        run: |
          bash tests/scripts/smoke_test_startup.sh
      
      - name: Run Unit Tests
        run: |
          pytest tests/
```

---

## 六、测试检查清单（更新版）

### 6.1 每日构建检查

每天首次启动前执行：

- [ ] ENV-01 后端启动验证
- [ ] ENV-02 前端编译验证
- [ ] ENV-03 数据库初始化验证
- [ ] ENV-04 AI 适配器加载验证
- [ ] ENV-05 环境变量检查

### 6.2 代码提交前检查

每次提交前执行：

- [ ] 前端语法检查
- [ ] 后端语法检查
- [ ] 单元测试通过
- [ ] 代码风格检查

### 6.3 上线前检查

上线前执行：

- [ ] 所有 P0 测试通过
- [ ] 所有 P1 测试通过 95%+
- [ ] 性能测试达标
- [ ] 安全测试无高风险
- [ ] 真机测试通过
- [ ] 启动验证通过

---

## 七、测试报告模板（更新）

### 7.1 启动验证报告

```markdown
# 启动验证报告

**日期**: 2026-02-23
**执行人**: XXX

## 验证结果

| 检查项 | 状态 | 备注 |
|-------|------|------|
| 后端启动 | ✅/❌ | |
| 前端编译 | ✅/❌ | |
| 数据库初始化 | ✅/❌ | |
| AI 适配器加载 | ✅/❌ | |
| 环境变量检查 | ✅/❌ | |

## 问题汇总

| 编号 | 描述 | 优先级 | 状态 |
|-----|------|--------|------|
| - | - | - | - |

## 结论

✅ 通过 / ❌ 不通过
```

### 7.2 完整测试报告

详见 `2026-02-22_测试执行报告.md` 模板

---

## 八、风险评估（更新）

### 8.1 新增风险

| 风险 | 概率 | 影响 | 缓解措施 |
|-----|------|------|---------|
| 启动脚本报错 | 中 | 严重 | 每日执行启动验证 |
| 数据库迁移失败 | 中 | 严重 | 备份 + 回滚脚本 |
| AI API Key 过期 | 高 | 严重 | 定期检查 + 告警 |
| 环境变量缺失 | 中 | 严重 | .env.example 检查清单 |

### 8.2 原有风险（不变）

详见 `2026-02-23_测试缺口分析报告.md`

---

## 九、测试资源需求（更新）

### 9.1 人力资源

| 角色 | 人数 | 工作时间 |
|-----|------|---------|
| 测试工程师 | 2 人 | 6 周 |
| 开发工程师 | 1 人 | 部分时间支持 |
| 安全专家 | 1 人 | 1 周 |
| **运维工程师** | **1 人** | **启动验证支持** |

### 9.2 设备资源（新增）

| 设备 | 数量 | 用途 |
|-----|------|------|
| **测试服务器** | **1 台** | **每日构建验证** |
| iOS 测试机 | 3 台 | iOS 12/14/16 |
| Android 测试机 | 3 台 | Android 10/12/折叠屏 |
| iPad | 1 台 | 平板适配 |
| 性能测试服务器 | 1 台 | 压测 |

---

## 十、结论与建议（更新）

### 10.1 测试状态

- **已覆盖**: 约 65%（包括启动验证）
- **未覆盖**: 约 35%（后端测试、安全测试等）
- **风险评估**: 存在中高风险，不建议立即上线

### 10.2 上线建议

**方案 A（推荐）**: 补充 P0 级测试后上线
- 时间：3 周
- 风险：低
- 成本：中
- **包含**: 启动验证、API 测试、安全测试

**方案 B（折中）**: 补充核心 P0 测试后灰度上线
- 时间：1 周
- 风险：中
- 成本：低
- **包含**: 启动验证、核心 API 测试
- **条件**: 限流、监控、快速回滚

**方案 C（激进）**: 直接上线
- 时间：0 周
- 风险：高
- 成本：低
- **条件**: 24 小时监控、随时待命修复

### 10.3 最终建议

**建议采用方案 A+**，理由：
1. 启动验证已补充，可提前发现环境问题
2. 品牌 AI 诊断是核心业务，质量问题影响大
3. 多 AI 平台集成复杂度高，需要充分测试
4. 涉及用户数据和支付，安全测试必不可少
5. 3 周测试时间可大幅降低上线风险

**A+ 方案**: 方案 A + 每日启动验证

---

**报告生成时间**: 2026-02-23  
**测试负责人**: 首席测试工程师 (AI)  
**审批状态**: 待审批  
**版本**: v2.0（补充启动验证）
