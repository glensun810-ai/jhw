# åç«¯ API ä¿®å¤æŒ‡å— - æ‰‹åŠ¨ç¼–è¾‘

**æ–‡ä»¶**: `backend_python/wechat_backend/views.py`  
**å‡½æ•°**: `get_task_status_api` (ç¬¬ 2543 è¡Œ)

---

## ä¿®å¤æ­¥éª¤

### æ­¥éª¤ 1: æ‰¾åˆ°å‡½æ•°ä½ç½®

æ‰“å¼€ `backend_python/wechat_backend/views.py`ï¼Œæ‰¾åˆ°ç¬¬ 2543 è¡Œçš„ `get_task_status_api` å‡½æ•°ã€‚

### æ­¥éª¤ 2: ä¿®æ”¹ execution_store åˆ†æ”¯

åœ¨ç¬¬ 2558 è¡Œé™„è¿‘ï¼Œæ‰¾åˆ°è¿™æ®µä»£ç ï¼š

```python
response_data = {
    'task_id': task_id,
    'progress': task_status.get('progress', 0),
    'stage': task_status.get('stage', 'init'),
    'status': task_status.get('status', 'init'),
    'results': task_status.get('results', []),
    'is_completed': task_status.get('status') == 'completed',
    'created_at': task_status.get('start_time', None)
}
```

**ä¿®æ”¹ä¸º**:

```python
response_data = {
    'task_id': task_id,
    'progress': task_status.get('progress', 0),
    'stage': task_status.get('stage', 'init'),
    'status': task_status.get('status', 'init'),
    'results': task_status.get('results', []),
    'detailed_results': task_status.get('results', []),  # æ·»åŠ è¿™ä¸€è¡Œ
    'is_completed': task_status.get('status') == 'completed',
    'created_at': task_status.get('start_time', None)
}
```

### æ­¥éª¤ 3: ä¿®æ”¹æ•°æ®åº“æŸ¥è¯¢åˆ†æ”¯

åœ¨ç¬¬ 2570 è¡Œé™„è¿‘ï¼Œæ‰¾åˆ° `else:` åˆ†æ”¯ï¼ˆæ•°æ®åº“é™çº§æŸ¥è¯¢ï¼‰ï¼Œåœ¨ `from wechat_backend.models import` åé¢æ·»åŠ ï¼š

```python
from wechat_backend.models import get_task_status as get_db_task_status, get_deep_intelligence_result
from wechat_backend.database_core import get_connection  # æ·»åŠ è¿™ä¸€è¡Œ
import gzip, json  # æ·»åŠ è¿™ä¸€è¡Œ
```

### æ­¥éª¤ 4: æ·»åŠ  results_summary æŸ¥è¯¢

åœ¨ç¬¬ 2583 è¡Œï¼ˆ`'message': 'Task found in database (server restarted)'` åé¢ï¼‰ï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```python
# ã€P0 ä¿®å¤ã€‘ä»æ•°æ®åº“è·å–å®Œæ•´çš„ results_summary
conn = get_connection()
cursor = conn.cursor()
cursor.execute("""
    SELECT results_summary, is_summary_compressed
    FROM test_records
    WHERE id = (
        SELECT MAX(id) FROM test_records 
        WHERE json_extract(results_summary, '$.execution_id') = ?
    )
""", (task_id,))
db_row = cursor.fetchone()
conn.close()

# è§£æ results_summary
if db_row:
    summary_raw, summary_comp = db_row
    try:
        if summary_comp and summary_raw:
            summary = json.loads(gzip.decompress(summary_raw).decode('utf-8'))
        elif summary_raw:
            summary = json.loads(summary_raw)
        else:
            summary = {}
        
        # æå–å…³é”®å­—æ®µ
        response_data['detailed_results'] = summary.get('detailed_results', [])
        response_data['brand_scores'] = summary.get('brand_scores', {})
        response_data['competitive_analysis'] = summary.get('competitive_analysis', {})
        response_data['negative_sources'] = summary.get('negative_sources', [])
        response_data['semantic_drift_data'] = summary.get('semantic_drift_data', {})
        response_data['recommendation_data'] = summary.get('recommendation_data', {})
        response_data['overall_score'] = summary.get('overall_score', 0)
        
        api_logger.info(f'âœ… ä»æ•°æ®åº“åŠ è½½ results_summary: {len(summary)} å­—æ®µ')
    except Exception as e:
        api_logger.error(f'âŒ è§£æ results_summary å¤±è´¥ï¼š{e}')
        response_data['detailed_results'] = []
        response_data['brand_scores'] = {}
        response_data['competitive_analysis'] = {}
```

### æ­¥éª¤ 5: åˆ é™¤æ—§ä»£ç 

åˆ é™¤ä»¥ä¸‹ä»£ç ï¼ˆç¬¬ 2588-2591 è¡Œï¼‰ï¼š

```python
# å¦‚æœä»»åŠ¡å·²å®Œæˆï¼Œå°è¯•è·å–ç»“æœ
if db_task_status.is_completed:
    deep_result = get_deep_intelligence_result(task_id)
    if deep_result:
        response_data['has_result'] = True
```

### æ­¥éª¤ 6: éªŒè¯è¯­æ³•

```bash
cd /Users/sgl/PycharmProjects/PythonProject/backend_python
python3 -m py_compile wechat_backend/views.py
```

### æ­¥éª¤ 7: é‡å¯åç«¯æœåŠ¡

```bash
# åœæ­¢å½“å‰è¿è¡Œçš„æœåŠ¡ï¼ˆCtrl+Cï¼‰
# é‡æ–°å¯åŠ¨
python3 wechat_backend/app.py
```

---

## éªŒè¯

åœ¨å°ç¨‹åºä¸­è¿è¡Œè¯Šæ–­æµ‹è¯•ï¼ŒæŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼š

**é¢„æœŸæ—¥å¿—**:
```
âœ… ä»æ•°æ®åº“åŠ è½½ results_summary: X å­—æ®µ
ğŸ“¦ æœ¬åœ°å­˜å‚¨æ•°æ®ï¼š{hasResults: true, ...}
âœ… ä»æœ¬åœ°å­˜å‚¨åŠ è½½æˆåŠŸ
```

---

*åç«¯ API ä¿®å¤æŒ‡å—ï¼Œæ‰‹åŠ¨ç¼–è¾‘ views.py è¿”å›å®Œæ•´ results_summary æ•°æ®*
