# è±†åŒ…æ—¥å¿—åŒè·¯å¾„é—®é¢˜è¯Šæ–­ä¸ä¿®å¤æŠ¥å‘Š

**åˆ†ææ—¥æœŸ**: 2026 å¹´ 2 æœˆ 19 æ—¥  
**é—®é¢˜**: ai_responses.jsonl ä¸­æ²¡æœ‰è±†åŒ…æ—¥å¿—ï¼Œä½†è±†åŒ… API ç¡®å®è¢«è°ƒç”¨äº†

---

## ğŸ”´ æ ¹æœ¬åŸå› 

**è±†åŒ…æ—¥å¿—è®°å½•åˆ°äº†ä¸åŒçš„æ–‡ä»¶è·¯å¾„**ï¼

### é—®é¢˜æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ—¥å¿—è®°å½•åŒè·¯å¾„é—®é¢˜                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  NXM æ‰§è¡Œå¼•æ“                                                    â”‚
â”‚       â”‚                                                         â”‚
â”‚       â”œâ”€â†’ deepseek/qwen/zhipu â†’ log_ai_response()              â”‚
â”‚       â”‚                        â†’ ai_responses.jsonl âœ…          â”‚
â”‚       â”‚                                                         â”‚
â”‚       â””â”€â†’ doubao â†’ DoubaoAdapter.send_prompt()                 â”‚
â”‚                    â†’ log_detailed_response()                    â”‚
â”‚                    â†’ log_ai_response_with_context()             â”‚
â”‚                    â†’ log_enhanced_response()                    â”‚
â”‚                    â†’ ai_responses_enhanced/users/*.jsonl âŒ     â”‚
â”‚                                                                 â”‚
â”‚  é—®é¢˜ï¼šai_responses_enhanced ç›®å½•æ˜¯ç©ºçš„ï¼                        â”‚
â”‚  åŸå› ï¼šlog_enhanced_response() æ²¡æœ‰å®é™…å†™å…¥                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸¤æ¡æ—¥å¿—è·¯å¾„

#### è·¯å¾„ 1: NXM æ‰§è¡Œå¼•æ“ (deepseek/qwen/zhipu)

```python
# nxm_execution_engine.py ç¬¬ 166 è¡Œ
from utils.ai_response_logger_v2 import log_ai_response

log_ai_response(
    question=geo_prompt,
    response=response_text,
    platform=normalized_model_name,  # 'deepseek', 'qwen', 'zhipu'
    ...
)
```

**æ—¥å¿—æ–‡ä»¶**: `data/ai_responses/ai_responses.jsonl` âœ…

#### è·¯å¾„ 2: DoubaoAdapter (è±†åŒ…)

```python
# doubao_adapter.py ç¬¬ 254 è¡Œ
from utils.ai_response_wrapper import log_detailed_response

log_detailed_response(
    question=prompt,
    response=content,
    platform=self.platform_type.value,  # 'doubao'
    ...
)
```

**æ—¥å¿—æ–‡ä»¶**: `data/ai_responses_enhanced/users/{user_id}/ai_responses_*.jsonl` âŒ

### ä¸ºä»€ä¹ˆå¢å¼ºç‰ˆæ—¥å¿—æ˜¯ç©ºçš„ï¼Ÿ

æ£€æŸ¥ `ai_response_logger_enhanced.py` çš„ `log_enhanced_response()` æ–¹æ³•ï¼š

```python
# ç¬¬ 315-335 è¡Œ
def log_enhanced_response(self, **kwargs):
    # è·å– user_id
    user_id = kwargs.get('user_id', 'anonymous')
    
    # æ ¹æ® user_id å†³å®šæ—¥å¿—æ–‡ä»¶
    if user_id and user_id != 'anonymous':
        log_file = self._get_user_log_file(user_id)
    else:
        log_file = self._get_system_log_file()  # ç³»ç»Ÿæ—¥å¿—
    
    # å†™å…¥æ—¥å¿—
    with open(log_file, 'a', encoding='utf-8') as f:
        f.write(json.dumps(record, ensure_ascii=False) + '\n')
```

**é—®é¢˜**: 
1. DoubaoAdapter è°ƒç”¨æ—¶ä¼ é€’äº† `execution_id` ä½†æ²¡æœ‰ä¼ é€’ `user_id`
2. `user_id` ä¸º `None` æˆ– `'anonymous'`
3. æ—¥å¿—è¢«å†™å…¥ç³»ç»Ÿæ—¥å¿—ç›®å½•ï¼š`data/ai_responses_enhanced/system/`
4. ä½†ç³»ç»Ÿæ—¥å¿—ç›®å½•æ˜¯**ç©ºçš„**ï¼

### çœŸæ­£çš„é—®é¢˜

**DoubaoAdapter åœ¨ MVP åˆ†æ”¯å¼€å‘æ—¶ï¼Œåˆ›å»ºäº†ç‹¬ç«‹çš„æ—¥å¿—è®°å½•è·¯å¾„ï¼Œä½†è¿™ä¸ªè·¯å¾„ä»æœªè¢«æ­£ç¡®é›†æˆåˆ°ä¸»æµç¨‹ä¸­ï¼**

---

## ğŸ” éªŒè¯è¯æ®

### 1. æ—¥å¿—ç›®å½•å¯¹æ¯”

```bash
# NXM æ‰§è¡Œå¼•æ“çš„æ—¥å¿—
$ ls -la data/ai_responses/
-rw-r--r--  ai_responses.jsonl  (339 æ¡è®°å½•ï¼ŒåŒ…å« deepseek/qwen/zhipu)

# DoubaoAdapter çš„æ—¥å¿—
$ ls -la data/ai_responses_enhanced/system/
(ç©ºç›®å½•ï¼)

$ ls -la data/ai_responses_enhanced/users/
(ç©ºç›®å½•ï¼)
```

### 2. ä»£ç è°ƒç”¨é“¾

**NXM â†’ deepseek/qwen/zhipu**:
```
nxm_execution_engine.py (ç¬¬ 166 è¡Œ)
  â†’ log_ai_response()
    â†’ AIResponseLogger.log_response()
      â†’ data/ai_responses/ai_responses.jsonl âœ…
```

**NXM â†’ doubao**:
```
nxm_execution_engine.py (ç¬¬ 145 è¡Œ)
  â†’ adapter.send_prompt()
    â†’ DoubaoAdapter._make_request_internal()
      â†’ log_detailed_response() (ç¬¬ 254 è¡Œ)
        â†’ log_ai_response_with_context()
          â†’ log_enhanced_response()
            â†’ data/ai_responses_enhanced/users/*.jsonl âŒ (ç©º)
```

### 3. app.log ä¸­çš„çº¿ç´¢

```
2026-02-19 13:45:00,408 - WARNING - Adapter doubao has no API key configured, skipping warm-up
```

**è¿™è¯´æ˜**: è±†åŒ… Adapter åœ¨ warm-up é˜¶æ®µè¢«è·³è¿‡ï¼Œä½†åœ¨ NXM æ‰§è¡Œæ—¶**å®é™…è¢«è°ƒç”¨äº†**ï¼Œåªæ˜¯æ—¥å¿—è®°å½•åˆ°äº†ä¸åŒçš„åœ°æ–¹ï¼ˆä¸”æ²¡æœ‰æˆåŠŸå†™å…¥ï¼‰ã€‚

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ç»Ÿä¸€æ—¥å¿—è®°å½•è·¯å¾„ (æ¨è)

**ä¿®æ”¹ DoubaoAdapterï¼Œä½¿ç”¨ä¸ NXM æ‰§è¡Œå¼•æ“ç›¸åŒçš„æ—¥å¿—è®°å½•æ–¹å¼**ã€‚

**æ­¥éª¤**:

1. ä» DoubaoAdapter ç§»é™¤ `log_detailed_response` è°ƒç”¨
2. è®© NXM æ‰§è¡Œå¼•æ“ç»Ÿä¸€è®°å½•æ‰€æœ‰å¹³å°çš„å“åº”

**ä¿®æ”¹ `doubao_adapter.py`**:

```python
# ç§»é™¤è¿™äº›å¯¼å…¥
# from utils.ai_response_wrapper import log_detailed_response

def _make_request_internal(self, prompt: str, **kwargs) -> AIResponse:
    # ... ç°æœ‰ä»£ç  ...
    
    # ç§»é™¤ log_detailed_response è°ƒç”¨
    # è®© NXM æ‰§è¡Œå¼•æ“ç»Ÿä¸€è®°å½•
    
    return AIResponse(...)
```

**ä¼˜ç‚¹**:
- ç»Ÿä¸€æ—¥å¿—è®°å½•é€»è¾‘
- æ‰€æœ‰å¹³å°è®°å½•åˆ°åŒä¸€ä¸ªæ–‡ä»¶
- ä¾¿äºåˆ†æå’Œå¯¹æ¯”

### æ–¹æ¡ˆ 2: ä¿®å¤å¢å¼ºç‰ˆæ—¥å¿—è®°å½•

å¦‚æœè¦ä¿ç•™å¢å¼ºç‰ˆæ—¥å¿—è®°å½•ï¼Œéœ€è¦ä¿®å¤ä»¥ä¸‹é—®é¢˜ï¼š

1. **ç¡®ä¿ user_id æ­£ç¡®ä¼ é€’**
2. **ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨**
3. **ç¡®ä¿æ—¥å¿—å†™å…¥æˆåŠŸ**

**ä¿®æ”¹ `doubao_adapter.py`**:

```python
# ç¬¬ 254 è¡Œé™„è¿‘
log_detailed_response(
    question=prompt,
    response=content,
    platform=self.platform_type.value,
    model=self.model_name,
    success=True,
    latency_ms=int(latency * 1000),
    tokens_used=tokens_used,
    execution_id=execution_id,
    user_id=kwargs.get('user_id', 'system'),  # æ·»åŠ  user_id
    brand=kwargs.get('brand_name'),
    competitor=kwargs.get('competitors'),
    metadata={
        'source': 'doubao_adapter',  # æ·»åŠ æ¥æºæ ‡è¯†
        **kwargs.get('metadata', {})
    }
)
```

### æ–¹æ¡ˆ 3: åˆå¹¶æ—¥å¿—æ–‡ä»¶ (ä¸´æ—¶æ–¹æ¡ˆ)

åˆ›å»ºä¸€ä¸ªè„šæœ¬ï¼Œå°† `ai_responses_enhanced` çš„æ—¥å¿—åˆå¹¶åˆ° `ai_responses.jsonl`:

```python
#!/usr/bin/env python3
"""
åˆå¹¶å¢å¼ºç‰ˆæ—¥å¿—åˆ°ä¸»æ—¥å¿—æ–‡ä»¶
"""

import json
from pathlib import Path

def merge_enhanced_logs():
    enhanced_dir = Path('data/ai_responses_enhanced')
    main_log = Path('data/ai_responses/ai_responses.jsonl')
    
    # æ”¶é›†æ‰€æœ‰å¢å¼ºç‰ˆæ—¥å¿—
    all_records = []
    for log_file in enhanced_dir.rglob('*.jsonl'):
        with open(log_file, 'r', encoding='utf-8') as f:
            for line in f:
                all_records.append(json.loads(line))
    
    # åˆå¹¶åˆ°ä¸»æ—¥å¿—
    with open(main_log, 'a', encoding='utf-8') as f:
        for record in all_records:
            # è½¬æ¢ä¸º ai_responses.jsonl æ ¼å¼
            simplified = {
                'timestamp': record['timestamp'],
                'question': record['question']['text'],
                'response': record['response']['text'],
                'platform': record['platform']['name'],
                'model': record['platform']['model'],
                'success': record['status']['success'],
                'metadata': record['metadata']
            }
            f.write(json.dumps(simplified, ensure_ascii=False) + '\n')
    
    print(f"Merged {len(all_records)} records to {main_log}")

if __name__ == '__main__':
    merge_enhanced_logs()
```

---

## ğŸ“‹ å®æ–½æ­¥éª¤

### æ¨èï¼šæ–¹æ¡ˆ 1 (ç»Ÿä¸€æ—¥å¿—è·¯å¾„)

**æ­¥éª¤ 1: ä¿®æ”¹ DoubaoAdapter**

```python
# wechat_backend/ai_adapters/doubao_adapter.py

# ç§»é™¤ç¬¬ 24 è¡Œçš„å¯¼å…¥
# from utils.ai_response_wrapper import log_detailed_response  # âŒ åˆ é™¤

# ç§»é™¤ç¬¬ 254-269 è¡Œçš„ log_detailed_response è°ƒç”¨
# ç§»é™¤ç¬¬ 290-307 è¡Œçš„ log_detailed_response è°ƒç”¨ (å¤±è´¥æƒ…å†µ)
# ç§»é™¤ç¬¬ 332-349 è¡Œçš„ log_detailed_response è°ƒç”¨
# ç§»é™¤ç¬¬ 384-401 è¡Œçš„ log_detailed_response è°ƒç”¨
# ç§»é™¤ç¬¬ 430-447 è¡Œçš„ log_detailed_response è°ƒç”¨
```

**æ­¥éª¤ 2: éªŒè¯ NXM æ‰§è¡Œå¼•æ“çš„æ—¥å¿—è®°å½•**

ç¡®ä¿ NXM æ‰§è¡Œå¼•æ“å¯¹æ‰€æœ‰å¹³å°éƒ½è°ƒç”¨ `log_ai_response()`ï¼š

```python
# nxm_execution_engine.py ç¬¬ 166-189 è¡Œ
# è¿™æ®µä»£ç å¯¹æ‰€æœ‰å¹³å°éƒ½æœ‰æ•ˆï¼ŒåŒ…æ‹¬è±†åŒ…
from utils.ai_response_logger_v2 import log_ai_response
log_ai_response(...)
```

**æ­¥éª¤ 3: æµ‹è¯•éªŒè¯**

```bash
# 1. æ‰§è¡ŒåŒ…å«è±†åŒ…çš„æµ‹è¯•
python3 test_doubao_brand_diagnosis.py

# 2. æ£€æŸ¥æ—¥å¿—
tail -20 data/ai_responses/ai_responses.jsonl | python3 -c "
import sys, json
from collections import Counter
platforms = Counter()
for line in sys.stdin:
    r = json.loads(line)
    p = r.get('platform', 'Unknown')
    if isinstance(p, dict): p = p.get('name', 'Unknown')
    platforms[p] += 1
for p, c in platforms.most_common():
    print(f'{p}: {c}')
"

# æœŸæœ›è¾“å‡ºåŒ…å«è±†åŒ…
# deepseek: X
# qwen: X
# zhipu: X
# è±†åŒ…ï¼šX  âœ…
```

---

## ğŸ“Š å†å²åŸå› åˆ†æ

### ä¸ºä»€ä¹ˆä¼šæœ‰åŒè·¯å¾„ï¼Ÿ

1. **MVP å¼€å‘é˜¶æ®µ**: è±†åŒ…æ˜¯æœ€æ—©é›†æˆçš„å¹³å°ï¼Œä½¿ç”¨äº†ç‹¬ç«‹çš„æ—¥å¿—è®°å½• (`ai_response_wrapper.py`)

2. **åç»­å¹³å°é›†æˆ**: deepseek/qwen/zhipu é›†æˆæ—¶ï¼ŒNXM æ‰§è¡Œå¼•æ“å·²ç»ç»Ÿä¸€äº†æ—¥å¿—è®°å½• (`ai_response_logger_v2.py`)

3. **åˆ†æ”¯æœªåˆå¹¶**: è±†åŒ…çš„æ—¥å¿—è®°å½•é€»è¾‘ä»æœªè¿ç§»åˆ°ç»Ÿä¸€è·¯å¾„

### æ—¶é—´çº¿æ¨æµ‹

```
2026-02-14: è±†åŒ… MVP å¼€å‘
  â†’ åˆ›å»º doubao_adapter.py
  â†’ åˆ›å»º ai_response_wrapper.py
  â†’ æ—¥å¿—è®°å½•åˆ° ai_responses_enhanced/

2026-02-15: å…¶ä»–å¹³å°é›†æˆ
  â†’ åˆ›å»º nxm_execution_engine.py
  â†’ ä½¿ç”¨ ai_response_logger_v2.py
  â†’ æ—¥å¿—è®°å½•åˆ° ai_responses/

2026-02-19: å‘ç°é—®é¢˜
  â†’ ai_responses.jsonl ä¸­æ²¡æœ‰è±†åŒ…
  â†’ å› ä¸ºè±†åŒ…è®°å½•åˆ°ä¸åŒçš„è·¯å¾„
```

---

## âœ… éªŒè¯æ¸…å•

ä¿®å¤åï¼ŒéªŒè¯ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] DoubaoAdapter ä¸å†è°ƒç”¨ `log_detailed_response()`
- [ ] NXM æ‰§è¡Œå¼•æ“å¯¹æ‰€æœ‰å¹³å°è°ƒç”¨ `log_ai_response()`
- [ ] `data/ai_responses/ai_responses.jsonl` åŒ…å«è±†åŒ…è®°å½•
- [ ] `data/ai_responses_enhanced/` ç›®å½•ä¸ºç©ºæˆ–ä¸å†ä½¿ç”¨
- [ ] æ‰§è¡Œä¸€æ¬¡å®Œæ•´çš„ N*M æµ‹è¯• (3 é—®é¢˜*4 å¹³å° = 12 æ¡è®°å½•)
- [ ] éªŒè¯ 12 æ¡è®°å½•éƒ½åœ¨ `ai_responses.jsonl` ä¸­

---

**æŠ¥å‘Šäºº**: AI ç³»ç»Ÿæ¶æ„å¸ˆ  
**æ—¥æœŸ**: 2026 å¹´ 2 æœˆ 19 æ—¥  
**ä¼˜å…ˆçº§**: P1 - é«˜
