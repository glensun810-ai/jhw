# 品牌 AI 诊断系统 - 技术重构方案计划

**文档版本**: v1.0  
**创建日期**: 2026-02-22  
**审计范围**: 全栈代码（前端 + 后端）  
**优先级定义**: 
- P0: 阻碍上线/严重影响性能（立即执行）
- P1: 影响可维护性/存在风险（1 周内）
- P2: 优化改进（1 月内）

---

## 一、执行摘要

### 1.1 代码规模统计

| 类别 | 文件数 | 总行数 | 最大文件 | 行数 |
|-----|-------|--------|---------|------|
| **前端 JS** | 127 个 | 32,854 行 | results.js | 2,122 行 |
| **后端 Python** | ~200 个 | 2M+ 行 | views.py | 4,440 行 |
| **WXML/WXSS** | ~80 个 | 22,513 行 | results.wxss | 1,931 行 |

### 1.2 需要重构的文件清单（Top 15）

| 排名 | 文件路径 | 行数 | 优先级 | 重构目标 |
|-----|---------|------|--------|---------|
| 1 | `backend_python/wechat_backend/views.py` | 4,440 行 | P0 | 拆分为路由模块 |
| 2 | `pages/results/results.js` | 2,122 行 | P0 | 服务化重构 |
| 3 | `services/reportAggregator.js` | 1,371 行 | P1 | 简化逻辑 |
| 4 | `pages/index/index.js` | 1,723 行 | ✅ 已完成 | 模块化重构 |
| 5 | `pages/report/dashboard/index.js` | 905 行 | P1 | 组件化 |
| 6 | `backend_python/wechat_backend/nxm_execution_engine.py` | 1,748 行 | P1 | 引擎优化 |
| 7 | `backend_python/wechat_backend/database_core.py` | 1,510 行 | P1 | 数据库层重构 |
| 8 | `components/diagnostic-drawer/index.js` | 765 行 | P2 | 组件拆分 |
| 9 | `components/IntelligencePipeline/IntelligencePipeline.js` | 587 行 | P2 | 流水线优化 |
| 10 | `backend_python/wechat_backend/views_admin.py` | 939 行 | P1 | 管理后台拆分 |
| 11 | `utils/storage.js` | 484 行 | P2 | 存储统一 |
| 12 | `pages/admin/users/users.js` | 477 行 | P2 | 管理页面优化 |
| 13 | `pages/report/roi-detail/roi-detail.js` | 430 行 | P2 | 详情页优化 |
| 14 | `pages/permission-manager/permission-manager.js` | 359 行 | P2 | 权限管理优化 |
| 15 | `pages/competitive-analysis/competitive-analysis.js` | 357 行 | P2 | 竞争分析优化 |

---

## 二、P0 级重构（立即执行）

### 2.1 backend/views.py 拆分（4,440 行 → ~500 行/模块）

**问题诊断**:
- 单文件承担过多职责（路由、业务逻辑、数据处理）
- 导入语句超过 50 行
- 函数平均行数 >100 行
- 圈复杂度高

**重构方案**:

```
backend_python/wechat_backend/views.py (4,440 行)
  ↓ 拆分为
├── views/__init__.py                  # 蓝图注册
├── views/diagnosis_views.py           # 诊断相关路由 (~600 行)
│   ├── /api/perform-brand-test
│   ├── /api/test-status/{id}
│   └── /api/test-progress
├── views/user_views.py                # 用户相关路由 (~400 行)
│   ├── /api/login
│   ├── /api/register
│   ├── /api/user/profile
│   └── /api/refresh-token
├──/views/report_views.py              # 报告相关路由 (~500 行)
│   ├── /api/export/pdf
│   ├── /api/export/excel
│   └── /api/report/generate
├── views/admin_views.py               # 管理后台路由 (~600 行)
│   ├── /api/admin/dashboard
│   ├── /api/admin/users
│   └── /api/admin/tests
├── views/analytics_views.py           # 分析相关路由 (~500 行)
│   ├── /api/analytics/track
│   ├── /api/analytics/funnel
│   └── /api/analytics/heatmap
├── views/audit_views.py               # 审计相关路由 (~400 行)
│   ├── /api/audit/logs
│   └── /api/audit/user-activity
└── views/sync_views.py                # 同步相关路由 (~300 行)
    ├── /api/sync/data
    └── /api/sync/status
```

**实施步骤**:
1. 创建 views 目录结构
2. 按功能模块提取路由函数
3. 提取公共业务逻辑到 services 层
4. 更新导入和蓝图注册
5. 单元测试验证

**预计工时**: 16 小时  
**风险等级**: 中（需全面测试）

---

### 2.2 pages/results/results.js 服务化重构（2,122 行 → ~800 行）

**问题诊断**:
- 页面逻辑与数据处理耦合
- 图表渲染逻辑分散
- 大量重复的数据提取代码

**重构方案**:

```
pages/results/results.js (2,122 行)
  ↓ 重构为
├── pages/results/results.js           # 页面逻辑 (~600 行)
│   ├── onLoad, onReady
│   ├── 事件处理
│   └── UI 交互
├── services/resultDataService.js      # 结果数据服务 (~500 行)
│   ├── loadResultData(executionId)
│   ├── fetchFromServer(executionId)
│   ├── loadFromStorage(executionId)
│   └── processCompetitiveAnalysis(data)
├── services/chartDataService.js       # 图表数据服务 (~400 行)
│   ├── prepareRadarData(competitiveAnalysis)
│   ├── prepareWordCloudData(semanticDriftData)
│   ├── prepareTrendData(timeSeries)
│   └── prepareComparisonData(brands)
├── utils/chartRenderer.js             # 图表渲染工具 (~300 行)
│   ├── renderRadarChart(canvas, option)
│   ├── renderWordCloud(canvas, option)
│   └── disposeChart(instance)
└── components/
    ├── ResultOverview/                # 结果概览组件
    ├── CompetitiveMatrix/             # 竞争矩阵组件
    └── InsightCards/                  # 洞察卡片组件
```

**实施步骤**:
1. 创建 resultDataService.js
2. 创建 chartDataService.js
3. 创建 chartRenderer.js
4. 重构 results.js 删除已迁移逻辑
5. 创建基础组件

**预计工时**: 12 小时  
**风险等级**: 中

---

## 三、P1 级重构（1 周内）

### 3.1 services/reportAggregator.js 简化（1,371 行 → ~600 行）

**问题诊断**:
- 聚合逻辑过于复杂
- 包含多个职责（数据清洗、评分计算、UI 适配）

**重构方案**:

```
services/reportAggregator.js (1,371 行)
  ↓ 拆分为
├── services/reportAggregator.js       # 聚合入口 (~200 行)
│   └── aggregateReport(rawResults, brandName, competitors)
├── services/dataSanitizer.js          # 数据清洗 (~300 行)
│   ├── sanitizeGeoData(geoData)
│   ├── sanitizeResponse(response)
│   └── fillMissingData(results)
├── services/scoringService.js         # 评分计算 (~400 行)
│   ├── calculateSOV(mentions)
│   ├── calculateRiskScore(interceptionData)
│   ├── calculateBrandHealth(scores)
│   └── generateInsightText(scores)
└── services/attributionService.js     # 归因分析 (~300 行)
    ├── attributeThreats(sources)
    ├── analyzeInterceptionPatterns(data)
    └── generateAttributionReport(threats)
```

**预计工时**: 8 小时

---

### 3.2 backend/nxm_execution_engine.py 优化（1,748 行）

**问题诊断**:
- NxM 执行引擎逻辑复杂
- 并发控制与错误处理耦合

**重构方案**:

```
wechat_backend/nxm_execution_engine.py (1,748 行)
  ↓ 拆分为
├── nxm_execution_engine.py            # 引擎入口 (~400 行)
│   └── execute_nxm_test(brand_list, models, questions)
├── nxm_scheduler.py                   # 任务调度 (~500 行)
│   ├── schedule_tasks(brand_list, models)
│   ├── manage_concurrency()
│   └── handle_retries()
├── nxm_result_aggregator.py           # 结果聚合 (~400 行)
│   ├── aggregate_results(raw_responses)
│   ├── validate_results(results)
│   └── format_for_frontend(results)
└── nxm_error_handler.py               # 错误处理 (~300 行)
    ├── handle_ai_timeout(error)
    ├── handle_rate_limit(error)
    └── generate_fallback_response()
```

**预计工时**: 10 小时

---

### 3.3 backend/database_core.py 重构（1,510 行）

**问题诊断**:
- 数据库操作与业务逻辑混合
- 连接管理复杂

**重构方案**:

```
wechat_backend/database_core.py (1,510 行)
  ↓ 拆分为
├── database_core.py                   # 核心连接管理 (~300 行)
│   ├── get_db_connection()
│   ├── close_db_connection()
│   └── execute_query(sql, params)
├── database_repositories.py           # 数据仓库层 (~600 行)
│   ├── TestRecordRepository
│   ├── TaskStatusRepository
│   ├── IntelligenceResultRepository
│   └── UserRepository
├── database_migrations.py             # 迁移管理 (~300 行)
│   ├── run_migrations()
│   └── rollback_migration()
└── database_connection_pool.py        # 连接池 (~300 行)
    ├── ConnectionPool
    ├── get_connection()
    └── release_connection()
```

**预计工时**: 8 小时

---

### 3.4 backend/views_admin.py 拆分（939 行）

**重构方案**:

```
wechat_backend/views_admin.py (939 行)
  ↓ 拆分为
├── views_admin.py                     # 管理后台入口 (~200 行)
├── admin_user_management.py           # 用户管理 (~300 行)
├── admin_test_management.py           # 测试管理 (~250 行)
└── admin_system_config.py             # 系统配置 (~200 行)
```

**预计工时**: 6 小时

---

## 四、P2 级重构（1 月内）

### 4.1 组件化重构清单

| 组件 | 当前行数 | 重构目标 | 优先级 |
|-----|---------|---------|--------|
| `components/diagnostic-drawer/` | 765 行 | 拆分为 Drawer + Content | P2 |
| `components/IntelligencePipeline/` | 587 行 | 流水线阶段组件化 | P2 |
| `components/ExportOptions/` | 521 行 | 导出选项分离 | P2 |
| `components/AnalysisCharts/` | 360 行 | 图表类型拆分 | P2 |
| `components/BattlefieldMatrix/` | 353 行 | 矩阵组件优化 | P2 |

### 4.2 工具函数整理

| 文件 | 当前行数 | 问题 | 重构方案 |
|-----|---------|------|---------|
| `utils/storage.js` | 484 行 | 职责不清 | 拆分为 storage.js + cache.js |
| `utils/charts.js` | 324 行 | 图表配置混杂 | 按图表类型拆分 |
| `utils/pdf-export.js` | 364 行 | PDF 生成逻辑复杂 | 移至 services/pdfService.js |
| `utils/visual-enhancements.js` | 371 行 | 视觉效果分散 | 整理为动画库 |

### 4.3 页面优化清单

| 页面 | 行数 | 优化目标 |
|-----|------|---------|
| `pages/report/dashboard/` | 905 行 | 使用战略看板组件 |
| `pages/admin/users/` | 477 行 | 表格组件化 |
| `pages/competitive-analysis/` | 357 行 | 分析服务化 |

---

## 五、后端服务层重构

### 5.1 服务层新增模块

```
backend_python/wechat_backend/services/
├── diagnosis_service.py              # 诊断业务逻辑
├── report_generation_service.py      # 报告生成
├── competitive_analysis_service.py   # 竞争分析
├── semantic_analysis_service.py      # 语义分析
├── recommendation_service.py         # 推荐生成
├── export_service.py                 # 导出服务
└── analytics_service.py              # 分析服务
```

### 5.2 AI 适配器优化

```
backend_python/wechat_backend/ai_adapters/
├── base_adapter.py                   # 基类（已有）
├── deepseek_adapter.py               # DeepSeek 适配器
├── doubao_adapter.py                 # 豆包适配器
├── qwen_adapter.py                   # 通义千问适配器
├── zhipu_adapter.py                  # 智谱 AI 适配器
└── factory.py                        # 工厂模式（已有）
```

---

## 六、数据库优化

### 6.1 索引优化清单

| 表名 | 当前索引 | 建议新增索引 | 预期提升 |
|-----|---------|------------|---------|
| `test_records` | execution_id | brand_name, created_at | 查询速度 5x |
| `task_status` | task_id | status, updated_at | 轮询效率 3x |
| `intelligence_results` | execution_id | brand_name, platform | 聚合速度 4x |

### 6.2 查询优化

| 查询场景 | 当前 SQL | 优化方案 |
|---------|---------|---------|
| 获取测试结果 | 单表查询 | 使用 JOIN + 索引覆盖 |
| 进度轮询 | 频繁全表扫描 | 添加状态索引 |
| 历史记录 | 无分页 | 添加 LIMIT + 游标分页 |

---

## 七、前端状态管理优化

### 7.1 引入轻量级状态管理

**当前问题**:
- 页面间数据共享依赖 Storage
- 全局状态管理分散

**建议方案**: 引入 MobX-miniprogram 或自研轻量级 Store

```javascript
// store/index.js
const store = {
  // 用户状态
  user: {
    openid: '',
    userInfo: null,
    permissions: []
  },
  
  // 诊断状态
  diagnosis: {
    currentExecutionId: null,
    status: 'idle', // idle | running | completed | failed
    progress: 0,
    results: null
  },
  
  // UI 状态
  ui: {
    loading: false,
    error: null,
    theme: 'light'
  }
};

// 页面中使用
import { observer } from 'mobx-miniprogram';
import store from '../../store/index';

Page({
  data: observer(store)
});
```

**预计工时**: 8 小时

---

## 八、测试覆盖率提升

### 8.1 当前测试状态

| 类别 | 文件数 | 测试覆盖 | 目标覆盖 |
|-----|-------|---------|---------|
| 前端 JS | 127 个 | <5% | >60% |
| 后端 Python | ~200 个 | ~30% | >70% |

### 8.2 测试计划

**阶段 1（2 周）**: 核心服务测试
- reportAggregator.js 测试
- brandTestService.js 测试
- dataProcessorService.js 测试

**阶段 2（4 周）**: 页面组件测试
- index.js 交互测试
- results.js 渲染测试

**阶段 3（6 周）**: 后端 API 测试
- views.py 路由测试
- services 层业务逻辑测试

---

## 九、重构优先级矩阵

```
                    影响范围
              小 ◄────────► 大
            ┌─────────┬─────────┐
          高│  P2     │  P0     │
            │ 组件优化 │ views.py│
            │         │ results │
  实施难度  ├─────────┼─────────┤
            │  P2     │  P1     │
          低│ 工具整理 │ aggregator│
            │         │ db_core │
            └─────────┴─────────┘
```

---

## 十、执行时间表

### 第 1 周（P0 紧急）
- [ ] backend/views.py 拆分（16h）
- [ ] pages/results/results.js 服务化（12h）

### 第 2 周（P1 重要）
- [ ] services/reportAggregator.js 简化（8h）
- [ ] backend/nxm_execution_engine.py 优化（10h）
- [ ] backend/database_core.py 重构（8h）

### 第 3-4 周（P2 优化）
- [ ] 组件化重构（16h）
- [ ] 工具函数整理（8h）
- [ ] 页面优化（12h）

### 第 5-8 周（长期）
- [ ] 状态管理引入（8h）
- [ ] 测试覆盖率提升（40h）
- [ ] 性能监控部署（16h）

---

## 十一、风险评估与缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|-----|------|------|---------|
| 重构引入 Bug | 中 | 高 | 全面单元测试 + 回归测试 |
| 进度延期 | 中 | 中 | 分阶段执行 + 每周 review |
| 团队学习成本 | 低 | 低 | 文档 + 代码审查 |
| 性能回退 | 低 | 高 | 性能基准测试 + 监控 |

---

## 十二、验收标准

### 代码质量指标
- [ ] 单文件最大行数 < 500 行
- [ ] 函数平均行数 < 50 行
- [ ] 圈复杂度 < 10
- [ ] 重复代码率 < 5%

### 测试覆盖指标
- [ ] 核心服务测试覆盖 > 80%
- [ ] API 端点测试覆盖 > 70%
- [ ] 页面组件测试覆盖 > 50%

### 性能指标
- [ ] 页面加载时间 < 2s
- [ ] API 响应时间 P95 < 500ms
- [ ] 诊断执行成功率 > 99%

---

## 十三、文档更新清单

重构完成后需更新以下文档：

- [ ] `docs/架构设计.md`
- [ ] `docs/API 接口文档.md`
- [ ] `docs/服务层说明.md`
- [ ] `docs/组件库文档.md`
- [ ] `docs/测试指南.md`
- [ ] `docs/部署手册.md`

---

**文档生成时间**: 2026-02-22  
**审核人**: 待定  
**批准人**: 待定  
**下次更新**: 每周 review 后更新
