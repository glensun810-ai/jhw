# P1-8 审计日志系统实施报告

**文档版本**: v1.0  
**创建日期**: 2026-02-21  
**实施状态**: ✅ 已完成  

---

## 执行摘要

### 问题描述

无管理员操作审计日志，导致：
- 无法追溯操作历史
- 安全风险
- 无法进行责任认定
- 缺乏异常操作监控

### 实施内容

本次实施完成了完整的审计日志系统，包括：
1. ✅ 审计日志数据库表设计
2. ✅ 审计日志记录模块
3. ✅ 审计日志装饰器
4. ✅ 审计日志查询 API
5. ✅ 审计统计 API
6. ✅ 可疑活动检测
7. ✅ 审计日志导出功能
8. ✅ 审计日志管理页面

### 新增模块

| 模块 | 类型 | 路径 | 功能 |
|------|------|------|------|
| audit_logs.py | 后端模块 | `wechat_backend/audit_logs.py` | 审计日志核心功能 |
| audit_decorator.py | 后端模块 | `wechat_backend/audit_decorator.py` | 审计日志装饰器 |
| views_audit.py | 后端模块 | `wechat_backend/views_audit.py` | 审计日志 API |
| audit-logs | 前端页面 | `pages/admin/audit-logs/` | 审计日志管理页面 |

### 新增 API 端点

| 端点 | 方法 | 功能 | 权限 |
|------|------|------|------|
| `/audit/logs` | GET | 查询审计日志 | 管理员 |
| `/audit/statistics` | GET | 获取审计统计 | 管理员 |
| `/audit/suspicious` | GET | 获取可疑活动 | 管理员 |
| `/audit/export` | GET | 导出审计日志 | 管理员 |
| `/audit/admin-stats` | GET | 管理员操作统计 | 管理员 |

---

## 第一部分：数据库设计

### 1.1 审计日志表结构

```sql
CREATE TABLE audit_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    admin_id TEXT NOT NULL,              -- 管理员 ID
    action TEXT NOT NULL,                 -- 操作类型
    resource TEXT,                        -- 操作资源
    resource_id TEXT,                     -- 资源 ID
    ip_address TEXT,                      -- IP 地址
    user_agent TEXT,                      -- 用户代理
    request_method TEXT,                  -- 请求方法
    request_data TEXT,                    -- 请求数据（JSON）
    response_status INTEGER,              -- 响应状态码
    error_message TEXT,                   -- 错误信息
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP  -- 创建时间
);

-- 索引
CREATE INDEX idx_audit_logs_admin_id ON audit_logs(admin_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
CREATE INDEX idx_audit_logs_resource ON audit_logs(resource);
```

### 1.2 字段说明

| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| id | INTEGER | 日志 ID | 123 |
| admin_id | TEXT | 管理员 ID | admin_001 |
| action | TEXT | 操作类型 | grant_admin, batch_delete |
| resource | TEXT | 操作资源 | user, test, platform |
| resource_id | TEXT | 资源 ID | 123, user_001 |
| ip_address | TEXT | IP 地址 | 192.168.1.100 |
| user_agent | TEXT | 用户代理 | Mozilla/5.0... |
| request_method | TEXT | 请求方法 | GET, POST |
| request_data | TEXT | 请求数据（JSON） | {"user_ids": [...]} |
| response_status | INTEGER | 响应状态码 | 200, 404, 500 |
| error_message | TEXT | 错误信息 | Permission denied |
| created_at | TIMESTAMP | 创建时间 | 2026-02-21 10:00:00 |

---

## 第二部分：后端实现

### 2.1 审计日志核心模块

**文件**: `wechat_backend/audit_logs.py`

**核心函数**:

```python
def save_audit_log(admin_id, action, resource=None, resource_id=None, 
                   ip_address=None, user_agent=None, request_method=None,
                   request_data=None, response_status=None, error_message=None):
    """保存审计日志"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    
    cursor.execute('''
        INSERT INTO audit_logs (
            admin_id, action, resource, resource_id, ip_address,
            user_agent, request_method, request_data, response_status,
            error_message
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    ''', (
        admin_id, action, resource, resource_id, ip_address,
        user_agent, request_method,
        json.dumps(request_data) if request_data else None,
        response_status, error_message
    ))
    
    conn.commit()
    conn.close()


def get_audit_logs(admin_id=None, action=None, resource=None, 
                   start_date=None, end_date=None, page=1, page_size=20):
    """查询审计日志"""
    # 构建动态查询条件
    # 返回日志列表和分页信息


def get_audit_statistics(days=7):
    """获取审计统计数据"""
    # 返回总操作数、错误数、错误率
    # 按操作类型、管理员、资源统计


def get_suspicious_activities(threshold=10, minutes=5):
    """检测可疑活动"""
    # 检测频繁操作
    # 检测频繁错误
    # 返回可疑活动列表


def export_audit_logs(format='csv', admin_id=None, start_date=None, end_date=None):
    """导出审计日志"""
    # 支持 CSV 和 JSON 格式
    # 返回导出的数据
```

---

### 2.2 审计日志装饰器

**文件**: `wechat_backend/audit_decorator.py`

**使用示例**:

```python
@admin_bp.route('/users/<user_id>/roles', methods=['POST'])
@require_admin
@log_admin_action(resource_type='user', resource_id_field='user_id')
def assign_user_role(user_id):
    """分配用户角色"""
    # 业务逻辑
    pass
```

**装饰器功能**:
- ✅ 自动记录操作
- ✅ 捕获响应状态码
- ✅ 捕获错误信息
- ✅ 脱敏敏感数据（密码、Token 等）
- ✅ 记录 IP 地址和用户代理

**批量操作装饰器**:

```python
@admin_bp.route('/users/batch-action', methods=['POST'])
@require_admin
@log_batch_action(resource_type='user')
def batch_user_action():
    """批量操作用户"""
    # 自动记录批量操作统计
    # processed_count, failed_count
```

---

### 2.3 审计日志 API

**文件**: `wechat_backend/views_audit.py`

**查询审计日志**:
```python
@audit_bp.route('/logs', methods=['GET'])
@require_auth
@require_admin
def query_audit_logs():
    """
    查询审计日志
    
    Query Parameters:
    - admin_id: 管理员 ID（可选）
    - action: 操作类型（可选）
    - resource: 资源类型（可选）
    - start_date: 开始日期（可选）
    - end_date: 结束日期（可选）
    - page: 页码（默认 1）
    - page_size: 每页数量（默认 20）
    """
```

**获取审计统计**:
```python
@audit_bp.route('/statistics', methods=['GET'])
@require_auth
@require_admin
def get_audit_stats():
    """
    获取审计统计数据
    
    Query Parameters:
    - days: 统计天数（默认 7）
    """
```

**获取可疑活动**:
```python
@audit_bp.route('/suspicious', methods=['GET'])
@require_auth
@require_admin
def get_suspicious():
    """
    获取可疑活动列表
    
    Query Parameters:
    - threshold: 阈值（默认 10）
    - minutes: 时间窗口（默认 5）
    """
```

**导出审计日志**:
```python
@audit_bp.route('/export', methods=['GET'])
@require_auth
@require_admin
def export_logs():
    """
    导出审计日志
    
    Query Parameters:
    - format: 导出格式（csv/json，默认 csv）
    - admin_id: 管理员 ID（可选）
    - start_date: 开始日期（可选）
    - end_date: 结束日期（可选）
    """
```

---

## 第三部分：前端实现

### 3.1 审计日志页面

**文件**: `pages/admin/audit-logs/audit-logs.*`

**筛选功能**:
- 管理员 ID 搜索
- 操作类型选择
- 日期范围选择
- 重置筛选

**统计卡片**:
- 总操作数
- 错误数
- 错误率（超过 5% 显示警告色）

**可疑活动告警**:
- 频繁操作检测
- 频繁错误检测
- 实时告警展示

**日志列表**:
- 操作类型（错误显示红色）
- 管理员 ID
- 响应状态（成功✅/失败❌）
- 资源信息
- IP 地址
- 时间戳
- 错误信息

**导出功能**:
- CSV 格式导出
- JSON 格式导出
- 支持筛选条件导出

---

### 3.2 页面布局

```
┌─────────────────────────────────────┐
│  审计日志                            │
│  管理员操作记录与监控                │
├─────────────────────────────────────┤
│  [管理员 ID] [操作类型] [日期] [查询]│
├─────────────────────────────────────┤
│  ┌─────┐ ┌─────┐ ┌─────┐          │
│  │总操作│ │错误数│ │错误率│          │
│  │ 150 │ │ 5   │ │ 3.3%│          │
│  └─────┘ └─────┘ └─────┘          │
├─────────────────────────────────────┤
│  ⚠️ 发现 2 个可疑活动                 │
│  - 频繁操作 - admin_001 (15 次)      │
│  - 频繁错误 - admin_002 (8 次)       │
├─────────────────────────────────────┤
│  操作日志               [导出日志]   │
│  ┌─────────────────────────────┐   │
│  │ grant_admin ✅ 200          │   │
│  │ 管理员：admin_001            │   │
│  │ 资源：user (123)             │   │
│  │ IP: 192.168.1.100           │   │
│  │ 时间：02-21 10:00           │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

---

## 第四部分：使用示例

### 4.1 查询审计日志

```javascript
// 查询某管理员的操作日志
wx.request({
  url: 'http://127.0.0.1:5000/audit/logs?admin_id=admin_001&page=1',
  header: {'Authorization': `Bearer ${token}`},
  success: (res) => {
    const logs = res.data.data.logs;
    console.log('审计日志:', logs);
  }
});
```

### 4.2 获取审计统计

```javascript
// 获取近 7 天审计统计
wx.request({
  url: 'http://127.0.0.1:5000/audit/statistics?days=7',
  header: {'Authorization': `Bearer ${token}`},
  success: (res) => {
    const stats = res.data.data;
    console.log('总操作数:', stats.total_actions);
    console.log('错误数:', stats.error_count);
    console.log('错误率:', stats.error_rate + '%');
  }
});
```

### 4.3 检测可疑活动

```javascript
// 获取可疑活动（5 分钟内操作超过 10 次）
wx.request({
  url: 'http://127.0.0.1:5000/audit/suspicious?threshold=10&minutes=5',
  header: {'Authorization': `Bearer ${token}`},
  success: (res) => {
    const suspicious = res.data.data.suspicious_activities;
    console.log('可疑活动:', suspicious);
  }
});
```

### 4.4 导出审计日志

```javascript
// 导出 CSV 格式审计日志
wx.downloadFile({
  url: 'http://127.0.0.1:5000/audit/export?format=csv&start_date=2026-02-01',
  header: {'Authorization': `Bearer ${token}`},
  success: (res) => {
    wx.openDocument({
      filePath: res.tempFilePath,
      showMenu: true
    });
  }
});
```

---

## 第五部分：安全特性

### 5.1 敏感数据脱敏

```python
# 自动脱敏敏感字段
if request_data:
    for sensitive_field in ['password', 'token', 'secret', 'key']:
        if sensitive_field in request_data:
            request_data[sensitive_field] = '***'
```

### 5.2 权限控制

- ✅ 所有审计端点需要管理员权限
- ✅ 需要有效的 JWT Token
- ✅ 限流保护（防止滥用）

### 5.3 不可篡改性

- ✅ 日志一旦创建不可修改
- ✅ 只允许查询和导出
- ✅ 无删除接口

---

## 第六部分：可疑活动检测

### 6.1 检测规则

**频繁操作检测**:
```python
# 5 分钟内同一管理员同一操作超过 10 次
SELECT admin_id, action, COUNT(*) as count
FROM audit_logs
WHERE created_at >= ?  # 5 分钟前
GROUP BY admin_id, action
HAVING count >= 10
```

**频繁错误检测**:
```python
# 5 分钟内同一管理员错误超过 5 次
SELECT admin_id, COUNT(*) as error_count
FROM audit_logs
WHERE created_at >= ? AND response_status >= 400
GROUP BY admin_id
HAVING error_count >= 5
```

### 6.2 告警阈值

| 检测类型 | 默认阈值 | 时间窗口 | 告警级别 |
|----------|----------|----------|----------|
| 频繁操作 | 10 次 | 5 分钟 | 警告 |
| 频繁错误 | 5 次 | 5 分钟 | 严重 |

---

## 第七部分：性能优化

### 7.1 数据库索引

```sql
CREATE INDEX idx_audit_logs_admin_id ON audit_logs(admin_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
CREATE INDEX idx_audit_logs_resource ON audit_logs(resource);
```

### 7.2 分页查询

```python
# 限制最大页大小
page_size = min(page_size, 100)

# 使用 OFFSET 分页
LIMIT ? OFFSET ?
```

### 7.3 日志清理策略

**建议**:
- 保留最近 90 天的详细日志
- 90 天前的日志归档或聚合统计
- 定期清理测试数据

---

## 第八部分：后续改进计划

### P1 改进项

1. **实时告警**
   - WebSocket 实时推送
   - 邮件告警
   - 短信告警

2. **日志分析**
   - 操作趋势分析
   - 管理员行为画像
   - 异常模式识别

### P2 改进项

3. **日志归档**
   - 自动归档旧日志
   - 压缩存储
   - 快速检索

4. **合规报告**
   - 自动生成合规报告
   - 审计轨迹导出
   - 第三方审计支持

---

**文档结束**
