# ã€å“ç‰Œ AI è¯Šæ–­ç³»ç»Ÿã€‘ä¸‰è§’è‰²æ·±åº¦è¯Šæ–­ä¸é‡æ„å®æ–½æ–¹æ¡ˆ

**å®¡è®¡ç‰ˆæœ¬**: v2.0  
**å®¡è®¡æ—¥æœŸ**: 2026-02-22  
**å®¡è®¡èŒƒå›´**: å¾®ä¿¡å°ç¨‹åºå‰ç«¯ + Flask åç«¯  
**å‚ä¸è§’è‰²**: é¦–å¸­è½¯ä»¶æ¶æ„å¸ˆã€é«˜çº§å…¨æ ˆå¼€å‘ä¸“å®¶ã€èµ„æ·±å‰ç«¯äº¤äº’å·¥ç¨‹å¸ˆ

---

## æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šç”±ä¸‰ä½èµ„æ·±ä¸“å®¶è”åˆè¾“å‡ºï¼Œé’ˆå¯¹å“ç‰Œ AI è¯Šæ–­ç³»ç»Ÿå½“å‰å­˜åœ¨çš„ **ä»£ç è‡ƒè‚¿**ã€**403 è®¤è¯é”™è¯¯**ã€**Canvas æ¸²æŸ“æ­»é”** ç­‰æ ¸å¿ƒé—®é¢˜è¿›è¡Œæ·±åº¦è¯Šæ–­ï¼Œå¹¶æä¾›å¯ç›´æ¥è½åœ°çš„é‡æ„æ–¹æ¡ˆã€‚

### æ ¸å¿ƒé—®é¢˜æ¦‚è§ˆ

| é—®é¢˜ç±»åˆ« | P0 çº§é—®é¢˜ | P1 çº§é—®é¢˜ | å½±å“èŒƒå›´ |
|---------|----------|----------|---------|
| ä»£ç ç»“æ„ | å•æ–‡ä»¶ 2276 è¡Œ | èŒè´£ä¸æ¸… | å…¨ç³»ç»Ÿ |
| è®¤è¯å®‰å…¨ | 403 Token è¿‡æœŸ | åˆ·æ–°æ­»å¾ªç¯ | ç»“æœé¡µ |
| UI ç¨³å®šæ€§ | Canvas èŠ‚ç‚¹æœªæ‰¾åˆ° | Loading æ€ç¼ºå¤± | å›¾è¡¨æ¸²æŸ“ |

---

# è§’è‰² Aï¼šé¦–å¸­è½¯ä»¶æ¶æ„å¸ˆè¯Šæ–­æŠ¥å‘Š

## A1. ä»£ç "ç˜¦èº«"æ–¹æ¡ˆ - index.js 2000 è¡Œé€»è¾‘åˆ†æ

### A1.1 ä»£ç èŒè´£åˆ†ç±»æ¸…å•

é€šè¿‡å¯¹ `pages/index/index.js` (2276 è¡Œ) çš„é€è¡Œåˆ†æï¼Œä»£ç èŒè´£åˆ†å¸ƒå¦‚ä¸‹ï¼š

| èŒè´£ç±»åˆ« | è¡Œå·èŒƒå›´ | è¡Œæ•° | å æ¯” | åº”è¿ç§»ä½ç½® |
|---------|---------|------|------|-----------|
| **UI äº¤äº’** | 1-100, 400-600, 1800-2000 | ~500 è¡Œ | 22% | ä¿ç•™åœ¨ Page |
| **æ•°æ®è®¡ç®—** | 1200-1500, 1600-1800 | ~500 è¡Œ | 22% | `services/` |
| **æŒä¹…åŒ–å­˜å‚¨** | 500-700, 1100-1200 | ~400 è¡Œ | 18% | `utils/storageManager.js` |
| **API è°ƒç”¨** | 900-1100, 1500-1600 | ~400 è¡Œ | 18% | `api/brand.js` |
| **çŠ¶æ€ç®¡ç†** | 700-900, 2000-2200 | ~400 è¡Œ | 18% | `services/pollingService.js` |
| **ç”Ÿå‘½å‘¨æœŸ** | 100-200, 200-400 | ~76 è¡Œ | 2% | ä¿ç•™åœ¨ Page |

### A1.2 è¯¦ç»†æ–‡ä»¶åˆ†æ‹†æ–¹æ¡ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    index.js ä»£ç åˆ†æ‹†åœ°å›¾                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ã€ä¿ç•™åœ¨ pages/index/index.jsã€‘                                 â”‚
â”‚  â”œâ”€â”€ onLoad, onShow, onReady, onUnload (ç”Ÿå‘½å‘¨æœŸ)               â”‚
â”‚  â”œâ”€â”€ äº‹ä»¶å¤„ç†å‡½æ•° (onBrandNameInput, onCompetitorInput)         â”‚
â”‚  â”œâ”€â”€ UI åˆ‡æ¢å‡½æ•° (toggleAdvancedSettings, handleResetAll)       â”‚
â”‚  â””â”€â”€ ç»„ä»¶é€šä¿¡å‡½æ•° (onSourceTap, onViewModeChange)               â”‚
â”‚                                                                 â”‚
â”‚  ã€è¿ç§»è‡³ services/brandTestService.jsã€‘                         â”‚
â”‚  â”œâ”€â”€ startBrandTest() æ ¸å¿ƒä¸šåŠ¡é€»è¾‘                              â”‚
â”‚  â”œâ”€â”€ validateInput() è¾“å…¥éªŒè¯é€»è¾‘                               â”‚
â”‚  â”œâ”€â”€ buildPayload() è¯·æ±‚è½½è·æ„å»º                                â”‚
â”‚  â”œâ”€â”€ generateDashboardData() ä»ªè¡¨ç›˜æ•°æ®ç”Ÿæˆ                     â”‚
â”‚  â”œâ”€â”€ generateTrendChartData() è¶‹åŠ¿å›¾æ•°æ®ç”Ÿæˆ                    â”‚
â”‚  â”œâ”€â”€ extractScoreData() è¯„åˆ†æ•°æ®æå–                            â”‚
â”‚  â”œâ”€â”€ extractCompetitionData() ç«äº‰æ•°æ®æå–                      â”‚
â”‚  â””â”€â”€ extractSourceListData() ä¿¡æºæ•°æ®æå–                       â”‚
â”‚                                                                 â”‚
â”‚  ã€è¿ç§»è‡³ services/pollingService.jsã€‘                           â”‚
â”‚  â”œâ”€â”€ pollTestProgress() è½®è¯¢æ ¸å¿ƒé€»è¾‘                            â”‚
â”‚  â”œâ”€â”€ createPollingController() è½®è¯¢æ§åˆ¶å™¨                       â”‚
â”‚  â”œâ”€â”€ parseTaskStatus() çŠ¶æ€è§£æ                                 â”‚
â”‚  â”œâ”€â”€ handlePollingError() é”™è¯¯å¤„ç†                              â”‚
â”‚  â””â”€â”€ shouldStopPolling() ç»ˆæ­¢æ¡ä»¶åˆ¤æ–­                           â”‚
â”‚                                                                 â”‚
â”‚  ã€è¿ç§»è‡³ services/draftService.jsã€‘                             â”‚
â”‚  â”œâ”€â”€ saveDraft() ä¿å­˜è‰ç¨¿                                       â”‚
â”‚  â”œâ”€â”€ restoreDraft() æ¢å¤è‰ç¨¿                                    â”‚
â”‚  â”œâ”€â”€ clearDraft() æ¸…é™¤è‰ç¨¿                                      â”‚
â”‚  â”œâ”€â”€ validateDraft() è‰ç¨¿æ ¡éªŒ                                   â”‚
â”‚  â””â”€â”€ isDraftExpired() è¿‡æœŸæ£€æŸ¥                                  â”‚
â”‚                                                                 â”‚
â”‚  ã€è¿ç§»è‡³ api/brand.jsã€‘                                        â”‚
â”‚  â”œâ”€â”€ checkServerConnectionApi()                                 â”‚
â”‚  â”œâ”€â”€ startBrandTestApi()                                        â”‚
â”‚  â”œâ”€â”€ getTestProgressApi()                                       â”‚
â”‚  â””â”€â”€ getTaskStatusApi()                                         â”‚
â”‚                                                                 â”‚
â”‚  ã€è¿ç§»è‡³ utils/storageManager.jsã€‘                              â”‚
â”‚  â”œâ”€â”€ setWithExpiry() å¸¦è¿‡æœŸæ—¶é—´çš„å­˜å‚¨                           â”‚
â”‚  â”œâ”€â”€ getWithExpiry() å¸¦è¿‡æœŸæ£€æŸ¥çš„è¯»å–                           â”‚
â”‚  â”œâ”€â”€ saveDiagnosticResult() è¯Šæ–­ç»“æœå­˜å‚¨                        â”‚
â”‚  â”œâ”€â”€ getDiagnosticResult() è¯Šæ–­ç»“æœè¯»å–                         â”‚
â”‚  â””â”€â”€ clearExpiredData() è¿‡æœŸæ•°æ®æ¸…ç†                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### A1.3 é‡æ„åæ–‡ä»¶è¡Œæ•°å¯¹æ¯”

| æ–‡ä»¶ | é‡æ„å‰ | é‡æ„å | ç¼©å‡ç‡ |
|-----|-------|-------|--------|
| `pages/index/index.js` | 2276 è¡Œ | ~400 è¡Œ | 82% â†“ |
| `services/brandTestService.js` | 0 è¡Œ | ~350 è¡Œ | æ–°å¢ |
| `services/pollingService.js` | 0 è¡Œ | ~200 è¡Œ | æ–°å¢ |
| `services/draftService.js` | 0 è¡Œ | ~150 è¡Œ | æ–°å¢ |
| `api/brand.js` | 0 è¡Œ | ~100 è¡Œ | æ–°å¢ |
| `utils/storageManager.js` | 0 è¡Œ | ~150 è¡Œ | æ–°å¢ |

---

## A2. è§£è€¦å»ºè®® - å‘å¸ƒ - è®¢é˜…æ¨¡å¼è§£å†³æ—¶åºé—®é¢˜

### A2.1 å½“å‰ onLoad æ—¶åºé—®é¢˜

```javascript
// âŒ å½“å‰é—®é¢˜ï¼šä»»åŠ¡å †å å¯¼è‡´æ—¶åºæ··ä¹±
onLoad: function (options) {
  this.initializeDefaults();      // ä»»åŠ¡ 1: åˆå§‹åŒ–é»˜è®¤å€¼
  this.checkServerConnection();   // ä»»åŠ¡ 2: æ£€æŸ¥æœåŠ¡å™¨ (å¼‚æ­¥)
  this.loadUserPlatformPreferences(); // ä»»åŠ¡ 3: åŠ è½½åå¥½ (å¼‚æ­¥)
  this.restoreDraft();            // ä»»åŠ¡ 4: æ¢å¤è‰ç¨¿ (ä¾èµ–ä»»åŠ¡ 3)
  this.checkLatestDiagnosis();    // ä»»åŠ¡ 5: æ£€æŸ¥è¯Šæ–­ (å¼‚æ­¥)
  // é—®é¢˜ï¼šå¼‚æ­¥ä»»åŠ¡æ— åºæ‰§è¡Œï¼ŒrestoreDraft å¯èƒ½è¯»å–æœªåˆå§‹åŒ–çš„æ•°æ®
}
```

### A2.2 å‘å¸ƒ - è®¢é˜…æ¨¡å¼å®ç°

```javascript
// ==================== utils/eventBus.js ====================
/**
 * è½»é‡çº§äº‹ä»¶æ€»çº¿ï¼ˆå‘å¸ƒ - è®¢é˜…æ¨¡å¼ï¼‰
 */
const eventBus = {
  events: {},

  // è®¢é˜…äº‹ä»¶
  on(event, callback) {
    if (!this.events[event]) {
      this.events[event] = [];
    }
    this.events[event].push(callback);
    return () => this.off(event, callback); // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°
  },

  // å‘å¸ƒäº‹ä»¶
  emit(event, data) {
    if (!this.events[event]) return;
    this.events[event].forEach(callback => callback(data));
  },

  // å–æ¶ˆè®¢é˜…
  off(event, callback) {
    if (!this.events[event]) return;
    this.events[event] = this.events[event].filter(cb => cb !== callback);
  },

  // ä¸€æ¬¡æ€§è®¢é˜…
  once(event, callback) {
    const unsubscribe = this.on(event, (data) => {
      unsubscribe();
      callback(data);
    });
    return unsubscribe;
  }
};

module.exports = { eventBus };
```

### A2.3 çŠ¶æ€æœºæ¨¡å¼å®ç°

```javascript
// ==================== services/pageStateMachine.js ====================
/**
 * é¡µé¢çŠ¶æ€æœº
 * è§£å†³ onLoad ä¸­å¤šä»»åŠ¡æ—¶åºä¾èµ–é—®é¢˜
 */

const { eventBus } = require('../utils/eventBus');

// çŠ¶æ€å®šä¹‰
const STATES = {
  INIT: 'init',
  INITIALIZING: 'initializing',
  INITIALIZED: 'initialized',
  CONNECTING: 'connecting',
  CONNECTED: 'connected',
  LOADING_PREFS: 'loading_prefs',
  PREFS_LOADED: 'prefs_loaded',
  RESTORING_DRAFT: 'restoring_draft',
  DRAFT_RESTORED: 'draft_restored',
  READY: 'ready'
};

// äº‹ä»¶å®šä¹‰
const EVENTS = {
  INIT_START: 'init:start',
  INIT_COMPLETE: 'init:complete',
  CONNECTION_COMPLETE: 'connection:complete',
  PREFS_COMPLETE: 'prefs:complete',
  DRAFT_COMPLETE: 'draft:complete'
};

class PageStateMachine {
  constructor(pageContext) {
    this.page = pageContext;
    this.currentState = STATES.INIT;
    this.stateHistory = [];
    this.pendingTasks = new Map();
  }

  // çŠ¶æ€è½¬æ¢
  transition(newState, eventData = {}) {
    const oldState = this.currentState;
    this.currentState = newState;
    this.stateHistory.push({
      from: oldState,
      to: newState,
      timestamp: Date.now(),
      eventData
    });

    console.log(`[State] ${oldState} â†’ ${newState}`);
    eventBus.emit(`state:${newState}`, { oldState, eventData });
  }

  // åˆå§‹åŒ–æµç¨‹ï¼ˆæœ‰åºæ‰§è¡Œï¼‰
  async initialize(options) {
    this.transition(STATES.INITIALIZING);

    try {
      // æ­¥éª¤ 1: åˆå§‹åŒ–é»˜è®¤å€¼ï¼ˆåŒæ­¥ï¼‰
      await this.taskInit();
      this.transition(STATES.INITIALIZED);

      // æ­¥éª¤ 2 & 3: å¹¶è¡Œæ‰§è¡Œï¼ˆè¿æ¥æ£€æŸ¥ + åŠ è½½åå¥½ï¼‰
      const [connectionResult, prefsResult] = await Promise.all([
        this.taskCheckConnection(),
        this.taskLoadPreferences()
      ]);
      this.transition(STATES.CONNECTED, { connectionResult, prefsResult });

      // æ­¥éª¤ 4: æ¢å¤è‰ç¨¿ï¼ˆä¾èµ–åå¥½åŠ è½½å®Œæˆï¼‰
      await this.taskRestoreDraft();
      this.transition(STATES.DRAFT_RESTORED);

      // æ­¥éª¤ 5: æ£€æŸ¥æœ€æ–°è¯Šæ–­ï¼ˆç‹¬ç«‹ä»»åŠ¡ï¼‰
      this.taskCheckDiagnosis(options);

      // å®Œæˆ
      this.transition(STATES.READY);
      eventBus.emit(EVENTS.DRAFT_COMPLETE);

    } catch (error) {
      console.error('[State] åˆå§‹åŒ–å¤±è´¥:', error);
      this.transition(STATES.INIT, { error });
    }
  }

  // ä»»åŠ¡ 1: åˆå§‹åŒ–é»˜è®¤å€¼
  async taskInit() {
    return new Promise((resolve) => {
      this.page.initializeDefaults();
      resolve();
    });
  }

  // ä»»åŠ¡ 2: æ£€æŸ¥æœåŠ¡å™¨è¿æ¥
  async taskCheckConnection() {
    return this.page.checkServerConnection();
  }

  // ä»»åŠ¡ 3: åŠ è½½ç”¨æˆ·åå¥½
  async taskLoadPreferences() {
    return this.page.loadUserPlatformPreferences();
  }

  // ä»»åŠ¡ 4: æ¢å¤è‰ç¨¿
  async taskRestoreDraft() {
    return this.page.restoreDraft();
  }

  // ä»»åŠ¡ 5: æ£€æŸ¥æœ€æ–°è¯Šæ–­
  taskCheckDiagnosis(options) {
    // å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»æµç¨‹
    setTimeout(() => this.page.checkLatestDiagnosis(), 100);
  }

  // æ£€æŸ¥æ˜¯å¦å¤„äºæŸçŠ¶æ€
  is(state) {
    return this.currentState === state;
  }

  // ç­‰å¾…ç‰¹å®šçŠ¶æ€
  waitFor(targetState) {
    return new Promise((resolve) => {
      if (this.currentState === targetState) {
        resolve();
        return;
      }
      eventBus.once(`state:${targetState}`, resolve);
    });
  }
}

module.exports = { PageStateMachine, STATES, EVENTS };
```

### A2.4 é‡æ„åçš„ onLoad

```javascript
// ==================== pages/index/index.js ====================
const { PageStateMachine } = require('../../services/pageStateMachine');

Page({
  data: { /* ... */ },

  onLoad: function (options) {
    console.log('å“ç‰Œ AI é›·è¾¾ - é¡µé¢åŠ è½½å®Œæˆ');

    // åˆ›å»ºçŠ¶æ€æœºå®ä¾‹
    this.stateMachine = new PageStateMachine(this);

    // å¯åŠ¨åˆå§‹åŒ–æµç¨‹ï¼ˆæœ‰åºæ‰§è¡Œï¼‰
    this.stateMachine.initialize(options);

    // è®¢é˜…çŠ¶æ€å˜åŒ–ï¼ˆç”¨äº UI æ›´æ–°ï¼‰
    this.stateMachine.on('state:ready', () => {
      this.setData({ isReady: true });
    });
  },

  // åŸæœ‰æ–¹æ³•ä¿æŒä¸å˜ï¼Œä½†å†…éƒ¨é€»è¾‘ç®€åŒ–
  initializeDefaults: function() { /* ... */ },
  checkServerConnection: function() { /* ... */ },
  loadUserPlatformPreferences: function() { /* ... */ },
  restoreDraft: function() { /* ... */ },
  checkLatestDiagnosis: function() { /* ... */ }
});
```

---

# è§’è‰² Bï¼šé«˜çº§å…¨æ ˆå¼€å‘ä¸“å®¶è¯Šæ–­æŠ¥å‘Š

## B1. æ•°æ®æµå®‰å…¨å®¡è®¡ - 403 é”™è¯¯æ ¹å› åˆ†æ

### B1.1 å½“å‰æ‹¦æˆªå™¨æœºåˆ¶é—®é¢˜

```javascript
// âŒ å½“å‰é—®é¢˜ï¼šrequest.js ä¸­ Token æ³¨å…¥é€»è¾‘å­˜åœ¨ç«æ€æ¡ä»¶

const request = (options = {}) => {
  // é—®é¢˜ 1: Token è¯»å–æ—¶æœºè¿‡æ—©ï¼Œå¯èƒ½åœ¨åˆ·æ–°è¿‡ç¨‹ä¸­è¯»å–æ—§å€¼
  const token = wx.getStorageSync('userToken');
  if (token) requestParams.header.Authorization = `Bearer ${token}`;

  // é—®é¢˜ 2: 401 å¤„ç†ä¸­åˆ·æ–° Token åï¼Œé‡è¯•é€»è¾‘å¯èƒ½å†æ¬¡ä½¿ç”¨æ—§ Token
  if (response.statusCode === 401) {
    refreshToken()
      .then((newToken) => {
        // é—®é¢˜ 3: è¿™é‡Œä½¿ç”¨æ–° Token é‡è¯•ï¼Œä½†å¹¶å‘è¯·æ±‚ä»ç”¨æ—§ Token
        return request({ ...options, header: newHeader, loading: false });
      });
  }
};
```

### B1.2 æ ‡å‡† Token æ³¨å…¥ä¸åˆ·æ–°æœºåˆ¶

```javascript
// ==================== utils/request.js (ä¿®å¤ç‰ˆ) ====================

// Token åˆ·æ–°é”ï¼Œé˜²æ­¢å¹¶å‘åˆ·æ–°
let isRefreshing = false;
let refreshQueue = [];

/**
 * æ‰§è¡Œåˆ·æ–°é˜Ÿåˆ—ä¸­çš„è¯·æ±‚
 */
const executeRefreshQueue = (newToken) => {
  console.log('[Token] æ‰§è¡Œåˆ·æ–°é˜Ÿåˆ—ï¼Œç­‰å¾…è¯·æ±‚æ•°:', refreshQueue.length);
  refreshQueue.forEach(({ resolve, reject, options }) => {
    const newHeader = { ...options.header, Authorization: `Bearer ${newToken}` };
    request({ ...options, header: newHeader, loading: false })
      .then(resolve)
      .catch(reject);
  });
  refreshQueue = [];
};

/**
 * æ‹’ç»åˆ·æ–°é˜Ÿåˆ—ä¸­çš„è¯·æ±‚
 */
const rejectRefreshQueue = (error) => {
  console.error('[Token] æ‹’ç»åˆ·æ–°é˜Ÿåˆ—:', error);
  refreshQueue.forEach(({ reject }) => reject(error));
  refreshQueue = [];
};

/**
 * åˆ·æ–° Tokenï¼ˆå¸¦é”æœºåˆ¶ï¼‰
 */
const refreshToken = () => {
  return new Promise((resolve, reject) => {
    const storedRefreshToken = wx.getStorageSync('refresh_token');

    if (!storedRefreshToken) {
      console.error('[Token] æ—  refresh_token å¯ç”¨');
      reject(new Error('No refresh token'));
      return;
    }

    wx.request({
      url: getBaseUrl() + '/api/refresh-token',
      method: 'POST',
      data: { refresh_token: storedRefreshToken },
      header: { 'Content-Type': 'application/json' },
      success: (res) => {
        if (res.statusCode === 200 && res.data.status === 'success') {
          const newToken = res.data.access_token;
          const newRefreshToken = res.data.refresh_token;

          // åŒæ­¥ä¿å­˜æ–° Token
          wx.setStorageSync('access_token', newToken);
          wx.setStorageSync('refresh_token', newRefreshToken);

          console.log('[Token] åˆ·æ–°æˆåŠŸ');
          resolve(newToken);
        } else {
          console.error('[Token] åˆ·æ–°å¤±è´¥:', res.data);
          reject(new Error('Token refresh failed'));
        }
      },
      fail: (err) => {
        console.error('[Token] åˆ·æ–°è¯·æ±‚å¤±è´¥:', err);
        reject(err);
      }
    });
  });
};

/**
 * è·å–æœ€æ–° Tokenï¼ˆç¡®ä¿è¯»å–æœ€æ–°å€¼ï¼‰
 */
const getLatestToken = () => {
  // ä¼˜å…ˆè¯»å– access_tokenï¼Œå…¼å®¹æ—§ç‰ˆ userToken
  return wx.getStorageSync('access_token') || wx.getStorageSync('userToken') || '';
};

/**
 * ç»Ÿä¸€è¯·æ±‚å‡½æ•°ï¼ˆä¿®å¤ç‰ˆï¼‰
 */
const request = (options = {}) => {
  return new Promise((resolve, reject) => {
    const {
      url, method = 'GET', data = {}, header = {},
      loading = true, timeout = 30000, showError = true,
      skipAuth = false // æ–°å¢ï¼šè·³è¿‡è®¤è¯ï¼ˆç”¨äºåˆ·æ–° Token è¯·æ±‚æœ¬èº«ï¼‰
    } = options;

    if (loading) wx.showLoading({ title: 'åŠ è½½ä¸­...', mask: true });

    const baseUrl = getBaseUrl();
    const fullUrl = url.startsWith('http') ? url : baseUrl + url;
    const normalizedUrl = fullUrl.replace(/([^:])\/\//g, '$1/');

    // ã€å…³é”®ä¿®å¤ã€‘åœ¨å‘é€è¯·æ±‚å‰è·å–æœ€æ–° Token
    const token = skipAuth ? '' : getLatestToken();

    const requestParams = {
      url: normalizedUrl,
      method: method.toUpperCase(),
      data,
      header: {
        'Content-Type': 'application/json',
        ...header
      },
      timeout,
      success: (response) => {
        if (loading) wx.hideLoading();

        // ã€å…³é”®ä¿®å¤ã€‘å¤„ç† 401 é”™è¯¯ - å°è¯•åˆ·æ–° Token
        if (response.statusCode === 401 && !skipAuth) {
          console.warn('[Request] 401 æœªæˆæƒï¼Œå°è¯•åˆ·æ–° Token');

          if (isRefreshing) {
            // å·²ç»åœ¨åˆ·æ–°ï¼ŒåŠ å…¥é˜Ÿåˆ—ç­‰å¾…
            console.log('[Request] Token æ­£åœ¨åˆ·æ–°ï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—');
            refreshQueue.push({ resolve, reject, options });
            return;
          }

          isRefreshing = true;

          // å°è¯•åˆ·æ–° Token
          refreshToken()
            .then((newToken) => {
              isRefreshing = false;

              // æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„è¯·æ±‚
              executeRefreshQueue(newToken);

              // é‡è¯•åŸè¯·æ±‚
              const newHeader = { ...header, Authorization: `Bearer ${newToken}` };
              return request({ ...options, header: newHeader, loading: false, skipAuth: true });
            })
            .then(resolve)
            .catch((err) => {
              isRefreshing = false;
              rejectRefreshQueue(err);
              handleUnauthorized();
              reject(new Error('è®¤è¯å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•'));
            });
          return;
        }

        // å¤„ç† 403 é”™è¯¯
        if (response.statusCode === 403 && !skipAuth) {
          console.warn('[Request] 403 ç¦æ­¢è®¿é—®');

          // 403 é€šå¸¸è¡¨ç¤º Token æœ‰æ•ˆä½†æƒé™ä¸è¶³ï¼Œæˆ– Token å·²è¿‡æœŸ
          // å°è¯•åˆ·æ–° Token
          if (!isRefreshing) {
            isRefreshing = true;

            refreshToken()
              .then((newToken) => {
                isRefreshing = false;
                executeRefreshQueue(newToken);

                const newHeader = { ...header, Authorization: `Bearer ${newToken}` };
                return request({ ...options, header: newHeader, loading: false, skipAuth: true });
              })
              .then(resolve)
              .catch((err) => {
                isRefreshing = false;
                rejectRefreshQueue(err);
                reject(new Error('æƒé™ä¸è¶³æˆ–è®¤è¯è¿‡æœŸ'));
              });
            return;
          }
        }

        if (response.statusCode === 200) {
          resolve(response.data);
        } else {
          const error = new Error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.statusCode}`);
          error.statusCode = response.statusCode;
          error.data = response.data;
          reject(error);
        }
      },
      fail: (error) => {
        if (loading) wx.hideLoading();

        if (error.errMsg && error.errMsg.includes('the maximum size limit exceeded')) {
          clearStorageRecursive();
          resolve(null);
          return;
        }

        reject(new Error(error.errMsg || 'ç½‘ç»œè¯·æ±‚å¤±è´¥'));
      }
    };

    // ã€å…³é”®ä¿®å¤ã€‘è¯·æ±‚æ‹¦æˆªå™¨ï¼šè‡ªåŠ¨æ·»åŠ  Token å’Œè®¾å¤‡ä¿¡æ¯
    if (token) {
      requestParams.header.Authorization = `Bearer ${token}`;
    }

    // æ·»åŠ è®¾å¤‡ ID å’Œ OpenID
    const deviceId = getApp()?.globalData?.deviceId || wx.getStorageSync('device_id');
    const openid = getApp()?.globalData?.openid || wx.getStorageSync('openid');

    if (deviceId) requestParams.header['X-Device-ID'] = deviceId;
    if (openid) requestParams.header['X-User-OpenID'] = openid;

    wx.request(requestParams);
  });
};

/**
 * å¤„ç†æœªæˆæƒçŠ¶æ€
 */
const handleUnauthorized = () => {
  console.log('[Auth] ç”¨æˆ·æœªæˆæƒï¼Œæ¸…ç†æœ¬åœ°æ•°æ®å¹¶è·³è½¬ç™»å½•');

  // æ¸…ç†æ•æ„Ÿæ•°æ®
  wx.removeStorageSync('userInfo');
  wx.removeStorageSync('access_token');
  wx.removeStorageSync('refresh_token');
  wx.removeStorageSync('userPermissions');

  // è·³è½¬ç™»å½•
  wx.reLaunch({ url: '/pages/login/login' });
};

module.exports = {
  request,
  get: (url, params = {}, options = {}) => request({ url, method: 'GET', data: params, ...options }),
  post: (url, data = {}, options = {}) => request({ url, method: 'POST', data, ...options }),
  put: (url, data = {}, options = {}) => request({ url, method: 'PUT', data, ...options }),
  del: (url, data = {}, options = {}) => request({ url, method: 'DELETE', data, ...options })
};
```

---

## B2. å¤§å®¹é‡æ•°æ®ä¼ è¾“æ–¹æ¡ˆ - Storage + ExecutionId å¼‚æ­¥æ‹‰å–

### B2.1 å½“å‰ URL ä¼ å‚é—®é¢˜åˆ†æ

```javascript
// âŒ é—®é¢˜ï¼šURL ä¼ å‚æœ‰ 2KB é™åˆ¶
wx.navigateTo({
  url: `/pages/results/results?results=${encodeURIComponent(JSON.stringify(largeData))}`
  // å½“ largeData è¶…è¿‡ 2KB æ—¶ï¼ŒURL ä¼šè¢«æˆªæ–­ï¼Œå¯¼è‡´æ•°æ®ä¸¢å¤±
});
```

### B2.2 æœ€ä½³å®è·µæ–¹æ¡ˆ

```javascript
// ==================== services/resultTransferService.js ====================
/**
 * ç»“æœæ•°æ®ä¼ è¾“æœåŠ¡
 * è§£å†³ URL ä¼ å‚ 2KB é™åˆ¶é—®é¢˜
 */

const STORAGE_KEY_PREFIX = 'diagnostic_result_';
const STORAGE_META_KEY = 'diagnostic_result_meta';
const EXPIRY_TIME = 30 * 60 * 1000; // 30 åˆ†é’Ÿè¿‡æœŸ

/**
 * ä¿å­˜è¯Šæ–­ç»“æœåˆ° Storageï¼ˆåˆ†å—å­˜å‚¨ï¼‰
 */
const saveResult = (executionId, resultData) => {
  try {
    const timestamp = Date.now();

    // æ–¹æ¡ˆ 1: ç›´æ¥å­˜å‚¨ï¼ˆé€‚ç”¨äº < 500KB æ•°æ®ï¼‰
    if (JSON.stringify(resultData).length < 500 * 1024) {
      const storageKey = `${STORAGE_KEY_PREFIX}${executionId}`;
      wx.setStorageSync(storageKey, {
        data: resultData,
        timestamp,
        executionId
      });

      // ä¿å­˜å…ƒæ•°æ®ï¼ˆç”¨äºæ¸…ç†ï¼‰
      const meta = wx.getStorageSync(STORAGE_META_KEY) || {};
      meta[executionId] = { timestamp, size: JSON.stringify(resultData).length };
      wx.setStorageSync(STORAGE_META_KEY, meta);

      console.log('[Transfer] ç»“æœå·²ä¿å­˜:', { executionId, size: JSON.stringify(resultData).length });
      return true;
    }

    // æ–¹æ¡ˆ 2: åˆ†å—å­˜å‚¨ï¼ˆé€‚ç”¨äº > 500KB æ•°æ®ï¼‰
    const chunkSize = 100 * 1024; // æ¯å— 100KB
    const dataStr = JSON.stringify(resultData);
    const chunks = [];

    for (let i = 0; i < dataStr.length; i += chunkSize) {
      chunks.push(dataStr.substr(i, chunkSize));
    }

    wx.setStorageSync(`${STORAGE_KEY_PREFIX}${executionId}_chunks`, chunks.length);
    chunks.forEach((chunk, index) => {
      wx.setStorageSync(`${STORAGE_KEY_PREFIX}${executionId}_chunk_${index}`, chunk);
    });

    const meta = wx.getStorageSync(STORAGE_META_KEY) || {};
    meta[executionId] = {
      timestamp,
      size: dataStr.length,
      chunked: true,
      chunkCount: chunks.length
    };
    wx.setStorageSync(STORAGE_META_KEY, meta);

    console.log('[Transfer] ç»“æœå·²åˆ†å—ä¿å­˜:', { executionId, chunks: chunks.length });
    return true;

  } catch (error) {
    console.error('[Transfer] ä¿å­˜å¤±è´¥:', error);

    // å­˜å‚¨å¤±è´¥æ—¶ï¼Œå°è¯•æ¸…ç†ç©ºé—´åé‡è¯•
    if (error.errMsg && error.errMsg.includes('exceeded')) {
      clearExpiredResults();
      // é‡è¯•ä¸€æ¬¡
      return saveResult(executionId, resultData);
    }

    return false;
  }
};

/**
 * ä» Storage è¯»å–è¯Šæ–­ç»“æœ
 */
const getResult = (executionId) => {
  try {
    // å°è¯•ç›´æ¥è¯»å–
    const storageKey = `${STORAGE_KEY_PREFIX}${executionId}`;
    const stored = wx.getStorageSync(storageKey);

    if (stored && stored.data) {
      // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
      if (Date.now() - stored.timestamp > EXPIRY_TIME) {
        console.warn('[Transfer] ç»“æœå·²è¿‡æœŸï¼Œåˆ é™¤');
        removeResult(executionId);
        return null;
      }

      console.log('[Transfer] ä» Storage åŠ è½½æˆåŠŸ:', { executionId });
      return stored.data;
    }

    // å°è¯•åˆ†å—è¯»å–
    const chunkCount = wx.getStorageSync(`${storageKey}_chunks`);
    if (chunkCount) {
      const chunks = [];
      for (let i = 0; i < chunkCount; i++) {
        chunks.push(wx.getStorageSync(`${storageKey}_chunk_${i}`));
      }

      const dataStr = chunks.join('');
      const data = JSON.parse(dataStr);

      console.log('[Transfer] ä»åˆ†å—åŠ è½½æˆåŠŸ:', { executionId, chunks: chunkCount });
      return data;
    }

    console.warn('[Transfer] æœªæ‰¾åˆ°ç»“æœ:', { executionId });
    return null;

  } catch (error) {
    console.error('[Transfer] è¯»å–å¤±è´¥:', error);
    return null;
  }
};

/**
 * åˆ é™¤è¯Šæ–­ç»“æœ
 */
const removeResult = (executionId) => {
  try {
    const storageKey = `${STORAGE_KEY_PREFIX}${executionId}`;
    const chunkCount = wx.getStorageSync(`${storageKey}_chunks`);

    if (chunkCount) {
      for (let i = 0; i < chunkCount; i++) {
        wx.removeStorageSync(`${storageKey}_chunk_${i}`);
      }
      wx.removeStorageSync(`${storageKey}_chunks`);
    }

    wx.removeStorageSync(storageKey);

    // æ›´æ–°å…ƒæ•°æ®
    const meta = wx.getStorageSync(STORAGE_META_KEY) || {};
    delete meta[executionId];
    wx.setStorageSync(STORAGE_META_KEY, meta);

    console.log('[Transfer] ç»“æœå·²åˆ é™¤:', { executionId });
  } catch (error) {
    console.error('[Transfer] åˆ é™¤å¤±è´¥:', error);
  }
};

/**
 * æ¸…ç†è¿‡æœŸç»“æœ
 */
const clearExpiredResults = () => {
  try {
    const meta = wx.getStorageSync(STORAGE_META_KEY) || {};
    const now = Date.now();
    let cleared = 0;

    Object.keys(meta).forEach(executionId => {
      if (now - meta[executionId].timestamp > EXPIRY_TIME) {
        removeResult(executionId);
        cleared++;
      }
    });

    console.log('[Transfer] æ¸…ç†è¿‡æœŸç»“æœ:', { cleared });
  } catch (error) {
    console.error('[Transfer] æ¸…ç†å¤±è´¥:', error);
  }
};

/**
 * è·å–æ‰€æœ‰ä¿å­˜çš„ç»“æœå…ƒæ•°æ®
 */
const getResultMeta = () => {
  return wx.getStorageSync(STORAGE_META_KEY) || {};
};

module.exports = {
  saveResult,
  getResult,
  removeResult,
  clearExpiredResults,
  getResultMeta,
  EXPIRY_TIME
};
```

### B2.3 ä½¿ç”¨ç¤ºä¾‹

```javascript
// ==================== pages/index/index.js (ä¿å­˜ç»“æœ) ====================
const { saveResult } = require('../../services/resultTransferService');

// åœ¨ pollTestProgress ä¸­ï¼Œå½“ä»»åŠ¡å®Œæˆæ—¶
if (parsedStatus.stage === 'completed') {
  const resultsToSave = parsedStatus.detailed_results || parsedStatus.results || [];
  const competitiveAnalysisToSave = parsedStatus.competitive_analysis || {};
  const brandScoresToSave = parsedStatus.brand_scores || {};

  // ä½¿ç”¨æ–°æœåŠ¡ä¿å­˜ç»“æœ
  const fullResult = {
    results: resultsToSave,
    competitiveAnalysis: competitiveAnalysisToSave,
    brandScores: brandScoresToSave,
    targetBrand: this.data.brandName,
    executionId: executionId,
    timestamp: Date.now()
  };

  const saved = saveResult(executionId, fullResult);

  if (saved) {
    // åªä¼ é€’ executionId å’Œ brandNameï¼ˆURL å®‰å…¨ï¼‰
    wx.navigateTo({
      url: `/pages/results/results?executionId=${executionId}&brandName=${encodeURIComponent(this.data.brandName)}`
    });
  } else {
    wx.showModal({
      title: 'ä¿å­˜å¤±è´¥',
      content: 'è¯Šæ–­ç»“æœä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•',
      showCancel: false
    });
  }
}

// ==================== pages/results/results.js (è¯»å–ç»“æœ) ====================
const { getResult } = require('../../services/resultTransferService');

Page({
  onLoad: function(options) {
    const executionId = decodeURIComponent(options.executionId || '');

    if (executionId) {
      // ä» Storage åŠ è½½ç»“æœ
      const resultData = getResult(executionId);

      if (resultData) {
        console.log('âœ… ä» Storage åŠ è½½ç»“æœ:', { executionId });
        this.initializePageWithData(
          resultData.results || [],
          resultData.targetBrand || '',
          [],
          resultData.competitiveAnalysis || {},
          null, null, null
        );
      } else {
        // Storage æ— æ•°æ®ï¼Œä»åç«¯ API æ‹‰å–
        console.log('ğŸ”„ Storage æ— æ•°æ®ï¼Œä»åç«¯ API æ‹‰å–');
        this.fetchResultsFromServer(executionId, options.brandName);
      }
    }
  }
});
```

---

# è§’è‰² Cï¼šèµ„æ·±å‰ç«¯äº¤äº’å·¥ç¨‹å¸ˆè¯Šæ–­æŠ¥å‘Š

## C1. æ¸²æŸ“æ­»é”æ²»ç† - Canvas èŠ‚ç‚¹æœªæ‰¾åˆ°é—®é¢˜

### C1.1 é—®é¢˜æ ¹å› åˆ†æ

```javascript
// âŒ å½“å‰é—®é¢˜ï¼šresults.js ä¸­ Canvas æ¸²æŸ“æ—¶åºé”™è¯¯

onLoad: function(options) {
  this.initializePageWithData(...);  // æ­¥éª¤ 1: è®¾ç½®æ•°æ®
  // æ­¥éª¤ 2: ç«‹å³æ¸²æŸ“å›¾è¡¨ï¼ˆä½† DOM å¯èƒ½è¿˜æœªæ›´æ–°ï¼‰
  this.renderRadarChart();  // âŒ æŠ¥é”™ï¼šæ— æ³•æ‰¾åˆ° canvas èŠ‚ç‚¹
}

// é—®é¢˜ï¼šsetData æ˜¯å¼‚æ­¥çš„ï¼Œåœ¨ DOM æ›´æ–°å‰è°ƒç”¨ renderChart ä¼šæ‰¾ä¸åˆ°èŠ‚ç‚¹
```

### C1.2 results.wxml ä¼˜åŒ–ï¼ˆç¡®ä¿ Canvas å ä½ï¼‰

```xml
<!-- ==================== pages/results/results.wxml ==================== -->

<!-- ä¿®å¤å‰ï¼šCanvas èŠ‚ç‚¹å¯èƒ½æœªæ¸²æŸ“ -->
<!--
<canvas wx:if="{{radarChartData.length > 0}}" id="radarCanvas" type="2d"></canvas>
-->

<!-- ä¿®å¤åï¼šå§‹ç»ˆæ¸²æŸ“ Canvas å®¹å™¨ï¼Œä½¿ç”¨ hidden æ§åˆ¶æ˜¾ç¤º -->
<view class="chart-container">
  <!-- é›·è¾¾å›¾ Canvas - å§‹ç»ˆå­˜åœ¨ï¼Œä½¿ç”¨ hidden æ§åˆ¶ -->
  <canvas
    id="radarCanvas"
    type="2d"
    hidden="{{!radarChartData || radarChartData.length === 0}}"
    class="chart-canvas"
  ></canvas>

  <!-- è¯äº‘ Canvas - å§‹ç»ˆå­˜åœ¨ï¼Œä½¿ç”¨ hidden æ§åˆ¶ -->
  <canvas
    id="wordCloudCanvas"
    type="2d"
    hidden="{{!keywordCloudData || keywordCloudData.length === 0}}"
    class="chart-canvas"
  ></canvas>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{!chartsReady}}" class="chart-loading">
    <view class="loading-spinner"></view>
    <text>å›¾è¡¨åŠ è½½ä¸­...</text>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:if="{{!radarChartData || radarChartData.length === 0}}" class="chart-empty">
    <text>æš‚æ— å›¾è¡¨æ•°æ®</text>
  </view>
</view>
```

### C1.3 results.js ä¼˜åŒ–ï¼ˆæ¸²æŸ“æ—¶åºæ§åˆ¶ï¼‰

```javascript
// ==================== pages/results/results.js (ä¿®å¤ç‰ˆ) ====================
const { getResult } = require('../../services/resultTransferService');

Page({
  data: {
    // ... å…¶ä»–æ•°æ®
    chartsReady: false,  // æ–°å¢ï¼šå›¾è¡¨æ˜¯å¦å‡†å¤‡å°±ç»ª
    radarChartInstance: null,  // æ–°å¢ï¼šä¿å­˜å›¾è¡¨å®ä¾‹
    wordCloudInstance: null  // æ–°å¢ï¼šä¿å­˜å›¾è¡¨å®ä¾‹
  },

  onLoad: function(options) {
    const executionId = decodeURIComponent(options.executionId || '');

    if (executionId) {
      const resultData = getResult(executionId);

      if (resultData) {
        this.initializePageWithData(
          resultData.results || [],
          resultData.targetBrand || '',
          [],
          resultData.competitiveAnalysis || {},
          null, null, null
        );
      } else {
        this.fetchResultsFromServer(executionId, options.brandName);
      }
    }
  },

  /**
   * åˆå§‹åŒ–é¡µé¢æ•°æ®ï¼ˆä¿®å¤ç‰ˆï¼‰
   */
  initializePageWithData: function(results, targetBrand, competitorBrands, competitiveAnalysis, negativeSources, semanticDriftData, recommendationData) {
    try {
      // ... åŸæœ‰æ•°æ®å¤„ç†é€»è¾‘ ...

      this.setData({
        targetBrand: targetBrand,
        competitiveAnalysis: competitiveAnalysis,
        latestTestResults: results,
        // ... å…¶ä»–æ•°æ®
        radarChartData: radarData,
        keywordCloudData: keywordCloudResult.keywordCloudData,
        // ã€å…³é”®ä¿®å¤ã€‘è®¾ç½® chartsReady ä¸º falseï¼Œç­‰å¾…æ¸²æŸ“
        chartsReady: false
      }, () => {
        // ã€å…³é”®ä¿®å¤ã€‘ä½¿ç”¨ wx.nextTick ç¡®ä¿ DOM å®Œå…¨æ›´æ–°åå†æ¸²æŸ“
        wx.nextTick(() => {
          // å»¶è¿Ÿæ¸²æŸ“ï¼Œç¡®ä¿ Canvas èŠ‚ç‚¹å·²æŒ‚è½½
          setTimeout(() => {
            this.renderAllCharts();
          }, 100);
        });
      });

    } catch (e) {
      console.error('åˆå§‹åŒ–é¡µé¢æ•°æ®å¤±è´¥', e);
    }
  },

  /**
   * æ¸²æŸ“æ‰€æœ‰å›¾è¡¨ï¼ˆæ–°å¢ï¼‰
   */
  renderAllCharts: function() {
    console.log('[Chart] å¼€å§‹æ¸²æŸ“æ‰€æœ‰å›¾è¡¨');

    // å¹¶è¡Œæ¸²æŸ“å¤šä¸ªå›¾è¡¨
    Promise.all([
      this.renderRadarChart(),
      this.renderWordCloud()
    ]).then(() => {
      this.setData({ chartsReady: true });
      console.log('[Chart] æ‰€æœ‰å›¾è¡¨æ¸²æŸ“å®Œæˆ');
    }).catch(error => {
      console.error('[Chart] å›¾è¡¨æ¸²æŸ“å¤±è´¥:', error);
    });
  },

  /**
   * æ¸²æŸ“é›·è¾¾å›¾ï¼ˆä¿®å¤ç‰ˆï¼‰
   */
  renderRadarChart: function(retryCount = 0) {
    return new Promise((resolve, reject) => {
      try {
        const query = wx.createSelectorQuery();

        query.select('#radarCanvas')
          .fields({ node: true, size: true })
          .exec((res) => {
            // ã€å…³é”®ä¿®å¤ã€‘èŠ‚ç‚¹æœªæ‰¾åˆ°çš„é‡è¯•æœºåˆ¶
            if (!res[0] || !res[0].node) {
              console.error('[Chart] é›·è¾¾å›¾ Canvas æœªæ‰¾åˆ°');

              // æœ€å¤šé‡è¯• 3 æ¬¡
              if (retryCount < 3) {
                console.log(`[Chart] é‡è¯• ${retryCount + 1}/3`);
                setTimeout(() => {
                  this.renderRadarChart(retryCount + 1)
                    .then(resolve)
                    .catch(reject);
                }, 300);
                return;
              }

              reject(new Error('Canvas èŠ‚ç‚¹æœªæ‰¾åˆ°'));
              return;
            }

            const canvas = res[0].node;
            const ctx = canvas.getContext('2d');
            const dpr = wx.getSystemInfoSync().pixelRatio;

            // è®¾ç½® Canvas å°ºå¯¸
            canvas.width = res[0].width * dpr;
            canvas.height = res[0].height * dpr;
            ctx.scale(dpr, dpr);

            // åˆå§‹åŒ– ECharts
            const chart = echarts.init(canvas, null, {
              renderer: 'canvas',
              devicePixelRatio: dpr
            });

            // é…ç½®é¡¹
            const option = {
              radar: {
                indicator: this.data.radarChartData.map(item => ({
                  name: item.name,
                  max: item.max || 100
                })),
                radius: '65%'
              },
              series: [{
                type: 'radar',
                data: this.data.radarChartData.map(item => ({
                  value: item.value,
                  name: item.name
                }))
              }]
            };

            chart.setOption(option);

            // ä¿å­˜å®ä¾‹
            this.setData({ radarChartInstance: chart });

            console.log('[Chart] é›·è¾¾å›¾æ¸²æŸ“æˆåŠŸ');
            resolve(chart);
          });
      } catch (error) {
        console.error('[Chart] é›·è¾¾å›¾æ¸²æŸ“å¤±è´¥:', error);
        reject(error);
      }
    });
  },

  /**
   * æ¸²æŸ“è¯äº‘ï¼ˆä¿®å¤ç‰ˆï¼‰
   */
  renderWordCloud: function(retryCount = 0) {
    return new Promise((resolve, reject) => {
      try {
        const query = wx.createSelectorQuery();

        query.select('#wordCloudCanvas')
          .fields({ node: true, size: true })
          .exec((res) => {
            // ã€å…³é”®ä¿®å¤ã€‘èŠ‚ç‚¹æœªæ‰¾åˆ°çš„é‡è¯•æœºåˆ¶
            if (!res[0] || !res[0].node) {
              console.error('[Chart] è¯äº‘ Canvas æœªæ‰¾åˆ°');

              // æœ€å¤šé‡è¯• 3 æ¬¡
              if (retryCount < 3) {
                console.log(`[Chart] é‡è¯• ${retryCount + 1}/3`);
                setTimeout(() => {
                  this.renderWordCloud(retryCount + 1)
                    .then(resolve)
                    .catch(reject);
                }, 300);
                return;
              }

              reject(new Error('Canvas èŠ‚ç‚¹æœªæ‰¾åˆ°'));
              return;
            }

            const canvas = res[0].node;
            const ctx = canvas.getContext('2d');
            const dpr = wx.getSystemInfoSync().pixelRatio;

            canvas.width = res[0].width * dpr;
            canvas.height = res[0].height * dpr;
            ctx.scale(dpr, dpr);

            const chart = echarts.init(canvas, null, {
              renderer: 'canvas',
              devicePixelRatio: dpr
            });

            // è¯äº‘é…ç½®
            const option = {
              series: [{
                type: 'wordCloud',
                shape: 'circle',
                left: 'center',
                top: 'center',
                width: '70%',
                height: '80%',
                right: null,
                bottom: null,
                data: this.data.keywordCloudData.map(item => ({
                  name: item.word,
                  value: item.count,
                  textStyle: {
                    color: this.getSentimentColor(item.sentiment)
                  }
                }))
              }]
            };

            chart.setOption(option);
            this.setData({ wordCloudInstance: chart });

            console.log('[Chart] è¯äº‘æ¸²æŸ“æˆåŠŸ');
            resolve(chart);
          });
      } catch (error) {
        console.error('[Chart] è¯äº‘æ¸²æŸ“å¤±è´¥:', error);
        reject(error);
      }
    });
  },

  /**
   * è·å–æƒ…æ„Ÿé¢œè‰²
   */
  getSentimentColor: function(sentiment) {
    switch (sentiment) {
      case 'positive': return '#52c41a';
      case 'negative': return '#ff4d4f';
      default: return '#1890ff';
    }
  },

  onUnload: function() {
    // æ¸…ç†å›¾è¡¨å®ä¾‹
    if (this.data.radarChartInstance) {
      this.data.radarChartInstance.dispose();
    }
    if (this.data.wordCloudInstance) {
      this.data.wordCloudInstance.dispose();
    }
  }
});
```

---

## C2. Loading ä¸å¼‚å¸¸æ€è®¾è®¡ - å®¹é”™ UI

### C2.1 å®Œæ•´å®¹é”™ UI æ–¹æ¡ˆ

```javascript
// ==================== pages/results/results.js (å®¹é”™ UI) ====================

Page({
  data: {
    // ... åŸæœ‰æ•°æ®
    loadingState: 'loading',  // 'loading' | 'success' | 'error' | 'empty'
    errorMessage: '',
    canRetry: true
  },

  onLoad: function(options) {
    const executionId = decodeURIComponent(options.executionId || '');

    if (executionId) {
      // è®¾ç½®åŠ è½½çŠ¶æ€
      this.setData({ loadingState: 'loading' });

      const resultData = getResult(executionId);

      if (resultData && resultData.results && resultData.results.length > 0) {
        this.initializePageWithData(...);
        this.setData({ loadingState: 'success' });
      } else {
        // ä»åç«¯æ‹‰å–
        this.fetchResultsFromServer(executionId, options.brandName);
      }
    } else {
      this.setData({
        loadingState: 'empty',
        errorMessage: 'ç¼ºå°‘æ‰§è¡Œ ID'
      });
    }
  },

  /**
   * ä»åç«¯ API æ‹‰å–ç»“æœï¼ˆå¸¦å®¹é”™ UIï¼‰
   */
  fetchResultsFromServer: function(executionId, brandName, isRetry) {
    const app = getApp();
    const baseUrl = app.globalData?.apiUrl || 'http://localhost:5000';
    const accessToken = wx.getStorageSync('access_token') || '';

    wx.request({
      url: `${baseUrl}/api/test-progress?executionId=${executionId}`,
      method: 'GET',
      header: {
        'Authorization': accessToken ? 'Bearer ' + accessToken : ''
      },
      success: (res) => {
        if (res.statusCode === 403) {
          this.handleAuthError(isRetry);
          return;
        }

        if (res.statusCode === 200 && res.data && res.data.results) {
          this.initializePageWithData(...);
          this.setData({ loadingState: 'success' });
          wx.showToast({ title: 'æ•°æ®åŠ è½½æˆåŠŸ', icon: 'success' });
        } else if (res.statusCode === 404) {
          this.setData({
            loadingState: 'empty',
            errorMessage: 'æœªæ‰¾åˆ°è¯Šæ–­ç»“æœ',
            canRetry: false
          });
        } else {
          this.setData({
            loadingState: 'error',
            errorMessage: `åŠ è½½å¤±è´¥ï¼šçŠ¶æ€ç  ${res.statusCode}`,
            canRetry: true
          });
        }
      },
      fail: (err) => {
        console.error('åç«¯ API è¯·æ±‚å¤±è´¥:', err);
        this.setData({
          loadingState: 'error',
          errorMessage: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•',
          canRetry: true
        });
      }
    });
  },

  /**
   * å¤„ç†è®¤è¯é”™è¯¯
   */
  handleAuthError: function(isRetry) {
    if (!isRetry && getApp().globalData?.refreshToken) {
      getApp().globalData.refreshToken(() => {
        this.fetchResultsFromServer(executionId, brandName, true);
      }, () => {
        this.setData({
          loadingState: 'error',
          errorMessage: 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•',
          canRetry: false
        });

        setTimeout(() => {
          wx.reLaunch({ url: '/pages/login/login' });
        }, 2000);
      });
    } else {
      this.setData({
        loadingState: 'error',
        errorMessage: 'è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•',
        canRetry: false
      });
    }
  },

  /**
   * é‡è¯•æŒ‰é’®ç‚¹å‡»å¤„ç†
   */
  onRetryTap: function() {
    if (!this.data.canRetry) return;

    const executionId = this.data.executionId;
    const brandName = this.data.targetBrand;

    this.setData({ loadingState: 'loading' });
    this.fetchResultsFromServer(executionId, brandName, false);
  },

  /**
   * è¿”å›é¦–é¡µ
   */
  onGoHomeTap: function() {
    wx.reLaunch({ url: '/pages/index/index' });
  }
});
```

### C2.2 results.wxml å®¹é”™ UI æ¨¡æ¿

```xml
<!-- ==================== pages/results/results.wxml ==================== -->

<view class="results-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loadingState === 'loading'}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">æ•°æ®åŠ è½½ä¸­...</text>
  </view>

  <!-- æˆåŠŸçŠ¶æ€ -->
  <view wx:elif="{{loadingState === 'success'}}" class="content-container">
    <!-- åŸæœ‰å†…å®¹ -->
    <view class="chart-section">
      <canvas id="radarCanvas" type="2d"></canvas>
    </view>
    <!-- ... å…¶ä»–å†…å®¹ ... -->
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view wx:elif="{{loadingState === 'error'}}" class="error-container">
    <view class="error-icon">âš ï¸</view>
    <text class="error-message">{{errorMessage}}</text>
    <button wx:if="{{canRetry}}" class="retry-button" bindtap="onRetryTap">
      ç‚¹å‡»é‡è¯•
    </button>
    <button class="home-button" bindtap="onGoHomeTap">
      è¿”å›é¦–é¡µ
    </button>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:elif="{{loadingState === 'empty'}}" class="empty-container">
    <view class="empty-icon">ğŸ“­</view>
    <text class="empty-message">{{errorMessage || 'æš‚æ— æ•°æ®'}}</text>
    <button class="home-button" bindtap="onGoHomeTap">
      è¿”å›é¦–é¡µ
    </button>
  </view>
</view>
```

### C2.3 results.wxss æ ·å¼

```css
/* ==================== pages/results/results.wxss ==================== */

/* åŠ è½½çŠ¶æ€ */
.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.loading-spinner {
  width: 60rpx;
  height: 60rpx;
  border: 4rpx solid rgba(255, 255, 255, 0.3);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  margin-top: 30rpx;
  color: #fff;
  font-size: 28rpx;
}

/* é”™è¯¯çŠ¶æ€ */
.error-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  padding: 60rpx;
  background: #fff;
}

.error-icon {
  font-size: 100rpx;
  margin-bottom: 30rpx;
}

.error-message {
  font-size: 32rpx;
  color: #666;
  text-align: center;
  margin-bottom: 60rpx;
  line-height: 1.6;
}

.retry-button {
  width: 300rpx;
  height: 88rpx;
  line-height: 88rpx;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  border-radius: 44rpx;
  margin-bottom: 30rpx;
}

.home-button {
  width: 300rpx;
  height: 88rpx;
  line-height: 88rpx;
  background: #f5f5f5;
  color: #666;
  border-radius: 44rpx;
}

/* ç©ºçŠ¶æ€ */
.empty-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  background: #fff;
}

.empty-icon {
  font-size: 100rpx;
  margin-bottom: 30rpx;
}

.empty-message {
  font-size: 32rpx;
  color: #999;
  text-align: center;
  margin-bottom: 60rpx;
}

/* å›¾è¡¨å®¹å™¨ */
.chart-container {
  position: relative;
  width: 100%;
  min-height: 600rpx;
}

.chart-canvas {
  width: 100%;
  height: 600rpx;
}

.chart-loading {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.9);
}

.chart-empty {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #999;
  font-size: 28rpx;
}
```

---

# é™„å½•ï¼šå¯è§†åŒ–å›¾è¡¨

## ä¼˜åŒ–åçš„æ•°æ®ç”Ÿå‘½å‘¨æœŸæµè½¬å›¾

```mermaid
flowchart TB
    subgraph User["ç”¨æˆ·å±‚"]
        A[è¾“å…¥ brandName] --> B[é€‰æ‹© AI æ¨¡å‹]
        B --> C[ç‚¹å‡»å¯åŠ¨è¯Šæ–­]
    end

    subgraph StateMachine["çŠ¶æ€æœºåè°ƒå±‚"]
        C --> D[PageStateMachine]
        D --> E[init:start]
        D --> F[init:complete]
        D --> G[connection:complete]
        D --> H[prefs:complete]
        D --> I[draft:complete]
    end

    subgraph Storage["å­˜å‚¨å±‚"]
        J[draft_diagnostic_input]
        K[user_ai_platform_preferences]
        L[diagnostic_result_{id}]
        M[access_token / refresh_token]
    end

    subgraph API["API å±‚"]
        N[startBrandTestApi]
        O[getTaskStatusApi]
        P[fetchResultsFromServer]
    end

    subgraph Backend["åç«¯æ‰§è¡Œå±‚"]
        Q[POST /api/perform-brand-test]
        R[GET /test/status/{id}]
        S[NxM å¼•æ“å¹¶è¡Œæ‰§è¡Œ]
        T[AI é€‚é…å™¨é›†ç¾¤]
    end

    subgraph Result["ç»“æœå±‚"]
        U[Storage åˆ†å—å­˜å‚¨]
        V[ExecutionId å¯¼èˆª]
        W[results é¡µåŠ è½½]
        X[ECharts æ¸²æŸ“]
    end

    User --> StateMachine
    StateMachine --> Storage
    StateMachine --> API
    API --> Backend
    Backend --> Result
    Result --> Storage

    style StateMachine fill:#e1f5fe
    style Storage fill:#fff3e0
    style API fill:#f3e5f5
    style Backend fill:#e8f5e9
    style Result fill:#fce4ec
```

---

## é—®é¢˜æ¸…å•æ±‡æ€»

| ä¼˜å…ˆçº§ | é—®é¢˜æè¿° | å½±å“èŒƒå›´ | è§£å†³æ–¹æ¡ˆ | é¢„è®¡å·¥æ—¶ |
|-------|---------|---------|---------|---------|
| **P0** | å•æ–‡ä»¶ 2276 è¡Œï¼Œéš¾ä»¥ç»´æŠ¤ | å…¨ç³»ç»Ÿ | åˆ†æ‹†è‡³ services/ å’Œ utils/ | 8h |
| **P0** | 403 Token è¿‡æœŸå¯¼è‡´ç»“æœé¡µæ— æ³•åŠ è½½ | ç»“æœé¡µ | ä¿®å¤ request.js åˆ·æ–°é€»è¾‘ | 4h |
| **P0** | Canvas èŠ‚ç‚¹æœªæ‰¾åˆ°æŠ¥é”™ | å›¾è¡¨æ¸²æŸ“ | wx.nextTick + é‡è¯•æœºåˆ¶ | 2h |
| **P1** | onLoad æ—¶åºæ··ä¹± | é¦–é¡µ | çŠ¶æ€æœºæ¨¡å¼ | 4h |
| **P1** | URL ä¼ å‚è¶…é™ | ç»“æœå¯¼èˆª | Storage + ExecutionId | 3h |
| **P1** | Loading æ€ç¼ºå¤± | ç”¨æˆ·ä½“éªŒ | å®¹é”™ UI è®¾è®¡ | 3h |

---

## é‡æ„åç›®å½•ç»“æ„

```
PythonProject/
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ index/
â”‚   â”‚   â”œâ”€â”€ index.js          # ~400 è¡Œï¼Œä»… UI äº¤äº’
â”‚   â”‚   â”œâ”€â”€ index.wxml
â”‚   â”‚   â””â”€â”€ index.wxss
â”‚   â””â”€â”€ results/
â”‚       â”œâ”€â”€ results.js        # ~600 è¡Œï¼Œä»… UI äº¤äº’
â”‚       â”œâ”€â”€ results.wxml
â”‚       â””â”€â”€ results.wxss
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ brandTestService.js   # å“ç‰Œè¯Šæ–­ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ pollingService.js     # è½®è¯¢çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ draftService.js       # è‰ç¨¿ç®¡ç†
â”‚   â”œâ”€â”€ resultTransferService.js  # ç»“æœä¼ è¾“æœåŠ¡
â”‚   â”œâ”€â”€ pageStateMachine.js   # é¡µé¢çŠ¶æ€æœº
â”‚   â””â”€â”€ reportAggregator.js   # æŠ¥å‘Šèšåˆ (å·²æœ‰)
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ request.js            # ç»Ÿä¸€è¯·æ±‚ (ä¿®å¤ç‰ˆ)
â”‚   â”œâ”€â”€ config.js             # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ storageManager.js     # Storage å°è£…
â”‚   â”œâ”€â”€ eventBus.js           # äº‹ä»¶æ€»çº¿
â”‚   â””â”€â”€ chartRenderer.js      # å›¾è¡¨æ¸²æŸ“å·¥å…·
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ brand.js              # å“ç‰Œè¯Šæ–­ API
â”‚   â”œâ”€â”€ auth.js               # è®¤è¯ API (å·²æœ‰)
â”‚   â””â”€â”€ home.js               # é¦–é¡µ API (å·²æœ‰)
â””â”€â”€ constants/
    â”œâ”€â”€ taskStatus.js         # ä»»åŠ¡çŠ¶æ€ (å·²æœ‰)
    â”œâ”€â”€ brandTest.js          # å“ç‰Œæµ‹è¯•å¸¸é‡ (å·²æœ‰)
    â””â”€â”€ chartConfig.js        # å›¾è¡¨é…ç½®å¸¸é‡
```

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-02-22  
**æŠ¥å‘Šç‰ˆæœ¬**: v1.0  
**ä¿å¯†çº§åˆ«**: å†…éƒ¨å…¬å¼€
