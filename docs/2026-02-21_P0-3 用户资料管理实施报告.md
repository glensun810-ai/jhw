# P0-3 用户资料管理实施报告

**文档版本**: v1.0  
**创建日期**: 2026-02-21  
**实施状态**: ✅ 已完成  

---

## 执行摘要

### 问题描述

用户无法查看/编辑个人资料，导致：
- 用户无法管理个人信息
- 配置管理页面功能不完整

### 实施内容

本次实施完成了完整的用户资料管理功能，包括：
1. ✅ 后端数据库支持（update_user_profile 函数）
2. ✅ 获取资料端点 `GET /api/user/profile`
3. ✅ 更新资料端点 `PUT /api/user/profile` 和 `POST/PUT /api/user/update`
4. ✅ 前端用户资料页面
5. ✅ 前端 API 封装

### 新增 API 端点

| 端点 | 方法 | 功能 | 状态 |
|------|------|------|------|
| `/api/user/profile` | GET | 获取用户资料 | ✅ 完成 |
| `/api/user/profile` | PUT | 更新用户资料 | ✅ 完成 |
| `/api/user/update` | POST/PUT | 更新用户资料（兼容） | ✅ 完成 |

---

## 第一部分：后端实现

### 1.1 数据库层增强

**文件**: `backend_python/wechat_backend/database.py`

**新增函数**:

```python
def update_user_profile(user_id: int, data: dict) -> bool:
    """
    Update user profile information
    
    Args:
        user_id: User ID
        data: Dictionary containing fields to update
        
    Returns:
        bool: True if successful, False otherwise
    """
    # Allowed fields that can be updated
    allowed_fields = ['nickname', 'avatar_url']
    
    # Filter only allowed fields
    update_data = {k: v for k, v in data.items() 
                   if k in allowed_fields and v is not None}
    
    if not update_data:
        return False
    
    # Build dynamic UPDATE statement
    fields = ', '.join([f"{field} = ?" for field in update_data.keys()])
    values = list(update_data.values())
    values.append(user_id)
    
    query = f'''
        UPDATE users 
        SET {fields}, updated_at = CURRENT_TIMESTAMP
        WHERE id = ?
    '''
    
    cursor.execute(query, values)
    conn.commit()
    
    return cursor.rowcount > 0
```

**特性**:
- ✅ 白名单验证（只允许更新 nickname 和 avatar_url）
- ✅ 动态 SQL 构建（防止 SQL 注入）
- ✅ 自动更新 updated_at 时间戳
- ✅ 返回更新结果

---

### 1.2 获取用户资料端点

**文件**: `backend_python/wechat_backend/views.py`

```python
@wechat_bp.route('/api/user/profile', methods=['GET'])
@require_auth
@rate_limit(limit=20, window=60, per='ip')
def get_user_profile():
    """Get user profile information"""
    user_id = get_current_user_id()
    api_logger.info(f"User profile endpoint accessed by user: {user_id}")
    
    # Convert user_id to int
    try:
        user_id_int = int(user_id)
    except (ValueError, TypeError):
        return jsonify({'error': 'Invalid user ID'}), 400
    
    # Fetch user profile from database
    from wechat_backend.database import get_user_by_id
    user = get_user_by_id(user_id_int)
    
    if not user:
        return jsonify({'error': 'User not found'}), 404
    
    # Mask phone number for privacy
    phone_masked = '***'
    if user.get('phone'):
        phone = user['phone']
        if len(phone) >= 7:
            phone_masked = phone[:3] + '****' + phone[-4:]
    
    return jsonify({
        'status': 'success',
        'profile': {
            'user_id': user['id'],
            'phone': phone_masked,
            'nickname': user.get('nickname') or '未设置昵称',
            'avatar_url': user.get('avatar_url') or '',
            'created_at': user.get('created_at'),
            'updated_at': user.get('updated_at')
        }
    })
```

**安全特性**:
- ✅ 需要认证（@require_auth）
- ✅ 限流保护（20 次/分钟）
- ✅ 手机号脱敏（138****8888）
- ✅ 用户 ID 格式验证

---

### 1.3 更新用户资料端点

**文件**: `backend_python/wechat_backend/views.py`

```python
@wechat_bp.route('/api/user/profile', methods=['PUT'])
@require_auth
@rate_limit(limit=10, window=60, per='ip')
def put_user_profile():
    """Update user profile information (PUT method)"""
    return update_user_profile_data()


@wechat_bp.route('/api/user/update', methods=['POST', 'PUT'])
@require_auth
@rate_limit(limit=10, window=60, per='ip')
def update_user_profile():
    """Update user profile information"""
    return update_user_profile_data()


def update_user_profile_data():
    """Helper function to update user profile"""
    user_id = get_current_user_id()
    
    # Convert user_id to int
    try:
        user_id_int = int(user_id)
    except (ValueError, TypeError):
        return jsonify({'error': 'Invalid user ID'}), 400
    
    data = request.get_json()
    if not data:
        return jsonify({'error': 'No JSON data provided'}), 400
    
    # Update user profile in database
    from wechat_backend.database import update_user_profile
    success = update_user_profile(user_id_int, data)
    
    if success:
        # Fetch updated profile
        user = get_user_by_id(user_id_int)
        
        return jsonify({
            'status': 'success',
            'message': 'Profile updated successfully',
            'profile': {
                'user_id': user['id'],
                'nickname': user.get('nickname'),
                'avatar_url': user.get('avatar_url')
            }
        })
    else:
        return jsonify({'error': 'Failed to update profile'}), 500
```

**特性**:
- ✅ 支持 PUT 和 POST 方法（兼容不同客户端）
- ✅ 限流保护（10 次/分钟）
- ✅ 返回更新后的资料
- ✅ 错误处理完善

---

## 第二部分：前端实现

### 2.1 API 封装

**文件**: `api/user.js`

```javascript
/**
 * 获取用户资料
 */
const getUserProfile = () => {
  return get(API_ENDPOINTS.USER.PROFILE);
};

/**
 * 更新用户资料
 * @param {Object} profileData - 用户资料数据
 * @param {string} profileData.nickname - 昵称
 * @param {string} profileData.avatar_url - 头像 URL
 */
const updateUserProfile = (profileData) => {
  return put(API_ENDPOINTS.USER.UPDATE, profileData);
};

module.exports = {
  getUserProfile,
  updateUserProfile
};
```

---

### 2.2 用户资料页面

**文件**: `pages/user-profile/`

#### WXML (user-profile.wxml)

```xml
<view class="container">
  <!-- 头部 -->
  <view class="header">
    <view class="avatar">
      <image class="avatar-img" src="{{avatarUrl}}"></image>
      <view class="avatar-edit" bindtap="chooseAvatar">
        <text class="iconfont icon-edit"></text>
      </view>
    </view>
    <view class="nickname-section">
      <input 
        class="nickname-input" 
        value="{{nickname}}" 
        placeholder="点击设置昵称"
        bindinput="onNicknameInput"
      />
    </view>
  </view>

  <!-- 用户信息列表 -->
  <view class="info-section">
    <view class="info-item">
      <text class="label">用户 ID</text>
      <text class="value">{{userId}}</text>
    </view>
    <view class="info-item">
      <text class="label">手机号</text>
      <text class="value">{{phone}}</text>
    </view>
    <view class="info-item">
      <text class="label">注册时间</text>
      <text class="value">{{createdAt}}</text>
    </view>
  </view>

  <!-- 保存按钮 -->
  <button class="save-btn" bindtap="saveProfile">保存</button>
  
  <!-- 退出登录 -->
  <button class="logout-btn" bindtap="logout">退出登录</button>
</view>
```

#### JavaScript (user-profile.js)

```javascript
const { getUserProfile, updateUserProfile } = require('../../api/user');

Page({
  data: {
    userId: '',
    phone: '',
    nickname: '',
    avatarUrl: '',
    createdAt: '',
    saving: false,
    hasChanges: false
  },

  onLoad: function() {
    this.loadUserProfile();
  },

  /**
   * 加载用户资料
   */
  async loadUserProfile() {
    try {
      wx.showLoading({ title: '加载中...' });
      const res = await getUserProfile();
      
      if (res && res.status === 'success' && res.profile) {
        const profile = res.profile;
        this.setData({
          userId: profile.user_id,
          phone: profile.phone,
          nickname: profile.nickname || '',
          avatarUrl: profile.avatar_url || '',
          createdAt: this.formatDate(profile.created_at)
        });
      }
      wx.hideLoading();
    } catch (error) {
      wx.showToast({ title: '加载失败', icon: 'none' });
    }
  },

  /**
   * 保存资料
   */
  async saveProfile() {
    if (!this.data.hasChanges) {
      wx.showToast({ title: '暂无修改', icon: 'none' });
      return;
    }

    try {
      this.setData({ saving: true });
      
      const updateData = {
        nickname: this.data.nickname.trim()
      };
      
      const res = await updateUserProfile(updateData);
      
      this.setData({ saving: false });
      
      if (res && res.status === 'success') {
        wx.showToast({ title: '保存成功', icon: 'success' });
        this.setData({ hasChanges: false });
      }
    } catch (error) {
      wx.showToast({ title: '保存失败', icon: 'none' });
    }
  },

  /**
   * 选择头像
   */
  chooseAvatar: function() {
    wx.chooseImage({
      count: 1,
      success: (res) => {
        this.setData({
          avatarUrl: res.tempFilePaths[0],
          hasChanges: true
        });
      }
    });
  },

  /**
   * 退出登录
   */
  logout: function() {
    wx.showModal({
      title: '确认退出',
      content: '确定要退出登录吗？',
      success: (res) => {
        if (res.confirm) {
          authLogout();
          wx.reLaunch({ url: '/pages/login/login' });
        }
      }
    });
  }
});
```

---

## 第三部分：测试验证

### 3.1 测试脚本

**文件**: `test_user_profile.py`

**测试用例**:

| 测试项 | 描述 | 预期结果 | 状态 |
|--------|------|----------|------|
| 获取用户资料 | GET /api/user/profile | 返回 200 + profile | ✅ |
| 更新用户资料 | PUT /api/user/profile | 返回 200 + success | ✅ |
| 更新端点兼容 | POST /api/user/update | 返回 200 + success | ✅ |
| 未授权访问 | 无 Token 访问 | 返回 401 | ✅ |
| 输入验证 | 空昵称 | 返回 400/500 | ✅ |

---

### 3.2 测试步骤

**运行测试**:
```bash
# 1. 启动后端服务
cd backend_python
python app.py

# 2. 运行测试脚本
python test_user_profile.py
```

**预期输出**:
```
============================================================
品牌 AI 诊断系统 - 用户资料管理测试
============================================================

注册测试用户...
✅ 用户注册成功：13812345678

==================================================
测试 1: 获取用户资料
==================================================
状态码：200
响应：{
  "status": "success",
  "profile": {
    "user_id": 1,
    "phone": "138****5678",
    "nickname": "未设置昵称",
    "avatar_url": "",
    "created_at": "2026-02-21T12:00:00"
  }
}
✅ 获取用户资料成功

==================================================
测试 2: 更新用户资料
==================================================
状态码：200
响应：{
  "status": "success",
  "message": "Profile updated successfully",
  "profile": {
    "user_id": 1,
    "nickname": "测试用户",
    "avatar_url": ""
  }
}
✅ 更新用户资料成功

✅ 所有用户资料管理测试通过！
```

---

## 第四部分：安全考虑

### 4.1 访问控制

**后端**:
- ✅ 所有端点需要认证（@require_auth）
- ✅ 限流保护（GET: 20 次/分，UPDATE: 10 次/分）
- ✅ 用户 ID 验证

**前端**:
- ✅ Token 自动附加
- ✅ 401 错误自动处理

---

### 4.2 数据验证

**白名单机制**:
```python
allowed_fields = ['nickname', 'avatar_url']
update_data = {k: v for k, v in data.items() 
               if k in allowed_fields and v is not None}
```

**防止 SQL 注入**:
```python
# 使用参数化查询
query = f'UPDATE users SET {fields} WHERE id = ?'
cursor.execute(query, values)
```

---

### 4.3 隐私保护

**手机号脱敏**:
```python
phone_masked = phone[:3] + '****' + phone[-4:]
# 13812345678 → 138****5678
```

---

## 第五部分：API 使用示例

### 5.1 获取用户资料

```bash
curl -X GET http://127.0.0.1:5000/api/user/profile \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

**响应**:
```json
{
  "status": "success",
  "profile": {
    "user_id": 1,
    "phone": "138****5678",
    "nickname": "测试用户",
    "avatar_url": "https://example.com/avatar.jpg",
    "created_at": "2026-02-21T12:00:00",
    "updated_at": "2026-02-21T14:30:00"
  }
}
```

---

### 5.2 更新用户资料

```bash
curl -X PUT http://127.0.0.1:5000/api/user/profile \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json" \
  -d '{"nickname": "新昵称"}'
```

**响应**:
```json
{
  "status": "success",
  "message": "Profile updated successfully",
  "profile": {
    "user_id": 1,
    "nickname": "新昵称",
    "avatar_url": ""
  }
}
```

---

## 第六部分：故障排查

### 6.1 常见问题

**问题 1**: 获取资料失败 - User not found

```
错误：User not found (404)
原因：
  1. 用户 ID 不存在
  2. Token 中的 user_id 格式错误
解决：检查 Token 是否有效
```

**问题 2**: 更新失败 - Invalid user ID

```
错误：Invalid user ID (400)
原因：user_id 无法转换为整数
解决：检查 Token 生成逻辑
```

**问题 3**: 更新失败 - Failed to update profile

```
错误：Failed to update profile (500)
原因：
  1. 数据库连接问题
  2. 没有可更新的字段
解决：检查后端日志
```

---

### 6.2 日志查看

**后端日志**:
```bash
tail -f logs/app.log | grep -E "user.*profile|update"
```

**关键日志**:
```
INFO - User profile endpoint accessed by user: 1
INFO - User profile retrieved: 1
INFO - Update user profile endpoint accessed by user: 1
INFO - Updated 1 row(s) for user 1
INFO - User profile updated: 1
```

---

## 第七部分：后续改进计划

### P1 改进项

1. **头像上传**
   - 实现头像上传到服务器
   - 支持图片压缩
   - CDN 存储

2. **更多字段**
   - 邮箱
   - 性别
   - 生日
   - 地区

### P2 改进项

3. **密码修改**
   - 修改密码功能
   - 密码强度验证
   - 历史密码检查

4. **账号安全**
   - 绑定手机号
   - 绑定邮箱
   - 两步验证

---

**文档结束**
