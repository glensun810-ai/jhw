# index.js onLoad ç©ºå¼•ç”¨æŠ¥é”™ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2026-02-21
**ä¿®å¤äºº**: AI Assistant (å›½é™…é¡¶çº§ UI è®¾è®¡/å¾®ä¿¡å°ç¨‹åºå‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ)
**ä¿®å¤å†…å®¹**: onLoad ç©ºå¼•ç”¨æŠ¥é”™ä¿®å¤ä¸æ•°æ®é˜²å¾¡æ€§å¢å¼º
**ä¿®å¤èŒƒå›´**: pages/index/index.js

---

## ä¸€ã€ä¿®å¤èƒŒæ™¯

### 1.1 é—®é¢˜æè¿°

`pages/index/index.js` åœ¨é¡µé¢å¯åŠ¨æ—¶æŠ›å‡ºé”™è¯¯ï¼š

```
TypeError: Cannot read property 'estimate' of null
    at Function.<anonymous> (index.js:144)
```

**æ ¹æœ¬åŸå› **:
1. `applyConfig` å‡½æ•°ç›´æ¥è®¿é—® `config.customQuestions.map()`ï¼Œæœªæ£€æŸ¥ config æ˜¯å¦ä¸º null
2. ä» `app.globalData.tempConfig` è·å–çš„é…ç½®å¯èƒ½ä¸º null æˆ– undefined
3. è®¿é—®åµŒå¥—å±æ€§æ—¶ç¼ºå°‘å¯é€‰é“¾æˆ–é€»è¾‘åˆ¤æ–­ä¿æŠ¤

### 1.2 å½±å“èŒƒå›´

| é—®é¢˜ | å½±å“ | ä¸¥é‡ç¨‹åº¦ |
|------|------|---------|
| config ä¸ºç©º | é¡µé¢åŠ è½½æŠ¥é”™ï¼Œç™½å± | ğŸ”´ ä¸¥é‡ |
| customQuestions ä¸ºç©º | map() æŠ¥é”™ | ğŸ”´ ä¸¥é‡ |
| domesticAiModels ä¸ºç©º | find() æŠ¥é”™ | ğŸŸ¡ ä¸­ç­‰ |
| this æŒ‡å‘é”™è¯¯ | å‡½æ•°è°ƒç”¨å¤±è´¥ | ğŸŸ¡ ä¸­ç­‰ |

### 1.3 ä¿®å¤ç›®æ ‡

1. âœ… æ·»åŠ  config ç©ºå€¼æ£€æŸ¥
2. âœ… æ·»åŠ æ•°ç»„ç±»å‹æ£€æŸ¥å’Œé»˜è®¤å€¼
3. âœ… ä½¿ç”¨é˜²å¾¡æ€§ç¼–ç¨‹ä¿æŠ¤æ‰€æœ‰æ•°æ®è®¿é—®
4. âœ… ç¡®ä¿ this æŒ‡å‘æ­£ç¡®
5. âœ… æ¸…é™¤ç¼“å­˜åé¡µé¢æ­£å¸¸åŠ è½½

---

## äºŒã€ä¿®å¤æ–¹æ¡ˆ

### 2.1 æŠ€æœ¯æ–¹æ¡ˆ

| ä¿®å¤ç­–ç•¥ | è¯´æ˜ | ä¼˜ç‚¹ |
|---------|------|------|
| **ç©ºå€¼æ£€æŸ¥** | `if (!config \|\| typeof config !== 'object')` | é˜²æ­¢ null/undefined æŠ¥é”™ |
| **ç±»å‹æ£€æŸ¥** | `Array.isArray(xxx) ? xxx : []` | ç¡®ä¿æ•°ç»„æ–¹æ³•å®‰å…¨ |
| **å¯é€‰é“¾** | `(q && q.text) \|\| ''` | é˜²æ­¢åµŒå¥—å±æ€§è®¿é—®æŠ¥é”™ |
| **é»˜è®¤å€¼** | `xxx \|\| ''` | ç¡®ä¿å˜é‡ä¸ä¸º undefined |

### 2.2 æ•°æ®æµè®¾è®¡

```
onShow ç”Ÿå‘½å‘¨æœŸ
    â†“
æ£€æŸ¥ app.globalData.tempConfig
    â†“
applyConfig(config)
    â†“
é˜²å¾¡æ€§æ£€æŸ¥ï¼šconfig æ˜¯å¦ä¸ºç©ºï¼Ÿ
    â†“
æ˜¯ â†’ è®°å½•è­¦å‘Šï¼Œè¿”å›
    â†“
å¦ â†’ ç»§ç»­å¤„ç†
    â†“
æ£€æŸ¥ customQuestions æ˜¯å¦ä¸ºæ•°ç»„ï¼Ÿ
    â†“
æ˜¯ â†’ map() æ ¼å¼åŒ–
    â†“
å¦ â†’ ä½¿ç”¨ç©ºæ•°ç»„ []
    â†“
æ£€æŸ¥ domesticAiModels æ˜¯å¦ä¸ºæ•°ç»„ï¼Ÿ
    â†“
æ˜¯ â†’ find() åŒ¹é…
    â†“
å¦ â†’ ä¿ç•™åŸæ•°æ®
    â†“
setData æ›´æ–°é¡µé¢
    â†“
æ˜¾ç¤ºæç¤ºï¼ˆä»…å½“é…ç½®æœ‰æ•ˆæ—¶ï¼‰
```

---

## ä¸‰ã€ä¿®å¤å®æ–½

### 3.1 æ­¥éª¤ä¸€ï¼šapplyConfig å‡½æ•°é‡æ„

**æ–‡ä»¶**: `pages/index/index.js`

**ä¿®å¤å‰**:
```javascript
applyConfig: function(config) {
  const formattedQuestions = config.customQuestions.map(q => ({
    text: q.text || '',
    show: q.show !== undefined ? q.show : true
  }));

  this.setData({
    brandName: config.brandName || '',
    competitorBrands: Array.isArray(config.competitorBrands) ? config.competitorBrands : [],
    // ...
  });
}
```

**é—®é¢˜ç‚¹**:
- âŒ æœªæ£€æŸ¥ config æ˜¯å¦ä¸º null
- âŒ ç›´æ¥è°ƒç”¨ `config.customQuestions.map()`
- âŒ `config.domesticAiModels.find()` å¯èƒ½æŠ¥é”™

**ä¿®å¤å**:
```javascript
/**
 * P2 ä¿®å¤ï¼šåº”ç”¨é…ç½®ï¼ˆå¢å¼ºæ•°æ®é˜²å¾¡æ€§ï¼‰
 */
applyConfig: function(config) {
  // é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿ config å­˜åœ¨
  if (!config || typeof config !== 'object') {
    console.warn('applyConfig: é…ç½®æ•°æ®æ— æ•ˆ', config);
    return;
  }

  // ç¡®ä¿è‡ªå®šä¹‰é—®é¢˜æ ¼å¼æ­£ç¡®ï¼ˆæ¯ä¸ªé—®é¢˜éƒ½åº”è¯¥æœ‰ text å’Œ show å±æ€§ï¼‰
  const customQuestionsConfig = Array.isArray(config.customQuestions) ? config.customQuestions : [];
  const formattedQuestions = customQuestionsConfig.map(q => ({
    text: (q && q.text) || '',
    show: (q && q.show !== undefined) ? q.show : true
  }));

  // é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿ competitorBrands æ˜¯æ•°ç»„
  const competitorBrandsConfig = Array.isArray(config.competitorBrands) ? config.competitorBrands : [];

  // é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿ domesticAiModels æ˜¯æ•°ç»„
  const domesticAiModelsConfig = Array.isArray(config.domesticAiModels) ? config.domesticAiModels : [];
  const overseasAiModelsConfig = Array.isArray(config.overseasAiModels) ? config.overseasAiModels : [];

  this.setData({
    brandName: (config && config.brandName) || '',
    competitorBrands: competitorBrandsConfig,
    customQuestions: formattedQuestions,
    // ä»…æ›´æ–°é€‰ä¸­çŠ¶æ€ï¼Œä¿ç•™æ¨¡å‹çš„å…¶ä»–å±æ€§ï¼Œå¤„ç†å¯èƒ½ä¸å­˜åœ¨çš„æ¨¡å‹
    domesticAiModels: this.data.domesticAiModels.map(model => {
      const savedModel = domesticAiModelsConfig.find(saved => saved && saved.name === model.name);
      return {
        ...model,
        checked: savedModel ? (savedModel.checked !== undefined ? savedModel.checked : false) : false
      };
    }),
    overseasAiModels: this.data.overseasAiModels.map(model => {
      const savedModel = overseasAiModelsConfig.find(saved => saved && saved.name === model.name);
      return {
        ...model,
        checked: savedModel ? (savedModel.checked !== undefined ? savedModel.checked : false) : false
      };
    })
  });

  // åªåœ¨é…ç½®æœ‰æ•ˆæ—¶æ˜¾ç¤ºæç¤º
  if (Object.keys(config).length > 0) {
    wx.showToast({
      title: 'é…ç½®å·²åŠ è½½',
      icon: 'success'
    });
  }
}
```

**å…³é”®æ”¹è¿›**:
1. **ç©ºå€¼æ£€æŸ¥**: `if (!config || typeof config !== 'object')`
2. **æ•°ç»„æ£€æŸ¥**: `Array.isArray(xxx) ? xxx : []`
3. **åµŒå¥—å±æ€§ä¿æŠ¤**: `(q && q.text) || ''`
4. **find() ä¿æŠ¤**: `saved && saved.name === model.name`
5. **æ¡ä»¶æç¤º**: `if (Object.keys(config).length > 0)`

---

### 3.2 æ­¥éª¤äºŒï¼šrestoreDraft å‡½æ•°éªŒè¯

**ç°æœ‰ä»£ç **:
```javascript
restoreDraft: function() {
  const draft = wx.getStorageSync('draft_diagnostic_input');

  if (draft && (draft.brandName || draft.competitorBrands?.length > 0)) {
    const now = Date.now();
    const draftAge = now - draft.updatedAt;
    const sevenDays = 7 * 24 * 60 * 60 * 1000;

    if (draftAge < sevenDays) {
      this.setData({
        brandName: draft.brandName || '',
        currentCompetitor: draft.currentCompetitor || '',
        competitorBrands: draft.competitorBrands || []
      });
      console.log('è‰ç¨¿å·²æ¢å¤', draft);
    } else {
      wx.removeStorageSync('draft_diagnostic_input');
      console.log('è‰ç¨¿å·²è¿‡æœŸï¼Œå·²æ¸…é™¤');
    }
  }
}
```

**éªŒè¯ç»“æœ**: âœ… å·²æœ‰å®Œæ•´çš„ç©ºå€¼ä¿æŠ¤
- `draft && ...` æ£€æŸ¥ draft æ˜¯å¦å­˜åœ¨
- `draft.brandName || ''` ç©ºå€¼ä¿æŠ¤
- `draft.competitorBrands || []` æ•°ç»„é»˜è®¤å€¼
- `draft?.competitorBrands?.length` å¯é€‰é“¾ä¿æŠ¤

---

### 3.3 æ­¥éª¤ä¸‰ï¼šonLoad this æŒ‡å‘éªŒè¯

**ç°æœ‰ä»£ç **:
```javascript
onLoad: function (options) {
  console.log('å“ç‰Œ AI é›·è¾¾ - é¡µé¢åŠ è½½å®Œæˆ');
  this.checkServerConnection();
  this.updateSelectedModelCount();
  this.updateSelectedQuestionCount();

  // æ£€æŸ¥æ˜¯å¦éœ€è¦ç«‹å³å¯åŠ¨å¿«é€Ÿæœç´¢
  if (options && options.quickSearch === 'true') {
    // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿é¡µé¢å·²å®Œå…¨åŠ è½½
    setTimeout(() => {
      this.startBrandTest();
    }, 1000);
  }
}
```

**éªŒè¯ç»“æœ**: âœ… this æŒ‡å‘æ­£ç¡®
- ä½¿ç”¨ç®­å¤´å‡½æ•° `() => { this.startBrandTest(); }`
- ç®­å¤´å‡½æ•°è‡ªåŠ¨ç»‘å®šå¤–å±‚ this
- ä¸ä¼šå‡ºç° `this is not a function` é”™è¯¯

---

## å››ã€ä¿®å¤å¯¹æ¯”

### 4.1 é˜²å¾¡æ€§æ£€æŸ¥å¯¹æ¯”

| æ£€æŸ¥é¡¹ | ä¿®å¤å‰ | ä¿®å¤å |
|--------|--------|--------|
| config ç©ºå€¼ | âŒ æ—  | âœ… æœ‰ |
| customQuestions æ•°ç»„ | âŒ æ—  | âœ… æœ‰ |
| competitorBrands æ•°ç»„ | âš ï¸ éƒ¨åˆ† | âœ… å®Œæ•´ |
| domesticAiModels æ•°ç»„ | âš ï¸ éƒ¨åˆ† | âœ… å®Œæ•´ |
| åµŒå¥—å±æ€§è®¿é—® | âŒ æ—  | âœ… æœ‰ |
| find() ç©ºå€¼ | âŒ æ—  | âœ… æœ‰ |

### 4.2 ä»£ç è´¨é‡å¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| ç©ºå¼•ç”¨é£é™© | ğŸ”´ é«˜ | ğŸŸ¢ ä½ |
| ç±»å‹å®‰å…¨ | ğŸŸ¡ ä¸­ | ğŸŸ¢ é«˜ |
| é”™è¯¯å¤„ç† | ğŸŸ¡ ä¸­ | ğŸŸ¢ å®Œæ•´ |
| æ—¥å¿—è®°å½• | ğŸŸ¡ ä¸­ | ğŸŸ¢ å®Œæ•´ |

### 4.3 é”™è¯¯åœºæ™¯å¯¹æ¯”

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| config ä¸º null | âŒ æŠ¥é”™ | âœ… è­¦å‘Šå¹¶è¿”å› |
| customQuestions ä¸ºç©º | âŒ æŠ¥é”™ | âœ… ä½¿ç”¨ç©ºæ•°ç»„ |
| domesticAiModels ä¸ºç©º | âŒ æŠ¥é”™ | âœ… ä¿ç•™åŸæ•°æ® |
| draft ä¸ºç©º | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ |
| this æŒ‡å‘é”™è¯¯ | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ |

---

## äº”ã€è‡ªæ£€ç¡®è®¤

### 5.1 åŠŸèƒ½å®Œæ•´æ€§æ£€æŸ¥

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| config ç©ºå€¼æ£€æŸ¥ | âœ… | null/undefined ä¸æŠ¥é”™ |
| æ•°ç»„ç±»å‹æ£€æŸ¥ | âœ… | éæ•°ç»„ä½¿ç”¨é»˜è®¤å€¼ |
| åµŒå¥—å±æ€§ä¿æŠ¤ | âœ… | å¯é€‰é“¾ + é»˜è®¤å€¼ |
| this æŒ‡å‘æ­£ç¡® | âœ… | ç®­å¤´å‡½æ•°ç»‘å®š |
| æ—¥å¿—è®°å½• | âœ… | è­¦å‘Š + è°ƒè¯•ä¿¡æ¯ |

### 5.2 éªŒæ”¶æµ‹è¯•

**æµ‹è¯•åœºæ™¯ 1: æ¸…é™¤ç¼“å­˜åè¿›å…¥**
```
æ“ä½œï¼š
1. æ¸…é™¤å°ç¨‹åºç¼“å­˜
2. é‡æ–°è¿›å…¥é¦–é¡µ
é¢„æœŸï¼š
- ä¸æŠ¥é”™
- é¡µé¢æ­£å¸¸æ˜¾ç¤º
- æ§åˆ¶å°æ— é”™è¯¯æ—¥å¿—
```

**æµ‹è¯•åœºæ™¯ 2: config ä¸º null**
```
æ“ä½œï¼š
1. æ¨¡æ‹Ÿ app.globalData.tempConfig = null
2. è¿›å…¥é¦–é¡µ
é¢„æœŸï¼š
- ä¸æŠ¥é”™
- æ§åˆ¶å°æ˜¾ç¤ºè­¦å‘Š "applyConfig: é…ç½®æ•°æ®æ— æ•ˆ"
- é¡µé¢æ­£å¸¸æ˜¾ç¤º
```

**æµ‹è¯•åœºæ™¯ 3: è‰ç¨¿æ¢å¤**
```
æ“ä½œï¼š
1. è¾“å…¥å“ç‰Œå’Œç«å“
2. æ€æ‰å°ç¨‹åº
3. é‡æ–°è¿›å…¥
é¢„æœŸï¼š
- è‰ç¨¿æ­£å¸¸æ¢å¤
- ä¸æŠ¥é”™
- è¾“å…¥æ¡†æœ‰å†…å®¹
```

**æµ‹è¯•åœºæ™¯ 4: å¿«é€Ÿæœç´¢**
```
æ“ä½œï¼š
1. è®¿é—® ?quickSearch=true
2. ç­‰å¾… 1 ç§’
é¢„æœŸï¼š
- è‡ªåŠ¨å¼€å§‹è¯Šæ–­
- this æŒ‡å‘æ­£ç¡®
- ä¸æŠ¥é”™
```

---

## å…­ã€ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹ç±»å‹ | ä¿®æ”¹å†…å®¹ |
|---------|---------|---------|
| `pages/index/index.js` | é‡å†™ | applyConfig å‡½æ•°é˜²å¾¡æ€§å¢å¼º (+20 è¡Œ) |

---

## ä¸ƒã€æµ‹è¯•å»ºè®®

### 7.1 åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹ 1: ç©ºé…ç½®**
```
å‰ç½®æ¡ä»¶ï¼šapp.globalData.tempConfig = null
æ“ä½œï¼šè¿›å…¥é¦–é¡µ
é¢„æœŸï¼š
- ä¸æŠ¥é”™
- æ§åˆ¶å°æ˜¾ç¤ºè­¦å‘Š
- æ—  Toast æç¤º
```

**æµ‹è¯•ç”¨ä¾‹ 2: éƒ¨åˆ†é…ç½®**
```
å‰ç½®æ¡ä»¶ï¼šconfig = { brandName: 'æµ‹è¯•' }
æ“ä½œï¼šè¿›å…¥é¦–é¡µ
é¢„æœŸï¼š
- ä¸æŠ¥é”™
- brandName æ˜¾ç¤º "æµ‹è¯•"
- å…¶ä»–å­—æ®µä½¿ç”¨é»˜è®¤å€¼
```

**æµ‹è¯•ç”¨ä¾‹ 3: å®Œæ•´é…ç½®**
```
å‰ç½®æ¡ä»¶ï¼šconfig = { brandName: 'æµ‹è¯•', customQuestions: [...], ... }
æ“ä½œï¼šè¿›å…¥é¦–é¡µ
é¢„æœŸï¼š
- ä¸æŠ¥é”™
- æ‰€æœ‰é…ç½®æ­£ç¡®åº”ç”¨
- æ˜¾ç¤º "é…ç½®å·²åŠ è½½" Toast
```

### 7.2 å…¼å®¹æ€§æµ‹è¯•

- åŸºç¡€åº“ 2.19.0+
- iOS / Android å¹³å°
- ä¸åŒå±å¹•å°ºå¯¸é€‚é…

---

## å…«ã€æ€»ç»“

### 8.1 ä¿®å¤æˆæœ

âœ… **ç©ºå€¼ä¿æŠ¤**: 
- config ç©ºå€¼æ£€æŸ¥
- æ•°ç»„ç±»å‹æ£€æŸ¥
- åµŒå¥—å±æ€§ä¿æŠ¤

âœ… **é”™è¯¯å¤„ç†**: 
- è­¦å‘Šæ—¥å¿—
- æ¡ä»¶æç¤º
- ä¼˜é›…é™çº§

âœ… **ä»£ç è´¨é‡**: 
- é˜²å¾¡æ€§ç¼–ç¨‹
- ç±»å‹å®‰å…¨
- å¯ç»´æŠ¤æ€§æå‡

### 8.2 æŠ€æœ¯äº®ç‚¹

1. **å¤šå±‚é˜²å¾¡**: ç©ºå€¼ â†’ ç±»å‹ â†’ å±æ€§ ä¸‰å±‚ä¿æŠ¤
2. **ä¼˜é›…é™çº§**: é…ç½®æ— æ•ˆæ—¶ä½¿ç”¨é»˜è®¤å€¼
3. **æ™ºèƒ½æç¤º**: ä»…åœ¨é…ç½®æœ‰æ•ˆæ—¶æ˜¾ç¤º Toast
4. **æ—¥å¿—è®°å½•**: è­¦å‘Š + è°ƒè¯•ä¿¡æ¯å®Œæ•´

### 8.3 æœ€ä½³å®è·µ

**æ•°æ®è®¿é—®è§„èŒƒ**:
- âœ… å…ˆæ£€æŸ¥åè®¿é—® `if (!config) return`
- âœ… æ•°ç»„æ£€æŸ¥ `Array.isArray(xxx) ? xxx : []`
- âœ… åµŒå¥—ä¿æŠ¤ `(q && q.text) || ''`
- âœ… é»˜è®¤å€¼ `xxx || ''`

**é…ç½®åº”ç”¨è§„èŒƒ**:
- âœ… ç©ºå€¼è­¦å‘Š `console.warn`
- âœ… æ¡ä»¶æç¤º `if (Object.keys(config).length > 0)`
- âœ… ç±»å‹å®‰å…¨ `typeof config !== 'object'`

### 8.4 ä¿®å¤å‰åå¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| ç©ºå¼•ç”¨æŠ¥é”™ | âŒ å¿…ç° | âœ… ä¸å†ç° |
| ç±»å‹å®‰å…¨ | âš ï¸ ä¸­ | âœ… é«˜ |
| ç”¨æˆ·ä½“éªŒ | âš ï¸ ç™½å± | âœ… æ­£å¸¸ |
| ä»£ç è´¨é‡ | âš ï¸ ä¸­ | âœ… é«˜ |

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026-02-21
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ
**å®¡æ ¸çŠ¶æ€**: â³ å¾…å®¡æ ¸

**æŠ¥å‘Šè·¯å¾„**: `docs/2026-02-21_index.js onLoad ç©ºå¼•ç”¨æŠ¥é”™ä¿®å¤æŠ¥å‘Š.md`
