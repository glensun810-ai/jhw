# 诊断流程卡点深度分析报告

**报告编号**: P20260228-003
**分析日期**: 2026-02-28 13:40
**分析依据**: 最新运行日志、代码审查、用户反馈
**诊断 ID**: `aa5ad118-771f-47af-8c1f-8697b9f21fac`

---

## 一、执行摘要

### 1.1 核心问题

用户选择**通义千问**模型进行诊断，但系统因**豆包 API 限流**问题导致诊断失败，前端卡住无报告输出。

### 1.2 问题总览

| 阶段 | 状态 | 问题数 | 影响等级 |
|------|------|--------|----------|
| 启动预热 | ⚠️ 部分失败 | 3 | P1 |
| AI 调用执行 | ❌ 完全失败 | 2 | P0 |
| 数据持久化 | ⚠️ 部分失败 | 2 | P1 |
| 前端状态同步 | ❌ 失败 | 2 | P0 |
| 报告生成 | ❌ 失败 | 1 | P0 |

---

## 二、完整流程梳理

### 2.1 用户操作流程

```
用户操作                    后端处理                      状态
─────────────────────────────────────────────────────────────
1. 输入品牌、问题           接收请求                      ✅
   品牌：无指定             POST /api/perform-brand-test
   问题：3000 元拍照好看
   模型：通义千问

2. 点击"开始诊断"          创建诊断记录                  ✅
                           execution_id: aa5ad118...
                           status: initializing

3. 等待诊断完成            执行 NxM 引擎                 ❌
                           AI 调用失败
                           status: failed

4. 前端轮询状态            返回失败状态                  ⚠️
                           GET /test/status
                           progress: 100%, stage: failed

5. 点击查看报告            报告验证失败                  ❌
                           GET /api/report/{id}
                           errors: 缺少必填字段

6. 点击历史记录            加载失败                      ❌
                           报告数据不完整
```

---

## 三、关键卡点分析

### 🔴 卡点 1：启动时豆包健康检查失败（P1）

**现象**:
```log
2026-02-28 13:33:58,065 - ERROR - Doubao health check failed: 429
SetLimitExceeded: Your account has reached the set inference limit 
for the [doubao-seed-1-8] model
```

**原因**:
- 豆包 `doubao-seed-1-8-251228` 模型配额用尽（429 错误）
- 健康检查在启动时执行，触发限流错误
- 虽然已配置多模型优先级，但健康检查仍使用第一个模型

**影响**:
- 启动日志显示大量 ERROR
- 但最终降级到备用模型 `ep-20260212000000-gd5tq`，**不影响主流程**

**状态**: ⚠️ **已修复但日志仍有 ERROR**（需优化健康检查逻辑）

---

### 🔴 卡点 2：缓存预热内存缓存导入失败（P1）

**现象**:
```log
2026-02-28 13:34:05,187 - ERROR - [CacheWarmup] 内存缓存失败：
cannot import name 'memory_cache' from 'wechat_backend.cache.api_cache'
```

**原因**:
```python
# cache_warmup_tasks.py:437
from wechat_backend.cache.api_cache import memory_cache  # ❌ 错误
```

`api_cache.py` 中只有 `MemoryCache` 类，没有 `memory_cache` 实例。

**影响**:
- 缓存预热无法写入内存缓存
- 降级策略失效
- **不影响主流程，但降低性能**

**修复方案**:
```python
# 修复 1: 创建全局实例
memory_cache = MemoryCache()

# 或修复 2: 动态创建
from wechat_backend.cache.api_cache import MemoryCache
cache = MemoryCache()
cache.set(key, value, ttl)
```

---

### 🔴 卡点 3：AI 调用失败 - 文心平台未配置 API Key（P0）

**现象**:
```log
2026-02-28 13:00:16,471 - ERROR - [MultiModel] 模型 wenxin 异常：
No API key provided or configured for platform: wenxin
```

**原因**:
- 多模型冗余调用配置中，备用模型包含 `wenxin`
- 但 `.env` 中未配置 `WENXIN_API_KEY`
- 导致备用模型调用失败

**配置状态**:
| 平台 | API Key 配置 | 状态 |
|------|-------------|------|
| doubao | ✅ 已配置 | 可用（但优先级 4 的模型配额用尽） |
| qwen | ✅ 已配置 | 可用 |
| deepseek | ✅ 已配置 | 可用 |
| wenxin | ❌ 未配置 | 不可用 |

**影响**:
- 多模型冗余策略部分失效
- 减少了一个备用选择

---

### 🔴 卡点 4：AI 响应解析失败 - AIResponse.status 属性（P0）**已修复但未生效**

**现象**:
```log
2026-02-28 13:00:16,472 - ERROR - [NxM] AI 调用失败：qwen, 问题 1: 
'AIResponse' object has no attribute 'status'
```

**原因**:
- `AIResponse` 类使用 `success` 属性（bool）
- 代码错误地使用 `ai_result.status == "success"`
- 导致属性访问错误

**修复状态**: ✅ **代码已修复，但服务可能未重启**

**修复文件**:
- `nxm_execution_engine.py` (2 处)
- `nxm_concurrent_engine.py` (1 处)
- `diagnosis_retry_api.py` (1 处)

---

### 🔴 卡点 5：诊断执行完全失败（P0）

**现象**:
```log
2026-02-28 13:00:16,474 - ERROR - [NxM] 执行完全失败：
aa5ad118-771f-47af-8c1f-8697b9f21fac, 无有效结果

2026-02-28 13:00:16,474 - ERROR - NxM execution failed: 
所有 AI 调用均失败，未获取任何有效结果
```

**完整调用链**:
```
1. NxM 执行引擎启动
   └─ execution_id: aa5ad118-771f-47af-8c1f-8697b9f21fac
   └─ 总任务数：1（1 个问题 × 1 个模型）

2. 多模型冗余调用
   ├─ 主模型：qwen ✅
   ├─ 备用模型：['doubao', 'deepseek', 'wenxin']
   │
   └─ 调用过程:
      ├─ qwen: ❌ AIResponse.status 属性错误
      ├─ doubao: ⚠️ 优先级 4 模型配额用尽（429）
      ├─ deepseek: ❓ 未看到日志（可能未执行）
      └─ wenxin: ❌ API Key 未配置

3. 结果验证
   └─ verification: 0/1 任务完成
   └─ 判定：完全失败
```

**根因**:
1. **主模型 qwen 调用因代码 Bug 失败**（AIResponse.status）
2. **备用模型 doubao 配额用尽**（优先级 4 的模型）
3. **备用模型 wenxin 未配置 API Key**

---

### 🔴 卡点 6：状态管理器数据库更新失败（P1）**已修复但未生效**

**现象**:
```log
2026-02-28 13:00:16,484 - ERROR - [StateManager] 数据库更新失败：
aa5ad118-771f-47af-8c1f-8697b9f21fac, 错误：
save_diagnosis_report() got an unexpected keyword argument 'error_message'
```

**原因**:
- `state_manager.py` 调用 `save_diagnosis_report()` 时传入 `error_message` 参数
- 但该函数不接受此参数

**影响**:
- 失败状态无法写入数据库
- 前端可能无法获取最新状态

**修复状态**: ✅ **代码已修复，但服务可能未重启**

---

### 🔴 卡点 7：报告验证失败 - 缺少必填字段（P0）

**现象**:
```log
2026-02-28 13:35:52,497 - WARNING - 报告验证失败：
aa5ad118-771f-47af-8c1f-8697b9f21fac, errors=[
  '缺少必填字段：execution_id',
  '缺少必填字段：user_id',
  '缺少必填字段：brand_name',
  '缺少必填字段：created_at'
]

2026-02-28 13:35:52,497 - INFO - 获取完整报告：
execution_id=aa5ad118-771f-47af-8c1f-8697b9f21fac, results=0
```

**原因**:
```python
# diagnosis_report_service.py:209
full_report = {
    'report': report,      # ❌ 可能为 None 或空字典
    'results': results,    # ❌ 空列表（因为 AI 调用失败）
    'analysis': analysis,  # ❌ 可能为空
    'meta': {...}
}
```

**验证逻辑**:
```python
# validation_service.py
required_fields = ['execution_id', 'user_id', 'brand_name', 'created_at']
for field in required_fields:
    if field not in report:  # ❌ 字段缺失
        errors.append(f'缺少必填字段：{field}')
```

**根因**:
- 诊断执行失败，未创建完整的报告记录
- `diagnosis_reports` 表中的记录缺少核心字段

---

### 🔴 卡点 8：前端轮询状态无响应（P0）

**现象**:
- 用户反馈："启动诊断后，后台完成了，前端还是卡着的"
- 日志中**没有** `GET /test/status` 的轮询记录

**可能原因**:

1. **前端轮询未启动**
   - WebSocket 连接失败后未降级到轮询
   - 轮询管理器初始化失败

2. **轮询请求未到达后端**
   - 前端 JavaScript 错误
   - 网络请求被拦截

3. **响应格式不正确**
   - 状态 API 返回数据格式与前端期望不一致
   - 前端解析失败

**检查点**:
```javascript
// miniprogram/pages/report-v2/report-v2.js
// 需要检查：
// 1. WebSocket 连接状态
// 2. 轮询管理器初始化
// 3. 错误处理逻辑
```

---

## 四、为什么选择通义千问却因为豆包限流失败？

### 4.1 用户配置

```
用户选择模型：通义千问 (qwen-max)
```

### 4.2 实际执行流程

```python
# NxM 执行引擎
selected_models = ['qwen']  # 用户选择

# 多模型冗余调用（multi_model_executor.py）
primary_model = 'qwen'
fallback_models = ['doubao', 'deepseek', 'wenxin']  # 默认配置

# 执行逻辑
1. 调用主模型 qwen ❌ 失败（AIResponse.status Bug）
2. 自动尝试备用模型 doubao ❌ 失败（429 配额用尽）
3. 自动尝试备用模型 deepseek ❓ 未知
4. 自动尝试备用模型 wenxin ❌ 失败（API Key 未配置）

# 结果：所有模型调用失败
```

### 4.3 根本原因

**问题不在于豆包限流**，而在于：

1. **主模型 qwen 调用因代码 Bug 失败**（AIResponse.status）
2. **故障转移机制触发**，尝试备用模型
3. **备用模型 doubao 配额用尽**（429 错误）
4. **其他备用模型也不可用**
5. **最终导致完全失败**

**豆包限流只是"雪上加霜"，真正的问题是主模型调用失败。**

---

## 五、各模块状态评估

### 5.1 正常工作的模块

| 模块 | 状态 | 说明 |
|------|------|------|
| 请求接收 | ✅ | POST /api/perform-brand-test 正常 |
| 诊断记录创建 | ✅ | diagnosis_reports 表正常写入 |
| 任务状态更新 | ✅ | task_statuses 表正常写入 |
| 内存状态管理 | ✅ | execution_store 正常更新 |
| 失败状态同步 | ✅ | 失败记录正常保存 |

### 5.2 异常工作的模块

| 模块 | 状态 | 问题 | 根因 |
|------|------|------|------|
| AI 适配器 | ❌ | AIResponse 属性错误 | 代码 Bug |
| 多模型冗余 | ⚠️ | 备用模型不可用 | 配置缺失 |
| 缓存预热 | ⚠️ | 内存缓存导入失败 | 导入错误 |
| 状态管理 DB | ⚠️ | 参数错误 | 代码 Bug |
| 报告生成 | ❌ | 字段缺失 | 执行失败 |
| 前端状态同步 | ❌ | 无轮询记录 | 前端/网络问题 |

---

## 六、修复优先级

### 6.1 立即修复（P0）

| 问题 | 修复方案 | 预计时间 |
|------|---------|---------|
| AIResponse.status Bug | 重启服务使修复生效 | 5 分钟 |
| save_diagnosis_report 参数 | 重启服务使修复生效 | 5 分钟 |
| 前端轮询无响应 | 检查前端日志，修复 WebSocket 降级 | 30 分钟 |

### 6.2 短期修复（P1）

| 问题 | 修复方案 | 预计时间 |
|------|---------|---------|
| memory_cache 导入错误 | 修复导入或创建全局实例 | 10 分钟 |
| wenxin API Key 未配置 | 配置 API Key 或移除备用模型 | 5 分钟 |
| 豆包优先级 4 模型限流 | 联系服务商或移除该模型 | - |

### 6.3 优化建议（P2）

| 问题 | 建议 |
|------|------|
| 健康检查日志噪音 | 降级为 WARNING 或 DEBUG |
| 报告验证过于严格 | 允许部分字段为空 |
| 多模型配置集中管理 | 避免硬编码备用模型列表 |

---

## 七、验证步骤

### 7.1 重启服务

```bash
cd backend_python
# 停止当前服务
# 重新启动
python main.py
```

### 7.2 验证修复

```bash
# 1. 检查启动日志（应无 memory_cache 导入错误）
tail -f logs/app.log | grep "CacheWarmup"

# 2. 发起诊断测试
curl -X POST http://localhost:5001/api/perform-brand-test \
  -H "Content-Type: application/json" \
  -d '{
    "brand_name": "测试品牌",
    "questions": ["3000 元拍照好看的手机品牌推荐"],
    "models": ["qwen"]
  }'

# 3. 轮询状态
curl http://localhost:5001/test/status/{execution_id}

# 4. 获取报告
curl http://localhost:5001/api/report/{execution_id}
```

### 7.3 预期结果

```
✅ AI 调用成功（qwen）
✅ 数据持久化正常
✅ 状态更新正常
✅ 报告生成成功
✅ 前端正常显示
```

---

## 八、总结

### 8.1 核心问题

1. **代码 Bug 未生效** - 已修复的代码因服务未重启而未生效
2. **配置不完整** - wenxin API Key 缺失
3. **前端状态同步问题** - 轮询机制可能未正常工作

### 8.2 豆包限流真相

- 豆包限流**不是主因**，只是备用模型之一
- 真正问题是**主模型 qwen 调用因代码 Bug 失败**
- 故障转移后，备用模型接连失败，导致完全失败

### 8.3 行动建议

1. **立即重启服务** - 使已修复的代码生效
2. **检查前端日志** - 确认轮询机制是否正常
3. **完善配置** - 配置 wenxin API Key 或移除备用模型
4. **优化健康检查** - 减少日志噪音

---

**报告编制**: AI Assistant
**审核**: 待定
**日期**: 2026-02-28 13:40
**版本**: v1.0
