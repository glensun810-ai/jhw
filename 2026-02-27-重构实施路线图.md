# å“ç‰Œè¯Šæ–­ç³»ç»Ÿé‡æ„å®æ–½è·¯çº¿å›¾

**åŸºäº**: 2026-02-27-é‡æ„åŸºçº¿  
**ç‰ˆæœ¬**: 1.0.0  
**åˆ¶å®šæ—¥æœŸ**: 2026-02-27  
**é¦–å¸­æ¶æ„å¸ˆ**: ç³»ç»Ÿæ¶æ„ç»„  

---

## æ‰§è¡Œæ‘˜è¦

æœ¬å®æ–½è·¯çº¿å›¾åŸºäº"é‡æ„åŸºçº¿"æŠ¥å‘Šçš„æ·±åº¦åˆ†æï¼Œé‡‡ç”¨**æ¸è¿›å¼é‡æ„ç­–ç•¥**ï¼Œåœ¨**4 ä¸ªé˜¶æ®µã€8 å‘¨æ—¶é—´**å†…å®Œæˆç³»ç»Ÿé‡æ„ã€‚æ ¸å¿ƒåŸåˆ™æ˜¯**ç”¨æˆ·ç¬¬ä¸€ã€å®‰å…¨ç¬¬ä¸€ã€ä¸šåŠ¡å¯¼å‘**ï¼Œç¡®ä¿æ¯ä¸ªé˜¶æ®µéƒ½å¯ç‹¬ç«‹äº¤ä»˜ã€å¯éªŒè¯ã€æœ‰ä¸šåŠ¡ä»·å€¼ã€‚

### æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰çŠ¶æ€ | é˜¶æ®µä¸€ç›®æ ‡ | é˜¶æ®µäºŒç›®æ ‡ | é˜¶æ®µä¸‰ç›®æ ‡ | é˜¶æ®µå››ç›®æ ‡ |
|------|---------|-----------|-----------|-----------|-----------|
| è¯Šæ–­å¡æ­»ç‡ | >60% | <5% | <2% | <1% | 0% |
| ç©ºæŠ¥å‘Šç‡ | >80% | <30% | <5% | <2% | 0% |
| ç”¨æˆ·æ»¡æ„åº¦ | <20% | >40% | >60% | >80% | >90% |
| ç³»ç»Ÿå¯ç”¨æ€§ | <50% | >90% | >95% | >99% | >99.5% |

### æ—¶é—´è§„åˆ’

```
Week 1-2: é˜¶æ®µä¸€ï¼ˆåŸºç¡€èƒ½åŠ›åŠ å›ºï¼‰
Week 3-5: é˜¶æ®µäºŒï¼ˆæ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½å®ç°ï¼‰
Week 6-7: é˜¶æ®µä¸‰ï¼ˆä½“éªŒä¸å¯é æ€§ä¼˜åŒ–ï¼‰
Week 8:   é˜¶æ®µå››ï¼ˆå†å²æ•°æ®ä¿®å¤ä¸æ”¶å°¾ï¼‰
```

---

## 1. æ€»ä½“ç­–ç•¥ä¸åŸåˆ™

### 1.1 é‡æ„å“²å­¦

#### 1.1.1 ç»æ€è€…æ¨¡å¼ (Strangler Fig Pattern)

**æ ¸å¿ƒæ€æƒ³**: ä¸ç›´æ¥æ›¿æ¢ç°æœ‰ç³»ç»Ÿï¼Œè€Œæ˜¯åœ¨å…¶å‘¨å›´é€æ­¥æ„å»ºæ–°åŠŸèƒ½ï¼Œæœ€ç»ˆ"ç»æ€"æ—§ç³»ç»Ÿã€‚

**å®æ–½ç­–ç•¥**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç°æœ‰ç³»ç»Ÿ (Legacy)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ è¯Šæ–­ API    â”‚  â”‚ çŠ¶æ€ç®¡ç†    â”‚  â”‚ æŠ¥å‘Šç”Ÿæˆ    â”‚       â”‚
â”‚  â”‚ (é—®é¢˜å¤š)    â”‚  â”‚ (å¡æ­»)      â”‚  â”‚ (ç©ºæ•°æ®)    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ é˜¶æ®µä¸€ï¼šåŒ…è£¹ç°æœ‰åŠŸèƒ½ï¼Œæ·»åŠ ä¿æŠ¤å±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ–°åŠŸèƒ½å±‚ (v2)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  çŠ¶æ€ä¿æŠ¤å™¨ (è¶…æ—¶/é‡è¯•/æ­»ä¿¡)                      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                    ç°æœ‰ç³»ç»Ÿ (Legacy)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ é˜¶æ®µäºŒï¼šé€æ­¥æ›¿æ¢æ ¸å¿ƒåŠŸèƒ½
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ–°åŠŸèƒ½å±‚ (v2)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ è¯Šæ–­ API v2 â”‚  â”‚ çŠ¶æ€ç®¡ç† v2 â”‚  â”‚ æŠ¥å‘Šç”Ÿæˆ v2 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                    ç°æœ‰ç³»ç»Ÿ (Legacy)                      â”‚
â”‚              (ä»…ä¿ç•™æœªè¿ç§»åŠŸèƒ½ä½œä¸ºåå¤‡)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ é˜¶æ®µä¸‰/å››ï¼šå®Œå…¨æ›¿æ¢ï¼Œç§»é™¤æ—§ç³»ç»Ÿ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ–°ç³»ç»Ÿ (v2) - ç”Ÿäº§å°±ç»ª                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ è¯Šæ–­ API v2 â”‚  â”‚ çŠ¶æ€ç®¡ç† v2 â”‚  â”‚ æŠ¥å‘Šç”Ÿæˆ v2 â”‚       â”‚
â”‚  â”‚ + ç›‘æ§å‘Šè­¦  â”‚  â”‚ + å®æ—¶æ¨é€  â”‚  â”‚ + ç»Ÿè®¡åˆ†æ  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…·ä½“å®æ–½**:

1. **ä¸ä¿®æ”¹æ—§ä»£ç **: ç°æœ‰ `diagnosis_views.py` (3056 è¡Œ) ä¿æŒä¸åŠ¨
2. **æ–°å»º v2 æ¨¡å—**: åˆ›å»º `wechat_backend/v2/` ç›®å½•ï¼Œå…¨æ–°å®ç°
3. **æµé‡è·¯ç”±**: é€šè¿‡ç‰¹æ€§å¼€å…³æ§åˆ¶æµé‡èµ°å‘ (æ—§/æ–°)
4. **é€æ­¥è¿ç§»**: æ¯ä¸ªåŠŸèƒ½ç‚¹ç‹¬ç«‹è¿ç§»ï¼ŒéªŒè¯åå†è¿ç§»ä¸‹ä¸€ä¸ª

#### 1.1.2 ç‰¹æ€§å¼€å…³ (Feature Flags)

**å¼€å…³è®¾è®¡**:

```python
# ç‰¹æ€§å¼€å…³é…ç½®
FEATURE_FLAGS = {
    # è¯Šæ–­ v2 åŠŸèƒ½å¼€å…³
    'diagnosis_v2_enabled': False,           # æ€»å¼€å…³
    'diagnosis_v2_state_manager': False,     # æ–°çŠ¶æ€ç®¡ç†å™¨
    'diagnosis_v2_storage': False,           # æ–°å­˜å‚¨å±‚
    'diagnosis_v2_statistics': False,        # ç»Ÿè®¡åˆ†ææ¨¡å—
    'diagnosis_v2_realtime_push': False,     # å®æ—¶æ¨é€
    
    # ç°åº¦æ§åˆ¶
    'diagnosis_v2_gray_users': [],           # ç°åº¦ç”¨æˆ·åˆ—è¡¨ (OpenID)
    'diagnosis_v2_gray_percentage': 0,       # ç°åº¦ç™¾åˆ†æ¯” (0-100)
    
    # é™çº§å¼€å…³
    'diagnosis_v2_fallback_to_v1': True,     # v2 å¤±è´¥æ—¶é™çº§åˆ° v1
}

# å¼€å…³ä½¿ç”¨ç¤ºä¾‹
def should_use_v2(user_id: str) -> bool:
    """åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä½¿ç”¨ v2 ç‰ˆæœ¬"""
    if not FEATURE_FLAGS['diagnosis_v2_enabled']:
        return False
    
    # ç°åº¦ç”¨æˆ·ä¼˜å…ˆ
    if user_id in FEATURE_FLAGS['diagnosis_v2_gray_users']:
        return True
    
    # æŒ‰ç™¾åˆ†æ¯”ç°åº¦
    if random.randint(0, 99) < FEATURE_FLAGS['diagnosis_v2_gray_percentage']:
        return True
    
    return False
```

**å¼€å…³ç®¡ç†å·¥å…·**:

```python
# ç‰¹æ€§å¼€å…³ç®¡ç† API
@wechat_bp.route('/api/admin/feature-flags', methods=['GET', 'POST'])
@admin_required
def manage_feature_flags():
    """ç®¡ç†ç‰¹æ€§å¼€å…³"""
    if request.method == 'POST':
        data = request.get_json()
        # æ›´æ–°å¼€å…³é…ç½®
        update_feature_flags(data)
        return jsonify({'status': 'success'})
    else:
        return jsonify(FEATURE_FLAGS)
```

#### 1.1.3 å¹¶è¡Œè¿è¡Œ (Parallel Run)

**ç­–ç•¥**: æ–°æ—§ç³»ç»ŸåŒæ—¶è¿è¡Œï¼Œå¯¹æ¯”ç»“æœï¼Œç¡®ä¿ä¸€è‡´æ€§ã€‚

```python
class ParallelExecutionStrategy:
    """å¹¶è¡Œæ‰§è¡Œç­–ç•¥"""
    
    def execute_diagnosis(self, request_data: Dict) -> Dict:
        """å¹¶è¡Œæ‰§è¡Œæ–°æ—§è¯Šæ–­é€»è¾‘"""
        
        # 1. åŒæ—¶æ‰§è¡Œæ–°æ—§ç‰ˆæœ¬
        with ThreadPoolExecutor(max_workers=2) as executor:
            future_v1 = executor.submit(self.execute_v1, request_data)
            future_v2 = executor.submit(self.execute_v2, request_data)
            
            # 2. ç­‰å¾…ä¸¤ä¸ªç»“æœ
            try:
                result_v1 = future_v1.result(timeout=600)
            except Exception as e:
                result_v1 = {'error': str(e), 'version': 'v1'}
            
            try:
                result_v2 = future_v2.result(timeout=600)
            except Exception as e:
                result_v2 = {'error': str(e), 'version': 'v2'}
        
        # 3. å¯¹æ¯”ç»“æœï¼ˆç”¨äºéªŒè¯ï¼‰
        if not result_v1.get('error') and not result_v2.get('error'):
            comparison = self.compare_results(result_v1, result_v2)
            if not comparison['is_consistent']:
                logger.warning(f"ç»“æœä¸ä¸€è‡´ï¼š{comparison['differences']}")
        
        # 4. è¿”å› v2 ç»“æœï¼ˆå¦‚æœå¯ç”¨ï¼‰ï¼Œå¦åˆ™é™çº§åˆ° v1
        if not result_v2.get('error'):
            return result_v2
        elif FEATURE_FLAGS['diagnosis_v2_fallback_to_v1']:
            return result_v1
        else:
            return result_v2
```

### 1.2 ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

#### 1.2.1 Git åˆ†æ”¯æ¨¡å‹

```mermaid
gitGraph:
    commit id: "v1.0.0" tag: "v1.0.0"
    branch feature/refactor-v2
    checkout feature/refactor-v2
    commit id: "é˜¶æ®µä¸€å®Œæˆ" tag: "v2.0.0-phase1"
    commit id: "é˜¶æ®µäºŒå®Œæˆ" tag: "v2.0.0-phase2"
    commit id: "é˜¶æ®µä¸‰å®Œæˆ" tag: "v2.0.0-phase3"
    commit id: "é˜¶æ®µå››å®Œæˆ" tag: "v2.0.0"
    checkout main
    merge feature/refactor-v2
    branch hotfix/emergency-fix
    checkout hotfix/emergency-fix
    commit id: "ç´§æ€¥ä¿®å¤"
    checkout main
    merge hotfix/emergency-fix
```

**åˆ†æ”¯è§„åˆ™**:

| åˆ†æ”¯ | å‘½åè§„åˆ™ | ç”¨é€” | ä¿æŠ¤çº§åˆ« |
|------|---------|------|---------|
| **ä¸»åˆ†æ”¯** | `main` | ç”Ÿäº§ç¯å¢ƒä»£ç ï¼Œéšæ—¶å¯éƒ¨ç½² | ä¸¥æ ¼ä¿æŠ¤ï¼Œéœ€ 2 äºº Review |
| **å¼€å‘åˆ†æ”¯** | `develop` | æ—¥å¸¸å¼€å‘é›†æˆåˆ†æ”¯ | ä¿æŠ¤ï¼Œéœ€ 1 äºº Review |
| **ç‰¹æ€§åˆ†æ”¯** | `feature/é˜¶æ®µ X-åŠŸèƒ½å` | å•ä¸ªåŠŸèƒ½å¼€å‘ | å¼€å‘è€…è‡ªè¡Œç®¡ç† |
| **å‘å¸ƒåˆ†æ”¯** | `release/v2.0.0-phaseX` | å‘å¸ƒå‡†å¤‡ã€æµ‹è¯• | ä¿æŠ¤ï¼Œå†»ç»“æ–°åŠŸèƒ½ |
| **çƒ­ä¿®å¤åˆ†æ”¯** | `hotfix/é—®é¢˜æè¿°` | ç”Ÿäº§ç´§æ€¥ä¿®å¤ | ä¸¥æ ¼ä¿æŠ¤ï¼Œå¿«é€Ÿé€šé“ |

**ç‰ˆæœ¬å‘½åè§„èŒƒ**:

```
ä¸»ç‰ˆæœ¬ã€‚æ¬¡ç‰ˆæœ¬ã€‚ä¿®è®¢ç‰ˆæœ¬ - é˜¶æ®µæ ‡è¯†

ç¤ºä¾‹:
- v1.0.0: å½“å‰ç”Ÿäº§ç‰ˆæœ¬ï¼ˆé‡æ„å‰ï¼‰
- v2.0.0-phase1: é‡æ„é˜¶æ®µä¸€ç‰ˆæœ¬
- v2.0.0-phase2: é‡æ„é˜¶æ®µäºŒç‰ˆæœ¬
- v2.0.0: é‡æ„å®Œæˆç‰ˆæœ¬
- v2.0.1: é‡æ„å®Œæˆåçš„ç¬¬ä¸€ä¸ªè¡¥ä¸ç‰ˆæœ¬
```

#### 1.2.2 å‘å¸ƒæµç¨‹

```
1. åŠŸèƒ½å¼€å‘å®Œæˆ (feature åˆ†æ”¯)
         â†“
2. åˆ›å»ºå‘å¸ƒåˆ†æ”¯ (release/v2.0.0-phaseX)
         â†“
3. é›†æˆæµ‹è¯• (è‡ªåŠ¨åŒ– + äººå·¥)
         â†“
4. é¢„å‘å¸ƒç¯å¢ƒéªŒè¯ (Staging)
         â†“
5. ç°åº¦å‘å¸ƒ (1% -> 10% -> 50% -> 100%)
         â†“
6. åˆå¹¶åˆ° mainï¼Œæ‰“æ ‡ç­¾
         â†“
7. éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ
```

### 1.3 å›æ»šæœºåˆ¶

#### 1.3.1 æ•°æ®åº“å…¼å®¹æ€§è®¾è®¡

**åŸåˆ™**: æ•°æ®åº“å˜æ›´å¿…é¡»**å‘åå…¼å®¹**ï¼Œç¡®ä¿æ—§ä»£ç èƒ½è¯»å–æ–°æ•°æ®ç»“æ„ã€‚

**ç­–ç•¥ 1: å¢é‡æ·»åŠ å­—æ®µ**

```sql
-- âœ… æ­£ç¡®åšæ³•ï¼šæ·»åŠ æ–°å­—æ®µï¼Œä¿ç•™æ—§å­—æ®µ
ALTER TABLE diagnosis_reports ADD COLUMN should_stop_polling BOOLEAN DEFAULT 0;
ALTER TABLE diagnosis_reports ADD COLUMN data_schema_version TEXT DEFAULT '1.0';

-- âŒ é”™è¯¯åšæ³•ï¼šåˆ é™¤æˆ–ä¿®æ”¹ç°æœ‰å­—æ®µ
-- ALTER TABLE diagnosis_reports DROP COLUMN old_column;  -- ç¦æ­¢ï¼
-- ALTER TABLE diagnosis_reports MODIFY COLUMN status TEXT;  -- ç¦æ­¢ï¼
```

**ç­–ç•¥ 2: åŒå†™è¿ç§»**

```python
class DataMigration:
    """æ•°æ®è¿ç§»ï¼ˆåŒå†™æ¨¡å¼ï¼‰"""
    
    def migrate_report_schema(self, execution_id: str):
        """æŠ¥å‘Š Schema è¿ç§»"""
        
        # é˜¶æ®µ 1: åŒæ—¶å†™å…¥æ–°æ—§æ ¼å¼
        old_format = self.build_old_format()
        new_format = self.build_new_format()
        
        # å†™å…¥æ–°è¡¨
        self.db.execute('INSERT INTO diagnosis_reports_v2 ...', new_format)
        
        # åŒæ—¶å†™å…¥æ—§è¡¨ï¼ˆä¿æŒå…¼å®¹ï¼‰
        self.db.execute('INSERT INTO diagnosis_reports ...', old_format)
        
        # é˜¶æ®µ 2: éªŒè¯æ–°æ ¼å¼ç¨³å®šåï¼Œåœæ­¢å†™å…¥æ—§è¡¨
        # é˜¶æ®µ 3: è¯»å–åˆ‡æ¢åˆ°æ–°è¡¨
        
        # é˜¶æ®µ 4: åˆ é™¤æ—§è¡¨ï¼ˆç¡®è®¤æ— éœ€å›æ»šåï¼‰
```

**ç­–ç•¥ 3: ç‰ˆæœ¬åŒ–è¡¨ç»“æ„**

```sql
-- æ–°æ—§è¡¨å…±å­˜
CREATE TABLE diagnosis_reports_v1 (...);  -- æ—§è¡¨
CREATE TABLE diagnosis_reports_v2 (...);  -- æ–°è¡¨

-- é€šè¿‡è§†å›¾ç»Ÿä¸€è®¿é—®
CREATE VIEW diagnosis_reports_current AS
    SELECT * FROM diagnosis_reports_v2
    UNION ALL
    SELECT * FROM diagnosis_reports_v1 WHERE execution_id NOT IN (SELECT execution_id FROM diagnosis_reports_v2);
```

#### 1.3.2 API ç‰ˆæœ¬å…¼å®¹

**URL ç‰ˆæœ¬åŒ–**:

```python
# æ—§ APIï¼ˆä¿ç•™ï¼‰
@wechat_bp.route('/api/perform-brand-test', methods=['POST'])
def perform_brand_test_v1():
    """v1 API - ä¿ç•™ç”¨äºå›æ»š"""
    pass

# æ–° APIï¼ˆv2ï¼‰
@wechat_bp.route('/api/v2/diagnostic/tasks', methods=['POST'])
def create_diagnostic_task_v2():
    """v2 API - æ–°å®ç°"""
    pass

# API è·¯ç”±å±‚å†³å®šä½¿ç”¨å“ªä¸ªç‰ˆæœ¬
@wechat_bp.route('/api/diagnostic/tasks', methods=['POST'])
def create_diagnostic_task():
    """ç»Ÿä¸€å…¥å£ï¼Œæ ¹æ®ç‰¹æ€§å¼€å…³è·¯ç”±"""
    if should_use_v2(get_user_id()):
        return create_diagnostic_task_v2()
    else:
        return perform_brand_test_v1()
```

**å“åº”å…¼å®¹å±‚**:

```python
class ResponseCompatibilityLayer:
    """å“åº”å…¼å®¹å±‚"""
    
    def adapt_v2_to_v1(self, v2_response: Dict) -> Dict:
        """å°† v2 å“åº”è½¬æ¢ä¸º v1 æ ¼å¼ï¼ˆå…¼å®¹æ—§å‰ç«¯ï¼‰"""
        return {
            'status': 'success',
            'execution_id': v2_response['execution_id'],
            'task_id': v2_response['execution_id'],  # å­—æ®µæ˜ å°„
            'estimated_duration': '30s',
            # ... å…¶ä»– v1 å­—æ®µ
        }
    
    def adapt_v1_to_v2(self, v1_response: Dict) -> Dict:
        """å°† v1 å“åº”è½¬æ¢ä¸º v2 æ ¼å¼ï¼ˆå…¼å®¹æ–°å‰ç«¯ï¼‰"""
        return {
            'execution_id': v1_response['execution_id'],
            'report_id': v1_response.get('report_id'),
            'status': 'success',
            # ... å…¶ä»– v2 å­—æ®µ
        }
```

#### 1.3.3 å‰ç«¯ç°åº¦å‘å¸ƒ

**å°ç¨‹åºç°åº¦ç­–ç•¥**:

```javascript
// å‰ç«¯ç‰ˆæœ¬æ£€æµ‹
const APP_VERSION = '2.0.0';

// ç°åº¦ç”¨æˆ·æ ‡è¯†
const isGrayUser = wx.getStorageSync('is_gray_user') || false;

// åŠŸèƒ½å¼€å…³
const featureFlags = {
  useNewDiagnosis: isGrayUser || APP_VERSION >= '2.0.0',
  useRealtimePush: isGrayUser || APP_VERSION >= '2.0.0-phase3',
};

// API è°ƒç”¨é€‚é…
function callDiagnosisAPI(data) {
  if (featureFlags.useNewDiagnosis) {
    return request.post('/api/v2/diagnostic/tasks', data);
  } else {
    return request.post('/api/perform-brand-test', data);
  }
}
```

**ç°åº¦å‘å¸ƒæµç¨‹**:

```
1. å†…éƒ¨æµ‹è¯• (å¼€å‘å›¢é˜Ÿ + æµ‹è¯•å›¢é˜Ÿ)
         â†“
2. ç§å­ç”¨æˆ· (5-10 ä¸ªå‹å¥½ç”¨æˆ·)
         â†“
3. å°èŒƒå›´ç°åº¦ (1% ç”¨æˆ·)
         â†“
4. ä¸­èŒƒå›´ç°åº¦ (10% ç”¨æˆ·)
         â†“
5. å¤§èŒƒå›´ç°åº¦ (50% ç”¨æˆ·)
         â†“
6. å…¨é‡å‘å¸ƒ (100% ç”¨æˆ·)
```

**å¿«é€Ÿå›æ»šè„šæœ¬**:

```bash
#!/bin/bash
# rollback.sh - å¿«é€Ÿå›æ»šè„šæœ¬

echo "ğŸš¨ å¼€å§‹å›æ»šåˆ° v1.0.0..."

# 1. åˆ‡æ¢ç‰¹æ€§å¼€å…³åˆ° v1
curl -X POST http://localhost:5000/api/admin/feature-flags \
  -H "Content-Type: application/json" \
  -d '{"diagnosis_v2_enabled": false, "diagnosis_v2_fallback_to_v1": true}'

echo "âœ… ç‰¹æ€§å¼€å…³å·²åˆ‡æ¢"

# 2. é‡å¯åº”ç”¨ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰
systemctl restart wechat-backend

echo "âœ… åº”ç”¨å·²é‡å¯"

# 3. éªŒè¯å›æ»š
sleep 5
curl http://localhost:5000/api/health

echo "âœ… å›æ»šå®Œæˆï¼Œè¯·éªŒè¯ç³»ç»ŸçŠ¶æ€"
```

#### 1.3.4 å›æ»šå†³ç­–çŸ©é˜µ

| é—®é¢˜ä¸¥é‡ç¨‹åº¦ | å½±å“èŒƒå›´ | å†³ç­–äºº | å“åº”æ—¶é—´ | å›æ»šç­–ç•¥ |
|-------------|---------|--------|---------|---------|
| **P0 - è‡´å‘½** | >50% ç”¨æˆ·æ— æ³•ä½¿ç”¨ | CTO | <5 åˆ†é’Ÿ | ç«‹å³å›æ»š |
| **P1 - ä¸¥é‡** | 20-50% ç”¨æˆ·ä½“éªŒå—æŸ | æŠ€æœ¯æ€»ç›‘ | <15 åˆ†é’Ÿ | æš‚åœç°åº¦ï¼Œè¯„ä¼°åå›æ»š |
| **P2 - ä¸€èˆ¬** | 5-20% ç”¨æˆ·è½»å¾®å½±å“ | äº§å“ç»ç† | <1 å°æ—¶ | ä¿®å¤ä¼˜å…ˆï¼Œå¿…è¦æ—¶å›æ»š |
| **P3 - è½»å¾®** | <5% ç”¨æˆ·æ— æ„ŸçŸ¥ | å¼€å‘è´Ÿè´£äºº | <4 å°æ—¶ | æ­£å¸¸ä¿®å¤æµç¨‹ |

---

## 2. åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

### é˜¶æ®µä¸€ï¼šåŸºç¡€èƒ½åŠ›åŠ å›º

**ç›®æ ‡**: è§£å†³"å¡æ­»"å’Œ"ç©ºæŠ¥å‘Š"é—®é¢˜  
**æ—¶é—´**: Week 1-2 (2 å‘¨)  
**äººåŠ›**: 2 åç«¯ + 1 å‰ç«¯ + 1 æµ‹è¯• = 4 äºº  
**ä¼°ç®—**: 40 äººæ—¥

#### 2.1.1 æ ¸å¿ƒä»»åŠ¡æ¸…å•

| ä»»åŠ¡ ID | ä»»åŠ¡åç§° | è´Ÿè´£äºº | ä¼˜å…ˆçº§ | ä¼°ç®— (äººæ—¥) | ä¾èµ– |
|--------|---------|--------|--------|------------|------|
| **P1-T1** | é‡æ„è¯Šæ–­ä»»åŠ¡çŠ¶æ€æœº | åç«¯ A | P0 | 3 | æ—  |
| **P1-T2** | å®ç°è¶…æ—¶ç®¡ç†æœºåˆ¶ | åç«¯ A | P0 | 2 | P1-T1 |
| **P1-T3** | å®ç°é‡è¯•æœºåˆ¶ | åç«¯ A | P0 | 2 | P1-T1 |
| **P1-T4** | å®ç°æ­»ä¿¡é˜Ÿåˆ— | åç«¯ A | P1 | 2 | P1-T1 |
| **P1-T5** | API è°ƒç”¨æ—¥å¿—æŒä¹…åŒ– | åç«¯ B | P0 | 2 | æ—  |
| **P1-T6** | åŸå§‹æ•°æ®æŒä¹…åŒ–æœºåˆ¶ | åç«¯ B | P0 | 3 | P1-T5 |
| **P1-T7** | æŠ¥å‘Šå­˜æ ¹å®ç° | åç«¯ B | P0 | 2 | P1-T6 |
| **P1-T8** | å‰ç«¯çŠ¶æ€è½®è¯¢ä¼˜åŒ– | å‰ç«¯ | P0 | 2 | P1-T1 |
| **P1-T9** | é›†æˆæµ‹è¯• | æµ‹è¯• | P0 | 3 | æ‰€æœ‰å¼€å‘ä»»åŠ¡ |
| **P1-T10** | é¢„å‘å¸ƒéªŒè¯ | å…¨ä½“ | P0 | 1 | P1-T9 |

#### 2.1.2 è¯¦ç»†è®¾è®¡

##### P1-T1: é‡æ„è¯Šæ–­ä»»åŠ¡çŠ¶æ€æœº

**æ–‡ä»¶ç»“æ„**:

```
wechat_backend/v2/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ state_machine/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ diagnosis_state_machine.py    # çŠ¶æ€æœºæ ¸å¿ƒ
â”‚   â”œâ”€â”€ states.py                      # çŠ¶æ€å®šä¹‰
â”‚   â””â”€â”€ transitions.py                 # çŠ¶æ€æµè½¬å®šä¹‰
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ diagnosis_service.py           # è¯Šæ–­æœåŠ¡
â”‚   â””â”€â”€ timeout_service.py             # è¶…æ—¶æœåŠ¡
â””â”€â”€ repositories/
    â””â”€â”€ diagnosis_repository.py        # æ•°æ®ä»“åº“
```

**çŠ¶æ€æœºå®ç°**:

```python
# wechat_backend/v2/state_machine/diagnosis_state_machine.py

from enum import Enum
from typing import Optional, Dict, Any
from datetime import datetime, timedelta

class DiagnosisState(Enum):
    """è¯Šæ–­çŠ¶æ€æšä¸¾"""
    INITIALIZING = 'initializing'
    AI_FETCHING = 'ai_fetching'
    ANALYZING = 'analyzing'
    COMPLETED = 'completed'
    PARTIAL_SUCCESS = 'partial_success'
    FAILED = 'failed'
    TIMEOUT = 'timeout'


class DiagnosisStateMachine:
    """è¯Šæ–­çŠ¶æ€æœº"""
    
    # çŠ¶æ€æµè½¬å®šä¹‰
    TRANSITIONS = {
        DiagnosisState.INITIALIZING: {
            'succeed': DiagnosisState.AI_FETCHING,
            'fail': DiagnosisState.FAILED,
        },
        DiagnosisState.AI_FETCHING: {
            'all_complete': DiagnosisState.ANALYZING,
            'partial_complete': DiagnosisState.ANALYZING,
            'all_fail': DiagnosisState.FAILED,
            'timeout': DiagnosisState.TIMEOUT,
        },
        DiagnosisState.ANALYZING: {
            'succeed': DiagnosisState.COMPLETED,
            'partial_succeed': DiagnosisState.PARTIAL_SUCCESS,
            'fail': DiagnosisState.FAILED,
        },
        # ç»ˆæ€ï¼Œæ— æµè½¬
        DiagnosisState.COMPLETED: {},
        DiagnosisState.PARTIAL_SUCCESS: {},
        DiagnosisState.FAILED: {},
        DiagnosisState.TIMEOUT: {},
    }
    
    def __init__(self, execution_id: str):
        self.execution_id = execution_id
        self.current_state = DiagnosisState.INITIALIZING
        self.progress = 0
        self.metadata: Dict[str, Any] = {}
    
    def transition(self, event: str, **kwargs) -> bool:
        """æ‰§è¡ŒçŠ¶æ€æµè½¬"""
        allowed_transitions = self.TRANSITIONS.get(self.current_state, {})
        
        if event not in allowed_transitions:
            logger.warning(f"éæ³•çŠ¶æ€æµè½¬ï¼š{self.current_state} -> {event}")
            return False
        
        next_state = allowed_transitions[event]
        
        # æ›´æ–°çŠ¶æ€
        old_state = self.current_state
        self.current_state = next_state
        
        # æ›´æ–°è¿›åº¦
        if 'progress' in kwargs:
            self.progress = kwargs['progress']
        
        # æ›´æ–°å…ƒæ•°æ®
        self.metadata.update(kwargs)
        
        logger.info(f"çŠ¶æ€æµè½¬ï¼š{self.execution_id}, "
                   f"{old_state.value} -> {next_state.value} (event={event})")
        
        # æŒä¹…åŒ–çŠ¶æ€
        self.persist_state()
        
        return True
    
    def persist_state(self):
        """æŒä¹…åŒ–çŠ¶æ€åˆ°æ•°æ®åº“"""
        from wechat_backend.v2.repositories.diagnosis_repository import DiagnosisRepository
        
        repo = DiagnosisRepository()
        repo.update_state(
            execution_id=self.execution_id,
            status=self.current_state.value,
            progress=self.progress,
            stage=self.current_state.value,
            is_completed=self.current_state in [
                DiagnosisState.COMPLETED,
                DiagnosisState.PARTIAL_SUCCESS,
                DiagnosisState.FAILED,
                DiagnosisState.TIMEOUT,
            ],
            should_stop_polling=self.current_state in [
                DiagnosisState.COMPLETED,
                DiagnosisState.PARTIAL_SUCCESS,
                DiagnosisState.FAILED,
                DiagnosisState.TIMEOUT,
            ],
            metadata=self.metadata,
        )
```

##### P1-T2: è¶…æ—¶ç®¡ç†æœºåˆ¶

```python
# wechat_backend/v2/services/timeout_service.py

import threading
from datetime import datetime, timedelta
from typing import Callable, Dict

class TimeoutManager:
    """è¶…æ—¶ç®¡ç†å™¨"""
    
    MAX_EXECUTION_TIME = 600  # 10 åˆ†é’Ÿ
    CHECK_INTERVAL = 30  # 30 ç§’æ£€æŸ¥ä¸€æ¬¡
    
    def __init__(self):
        self.timers: Dict[str, threading.Timer] = {}
        self.start_times: Dict[str, datetime] = {}
    
    def start_timer(self, execution_id: str, on_timeout: Callable[[str], None]):
        """å¯åŠ¨è¶…æ—¶è®¡æ—¶å™¨"""
        self.start_times[execution_id] = datetime.now()
        
        def timeout_handler():
            logger.warning(f"ä»»åŠ¡è¶…æ—¶ï¼š{execution_id}")
            on_timeout(execution_id)
            # ä»è®¡æ—¶å™¨ä¸­ç§»é™¤
            if execution_id in self.timers:
                del self.timers[execution_id]
        
        timer = threading.Timer(self.MAX_EXECUTION_TIME, timeout_handler)
        self.timers[execution_id] timer.start()
        
        logger.info(f"è¶…æ—¶è®¡æ—¶å™¨å·²å¯åŠ¨ï¼š{execution_id}, è¶…æ—¶æ—¶é—´={self.MAX_EXECUTION_TIME}ç§’")
    
    def cancel_timer(self, execution_id: str):
        """å–æ¶ˆè¶…æ—¶è®¡æ—¶å™¨"""
        if execution_id in self.timers:
            self.timers[execution_id].cancel()
            del self.timers[execution_id]
            logger.info(f"è¶…æ—¶è®¡æ—¶å™¨å·²å–æ¶ˆï¼š{execution_id}")
    
    def get_remaining_time(self, execution_id: str) -> int:
        """è·å–å‰©ä½™æ—¶é—´ï¼ˆç§’ï¼‰"""
        if execution_id not in self.start_times:
            return 0
        
        elapsed = (datetime.now() - self.start_times[execution_id]).total_seconds()
        remaining = max(0, self.MAX_EXECUTION_TIME - elapsed)
        return int(remaining)
```

##### P1-T5 & P1-T6: API è°ƒç”¨æ—¥å¿—ä¸åŸå§‹æ•°æ®æŒä¹…åŒ–

```python
# wechat_backend/v2/repositories/api_call_log_repository.py

import json
from datetime import datetime
from typing import Dict, Any, List

class APICallLogRepository:
    """API è°ƒç”¨æ—¥å¿—ä»“åº“"""
    
    def log_api_call(
        self,
        execution_id: str,
        brand: str,
        question: str,
        model: str,
        request_data: Dict[str, Any],
        response_data: Optional[Dict[str, Any]],
        error: Optional[str],
        latency_ms: int,
        timestamp: datetime = None,
    ):
        """è®°å½• API è°ƒç”¨æ—¥å¿—"""
        timestamp = timestamp or datetime.now()
        
        # å†™å…¥æ•°æ®åº“
        db.execute('''
            INSERT INTO api_call_logs (
                execution_id, brand, question, model,
                request_data, response_data, error,
                latency_ms, timestamp
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            execution_id, brand, question, model,
            json.dumps(request_data),
            json.dumps(response_data) if response_data else None,
            error,
            latency_ms,
            timestamp.isoformat(),
        ))
        
        # åŒæ—¶å†™å…¥æ–‡ä»¶ï¼ˆåŒé‡ä¿é™©ï¼‰
        self._write_to_file(execution_id, {
            'brand': brand,
            'question': question,
            'model': model,
            'request': request_data,
            'response': response_data,
            'error': error,
            'latency_ms': latency_ms,
            'timestamp': timestamp.isoformat(),
        })
    
    def _write_to_file(self, execution_id: str, data: Dict[str, Any]):
        """å†™å…¥æ–‡ä»¶å¤‡ä»½"""
        import os
        log_dir = f'/data/diagnosis/logs/{execution_id[:8]}'
        os.makedirs(log_dir, exist_ok=True)
        
        log_file = os.path.join(log_dir, f'{execution_id}.jsonl')
        with open(log_file, 'a') as f:
            f.write(json.dumps(data, ensure_ascii=False) + '\n')
    
    def get_all_calls(self, execution_id: str) -> List[Dict[str, Any]]:
        """è·å–æŸæ¬¡è¯Šæ–­çš„æ‰€æœ‰ API è°ƒç”¨è®°å½•"""
        cursor = db.execute('''
            SELECT * FROM api_call_logs
            WHERE execution_id = ?
            ORDER BY timestamp ASC
        ''', (execution_id,))
        
        return [dict(row) for row in cursor.fetchall()]
```

##### P1-T7: æŠ¥å‘Šå­˜æ ¹å®ç°

```python
# wechat_backend/v2/services/report_stub_service.py

class ReportStubService:
    """æŠ¥å‘Šå­˜æ ¹æœåŠ¡"""
    
    def create_stub(self, execution_id: str) -> Dict[str, Any]:
        """åˆ›å»ºæŠ¥å‘Šå­˜æ ¹ï¼ˆå³ä½¿æ²¡æœ‰å®Œæ•´æ•°æ®ä¹Ÿèƒ½è¿”å›ï¼‰"""
        
        # ä»æ•°æ®åº“è·å–åŸºæœ¬ä¿¡æ¯
        report_info = self.get_report_info(execution_id)
        
        # è·å– API è°ƒç”¨è®°å½•
        api_calls = self.get_api_call_logs(execution_id)
        
        # æ„å»ºå­˜æ ¹æŠ¥å‘Š
        stub_report = {
            'report': {
                'execution_id': execution_id,
                'brand_name': report_info.get('brand_name', ''),
                'status': report_info.get('status', 'unknown'),
                'created_at': report_info.get('created_at'),
                'completed_at': report_info.get('completed_at'),
            },
            'results': [],
            'analysis': {
                'brand_distribution': {},
                'sentiment_distribution': {},
                'keywords': [],
            },
            'meta': {
                'is_stub': True,  # æ ‡è®°ä¸ºå­˜æ ¹æŠ¥å‘Š
                'data_completeness': self.calculate_completeness(api_calls),
                'api_call_count': len(api_calls),
                'success_rate': self.calculate_success_rate(api_calls),
            },
            'checksum_verified': False,
        }
        
        # å¦‚æœæœ‰éƒ¨åˆ†æ•°æ®ï¼Œå¡«å……åˆ° results
        if api_calls:
            for call in api_calls:
                if call.get('response_data'):
                    stub_report['results'].append({
                        'brand': call['brand'],
                        'question': call['question'],
                        'model': call['model'],
                        'response': call['response_data'],
                        'geo_data': call['response_data'].get('geo_data', {}),
                        'quality_score': None,  # å¾…è®¡ç®—
                        'quality_level': 'unknown',
                    })
        
        return stub_report
    
    def calculate_completeness(self, api_calls: List[Dict]) -> float:
        """è®¡ç®—æ•°æ®å®Œæ•´åº¦"""
        if not api_calls:
            return 0.0
        
        successful_calls = sum(1 for call in api_calls if call.get('response_data'))
        return successful_calls / len(api_calls) * 100
    
    def calculate_success_rate(self, api_calls: List[Dict]) -> float:
        """è®¡ç®—æˆåŠŸç‡"""
        if not api_calls:
            return 0.0
        
        successful_calls = sum(1 for call in api_calls if not call.get('error'))
        return successful_calls / len(api_calls) * 100
```

#### 2.1.3 äº¤ä»˜æ ‡å‡†

**åŠŸèƒ½éªŒæ”¶**:

- [ ] è¯Šæ–­ä»»åŠ¡ä¸å†å¡æ­»ï¼ˆè¶…æ—¶æœºåˆ¶ç”Ÿæ•ˆï¼‰
- [ ] æ‰€æœ‰ API è°ƒç”¨éƒ½æœ‰æ—¥å¿—è®°å½•
- [ ] å³ä½¿è¯Šæ–­å¤±è´¥ï¼Œä¹Ÿèƒ½è¿”å›å­˜æ ¹æŠ¥å‘Š
- [ ] å†å²è®°å½•é¡µé¢æ˜¾ç¤º"æœ‰æ•°æ®"æ ‡è¯†
- [ ] å‰ç«¯è½®è¯¢åœ¨ä»»åŠ¡å®Œæˆåæ­£ç¡®åœæ­¢

**è´¨é‡éªŒæ”¶**:

- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡ç‡ 100%
- [ ] é¢„å‘å¸ƒç¯å¢ƒéªŒè¯é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•ï¼šå•ä»»åŠ¡æ‰§è¡Œæ—¶é—´ < 10 åˆ†é’Ÿ

**æ–‡æ¡£éªŒæ”¶**:

- [ ] API æ–‡æ¡£æ›´æ–°
- [ ] éƒ¨ç½²æ–‡æ¡£æ›´æ–°
- [ ] è¿ç»´æ‰‹å†Œæ›´æ–°

#### 2.1.4 é£é™©è¯„ä¼°ä¸åº”å¯¹

| é£é™© | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ |
|------|-------|------|---------|
| çŠ¶æ€æœºä¸ç°æœ‰ä»£ç ä¸å…¼å®¹ | ä¸­ | é«˜ | ä¿ç•™ v1 ä»£ç ï¼Œé€šè¿‡ç‰¹æ€§å¼€å…³éš”ç¦» |
| æ•°æ®åº“å†™å…¥æ€§èƒ½ä¸‹é™ | ä½ | ä¸­ | ä½¿ç”¨è¿æ¥æ± ï¼Œæ‰¹é‡å†™å…¥ä¼˜åŒ– |
| å‰ç«¯è½®è¯¢é€»è¾‘å˜æ›´å¼•å…¥ Bug | ä¸­ | ä¸­ | å……åˆ†æµ‹è¯•ï¼Œç°åº¦å‘å¸ƒ |
| è¶…æ—¶æ—¶é—´è®¾ç½®ä¸åˆç† | ä¸­ | ä½ | ç›‘æ§å®é™…æ‰§è¡Œæ—¶é—´ï¼ŒåŠ¨æ€è°ƒæ•´ |

**å›æ»šæ–¹æ¡ˆ**:

```bash
# é˜¶æ®µä¸€å›æ»šè„šæœ¬
./rollback.sh --target v1.0.0 --reason "é˜¶æ®µä¸€é—®é¢˜"

# å›æ»šåéªŒè¯
curl http://localhost:5000/api/health
curl http://localhost:5000/api/diagnosis/history?user_id=test
```

---

### é˜¶æ®µäºŒï¼šæ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½å®ç°

**ç›®æ ‡**: äº¤ä»˜çœŸå®çš„ç»Ÿè®¡åˆ†ææŠ¥å‘Š  
**æ—¶é—´**: Week 3-5 (3 å‘¨)  
**äººåŠ›**: 2 åç«¯ + 1 æ•°æ® + 1 å‰ç«¯ + 1 æµ‹è¯• = 5 äºº  
**ä¼°ç®—**: 60 äººæ—¥

#### 2.2.1 æ ¸å¿ƒä»»åŠ¡æ¸…å•

| ä»»åŠ¡ ID | ä»»åŠ¡åç§° | è´Ÿè´£äºº | ä¼˜å…ˆçº§ | ä¼°ç®— (äººæ—¥) | ä¾èµ– |
|--------|---------|--------|--------|------------|------|
| **P2-T1** | AI å¹³å°æ ‡å‡†åŒ–æ•°æ®äº¤äº’å±‚ | åç«¯ A | P0 | 4 | æ—  |
| **P2-T2** | æ•°æ®æ¸…æ´—ç®¡é“å®ç° | åç«¯ B | P0 | 3 | P2-T1 |
| **P2-T3** | é¢‘æ®µåˆ†å¸ƒç»Ÿè®¡ç®—æ³• | æ•°æ® | P0 | 3 | P2-T2 |
| **P2-T4** | æƒ…æ„Ÿåˆ†æç»Ÿè®¡ç®—æ³• | æ•°æ® | P0 | 3 | P2-T2 |
| **P2-T5** | å…³é”®è¯æå–ç®—æ³• | æ•°æ® | P1 | 4 | P2-T2 |
| **P2-T6** | è¶‹åŠ¿å¯¹æ¯”åˆ†æç®—æ³• | æ•°æ® | P1 | 4 | P2-T2 |
| **P2-T7** | æŠ¥å‘Šæ•°æ®ç»“æ„è®¾è®¡ | åç«¯ A | P0 | 2 | æ—  |
| **P2-T8** | å‰ç«¯æŠ¥å‘Šæ¸²æŸ“é€»è¾‘ | å‰ç«¯ | P0 | 5 | P2-T7 |
| **P2-T9** | æ•°æ®å…¼å®¹æ€§å¤„ç† | åç«¯ B | P0 | 3 | P2-T7 |
| **P2-T10** | é›†æˆæµ‹è¯• | æµ‹è¯• | P0 | 5 | æ‰€æœ‰å¼€å‘ä»»åŠ¡ |
| **P2-T11** | é¢„å‘å¸ƒéªŒè¯ | å…¨ä½“ | P0 | 2 | P2-T10 |

#### 2.2.2 è¯¦ç»†è®¾è®¡

##### P2-T1: AI å¹³å°æ ‡å‡†åŒ–æ•°æ®äº¤äº’å±‚

```python
# wechat_backend/v2/adapters/ai_adapter_interface.py

from abc import ABC, abstractmethod
from typing import Dict, Any, Optional
from dataclasses import dataclass

@dataclass
class AIRequest:
    """AI è¯·æ±‚æ ‡å‡†åŒ–ç»“æ„"""
    prompt: str
    temperature: float = 0.7
    max_tokens: int = 2000
    timeout: int = 60


@dataclass
class AIResponse:
    """AI å“åº”æ ‡å‡†åŒ–ç»“æ„"""
    content: str
    latency_ms: int
    model: str
    usage: Optional[Dict[str, int]] = None  # token ä½¿ç”¨æƒ…å†µ
    raw_response: Optional[Dict[str, Any]] = None  # åŸå§‹å“åº”
    error: Optional[str] = None


class AIAdapter(ABC):
    """AI é€‚é…å™¨æ¥å£"""
    
    @abstractmethod
    async def send(self, request: AIRequest) -> AIResponse:
        """å‘é€è¯·æ±‚å¹¶è·å–å“åº”"""
        pass
    
    @abstractmethod
    def validate_response(self, response: AIResponse) -> bool:
        """éªŒè¯å“åº”æœ‰æ•ˆæ€§"""
        pass
    
    @abstractmethod
    def parse_geo_data(self, response: AIResponse) -> Dict[str, Any]:
        """è§£æ GEO æ•°æ®"""
        pass


# é€‚é…å™¨å·¥å‚
class AIAdapterFactory:
    """AI é€‚é…å™¨å·¥å‚"""
    
    _adapters: Dict[str, AIAdapter] = {}
    
    @classmethod
    def register(cls, model_name: str, adapter: AIAdapter):
        """æ³¨å†Œé€‚é…å™¨"""
        cls._adapters[model_name] = adapter
    
    @classmethod
    def get_adapter(cls, model_name: str) -> AIAdapter:
        """è·å–é€‚é…å™¨"""
        if model_name not in cls._adapters:
            raise ValueError(f"æœªçŸ¥çš„ AI æ¨¡å‹ï¼š{model_name}")
        return cls._adapters[model_name]
```

##### P2-T3: é¢‘æ®µåˆ†å¸ƒç»Ÿè®¡ç®—æ³•

```python
# wechat_backend/v2/analytics/brand_distribution_analyzer.py

from typing import List, Dict
from collections import defaultdict

class BrandDistributionAnalyzer:
    """å“ç‰Œåˆ†å¸ƒåˆ†æå™¨"""
    
    def analyze(self, results: List[Dict[str, Any]]) -> Dict[str, float]:
        """
        åˆ†æå“ç‰Œé¢‘æ®µåˆ†å¸ƒ
        
        å‚æ•°:
            results: è¯Šæ–­ç»“æœåˆ—è¡¨ï¼Œæ¯é¡¹åŒ…å« brand å­—æ®µ
        
        è¿”å›:
            å“ç‰Œåˆ†å¸ƒå­—å…¸ï¼Œkey ä¸ºå“ç‰Œåï¼Œvalue ä¸ºå æ¯”ï¼ˆ0-100ï¼‰
        """
        if not results:
            return {}
        
        # ç»Ÿè®¡å„å“ç‰Œå‡ºç°æ¬¡æ•°
        brand_counts = defaultdict(int)
        for result in results:
            brand = result.get('brand', 'unknown')
            brand_counts[brand] += 1
        
        # è®¡ç®—å æ¯”
        total = sum(brand_counts.values())
        distribution = {}
        for brand, count in brand_counts.items():
            distribution[brand] = round(count / total * 100, 2)
        
        return distribution
    
    def analyze_by_model(
        self,
        results: List[Dict[str, Any]]
    ) -> Dict[str, Dict[str, float]]:
        """
        æŒ‰ AI æ¨¡å‹åˆ†æå“ç‰Œåˆ†å¸ƒ
        
        è¿”å›:
            åµŒå¥—å­—å…¸ï¼Œå¤–å±‚ key ä¸ºæ¨¡å‹åï¼Œå†…å±‚ä¸ºå“ç‰Œåˆ†å¸ƒ
        """
        model_brand_counts = defaultdict(lambda: defaultdict(int))
        
        for result in results:
            model = result.get('model', 'unknown')
            brand = result.get('brand', 'unknown')
            model_brand_counts[model][brand] += 1
        
        # è®¡ç®—æ¯ä¸ªæ¨¡å‹çš„åˆ†å¸ƒ
        distribution = {}
        for model, brand_counts in model_brand_counts.items():
            total = sum(brand_counts.values())
            distribution[model] = {
                brand: round(count / total * 100, 2)
                for brand, count in brand_counts.items()
            }
        
        return distribution
```

##### P2-T4: æƒ…æ„Ÿåˆ†æç»Ÿè®¡ç®—æ³•

```python
# wechat_backend/v2/analytics/sentiment_analyzer.py

from typing import List, Dict
from collections import defaultdict

class SentimentAnalyzer:
    """æƒ…æ„Ÿåˆ†æå™¨"""
    
    SENTIMENT_LABELS = ['positive', 'neutral', 'negative']
    
    def analyze(self, results: List[Dict[str, Any]]) -> Dict[str, float]:
        """
        åˆ†ææƒ…æ„Ÿå€¾å‘åˆ†å¸ƒ
        
        å‚æ•°:
            results: è¯Šæ–­ç»“æœåˆ—è¡¨ï¼Œæ¯é¡¹åŒ…å« geo_data.sentiment å­—æ®µ
        
        è¿”å›:
            æƒ…æ„Ÿåˆ†å¸ƒå­—å…¸ï¼Œkey ä¸ºæƒ…æ„Ÿæ ‡ç­¾ï¼Œvalue ä¸ºå æ¯”ï¼ˆ0-100ï¼‰
        """
        if not results:
            return {label: 0.0 for label in self.SENTIMENT_LABELS}
        
        # ç»Ÿè®¡å„æƒ…æ„Ÿæ ‡ç­¾å‡ºç°æ¬¡æ•°
        sentiment_counts = defaultdict(int)
        for result in results:
            geo_data = result.get('geo_data', {})
            sentiment = geo_data.get('sentiment', 'neutral')
            sentiment_counts[sentiment] += 1
        
        # ç¡®ä¿æ‰€æœ‰æ ‡ç­¾éƒ½æœ‰å€¼
        for label in self.SENTIMENT_LABELS:
            if label not in sentiment_counts:
                sentiment_counts[label] = 0
        
        # è®¡ç®—å æ¯”
        total = sum(sentiment_counts.values())
        distribution = {}
        for label in self.SENTIMENT_LABELS:
            distribution[label] = round(
                sentiment_counts[label] / total * 100 if total > 0 else 0,
                2
            )
        
        return distribution
    
    def analyze_by_brand(
        self,
        results: List[Dict[str, Any]]
    ) -> Dict[str, Dict[str, float]]:
        """
        æŒ‰å“ç‰Œåˆ†ææƒ…æ„Ÿåˆ†å¸ƒ
        
        è¿”å›:
            åµŒå¥—å­—å…¸ï¼Œå¤–å±‚ key ä¸ºå“ç‰Œåï¼Œå†…å±‚ä¸ºæƒ…æ„Ÿåˆ†å¸ƒ
        """
        brand_sentiment_counts = defaultdict(lambda: defaultdict(int))
        
        for result in results:
            brand = result.get('brand', 'unknown')
            geo_data = result.get('geo_data', {})
            sentiment = geo_data.get('sentiment', 'neutral')
            brand_sentiment_counts[brand][sentiment] += 1
        
        # è®¡ç®—æ¯ä¸ªå“ç‰Œçš„æƒ…æ„Ÿåˆ†å¸ƒ
        distribution = {}
        for brand, sentiment_counts in brand_sentiment_counts.items():
            total = sum(sentiment_counts.values())
            distribution[brand] = {
                label: round(
                    sentiment_counts.get(label, 0) / total * 100 if total > 0 else 0,
                    2
                )
                for label in self.SENTIMENT_LABELS
            }
        
        return distribution
```

##### P2-T7: æŠ¥å‘Šæ•°æ®ç»“æ„è®¾è®¡

```python
# wechat_backend/v2/models/report_schema.py

from dataclasses import dataclass, field
from typing import List, Dict, Any, Optional
from datetime import datetime


@dataclass
class DiagnosticReport:
    """è¯Šæ–­æŠ¥å‘Šä¸»æ•°æ®ç»“æ„"""
    
    # åŸºæœ¬ä¿¡æ¯
    execution_id: str
    user_id: str
    brand_name: str
    
    # è¯Šæ–­é…ç½®
    competitor_brands: List[str] = field(default_factory=list)
    selected_models: List[str] = field(default_factory=list)
    custom_questions: List[str] = field(default_factory=list)
    
    # çŠ¶æ€ä¿¡æ¯
    status: str  # initializing, ai_fetching, analyzing, completed, failed, timeout
    progress: int = 0
    stage: str = 'init'
    is_completed: bool = False
    should_stop_polling: bool = False
    
    # æ—¶é—´ä¿¡æ¯
    created_at: datetime = field(default_factory=datetime.now)
    completed_at: Optional[datetime] = None
    
    # å…ƒæ•°æ®
    data_schema_version: str = '2.0'
    server_version: str = '2.0.0'
    checksum: Optional[str] = None


@dataclass
class DiagnosticResult:
    """è¯Šæ–­ç»“æœå•é¡¹"""
    
    brand: str
    question: str
    model: str
    
    # AI å“åº”
    response: Dict[str, Any] = field(default_factory=dict)
    
    # GEO åˆ†ææ•°æ®
    geo_data: Dict[str, Any] = field(default_factory=dict)
    
    # è´¨é‡è¯„ä¼°
    quality_score: Optional[float] = None
    quality_level: str = 'unknown'  # high, medium, low
    
    # æ€§èƒ½æŒ‡æ ‡
    latency_ms: Optional[int] = None
    
    # é”™è¯¯ä¿¡æ¯
    error: Optional[str] = None


@dataclass
class DiagnosticAnalysis:
    """è¯Šæ–­åˆ†ææ•°æ®"""
    
    # å“ç‰Œåˆ†å¸ƒ
    brand_distribution: Dict[str, float] = field(default_factory=dict)
    
    # æƒ…æ„Ÿåˆ†å¸ƒ
    sentiment_distribution: Dict[str, float] = field(default_factory=dict)
    
    # å…³é”®è¯äº‘
    keywords: List[Dict[str, Any]] = field(default_factory=list)
    # æ¯ä¸ªå…³é”®è¯ï¼š{'word': str, 'count': int, 'sentiment': str}
    
    # è¶‹åŠ¿å¯¹æ¯”ï¼ˆå¦‚æœ‰å†å²æ•°æ®ï¼‰
    trend: Optional[Dict[str, Any]] = None
    
    # ç«å“å¯¹æ¯”
    competitive_analysis: Optional[Dict[str, Any]] = None


@dataclass
class FullReport:
    """å®Œæ•´æŠ¥å‘Šï¼ˆè¿”å›ç»™å‰ç«¯ï¼‰"""
    
    report: DiagnosticReport
    results: List[DiagnosticResult]
    analysis: DiagnosticAnalysis
    meta: Dict[str, Any] = field(default_factory=lambda: {
        'data_schema_version': '2.0',
        'server_version': '2.0.0',
        'retrieved_at': datetime.now().isoformat(),
    })
    checksum_verified: bool = False
```

#### 2.2.3 æ•°æ®å…¼å®¹æ€§è®¾è®¡

**æ–°æ—§æŠ¥å‘Šæ•°æ®ç»“æ„å…±å­˜æ–¹æ¡ˆ**:

```python
# wechat_backend/v2/migration/data_compatibility_layer.py

class DataCompatibilityLayer:
    """æ•°æ®å…¼å®¹å±‚"""
    
    def convert_v1_to_v2(self, v1_data: Dict) -> Dict:
        """å°† v1 æ•°æ®è½¬æ¢ä¸º v2 æ ¼å¼"""
        return {
            'report': {
                'execution_id': v1_data.get('execution_id'),
                'user_id': v1_data.get('user_id', 'anonymous'),
                'brand_name': v1_data.get('brand_name', ''),
                'status': v1_data.get('status', 'unknown'),
                'progress': v1_data.get('progress', 0),
                'is_completed': v1_data.get('is_completed', False),
                'should_stop_polling': v1_data.get('status') in ['completed', 'failed'],
                'created_at': v1_data.get('created_at'),
                'completed_at': v1_data.get('completed_at'),
                'data_schema_version': '1.0',
            },
            'results': self._convert_v1_results(v1_data.get('results', [])),
            'analysis': {
                'brand_distribution': {},  # v1 æ— æ­¤æ•°æ®
                'sentiment_distribution': {},  # v1 æ— æ­¤æ•°æ®
                'keywords': [],  # v1 æ— æ­¤æ•°æ®
            },
            'meta': {
                'is_stub': True,
                'converted_from_v1': True,
            },
            'checksum_verified': False,
        }
    
    def convert_v2_to_v1(self, v2_data: Dict) -> Dict:
        """å°† v2 æ•°æ®è½¬æ¢ä¸º v1 æ ¼å¼ï¼ˆå‘åå…¼å®¹ï¼‰"""
        return {
            'execution_id': v2_data['report']['execution_id'],
            'status': v2_data['report']['status'],
            'progress': v2_data['report']['progress'],
            'is_completed': v2_data['report']['is_completed'],
            'results': v2_data.get('results', []),
            # v1 æ ¼å¼ä¸åŒ…å« analysis å­—æ®µ
        }
    
    def _convert_v1_results(self, v1_results: List[Dict]) -> List[Dict]:
        """è½¬æ¢ v1 ç»“æœæ ¼å¼"""
        converted = []
        for result in v1_results:
            converted.append({
                'brand': result.get('brand', ''),
                'question': result.get('question', ''),
                'model': result.get('model', ''),
                'response': result.get('response', {}),
                'geo_data': result.get('geo_data', {}),
                'quality_score': None,
                'quality_level': 'unknown',
            })
        return converted
```

**æ•°æ®åº“å¹³æ»‘è¿ç§»**:

```sql
-- é˜¶æ®µ 1: æ·»åŠ æ–°å­—æ®µï¼ˆå‘åå…¼å®¹ï¼‰
ALTER TABLE diagnosis_reports ADD COLUMN data_schema_version TEXT DEFAULT '1.0';
ALTER TABLE diagnosis_reports ADD COLUMN should_stop_polling BOOLEAN DEFAULT 0;

-- é˜¶æ®µ 2: åˆ›å»ºæ–°è¡¨ï¼ˆv2 æ ¼å¼ï¼‰
CREATE TABLE diagnosis_reports_v2 (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    execution_id TEXT UNIQUE NOT NULL,
    user_id TEXT NOT NULL,
    brand_name TEXT NOT NULL,
    competitor_brands TEXT,
    selected_models TEXT,
    custom_questions TEXT,
    status TEXT NOT NULL,
    progress INTEGER DEFAULT 0,
    stage TEXT NOT NULL,
    is_completed BOOLEAN DEFAULT 0,
    should_stop_polling BOOLEAN DEFAULT 0,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP,
    data_schema_version TEXT DEFAULT '2.0',
    server_version TEXT,
    checksum TEXT
);

-- é˜¶æ®µ 3: åˆ›å»ºè§†å›¾ï¼ˆç»Ÿä¸€è®¿é—®æ¥å£ï¼‰
CREATE VIEW diagnosis_reports_current AS
    SELECT * FROM diagnosis_reports_v2
    UNION ALL
    SELECT * FROM diagnosis_reports
    WHERE execution_id NOT IN (SELECT execution_id FROM diagnosis_reports_v2);

-- é˜¶æ®µ 4: æ•°æ®è¿ç§»ï¼ˆåå°ä»»åŠ¡ï¼‰
-- å°†æ—§æ•°æ®é€æ­¥è¿ç§»åˆ°æ–°è¡¨
```

#### 2.2.4 äº¤ä»˜æ ‡å‡†

**åŠŸèƒ½éªŒæ”¶**:

- [ ] ç”¨æˆ·èƒ½è·å–åŸºäºçœŸå® API æ•°æ®çš„æŠ¥å‘Š
- [ ] æŠ¥å‘ŠåŒ…å«å“ç‰Œé¢‘æ®µåˆ†å¸ƒç»Ÿè®¡
- [ ] æŠ¥å‘ŠåŒ…å«æƒ…æ„Ÿå€¾å‘åˆ†å¸ƒç»Ÿè®¡
- [ ] æŠ¥å‘Šè‡³å°‘åŒ…å«ä¸€ç§å¯è§†åŒ–å›¾è¡¨æ•°æ®
- [ ] å†å²è®°å½•èƒ½æ­£ç¡®å±•ç¤ºæŠ¥å‘Šè¯¦æƒ…

**è´¨é‡éªŒæ”¶**:

- [ ] ç»Ÿè®¡è®¡ç®—å‡†ç¡®ç‡ 100%ï¼ˆä¸æ‰‹åŠ¨è®¡ç®—å¯¹æ¯”ï¼‰
- [ ] æ•°æ®ä¸€è‡´æ€§ 100%ï¼ˆå‰ç«¯/åç«¯/æ•°æ®åº“ä¸€è‡´ï¼‰
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 85%
- [ ] æ€§èƒ½æµ‹è¯•ï¼šæŠ¥å‘Šç”Ÿæˆæ—¶é—´ < 30 ç§’

**æ–‡æ¡£éªŒæ”¶**:

- [ ] ç»Ÿè®¡ç®—æ³•æ–‡æ¡£
- [ ] æ•°æ®ç»“æ„æ–‡æ¡£
- [ ] API æ–‡æ¡£æ›´æ–°

#### 2.2.5 é£é™©è¯„ä¼°ä¸åº”å¯¹

| é£é™© | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ |
|------|-------|------|---------|
| AI å¹³å° API æ ¼å¼å˜æ›´ | ä¸­ | é«˜ | é€‚é…å™¨å±‚éš”ç¦»å˜åŒ–ï¼Œå¿«é€Ÿæ›´æ–° |
| ç»Ÿè®¡ç®—æ³•æ€§èƒ½ç“¶é¢ˆ | ä½ | ä¸­ | é¢„è®¡ç®— + ç¼“å­˜ï¼Œå¢é‡æ›´æ–° |
| æ•°æ®è¿ç§»å¤±è´¥ | ä½ | é«˜ | åŒå†™æ¨¡å¼ï¼Œå¯å›æ»š |
| å‰ç«¯æ¸²æŸ“æ€§èƒ½é—®é¢˜ | ä¸­ | ä¸­ | åˆ†é¡µåŠ è½½ï¼Œè™šæ‹Ÿåˆ—è¡¨ |

---

### é˜¶æ®µä¸‰ï¼šä½“éªŒä¸å¯é æ€§ä¼˜åŒ–

**ç›®æ ‡**: æå‡ç”¨æˆ·ä¿¡ä»»ä¸ç³»ç»ŸéŸ§æ€§  
**æ—¶é—´**: Week 6-7 (2 å‘¨)  
**äººåŠ›**: 2 åç«¯ + 1 å‰ç«¯ + 1 æµ‹è¯• = 4 äºº  
**ä¼°ç®—**: 35 äººæ—¥

#### 2.3.1 æ ¸å¿ƒä»»åŠ¡æ¸…å•

| ä»»åŠ¡ ID | ä»»åŠ¡åç§° | è´Ÿè´£äºº | ä¼˜å…ˆçº§ | ä¼°ç®— (äººæ—¥) | ä¾èµ– |
|--------|---------|--------|--------|------------|------|
| **P3-T1** | WebSocket å®æ—¶æ¨é€å®ç° | åç«¯ A | P1 | 4 | æ—  |
| **P3-T2** | å‰ç«¯è½®è¯¢ä¼˜åŒ–ï¼ˆæ”¹ç”¨ WebSocketï¼‰ | å‰ç«¯ | P1 | 3 | P3-T1 |
| **P3-T3** | å¼‚å¸¸åœºæ™¯å‹å¥½æç¤º | å‰ç«¯ | P0 | 2 | æ—  |
| **P3-T4** | åç«¯å¼‚å¸¸å¤„ç†ä¼˜åŒ– | åç«¯ B | P0 | 2 | æ—  |
| **P3-T5** | è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›– | æµ‹è¯• | P0 | 5 | æ‰€æœ‰å¼€å‘ä»»åŠ¡ |
| **P3-T6** | æ€§èƒ½ä¼˜åŒ–ï¼ˆå¹¶å‘/ç¼“å­˜ï¼‰ | åç«¯ A | P1 | 4 | æ—  |
| **P3-T7** | ç›‘æ§å‘Šè­¦é…ç½® | åç«¯ B | P1 | 3 | æ—  |
| **P3-T8** | é¢„å‘å¸ƒéªŒè¯ | å…¨ä½“ | P0 | 2 | P3-T5 |

#### 2.3.2 è¯¦ç»†è®¾è®¡

##### P3-T1: WebSocket å®æ—¶æ¨é€

```python
# wechat_backend/v2/services/websocket_service.py

import asyncio
import websockets
import json
from typing import Set, Dict
from datetime import datetime

class WebSocketService:
    """WebSocket æœåŠ¡"""
    
    def __init__(self):
        self.clients: Dict[str, Set[websockets.WebSocketServerProtocol]] = {}
    
    async def register(self, execution_id: str, websocket: websockets.WebSocketServerProtocol):
        """æ³¨å†Œå®¢æˆ·ç«¯è¿æ¥"""
        if execution_id not in self.clients:
            self.clients[execution_id] = set()
        self.clients[execution_id].add(websocket)
        print(f"å®¢æˆ·ç«¯å·²æ³¨å†Œï¼š{execution_id}")
    
    async def unregister(self, execution_id: str, websocket: websockets.WebSocketServerProtocol):
        """æ³¨é”€å®¢æˆ·ç«¯è¿æ¥"""
        if execution_id in self.clients:
            self.clients[execution_id].discard(websocket)
            if not self.clients[execution_id]:
                del self.clients[execution_id]
        print(f"å®¢æˆ·ç«¯å·²æ³¨é”€ï¼š{execution_id}")
    
    async def broadcast(self, execution_id: str, message: Dict):
        """å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰è®¢é˜…è¯¥ execution_id çš„å®¢æˆ·ç«¯"""
        if execution_id not in self.clients:
            return
        
        message_json = json.dumps({
            'type': 'diagnosis_update',
            'execution_id': execution_id,
            'timestamp': datetime.now().isoformat(),
            **message
        })
        
        # å¼‚æ­¥å‘é€ç»™æ‰€æœ‰å®¢æˆ·ç«¯
        await asyncio.gather(
            *[self._send_to_client(client, message_json) for client in self.clients[execution_id]],
            return_exceptions=True
        )
    
    async def _send_to_client(self, client: websockets.WebSocketServerProtocol, message: str):
        """å‘é€ç»™å•ä¸ªå®¢æˆ·ç«¯"""
        try:
            await client.send(message)
        except websockets.exceptions.ConnectionClosed:
            pass  # å®¢æˆ·ç«¯å·²æ–­å¼€
        except Exception as e:
            print(f"å‘é€æ¶ˆæ¯å¤±è´¥ï¼š{e}")
    
    async def send_progress(self, execution_id: str, progress: int, stage: str, status: str):
        """å‘é€è¿›åº¦æ›´æ–°"""
        await self.broadcast(execution_id, {
            'event': 'progress',
            'progress': progress,
            'stage': stage,
            'status': status,
        })
    
    async def send_result(self, execution_id: str, result: Dict):
        """å‘é€ä¸­é—´ç»“æœ"""
        await self.broadcast(execution_id, {
            'event': 'result',
            'result': result,
        })
    
    async def send_complete(self, execution_id: str, final_report: Dict):
        """å‘é€å®Œæˆé€šçŸ¥"""
        await self.broadcast(execution_id, {
            'event': 'complete',
            'report': final_report,
        })
    
    async def send_error(self, execution_id: str, error: str, error_type: str):
        """å‘é€é”™è¯¯é€šçŸ¥"""
        await self.broadcast(execution_id, {
            'event': 'error',
            'error': error,
            'error_type': error_type,
        })


# WebSocket æœåŠ¡å™¨
class WebSocketServer:
    """WebSocket æœåŠ¡å™¨"""
    
    def __init__(self, host: str = '0.0.0.0', port: int = 8765):
        self.host = host
        self.port = port
        self.service = WebSocketService()
    
    async def handler(self, websocket: websockets.WebSocketServerProtocol, path: str):
        """WebSocket è¿æ¥å¤„ç†å™¨"""
        # ä»è·¯å¾„ä¸­æå– execution_id
        # è·¯å¾„æ ¼å¼ï¼š/ws/diagnosis/{execution_id}
        execution_id = path.split('/')[-1]
        
        # æ³¨å†Œå®¢æˆ·ç«¯
        await self.service.register(execution_id, websocket)
        
        try:
            # ä¿æŒè¿æ¥ï¼Œæ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯ï¼ˆå¿ƒè·³ç­‰ï¼‰
            async for message in websocket:
                # å¯ä»¥å¤„ç†å®¢æˆ·ç«¯æ¶ˆæ¯ï¼ˆå¦‚å¿ƒè·³ï¼‰
                pass
        finally:
            # æ³¨é”€å®¢æˆ·ç«¯
            await self.service.unregister(execution_id, websocket)
    
    def start(self):
        """å¯åŠ¨æœåŠ¡å™¨"""
        start_server = websockets.serve(self.handler, self.host, self.port)
        asyncio.get_event_loop().run_until_complete(start_server)
        print(f"WebSocket æœåŠ¡å™¨å·²å¯åŠ¨ï¼šws://{self.host}:{self.port}")
        asyncio.get_event_loop().run_forever()
```

##### P3-T3: å¼‚å¸¸åœºæ™¯å‹å¥½æç¤º

```javascript
// å‰ç«¯å¼‚å¸¸å¤„ç†

const ERROR_MESSAGES = {
  // ç½‘ç»œé”™è¯¯
  NETWORK_ERROR: {
    title: 'ç½‘ç»œè¿æ¥å¤±è´¥',
    message: 'è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥ï¼Œç„¶åé‡è¯•',
    action: 'é‡è¯•',
  },
  
  // API è¶…æ—¶
  API_TIMEOUT: {
    title: 'è¯·æ±‚è¶…æ—¶',
    message: 'è¯Šæ–­ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼Œè¯·è€å¿ƒç­‰å¾…æˆ–ç¨åæŸ¥çœ‹å†å²è®°å½•',
    action: 'æŸ¥çœ‹å†å²è®°å½•',
  },
  
  // AI å¹³å°é”™è¯¯
  AI_PLATFORM_ERROR: {
    title: 'AI å¹³å°æš‚æ—¶ä¸å¯ç”¨',
    message: 'æ‰€é€‰ AI å¹³å°æš‚æ—¶æ— æ³•è®¿é—®ï¼Œæˆ‘ä»¬å·²è®°å½•æ­¤é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•',
    action: 'åˆ‡æ¢ AI æ¨¡å‹',
  },
  
  // æ•°æ®å¼‚å¸¸
  DATA_ERROR: {
    title: 'æ•°æ®åŠ è½½å¤±è´¥',
    message: 'æŠ¥å‘Šæ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
    action: 'é‡è¯•',
  },
  
  // ä»»åŠ¡å¤±è´¥
  TASK_FAILED: {
    title: 'è¯Šæ–­ä»»åŠ¡å¤±è´¥',
    message: 'è¯Šæ–­ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œå·²ä¿å­˜å½“å‰è¿›åº¦ï¼Œæ‚¨å¯ä»¥é‡è¯•æˆ–æŸ¥çœ‹éƒ¨åˆ†ç»“æœ',
    action: 'æŸ¥çœ‹éƒ¨åˆ†ç»“æœ',
  },
  
  // ä»»åŠ¡è¶…æ—¶
  TASK_TIMEOUT: {
    title: 'è¯Šæ–­è¶…æ—¶',
    message: 'è¯Šæ–­ä»»åŠ¡æ‰§è¡Œè¶…æ—¶ï¼Œå·²ä¿å­˜å½“å‰è·å–çš„æ•°æ®ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹éƒ¨åˆ†ç»“æœæˆ–é‡è¯•',
    action: 'æŸ¥çœ‹éƒ¨åˆ†ç»“æœ',
  },
};

function handleError(error) {
  const errorType = error.type || 'NETWORK_ERROR';
  const errorConfig = ERROR_MESSAGES[errorType] || ERROR_MESSAGES.NETWORK_ERROR;
  
  // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
  wx.showModal({
    title: errorConfig.title,
    content: errorConfig.message,
    confirmText: errorConfig.action,
    success: (res) => {
      if (res.confirm) {
        // æ‰§è¡Œç”¨æˆ·é€‰æ‹©çš„æ“ä½œ
        handleUserAction(errorConfig.action, error);
      }
    }
  });
}

function handleUserAction(action, error) {
  switch (action) {
    case 'é‡è¯•':
      retryDiagnosis(error.executionId);
      break;
    case 'æŸ¥çœ‹å†å²è®°å½•':
      wx.navigateTo({ url: '/pages/history/history' });
      break;
    case 'åˆ‡æ¢ AI æ¨¡å‹':
      wx.navigateTo({ url: '/pages/config/config' });
      break;
    case 'æŸ¥çœ‹éƒ¨åˆ†ç»“æœ':
      viewPartialResults(error.executionId);
      break;
  }
}
```

#### 2.3.3 æ€§èƒ½è€ƒé‡

**å¹¶å‘æ§åˆ¶**:

```python
# wechat_backend/v2/services/concurrency_control.py

import asyncio
from typing import Dict
from datetime import datetime

class ConcurrencyController:
    """å¹¶å‘æ§åˆ¶å™¨"""
    
    MAX_CONCURRENT_TASKS = 10  # æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°
    MAX_AI_CALLS_PER_MINUTE = 60  # æ¯åˆ†é’Ÿæœ€å¤§ AI è°ƒç”¨æ¬¡æ•°
    
    def __init__(self):
        self.semaphore = asyncio.Semaphore(self.MAX_CONCURRENT_TASKS)
        self.ai_call_timestamps: list = []
    
    async def execute_with_limit(self, coro):
        """é™åˆ¶å¹¶å‘æ‰§è¡Œ"""
        async with self.semaphore:
            return await coro
    
    async def rate_limit_ai_call(self):
        """AI è°ƒç”¨é™æµ"""
        now = datetime.now()
        
        # ç§»é™¤ 1 åˆ†é’Ÿå‰çš„æ—¶é—´æˆ³
        self.ai_call_timestamps = [
            ts for ts in self.ai_call_timestamps
            if (now - ts).total_seconds() < 60
        ]
        
        # å¦‚æœè¾¾åˆ°é™æµï¼Œç­‰å¾…
        if len(self.ai_call_timestamps) >= self.MAX_AI_CALLS_PER_MINUTE:
            wait_time = 60 - (now - self.ai_call_timestamps[0]).total_seconds()
            if wait_time > 0:
                await asyncio.sleep(wait_time)
        
        # è®°å½•æœ¬æ¬¡è°ƒç”¨
        self.ai_call_timestamps.append(now)
```

**ç¼“å­˜ç­–ç•¥**:

```python
# wechat_backend/v2/cache/report_cache.py

import redis
import json
from typing import Optional, Dict
from datetime import timedelta

class ReportCache:
    """æŠ¥å‘Šç¼“å­˜"""
    
    def __init__(self, redis_host: str = 'localhost', redis_port: int = 6379):
        self.redis = redis.Redis(host=redis_host, port=redis_port, decode_responses=True)
        self.ttl = timedelta(hours=24)  # ç¼“å­˜ 24 å°æ—¶
    
    def get(self, execution_id: str) -> Optional[Dict]:
        """è·å–ç¼“å­˜çš„æŠ¥å‘Š"""
        key = f'diagnosis:report:{execution_id}'
        data = self.redis.get(key)
        if data:
            return json.loads(data)
        return None
    
    def set(self, execution_id: str, report: Dict):
        """ç¼“å­˜æŠ¥å‘Š"""
        key = f'diagnosis:report:{execution_id}'
        self.redis.setex(key, self.ttl, json.dumps(report, ensure_ascii=False))
    
    def invalidate(self, execution_id: str):
        """ä½¿ç¼“å­˜å¤±æ•ˆ"""
        key = f'diagnosis:report:{execution_id}'
        self.redis.delete(key)
    
    def get_progress(self, execution_id: str) -> Optional[Dict]:
        """è·å–ç¼“å­˜çš„è¿›åº¦"""
        key = f'diagnosis:progress:{execution_id}'
        data = self.redis.get(key)
        if data:
            return json.loads(data)
        return None
    
    def set_progress(self, execution_id: str, progress: int, stage: str, status: str):
        """ç¼“å­˜è¿›åº¦ï¼ˆçŸ­ TTLï¼‰"""
        key = f'diagnosis:progress:{execution_id}'
        value = json.dumps({
            'progress': progress,
            'stage': stage,
            'status': status,
        })
        self.redis.setex(key, timedelta(minutes=5), value)  # è¿›åº¦ç¼“å­˜ 5 åˆ†é’Ÿ
```

#### 2.3.4 äº¤ä»˜æ ‡å‡†

**åŠŸèƒ½éªŒæ”¶**:

- [ ] å®æ—¶è¿›åº¦æ¨é€æ­£å¸¸å·¥ä½œï¼ˆWebSocket æˆ–è½®è¯¢ï¼‰
- [ ] å¼‚å¸¸åœºæ™¯æœ‰å‹å¥½æç¤º
- [ ] è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] æ€§èƒ½æµ‹è¯•ï¼šå¹¶å‘ 100 ç”¨æˆ·ï¼Œé”™è¯¯ç‡ < 1%

**è´¨é‡éªŒæ”¶**:

- [ ] ç”¨æˆ·ä½“éªŒæµ‹è¯•é€šè¿‡
- [ ] å¼‚å¸¸åœºæ™¯æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•é€šè¿‡

**æ–‡æ¡£éªŒæ”¶**:

- [ ] è¿ç»´æ‰‹å†Œæ›´æ–°
- [ ] æ•…éšœæ’æŸ¥æŒ‡å—
- [ ] ç›‘æ§å‘Šè­¦é…ç½®æ–‡æ¡£

---

### é˜¶æ®µå››ï¼šå†å²æ•°æ®ä¿®å¤ä¸æ”¶å°¾

**ç›®æ ‡**: ç³»ç»Ÿå½»åº•æ‘†è„±å†å²å€ºåŠ¡  
**æ—¶é—´**: Week 8 (1 å‘¨)  
**äººåŠ›**: 1 åç«¯ + 1 æµ‹è¯• = 2 äºº  
**ä¼°ç®—**: 10 äººæ—¥

#### 2.4.1 æ ¸å¿ƒä»»åŠ¡æ¸…å•

| ä»»åŠ¡ ID | ä»»åŠ¡åç§° | è´Ÿè´£äºº | ä¼˜å…ˆçº§ | ä¼°ç®— (äººæ—¥) | ä¾èµ– |
|--------|---------|--------|--------|------------|------|
| **P4-T1** | å†å²è¯Šæ–­è®°å½•ä¿®å¤è„šæœ¬ | åç«¯ | P2 | 3 | æ—  |
| **P4-T2** | æ— ç”¨ä»£ç æ¸…ç† | åç«¯ | P2 | 2 | æ‰€æœ‰é˜¶æ®µå®Œæˆ |
| **P4-T3** | ä¸´æ—¶è¡¨æ¸…ç† | åç«¯ | P2 | 1 | P4-T1 |
| **P4-T4** | æŠ€æœ¯æ–‡æ¡£æ›´æ–° | åç«¯ | P1 | 2 | æ‰€æœ‰é˜¶æ®µå®Œæˆ |
| **P4-T5** | è¿ç»´æ‰‹å†Œæ›´æ–° | åç«¯ | P1 | 2 | æ‰€æœ‰é˜¶æ®µå®Œæˆ |

#### 2.4.2 å†å²æ•°æ®ä¿®å¤è„šæœ¬

```python
# scripts/fix_historical_records.py

"""
å†å²è¯Šæ–­è®°å½•ä¿®å¤è„šæœ¬

ç”¨é€”:
1. ä¿®å¤ç¼ºå¤± should_stop_polling å­—æ®µçš„è®°å½•
2. ä¿®å¤çŠ¶æ€ä¸ä¸€è‡´çš„è®°å½•
3. è¡¥å…¨ç¼ºå¤±çš„ analysis æ•°æ®
"""

import sqlite3
import json
from datetime import datetime

def fix_historical_records(db_path: str):
    """ä¿®å¤å†å²è®°å½•"""
    
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    # 1. ä¿®å¤ç¼ºå¤± should_stop_polling çš„è®°å½•
    cursor.execute('''
        UPDATE diagnosis_reports
        SET should_stop_polling = 1
        WHERE status IN ('completed', 'failed', 'timeout')
        AND should_stop_polling = 0
    ''')
    fixed_count = cursor.rowcount
    print(f"ä¿®å¤ should_stop_polling å­—æ®µï¼š{fixed_count} æ¡è®°å½•")
    
    # 2. ä¿®å¤çŠ¶æ€ä¸ä¸€è‡´çš„è®°å½•
    cursor.execute('''
        UPDATE diagnosis_reports
        SET stage = status
        WHERE stage != status
        AND status IN ('initializing', 'ai_fetching', 'analyzing', 'completed', 'failed', 'timeout')
    ''')
    fixed_count = cursor.rowcount
    print(f"ä¿®å¤ stage å­—æ®µï¼š{fixed_count} æ¡è®°å½•")
    
    # 3. æ ‡è®°ç©ºæŠ¥å‘Š
    cursor.execute('''
        UPDATE diagnosis_reports
        SET error_message = 'å†å²æ•°æ®ï¼šæŠ¥å‘Šå†…å®¹ä¸ºç©º'
        WHERE execution_id NOT IN (
            SELECT DISTINCT execution_id FROM diagnosis_results
        )
        AND status = 'completed'
    ''')
    marked_count = cursor.rowcount
    print(f"æ ‡è®°ç©ºæŠ¥å‘Šï¼š{marked_count} æ¡è®°å½•")
    
    conn.commit()
    conn.close()
    
    print("å†å²è®°å½•ä¿®å¤å®Œæˆ")


if __name__ == '__main__':
    db_path = '/path/to/database.db'
    fix_historical_records(db_path)
```

#### 2.4.3 äº¤ä»˜æ ‡å‡†

**åŠŸèƒ½éªŒæ”¶**:

- [ ] å†å²è®°å½•å¯æ­£å¸¸è®¿é—®
- [ ] æ— ç”¨ä»£ç å·²æ¸…ç†
- [ ] æ•°æ®åº“æ— ä¸´æ—¶è¡¨æ®‹ç•™

**æ–‡æ¡£éªŒæ”¶**:

- [ ] å®Œæ•´çš„æŠ€æœ¯æ–‡æ¡£
- [ ] è¿ç»´æ‰‹å†Œ
- [ ] æ•…éšœæ’æŸ¥æŒ‡å—
- [ ] API æ–‡æ¡£

---

## 3. æŠ€æœ¯ç»†èŠ‚è§„åˆ’

### 3.1 æ•°æ®åº“è¿ç§»ç­–ç•¥

#### 3.1.1 é˜¶æ®µä¸€æ•°æ®åº“å˜æ›´

```sql
-- æ·»åŠ è¶…æ—¶å’ŒçŠ¶æ€æ§åˆ¶å­—æ®µ
ALTER TABLE diagnosis_reports ADD COLUMN should_stop_polling BOOLEAN DEFAULT 0;
ALTER TABLE diagnosis_reports ADD COLUMN timeout_at TIMESTAMP;

-- åˆ›å»º API è°ƒç”¨æ—¥å¿—è¡¨
CREATE TABLE api_call_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    execution_id TEXT NOT NULL,
    brand TEXT NOT NULL,
    question TEXT NOT NULL,
    model TEXT NOT NULL,
    request_data TEXT,
    response_data TEXT,
    error TEXT,
    latency_ms INTEGER,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_api_logs_execution ON api_call_logs(execution_id);
```

#### 3.1.2 é˜¶æ®µäºŒæ•°æ®åº“å˜æ›´

```sql
-- åˆ›å»º v2 æŠ¥å‘Šè¡¨
CREATE TABLE diagnosis_reports_v2 (...);

-- åˆ›å»ºè¯Šæ–­ç»“æœè¡¨ï¼ˆæ–°ç»“æ„ï¼‰
CREATE TABLE diagnosis_results_v2 (...);

-- åˆ›å»ºåˆ†ææ•°æ®è¡¨
CREATE TABLE diagnosis_analysis_v2 (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    report_id INTEGER,
    execution_id TEXT NOT NULL,
    analysis_type TEXT NOT NULL,
    analysis_data TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºè§†å›¾ï¼ˆå…¼å®¹å±‚ï¼‰
CREATE VIEW diagnosis_reports_current AS ...;
```

#### 3.1.3 é˜¶æ®µä¸‰æ•°æ®åº“å˜æ›´

```sql
-- æ·»åŠ æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_reports_status_progress ON diagnosis_reports(status, progress);
CREATE INDEX idx_reports_user_created ON diagnosis_reports(user_id, created_at);

-- æ·»åŠ ç¼“å­˜è¡¨
CREATE TABLE report_cache (
    execution_id TEXT PRIMARY KEY,
    report_data TEXT NOT NULL,
    cached_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NOT NULL
);
```

### 3.2 API ç‰ˆæœ¬ç®¡ç†

#### 3.2.1 ç‰ˆæœ¬è·¯ç”±

```python
# API ç‰ˆæœ¬è·¯ç”±é…ç½®

API_VERSIONS = {
    'v1': {
        'prefix': '/api',
        'routes': {
            'create_task': '/perform-brand-test',
            'get_status': '/test/status/<task_id>',
            'get_result': '/test/result/<task_id>',
        }
    },
    'v2': {
        'prefix': '/api/v2',
        'routes': {
            'create_task': '/diagnostic/tasks',
            'get_status': '/diagnostic/tasks/<task_id>/status',
            'get_report': '/diagnostic/tasks/<task_id>/report',
        }
    }
}

# ç»Ÿä¸€å…¥å£ï¼ˆæ ¹æ®ç‰¹æ€§å¼€å…³è·¯ç”±ï¼‰
@wechat_bp.route('/api/diagnostic/tasks', methods=['POST'])
def create_task_unified():
    if should_use_v2(get_user_id()):
        return create_task_v2()
    else:
        return create_task_v1()
```

#### 3.2.2 åºŸå¼ƒè®¡åˆ’

| API ç‰ˆæœ¬ | åºŸå¼ƒæ—¶é—´ | ä¸‹çº¿æ—¶é—´ | è¿ç§»æŒ‡å— |
|---------|---------|---------|---------|
| v1 | é˜¶æ®µäºŒå®Œæˆå | é˜¶æ®µå››å®Œæˆå | è¿ç§»åˆ° v2 API |

### 3.3 ç‰¹æ€§å¼€å…³è®¾è®¡

#### 3.3.1 å¼€å…³åˆ—è¡¨

```python
FEATURE_FLAGS = {
    # æ€»å¼€å…³
    'diagnosis_v2_enabled': False,
    
    # åŠŸèƒ½å¼€å…³
    'diagnosis_v2_state_machine': False,
    'diagnosis_v2_timeout': False,
    'diagnosis_v2_storage': False,
    'diagnosis_v2_statistics': False,
    'diagnosis_v2_websocket': False,
    
    # ç°åº¦æ§åˆ¶
    'diagnosis_v2_gray_users': [],
    'diagnosis_v2_gray_percentage': 0,
    
    # é™çº§å¼€å…³
    'diagnosis_v2_fallback_to_v1': True,
}
```

#### 3.3.2 å¼€å…³ç®¡ç† API

```python
@wechat_bp.route('/api/admin/feature-flags', methods=['GET', 'POST', 'PUT'])
@admin_required
def manage_feature_flags():
    """ç®¡ç†ç‰¹æ€§å¼€å…³"""
    
    if request.method == 'GET':
        return jsonify(FEATURE_FLAGS)
    
    elif request.method == 'POST':
        # åˆ›å»ºæ–°å¼€å…³
        data = request.get_json()
        create_feature_flag(data['key'], data['value'])
        return jsonify({'status': 'success'})
    
    elif request.method == 'PUT':
        # æ›´æ–°å¼€å…³
        data = request.get_json()
        update_feature_flag(data['key'], data['value'])
        return jsonify({'status': 'success'})
```

### 3.4 ç›‘æ§ä¸å‘Šè­¦

#### 3.4.1 å…³é”®æŒ‡æ ‡ç›‘æ§

| æŒ‡æ ‡åç§° | ç±»å‹ | é˜ˆå€¼ | å‘Šè­¦çº§åˆ« |
|---------|------|------|---------|
| è¯Šæ–­æˆåŠŸç‡ | ç™¾åˆ†æ¯” | < 90% | P1 |
| æŠ¥å‘Šç”Ÿæˆå»¶è¿Ÿ | ç§’ | > 600 | P1 |
| API é”™è¯¯ç‡ | ç™¾åˆ†æ¯” | > 5% | P1 |
| ä»»åŠ¡å¡æ­»ç‡ | ç™¾åˆ†æ¯” | > 2% | P0 |
| ç©ºæŠ¥å‘Šç‡ | ç™¾åˆ†æ¯” | > 10% | P1 |
| WebSocket è¿æ¥æ•° | è®¡æ•° | > 1000 | P2 |
| æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡ | ç™¾åˆ†æ¯” | > 80% | P2 |

#### 3.4.2 ç›‘æ§ä»ªè¡¨æ¿

```python
# ç›‘æ§ä»ªè¡¨æ¿ API
@wechat_bp.route('/api/monitoring/dashboard')
def monitoring_dashboard():
    """ç›‘æ§ä»ªè¡¨æ¿æ•°æ®"""
    return jsonify({
        'diagnosis_success_rate': get_diagnosis_success_rate(),
        'report_generation_latency': get_report_generation_latency(),
        'api_error_rate': get_api_error_rate(),
        'task_stuck_rate': get_task_stuck_rate(),
        'empty_report_rate': get_empty_report_rate(),
        'active_websocket_connections': get_websocket_connections(),
        'database_pool_usage': get_database_pool_usage(),
    })
```

---

## 4. é£é™©åº”å¯¹é¢„æ¡ˆ

### 4.1 ä¸å¯é€†é£é™©è¯†åˆ«

| é£é™©åœºæ™¯ | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ |
|---------|-------|------|---------|
| æ•°æ®åº“ Schema ä¸å…¼å®¹å˜æ›´ | ä½ | é«˜ | ä¸¥æ ¼å®¡æŸ¥æ‰€æœ‰æ•°æ®åº“å˜æ›´ï¼Œç¡®ä¿å‘åå…¼å®¹ |
| ç¬¬ä¸‰æ–¹ API ä¾èµ–å˜æ›´ | ä¸­ | é«˜ | é€‚é…å™¨å±‚éš”ç¦»ï¼Œå¿«é€Ÿå“åº”æ›´æ–° |
| æ•°æ®ä¸¢å¤± | ä½ | é«˜ | å¤šé‡å¤‡ä»½ï¼ŒWAL æ—¥å¿—ï¼Œå®šæœŸå¿«ç…§ |
| æ€§èƒ½ä¸¥é‡ä¸‹é™ | ä¸­ | ä¸­ | æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼Œç°åº¦å‘å¸ƒç›‘æ§ |

### 4.2 å…œåº•æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1: å®Œæ•´ç³»ç»Ÿå¿«ç…§**

```bash
# æ¯æ—¥å¿«ç…§è„šæœ¬
#!/bin/bash

# æ•°æ®åº“å¿«ç…§
sqlite3 /data/diagnosis.db ".backup '/data/backups/diagnosis_$(date +%Y%m%d_%H%M%S).db'"

# ä»£ç å¿«ç…§
git archive --format=tar --prefix=wechat-backend/ HEAD | gzip > /data/backups/code_$(date +%Y%m%d_%H%M%S).tar.gz

# æ–‡ä»¶å½’æ¡£å¿«ç…§
tar -czf /data/backups/files_$(date +%Y%m%d_%H%M%S).tar.gz /data/diagnosis/reports/

# ä¿ç•™æœ€è¿‘ 7 å¤©çš„å¿«ç…§
find /data/backups/ -mtime +7 -delete
```

**æ–¹æ¡ˆ 2: è“ç»¿éƒ¨ç½²**

```
ç”Ÿäº§ç¯å¢ƒ A (v1) â†â†’ è´Ÿè½½å‡è¡¡å™¨ â†â†’ ç”Ÿäº§ç¯å¢ƒ B (v2)

æ­£å¸¸æƒ…å†µï¼šæµé‡ 100% æŒ‡å‘ A
ç°åº¦æœŸé—´ï¼šæµé‡æŒ‰æ¯”ä¾‹åˆ†é…åˆ° A å’Œ B
å‡ºç°é—®é¢˜ï¼šæµé‡ 100% åˆ‡å› A
```

### 4.3 å†³ç­–æœºåˆ¶

#### 4.3.1 å›æ»šå†³ç­–æµç¨‹

```mermaid
graph TD
    A[å‘ç°é—®é¢˜] --> B{é—®é¢˜åˆ†çº§}
    B -->|P0 è‡´å‘½ | C[ç«‹å³å›æ»š]
    B -->|P1 ä¸¥é‡ | D[æš‚åœç°åº¦]
    B -->|P2 ä¸€èˆ¬ | E[è¯„ä¼°åå†³å®š]
    B -->|P3 è½»å¾® | F[æ­£å¸¸ä¿®å¤]
    
    C --> G[CTO æ‰¹å‡†]
    G --> H[æ‰§è¡Œå›æ»š]
    H --> I[é—®é¢˜å¤ç›˜]
    
    D --> J[æŠ€æœ¯æ€»ç›‘æ‰¹å‡†]
    J --> K{è¯„ä¼°ç»“æœ}
    K -->|ä¿®å¤å¯è¡Œ | L[ç»§ç»­ä¿®å¤]
    K -->|ä¿®å¤å›°éš¾ | C
    
    E --> M[äº§å“ç»ç†æ‰¹å‡†]
    M --> N{è¯„ä¼°ç»“æœ}
    N -->|ä¿®å¤å¯è¡Œ | L
    N -->|ä¿®å¤å›°éš¾ | J
```

#### 4.3.2 å†³ç­–äººæ¸…å•

| å†³ç­–ç±»å‹ | å†³ç­–äºº | å¤‡é€‰å†³ç­–äºº | è”ç³»æ–¹å¼ |
|---------|--------|-----------|---------|
| P0 å›æ»š | CTO | æŠ€æœ¯æ€»ç›‘ | ç”µè¯/å¾®ä¿¡ |
| P1 æš‚åœ | æŠ€æœ¯æ€»ç›‘ | äº§å“ç»ç† | ç”µè¯/å¾®ä¿¡ |
| P2 è¯„ä¼° | äº§å“ç»ç† | å¼€å‘è´Ÿè´£äºº | å¾®ä¿¡/é‚®ä»¶ |

---

## 5. éªŒæ”¶ä¸ä¸Šçº¿æ ‡å‡†

### 5.1 é˜¶æ®µé—¨æ§ Checklist

#### 5.1.1 é˜¶æ®µä¸€ä¸Šçº¿å‰

```markdown
## ä»£ç å®¡æŸ¥
- [ ] æ‰€æœ‰ä»£ç ç»è¿‡è‡³å°‘ 1 äºº Review
- [ ] å…³é”®ä»£ç ç»è¿‡ 2 äºº Review
- [ ] æ— ä¸¥é‡ä»£ç å¼‚å‘³

## æµ‹è¯•è¦†ç›–
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡ç‡ 100%
- [ ] æ—  P0/P1 Bug

## æ€§èƒ½åŸºå‡†
- [ ] å•ä»»åŠ¡æ‰§è¡Œæ—¶é—´ < 10 åˆ†é’Ÿ
- [ ] è¶…æ—¶æœºåˆ¶æ­£å¸¸å·¥ä½œ
- [ ] å†…å­˜ä½¿ç”¨ < 500MB

## æ–‡æ¡£
- [ ] API æ–‡æ¡£å·²æ›´æ–°
- [ ] éƒ¨ç½²æ–‡æ¡£å·²æ›´æ–°
- [ ] è¿ç»´æ‰‹å†Œå·²æ›´æ–°

## é¢„å‘å¸ƒéªŒè¯
- [ ] é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²æˆåŠŸ
- [ ] å†’çƒŸæµ‹è¯•é€šè¿‡
- [ ] äº§å“éªŒæ”¶é€šè¿‡
```

#### 5.1.2 é˜¶æ®µäºŒä¸Šçº¿å‰

```markdown
## ä»£ç å®¡æŸ¥
- [ ] æ‰€æœ‰ä»£ç ç»è¿‡è‡³å°‘ 1 äºº Review
- [ ] ç»Ÿè®¡ç®—æ³•ç»è¿‡æ•°æ®ä¸“å®¶ Review
- [ ] æ— ä¸¥é‡ä»£ç å¼‚å‘³

## æµ‹è¯•è¦†ç›–
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 85%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡ç‡ 100%
- [ ] æ•°æ®å‡†ç¡®æ€§æµ‹è¯•é€šè¿‡
- [ ] æ—  P0/P1 Bug

## æ€§èƒ½åŸºå‡†
- [ ] æŠ¥å‘Šç”Ÿæˆæ—¶é—´ < 30 ç§’
- [ ] ç»Ÿè®¡è®¡ç®—å‡†ç¡®ç‡ 100%
- [ ] æ•°æ®ä¸€è‡´æ€§ 100%

## æ–‡æ¡£
- [ ] ç»Ÿè®¡ç®—æ³•æ–‡æ¡£å·²ç¼–å†™
- [ ] æ•°æ®ç»“æ„æ–‡æ¡£å·²æ›´æ–°
- [ ] API æ–‡æ¡£å·²æ›´æ–°

## é¢„å‘å¸ƒéªŒè¯
- [ ] é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²æˆåŠŸ
- [ ] å†’çƒŸæµ‹è¯•é€šè¿‡
- [ ] äº§å“éªŒæ”¶é€šè¿‡
```

#### 5.1.3 é˜¶æ®µä¸‰ä¸Šçº¿å‰

```markdown
## ä»£ç å®¡æŸ¥
- [ ] æ‰€æœ‰ä»£ç ç»è¿‡è‡³å°‘ 1 äºº Review
- [ ] WebSocket ä»£ç ç»è¿‡å‹åŠ›æµ‹è¯•
- [ ] æ— ä¸¥é‡ä»£ç å¼‚å‘³

## æµ‹è¯•è¦†ç›–
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 85%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡ç‡ 100%
- [ ] å¼‚å¸¸åœºæ™¯æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] æ—  P0/P1 Bug

## æ€§èƒ½åŸºå‡†
- [ ] å¹¶å‘ 100 ç”¨æˆ·ï¼Œé”™è¯¯ç‡ < 1%
- [ ] WebSocket å»¶è¿Ÿ < 100ms
- [ ] ç¼“å­˜å‘½ä¸­ç‡ > 80%

## æ–‡æ¡£
- [ ] è¿ç»´æ‰‹å†Œå·²æ›´æ–°
- [ ] æ•…éšœæ’æŸ¥æŒ‡å—å·²ç¼–å†™
- [ ] ç›‘æ§å‘Šè­¦é…ç½®æ–‡æ¡£å·²ç¼–å†™

## é¢„å‘å¸ƒéªŒè¯
- [ ] é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²æˆåŠŸ
- [ ] å†’çƒŸæµ‹è¯•é€šè¿‡
- [ ] äº§å“éªŒæ”¶é€šè¿‡
- [ ] ç”¨æˆ·ä½“éªŒæµ‹è¯•é€šè¿‡
```

### 5.2 ç°åº¦å‘å¸ƒè®¡åˆ’

#### 5.2.1 ç°åº¦æµç¨‹

```mermaid
graph LR
    A[å†…éƒ¨æµ‹è¯•] --> B[ç§å­ç”¨æˆ· 5-10 äºº]
    B --> C{éªŒè¯é€šè¿‡ï¼Ÿ}
    C -->|æ˜¯ | D[1% ç”¨æˆ·]
    C -->|å¦ | E[ä¿®å¤é—®é¢˜]
    E --> B
    D --> F{ç›‘æ§æŒ‡æ ‡æ­£å¸¸ï¼Ÿ}
    F -->|æ˜¯ | G[10% ç”¨æˆ·]
    F -->|å¦ | H[æš‚åœç°åº¦]
    G --> I{ç›‘æ§æŒ‡æ ‡æ­£å¸¸ï¼Ÿ}
    I -->|æ˜¯ | J[50% ç”¨æˆ·]
    I -->|å¦ | H
    J --> K{ç›‘æ§æŒ‡æ ‡æ­£å¸¸ï¼Ÿ}
    K -->|æ˜¯ | L[100% ç”¨æˆ·]
    K -->|å¦ | H
```

#### 5.2.2 ç°åº¦ç›‘æ§æŒ‡æ ‡

| é˜¶æ®µ | ç”¨æˆ·æ¯”ä¾‹ | ç›‘æ§æ—¶é•¿ | å…³é”®æŒ‡æ ‡ | é€šè¿‡æ ‡å‡† |
|------|---------|---------|---------|---------|
| å†…éƒ¨æµ‹è¯• | 0% | 1 å¤© | åŠŸèƒ½å¯ç”¨æ€§ | 100% å¯ç”¨ |
| ç§å­ç”¨æˆ· | <0.1% | 2 å¤© | ç”¨æˆ·åé¦ˆ | æ— ä¸¥é‡é—®é¢˜ |
| 1% ç°åº¦ | 1% | 1 å¤© | é”™è¯¯ç‡ < 5% | é”™è¯¯ç‡ < 2% |
| 10% ç°åº¦ | 10% | 2 å¤© | é”™è¯¯ç‡ < 3% | é”™è¯¯ç‡ < 1% |
| 50% ç°åº¦ | 50% | 2 å¤© | é”™è¯¯ç‡ < 2% | é”™è¯¯ç‡ < 1% |
| 100% å‘å¸ƒ | 100% | æŒç»­ | é”™è¯¯ç‡ < 1% | é”™è¯¯ç‡ < 0.5% |

### 5.3 ç”¨æˆ·æ²Ÿé€šç­–ç•¥

#### 5.3.1 å‘å¸ƒå…¬å‘Šæ¨¡æ¿

```markdown
# ç³»ç»Ÿå‡çº§å…¬å‘Š

å°Šæ•¬çš„ç”¨æˆ·ï¼š

ä¸ºäº†æä¾›æ›´å¥½çš„æœåŠ¡ï¼Œæˆ‘ä»¬å°†äº **YYYY-MM-DD HH:MM** è¿›è¡Œç³»ç»Ÿå‡çº§ã€‚

## å‡çº§å†…å®¹
- ä¼˜åŒ–è¯Šæ–­ä»»åŠ¡æ‰§è¡Œæµç¨‹ï¼Œè§£å†³å¡æ­»é—®é¢˜
- æ–°å¢çœŸå®æ•°æ®ç»Ÿè®¡åˆ†ææŠ¥å‘Š
- æå‡ç³»ç»Ÿç¨³å®šæ€§å’Œå“åº”é€Ÿåº¦

## å½±å“èŒƒå›´
- å‡çº§æœŸé—´ï¼Œè¯Šæ–­åŠŸèƒ½å¯èƒ½æš‚æ—¶ä¸å¯ç”¨
- é¢„è®¡å½±å“æ—¶é•¿ï¼š30 åˆ†é’Ÿ

## å‡çº§æ—¶é—´
- å¼€å§‹æ—¶é—´ï¼šYYYY-MM-DD HH:MM
- é¢„è®¡å®Œæˆï¼šYYYY-MM-DD HH:MM

## æ³¨æ„äº‹é¡¹
- å»ºè®®æ‚¨é¿å¼€å‡çº§æ—¶æ®µè¿›è¡Œè¯Šæ–­æ“ä½œ
- å‡çº§åï¼Œå†å²è®°å½•å¯èƒ½éœ€è¦å‡ åˆ†é’ŸåŒæ­¥

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·è”ç³»å®¢æœã€‚

æ„Ÿè°¢æ‚¨çš„ç†è§£ä¸æ”¯æŒï¼

äº§å“å›¢é˜Ÿ
YYYY-MM-DD
```

#### 5.3.2 æ›´æ–°æ—¥å¿—

```markdown
# æ›´æ–°æ—¥å¿—

## v2.0.0-phase1 (YYYY-MM-DD)

### æ–°å¢
- è¯Šæ–­ä»»åŠ¡è¶…æ—¶ä¿æŠ¤æœºåˆ¶
- API è°ƒç”¨æ—¥å¿—è®°å½•
- æŠ¥å‘Šå­˜æ ¹åŠŸèƒ½

### ä¼˜åŒ–
- çŠ¶æ€è½®è¯¢é€»è¾‘ä¼˜åŒ–
- é”™è¯¯å¤„ç†ä¼˜åŒ–

### ä¿®å¤
- ä¿®å¤è¯Šæ–­å¡æ­»é—®é¢˜
- ä¿®å¤å†å²è®°å½•ä¸ºç©ºé—®é¢˜

## v2.0.0-phase2 (YYYY-MM-DD)

### æ–°å¢
- å“ç‰Œé¢‘æ®µåˆ†å¸ƒç»Ÿè®¡
- æƒ…æ„Ÿå€¾å‘åˆ†å¸ƒç»Ÿè®¡
- çœŸå® API æ•°æ®æŠ¥å‘Š

### ä¼˜åŒ–
- æŠ¥å‘Šæ•°æ®ç»“æ„ä¼˜åŒ–
- å‰ç«¯æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–

## v2.0.0-phase3 (YYYY-MM-DD)

### æ–°å¢
- WebSocket å®æ—¶è¿›åº¦æ¨é€
- å¼‚å¸¸åœºæ™¯å‹å¥½æç¤º
- è‡ªåŠ¨åŒ–ç›‘æ§å‘Šè­¦

### ä¼˜åŒ–
- å¹¶å‘æ€§èƒ½ä¼˜åŒ–
- ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

## v2.0.0 (YYYY-MM-DD)

### æ–°å¢
- å®Œæ•´çš„ç»Ÿè®¡åˆ†ææŠ¥å‘Š
- å®æ—¶è¿›åº¦åé¦ˆ
- å†å²æ•°æ®ä¿®å¤

### ä¼˜åŒ–
- å…¨é¢æ€§èƒ½ä¼˜åŒ–
- ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### ä¿®å¤
- æ‰€æœ‰å·²çŸ¥é—®é¢˜ä¿®å¤
```

#### 5.3.3 åŠŸèƒ½è¯´æ˜æ–‡æ¡£

```markdown
# å“ç‰Œè¯Šæ–­åŠŸèƒ½è¯´æ˜

## ä»€ä¹ˆæ˜¯å“ç‰Œè¯Šæ–­ï¼Ÿ

å“ç‰Œè¯Šæ–­åŠŸèƒ½é€šè¿‡åˆ†ææ‚¨çš„å“ç‰Œåœ¨ä¸»æµ AI å¹³å°çš„éœ²å‡ºæƒ…å†µï¼Œå¸®åŠ©æ‚¨äº†è§£å“ç‰Œåœ¨ AI æ—¶ä»£çš„è®¤çŸ¥çŠ¶å†µã€‚

## å¦‚ä½•ä½¿ç”¨ï¼Ÿ

1. è¾“å…¥æ‚¨çš„å“ç‰Œåç§°
2. ï¼ˆå¯é€‰ï¼‰æ·»åŠ ç«å“å“ç‰Œ
3. é€‰æ‹©è¦åˆ†æçš„ AI å¹³å°
4. è¾“å…¥è¯Šæ–­é—®é¢˜
5. ç‚¹å‡»"å¼€å§‹è¯Šæ–­"

## è¯Šæ–­æŠ¥å‘ŠåŒ…å«ä»€ä¹ˆï¼Ÿ

- **å“ç‰Œé¢‘æ®µåˆ†å¸ƒ**: å„ AI å¹³å°å¯¹æ‚¨å“ç‰Œçš„éœ²å‡ºå æ¯”
- **æƒ…æ„Ÿå€¾å‘åˆ†æ**: AI å¯¹æ‚¨å“ç‰Œçš„æƒ…æ„Ÿè¯„ä»·ï¼ˆæ­£é¢/ä¸­æ€§/è´Ÿé¢ï¼‰
- **å…³é”®è¯äº‘**: ä¸æ‚¨çš„å“ç‰Œå…³è”çš„é«˜é¢‘å…³é”®è¯
- **åŸå§‹æ•°æ®**: æ¯ä¸ª AI å¹³å°çš„å®Œæ•´å“åº”å†…å®¹

## è¯Šæ–­éœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ

é€šå¸¸éœ€è¦ 3-5 åˆ†é’Ÿï¼Œå…·ä½“å–å†³äºé€‰æ‹©çš„ AI å¹³å°æ•°é‡ã€‚

## è¯Šæ–­å®Œæˆåå¦‚ä½•æŸ¥çœ‹æŠ¥å‘Šï¼Ÿ

è¯Šæ–­å®Œæˆåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è·³è½¬åˆ°æŠ¥å‘Šé¡µé¢ã€‚æ‚¨ä¹Ÿå¯ä»¥åœ¨"å†å²è®°å½•"ä¸­éšæ—¶æŸ¥çœ‹è¿‡å¾€è¯Šæ–­æŠ¥å‘Šã€‚
```

---

## é™„å½•

### A. é¡¹ç›®ç»„ç»‡æ¶æ„

| è§’è‰² | äººå‘˜ | èŒè´£ |
|------|------|------|
| **é¦–å¸­æ¶æ„å¸ˆ** | XXX | æ•´ä½“æŠ€æœ¯æ¶æ„ã€å…³é”®å†³ç­– |
| **åç«¯è´Ÿè´£äºº** | XXX | åç«¯å¼€å‘ã€ä»£ç  Review |
| **å‰ç«¯è´Ÿè´£äºº** | XXX | å‰ç«¯å¼€å‘ã€ç”¨æˆ·ä½“éªŒ |
| **æ•°æ®ä¸“å®¶** | XXX | ç»Ÿè®¡ç®—æ³•ã€æ•°æ®å‡†ç¡®æ€§ |
| **æµ‹è¯•è´Ÿè´£äºº** | XXX | æµ‹è¯•ç­–ç•¥ã€è´¨é‡ä¿éšœ |
| **äº§å“ç»ç†** | XXX | éœ€æ±‚ç®¡ç†ã€ç”¨æˆ·æ²Ÿé€š |
| **è¿ç»´å·¥ç¨‹å¸ˆ** | XXX | éƒ¨ç½²ã€ç›‘æ§ã€å‘Šè­¦ |

### B. æ²Ÿé€šæœºåˆ¶

| ä¼šè®®ç±»å‹ | é¢‘ç‡ | å‚ä¸äºº | è®®ç¨‹ |
|---------|------|--------|------|
| ç«™ä¼š | æ¯å¤© 10:00 | å…¨ä½“å¼€å‘ | æ˜¨æ—¥è¿›å±•ã€ä»Šæ—¥è®¡åˆ’ã€é˜»å¡é—®é¢˜ |
| å‘¨ä¼š | æ¯å‘¨ä¸€ 14:00 | å…¨ä½“ + äº§å“ | å‘¨è®¡åˆ’ã€é£é™©åŒæ­¥ã€å†³ç­–äº‹é¡¹ |
| è¯„å®¡ä¼š | æ¯é˜¶æ®µç»“æŸ | å…¨ä½“ + äº§å“ | é˜¶æ®µæˆæœæ¼”ç¤ºã€éªŒæ”¶ |
| å¤ç›˜ä¼š | æ¯é˜¶æ®µç»“æŸ | å…¨ä½“ | ç»éªŒæ€»ç»“ã€æ”¹è¿›æªæ–½ |

### C. å…³é”®æ—¶é—´èŠ‚ç‚¹

| èŠ‚ç‚¹ | æ—¥æœŸ | äº¤ä»˜ç‰© |
|------|------|--------|
| é˜¶æ®µä¸€å¯åŠ¨ | Week 1 å‘¨ä¸€ | å¼€å‘ç¯å¢ƒå°±ç»ª |
| é˜¶æ®µä¸€å®Œæˆ | Week 2 å‘¨äº” | å¯ä¸Šçº¿ç‰ˆæœ¬ |
| é˜¶æ®µäºŒå¯åŠ¨ | Week 3 å‘¨ä¸€ | å¼€å‘ç¯å¢ƒå°±ç»ª |
| é˜¶æ®µäºŒå®Œæˆ | Week 5 å‘¨äº” | å¯ä¸Šçº¿ç‰ˆæœ¬ |
| é˜¶æ®µä¸‰å¯åŠ¨ | Week 6 å‘¨ä¸€ | å¼€å‘ç¯å¢ƒå°±ç»ª |
| é˜¶æ®µä¸‰å®Œæˆ | Week 7 å‘¨äº” | å¯ä¸Šçº¿ç‰ˆæœ¬ |
| é˜¶æ®µå››å¯åŠ¨ | Week 8 å‘¨ä¸€ | å¼€å‘ç¯å¢ƒå°±ç»ª |
| é‡æ„å®Œæˆ | Week 8 å‘¨äº” | ç”Ÿäº§ç‰ˆæœ¬ v2.0.0 |

### D. èµ„æºéœ€æ±‚

| èµ„æºç±»å‹ | æ•°é‡ | ç”¨é€” |
|---------|------|------|
| å¼€å‘äººå‘˜ | 4-5 äºº | åç«¯ 2 äººã€å‰ç«¯ 1 äººã€æ•°æ® 1 äººã€æµ‹è¯• 1 äºº |
| æœåŠ¡å™¨ | 2 å° | é¢„å‘å¸ƒç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒï¼ˆè“ç»¿éƒ¨ç½²ï¼‰ |
| Redis | 1 ä¸ª | ç¼“å­˜ã€WebSocket ä¼šè¯ç®¡ç† |
| ç›‘æ§å·¥å…· | 1 å¥— | Prometheus + Grafana |

---

**æ–‡æ¡£ç»“æŸ**

---

## ç­¾å­—ç¡®è®¤

| è§’è‰² | äººå‘˜ | ç­¾å­— | æ—¥æœŸ |
|------|------|------|------|
| **é¦–å¸­æ¶æ„å¸ˆ** | | ___________ | ___________ |
| **æŠ€æœ¯æ€»ç›‘** | | ___________ | ___________ |
| **äº§å“ç»ç†** | | ___________ | ___________ |
| **é¡¹ç›®ç»ç†** | | ___________ | ___________ |

---

**é‡æ„å¯åŠ¨æ—¥æœŸ**: 2026-02-28 (Week 1 å‘¨ä¸€)  
**é¢„è®¡å®Œæˆæ—¥æœŸ**: 2026-04-25 (Week 8 å‘¨äº”)  
**æ€»ä¼°ç®—**: 145 äººæ—¥

