# 情报枢纽——自动化报告与高管视角 功能文档

## 概述

情报枢纽系统通过聚合 TestResult、CruiseTrend 和 WorkflowTask 数据，计算品牌 GEO 运营的 ROI，并提供自动化报告和高管视角。

## 核心组件

### ReportGenerator 类

报告生成器是整个系统的核心，负责聚合数据、计算 ROI 和生成报告。

#### 主要方法

1. `generate_executive_summary()` - 生成高管摘要报告
2. `get_hub_summary()` - 获取枢纽摘要数据
3. `generate_pdf_report()` - 生成PDF报告
4. `_calculate_roi_metrics()` - 计算ROI指标
5. `_calculate_exposure_increment()` - 计算预估曝光增量
6. `_calculate_ranking_improvement()` - 计算排名改善程度

### 数据聚合逻辑

系统聚合以下数据源：
- **TestResult**: 品牌测试结果，包含整体分数、AI模型使用情况等
- **CruiseTrend**: 巡航趋势数据，包含排名变化、情感分数等
- **WorkflowTask**: 工作流任务数据（预留接口）

## 功能特性

### 1. ROI 计算

系统计算品牌 GEO 运营的投资回报率：
- **投资价值**: 基于测试数量和复杂度
- **回报价值**: 基于排名提升和曝光增加
- **ROI 百分比**: (回报价值 - 投资价值) / 投资价值 * 100
- **置信度**: 基于数据完整性

### 2. 颴估曝光增量

系统计算由于排位上升带来的"预估曝光增量"：
- 基于排名改善程度
- 排名每提升1位，曝光增量约为10%
- 负向排名变化不计入曝光增量

### 3. 关键指标

- **ROI得分**: 0-100分制的品牌运营效果评分
- **排名改善**: 排名变化的数值（正数表示提升）
- **情感趋势**: 情感分数的变化方向和幅度
- **平均分数**: 测试结果的平均整体分数

## API 接口

### GET /hub/summary

获取枢纽摘要数据

**参数**:
- `brand_name` (必需): 品牌名称
- `days` (可选): 查询天数，默认7天，最大365天

**响应**:
```json
{
  "status": "success",
  "summary": {
    "brand_name": "TechBrand",
    "summary_period": {
      "start_date": "2023-01-01T00:00:00",
      "end_date": "2023-01-08T00:00:00",
      "days": 7
    },
    "metrics": {
      "roi_score": 75.5,
      "roi_percentage": 15.2,
      "estimated_exposure_increment": 12.5,
      "ranking_improvement": 3,
      "average_overall_score": 82.4,
      "test_count": 5,
      "trend_data_points": 10
    },
    "status": "success",
    "message": "数据获取成功"
  }
}
```

### GET /reports/executive

获取高管视角报告

**参数**:
- `brand_name` (必需): 品牌名称
- `days` (可选): 查询天数，默认30天，最大365天

**响应**:
```json
{
  "status": "success",
  "report": {
    "brand_name": "TechBrand",
    "report_period": {
      "start_date": "2023-01-01T00:00:00",
      "end_date": "2023-01-31T00:00:00",
      "days": 30
    },
    "roi_metrics": {
      "roi_score": 75.5,
      "investment_value": 5000.0,
      "return_value": 5760.0,
      "roi_percentage": 15.2,
      "confidence_level": "high"
    },
    "exposure_metrics": {
      "estimated_exposure_increment": 12.5,
      "ranking_improvement": 3,
      "sentiment_trend": {
        "average_sentiment": 0.75,
        "trend_direction": "improving",
        "change_magnitude": 0.15
      }
    },
    "performance_summary": {
      "avg_overall_score": 82.4,
      "test_count": 5,
      "trend_data_points": 10
    },
    "key_insights": [
      "品牌认知度表现优异，平均得分为82.4分",
      "品牌排名有所提升，改善了3位",
      "预估曝光量增加了12.5%"
    ],
    "recommendations": [
      {
        "type": "ranking_improvement",
        "title": "排名优化建议",
        "description": "当前品牌排名呈上升趋势，建议维持现有策略并扩大优势",
        "priority": "low"
      }
    ]
  }
}
```

### GET /reports/pdf

下载PDF格式的报告

**参数**:
- `brand_name` (必需): 品牌名称
- `days` (可选): 查询天数，默认30天，最大365天

**响应**: PDF文件下载

## 定时任务

系统支持每周日晚间自动生成PDF报告：
- 通过调度器定期执行报告生成
- 生成的报告保存到指定目录
- 更新 hub/summary 数据

## 数据处理逻辑

### 排名改善计算
- 获取最早和最新的排名数据
- 计算排名改善 = 初始排名 - 最终排名
- 数值越小表示排名越高

### 曝光增量计算
- 基于排名改善程度计算
- 排名每提升1位，曝光增量约为10%
- 只计算正向改善带来的曝光增量

### ROI 计算公式
```
投资价值 = 测试数量 × 100
回报价值 = (排名改善 × 500) + (曝光增量 × 10)
ROI百分比 = (回报价值 - 投资价值) / 投资价值 × 100
```

## 错误处理

### 数据缺失处理
- 当无测试结果数据时，返回合理的默认值
- 当无趋势数据时，返回零值指标
- 当数据库连接失败时，返回错误状态

### 参数验证
- 验证品牌名称的有效性
- 验证天数范围（1-365天）
- 防止SQL注入和其他安全漏洞

## 性能指标

- **报告生成时间**: <2秒 (取决于数据量)
- **API响应时间**: <500毫秒
- **内存占用**: <100MB (单次生成)

## 监控和日志

系统记录以下关键事件：
- API请求和响应
- 数据聚合过程
- ROI计算结果
- PDF生成状态

## 配置选项

- `default_summary_days`: 默认摘要天数 (7天)
- `default_report_days`: 默认报告天数 (30天)
- `exposure_increment_multiplier`: 曝光增量乘数 (10%)

## 安全考虑

- 输入参数验证和清理
- SQL注入防护
- 文件下载安全验证
- API访问频率限制

## 故障排除

### 报告生成失败
1. 检查数据库连接状态
2. 验证品牌名称是否存在
3. 确认查询天数在有效范围内

### ROI计算异常
1. 检查测试结果数据完整性
2. 验证趋势数据格式
3. 确认排名数据有效性