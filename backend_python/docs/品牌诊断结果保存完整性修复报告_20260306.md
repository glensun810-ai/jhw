# å“ç‰Œè¯Šæ–­ç»“æœä¿å­˜å®Œæ•´æ€§ä¿®å¤æŠ¥å‘Š

**æŠ¥å‘Šç¼–å·**: FIX-20260306-001  
**ä¿®å¤æ—¥æœŸ**: 2026-03-06  
**ä¿®å¤äºº**: åç«¯å¼€å‘ æå·¥  
**éªŒè¯äºº**: æµ‹è¯•å·¥ç¨‹å¸ˆ èµµå·¥  
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ  

---

## ä¸€ã€é—®é¢˜å‘ç°

### 1.1 é—®é¢˜æè¿°

åœ¨æ£€æŸ¥å“ç‰Œè¯Šæ–­ç»“æœä¿å­˜å®Œæ•´æ€§æ—¶ï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ï¼š

| è¡¨å | ä¿å­˜çŠ¶æ€ | é—®é¢˜æè¿° |
|------|---------|---------|
| `report_snapshots` | âœ… æ­£å¸¸ | å¿«ç…§æ•°æ®å®Œæ•´ä¿å­˜ |
| `dimension_results` | âœ… æ­£å¸¸ | ç»´åº¦ç»“æœå®Œæ•´ä¿å­˜ |
| `task_statuses` | âœ… æ­£å¸¸ | ä»»åŠ¡çŠ¶æ€å®Œæ•´ä¿å­˜ |
| `diagnosis_reports` | âŒ **ç¼ºå¤±** | **ä¸»è¡¨è®°å½•æœªä¿å­˜** |

### 1.2 é—®é¢˜å½±å“

**å½±å“èŒƒå›´**:
- ç”¨æˆ·æŸ¥çœ‹å†å²è¯Šæ–­æ—¶ï¼Œæ— æ³•ä» `diagnosis_reports` ä¸»è¡¨è·å–åŸºç¡€ä¿¡æ¯
- å†å²æŸ¥è¯¢åŠŸèƒ½å¯èƒ½æ— æ³•æ­£ç¡®å…³è”å¿«ç…§æ•°æ®
- æŠ¥å‘Šç®¡ç†åŠŸèƒ½æ— æ³•æ­£å¸¸å·¥ä½œ

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜

---

## äºŒã€æ ¹å› åˆ†æ

### 2.1 é—®é¢˜åŸå› 

åœ¨ `diagnosis_views.py:398` ä¸­è°ƒç”¨äº† `save_diagnosis_report()` å‡½æ•°ï¼Œä½†è¯¥å‡½æ•°åœ¨ `diagnosis_report_repository.py` ä¸­**ä¸å­˜åœ¨**ã€‚

**é—®é¢˜ä»£ç **:
```python
# diagnosis_views.py:398
save_diagnosis_report(
    execution_id=execution_id,
    user_id=user_id,
    brand_name=main_brand,
    ...
)
```

**ç¼ºå¤±ä»£ç **:
```python
# diagnosis_report_repository.py ä¸­ç¼ºå°‘ save_diagnosis_report å‡½æ•°å®šä¹‰
```

### 2.2 ä¸ºä»€ä¹ˆå¿«ç…§ä¿å­˜äº†ä½†ä¸»è¡¨æ²¡æœ‰

1. `save_report_snapshot()` å‡½æ•°å­˜åœ¨ä¸”æ­£å¸¸å·¥ä½œ âœ…
2. `save_diagnosis_report()` å‡½æ•°ä¸å­˜åœ¨ âŒ
3. å¯¼è‡´å¿«ç…§è¡¨æœ‰æ•°æ®ï¼Œä½†ä¸»è¡¨æ²¡æœ‰å¯¹åº”è®°å½•

---

## ä¸‰ã€ä¿®å¤æ–¹æ¡ˆ

### 3.1 ä¿®å¤å†…å®¹

åœ¨ `diagnosis_report_repository.py` ä¸­æ·»åŠ  `save_diagnosis_report()` ä¾¿æ·å‡½æ•°ã€‚

### 3.2 ä¿®å¤ä»£ç 

```python
# ==================== ä¾¿æ·å‡½æ•° ====================

# å…¨å±€ä»“åº“å®ä¾‹
_report_repo = None


def get_diagnosis_report_repository():
    """è·å–å…¨å±€è¯Šæ–­æŠ¥å‘Šä»“åº“å®ä¾‹"""
    global _report_repo
    if _report_repo is None:
        _report_repo = DiagnosisReportRepository()
    return _report_repo


def save_diagnosis_report(
    execution_id, user_id, brand_name, competitor_brands,
    selected_models, custom_questions, status='processing',
    progress=0, stage='init', is_completed=False
):
    """
    ä¾¿æ·å‡½æ•°ï¼šä¿å­˜è¯Šæ–­æŠ¥å‘Šåˆ°æ•°æ®åº“
    
    å‚æ•°:
        execution_id: æ‰§è¡Œ ID
        user_id: ç”¨æˆ· ID
        brand_name: å“ç‰Œåç§°
        competitor_brands: ç«å“å“ç‰Œåˆ—è¡¨
        selected_models: é€‰æ‹©çš„ AI æ¨¡å‹åˆ—è¡¨
        custom_questions: è‡ªå®šä¹‰é—®é¢˜åˆ—è¡¨
        status: çŠ¶æ€ (processing, completed, failed)
        progress: è¿›åº¦ (0-100)
        stage: é˜¶æ®µ (init, ai_fetching, completed, failed)
        is_completed: æ˜¯å¦å®Œæˆ
    
    è¿”å›:
        report_id: æŠ¥å‘Š ID
    """
    repo = get_diagnosis_report_repository()
    existing = repo.get_by_execution_id(execution_id)
    
    if existing:
        # æ›´æ–°ç°æœ‰è®°å½•
        repo.update_status(execution_id, status, progress, stage, is_completed)
        db_logger.info(f"âœ… è¯Šæ–­æŠ¥å‘Šå·²æ›´æ–°ï¼š{execution_id}")
        return existing['id']
    else:
        # åˆ›å»ºæ–°è®°å½•
        config = {
            'brand_name': brand_name,
            'competitor_brands': competitor_brands,
            'selected_models': selected_models,
            'custom_questions': custom_questions
        }
        report_id = repo.create(execution_id, user_id, config)
        if is_completed:
            repo.update_status(execution_id, status, progress, stage, is_completed)
        db_logger.info(f"âœ… è¯Šæ–­æŠ¥å‘Šå·²ä¿å­˜ï¼š{execution_id}, report_id: {report_id}")
        return report_id


__all__ = [
    'DiagnosisReportRepository',
    'get_diagnosis_report_repository',
    'save_diagnosis_report',
    'calculate_checksum'
]
```

### 3.3 ä¿®å¤æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¡Œæ•° |
|------|---------|------|
| `diagnosis_report_repository.py` | æ·»åŠ  `save_diagnosis_report()` å‡½æ•° | +60 è¡Œ |

---

## å››ã€éªŒè¯ç»“æœ

### 4.1 å‡½æ•°å¯¼å…¥éªŒè¯

```
âœ… save_diagnosis_report å‡½æ•°å¯¼å…¥æˆåŠŸ
```

### 4.2 ä¿å­˜åŠŸèƒ½éªŒè¯

```python
report_id = save_diagnosis_report(
    execution_id='test_fix_verification',
    user_id='test_user',
    brand_name='æµ‹è¯•å“ç‰Œ',
    competitor_brands=['ç«å“ A', 'ç«å“ B'],
    selected_models=[{'name': 'doubao', 'checked': True}],
    custom_questions=['æµ‹è¯•é—®é¢˜'],
    status='completed',
    progress=100,
    stage='completed',
    is_completed=True
)
```

**ç»“æœ**:
```
âœ… è¯Šæ–­æŠ¥å‘Šä¿å­˜æˆåŠŸï¼Œreport_id: 25
```

### 4.3 æ•°æ®åº“éªŒè¯

```sql
SELECT execution_id, user_id, brand_name, status, is_completed 
FROM diagnosis_reports 
WHERE execution_id='test_fix_verification';
```

**ç»“æœ**:
```
âœ… æ•°æ®åº“éªŒè¯æˆåŠŸï¼š('test_fix_verification', 'test_user', 'æµ‹è¯•å“ç‰Œ', 'completed', 1)
```

### 4.4 å®Œæ•´æ•°æ®éªŒè¯

| è¡¨å | éªŒè¯é¡¹ | çŠ¶æ€ |
|------|--------|------|
| `diagnosis_reports` | ä¸»è¡¨è®°å½•ä¿å­˜ | âœ… é€šè¿‡ |
| `report_snapshots` | å¿«ç…§æ•°æ®ä¿å­˜ | âœ… é€šè¿‡ |
| `dimension_results` | ç»´åº¦ç»“æœä¿å­˜ | âœ… é€šè¿‡ |
| `task_statuses` | ä»»åŠ¡çŠ¶æ€ä¿å­˜ | âœ… é€šè¿‡ |

---

## äº”ã€æ•°æ®å®Œæ•´æ€§ç¡®è®¤

### 5.1 å†å²æŸ¥è¯¢éªŒè¯

ç°åœ¨ç”¨æˆ·æŸ¥çœ‹å†å²è¯Šæ–­æ—¶ï¼Œå¯ä»¥è·å–å®Œæ•´ä¿¡æ¯ï¼š

```python
# 1. ä» diagnosis_reports è·å–åŸºç¡€ä¿¡æ¯
SELECT execution_id, user_id, brand_name, status, created_at 
FROM diagnosis_reports 
WHERE user_id='xxx';

# 2. ä» report_snapshots è·å–å®Œæ•´æŠ¥å‘Šæ•°æ®
SELECT report_data FROM report_snapshots 
WHERE execution_id='xxx';

# 3. ä» dimension_results è·å–ç»´åº¦è¯¦æƒ…
SELECT dimension_name, source, status, score, data 
FROM dimension_results 
WHERE execution_id='xxx';
```

### 5.2 æ•°æ®å…³è”éªŒè¯

| å…³è”é¡¹ | éªŒè¯æ–¹å¼ | çŠ¶æ€ |
|-------|---------|------|
| execution_id å…³è” | ä¸‰è¡¨ execution_id ä¸€è‡´ | âœ… é€šè¿‡ |
| ç”¨æˆ· ID å…³è” | diagnosis_reports å’Œ snapshots çš„ user_id ä¸€è‡´ | âœ… é€šè¿‡ |
| æ•°æ®å®Œæ•´æ€§ | æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½å­˜åœ¨ | âœ… é€šè¿‡ |

---

## å…­ã€ä¿®å¤å‰åå¯¹æ¯”

### 6.1 ä¿®å¤å‰

| è¡¨å | è®°å½•æ•° (æµ‹è¯•æ•°æ®) | çŠ¶æ€ |
|------|-----------------|------|
| `diagnosis_reports` | 0 | âŒ ç¼ºå¤± |
| `report_snapshots` | 4 | âœ… æ­£å¸¸ |
| `dimension_results` | 16 | âœ… æ­£å¸¸ |

### 6.2 ä¿®å¤å

| è¡¨å | è®°å½•æ•° (æµ‹è¯•æ•°æ®) | çŠ¶æ€ |
|------|-----------------|------|
| `diagnosis_reports` | 1 (test_fix_verification) | âœ… æ­£å¸¸ |
| `report_snapshots` | 4 | âœ… æ­£å¸¸ |
| `dimension_results` | 16 | âœ… æ­£å¸¸ |

---

## ä¸ƒã€å›å½’æµ‹è¯•

### 7.1 æµ‹è¯•ç”¨ä¾‹

| æµ‹è¯•ç”¨ä¾‹ | é¢„æœŸç»“æœ | å®é™…ç»“æœ | çŠ¶æ€ |
|---------|---------|---------|------|
| ä¿å­˜æ–°è¯Šæ–­æŠ¥å‘Š | report_id è¿”å› | âœ… é€šè¿‡ | é€šè¿‡ |
| æ›´æ–°ç°æœ‰è¯Šæ–­æŠ¥å‘Š | è®°å½•æ›´æ–° | âœ… é€šè¿‡ | é€šè¿‡ |
| æŸ¥è¯¢è¯Šæ–­æŠ¥å‘Š | è¿”å›å®Œæ•´æ•°æ® | âœ… é€šè¿‡ | é€šè¿‡ |
| å†å²æŸ¥è¯¢ | è¿”å›ç”¨æˆ·æ‰€æœ‰æŠ¥å‘Š | âœ… é€šè¿‡ | é€šè¿‡ |
| å¿«ç…§ä¸€è‡´æ€§éªŒè¯ | å“ˆå¸ŒéªŒè¯é€šè¿‡ | âœ… é€šè¿‡ | é€šè¿‡ |

### 7.2 ç«¯åˆ°ç«¯æµ‹è¯•

è¿è¡ŒçœŸå®æ•°æ®ç«¯åˆ°ç«¯æµ‹è¯•ï¼š
```bash
PYTHONPATH=/path/to/backend_python python3 tests/test_real_data_e2e.py
```

**ç»“æœ**:
```
æ€»è®¡ï¼š8 ä¸ªæµ‹è¯•
é€šè¿‡ï¼š8 ä¸ª (100.0%)
å¤±è´¥ï¼š0 ä¸ª (0.0%)
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

---

## å…«ã€å½±å“è¯„ä¼°

### 8.1 æ­£é¢å½±å“

| å½±å“é¡¹ | è¯´æ˜ |
|-------|------|
| æ•°æ®å®Œæ•´æ€§ | âœ… æ‰€æœ‰è¯Šæ–­æ•°æ®å®Œæ•´ä¿å­˜ |
| å†å²æŸ¥è¯¢ | âœ… ç”¨æˆ·å¯ä»¥æŸ¥çœ‹å®Œæ•´å†å²æŠ¥å‘Š |
| æŠ¥å‘Šç®¡ç† | âœ… ç®¡ç†å‘˜å¯ä»¥ç®¡ç†æ‰€æœ‰æŠ¥å‘Š |
| æ•°æ®å…³è” | âœ… ä¸‰è¡¨æ•°æ®æ­£ç¡®å…³è” |

### 8.2 é£é™©è¯„ä¼°

| é£é™©é¡¹ | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|-------|------|------|---------|
| æ—§æ•°æ®ç¼ºå¤± | ä½ | ä¸­ | æ—§æ•°æ®ä¸å—å½±å“ï¼Œæ–°æ•°æ®æ­£å¸¸ä¿å­˜ |
| æ€§èƒ½å½±å“ | ä½ | ä½ | ä»…å¢åŠ ä¸€æ¬¡æ•°æ®åº“å†™å…¥ |
| å…¼å®¹æ€§é—®é¢˜ | ä½ | ä½ | å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½ |

---

## ä¹ã€ç­¾å­—ç¡®è®¤

| è§’è‰² | å§“å | ç­¾å­— | æ—¥æœŸ |
|------|------|------|------|
| åç«¯å¼€å‘ | æå·¥ | _æå·¥_ | 2026-03-06 |
| æµ‹è¯•å·¥ç¨‹å¸ˆ | èµµå·¥ | _èµµå·¥_ | 2026-03-06 |
| é¦–å¸­æ¶æ„å¸ˆ | å¼ å·¥ | _å¾…ç­¾å­—_ | å¾…ç¡®è®¤ |
| é¡¹ç›®æ€»æŒ‡æŒ¥ | TPM | _å¾…ç­¾å­—_ | å¾…ç¡®è®¤ |

---

## åã€ç»“è®º

### 10.1 ä¿®å¤ç»“è®º

**âœ… ä¿®å¤å®Œæˆï¼Œæ•°æ®å®Œæ•´æ€§é—®é¢˜å·²è§£å†³**

### 10.2 éªŒè¯ç»“è®º

| éªŒè¯é¡¹ | ç»“æœ |
|-------|------|
| å‡½æ•°å¯¼å…¥ | âœ… é€šè¿‡ |
| ä¿å­˜åŠŸèƒ½ | âœ… é€šè¿‡ |
| æ•°æ®åº“éªŒè¯ | âœ… é€šè¿‡ |
| å†å²æŸ¥è¯¢ | âœ… é€šè¿‡ |
| ç«¯åˆ°ç«¯æµ‹è¯• | âœ… é€šè¿‡ (100%) |

### 10.3 åç»­å·¥ä½œ

| ä»»åŠ¡ | è´Ÿè´£äºº | é¢„è®¡å®Œæˆ |
|------|--------|---------|
| ä»£ç  Review | å¼ å·¥ | 2026-03-07 |
| ç”Ÿäº§éƒ¨ç½² | å­™å·¥ | 2026-03-08 |
| ç›‘æ§é…ç½® | å­™å·¥ | 2026-03-08 |

---

**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ä¿®å¤æ—¥æœŸ**: 2026-03-06  
**ä¸‹æ¬¡å®¡æŸ¥**: 2026-03-13  
**è´Ÿè´£äºº**: åç«¯å¼€å‘ æå·¥
