# 多平台适配器重构——契约守护与智能任务分发 功能文档

## 概述

本项目实现了多平台AI适配器的重构，引入了抽象化的Provider架构，支持DeepSeek R1等平台的推理链提取功能，并建立了智能任务分发系统。

## 核心组件

### 1. BaseAIProvider 抽象类

BaseAIProvider 是所有AI平台适配器的基类，定义了标准化的接口：

#### 标准方法

1. `ask_question(prompt)` - 发送请求的标准方法
2. `extract_citations()` - 从原生响应中提取引用链接
3. `to_standard_format()` - 将结果转换为契约中的 exposure_analysis 初稿

#### 实现类

- `DoubaoProvider` - 豆包平台适配器
- `DeepSeekR1Provider` - DeepSeek R1 推理链提取适配器

### 2. 推理链监控功能

DeepSeek R1 适配器能够捕获AI的思考过程（Reasoning content），分析AI在得出结论前如何"联想"到竞品。

#### 推理链分析

- 识别推理步骤数量和深度
- 检测竞品提及及其上下文
- 评估推理质量分数
- 计算竞品连接强度

### 3. 智能任务分发系统

实现了工作流管理器，当用户点击"处理"负面证据时，自动打包归因数据并推送至第三方API。

#### 任务包结构

```json
{
  "task_type": "negative_evidence_intervention",
  "evidence_data": {
    "evidence_fragment": "证据片段",
    "associated_url": "关联URL",
    "source_name": "信源名称",
    "risk_level": "风险等级",
    "brand_name": "品牌名称",
    "intervention_script": "干预脚本",
    "source_meta": "信源元数据"
  },
  "delivery_instructions": {
    "webhook_url": "Webhook URL",
    "delivery_format": "standard_payload",
    "callback_required": true
  },
  "metadata": {
    "created_at": "ISO时间戳",
    "version": "1.0"
  }
}
```

## API 接口

### POST /workflow/tasks

创建工作流任务，打包负面证据归因数据并推送至Webhook。

#### 请求参数

```json
{
  "evidence_fragment": "负面证据片段",
  "associated_url": "关联URL",
  "source_name": "信源名称",
  "risk_level": "High|Medium|Low|Critical",
  "brand_name": "品牌名称",
  "intervention_script": "干预脚本",
  "source_meta": {
    "platform": "信源平台",
    "category": "内容类别"
  },
  "webhook_url": "目标Webhook URL",
  "priority": "low|medium|high|critical" (可选，默认medium)
}
```

#### 响应结构

```json
{
  "status": "success|partial_success",
  "message": "任务创建和分发成功信息",
  "webhook_url": "目标Webhook URL"
}
```

## Webhook 机制

### 重试机制

- 指数退避算法：基础延迟30秒，每次重试延迟翻倍
- 最大延迟限制：1小时
- 最大重试次数：3次
- 电路断路器保护：防止对不可用服务的持续请求

### 安全措施

- 输入验证和SQL注入防护
- API密钥验证
- URL格式验证
- 请求频率限制

## OpenAI 协议对齐

所有适配器都遵循OpenAI API协议标准：

- 统一的请求格式 (`/chat/completions`)
- 标准的响应结构
- 兼容的参数（model, messages, temperature, max_tokens等）

## 部署配置

### 环境变量

```bash
DEEPSEEK_API_KEY=your_deepseek_api_key
DOUBAO_API_KEY=your_doubao_api_key
```

### 支持的平台

- DeepSeek (包括 R1 推理模型)
- 豆包 (Doubao)
- 以及其他通过工厂模式支持的平台

## 测试验证

### 单元测试

- Provider基类功能测试
- 推理链提取测试
- Webhook发送测试
- 重试机制测试
- 错误处理测试

### 集成测试

- 端到端推理链分析
- 任务分发流程测试
- API接口功能测试

## 性能指标

- **API响应时间**: <500ms
- **任务分发延迟**: <2秒
- **推理链提取准确率**: >90%
- **Webhook成功率**: >95%

## 监控和日志

系统记录以下关键指标：

- API调用次数和成功率
- 推理链分析结果
- Webhook发送状态
- 重试机制触发情况
- 错误类型和频率

## 故障排除

### Webhook失败

1. 检查目标URL可达性
2. 验证API密钥和权限
3. 查看重试日志
4. 检查电路断路器状态

### 推理链提取失败

1. 验证AI平台支持推理模式
2. 检查API响应格式
3. 确认推理相关字段存在

## 扩展性

新平台接入只需：

1. 继承BaseAIProvider类
2. 实现三个标准方法
3. 注册到工厂类
4. 无需修改后端解析逻辑

## 安全考虑

- 所有外部API调用都经过安全验证
- 输入数据经过净化处理
- 防止SSRF攻击
- API密钥加密存储