# 模块 4.1：执行闭环——智能任务分发 功能文档

## 概述

智能任务分发系统实现了工作流管理功能，当用户在UI点击"处理"某条负面证据时，系统自动打包该片段的归因数据，并通过Webhook机制推送到预设的第三方API或企业通知渠道。

## 核心组件

### WorkflowManager 类

工作流管理器是整个系统的核心，负责任务打包、分发和状态管理。

#### 主要方法

1. `create_task_package()` - 创建标准化任务包
2. `dispatch_task()` - 分发任务到指定Webhook URL
3. `_process_task()` - 处理单个任务
4. `_process_task_with_retry()` - 处理需要重试的任务
5. `_calculate_retry_delay()` - 计算重试延迟时间（指数退避算法）
6. `get_task_status()` - 获取任务状态

### WebhookManager 类

Webhook管理器负责处理任务推送至第三方API。

#### 主要方法

1. `send_webhook()` - 发送Webhook请求到目标URL
2. `_send_webhook_internal()` - 内部Webhook发送逻辑

## 功能特性

### 1. 任务打包功能

系统创建标准化的任务包，包含：
- 证据数据（证据片段、关联URL、信源名称、风险等级等）
- 交付指令（Webhook URL、交付格式等）
- 元数据（创建时间、版本等）

### 2. 优先级队列

系统支持四种任务优先级：
- CRITICAL (最高优先级)
- HIGH (高优先级)
- MEDIUM (中等优先级)
- LOW (低优先级)

优先级高的任务会优先处理。

### 3. 重试机制

系统实现智能重试机制，使用指数退避算法：
- 基础延迟：30秒
- 每次重试延迟时间翻倍
- 添加随机抖动避免雷同
- 最大延迟限制：1小时
- 最大重试次数：3次

### 4. 电路断路器

系统集成电路断路器保护，防止在目标服务不可用时持续发送请求造成雪崩效应。

## API 接口

### POST /workflow/tasks

创建并分发工作流任务

**请求体**:
```json
{
  "evidence_fragment": "负面证据片段内容",
  "associated_url": "https://example.com/source",
  "source_name": "信源名称",
  "risk_level": "High",
  "brand_name": "品牌名称",
  "intervention_script": "干预脚本内容",
  "source_meta": {
    "platform": "信源平台",
    "category": "内容类别"
  },
  "webhook_url": "https://hooks.example.com/webhook",
  "priority": "medium"
}
```

**响应**:
```json
{
  "status": "success",
  "task_id": "wf_1234567890_a1b2c3d4",
  "message": "Workflow task created and dispatched successfully",
  "webhook_url": "https://hooks.example.com/webhook"
}
```

### GET /workflow/tasks/{task_id}

获取工作流任务状态

**响应**:
```json
{
  "status": "success",
  "task_info": {
    "task_id": "wf_1234567890_a1b2c3d4",
    "status": "completed",
    "completed_at": "2023-01-01T10:00:00Z"
  }
}
```

## 任务包结构

### 标准化任务包格式

```json
{
  "task_type": "negative_evidence_intervention",
  "evidence_data": {
    "evidence_fragment": "证据片段",
    "associated_url": "关联URL",
    "source_name": "信源名称",
    "risk_level": "风险等级",
    "brand_name": "品牌名称",
    "intervention_script": "干预脚本",
    "source_meta": {}
  },
  "delivery_instructions": {
    "webhook_url": "Webhook URL",
    "delivery_format": "standard_payload",
    "callback_required": true
  },
  "metadata": {
    "created_at": "ISO时间戳",
    "version": "1.0"
  }
}