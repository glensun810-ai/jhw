# 微信小程序架构重构分析报告

基于 REFACTOR_GUIDE.md 规范的项目现状分析及改进建议

## 1. 当前项目架构现状

经过对项目目录结构的全面分析，发现当前项目在架构方面存在多个不符合 REFACTOR_GUIDE.md 标准的问题。

## 2. 最紧急的三个重构痛点

### 2.1 缺失集中化请求工具 (严重违规)

- **问题**: 根据 REFACTOR_GUIDE.md，应该有一个 `utils/request.js` 作为所有网络请求的唯一出口，但该文件不存在。
- **现状**: 多个文件（`auth.js`, `data-sync.js`）直接使用 `wx.request`，违反了"单一出口原则"。
- **影响**: 无法实现全局加载状态、令牌自动注入、401自动跳转登录等统一处理机制。

**涉及文件**:
- `/miniprogram/utils/auth.js` - 多处直接调用 `wx.request`
- `/miniprogram/utils/data-sync.js` - 多处直接调用 `wx.request`

### 2.2 缺失常量目录 (主要违规)

- **问题**: 没有 `/constants` 目录，不符合 REFACTOR_GUIDE.md 要求。
- **现状**: 硬编码值散布在代码库中（如 API URL: `'http://127.0.0.1:5000/api/login'`）。
- **影响**: 难以维护、更新配置，违反"魔法数字"消除原则。

**示例硬编码值**:
- API 地址: `http://127.0.0.1:5000`
- 各种端点路径

### 2.3 缺失服务层 (架构缺陷)

- **问题**: 没有 `/services` 目录，不符合 REFACTOR_GUIDE.md 要求。
- **现状**: 复杂业务逻辑与 UI 逻辑混合，未分离到服务层。
- **影响**: 代码难以测试、维护，业务逻辑无法跨组件复用。

## 3. 重构优先级建议

### 第一阶段：通讯层标准化 (Phase 1)
1. 创建 `utils/request.js` 作为网络请求的统一入口
2. 提取所有硬编码的 API 地址到环境配置
3. 实现全局 Loading 控制、Token 自动注入、401 自动跳转登录逻辑

### 第二阶段：API 模块化解耦 (Phase 2)
1. 将各页面中的请求逻辑迁移到对应的 `/api/*.js` 文件
2. 遵循函数命名模板：`export const [动作][对象] = (data) => request({ ... })`

### 第三阶段：数据预处理提取 (Phase 3)
1. 创建 `/services` 目录
2. 将复杂的数据处理逻辑从页面中提取到服务层

### 第四阶段：配置与常量收拢 (Phase 4)
1. 创建 `/constants` 目录
2. 将硬编码值迁移到常量文件中
3. 使用枚举值替代魔法数字

## 4. 立即行动建议

建议首先实施第一阶段：创建 `utils/request.js` 文件，作为整个重构工作的基础。这将为后续的 API 解耦和统一错误处理提供基础设施。

## 5. 验收标准

每次完成小模块重构后，需自检以下清单：
- [ ] 静态检查：在微信开发者工具中按 Ctrl+B 编译，控制台 0 错误，0 警告
- [ ] 路径追溯：使用全局搜索确认旧代码块已被物理删除，没有冗余残留
- [ ] 异步安全：确保所有异步操作（Promise/async-await）都有 .catch 或 try-catch 处理
- [ ] 性能检查：重构后单次 setData 的数据量不得超过 1MB，避免不必要的全局数据刷新