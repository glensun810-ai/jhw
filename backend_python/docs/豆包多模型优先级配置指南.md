# 豆包多模型优先级配置指南

**配置日期**: 2026-02-23  
**配置版本**: v2.6.0  
**配置状态**: ✅ 已完成

---

## 一、配置概述

支持配置多个豆包模型 ID，系统会按优先级顺序自动选择可用的模型进行调用。

### 核心特性

1. **优先级配置**: 支持最多 10 个优先级模型配置
2. **自动选择**: 自动选择优先级最高的可用模型
3. **故障转移**: 当前模型失败时自动切换到下一个优先级模型
4. **向后兼容**: 保留旧配置方式，平滑升级

---

## 二、配置方法

### 2.1 编辑 .env 文件

打开 `backend_python/.env` 文件，配置以下内容：

```bash
# =============================================================================
# 豆包多模型优先级配置
# =============================================================================

# 豆包 API Key（必填）
ARK_API_KEY=your-doubao-ark-api-key-here

# 优先级 1：最高优先级（首选模型）
DOUBAO_MODEL_PRIORITY_1=doubao-seed-1-8-251228

# 优先级 2：次高优先级（备选模型 1）
DOUBAO_MODEL_PRIORITY_2=doubao-seed-2-0-mini-260215

# 优先级 3：第三优先级（备选模型 2）
DOUBAO_MODEL_PRIORITY_3=doubao-seed-2-0-pro-260215

# 优先级 4：最低优先级（备选模型 3）
DOUBAO_MODEL_PRIORITY_4=doubao-seed-2-0-lite-260215

# 自动选择模式：true=自动选择最高优先级可用模型（推荐）
DOUBAO_AUTO_SELECT_MODEL=true
```

### 2.2 配置说明

| 配置项 | 说明 | 必填 | 示例 |
|-------|------|------|------|
| `ARK_API_KEY` | 豆包 API Key | ✅ 必填 | `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` |
| `DOUBAO_MODEL_PRIORITY_1` | 优先级 1 模型 | ✅ 至少配置一个 | `doubao-seed-1-8-251228` |
| `DOUBAO_MODEL_PRIORITY_2` | 优先级 2 模型 | ⚠️ 可选 | `doubao-seed-2-0-mini-260215` |
| `DOUBAO_MODEL_PRIORITY_3` | 优先级 3 模型 | ⚠️ 可选 | `doubao-seed-2-0-pro-260215` |
| `DOUBAO_MODEL_PRIORITY_4` | 优先级 4 模型 | ⚠️ 可选 | `doubao-seed-2-0-lite-260215` |
| `DOUBAO_AUTO_SELECT_MODEL` | 是否启用自动选择 | ⚠️ 可选，默认 true | `true` 或 `false` |

### 2.3 配置示例

#### 示例 1: 单模型配置（兼容旧版）

```bash
ARK_API_KEY=your-api-key
DOUBAO_MODEL_ID=ep-20260212000000-gd5tq
```

#### 示例 2: 多模型优先级配置（推荐）

```bash
ARK_API_KEY=your-api-key

# 按优先级配置多个模型
DOUBAO_MODEL_PRIORITY_1=doubao-seed-1-8-251228
DOUBAO_MODEL_PRIORITY_2=doubao-seed-2-0-mini-260215
DOUBAO_MODEL_PRIORITY_3=doubao-seed-2-0-pro-260215
DOUBAO_MODEL_PRIORITY_4=doubao-seed-2-0-lite-260215

# 启用自动选择
DOUBAO_AUTO_SELECT_MODEL=true
```

#### 示例 3: 禁用自动选择（手动指定）

```bash
ARK_API_KEY=your-api-key

DOUBAO_MODEL_PRIORITY_1=doubao-seed-1-8-251228
DOUBAO_MODEL_PRIORITY_2=doubao-seed-2-0-mini-260215

# 禁用自动选择，只使用优先级 1 的模型
DOUBAO_AUTO_SELECT_MODEL=false
```

---

## 三、工作原理

### 3.1 启动时模型选择

```
系统启动
    ↓
读取 .env 配置
    ↓
加载优先级模型列表
    ↓
按优先级顺序尝试连接
    ↓
选择第一个可用的模型 ✅
    ↓
记录日志：已选中模型 XXX
```

### 3.2 运行时故障转移

```
API 请求
    ↓
使用当前模型调用
    ↓
成功？
    ├─ 是 → 返回结果 ✅
    └─ 否 → 检查错误类型
            ↓
        服务不可用？
            ├─ 是 → 切换到下一个优先级模型
            │         ↓
            │      重试请求 ✅
            └─ 否 → 返回错误 ❌
```

### 3.3 优先级规则

1. **数字越小优先级越高**: `PRIORITY_1` > `PRIORITY_2` > `PRIORITY_3` ...
2. **自动选择可用模型**: 系统会尝试连接每个模型，选择第一个成功的
3. **故障自动转移**: 当前模型失败时，自动尝试下一个优先级的模型
4. **最多支持 10 个优先级**: `PRIORITY_1` 到 `PRIORITY_10`

---

## 四、验证配置

### 4.1 运行测试脚本

```bash
cd /Users/sgl/PycharmProjects/PythonProject/backend_python
python3 test_doubao_priority.py
```

### 4.2 预期输出

```
📄 尝试加载 .env 文件：/path/to/.env
✅ .env 文件加载成功

======================================================================
🔍 豆包多模型优先级配置验证
======================================================================

📌 API Key 配置:
  ARK_API_KEY: ✅ 已配置
  DOUBAO_API_KEY: ❌ 未配置

✅ 使用 API Key: eyJhbGciOiJIUzI1NiIs...

📌 模型配置:
  自动选择模式：✅ 启用
  优先级模型数量：4
  总模型数量：4

📋 优先级模型列表（按优先级排序）:
  1. doubao-seed-1-8-251228 (首选)
  2. doubao-seed-2-0-mini-260215
  3. doubao-seed-2-0-pro-260215
  4. doubao-seed-2-0-lite-260215

======================================================================
🧪 豆包优先级适配器测试
======================================================================

📍 创建豆包优先级适配器...
  ✅ 适配器创建成功
  📊 适配器类型：DoubaoPriorityAdapter
  📋 优先级模型列表：4 个
  ✅ 选中的模型：doubao-seed-1-8-251228
  💡 说明：系统自动选择了优先级最高的可用模型

📍 发送测试请求...

======================================================================
✅ API 调用成功
======================================================================
  📊 使用 Token: 125
  ⏱️  响应延迟：2.35s
  💬 回复预览：我是豆包 AI 助手...

======================================================================
📊 测试总结
======================================================================

✅ 测试成功!
  • 使用模型：doubao-seed-1-8-251228
  • 消耗 Token: 125
  • 响应时间：2.35s
```

### 4.3 查看日志

```bash
# 查看后端日志
tail -f logs/app.log | grep -E "DoubaoPriority|Factory"
```

**预期日志**:
```
[Factory] 使用豆包优先级适配器，模型列表：['doubao-seed-1-8-251228', ...]
[DoubaoPriority] 尝试初始化适配器，优先级模型列表：['doubao-seed-1-8-251228', ...]
[DoubaoPriority] 尝试模型 1/4: doubao-seed-1-8-251228
[DoubaoPriority] ✅ 模型 doubao-seed-1-8-251228 可用，已选中
```

---

## 五、常见问题

### Q1: 如何知道哪个模型被选中了？

**A**: 查看日志输出，会显示选中的模型 ID：

```
[DoubaoPriority] ✅ 模型 doubao-seed-1-8-251228 可用，已选中
```

### Q2: 如果所有模型都不可用怎么办？

**A**: 系统会记录错误日志，并返回错误响应：

```
[DoubaoPriority] ❌ 所有 4 个模型都不可用
```

### Q3: 可以配置多少个优先级模型？

**A**: 最多支持 10 个优先级模型（`PRIORITY_1` 到 `PRIORITY_10`）。

### Q4: 如何禁用自动选择功能？

**A**: 设置 `DOUBAO_AUTO_SELECT_MODEL=false`：

```bash
DOUBAO_AUTO_SELECT_MODEL=false
```

### Q5: 旧的 `DOUBAO_MODEL_ID` 配置还能用吗？

**A**: 可以，系统会向后兼容：

- 如果配置了 `PRIORITY_*`，则使用优先级配置
- 如果未配置 `PRIORITY_*`，则使用 `DOUBAO_MODEL_ID`

---

## 六、最佳实践

### 6.1 推荐配置

```bash
# 配置 3-4 个优先级模型
DOUBAO_MODEL_PRIORITY_1=doubao-seed-1-8-251228  # 首选（性能最好）
DOUBAO_MODEL_PRIORITY_2=doubao-seed-2-0-mini-260215  # 备选 1（速度快）
DOUBAO_MODEL_PRIORITY_3=doubao-seed-2-0-pro-260215  # 备选 2（质量高）
DOUBAO_MODEL_PRIORITY_4=doubao-seed-2-0-lite-260215  # 备选 3（成本低）

# 启用自动选择
DOUBAO_AUTO_SELECT_MODEL=true
```

### 6.2 模型选择策略

| 优先级 | 模型类型 | 适用场景 |
|-------|---------|---------|
| 1 | 高性能模型 | 首选，日常使用 |
| 2 | 快速模型 | 备选，对延迟敏感 |
| 3 | 高质量模型 | 备选，对质量敏感 |
| 4 | 低成本模型 | 备选，控制成本 |

### 6.3 监控建议

1. **监控选中的模型**: 定期检查日志，确认使用的是预期模型
2. **监控故障转移**: 如果频繁切换模型，检查高优先级模型状态
3. **监控成本**: 不同模型可能有不同定价，注意成本控制

---

## 七、技术细节

### 7.1 相关文件

| 文件 | 说明 |
|-----|------|
| `backend_python/.env` | 配置文件 |
| `backend_python/config.py` | 配置读取 |
| `wechat_backend/ai_adapters/doubao_priority_adapter.py` | 优先级适配器 |
| `wechat_backend/ai_adapters/factory.py` | 工厂类（使用优先级适配器） |
| `backend_python/test_doubao_priority.py` | 测试脚本 |

### 7.2 配置加载流程

```
应用启动
    ↓
load_dotenv('.env')
    ↓
Config 类读取环境变量
    ↓
get_doubao_priority_models()
    ↓
返回优先级模型列表
    ↓
DoubaoPriorityAdapter 使用
```

### 7.3 适配器创建流程

```
AIAdapterFactory.create('doubao', api_key)
    ↓
检查是否配置优先级模型
    ↓
是 → 创建 DoubaoPriorityAdapter
    ↓
尝试连接优先级模型
    ↓
选择第一个可用的模型
    ↓
返回适配器实例
```

---

## 八、总结

### 8.1 已完成功能

✅ **多模型优先级配置** - 支持最多 10 个优先级  
✅ **自动选择可用模型** - 启动时自动选择  
✅ **故障自动转移** - 运行时自动切换  
✅ **向后兼容** - 保留旧配置方式  

### 8.2 使用建议

1. **配置 3-4 个优先级模型** - 平衡性能和可靠性
2. **启用自动选择模式** - 简化运维
3. **定期检查日志** - 确认模型选择正常
4. **运行测试脚本** - 验证配置正确

### 8.3 下一步

1. **填入真实 API Key** - 编辑 `.env` 文件
2. **运行测试脚本** - `python3 test_doubao_priority.py`
3. **查看测试结果** - 确认配置生效

---

**文档生成时间**: 2026-02-23  
**配置版本**: v2.6.0  
**审核状态**: ✅ 已通过  
**配置状态**: ✅ 已完成
