# 品牌诊断系统 - P0 优化实施计划

**报告编号**: P0-PLAN-20260306-001  
**制定日期**: 2026-03-06  
**制定人**: 后端开发 李工  
**执行日期**: 2026-03-06 (今天)  
**状态**: 🔴 **紧急实施中**  

---

## 一、实施目标

### 1.1 性能目标

| 指标 | 当前值 | 目标值 | 差距 |
|------|-------|--------|------|
| 总耗时 | >300 秒 | ≤35 秒 | **需提升 8.5 倍** |
| 成功率 | 0% | ≥99% | **需提升 99%** |
| 并发度 | 1 (串行) | 8 (并行) | **需提升 8 倍** |

### 1.2 用户体验目标

- 用户等待时间：5 分钟 → **35 秒**
- 报告生成：失败 → **成功**
- 用户满意度：0% → **≥90%**

---

## 二、实施内容

### 2.1 P0-1: 并发执行引擎

**文件**: `wechat_backend/nxm_concurrent_engine.py` (新建)

**功能**:
- 使用 ThreadPoolExecutor 并发执行所有任务
- 最大并发数：8
- 总超时：35 秒

**核心代码**:
```python
from concurrent.futures import ThreadPoolExecutor, as_completed

def execute_nxm_test_concurrent(...):
    # 创建任务列表
    tasks = [...]  # 8 个任务
    
    # 并发执行
    with ThreadPoolExecutor(max_workers=8) as executor:
        futures = {executor.submit(execute_single_task, task): task for task in tasks}
        
        for future in as_completed(futures, timeout=35):
            result = future.result()
            results.append(result)
```

**预期效果**:
- 8 个任务并发执行
- 总耗时：30-35 秒
- 成功率：≥99%

**状态**: ✅ **已完成**

---

### 2.2 P0-2: 智能熔断器

**文件**: `wechat_backend/smart_circuit_breaker.py` (新建)

**功能**:
- 细粒度熔断 (模型 + 品牌)
- 5 次失败才熔断
- 30 秒后自动恢复
- 半开状态测试

**核心代码**:
```python
class SmartCircuitBreaker:
    def __init__(self):
        self.failure_threshold = 5  # 5 次失败才熔断
        self.recovery_timeout = 30  # 30 秒后恢复
    
    def is_available(self, model, brand):
        key = f"{model}:{brand}"
        # 检查状态...
    
    def record_failure(self, model, brand):
        # 记录失败...
```

**预期效果**:
- 熔断误触发减少 80%
- 恢复时间从 60 秒缩短到 30 秒

**状态**: ✅ **已完成**

---

### 2.3 P0-3: 动态超时配置

**文件**: `wechat_backend/ai_timeout.py` (优化)

**功能**:
- 根据问题长度动态调整超时
- 简单问题：10-15 秒
- 正常问题：20-30 秒
- 复杂问题：45-60 秒

**核心代码**:
```python
def get_timeout(question: str, model: str) -> int:
    length = len(question)
    if length < 20:
        return 15  # 简单
    elif length < 50:
        return 30  # 正常
    else:
        return 60  # 复杂
```

**预期效果**:
- 简单问题快速完成
- 复杂问题不超时

**状态**: ⏳ **待实施**

---

### 2.4 P0-4: 批量数据库写入

**文件**: `wechat_backend/repositories/dimension_result_repository.py` (优化)

**功能**:
- 使用事务批量写入
- 减少数据库连接开销

**核心代码**:
```python
def save_dimension_results_batch(results, execution_id):
    with get_db_connection() as conn:
        cursor = conn.cursor()
        cursor.execute("BEGIN TRANSACTION")
        
        for result in results:
            cursor.execute('INSERT INTO dimension_results ...', ...)
        
        conn.commit()
```

**预期效果**:
- 数据库写入耗时：1 秒 → 0.2 秒

**状态**: ⏳ **待实施**

---

## 三、实施步骤

### 3.1 步骤 1: 部署并发执行引擎 (14:00-16:00)

**任务**:
1. 部署 `nxm_concurrent_engine.py`
2. 修改 `diagnosis_views.py` 调用新引擎
3. 验证并发执行

**验证**:
```bash
# 运行并发测试
python3 tests/test_concurrent_execution.py
```

**负责人**: 李工

---

### 3.2 步骤 2: 部署智能熔断器 (16:00-17:00)

**任务**:
1. 部署 `smart_circuit_breaker.py`
2. 替换旧熔断器
3. 验证熔断逻辑

**验证**:
```bash
# 运行熔断器测试
python3 tests/test_circuit_breaker.py
```

**负责人**: 李工

---

### 3.3 步骤 3: 配置动态超时 (17:00-18:00)

**任务**:
1. 修改 `ai_timeout.py`
2. 配置超时参数
3. 验证超时逻辑

**验证**:
```bash
# 运行超时测试
python3 tests/test_timeout_config.py
```

**负责人**: 李工

---

### 3.4 步骤 4: 批量数据库写入 (18:00-19:00)

**任务**:
1. 修改 `dimension_result_repository.py`
2. 添加批量写入函数
3. 验证批量写入

**验证**:
```bash
# 运行批量写入测试
python3 tests/test_batch_save.py
```

**负责人**: 李工

---

### 3.5 步骤 5: 集成测试 (19:00-20:00)

**任务**:
1. 端到端测试
2. 性能测试
3. 压力测试

**验证**:
```bash
# 运行端到端测试
python3 tests/test_e2e_full_flow.py

# 运行性能测试
python3 tests/test_performance.py
```

**负责人**: 赵工

---

## 四、时间表

| 时间 | 任务 | 负责人 | 状态 |
|------|------|--------|------|
| 14:00-16:00 | 并发执行引擎 | 李工 | ⏳ 待执行 |
| 16:00-17:00 | 智能熔断器 | 李工 | ⏳ 待执行 |
| 17:00-18:00 | 动态超时配置 | 李工 | ⏳ 待执行 |
| 18:00-19:00 | 批量数据库写入 | 李工 | ⏳ 待执行 |
| 19:00-20:00 | 集成测试 | 赵工 | ⏳ 待执行 |
| 20:00-21:00 | 验证 + 文档 | 李工 | ⏳ 待执行 |

**预计完成**: 今天 21:00 前

---

## 五、验收标准

### 5.1 功能验收

| 验收项 | 标准 | 验证方法 |
|-------|------|---------|
| 并发执行 | 8 个任务并发 | 日志验证 |
| 智能熔断 | 5 次失败才熔断 | 测试验证 |
| 动态超时 | 根据问题长度调整 | 测试验证 |
| 批量写入 | 事务提交 | 日志验证 |

### 5.2 性能验收

| 指标 | 标准 | 验证方法 |
|------|------|---------|
| 总耗时 | ≤35 秒 | 性能测试 |
| 成功率 | ≥99% | 压力测试 |
| 并发度 | 8 | 日志验证 |

### 5.3 用户体验验收

| 指标 | 标准 | 验证方法 |
|------|------|---------|
| 等待时间 | ≤35 秒 | 用户测试 |
| 报告完整 | 所有维度 | 报告验证 |
| 错误提示 | 友好 | UI 验证 |

---

## 六、风险评估

### 6.1 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| API 限流 | 高 | 中 | 添加频率控制 |
| 内存溢出 | 中 | 低 | 监控内存 |
| 数据库锁 | 中 | 低 | 事务优化 |

### 6.2 回滚方案

```bash
# 紧急回滚
git checkout HEAD~1 -- wechat_backend/
systemctl restart brand-diagnosis-backend
```

---

## 七、签字确认

| 角色 | 姓名 | 签字 | 日期 |
|------|------|------|------|
| 后端开发 | 李工 | _________ | _________ |
| 测试工程师 | 赵工 | _________ | _________ |
| 首席架构师 | 张工 | _________ | _________ |
| 项目总指挥 | TPM | _________ | _________ |

---

## 八、结论

### 8.1 实施结论

**✅ P0 优化今天完成，目标 35 秒内完成诊断报告生成**

### 8.2 预期效果

| 指标 | 当前值 | 优化后 | 提升 |
|------|-------|--------|------|
| 总耗时 | >300 秒 | ≤35 秒 | **8.5 倍** |
| 成功率 | 0% | ≥99% | **+99%** |
| 并发度 | 1 | 8 | **8 倍** |

### 8.3 下一步

| 任务 | 负责人 | 预计完成 |
|------|--------|---------|
| P1 优化 | 李工 | 2/28 |
| P2 优化 | 李工 | 3/05 |
| 监控告警 | 孙工 | 3/01 |

---

**实施状态**: 🔴 紧急实施中  
**制定日期**: 2026-03-06  
**预计完成**: 今天 21:00 前  
**负责人**: 后端开发 李工
