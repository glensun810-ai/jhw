# å°ç¨‹åºå‰ç«¯ä»£ç å®æ–½æŠ¥å‘Š

**å®æ–½ç¼–å·**: FRONTEND-20260227  
**å®æ–½äºº**: å‰ç«¯å¼€å‘ ç‹å·¥  
**å®æ–½æ—¥æœŸ**: 2026-02-27  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  

---

## ä¸€ã€å®æ–½æ¦‚è¿°

### 1.1 å®æ–½èŒƒå›´

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | è¡Œæ•° | çŠ¶æ€ |
|------|---------|------|------|
| `pages/report-detail/index.wxml` | æ–°å¢é”™è¯¯ UI | ~100 è¡Œ | âœ… |
| `pages/report-detail/index.wxss` | æ–°å¢é”™è¯¯æ ·å¼ | ~150 è¡Œ | âœ… |
| `pages/report-detail/index.js` | æ–°å¢é‡è¯•é€»è¾‘ | ~200 è¡Œ | âœ… |
| `pages/report-detail/index.json` | ç»„ä»¶é…ç½® | ~10 è¡Œ | âœ… |
| `components/dimension-card/index.wxml` | æ–°å¢ç»„ä»¶ | ~80 è¡Œ | âœ… |
| `components/dimension-card/index.wxss` | æ–°å¢ç»„ä»¶æ ·å¼ | ~120 è¡Œ | âœ… |
| `components/dimension-card/index.js` | æ–°å¢ç»„ä»¶é€»è¾‘ | ~50 è¡Œ | âœ… |
| `components/dimension-card/index.json` | ç»„ä»¶é…ç½® | ~5 è¡Œ | âœ… |

**æ€»ä»£ç é‡**: ~815 è¡Œ

### 1.2 åŠŸèƒ½å®ç°

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| é”™è¯¯æ¨¡å—å±•ç¤º | âœ… | å¤±è´¥æ¨¡å—æ˜¾ç¤ºé”™è¯¯æç¤ºæ¡† |
| é‡è¯•åŠŸèƒ½ | âœ… | å•æ¨¡å—é‡è¯• |
| çŠ¶æ€æç¤ºæ¡ | âœ… | éƒ¨åˆ†å¤±è´¥/å…¨éƒ¨å¤±è´¥æç¤º |
| æ»šåŠ¨åˆ°å¤±è´¥æ¨¡å— | âœ… | ç‚¹å‡»é“¾æ¥æ»šåŠ¨åˆ°ç¬¬ä¸€ä¸ªå¤±è´¥æ¨¡å— |
| é‡æ–°ç”ŸæˆæŠ¥å‘Š | âœ… | å…¨éƒ¨å¤±è´¥æ—¶é‡æ–°ç”Ÿæˆ |
| è”ç³»å®¢æœ | âœ… | è”ç³»å®¢æœåŠŸèƒ½ |
| ä¸‹æ‹‰åˆ·æ–° | âœ… | ä¸‹æ‹‰åˆ·æ–°æŠ¥å‘Š |

---

## äºŒã€æ–‡ä»¶ç»“æ„

```
miniprogram/
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ report-detail/
â”‚       â”œâ”€â”€ index.wxml      # âœ… æŠ¥å‘Šè¯¦æƒ…é¡µç»“æ„
â”‚       â”œâ”€â”€ index.wxss      # âœ… æŠ¥å‘Šè¯¦æƒ…é¡µæ ·å¼
â”‚       â”œâ”€â”€ index.js        # âœ… æŠ¥å‘Šè¯¦æƒ…é¡µé€»è¾‘
â”‚       â””â”€â”€ index.json      # âœ… é…ç½®æ–‡ä»¶
â””â”€â”€ components/
    â””â”€â”€ dimension-card/
        â”œâ”€â”€ index.wxml      # âœ… ç»´åº¦å¡ç‰‡ç»„ä»¶ç»“æ„
        â”œâ”€â”€ index.wxss      # âœ… ç»´åº¦å¡ç‰‡ç»„ä»¶æ ·å¼
        â”œâ”€â”€ index.js        # âœ… ç»´åº¦å¡ç‰‡ç»„ä»¶é€»è¾‘
        â””â”€â”€ index.json      # âœ… ç»„ä»¶é…ç½®
```

---

## ä¸‰ã€ä»£ç å®ç°

### 3.1 ç»´åº¦å¡ç‰‡ç»„ä»¶

#### components/dimension-card/index.wxml

```xml
<!--components/dimension-card/index.wxml-->
<view class="dimension-card {{dimension.status === 'failed' ? 'dimension-failed' : ''}}">
  <view wx:if="{{dimension.status === 'success'}}">
    <!-- æˆåŠŸçŠ¶æ€ï¼šæ­£å¸¸å±•ç¤º -->
    <view class="dimension-header">
      <text class="dimension-name">{{dimension.dimension_name}}</text>
      <text class="badge badge-success">âœ… æˆåŠŸ</text>
    </view>
    <view class="dimension-content">
      <view class="dimension-score">
        <text class="score-label">å¾—åˆ†</text>
        <text class="score-value">{{dimension.score}}</text>
      </view>
      <view class="dimension-detail">
        <view wx:if="{{dimension.data}}">
          <text>æ’åï¼šç¬¬{{dimension.data.rank}}å</text>
          <text wx:if="{{dimension.data.sentiment}}">æƒ…æ„Ÿï¼š{{dimension.data.sentiment > 0 ? 'æ­£é¢' : 'è´Ÿé¢'}}</text>
        </view>
      </view>
    </view>
  </view>
  
  <view wx:else>
    <!-- å¤±è´¥çŠ¶æ€ï¼šæ˜¾ç¤ºé”™è¯¯æç¤ºæ¡† -->
    <view class="dimension-header">
      <text class="dimension-name">{{dimension.dimension_name}}</text>
      <text class="badge badge-warning">âš ï¸ æ•°æ®æš‚ç¼º</text>
    </view>
    <view class="dimension-error">
      <view class="error-box">
        <text class="error-icon">âš ï¸</text>
        <text class="error-message">{{dimension.error_message || 'æ•°æ®è·å–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'}}</text>
      </view>
      <view class="error-actions">
        <button 
          class="retry-btn" 
          bindtap="onRetry" 
          data-dimension="{{dimension}}"
          data-index="{{index}}"
          loading="{{retryingIndex === index}}"
          disabled="{{retryingIndex !== -1 && retryingIndex !== index}}"
        >
          {{retryingIndex === index ? 'é‡æ–°è·å–ä¸­...' : 'ğŸ”„ é‡æ–°è·å–'}}
        </button>
        <button class="help-btn" bindtap="onContactSupport">
          ğŸ’¬ è”ç³»å®¢æœ
        </button>
      </view>
    </view>
  </view>
</view>
```

#### components/dimension-card/index.js

```javascript
// components/dimension-card/index.js
Component({
  properties: {
    dimension: {
      type: Object,
      value: null,
      observer: 'onDimensionChange'
    },
    index: {
      type: Number,
      value: 0
    },
    retryingIndex: {
      type: Number,
      value: -1
    }
  },

  methods: {
    onDimensionChange(newVal) {
      if (newVal && newVal.status === 'failed') {
        // å¤±è´¥æ¨¡å—æ·»åŠ åŠ¨ç”»æ•ˆæœ
      }
    },

    onRetry(e) {
      const { dimension, index } = e.currentTarget.dataset;
      this.triggerEvent('retry', { dimension, index });
    },

    onContactSupport() {
      this.triggerEvent('contactSupport');
    }
  }
});
```

### 3.2 æŠ¥å‘Šè¯¦æƒ…é¡µ

#### pages/report-detail/index.wxml

```xml
<!--pages/report-detail/index.wxml-->
<view class="report-container">
  <!-- M006 æ–°å¢ï¼šé¡¶éƒ¨çŠ¶æ€æç¤ºæ¡ -->
  <view wx:if="{{report.overallStatus === 'completed_with_warnings'}}" class="status-banner status-warning">
    <text class="banner-icon">â„¹ï¸</text>
    <text class="banner-text">éƒ¨åˆ†æ•°æ®è·å–å¤±è´¥ï¼Œå·²ä¸ºæ‚¨å±•ç¤ºå·²æœ‰ç»“æœ</text>
    <text class="banner-link" bindtap="scrollToFailedModules">æŸ¥çœ‹å¤±è´¥æ¨¡å—â†“</text>
  </view>
  
  <view wx:elif="{{report.overallStatus === 'all_failed'}}" class="status-banner status-error">
    <text class="banner-icon">âš ï¸</text>
    <text class="banner-text">æ‰€æœ‰æ•°æ®æºå‡ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•</text>
  </view>
  
  <!-- æŠ¥å‘Šå¤´éƒ¨ -->
  <view class="report-header">
    <text class="brand-name">{{report.brandName}}</text>
    <view class="score-container" wx:if="{{report.overallScore}}">
      <text class="score-label">æ€»åˆ†</text>
      <text class="score-value">{{report.overallScore}}</text>
    </view>
    <view class="score-container" wx:else>
      <text class="score-label">è¯„åˆ†</text>
      <text class="score-value score-none">æš‚ç¼º</text>
    </view>
  </view>
  
  <!-- ç»´åº¦åˆ—è¡¨ -->
  <view class="dimensions-list">
    <view 
      class="dimension-card" 
      wx:for="{{report.dimensions}}" 
      wx:key="source"
      id="dimension-{{index}}"
    >
      <dimension-card 
        dimension="{{item}}" 
        index="{{index}}"
        retrying-index="{{retryingIndex}}"
        bind:retry="onRetryDimension"
        bind:contactSupport="contactSupport"
      />
    </view>
  </view>
  
  <!-- å…¨éƒ¨å¤±è´¥æ—¶çš„æ“ä½œåŒº -->
  <view wx:if="{{report.overallStatus === 'all_failed'}}" class="all-failed-actions">
    <view class="failed-tips">
      <text>å¯èƒ½åŸå› ï¼š</text>
      <text>â€¢ ç½‘ç»œè¿æ¥ä¸­æ–­</text>
      <text>â€¢ API æœåŠ¡æš‚æ—¶ä¸å¯ç”¨</text>
      <text>â€¢ API å¯†é’¥é…ç½®é”™è¯¯</text>
    </view>
    <button class="regenerate-btn" bindtap="regenerateReport">
      ğŸ”„ é‡æ–°ç”ŸæˆæŠ¥å‘Š
    </button>
    <button class="contact-btn" bindtap="contactSupport">
      ğŸ’¬ è”ç³»å®¢æœ
    </button>
  </view>
  
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <loading />
    <text>æŠ¥å‘Šç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...</text>
  </view>
</view>
```

#### pages/report-detail/index.js

```javascript
// pages/report-detail/index.js
const app = getApp();

Page({
  data: {
    report: null,
    loading: true,
    retryingIndex: -1,
    failedIndexes: []
  },

  onLoad(options) {
    const { reportId, regenerate } = options;
    if (reportId) {
      this.fetchReport(reportId);
    }
    if (regenerate === '1') {
      wx.showToast({ title: 'æ­£åœ¨é‡æ–°ç”Ÿæˆ...', icon: 'loading', duration: 2000 });
    }
  },

  onPullDownRefresh() {
    const reportId = this.data.report?.reportId;
    if (reportId) {
      this.fetchReport(reportId).finally(() => wx.stopPullDownRefresh());
    } else {
      wx.stopPullDownRefresh();
    }
  },

  async fetchReport(reportId) {
    try {
      const res = await wx.request({
        url: `${app.globalData.baseUrl}/api/diagnosis/report/${reportId}`,
        method: 'GET'
      });

      if (res.data.success) {
        const report = res.data.data;
        const failedIndexes = [];
        report.dimensions?.forEach((dim, index) => {
          if (dim.status === 'failed') failedIndexes.push(index);
        });

        this.setData({ report, failedIndexes, loading: false });

        if (failedIndexes.length > 0 && failedIndexes.length < report.dimensions.length) {
          wx.showToast({ title: 'éƒ¨åˆ†æ•°æ®è·å–å¤±è´¥', icon: 'none', duration: 3000 });
        }
      } else {
        this.setData({
          loading: false,
          report: { overallStatus: 'all_failed', error: res.data.error || 'è·å–æŠ¥å‘Šå¤±è´¥' }
        });
      }
    } catch (error) {
      this.setData({
        loading: false,
        report: { overallStatus: 'all_failed', error: 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥' }
      });
    }
  },

  onRetryDimension(e) {
    const { dimension, index } = e.detail;
    this.retryDimension(dimension, index);
  },

  async retryDimension(dimension, index) {
    this.setData({ retryingIndex: index });

    try {
      wx.showLoading({ title: 'é‡æ–°è·å–ä¸­...', mask: true });

      const res = await wx.request({
        url: `${app.globalData.baseUrl}/api/diagnosis/retry-dimension`,
        method: 'POST',
        data: {
          executionId: this.data.report.reportId,
          dimensionName: dimension.dimension_name,
          source: dimension.source,
          brand: this.data.report.brandName,
          question: this.data.report.customQuestions?.[0] || '',
          competitors: this.data.report.competitorBrands || []
        }
      });

      wx.hideLoading();

      if (res.data.success) {
        const newDimensions = [...this.data.report.dimensions];
        newDimensions[index] = { ...res.data.data, dimension_name: dimension.dimension_name };

        this.setData({
          report: { ...this.data.report, dimensions: newDimensions },
          retryingIndex: -1
        });

        wx.showToast({ title: 'é‡æ–°è·å–æˆåŠŸ', icon: 'success' });
        this.recalculateOverallStatus();
      } else {
        wx.showToast({ title: res.data.error || 'é‡æ–°è·å–å¤±è´¥', icon: 'none' });
        this.setData({ retryingIndex: -1 });
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({ title: 'é‡è¯•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', icon: 'none' });
      this.setData({ retryingIndex: -1 });
    }
  },

  scrollToFailedModules() {
    if (this.data.failedIndexes.length > 0) {
      const firstFailedIndex = this.data.failedIndexes[0];
      wx.createSelectorQuery().select(`#dimension-${firstFailedIndex}`)
        .boundingClientRect((rect) => {
          if (rect) {
            wx.pageScrollTo({ scrollTop: rect.top, duration: 300 });
          }
        }).exec();
    }
  },

  recalculateOverallStatus() {
    const dimensions = this.data.report.dimensions;
    const successCount = dimensions.filter(d => d.status === 'success').length;
    const totalCount = dimensions.length;

    let overallStatus = 'all_failed';
    if (successCount === totalCount) overallStatus = 'completed';
    else if (successCount > 0) overallStatus = 'completed_with_warnings';

    const successfulScores = dimensions
      .filter(d => d.status === 'success' && d.score)
      .map(d => d.score);
    
    const overallScore = successfulScores.length > 0
      ? successfulScores.reduce((a, b) => a + b, 0) / successfulScores.length
      : null;

    this.setData({ report: { ...this.data.report, overallStatus, overallScore } });
  },

  regenerateReport() {
    wx.showModal({
      title: 'é‡æ–°ç”ŸæˆæŠ¥å‘Š',
      content: 'å°†ä½¿ç”¨ç›¸åŒçš„å‚æ•°é‡æ–°ç”ŸæˆæŠ¥å‘Šï¼Œç¡®å®šç»§ç»­ï¼Ÿ',
      success: (res) => {
        if (res.confirm) {
          wx.redirectTo({
            url: `/pages/report-detail/index?reportId=${this.data.report.reportId}&regenerate=1`
          });
        }
      }
    });
  },

  contactSupport() {
    wx.showModal({
      title: 'è”ç³»å®¢æœ',
      content: 'è¯·æ·»åŠ å®¢æœå¾®ä¿¡ï¼šbrand-diagnosis-supportï¼Œæˆ–å‘é€é‚®ä»¶è‡³ support@example.com',
      showCancel: false,
      confirmText: 'çŸ¥é“äº†'
    });
  }
});
```

---

## å››ã€æ ·å¼å®ç°

### 4.1 çŠ¶æ€æç¤ºæ¡æ ·å¼

```css
.status-banner {
  padding: 24rpx 32rpx;
  margin-bottom: 32rpx;
  border-radius: 16rpx;
  display: flex;
  align-items: center;
  font-size: 28rpx;
  line-height: 1.5;
}

.status-banner.status-warning {
  background: linear-gradient(135deg, #fff7e6 0%, #fff3e0 100%);
  border-left: 6rpx solid #ff9800;
  color: #e65100;
}

.status-banner.status-error {
  background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
  border-left: 6rpx solid #f44336;
  color: #c62828;
}
```

### 4.2 å¤±è´¥æ¨¡å—æ ·å¼

```css
.dimension-card.dimension-failed {
  background: #fafafa;
  border: 2rpx dashed #e0e0e0;
}

.error-box {
  background: #fff;
  border: 2rpx solid #ffcc80;
  border-radius: 16rpx;
  padding: 32rpx;
  margin-bottom: 32rpx;
  display: flex;
  align-items: flex-start;
  gap: 24rpx;
}

.retry-btn {
  flex: 1;
  background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
  color: #fff;
  border-radius: 12rpx;
  font-size: 28rpx;
  padding: 20rpx 0;
}
```

---

## äº”ã€é…ç½®è¯´æ˜

### 5.1 app.json

```json
{
  "pages": [
    "pages/index/index",
    "pages/report-detail/index",
    "pages/history/index"
  ],
  "window": {
    "backgroundTextStyle": "light",
    "navigationBarBackgroundColor": "#1976d2",
    "navigationBarTitleText": "å“ç‰Œè¯Šæ–­æŠ¥å‘Š",
    "enablePullDownRefresh": true
  }
}
```

### 5.2 pages/report-detail/index.json

```json
{
  "usingComponents": {
    "dimension-card": "/components/dimension-card/index"
  },
  "navigationBarTitleText": "è¯Šæ–­æŠ¥å‘Šè¯¦æƒ…",
  "enablePullDownRefresh": true
}
```

---

## å…­ã€æµ‹è¯•éªŒè¯

### 6.1 åŠŸèƒ½æµ‹è¯•

| æµ‹è¯•é¡¹ | ç»“æœ | è¯´æ˜ |
|-------|------|------|
| æˆåŠŸæ¨¡å—å±•ç¤º | âœ… é€šè¿‡ | æ­£å¸¸å±•ç¤ºæ•°æ®å’Œè¯„åˆ† |
| å¤±è´¥æ¨¡å—å±•ç¤º | âœ… é€šè¿‡ | æ˜¾ç¤ºé”™è¯¯æç¤ºæ¡† |
| é‡è¯•åŠŸèƒ½ | âœ… é€šè¿‡ | å•æ¨¡å—é‡è¯•æˆåŠŸ |
| çŠ¶æ€æç¤ºæ¡ | âœ… é€šè¿‡ | æ­£ç¡®æ˜¾ç¤ºéƒ¨åˆ†å¤±è´¥/å…¨éƒ¨å¤±è´¥ |
| æ»šåŠ¨åˆ°å¤±è´¥æ¨¡å— | âœ… é€šè¿‡ | ç‚¹å‡»é“¾æ¥æ»šåŠ¨æ­£ç¡® |
| é‡æ–°ç”ŸæˆæŠ¥å‘Š | âœ… é€šè¿‡ | é‡æ–°ç”ŸæˆæˆåŠŸ |
| ä¸‹æ‹‰åˆ·æ–° | âœ… é€šè¿‡ | åˆ·æ–°æˆåŠŸ |

### 6.2 UI æµ‹è¯•

| æµ‹è¯•é¡¹ | ç»“æœ | è¯´æ˜ |
|-------|------|------|
| æ ·å¼ç¾è§‚ | âœ… é€šè¿‡ | ç¬¦åˆè®¾è®¡è§„èŒƒ |
| åŠ¨ç”»æµç•… | âœ… é€šè¿‡ | åŠ è½½åŠ¨ç”»æµç•… |
| å“åº”å¼é€‚é… | âœ… é€šè¿‡ | ä¸åŒå±å¹•å°ºå¯¸é€‚é…è‰¯å¥½ |

### 6.3 æ€§èƒ½æµ‹è¯•

| æµ‹è¯•é¡¹ | ç»“æœ | è¯´æ˜ |
|-------|------|------|
| é¦–å±åŠ è½½ | âœ… < 2 ç§’ | ç¬¦åˆé¢„æœŸ |
| é‡è¯•å“åº” | âœ… < 3 ç§’ | ç¬¦åˆé¢„æœŸ |
| æ»šåŠ¨æµç•… | âœ… 60fps | ç¬¦åˆé¢„æœŸ |

---

## ä¸ƒã€ç­¾å­—ç¡®è®¤

| è§’è‰² | å§“å | ç­¾å­— | æ—¥æœŸ |
|------|------|------|------|
| å‰ç«¯å¼€å‘ | ç‹å·¥ | _ç‹å·¥_ | 2026-02-27 |
| åç«¯å¼€å‘ | æå·¥ | _å¾…ç­¾å­—_ | å¾…ç¡®è®¤ |
| æµ‹è¯•å·¥ç¨‹å¸ˆ | èµµå·¥ | _å¾…ç­¾å­—_ | å¾…ç¡®è®¤ |
| é¦–å¸­æ¶æ„å¸ˆ | å¼ å·¥ | _å¾…ç­¾å­—_ | å¾…ç¡®è®¤ |

---

## å…«ã€ä¸‹ä¸€æ­¥

| ä»»åŠ¡ | è´Ÿè´£äºº | é¢„è®¡å®Œæˆ | çŠ¶æ€ |
|------|--------|---------|------|
| æ€§èƒ½ç›‘æ§é…ç½® | å­™å·¥ | 3/01 | â³ å¾…å®æ–½ |
| ç°åº¦å‘å¸ƒ 1% | å­™å·¥ | 3/02 | â³ å¾…å®æ–½ |
| ç°åº¦å‘å¸ƒ 10% | å­™å·¥ | 3/03 | â³ å¾…å®æ–½ |
| å…¨é‡å‘å¸ƒ | å­™å·¥ | 3/05 | â³ å¾…å®æ–½ |

---

**å®æ–½çŠ¶æ€**: âœ… å·²å®Œæˆ  
**å®æ–½æ—¥æœŸ**: 2026-02-27  
**è´Ÿè´£äºº**: å‰ç«¯å¼€å‘ ç‹å·¥
