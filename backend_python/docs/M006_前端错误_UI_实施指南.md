# M006: 前端错误 UI 实施指南

**实施编号**: IMPL-20260225-004  
**实施人**: 前端开发 王工  
**实施日期**: 2026-02-25  
**状态**: 📘 设计完成，待实施  

---

## 一、实施概述

### 1.1 改造目标

| 目标 | 改造前 | 改造后 |
|------|-------|--------|
| 错误展示 | ❌ 白屏/崩溃 | ✅ 友好提示框 |
| 部分失败 | ❌ 整个报告失败 | ✅ 失败模块单独展示 |
| 重试功能 | ❌ 无 | ✅ 单模块重试 |
| 状态提示 | ❌ 无 | ✅ 顶部提示条 |

### 1.2 改造范围

| 文件 | 修改类型 | 修改行数 | 状态 |
|------|---------|---------|------|
| `pages/report-detail/index.wxml` | 新增错误 UI | ~80 行 | ⏳ 待实施 |
| `pages/report-detail/index.wxss` | 新增错误样式 | ~100 行 | ⏳ 待实施 |
| `pages/report-detail/index.js` | 新增重试逻辑 | ~50 行 | ⏳ 待实施 |
| `components/dimension-card/index.wxml` | 改造组件 | ~60 行 | ⏳ 待实施 |

---

## 二、UI 设计

### 2.1 错误状态展示

#### 状态 1: 成功模块（保持原样）

```
┌─────────────────────────────────────┐
│  📊 社交媒体影响力                  │
│  ─────────────────────────────────  │
│  得分：85                           │
│  排名：第 3 名                        │
│  情感：正面                         │
│  [详细数据图表...]                  │
└─────────────────────────────────────┘
```

#### 状态 2: 失败模块（新增）

```
┌─────────────────────────────────────┐
│  📰 新闻舆情            ⚠️ 数据暂缺  │
│  ─────────────────────────────────  │
│  ┌───────────────────────────────┐  │
│  │ ⚠️ 【新闻舆情】AI 平台配额已用尽 │  │
│  │    此部分结果暂缺              │  │
│  │    请提醒管理员充值            │  │
│  │                               │  │
│  │    [🔄 重新获取]              │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

#### 状态 3: 部分失败提示条（新增）

```
┌─────────────────────────────────────┐
│ ℹ️ 部分数据获取失败，已为您展示已有结果│
│                      [查看失败模块↓] │
└─────────────────────────────────────┘
```

#### 状态 4: 全部失败（新增）

```
┌─────────────────────────────────────┐
│  ⚠️ 所有数据源均不可用               │
│                                     │
│  可能原因：                         │
│  • 网络连接中断                     │
│  • API 服务暂时不可用                │
│  • API 密钥配置错误                  │
│                                     │
│  [🔄 重新生成报告]  [💬 联系客服]   │
└─────────────────────────────────────┘
```

---

## 三、代码实现

### 3.1 WXML 结构改造

**文件**: `pages/report-detail/index.wxml`

```xml
<!-- 改造前 -->
<view class="report-container">
  <view class="report-header">
    <text class="brand-name">{{report.brandName}}</text>
    <text class="score">总分：{{report.overallScore}}</text>
  </view>
  
  <view class="dimensions-list">
    <view class="dimension-card" wx:for="{{report.dimensions}}" wx:key="source">
      <text class="dimension-name">{{item.name}}</text>
      <text class="dimension-score">得分：{{item.score}}</text>
      <!-- 原有内容 -->
    </view>
  </view>
</view>

<!-- 改造后 -->
<view class="report-container">
  <!-- M006 新增：顶部状态提示条 -->
  <view wx:if="{{report.overallStatus === 'completed_with_warnings'}}" class="status-banner status-warning">
    <text class="banner-icon">ℹ️</text>
    <text class="banner-text">部分数据获取失败，已为您展示已有结果</text>
    <text class="banner-link" bindtap="scrollToFailedModules">查看失败模块↓</text>
  </view>
  
  <view wx:elif="{{report.overallStatus === 'all_failed'}}" class="status-banner status-error">
    <text class="banner-icon">⚠️</text>
    <text class="banner-text">所有数据源均不可用，请稍后重试</text>
  </view>
  
  <view class="report-header">
    <text class="brand-name">{{report.brandName}}</text>
    <view class="score-container" wx:if="{{report.overallScore}}">
      <text class="score-label">总分</text>
      <text class="score-value">{{report.overallScore}}</text>
    </view>
    <view class="score-container" wx:else>
      <text class="score-label">评分</text>
      <text class="score-value score-none">暂缺</text>
    </view>
  </view>
  
  <view class="dimensions-list">
    <view 
      class="dimension-card {{item.status === 'failed' ? 'dimension-failed' : ''}}" 
      wx:for="{{report.dimensions}}" 
      wx:key="source"
      id="dimension-{{index}}"
    >
      <!-- M006 改造：根据状态展示不同 UI -->
      <view wx:if="{{item.status === 'success'}}">
        <!-- 成功状态：正常展示 -->
        <view class="dimension-header">
          <text class="dimension-name">{{item.dimension_name}}</text>
          <text class="badge badge-success">✅ 成功</text>
        </view>
        <view class="dimension-content">
          <view class="dimension-score">
            <text class="score-label">得分</text>
            <text class="score-value">{{item.score}}</text>
          </view>
          <!-- 原有详细数据展示 -->
          <view class="dimension-detail">
            <!-- ... 原有内容 ... -->
          </view>
        </view>
      </view>
      
      <view wx:else>
        <!-- 失败状态：显示错误提示框 -->
        <view class="dimension-header">
          <text class="dimension-name">{{item.dimension_name}}</text>
          <text class="badge badge-warning">⚠️ 数据暂缺</text>
        </view>
        <view class="dimension-error">
          <view class="error-box">
            <text class="error-icon">⚠️</text>
            <text class="error-message">{{item.error_message || '数据获取失败，请稍后重试'}}</text>
          </view>
          <view class="error-actions">
            <button 
              class="retry-btn" 
              bindtap="retryDimension" 
              data-dimension="{{item}}"
              data-index="{{index}}"
              loading="{{retryingIndex === index}}"
            >
              🔄 重新获取
            </button>
            <button class="help-btn" bindtap="contactSupport">
              💬 联系客服
            </button>
          </view>
        </view>
      </view>
    </view>
  </view>
  
  <!-- M006 新增：全部失败时的操作区 -->
  <view wx:if="{{report.overallStatus === 'all_failed'}}" class="all-failed-actions">
    <button class="regenerate-btn" bindtap="regenerateReport">
      🔄 重新生成报告
    </button>
    <button class="contact-btn" bindtap="contactSupport">
      💬 联系客服
    </button>
  </view>
</view>
```

### 3.2 WXSS 样式实现

**文件**: `pages/report-detail/index.wxss`

```css
/* 原有样式保持不变 */

/* ==================== */
/* M006 新增：状态提示条 */
/* ==================== */
.status-banner {
  padding: 24rpx 32rpx;
  margin: 0 32rpx 32rpx;
  border-radius: 16rpx;
  display: flex;
  align-items: center;
  font-size: 28rpx;
  line-height: 1.5;
}

.status-banner.status-warning {
  background: linear-gradient(135deg, #fff7e6 0%, #fff3e0 100%);
  border-left: 6rpx solid #ff9800;
  color: #e65100;
}

.status-banner.status-error {
  background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
  border-left: 6rpx solid #f44336;
  color: #c62828;
}

.banner-icon {
  font-size: 32rpx;
  margin-right: 16rpx;
}

.banner-text {
  flex: 1;
}

.banner-link {
  color: #1976d2;
  font-weight: 500;
  margin-left: 16rpx;
}

/* ==================== */
/* M006 新增：失败模块样式 */
/* ==================== */
.dimension-card.dimension-failed {
  background: #fafafa;
  border: 2rpx dashed #e0e0e0;
}

.dimension-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: 24rpx;
  border-bottom: 2rpx solid #f5f5f5;
  margin-bottom: 24rpx;
}

.badge {
  padding: 8rpx 16rpx;
  border-radius: 20rpx;
  font-size: 24rpx;
  font-weight: 500;
}

.badge-success {
  background: #e8f5e9;
  color: #2e7d32;
}

.badge-warning {
  background: #fff3e0;
  color: #e65100;
}

.badge-error {
  background: #ffebee;
  color: #c62828;
}

.dimension-error {
  padding: 32rpx;
}

.error-box {
  background: #fff;
  border: 2rpx solid #ffcc80;
  border-radius: 16rpx;
  padding: 32rpx;
  margin-bottom: 32rpx;
  display: flex;
  align-items: flex-start;
}

.error-icon {
  font-size: 40rpx;
  margin-right: 24rpx;
  flex-shrink: 0;
}

.error-message {
  flex: 1;
  font-size: 28rpx;
  line-height: 1.6;
  color: #666;
}

.error-actions {
  display: flex;
  gap: 24rpx;
}

.retry-btn {
  flex: 1;
  background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
  color: #fff;
  border-radius: 12rpx;
  font-size: 28rpx;
  padding: 20rpx 0;
}

.retry-btn[loading] {
  opacity: 0.7;
}

.help-btn {
  flex: 1;
  background: #fff;
  color: #666;
  border: 2rpx solid #e0e0e0;
  border-radius: 12rpx;
  font-size: 28rpx;
  padding: 20rpx 0;
}

/* ==================== */
/* M006 新增：全部失败操作区 */
/* ==================== */
.all-failed-actions {
  margin: 64rpx 32rpx 32rpx;
  padding: 64rpx 32rpx;
  background: #fff;
  border-radius: 24rpx;
  box-shadow: 0 4rpx 16rpx rgba(0, 0, 0, 0.1);
  text-align: center;
}

.all-failed-actions text {
  display: block;
  margin-bottom: 48rpx;
  font-size: 32rpx;
  color: #666;
  line-height: 1.6;
}

.regenerate-btn {
  width: 100%;
  background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
  color: #fff;
  border-radius: 16rpx;
  font-size: 32rpx;
  padding: 28rpx 0;
  margin-bottom: 24rpx;
}

.contact-btn {
  width: 100%;
  background: #fff;
  color: #666;
  border: 2rpx solid #e0e0e0;
  border-radius: 16rpx;
  font-size: 32rpx;
  padding: 28rpx 0;
}

/* ==================== */
/* M006 新增：评分暂缺样式 */
/* ==================== */
.score-none {
  color: #999;
  font-style: italic;
}

/* ==================== */
/* M006 新增：动画效果 */
/* ==================== */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-8rpx); }
  75% { transform: translateX(8rpx); }
}

.shake {
  animation: shake 0.3s ease-in-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(16rpx);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.fade-in {
  animation: fadeIn 0.3s ease-out;
}
```

### 3.3 JS 逻辑实现

**文件**: `pages/report-detail/index.js`

```javascript
// 原有代码保持不变

Page({
  data: {
    report: null,
    loading: true,
    retryingIndex: -1,  // M006 新增：正在重试的模块索引
    failedIndexes: []   // M006 新增：失败模块索引列表
  },

  onLoad(options) {
    const { reportId } = options;
    this.fetchReport(reportId);
  },

  // M006 新增：获取报告
  async fetchReport(reportId) {
    try {
      const res = await wx.request({
        url: `/api/diagnosis/report/${reportId}`,
        method: 'GET'
      });

      if (res.data.success) {
        const report = res.data.data;
        
        // M006 新增：识别失败模块
        const failedIndexes = [];
        report.dimensions?.forEach((dim, index) => {
          if (dim.status === 'failed') {
            failedIndexes.push(index);
          }
        });

        this.setData({
          report,
          failedIndexes,
          loading: false
        });

        // M006 新增：如果有失败模块，显示提示
        if (failedIndexes.length > 0 && failedIndexes.length < report.dimensions.length) {
          wx.showToast({
            title: '部分数据获取失败',
            icon: 'none',
            duration: 3000
          });
        }
      } else {
        this.setData({
          loading: false,
          report: {
            overallStatus: 'all_failed',
            error: res.data.error || '获取报告失败'
          }
        });
      }
    } catch (error) {
      console.error('获取报告失败:', error);
      this.setData({
        loading: false,
        report: {
          overallStatus: 'all_failed',
          error: '网络请求失败，请检查网络连接'
        }
      });
    }
  },

  // M006 新增：重试单个模块
  async retryDimension(e) {
    const { dimension, index } = e.currentTarget.dataset;
    
    this.setData({ retryingIndex: index });

    try {
      // 显示加载提示
      wx.showLoading({ title: '重新获取中...', mask: true });

      // 调用重试 API（需要后端支持）
      const res = await wx.request({
        url: '/api/diagnosis/retry-dimension',
        method: 'POST',
        data: {
          executionId: this.data.report.reportId,
          dimensionName: dimension.dimension_name,
          source: dimension.source
        }
      });

      wx.hideLoading();

      if (res.data.success) {
        // 重试成功，更新该模块数据
        const newDimensions = [...this.data.report.dimensions];
        newDimensions[index] = {
          ...res.data.data,
          status: 'success'
        };

        this.setData({
          report: {
            ...this.data.report,
            dimensions: newDimensions
          },
          retryingIndex: -1
        });

        wx.showToast({
          title: '重新获取成功',
          icon: 'success'
        });

        // M006 新增：重新计算总体状态
        this.recalculateOverallStatus();
      } else {
        wx.showToast({
          title: res.data.error || '重新获取失败',
          icon: 'none'
        });
        this.setData({ retryingIndex: -1 });
      }
    } catch (error) {
      console.error('重试失败:', error);
      wx.hideLoading();
      wx.showToast({
        title: '重试失败，请稍后重试',
        icon: 'none'
      });
      this.setData({ retryingIndex: -1 });
    }
  },

  // M006 新增：滚动到失败模块
  scrollToFailedModules() {
    if (this.data.failedIndexes.length > 0) {
      const firstFailedIndex = this.data.failedIndexes[0];
      wx.createSelectorQuery().select(`#dimension-${firstFailedIndex}`)
        .boundingClientRect((rect) => {
          if (rect) {
            wx.pageScrollTo({
              scrollTop: rect.top,
              duration: 300
            });
          }
        }).exec();
    }
  },

  // M006 新增：重新计算总体状态
  recalculateOverallStatus() {
    const dimensions = this.data.report.dimensions;
    const successCount = dimensions.filter(d => d.status === 'success').length;
    const totalCount = dimensions.length;

    let overallStatus = 'all_failed';
    if (successCount === totalCount) {
      overallStatus = 'completed';
    } else if (successCount > 0) {
      overallStatus = 'completed_with_warnings';
    }

    // 计算新的总体评分
    const successfulScores = dimensions
      .filter(d => d.status === 'success' && d.score)
      .map(d => d.score);
    
    const overallScore = successfulScores.length > 0
      ? successfulScores.reduce((a, b) => a + b, 0) / successfulScores.length
      : null;

    this.setData({
      report: {
        ...this.data.report,
        overallStatus,
        overallScore
      }
    });
  },

  // M006 新增：重新生成报告
  regenerateReport() {
    wx.showModal({
      title: '重新生成报告',
      content: '将使用相同的参数重新生成报告，确定继续？',
      success: (res) => {
        if (res.confirm) {
          wx.redirectTo({
            url: `/pages/report-detail/index?reportId=${this.data.report.reportId}&regenerate=1`
          });
        }
      }
    });
  },

  // M006 新增：联系客服
  contactSupport() {
    wx.showModal({
      title: '联系客服',
      content: '请添加客服微信：brand-diagnosis-support，或发送邮件至 support@example.com',
      showCancel: false,
      confirmText: '知道了'
    });
  },

  // M006 新增：下拉刷新
  onPullDownRefresh() {
    const reportId = this.data.report?.reportId;
    if (reportId) {
      this.fetchReport(reportId).finally(() => {
        wx.stopPullDownRefresh();
      });
    } else {
      wx.stopPullDownRefresh();
    }
  }
});
```

---

## 四、后端 API 支持

### 4.1 重试维度 API（待实现）

**端点**: `POST /api/diagnosis/retry-dimension`

**请求**:
```json
{
  "executionId": "exec_123",
  "dimensionName": "社交媒体影响力",
  "source": "weibo"
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "dimension_name": "社交媒体影响力",
    "source": "weibo",
    "status": "success",
    "score": 85,
    "data": { ... }
  }
}
```

### 4.2 历史报告查询 API（已实现）

**端点**: `GET /api/diagnosis/history/:userId`

**端点**: `GET /api/diagnosis/report/:reportId`

---

## 五、验收标准

### 5.1 功能验收

| 验收项 | 验收标准 | 状态 |
|-------|---------|------|
| 错误展示 | 失败模块显示友好提示框 | ⏳ 待验收 |
| 部分失败 | 成功模块正常，失败模块显示错误 | ⏳ 待验收 |
| 全部失败 | 显示全部失败页面，有操作按钮 | ⏳ 待验收 |
| 重试功能 | 点击重试可重新获取该模块 | ⏳ 待验收 |
| 状态提示 | 顶部显示部分失败提示条 | ⏳ 待验收 |

### 5.2 UI 验收

| 验收项 | 验收标准 | 状态 |
|-------|---------|------|
| 样式美观 | 符合设计规范 | ⏳ 待验收 |
| 动画流畅 | 加载、刷新动画流畅 | ⏳ 待验收 |
| 响应式 | 不同屏幕尺寸适配良好 | ⏳ 待验收 |
| 无障碍 | 支持屏幕阅读器 | ⏳ 待验收 |

### 5.3 性能验收

| 验收项 | 验收标准 | 状态 |
|-------|---------|------|
| 首屏加载 | < 2 秒 | ⏳ 待验收 |
| 重试响应 | < 3 秒 | ⏳ 待验收 |
| 滚动流畅 | 60fps | ⏳ 待验收 |

---

## 六、实施计划

| 任务 | 负责人 | 预计时间 | 状态 |
|------|--------|---------|------|
| WXML 结构改造 | 王工 | 2/26 4h | ⏳ 待实施 |
| WXSS 样式实现 | 王工 | 2/26 4h | ⏳ 待实施 |
| JS 逻辑实现 | 王工 | 2/26 4h | ⏳ 待实施 |
| 后端 API 支持 | 李工 | 2/26 4h | ⏳ 待实施 |
| 联调测试 | 王工 + 李工 | 2/27 4h | ⏳ 待实施 |
| UI 验收 | 王工 | 2/27 2h | ⏳ 待实施 |

---

## 七、签字确认

| 角色 | 姓名 | 签字 | 日期 |
|------|------|------|------|
| 前端开发 | 王工 | _待签字_ | 待确认 |
| 后端开发 | 李工 | _待签字_ | 待确认 |
| Code Review | 张工 | _待签字_ | 待确认 |
| 项目总指挥 | TPM | _待签字_ | 待确认 |

---

**文档状态**: 📘 设计完成，待实施  
**预计完成**: 2026-02-27  
**负责人**: 王工
