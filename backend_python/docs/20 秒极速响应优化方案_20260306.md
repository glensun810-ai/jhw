# å“ç‰Œè¯Šæ–­ç³»ç»Ÿ - 20 ç§’æé€Ÿå“åº”ä¼˜åŒ–æ–¹æ¡ˆ

**æŠ¥å‘Šç¼–å·**: PERF-OPT-20260306-001  
**åˆ¶å®šæ—¥æœŸ**: 2026-03-06  
**åˆ¶å®šäºº**: é¦–å¸­æ¶æ„å¸ˆ å¼ å·¥ + ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–å¤§å¸ˆ  
**ç´§æ€¥ç¨‹åº¦**: ğŸ”´ **æœ€é«˜ä¼˜å…ˆçº§ - P0**  
**ç›®æ ‡**: **20 ç§’å†…å®Œæˆè¯Šæ–­æŠ¥å‘Šç”Ÿæˆ**  

---

## ä¸€ã€ç°çŠ¶ä¸ç›®æ ‡å¯¹æ¯”

### 1.1 å½“å‰æ€§èƒ½

| æŒ‡æ ‡ | å½“å‰å€¼ | é—®é¢˜ |
|------|-------|------|
| æ€»è€—æ—¶ | >300 ç§’ (5 åˆ†é’Ÿ+) | âŒ ä¸å¯æ¥å— |
| æˆåŠŸç‡ | 0% | âŒ å®Œå…¨å¤±è´¥ |
| å¹¶å‘åº¦ | 1 (ä¸²è¡Œ) | âŒ èµ„æºæµªè´¹ |
| è¶…æ—¶é…ç½® | 30 ç§’/ä»»åŠ¡ | âš ï¸ è¿‡ç´§ |
| ç”¨æˆ·ä½“éªŒ | ç­‰å¾…åå¤±è´¥ | âŒ æå·® |

### 1.2 ç›®æ ‡æ€§èƒ½

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å¯¹æ ‡äº§å“ |
|------|-------|---------|
| æ€»è€—æ—¶ | **â‰¤20 ç§’** | AI æœç´¢ APP |
| æˆåŠŸç‡ | â‰¥99% | ç”Ÿäº§çº§æ ‡å‡† |
| å¹¶å‘åº¦ | 4-8 (å¹¶è¡Œ) | å……åˆ†åˆ©ç”¨ API |
| è¶…æ—¶é…ç½® | åŠ¨æ€è°ƒæ•´ | æ™ºèƒ½é€‚é… |
| ç”¨æˆ·ä½“éªŒ | æµç•…å¦‚ AI æœç´¢ | æè‡´ä½“éªŒ |

### 1.3 æ€§èƒ½å·®è·åˆ†æ

```
å½“å‰æµç¨‹ (ä¸²è¡Œ):
ä»»åŠ¡ 1(30s) â†’ ä»»åŠ¡ 2(30s) â†’ ... â†’ ä»»åŠ¡ 8(30s) = 240 ç§’ +

ç›®æ ‡æµç¨‹ (å¹¶è¡Œ):
ä»»åŠ¡ 1 â”€â”
ä»»åŠ¡ 2 â”€â”¤
ä»»åŠ¡ 3 â”€â”¼â”€â†’ å¹¶å‘æ‰§è¡Œ â†’ ç»“æœèšåˆ = 30 ç§’ (æœ€æ…¢ä»»åŠ¡è€—æ—¶)
ä»»åŠ¡ 4 â”€â”¤
...   â”€â”˜

æ€§èƒ½æå‡ï¼š240 ç§’ â†’ 30 ç§’ = **8 å€æå‡**
```

---

## äºŒã€æ ¸å¿ƒé—®é¢˜æ ¹å› åˆ†æ

### 2.1 æ¶æ„å±‚é¢é—®é¢˜

#### é—®é¢˜ 1: å•çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œ ğŸ”´ è‡´å‘½

**å½“å‰æ¶æ„**:
```python
# nxm_execution_engine.py - ä¸²è¡Œæ‰§è¡Œ
for brand in all_brands:          # 4 å“ç‰Œ
    for q_idx, question in enumerate(raw_questions):  # 1 é—®é¢˜
        for model_info in selected_models:  # 2 æ¨¡å‹
            # ä¸²è¡Œæ‰§è¡Œï¼Œæ€»ä»»åŠ¡æ•° = 4Ã—1Ã—2 = 8
            ai_result = call_ai(...)  # æ¯æ¬¡ 30 ç§’
```

**è€—æ—¶è®¡ç®—**:
- 8 ä¸ªä»»åŠ¡ Ã— 30 ç§’/ä»»åŠ¡ = **240 ç§’** (ç†è®ºæœ€å°å€¼)
- å®é™…è¶…æ—¶ + é‡è¯• = **>300 ç§’**

**ä¼˜åŒ–æ–¹æ¡ˆ**: å¹¶å‘æ‰§è¡Œ
```python
# ä½¿ç”¨ ThreadPoolExecutor å¹¶å‘
with ThreadPoolExecutor(max_workers=8) as executor:
    futures = [executor.submit(call_ai, task) for task in tasks]
    results = [f.result() for f in as_completed(futures, timeout=20)]
```

**é¢„æœŸè€—æ—¶**:
- 8 ä¸ªä»»åŠ¡å¹¶å‘æ‰§è¡Œ = **30 ç§’** (æœ€æ…¢ä»»åŠ¡è€—æ—¶)
- åŠ ä¸Šèšåˆå¼€é”€ = **â‰¤35 ç§’**

---

#### é—®é¢˜ 2: è¶…æ—¶é…ç½®ä¸åˆç† ğŸŸ¡ é«˜

**å½“å‰é…ç½®**:
```python
timeout = 30  # æ‰€æœ‰æ¨¡å‹ç»Ÿä¸€ 30 ç§’
```

**é—®é¢˜**:
- ç®€å•é—®é¢˜ 5 ç§’å¯å®Œæˆï¼Œé…ç½® 30 ç§’æµªè´¹
- å¤æ‚é—®é¢˜éœ€è¦ 60 ç§’ï¼Œ30 ç§’å¯¼è‡´å¤±è´¥
- æœªè€ƒè™‘ç½‘ç»œæ³¢åŠ¨

**ä¼˜åŒ–æ–¹æ¡ˆ**: åŠ¨æ€è¶…æ—¶é…ç½®
```python
TIMEOUT_CONFIG = {
    'doubao': {'simple': 15, 'normal': 30, 'complex': 60},
    'qwen': {'simple': 10, 'normal': 20, 'complex': 45},
    'deepseek': {'simple': 15, 'normal': 30, 'complex': 60},
    'zhipu': {'simple': 10, 'normal': 20, 'complex': 45},
}

# æ ¹æ®é—®é¢˜é•¿åº¦åŠ¨æ€é€‰æ‹©
def get_timeout(question: str, model: str) -> int:
    if len(question) < 20:
        return TIMEOUT_CONFIG[model]['simple']
    elif len(question) < 50:
        return TIMEOUT_CONFIG[model]['normal']
    else:
        return TIMEOUT_CONFIG[model]['complex']
```

---

#### é—®é¢˜ 3: ç†”æ–­å™¨è¿‡äºæ•æ„Ÿ ğŸŸ¡ é«˜

**å½“å‰é…ç½®**:
```python
failure_threshold = 3  # 3 æ¬¡å¤±è´¥å³ç†”æ–­
recovery_timeout = 60  # 60 ç§’åæ¢å¤
```

**é—®é¢˜**:
- ç½‘ç»œæ³¢åŠ¨å¯¼è‡´ 1-2 æ¬¡å¤±è´¥å³ç†”æ–­
- ç†”æ–­åæ‰€æœ‰å“ç‰Œéƒ½å—å½±å“
- æ¢å¤æ—¶é—´è¿‡é•¿

**ä¼˜åŒ–æ–¹æ¡ˆ**: æ™ºèƒ½ç†”æ–­
```python
# ç»†åŒ–ç†”æ–­ç²’åº¦ (æ¨¡å‹ + å“ç‰Œ)
circuit_breaker_key = f"{model_name}:{brand}"

# æé«˜é˜ˆå€¼
failure_threshold = 5
recovery_timeout = 30  # ç¼©çŸ­æ¢å¤æ—¶é—´

# åŠå¼€çŠ¶æ€æµ‹è¯•
def is_available(key):
    if state[key] == OPEN:
        if time.time() - last_failure[key] > recovery_timeout:
            state[key] = HALF_OPEN  # åŠå¼€çŠ¶æ€ï¼Œå…è®¸ä¸€æ¬¡æµ‹è¯•è¯·æ±‚
        return False
    return True
```

---

### 2.2 ä»£ç å±‚é¢é—®é¢˜

#### é—®é¢˜ 4: ç»“æœæ”¶é›†æ–¹æ³•ç¼ºå¤± ğŸ”´ è‡´å‘½

**é—®é¢˜**: `FaultTolerantExecutor.collect_result()` æ–¹æ³•ä¸å­˜åœ¨

**å½±å“**: æ‰€æœ‰ AI è°ƒç”¨ç»“æœæ— æ³•æ”¶é›†ï¼Œå¯¼è‡´ 0 æˆåŠŸç‡

**ä¿®å¤**: âœ… å·²ä¿®å¤ (è§ç´§æ€¥ä¿®å¤æŠ¥å‘Š)

---

#### é—®é¢˜ 5: çŠ¶æ€ç®¡ç†æ··ä¹± ğŸŸ¡ é«˜

**é—®é¢˜**: 
- `execution_store` å¯¼å…¥å¤±è´¥
- å†…å­˜çŠ¶æ€ä¸å¯é 
- æ•°æ®åº“çŠ¶æ€æœªå……åˆ†åˆ©ç”¨

**ä¿®å¤**: âœ… å·²ä¿®å¤ (æ”¹ç”¨æ•°æ®åº“å­˜å‚¨)

---

#### é—®é¢˜ 6: é”™è¯¯å¤„ç†é“¾è·¯é•¿ ğŸŸ¡ ä¸­

**é—®é¢˜**: é”™è¯¯ä¿¡æ¯åœ¨å¤šå±‚ä¼ é€’ä¸­ä¸¢å¤±

**ä¼˜åŒ–æ–¹æ¡ˆ**: ç»Ÿä¸€é”™è¯¯å¤„ç†
```python
class DiagnosisError(Exception):
    def __init__(self, error_type, error_code, error_message, recoverable=True):
        self.error_type = error_type
        self.error_code = error_code
        self.error_message = error_message
        self.recoverable = recoverable
        self.timestamp = datetime.now()
```

---

### 2.3 æµ‹è¯•å±‚é¢é—®é¢˜

#### é—®é¢˜ 7: æµ‹è¯•ä¸ç”Ÿäº§ä¸ä¸€è‡´ ğŸŸ¡ é«˜

**é—®é¢˜**:
| ç»´åº¦ | æµ‹è¯•ç¯å¢ƒ | ç”Ÿäº§ç¯å¢ƒ |
|------|---------|---------|
| AI è°ƒç”¨ | Mock (<1 ç§’) | çœŸå® API (>30 ç§’) |
| å¹¶å‘ | å•çº¿ç¨‹ | å•çº¿ç¨‹ |
| æ•°æ®é‡ | ç®€åŒ– | å®Œæ•´ |

**ä¼˜åŒ–æ–¹æ¡ˆ**: æ·»åŠ æ€§èƒ½æµ‹è¯•
```python
@pytest.mark.performance
def test_ai_call_performance():
    """æµ‹è¯•çœŸå® AI è°ƒç”¨æ€§èƒ½"""
    start = time.time()
    result = call_real_ai_api("20 ä¸‡å·¦å³çš„æ–°èƒ½æºæ±½è½¦å“ç‰Œæ¨è")
    elapsed = time.time() - start
    assert elapsed < 20, f"AI è°ƒç”¨è€—æ—¶{elapsed}ç§’ï¼Œè¶…è¿‡ 20 ç§’ç›®æ ‡"
```

---

## ä¸‰ã€ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡

### 3.1 æ¶æ„ä¼˜åŒ– (P0 - ç«‹å³æ‰§è¡Œ)

#### ä¼˜åŒ– 1: å¹¶å‘æ‰§è¡Œå¼•æ“

**è®¾è®¡ç›®æ ‡**: 8 ä¸ªä»»åŠ¡å¹¶å‘æ‰§è¡Œï¼Œæ€»è€—æ—¶â‰¤35 ç§’

**æ¶æ„å›¾**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¹¶å‘æ‰§è¡Œå¼•æ“                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä»»åŠ¡é˜Ÿåˆ— (8 ä¸ªä»»åŠ¡)                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ T1  â”‚ â”‚ T2  â”‚ â”‚ T3  â”‚ â”‚ T4  â”‚ â† ThreadPoolExecutor  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜    (max_workers=8)    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ T5  â”‚ â”‚ T6  â”‚ â”‚ T7  â”‚ â”‚ T8  â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚              â”‚
         â–¼              â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Doubao â”‚    â”‚  Qwen  â”‚    â”‚ Zhipu  â”‚
    â”‚  API   â”‚    â”‚  API   â”‚    â”‚  API   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  ç»“æœèšåˆ    â”‚
                 â”‚  (â‰¤5 ç§’)     â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  è¿”å›æŠ¥å‘Š    â”‚
                 â”‚  (â‰¤35 ç§’)    â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ä»£ç **:
```python
from concurrent.futures import ThreadPoolExecutor, as_completed, TimeoutError

def execute_nxm_test_concurrent(
    execution_id: str,
    tasks: List[Dict[str, Any]],
    max_workers: int = 8,
    timeout: int = 20
) -> Dict[str, Any]:
    """
    å¹¶å‘æ‰§è¡Œ NxM æµ‹è¯•
    
    å‚æ•°:
        execution_id: æ‰§è¡Œ ID
        tasks: ä»»åŠ¡åˆ—è¡¨
        max_workers: æœ€å¤§å¹¶å‘æ•°
        timeout: æ€»è¶…æ—¶æ—¶é—´ (ç§’)
    
    è¿”å›:
        æ‰§è¡Œç»“æœ
    """
    results = []
    start_time = time.time()
    
    with ThreadPoolExecutor(max_workers=max_workers) as executor:
        # æäº¤æ‰€æœ‰ä»»åŠ¡
        future_to_task = {
            executor.submit(execute_single_task, task): task
            for task in tasks
        }
        
        # æ”¶é›†ç»“æœ (å¸¦è¶…æ—¶)
        try:
            for future in as_completed(future_to_task, timeout=timeout):
                task = future_to_task[future]
                try:
                    result = future.result()
                    results.append(result)
                    
                    # å®æ—¶æŒä¹…åŒ–
                    save_dimension_result_from_result(result)
                    
                except Exception as e:
                    api_logger.error(f"ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼š{task}, é”™è¯¯ï¼š{e}")
                    results.append({
                        "task": task,
                        "error": str(e),
                        "status": "failed"
                    })
        except TimeoutError:
            api_logger.error(f"æ‰§è¡Œè¶…æ—¶ ({timeout}ç§’)")
    
    elapsed = time.time() - start_time
    api_logger.info(f"å¹¶å‘æ‰§è¡Œå®Œæˆï¼š{len(results)}/{len(tasks)}, è€—æ—¶ï¼š{elapsed:.2f}ç§’")
    
    return {
        "success": len(results) > 0,
        "results": results,
        "elapsed": elapsed,
        "total": len(tasks),
        "completed": len([r for r in results if r.get("status") == "success"])
    }
```

**é¢„æœŸæ•ˆæœ**:
- 8 ä¸ªä»»åŠ¡å¹¶å‘æ‰§è¡Œ
- æ€»è€—æ—¶ï¼š30-35 ç§’
- æˆåŠŸç‡ï¼šâ‰¥99%

---

#### ä¼˜åŒ– 2: æ™ºèƒ½è¶…æ—¶é…ç½®

**è®¾è®¡ç›®æ ‡**: æ ¹æ®é—®é¢˜å’Œæ¨¡å‹åŠ¨æ€è°ƒæ•´è¶…æ—¶

**å®ç°ä»£ç **:
```python
# wechat_backend/ai_timeout.py

from enum import Enum

class QuestionComplexity(Enum):
    SIMPLE = "simple"      # <20 å­—
    NORMAL = "normal"      # 20-50 å­—
    COMPLEX = "complex"    # >50 å­—

TIMEOUT_CONFIG = {
    'doubao': {
        QuestionComplexity.SIMPLE: 15,
        QuestionComplexity.NORMAL: 30,
        QuestionComplexity.COMPLEX: 60,
    },
    'qwen': {
        QuestionComplexity.SIMPLE: 10,
        QuestionComplexity.NORMAL: 20,
        QuestionComplexity.COMPLEX: 45,
    },
    'deepseek': {
        QuestionComplexity.SIMPLE: 15,
        QuestionComplexity.NORMAL: 30,
        QuestionComplexity.COMPLEX: 60,
    },
    'zhipu': {
        QuestionComplexity.SIMPLE: 10,
        QuestionComplexity.NORMAL: 20,
        QuestionComplexity.COMPLEX: 45,
    },
}

def get_timeout(question: str, model: str) -> int:
    """
    æ ¹æ®é—®é¢˜é•¿åº¦å’Œæ¨¡å‹è·å–è¶…æ—¶æ—¶é—´
    
    å‚æ•°:
        question: ç”¨æˆ·é—®é¢˜
        model: AI æ¨¡å‹åç§°
    
    è¿”å›:
        è¶…æ—¶æ—¶é—´ (ç§’)
    """
    # åˆ¤æ–­é—®é¢˜å¤æ‚åº¦
    length = len(question)
    if length < 20:
        complexity = QuestionComplexity.SIMPLE
    elif length < 50:
        complexity = QuestionComplexity.NORMAL
    else:
        complexity = QuestionComplexity.COMPLEX
    
    # è·å–è¶…æ—¶é…ç½®
    model_config = TIMEOUT_CONFIG.get(model, TIMEOUT_CONFIG['qwen'])
    timeout = model_config.get(complexity, 30)
    
    api_logger.debug(f"è¶…æ—¶é…ç½®ï¼š{model}, {complexity.value}, {timeout}ç§’")
    return timeout
```

**é¢„æœŸæ•ˆæœ**:
- ç®€å•é—®é¢˜ï¼š10-15 ç§’å®Œæˆ
- æ­£å¸¸é—®é¢˜ï¼š20-30 ç§’å®Œæˆ
- å¤æ‚é—®é¢˜ï¼š45-60 ç§’å®Œæˆ (å¯é…ç½®)

---

#### ä¼˜åŒ– 3: æ™ºèƒ½ç†”æ–­å™¨

**è®¾è®¡ç›®æ ‡**: ç»†ç²’åº¦ç†”æ–­ï¼Œé¿å…è¯¯è§¦å‘

**å®ç°ä»£ç **:
```python
# wechat_backend/smart_circuit_breaker.py

from enum import Enum
import time

class CircuitState(Enum):
    CLOSED = "closed"      # æ­£å¸¸
    OPEN = "open"          # ç†”æ–­
    HALF_OPEN = "half_open"  # åŠå¼€ (æµ‹è¯•)

class SmartCircuitBreaker:
    """æ™ºèƒ½ç†”æ–­å™¨"""
    
    def __init__(
        self,
        failure_threshold: int = 5,
        recovery_timeout: int = 30,
        half_open_max_calls: int = 1
    ):
        self.failure_threshold = failure_threshold
        self.recovery_timeout = recovery_timeout
        self.half_open_max_calls = half_open_max_calls
        
        # çŠ¶æ€å­˜å‚¨ (key: model:brand)
        self.states = {}
        self.failure_counts = {}
        self.last_failure_times = {}
        self.half_open_calls = {}
    
    def _get_key(self, model: str, brand: str) -> str:
        """ç”Ÿæˆç†”æ–­é”® (æ¨¡å‹ + å“ç‰Œ)"""
        return f"{model}:{brand}"
    
    def is_available(self, model: str, brand: str) -> bool:
        """æ£€æŸ¥æ˜¯å¦å¯ç”¨"""
        key = self._get_key(model, brand)
        state = self.states.get(key, CircuitState.CLOSED)
        
        if state == CircuitState.CLOSED:
            return True
        
        if state == CircuitState.OPEN:
            # æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ¢å¤æ—¶é—´
            last_failure = self.last_failure_times.get(key, 0)
            if time.time() - last_failure > self.recovery_timeout:
                # è¿›å…¥åŠå¼€çŠ¶æ€
                self.states[key] = CircuitState.HALF_OPEN
                self.half_open_calls[key] = 0
                api_logger.info(f"[ç†”æ–­å™¨] {key} è¿›å…¥åŠå¼€çŠ¶æ€")
                return True
            return False
        
        if state == CircuitState.HALF_OPEN:
            # åŠå¼€çŠ¶æ€å…è®¸æœ‰é™è°ƒç”¨
            calls = self.half_open_calls.get(key, 0)
            if calls < self.half_open_max_calls:
                self.half_open_calls[key] = calls + 1
                return True
            return False
        
        return True
    
    def record_success(self, model: str, brand: str):
        """è®°å½•æˆåŠŸ"""
        key = self._get_key(model, brand)
        self.failure_counts[key] = 0
        self.states[key] = CircuitState.CLOSED
        api_logger.debug(f"[ç†”æ–­å™¨] {key} æˆåŠŸï¼Œå·²é‡ç½®")
    
    def record_failure(self, model: str, brand: str):
        """è®°å½•å¤±è´¥"""
        key = self._get_key(model, brand)
        self.failure_counts[key] = self.failure_counts.get(key, 0) + 1
        self.last_failure_times[key] = time.time()
        
        # æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç†”æ–­é˜ˆå€¼
        if self.failure_counts[key] >= self.failure_threshold:
            self.states[key] = CircuitState.OPEN
            api_logger.warning(f"[ç†”æ–­å™¨] {key} å·²ç†”æ–­ (å¤±è´¥{self.failure_counts[key]}æ¬¡)")
        
        # åŠå¼€çŠ¶æ€å¤±è´¥ï¼Œè¿”å›ç†”æ–­
        if self.states.get(key) == CircuitState.HALF_OPEN:
            self.states[key] = CircuitState.OPEN
            self.last_failure_times[key] = time.time()
            api_logger.warning(f"[ç†”æ–­å™¨] {key} åŠå¼€æµ‹è¯•å¤±è´¥ï¼Œé‡æ–°ç†”æ–­")

# å…¨å±€å®ä¾‹
circuit_breaker = SmartCircuitBreaker(
    failure_threshold=5,      # 5 æ¬¡å¤±è´¥æ‰ç†”æ–­
    recovery_timeout=30,      # 30 ç§’åæ¢å¤
    half_open_max_calls=1     # åŠå¼€çŠ¶æ€å…è®¸ 1 æ¬¡æµ‹è¯•
)
```

**é¢„æœŸæ•ˆæœ**:
- ç†”æ–­è¯¯è§¦å‘å‡å°‘ 80%
- æ¢å¤æ—¶é—´ä» 60 ç§’ç¼©çŸ­åˆ° 30 ç§’
- ç»†ç²’åº¦ç†”æ–­ (æ¨¡å‹ + å“ç‰Œ)

---

### 3.2 ä»£ç ä¼˜åŒ– (P0 - ç«‹å³æ‰§è¡Œ)

#### ä¼˜åŒ– 4: ç®€åŒ–æ‰§è¡Œæµç¨‹

**å½“å‰æµç¨‹** (å†—ä½™):
```
åˆ›å»º loop â†’ è®¾ç½® loop â†’ è¿è¡Œ â†’ å…³é—­ loop â†’ è§£æ â†’ é‡è¯• â†’ ...
```

**ä¼˜åŒ–åæµç¨‹** (ç®€æ´):
```python
def execute_single_task(task: Dict[str, Any]) -> Dict[str, Any]:
    """æ‰§è¡Œå•ä¸ªä»»åŠ¡ (ç®€åŒ–ç‰ˆ)"""
    start = time.time()
    
    try:
        # 1. åˆ›å»ºå®¢æˆ·ç«¯
        client = AIAdapterFactory.create(task['model'])
        
        # 2. æ„å»ºæç¤ºè¯
        prompt = build_prompt(task['brand'], task['competitors'], task['question'])
        
        # 3. è°ƒç”¨ AI (å¸¦è¶…æ—¶)
        timeout = get_timeout(task['question'], task['model'])
        ai_result = client.send_prompt(prompt, timeout=timeout)
        
        # 4. è§£æç»“æœ
        geo_data = parse_geo(ai_result.data)
        
        # 5. è¿”å›ç»“æœ
        return {
            "brand": task['brand'],
            "model": task['model'],
            "status": "success",
            "data": geo_data,
            "elapsed": time.time() - start
        }
        
    except Exception as e:
        return {
            "brand": task['brand'],
            "model": task['model'],
            "status": "failed",
            "error": str(e),
            "elapsed": time.time() - start
        }
```

---

#### ä¼˜åŒ– 5: ä¼˜åŒ–æ•°æ®åº“å†™å…¥

**å½“å‰é—®é¢˜**: æ¯ä¸ªç»´åº¦ç»“æœéƒ½ç«‹å³å†™å…¥æ•°æ®åº“

**ä¼˜åŒ–æ–¹æ¡ˆ**: æ‰¹é‡å†™å…¥
```python
# ä½¿ç”¨äº‹åŠ¡æ‰¹é‡å†™å…¥
def save_dimension_results_batch(results: List[Dict[str, Any]], execution_id: str):
    """æ‰¹é‡ä¿å­˜ç»´åº¦ç»“æœ"""
    with get_db_connection() as conn:
        cursor = conn.cursor()
        
        # å¼€å¯äº‹åŠ¡
        cursor.execute("BEGIN TRANSACTION")
        
        try:
            for result in results:
                cursor.execute('''
                    INSERT INTO dimension_results (...)
                    VALUES (?, ?, ?, ?, ?, ?, ?)
                ''', (
                    execution_id,
                    result['brand'],
                    result['model'],
                    result['status'],
                    result.get('score'),
                    json.dumps(result.get('data')),
                    result.get('error')
                ))
            
            # æäº¤äº‹åŠ¡
            conn.commit()
            api_logger.info(f"æ‰¹é‡ä¿å­˜ {len(results)} ä¸ªç»´åº¦ç»“æœ")
            
        except Exception as e:
            conn.rollback()
            api_logger.error(f"æ‰¹é‡ä¿å­˜å¤±è´¥ï¼š{e}")
            raise
```

**é¢„æœŸæ•ˆæœ**:
- æ•°æ®åº“å†™å…¥è€—æ—¶ï¼š1 ç§’ â†’ 0.2 ç§’
- å‡å°‘æ•°æ®åº“è¿æ¥å¼€é”€

---

### 3.3 æµ‹è¯•ä¼˜åŒ– (P1 - çŸ­æœŸæ‰§è¡Œ)

#### ä¼˜åŒ– 6: æ·»åŠ æ€§èƒ½æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**:
```python
# tests/test_performance.py

import pytest
import time

class TestPerformance:
    """æ€§èƒ½æµ‹è¯•"""
    
    @pytest.mark.performance
    def test_end_to_end_latency(self):
        """ç«¯åˆ°ç«¯å»¶è¿Ÿæµ‹è¯•"""
        start = time.time()
        
        # æ‰§è¡Œè¯Šæ–­
        result = execute_diagnosis(
            brand="åä¸º",
            competitors=["å°ç±³", "ç‰¹æ–¯æ‹‰", "æ¯”äºšè¿ª"],
            question="20 ä¸‡å·¦å³çš„æ–°èƒ½æºæ±½è½¦å“ç‰Œæ¨è",
            models=["doubao", "qwen"]
        )
        
        elapsed = time.time() - start
        
        # éªŒè¯è€—æ—¶
        assert elapsed < 20, f"ç«¯åˆ°ç«¯è€—æ—¶{elapsed}ç§’ï¼Œè¶…è¿‡ 20 ç§’ç›®æ ‡"
        assert result['success'], "è¯Šæ–­å¤±è´¥"
    
    @pytest.mark.performance
    def test_concurrent_execution(self):
        """å¹¶å‘æ‰§è¡Œæµ‹è¯•"""
        tasks = [
            {"brand": "åä¸º", "model": "doubao", "question": "æµ‹è¯•é—®é¢˜ 1"},
            {"brand": "åä¸º", "model": "qwen", "question": "æµ‹è¯•é—®é¢˜ 2"},
            {"brand": "å°ç±³", "model": "doubao", "question": "æµ‹è¯•é—®é¢˜ 3"},
            {"brand": "å°ç±³", "model": "qwen", "question": "æµ‹è¯•é—®é¢˜ 4"},
        ]
        
        start = time.time()
        results = execute_nxm_test_concurrent(tasks, max_workers=4, timeout=20)
        elapsed = time.time() - start
        
        # éªŒè¯å¹¶å‘æ•ˆæœ
        assert elapsed < 20, f"å¹¶å‘æ‰§è¡Œè€—æ—¶{elapsed}ç§’"
        assert results['completed'] >= 3, f"æˆåŠŸç‡è¿‡ä½ï¼š{results['completed']}/{len(tasks)}"
```

---

## å››ã€å®æ–½è®¡åˆ’

### 4.1 P0 - ç´§æ€¥å®æ–½ (ä»Šå¤©å®Œæˆ)

| ä»»åŠ¡ | è´Ÿè´£äºº | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|------|--------|---------|------|
| 1. æ·»åŠ å¹¶å‘æ‰§è¡Œå¼•æ“ | æå·¥ | 4 å°æ—¶ | â³ å¾…æ‰§è¡Œ |
| 2. é…ç½®æ™ºèƒ½è¶…æ—¶ | æå·¥ | 2 å°æ—¶ | â³ å¾…æ‰§è¡Œ |
| 3. ä¼˜åŒ–ç†”æ–­å™¨ | æå·¥ | 2 å°æ—¶ | â³ å¾…æ‰§è¡Œ |
| 4. ç®€åŒ–æ‰§è¡Œæµç¨‹ | æå·¥ | 2 å°æ—¶ | â³ å¾…æ‰§è¡Œ |
| 5. éªŒè¯ä¿®å¤æ•ˆæœ | èµµå·¥ | 2 å°æ—¶ | â³ å¾…æ‰§è¡Œ |

**é¢„è®¡å®Œæˆæ—¶é—´**: ä»Šå¤© 20:00 å‰

### 4.2 P1 - çŸ­æœŸå®æ–½ (2 å¤©å†…å®Œæˆ)

| ä»»åŠ¡ | è´Ÿè´£äºº | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|------|--------|---------|------|
| 1. æ‰¹é‡æ•°æ®åº“å†™å…¥ | æå·¥ | 2 å°æ—¶ | â³ å¾…æ‰§è¡Œ |
| 2. æ·»åŠ æ€§èƒ½æµ‹è¯• | èµµå·¥ | 4 å°æ—¶ | â³ å¾…æ‰§è¡Œ |
| 3. æ·»åŠ ç›‘æ§å‘Šè­¦ | å­™å·¥ | 4 å°æ—¶ | â³ å¾…æ‰§è¡Œ |
| 4. æ€§èƒ½å›å½’æµ‹è¯• | èµµå·¥ | 4 å°æ—¶ | â³ å¾…æ‰§è¡Œ |

**é¢„è®¡å®Œæˆæ—¶é—´**: 2026-03-08

### 4.3 P2 - ä¸­æœŸä¼˜åŒ– (1 å‘¨å†…å®Œæˆ)

| ä»»åŠ¡ | è´Ÿè´£äºº | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|------|--------|---------|------|
| 1. å¼•å…¥å¼‚æ­¥æ¶æ„ | æå·¥ + å¼ å·¥ | 2 å¤© | â³ å¾…æ‰§è¡Œ |
| 2. æ·»åŠ ç»“æœç¼“å­˜ | æå·¥ | 1 å¤© | â³ å¾…æ‰§è¡Œ |
| 3. ä¼˜åŒ– AI æç¤ºè¯ | æå·¥ | 1 å¤© | â³ å¾…æ‰§è¡Œ |
| 4. å‹åŠ›æµ‹è¯• | èµµå·¥ | 1 å¤© | â³ å¾…æ‰§è¡Œ |

**é¢„è®¡å®Œæˆæ—¶é—´**: 2026-03-13

---

## äº”ã€é¢„æœŸæ•ˆæœ

### 5.1 æ€§èƒ½æå‡

| æŒ‡æ ‡ | å½“å‰å€¼ | ä¼˜åŒ–å | æå‡ |
|------|-------|--------|------|
| æ€»è€—æ—¶ | >300 ç§’ | â‰¤35 ç§’ | **8.5 å€** |
| æˆåŠŸç‡ | 0% | â‰¥99% | **+99%** |
| å¹¶å‘åº¦ | 1 | 8 | **8 å€** |
| ç”¨æˆ·ä½“éªŒ | å¤±è´¥ | æµç•… | **è´¨å˜** |

### 5.2 æˆæœ¬åˆ†æ

| é¡¹ç›® | å½“å‰æˆæœ¬ | ä¼˜åŒ–åæˆæœ¬ | å˜åŒ– |
|------|---------|-----------|------|
| è®¡ç®—èµ„æº | 1 æ ¸ | 8 æ ¸ (ä¸´æ—¶) | +7 æ ¸ |
| æ‰§è¡Œæ—¶é—´ | 300 ç§’ | 35 ç§’ | -88% |
| æ€» CPU ç§’ | 300 æ ¸ç§’ | 280 æ ¸ç§’ | -7% |
| ç”¨æˆ·ç­‰å¾… | 5 åˆ†é’Ÿ | 35 ç§’ | -88% |

**ç»“è®º**: æ€»è®¡ç®—æˆæœ¬ç•¥é™ï¼Œç”¨æˆ·ä½“éªŒå¤§å¹…æå‡

---

## å…­ã€é£é™©è¯„ä¼°

### 6.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| å¹¶å‘å¯¼è‡´ API é™æµ | é«˜ | ä¸­ | æ·»åŠ è¯·æ±‚é¢‘ç‡æ§åˆ¶ |
| å†…å­˜å ç”¨å¢åŠ  | ä¸­ | ä¸­ | ç›‘æ§å†…å­˜ä½¿ç”¨ |
| æ•°æ®åº“è¿æ¥è€—å°½ | ä¸­ | ä½ | è¿æ¥æ± ä¼˜åŒ– |

### 6.2 å›æ»šæ–¹æ¡ˆ

```bash
# ç´§æ€¥å›æ»šè„šæœ¬
git checkout HEAD~1 -- wechat_backend/nxm_execution_engine.py
git checkout HEAD~1 -- wechat_backend/fault_tolerant_executor.py
systemctl restart brand-diagnosis-backend
```

---

## ä¸ƒã€ç­¾å­—ç¡®è®¤

| è§’è‰² | å§“å | ç­¾å­— | æ—¥æœŸ |
|------|------|------|------|
| é¦–å¸­æ¶æ„å¸ˆ | å¼ å·¥ | _________ | _________ |
| åç«¯å¼€å‘ | æå·¥ | _________ | _________ |
| æµ‹è¯•å·¥ç¨‹å¸ˆ | èµµå·¥ | _________ | _________ |
| é¡¹ç›®æ€»æŒ‡æŒ¥ | TPM | _________ | _________ |

---

## å…«ã€ç»“è®º

### 8.1 æ ¸å¿ƒç»“è®º

**å½“å‰ç³»ç»Ÿæ€§èƒ½é—®é¢˜å¯é€šè¿‡å¹¶å‘æ‰§è¡Œå½»åº•è§£å†³ï¼Œç›®æ ‡ 20-35 ç§’å†…å®Œæˆè¯Šæ–­æŠ¥å‘Šç”Ÿæˆ**

### 8.2 å®æ–½ä¼˜å…ˆçº§

**P0 - ä»Šå¤©å®Œæˆ**:
1. å¹¶å‘æ‰§è¡Œå¼•æ“
2. æ™ºèƒ½è¶…æ—¶é…ç½®
3. æ™ºèƒ½ç†”æ–­å™¨

**P1 - 2 å¤©å†…å®Œæˆ**:
1. æ‰¹é‡æ•°æ®åº“å†™å…¥
2. æ€§èƒ½æµ‹è¯•
3. ç›‘æ§å‘Šè­¦

**P2 - 1 å‘¨å†…å®Œæˆ**:
1. å¼‚æ­¥æ¶æ„
2. ç»“æœç¼“å­˜
3. å‹åŠ›æµ‹è¯•

### 8.3 æˆåŠŸæ ‡å‡†

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | éªŒæ”¶æ—¶é—´ |
|------|-------|---------|
| æ€»è€—æ—¶ | â‰¤35 ç§’ | ä»Šå¤© |
| æˆåŠŸç‡ | â‰¥99% | ä»Šå¤© |
| å¹¶å‘åº¦ | 8 | ä»Šå¤© |
| ç”¨æˆ·æ»¡æ„åº¦ | â‰¥90% | 1 å‘¨ |

---

**æŠ¥å‘ŠçŠ¶æ€**: ğŸ”´ ç´§æ€¥å®æ–½ä¸­  
**åˆ¶å®šæ—¥æœŸ**: 2026-03-06  
**ä¸‹æ¬¡æ›´æ–°**: 2026-03-07 (P0 å®Œæˆå)  
**è´Ÿè´£äºº**: é¦–å¸­æ¶æ„å¸ˆ å¼ å·¥
