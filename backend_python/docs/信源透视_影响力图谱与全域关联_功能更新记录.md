# 信源透视——影响力图谱与全域关联 功能更新记录

**更新日期**: 2026年2月13日  
**版本**: v2.1  
**作者**: Evolution Bay Tech Team  

## 更新概述

本次更新实现了"信源透视——影响力图谱与全域关联"功能，主要包括：

1. 升级 SourceAggregator 模块，增加模型覆盖度和问题引用排名统计
2. 实现 ImpactCalculator，计算信源影响力指数
3. 在 API 响应中增加 cross_model_coverage 字段

## 详细变更

### 1. 逻辑升级：SourceAggregator 增强

#### 新增功能：
- **模型覆盖度统计**：计算每个 URL 被多少个不同的 AI 模型引用
- **问题引用排名**：跟踪每个 URL 被哪些搜索问题引用，便于分析热门问题
- **改进的 URL 提取**：修复正则表达式，避免重复条目

#### 代码变更：
- `wechat_backend/analytics/source_aggregator.py`：增强聚合逻辑，添加 cross_model_coverage 和 referenced_questions 字段

### 2. 影响力算法：ImpactCalculator 实现

#### 核心功能：
- **多因子影响力指数**：基于引用频率、模型覆盖度和情感偏向计算
- **加权评分系统**：
  - 引用次数权重：0.4
  - 模型覆盖度权重：0.3  
  - 情感偏向权重：0.3
- **权威度调整**：根据域名权威度应用乘数（高：1.2x，中：1.0x，低：0.8x）

#### 代码变更：
- `wechat_backend/analytics/impact_calculator.py`：全新实现影响力计算器

### 3. 数据呈现：API 响应增强

#### 新增字段：
- `cross_model_coverage`：跨模型覆盖度，表示被多少个不同 AI 模型引用
- `impact_index`：影响力指数（0-100）
- `referenced_questions`：引用此 URL 的问题列表
- `question_reference_count`：引用此 URL 的问题数量

#### 代码变更：
- `wechat_backend/analytics/source_intelligence_processor.py`：集成 ImpactCalculator 和增强的 SourceAggregator

## 技术实现细节

### 模型覆盖度计算
```python
# 统计每个 URL 的模型引用情况
url_stats = defaultdict(lambda: {
    'citation_count': 0,
    'models': set(),  # 存储引用此 URL 的模型名称
    'questions': set()  # 存储引用此 URL 的问题
})
```

### 影响力指数计算
```python
def calculate_impact_index(
    self,
    citation_count: int,
    model_coverage: int, 
    sentiment_score: float = 0.0,
    domain_authority: str = 'Medium'
) -> float:
    # 加权计算影响力指数
    weighted_impact = (
        normalized_citation_score * self.weights['citation_count'] +
        normalized_coverage_score * self.weights['model_coverage'] +
        normalized_sentiment_score * self.weights['sentiment_bias']
    )
    # 应用权威度乘数
    final_impact = weighted_impact * authority_multiplier
    return max(0.0, min(100.0, final_impact))
```

## 测试验证

### 核心测试场景
1. **多模型引用测试**：验证当一个信源被多个核心模型（豆包、Deepseek、通义千问、元宝等）同时引用时，影响力指数正确加权
2. **跨区域网络配置**：确保国内外模型配置互斥和提醒机制有效
3. **API 响应结构**：验证 cross_model_coverage 字段正确出现在响应中

### 测试结果
- ✅ 多模型引用影响力指数正确加权
- ✅ API 响应包含所需字段
- ✅ 国内外模型配置机制正常工作

## API 接口变更

### 请求/响应格式
- **请求**：保持不变
- **响应**：在 `/test/result/{task_id}` 的 `source_intelligence.source_pool` 中新增以下字段：
  - `cross_model_coverage`：跨模型覆盖度
  - `impact_index`：影响力指数
  - `referenced_questions`：引用问题列表
  - `question_reference_count`：引用问题数量

### 示例响应
```json
{
  "source_pool": [
    {
      "id": "abc123",
      "url": "https://zhihu.com/article/123",
      "site_name": "知乎",
      "citation_count": 5,
      "cross_model_coverage": 3,
      "domain_authority": "High",
      "impact_index": 75.5,
      "referenced_questions": ["智能锁品牌对比", "德施曼怎么样", "安全性评测"],
      "question_reference_count": 3
    }
  ]
}
```

## 配置说明

### 国内外网络配置
- 系统支持国内外模型配置的互斥和提醒
- 当无法同时调用国内外模型时，提供合理配置指导
- 在配置界面上提供明确的互斥提醒

## 向后兼容性

- 本次更新完全向后兼容
- 现有 API 接口保持不变
- 新增字段不会影响现有功能
- 所有现有测试用例继续通过

## 已知问题

- 在极少数情况下，URL 解析可能因特殊字符而产生异常
- 情感分析算法在处理复杂语境时可能存在偏差

## 下一步计划

1. 优化情感分析算法，提高准确性
2. 增加更多模型的覆盖度统计
3. 实现动态权重调整机制
4. 添加可视化图表展示影响力趋势

## 审核

- **技术审核**：通过
- **测试审核**：通过  
- **文档审核**：通过