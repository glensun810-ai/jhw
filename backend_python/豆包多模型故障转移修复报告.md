# è±†åŒ…å¤šæ¨¡å‹æ•…éšœè½¬ç§»ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2026-02-25  
**ä¿®å¤è´Ÿè´£äºº**: é¦–å¸­å…¨æ ˆå·¥ç¨‹å¸ˆ  
**é—®é¢˜ä¼˜å…ˆçº§**: ğŸ”´ ä¸¥é‡  

---

## é—®é¢˜æè¿°

ç”¨æˆ·é…ç½®äº† 4 ä¸ªè±†åŒ…æ¨¡å‹ IDï¼ŒæœŸæœ›åœ¨ç¬¬ä¸€ä¸ªæ¨¡å‹é…é¢ç”¨å°½ï¼ˆ429 é”™è¯¯ï¼‰æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ¨¡å‹ï¼Œä½†å®é™…å¹¶æœªè§¦å‘åˆ‡æ¢é€»è¾‘ã€‚

### é…ç½®çš„æ¨¡å‹

```bash
DOUBAO_MODEL_PRIORITY_1=doubao-seed-1-8-251228
DOUBAO_MODEL_PRIORITY_2=doubao-seed-2-0-mini-260215
DOUBAO_MODEL_PRIORITY_3=doubao-seed-2-0-pro-260215
DOUBAO_MODEL_PRIORITY_4=doubao-seed-2-0-lite-260215
```

### é”™è¯¯æ—¥å¿—

```
429 Client Error: Too Many Requests
SetLimitExceeded: Your account has reached the set inference limit
```

---

## æ ¹å› åˆ†æ

### é—®é¢˜ 1: 429 é”™è¯¯æœªè§¦å‘æ¨¡å‹åˆ‡æ¢

**æ–‡ä»¶**: `wechat_backend/ai_adapters/doubao_priority_adapter.py`

**åŸä»£ç ** (ç¬¬ 205 è¡Œ):
```python
if response.error_type in [AIErrorType.SERVICE_UNAVAILABLE, AIErrorType.SERVER_ERROR]:
    # å°è¯•åˆ‡æ¢æ¨¡å‹
```

**é—®é¢˜**: `AIErrorType.RATE_LIMIT_EXCEEDED`ï¼ˆ429 é”™è¯¯ï¼‰ä¸åœ¨åˆ‡æ¢æ¡ä»¶ä¸­

### é—®é¢˜ 2: å¼‚å¸¸å¤„ç†æœªè¯†åˆ« 429 é”™è¯¯

**æ–‡ä»¶**: `wechat_backend/ai_adapters/doubao_priority_adapter.py`

**åŸä»£ç ** (ç¬¬ 216 è¡Œ):
```python
except Exception as e:
    # å°è¯•åˆ‡æ¢æ¨¡å‹
    if self._retry_with_next_model(self.selected_model):
        # ...
```

**é—®é¢˜**: æ²¡æœ‰ä¸“é—¨å¤„ç† 429 é”™è¯¯çš„é€»è¾‘

---

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: æ·»åŠ  429 é”™è¯¯åˆ°åˆ‡æ¢æ¡ä»¶

**æ–‡ä»¶**: `wechat_backend/ai_adapters/doubao_priority_adapter.py`

**ä¿®æ”¹** (ç¬¬ 205-215 è¡Œ):
```python
# ä¿®å¤å‰
if response.error_type in [AIErrorType.SERVICE_UNAVAILABLE, AIErrorType.SERVER_ERROR]:
    api_logger.warning(f"[DoubaoPriority] æ¨¡å‹ {self.selected_model} è°ƒç”¨å¤±è´¥ï¼Œå°è¯•åˆ‡æ¢æ¨¡å‹")
    # ...

# ä¿®å¤å
if response.error_type in [AIErrorType.SERVICE_UNAVAILABLE, AIErrorType.SERVER_ERROR, AIErrorType.RATE_LIMIT_EXCEEDED]:
    api_logger.warning(f"[DoubaoPriority] æ¨¡å‹ {self.selected_model} è°ƒç”¨å¤±è´¥ ({response.error_type})ï¼Œå°è¯•åˆ‡æ¢æ¨¡å‹")
    # ...
```

### ä¿®å¤ 2: å¢å¼ºå¼‚å¸¸å¤„ç†ä¸­çš„ 429 è¯†åˆ«

**æ–‡ä»¶**: `wechat_backend/ai_adapters/doubao_priority_adapter.py`

**ä¿®æ”¹** (ç¬¬ 218-237 è¡Œ):
```python
except Exception as e:
    api_logger.error(f"[DoubaoPriority] å‘é€è¯·æ±‚å¼‚å¸¸ï¼š{str(e)}")

    # æ£€æŸ¥æ˜¯å¦æ˜¯ 429 é”™è¯¯ï¼ˆé…é¢ç”¨å°½ï¼‰
    error_str = str(e)
    is_quota_exceeded = '429' in error_str or 'SetLimitExceeded' in error_str or 'Too Many Requests' in error_str
    
    # å°è¯•åˆ‡æ¢æ¨¡å‹ï¼ˆå¦‚æœæ˜¯ 429 é”™è¯¯æˆ–å…¶ä»–å¯æ¢å¤é”™è¯¯ï¼‰
    if is_quota_exceeded or self._retry_with_next_model(self.selected_model):
        if is_quota_exceeded:
            api_logger.warning(f"[DoubaoPriority] æ£€æµ‹åˆ°é…é¢ç”¨å°½ï¼ˆ429ï¼‰ï¼Œå°è¯•åˆ‡æ¢æ¨¡å‹")
        if self._retry_with_next_model(self.selected_model):
            # åˆ‡æ¢æˆåŠŸï¼Œä½¿ç”¨æ–°æ¨¡å‹é‡è¯•
            api_logger.info(f"[DoubaoPriority] ä½¿ç”¨æ–°æ¨¡å‹ {self.selected_model} é‡è¯•")
            return self.selected_adapter.send_prompt(prompt, **kwargs)

    # è¿”å›é”™è¯¯å“åº”
    return AIResponse(
        success=False,
        error_message=str(e),
        error_type=AIErrorType.RATE_LIMIT_EXCEEDED if is_quota_exceeded else AIErrorType.UNKNOWN_ERROR,
        model=self.selected_model,
        platform='doubao'
    )
```

---

## å·¥ä½œæµç¨‹

### ä¿®å¤å‰

```
ç”¨æˆ·è¯·æ±‚
  â†“
è°ƒç”¨ doubao-seed-1-8 (P1)
  â†“
429 é”™è¯¯ï¼ˆé…é¢ç”¨å°½ï¼‰
  â†“
âŒ è¿”å›å¤±è´¥ï¼ˆæœªåˆ‡æ¢ï¼‰
```

### ä¿®å¤å

```
ç”¨æˆ·è¯·æ±‚
  â†“
è°ƒç”¨ doubao-seed-1-8 (P1)
  â†“
429 é”™è¯¯ï¼ˆé…é¢ç”¨å°½ï¼‰
  â†“
âœ… æ£€æµ‹åˆ° 429 é”™è¯¯
  â†“
âœ… åˆ‡æ¢åˆ° doubao-seed-2-0-mini (P2)
  â†“
é‡è¯•è¯·æ±‚
  â†“
æˆåŠŸ â†’ è¿”å›ç»“æœ
å¤±è´¥ â†’ ç»§ç»­åˆ‡æ¢ P3 â†’ P4
```

---

## éªŒè¯æ–¹æ³•

### æ–¹æ³• 1: æŸ¥çœ‹æ—¥å¿—

å¯åŠ¨è¯Šæ–­ä»»åŠ¡åï¼Œè§‚å¯Ÿæ—¥å¿—ï¼š

```bash
tail -f backend_python/logs/app.log | grep "DoubaoPriority"
```

**æœŸæœ›è¾“å‡º**:
```
[DoubaoPriority] æ£€æµ‹åˆ°é…é¢ç”¨å°½ï¼ˆ429ï¼‰ï¼Œå°è¯•åˆ‡æ¢æ¨¡å‹
[DoubaoPriority] åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªä¼˜å…ˆçº§æ¨¡å‹ï¼šdoubao-seed-2-0-mini-260215
[DoubaoPriority] âœ… æˆåŠŸåˆ‡æ¢åˆ°æ¨¡å‹ doubao-seed-2-0-mini-260215
[DoubaoPriority] ä½¿ç”¨æ–°æ¨¡å‹ doubao-seed-2-0-mini-260215 é‡è¯•
```

### æ–¹æ³• 2: ä½¿ç”¨æµ‹è¯•è„šæœ¬

```bash
cd backend_python
python3 test_doubao_429_switch.py
```

### æ–¹æ³• 3: å®é™…è¯Šæ–­æµ‹è¯•

1. åœ¨å¾®ä¿¡å°ç¨‹åºä¸­å‘èµ·å“ç‰Œè¯Šæ–­
2. è§‚å¯Ÿè½®è¯¢æ—¥å¿—
3. æ£€æŸ¥æœ€ç»ˆæ˜¯å¦è·å–åˆ°ç»“æœ

---

## é¢„æœŸæ•ˆæœ

### åœºæ™¯ 1: P1 é…é¢ç”¨å°½

- **P1**: 429 é”™è¯¯
- **P2**: âœ… æˆåŠŸ
- **ç»“æœ**: ä½¿ç”¨ P2 æ¨¡å‹è¿”å›ç»“æœ

### åœºæ™¯ 2: P1-P3 é…é¢ç”¨å°½

- **P1**: 429 é”™è¯¯
- **P2**: 429 é”™è¯¯
- **P3**: 429 é”™è¯¯
- **P4**: âœ… æˆåŠŸ
- **ç»“æœ**: ä½¿ç”¨ P4 æ¨¡å‹è¿”å›ç»“æœ

### åœºæ™¯ 3: æ‰€æœ‰æ¨¡å‹é…é¢ç”¨å°½

- **P1-P4**: å…¨éƒ¨ 429 é”™è¯¯
- **ç»“æœ**: è¿”å›å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯ "æ‰€æœ‰è±†åŒ…æ¨¡å‹é…é¢å‡å·²ç”¨å°½"

---

## ç›‘æ§å»ºè®®

### æ·»åŠ é…é¢ç›‘æ§

```python
# è®°å½•æ¯ä¸ªæ¨¡å‹çš„é…é¢ä½¿ç”¨æƒ…å†µ
model_quota_status = {
    'doubao-seed-1-8-251228': 'exhausted',
    'doubao-seed-2-0-mini-260215': 'active',
    'doubao-seed-2-0-pro-260215': 'active',
    'doubao-seed-2-0-lite-260215': 'active'
}
```

### æ·»åŠ å‘Šè­¦

å½“æ‰€æœ‰æ¨¡å‹éƒ½é…é¢ç”¨å°½æ—¶ï¼Œå‘é€å‘Šè­¦ï¼š
- é‚®ä»¶é€šçŸ¥
- çŸ­ä¿¡é€šçŸ¥
- é’‰é’‰/ä¼ä¸šå¾®ä¿¡æœºå™¨äºº

---

## åç»­ä¼˜åŒ–

### ä¼˜åŒ– 1: æ™ºèƒ½æ¨¡å‹é€‰æ‹©

æ ¹æ®é…é¢å‰©ä½™æƒ…å†µé€‰æ‹©æ¨¡å‹ï¼Œè€Œä¸æ˜¯æŒ‰å›ºå®šé¡ºåºï¼š

```python
def select_best_model(self):
    # ä¼˜å…ˆé€‰æ‹©é…é¢å……è¶³çš„æ¨¡å‹
    for model in self.priority_models:
        if self.get_quota_remaining(model) > THRESHOLD:
            return model
    return self.priority_models[0]
```

### ä¼˜åŒ– 2: é…é¢é¢„æµ‹

æ ¹æ®å†å²ä½¿ç”¨é‡é¢„æµ‹é…é¢è€—å°½æ—¶é—´ï¼š

```python
def predict_quota_exhaustion(model_id):
    daily_usage = get_average_daily_usage(model_id)
    remaining_quota = get_remaining_quota(model_id)
    days_until_exhaustion = remaining_quota / daily_usage
    return days_until_exhaustion
```

### ä¼˜åŒ– 3: è‡ªåŠ¨å……å€¼

å½“é…é¢ä½äºé˜ˆå€¼æ—¶è‡ªåŠ¨å……å€¼ï¼ˆéœ€è¦ API æ”¯æŒï¼‰ã€‚

---

## ç›¸å…³æ–‡ä»¶

### å·²ä¿®æ”¹

1. `wechat_backend/ai_adapters/doubao_priority_adapter.py`

### ç›¸å…³é…ç½®

1. `.env` - è±†åŒ…æ¨¡å‹ä¼˜å…ˆçº§é…ç½®
2. `config.py` - API Key åŠ è½½é€»è¾‘

### æµ‹è¯•æ–‡ä»¶

1. `test_doubao_429_switch.py` - æ¨¡å‹åˆ‡æ¢æµ‹è¯•è„šæœ¬

---

## éªŒæ”¶æ ‡å‡†

- [x] 429 é”™è¯¯è§¦å‘æ¨¡å‹åˆ‡æ¢
- [x] æŒ‰ä¼˜å…ˆçº§é¡ºåºå°è¯•æ¨¡å‹
- [x] åˆ‡æ¢æˆåŠŸæ—¶è®°å½•æ—¥å¿—
- [x] æ‰€æœ‰æ¨¡å‹å¤±è´¥æ—¶è¿”å›å‹å¥½é”™è¯¯
- [ ] å®é™…è¯Šæ–­ä»»åŠ¡æˆåŠŸè·å–ç»“æœï¼ˆå¾… API é…é¢æ¢å¤åéªŒè¯ï¼‰

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026-02-25 00:35:00  
**å¾…éªŒè¯**: è±†åŒ… API é…é¢æ¢å¤åéªŒè¯åˆ‡æ¢é€»è¾‘
