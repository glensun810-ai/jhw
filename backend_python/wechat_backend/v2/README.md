# å“ç‰Œè¯Šæ–­ç³»ç»Ÿ v2.0 æ¶æ„æ–‡æ¡£

**ç‰ˆæœ¬**: 2.0.0
**åˆ›å»ºæ—¥æœŸ**: 2026-02-27
**æœ€åæ›´æ–°**: 2026-02-27
**çŠ¶æ€**: ç°åº¦å‘å¸ƒä¸­ï¼ˆ10% æµé‡ï¼‰

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [æ ¸å¿ƒæ¨¡å—](#æ ¸å¿ƒæ¨¡å—)
3. [æ•°æ®æµå›¾](#æ•°æ®æµå›¾)
4. [API æ¥å£](#api æ¥å£)
5. [éƒ¨ç½²æŒ‡å—](#éƒ¨ç½²æŒ‡å—)
6. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## æ¶æ„æ¦‚è§ˆ

### è®¾è®¡åŸåˆ™

1. **ç”¨æˆ·ç¬¬ä¸€**: æ‰€æœ‰æŠ€æœ¯å†³ç­–æœåŠ¡äº"è®©ç”¨æˆ·è·å–çœŸå®å“ç‰Œè¯Šæ–­æŠ¥å‘Š"
2. **å®‰å…¨ç¬¬ä¸€**: å®å¯æ…¢ï¼Œä¸å¯ä¹±ï¼Œç¡®ä¿éšæ—¶å¯ä»¥å›æ»š
3. **æ•°æ®çœŸå®**: ç¦æ­¢ä¼ªé€ ã€æ¨¡æ‹Ÿè¯Šæ–­æ•°æ®
4. **æ¸è¿›å¼äº¤ä»˜**: åˆ†é˜¶æ®µã€å°æ­¥å¿«è·‘ï¼Œç¦æ­¢"å¤§çˆ†ç‚¸"å¼é‡æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Frontend (Web)                      â”‚
â”‚  - å“ç‰Œé€‰æ‹©  - æ¨¡å‹é…ç½®  - è¿›åº¦è½®è¯¢  - æŠ¥å‘Šå±•ç¤º          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTP/REST API
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   API Layer (Flask)                      â”‚
â”‚  - /api/perform-brand-test (æ—§ç‰ˆï¼Œå…¼å®¹)                  â”‚
â”‚  - /api/v2/diagnostic/tasks/* (v2 API)                   â”‚
â”‚  - è®¤è¯/é™æµ/æ—¥å¿—/è¶…æ—¶ä¿æŠ¤                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Service Layer (v2)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ DiagnosisService          è¯Šæ–­æ ¸å¿ƒæœåŠ¡           â”‚    â”‚
â”‚  â”‚ TimeoutService            è¶…æ—¶ç®¡ç†æœåŠ¡           â”‚    â”‚
â”‚  â”‚ ReportStubService         æŠ¥å‘Šå­˜æ ¹æœåŠ¡           â”‚    â”‚
â”‚  â”‚ DeadLetterQueue           æ­»ä¿¡é˜Ÿåˆ—æœåŠ¡           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               State Machine Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ DiagnosisStateMachine     çŠ¶æ€æœºæ ¸å¿ƒ             â”‚    â”‚
â”‚  â”‚ States                    çŠ¶æ€å®šä¹‰               â”‚    â”‚
â”‚  â”‚ Transitions               çŠ¶æ€æµè½¬               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Repository Layer (Data Access)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ DiagnosisRepository         è¯Šæ–­æŠ¥å‘Š CRUD         â”‚    â”‚
â”‚  â”‚ DiagnosisResultRepository   è¯Šæ–­ç»“æœ CRUD         â”‚    â”‚
â”‚  â”‚ ApiCallLogRepository        API è°ƒç”¨æ—¥å¿— CRUD      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Database (SQLite)                      â”‚
â”‚  - diagnosis_reports       è¯Šæ–­æŠ¥å‘Šä¸»è¡¨                 â”‚
â”‚  - diagnosis_results       è¯Šæ–­ç»“æœæ˜ç»†è¡¨               â”‚
â”‚  - diagnosis_analysis      è¯Šæ–­åˆ†æè¡¨                   â”‚
â”‚  - api_call_logs           API è°ƒç”¨æ—¥å¿—è¡¨               â”‚
â”‚  - dead_letter_queue       æ­»ä¿¡é˜Ÿåˆ—è¡¨                   â”‚
â”‚  - cache_entries           ç¼“å­˜è¡¨                       â”‚
â”‚  - audit_logs              å®¡è®¡æ—¥å¿—è¡¨                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæ¨¡å—

### 1. çŠ¶æ€æœºæ¨¡å— (`state_machine/`)

**èŒè´£**: ç®¡ç†è¯Šæ–­ä»»åŠ¡çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ

**æ ¸å¿ƒç±»**:
- `DiagnosisStateMachine`: çŠ¶æ€æœºæ ¸å¿ƒ
- `DiagnosisState`: çŠ¶æ€æšä¸¾
- `StateTransition`: çŠ¶æ€æµè½¬å®šä¹‰

**çŠ¶æ€æµè½¬å›¾**:
```
INITIALIZING â†’ AI_FETCHING â†’ ANALYZING â†’ COMPLETED
                         â†“
                    PARTIAL_SUCCESS
                         â†“
                    FAILED/TIMEOUT
```

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from wechat_backend.v2.state_machine.diagnosis_state_machine import DiagnosisStateMachine

state_machine = DiagnosisStateMachine(
    execution_id='exec-123',
    repository=diagnosis_repo,
)

# çŠ¶æ€æµè½¬
state_machine.transition(
    event='succeed',
    progress=50,
    config={'brand_name': 'å“ç‰Œ A'}
)
```

### 2. è¶…æ—¶ç®¡ç†æœåŠ¡ (`services/timeout_service.py`)

**èŒè´£**: ä¸ºè¯Šæ–­ä»»åŠ¡æä¾› 10 åˆ†é’Ÿè¶…æ—¶ä¿æŠ¤

**æ ¸å¿ƒåŠŸèƒ½**:
- å¯åŠ¨/å–æ¶ˆè¶…æ—¶è®¡æ—¶å™¨
- è¶…æ—¶å›è°ƒå¤„ç†
- å‰©ä½™æ—¶é—´æŸ¥è¯¢

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from wechat_backend.v2.services.timeout_service import TimeoutManager

timeout_manager = TimeoutManager()

def on_timeout(execution_id):
    print(f"Task {execution_id} timed out")

# å¯åŠ¨è®¡æ—¶å™¨
timeout_manager.start_timer(
    execution_id='exec-123',
    on_timeout=on_timeout,
    timeout_seconds=600  # 10 åˆ†é’Ÿ
)

# å®Œæˆåå–æ¶ˆ
timeout_manager.cancel_timer('exec-123')
```

### 3. æŠ¥å‘Šå­˜æ ¹æœåŠ¡ (`services/report_stub_service.py`)

**èŒè´£**: åœ¨è¯Šæ–­å¤±è´¥/éƒ¨åˆ†æˆåŠŸ/è¶…æ—¶æ—¶ï¼Œç”Ÿæˆæœ‰æ„ä¹‰çš„æŠ¥å‘Šå­˜æ ¹

**æ ¸å¿ƒåŠŸèƒ½**:
- ä»è¯Šæ–­è®°å½•æ„å»ºå­˜æ ¹
- åŒ…å«éƒ¨åˆ†ç»“æœæ•°æ®
- æä¾›å‹å¥½é”™è¯¯ä¿¡æ¯å’Œå»ºè®®

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from wechat_backend.v2.services.report_stub_service import ReportStubService

stub_service = ReportStubService()

# è·å–å­˜æ ¹æŠ¥å‘Š
stub = stub_service.get_stub_report(
    execution_id='exec-123',
    include_partial_results=True
)

# è½¬æ¢ä¸º API å“åº”
response = stub.to_dict()
```

### 4. æ­»ä¿¡é˜Ÿåˆ—æœåŠ¡ (`services/dead_letter_queue.py`)

**èŒè´£**: å­˜å‚¨å’Œè¿½è¸ªæ— æ³•è‡ªåŠ¨æ¢å¤çš„å¤±è´¥ä»»åŠ¡

**æ ¸å¿ƒåŠŸèƒ½**:
- æ·»åŠ å¤±è´¥ä»»åŠ¡
- æŸ¥è¯¢/åˆ†é¡µ/è¿‡æ»¤
- é‡è¯•æœºåˆ¶
- ç»Ÿè®¡åˆ†æ

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from wechat_backend.v2.services.dead_letter_queue import DeadLetterQueue

dlq = DeadLetterQueue()

# æ·»åŠ å¤±è´¥ä»»åŠ¡
dlq.add_to_dead_letter(
    execution_id='exec-123',
    task_type='ai_call',
    error=TimeoutError('Timeout'),
    task_context={'brand': 'å“ç‰Œ A'}
)

# æŸ¥è¯¢ç»Ÿè®¡
stats = dlq.get_statistics()
```

### 5. ç‰¹æ€§å¼€å…³ç®¡ç† (`feature_flags.py`)

**èŒè´£**: æ§åˆ¶ v2 åŠŸèƒ½çš„ç°åº¦å‘å¸ƒ

**é…ç½®é¡¹**:
```python
FEATURE_FLAGS = {
    'diagnosis_v2_enabled': True,         # æ€»å¼€å…³
    'diagnosis_v2_timeout': True,         # è¶…æ—¶æœºåˆ¶
    'diagnosis_v2_report_stub': True,     # æŠ¥å‘Šå­˜æ ¹
    'diagnosis_v2_dead_letter': True,     # æ­»ä¿¡é˜Ÿåˆ—
    'diagnosis_v2_gray_users': [],        # ç°åº¦ç”¨æˆ·åˆ—è¡¨
    'diagnosis_v2_gray_percentage': 10,   # ç°åº¦ç™¾åˆ†æ¯”
}
```

---

## æ•°æ®æµå›¾

### è¯Šæ–­ä»»åŠ¡æ‰§è¡Œæµç¨‹

```
1. å‰ç«¯å‘èµ·è¯Šæ–­è¯·æ±‚
   â”‚
   â–¼
2. API å±‚éªŒè¯å‚æ•°
   â”‚
   â”œâ”€â†’ å¯åŠ¨å…¨å±€è¶…æ—¶è®¡æ—¶å™¨ (P1-T2)
   â”‚
   â–¼
3. åˆ›å»ºè¯Šæ–­æŠ¥å‘Šåˆå§‹è®°å½•
   â”‚
   â”œâ”€â†’ ç”Ÿæˆ execution_id
   â”œâ”€â†’ å†™å…¥ diagnosis_reports è¡¨
   â””â”€â†’ è®¾ç½® should_stop_polling=false
   â”‚
   â–¼
4. å¯åŠ¨å¼‚æ­¥è¯Šæ–­çº¿ç¨‹
   â”‚
   â”œâ”€â†’ çŠ¶æ€æœºåˆå§‹åŒ– (INITIALIZING)
   â”œâ”€â†’ æ‰§è¡Œ NxM æµ‹è¯•
   â”‚
   â–¼
5. AI æ¨¡å‹è°ƒç”¨å¾ªç¯
   â”‚
   â”œâ”€â†’ å“ç‰Œ Ã— é—®é¢˜ Ã— æ¨¡å‹
   â”œâ”€â†’ API è°ƒç”¨æ—¥å¿—è®°å½•
   â””â”€â†’ ç»“æœå­˜å‚¨
   â”‚
   â–¼
6. æ•°æ®åˆ†æä¸èšåˆ
   â”‚
   â”œâ”€â†’ å“ç‰Œåˆ†å¸ƒç»Ÿè®¡
   â”œâ”€â†’ æƒ…æ„Ÿåˆ†æ
   â””â”€â†’ å…³é”®è¯æå–
   â”‚
   â–¼
7. å®Œæˆè¯Šæ–­
   â”‚
   â”œâ”€â†’ çŠ¶æ€æµè½¬åˆ° COMPLETED
   â”œâ”€â†’ should_stop_polling=true
   â”œâ”€â†’ å–æ¶ˆè¶…æ—¶è®¡æ—¶å™¨
   â””â”€â†’ å‘é€ SSE å®Œæˆé€šçŸ¥
   â”‚
   â–¼
8. å‰ç«¯è½®è¯¢è·å–æŠ¥å‘Š
      â”‚
      â”œâ”€â†’ å®Œæ•´æŠ¥å‘Šå¯ç”¨ â†’ è¿”å›å®Œæ•´æŠ¥å‘Š
      â””â”€â†’ å®Œæ•´æŠ¥å‘Šä¸å¯ç”¨ â†’ è¿”å›å­˜æ ¹æŠ¥å‘Š
```

---

## API æ¥å£

### v2 API ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/v2/diagnostic/tasks` | POST | åˆ›å»ºè¯Šæ–­ä»»åŠ¡ |
| `/api/v2/diagnostic/tasks/{taskId}/status` | GET | æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ |
| `/api/v2/diagnostic/tasks/{taskId}/report` | GET | è·å–è¯Šæ–­æŠ¥å‘Š |
| `/api/v2/diagnostic/tasks/{taskId}/stub` | GET | è·å–å­˜æ ¹æŠ¥å‘Š |

### è¯·æ±‚ç¤ºä¾‹

```bash
# åˆ›å»ºè¯Šæ–­ä»»åŠ¡
curl -X POST http://localhost:5000/api/v2/diagnostic/tasks \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "brand_list": ["å“ç‰Œ A", "å“ç‰Œ B"],
    "selected_models": ["deepseek", "doubao"],
    "custom_question": "å“ç‰Œ A çš„æ ¸å¿ƒç«äº‰åŠ›æ˜¯ä»€ä¹ˆï¼Ÿ"
  }'

# æŸ¥è¯¢çŠ¶æ€
curl -X GET http://localhost:5000/api/v2/diagnostic/tasks/exec-123/status

# è·å–æŠ¥å‘Š
curl -X GET http://localhost:5000/api/v2/diagnostic/tasks/exec-123/report
```

### å“åº”æ ¼å¼

**æˆåŠŸå“åº”**:
```json
{
  "status": "success",
  "data": {
    "execution_id": "exec-123",
    "report_id": 12345,
    "brand_name": "å“ç‰Œ A",
    "analysis": {...},
    "results": [...]
  },
  "meta": {
    "request_id": "req-xxx",
    "timestamp": "2026-02-27T10:00:00Z"
  }
}
```

**é”™è¯¯å“åº”**:
```json
{
  "status": "error",
  "error": {
    "code": "DIAGNOSIS_TIMEOUT",
    "message": "è¯Šæ–­ä»»åŠ¡æ‰§è¡Œè¶…æ—¶",
    "details": {
      "execution_id": "exec-123",
      "elapsed_time": 650,
      "max_allowed": 600
    }
  },
  "meta": {
    "request_id": "req-xxx",
    "timestamp": "2026-02-27T10:00:00Z"
  }
}
```

---

## éƒ¨ç½²æŒ‡å—

### ç¯å¢ƒè¦æ±‚

- Python 3.8+
- SQLite 3.35+
- Flask 2.0+

### éƒ¨ç½²æ­¥éª¤

```bash
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. åˆå§‹åŒ–æ•°æ®åº“
python -m wechat_backend.database_core

# 3. é…ç½®ç¯å¢ƒå˜é‡
export FLASK_ENV=production
export SECRET_KEY=<your-secret-key>

# 4. å¯åŠ¨æœåŠ¡
python -m wechat_backend.main
```

### ç°åº¦å‘å¸ƒé…ç½®

ç¼–è¾‘ `wechat_backend/v2/feature_flags.py`:

```python
FEATURE_FLAGS = {
    'diagnosis_v2_enabled': True,
    'diagnosis_v2_gray_users': ['test_user_001'],
    'diagnosis_v2_gray_percentage': 10,  # 10% æµé‡
}
```

### ç›‘æ§æŒ‡æ ‡

- **é”™è¯¯ç‡**: < 5%
- **è¶…æ—¶ç‡**: < 2%
- **å¹³å‡å“åº”æ—¶é—´**: < 30s
- **æ­»ä¿¡é˜Ÿåˆ—å¢é•¿**: < 10/å°æ—¶

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. å‰ç«¯æŒç»­ loadingï¼ˆ"å¡æ­»"ï¼‰

**åŸå› **: `should_stop_polling` å­—æ®µç¼ºå¤±æˆ–çŠ¶æ€æœªæ­£ç¡®æ›´æ–°

**è§£å†³**:
```sql
-- æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨
PRAGMA table_info(diagnosis_reports);

-- å¦‚æœç¼ºå¤±ï¼Œæ·»åŠ å­—æ®µ
ALTER TABLE diagnosis_reports ADD COLUMN should_stop_polling BOOLEAN DEFAULT 0;
CREATE INDEX idx_diagnosis_reports_execution_id ON diagnosis_reports(execution_id);
```

#### 2. è¯Šæ–­ä»»åŠ¡è¶…æ—¶

**åŸå› **: ä»»åŠ¡æ‰§è¡Œè¶…è¿‡ 10 åˆ†é’Ÿ

**è§£å†³**:
1. æ£€æŸ¥æ—¥å¿—ï¼š`grep "global_timeout_triggered" logs/*.log`
2. æŸ¥çœ‹æ­»ä¿¡é˜Ÿåˆ—ï¼š`python -c "from wechat_backend.v2.services.dead_letter_queue import DeadLetterQueue; dlq = DeadLetterQueue(); print(dlq.get_statistics())"`
3. åˆ†æå¤±è´¥åŸå› ï¼Œä¼˜åŒ– AI è°ƒç”¨æˆ–å¢åŠ è¶…æ—¶æ—¶é—´

#### 3. æ•°æ®åº“é”ç«äº‰

**åŸå› **: å¹¶å‘å†™å…¥å¯¼è‡´ SQLite é”ç­‰å¾…

**è§£å†³**:
```python
# ä½¿ç”¨è¿æ¥æ± 
from wechat_backend.database_connection_pool import get_db_pool

conn = get_db_pool().get_connection()
# ä½¿ç”¨ WAL æ¨¡å¼
cursor.execute("PRAGMA journal_mode=WAL")
```

### æ—¥å¿—æŸ¥è¯¢

```bash
# æŸ¥è¯¢è¶…æ—¶æ—¥å¿—
grep "timeout" logs/*.log

# æŸ¥è¯¢é”™è¯¯æ—¥å¿—
grep "ERROR" logs/*.log | tail -50

# æŸ¥è¯¢ç‰¹å®š execution_id
grep "exec-123" logs/*.log
```

---

## å˜æ›´æ—¥å¿—

è¯¦è§ [CHANGELOG.md](./CHANGELOG.md)

---

## è”ç³»æ”¯æŒ

- æŠ€æœ¯é—®é¢˜ï¼šæŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ `logs/`
- ç´§æ€¥æ•…éšœï¼šè”ç³»è¿ç»´å›¢é˜Ÿ
- åŠŸèƒ½å»ºè®®ï¼šæäº¤ Issue
