# å¹³å°é…ç½®ç¼ºå¤±ä¼˜é›…é™çº§ä¿®å¤æŠ¥å‘Š

**æ—¥æœŸ**: 2026-03-01  
**ç‰ˆæœ¬**: v2.1.0  
**çŠ¶æ€**: âœ… å®Œæˆå¹¶éªŒè¯

---

## ğŸ“‹ ä¿®å¤ç›®æ ‡

ç¡®ä¿ç³»ç»Ÿåœ¨æ£€æµ‹åˆ° AI å¹³å°é…ç½®ç¼ºå¤±æ—¶èƒ½å¤Ÿï¼š
1. **æ­£å¸¸å¯åŠ¨** - ä¸æŠ›å‡ºå¼‚å¸¸æˆ–é˜»å¡
2. **ä¼˜é›…é™çº§** - ä½¿ç”¨å¯ç”¨å¹³å°ç»§ç»­è¿è¡Œ
3. **ç”¨æˆ·æç¤º** - å‰ç«¯æ¸…æ™°æ˜¾ç¤ºæœªé…ç½®çš„å¹³å°

---

## ğŸ”§ ä¿®å¤å†…å®¹

### ä¸€ã€åç«¯ä¿®æ”¹

#### 1.1 ä¿®æ”¹ `run_startup_health_check()` å‡½æ•°

**æ–‡ä»¶**: `wechat_backend/ai_adapters/platform_health_monitor.py`

**å…³é”®ä¿®æ”¹ç‚¹**:

```python
def run_startup_health_check():
    """
    åœ¨åº”ç”¨å¯åŠ¨æ—¶è¿è¡Œå¥åº·æ£€æŸ¥
    
    ã€å…³é”®ä¿®æ”¹ã€‘ï¼š
    1. æ£€æµ‹åˆ°é…ç½®ç¼ºå¤±æ—¶ä»…è®°å½•è­¦å‘Šï¼Œä¸æŠ›å‡ºå¼‚å¸¸
    2. å§‹ç»ˆè¿”å› Trueï¼Œå…è®¸åç»­æµç¨‹ç»§ç»­è¿è¡Œ
    3. ä½¿ç”¨ INFO/WARNING æ—¥å¿—çº§åˆ«ï¼Œé¿å… ERROR é˜»å¡
    """
    
    # ã€å…³é”®ä¿®æ”¹ 1ã€‘ï¼šé…ç½®ç¼ºå¤±ä»…è®°å½• INFO
    if unconfigured_platforms:
        msg = (f"â„¹ï¸ {len(unconfigured_platforms)} platform(s) not configured: "
               f"{', '.join(unconfigured_platforms)}. "
               f"Add API keys to .env if needed.")
        api_logger.info(msg)  # ä½¿ç”¨ INFO è€Œä¸æ˜¯ ERROR
    
    # ã€å…³é”®ä¿®æ”¹ 2ã€‘ï¼šä¸å¥åº·å¹³å°è®°å½• WARNINGï¼Œä½†ä¸é˜»æ­¢å¯åŠ¨
    if unhealthy_platforms:
        api_logger.warning(
            f"âš ï¸ {len(unhealthy_platforms)} platform(s) unhealthy: "
            f"{', '.join(unhealthy_platforms)}. "
            f"System will proceed with reduced functionality."
        )
    
    # ã€å…³é”®ä¿®æ”¹ 3ã€‘ï¼šå§‹ç»ˆè¿”å› Trueï¼Œå…è®¸åç»­æµç¨‹ç»§ç»­è¿è¡Œ
    api_logger.warning(
        "âš ï¸ AI Platform health check completed with warnings, "
        "but system is proceeding with available platforms."
    )
    
    return {
        'success': True,  # å§‹ç»ˆè¿”å›æˆåŠŸï¼Œå…è®¸å¯åŠ¨
        'results': results,
        'warnings': results.get('warnings', []),
        'unconfigured_platforms': unconfigured_platforms,
        'unhealthy_platforms': unhealthy_platforms
    }
```

**ä¿®æ”¹å‰åå¯¹æ¯”**:

| ä¿®æ”¹é¡¹ | ä¿®æ”¹å‰ | ä¿®æ”¹å |
|--------|--------|--------|
| é…ç½®ç¼ºå¤±æ—¥å¿— | ERROR | INFO |
| ä¸å¥åº·å¹³å° | å¯èƒ½é˜»å¡ | WARNINGï¼Œç»§ç»­å¯åŠ¨ |
| è¿”å›å€¼ | å¯èƒ½è¿”å› None | å§‹ç»ˆè¿”å› success=True |
| å¼‚å¸¸å¤„ç† | æŠ›å‡ºå¼‚å¸¸ | æ•è·å¼‚å¸¸å¹¶ç»§ç»­ |

---

#### 1.2 æ›´æ–° `/api/platform-status` æ¥å£

**æ–‡ä»¶**: `wechat_backend/views/diagnosis_views.py`

**æ–°å¢åŠŸèƒ½**:
- è¿”å› `isConfigured` å­—æ®µï¼ˆå‰ç«¯éœ€è¦ï¼‰
- è¿”å› `category` å­—æ®µï¼ˆå›½å†…/æµ·å¤–ï¼‰
- è¿”å›é…ç½®æ‘˜è¦ä¿¡æ¯

**è¿”å›æ•°æ®ç»“æ„**:

```json
{
  "status": "success",
  "platforms": {
    "deepseek": {
      "id": "deepseek",
      "name": "DeepSeek",
      "isConfigured": true,
      "status": "active",
      "has_api_key": true,
      "category": "domestic",
      "quota": { ... }
    },
    "wenxin": {
      "id": "wenxin",
      "name": "æ–‡å¿ƒä¸€è¨€",
      "isConfigured": false,
      "status": "inactive",
      "has_api_key": false,
      "category": "domestic"
    }
  },
  "summary": {
    "total": 7,
    "configured": 6,
    "unconfigured": 1
  }
}
```

---

### äºŒã€å‰ç«¯ä¿®æ”¹

#### 2.1 æ·»åŠ å¹³å°é…ç½®çŠ¶æ€åŠ è½½

**æ–‡ä»¶**: `pages/index/index.js`

**æ–°å¢æ–¹æ³•**:

```javascript
/**
 * ã€æ–°å¢ã€‘åŠ è½½å¹³å°é…ç½®çŠ¶æ€ï¼Œæ ‡è®°æœªé…ç½®çš„å¹³å°
 */
loadPlatformConfigStatus: function() {
  const that = this;
  wx.request({
    url: getApp().globalData.serverUrl + '/api/platform-status',
    method: 'GET',
    success: function(res) {
      if (res.statusCode === 200 && res.data.status === 'success') {
        const platforms = res.data.platforms;
        
        // æ›´æ–°å›½å†…å¹³å°é…ç½®çŠ¶æ€
        const domesticAiModels = that.data.domesticAiModels.map(model => {
          const platformStatus = platforms[model.id];
          return {
            ...model,
            isConfigured: platformStatus ? platformStatus.isConfigured : false,
            disabled: platformStatus ? !platformStatus.isConfigured : false
          };
        });
        
        // æ›´æ–°æµ·å¤–å¹³å°é…ç½®çŠ¶æ€
        const overseasAiModels = that.data.overseasAiModels.map(model => {
          const platformStatus = platforms[model.id];
          return {
            ...model,
            isConfigured: platformStatus ? platformStatus.isConfigured : false,
            disabled: platformStatus ? !platformStatus.isConfigured : false
          };
        });
        
        that.setData({ domesticAiModels, overseasAiModels });
      }
    }
  });
}
```

**è°ƒç”¨æ—¶æœº**: `onLoad()` æ—¶è‡ªåŠ¨è°ƒç”¨

---

#### 2.2 æ›´æ–°å¹³å°é€‰æ‹©é€»è¾‘

**æ–‡ä»¶**: `pages/index/index.js`

**ä¿®æ”¹ `toggleModelSelection()` æ–¹æ³•**:

```javascript
toggleModelSelection: function(e) {
  const { type, index } = e.currentTarget.dataset;
  const key = type === 'domestic' ? 'domesticAiModels' : 'overseasAiModels';
  const models = Array.isArray(this.data[key]) ? this.data[key] : [];

  // ã€æ–°å¢ã€‘æ£€æŸ¥å¹³å°æ˜¯å¦å·²é…ç½®
  if (models[index].disabled || models[index].isConfigured === false) {
    wx.showToast({ 
      title: 'è¯¥å¹³å°æš‚æœªé…ç½® API Key', 
      icon: 'none',
      duration: 2000
    });
    // ã€æ–°å¢ã€‘æ˜¾ç¤ºé…ç½®æç¤º
    this.showMissingConfigTip(models[index]);
    return;
  }

  // ... æ­£å¸¸é€‰æ‹©é€»è¾‘
}
```

**æ–°å¢æç¤ºæ–¹æ³•**:

```javascript
/**
 * ã€æ–°å¢ã€‘æ˜¾ç¤ºæœªé…ç½®å¹³å°çš„æç¤ºä¿¡æ¯
 */
showMissingConfigTip: function(model) {
  wx.showModal({
    title: 'å¹³å°æœªé…ç½®',
    content: `å¹³å° "${model.name}" æš‚æœªé…ç½® API Keyã€‚è¯·åœ¨ .env æ–‡ä»¶ä¸­é…ç½®ç›¸åº”çš„å¯†é’¥ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜ã€‚`,
    confirmText: 'æŸ¥çœ‹é…ç½®',
    cancelText: 'å–æ¶ˆ',
    success: function(res) {
      if (res.confirm) {
        wx.showToast({ title: 'è¯·è”ç³»ç®¡ç†å‘˜é…ç½®', icon: 'none' });
      }
    }
  });
}
```

---

#### 2.3 æ›´æ–° WXML æ¨¡æ¿

**æ–‡ä»¶**: `pages/index/index.wxml`

**å›½å†…å¹³å°**:

```xml
<view class="model-chip-pro 
             {{item.checked ? 'checked' : ''}} 
             {{item.disabled ? 'disabled' : ''}} 
             {{item.isConfigured === false ? 'unconfigured' : ''}}" 
      wx:for="{{domesticAiModels}}" 
      wx:key="id" 
      bindtap="{{item.isConfigured === false ? 'showMissingConfigTip' : 'toggleModelSelection'}}" 
      data-type="domestic" 
      data-index="{{index}}"
      data-model="{{item}}">
  <view class="logo-placeholder">{{item.logo || item.name.substring(0,2)}}</view>
  <text class="model-name">{{item.name}}</text>
  <view class="tag-list">
    <text class="tag" wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this">{{tag}}</text>
  </view>
  <!-- ã€æ–°å¢ã€‘æœªé…ç½®è­¦å‘Šå›¾æ ‡ -->
  <view class="config-warning-icon" wx:if="{{item.isConfigured === false}}">âš ï¸</view>
  <view class="check-icon" wx:else>âœ“</view>
</view>
```

**æµ·å¤–å¹³å°**ï¼šåŒæ ·çš„ä¿®æ”¹åº”ç”¨äºæµ·å¤–å¹³å°åˆ—è¡¨

---

#### 2.4 æ·»åŠ  CSS æ ·å¼

**æ–‡ä»¶**: `pages/index/index.wxss`

**æ–°å¢æ ·å¼**:

```css
/* ã€æ–°å¢ã€‘æœªé…ç½®å¹³å°çš„æ ·å¼ */
.model-chip-pro.unconfigured { 
  opacity: 0.5; 
  border-color: #FF9500; 
  border-style: dashed;
  background-color: rgba(255, 149, 0, 0.05);
}

/* ã€æ–°å¢ã€‘æœªé…ç½®è­¦å‘Šå›¾æ ‡ */
.config-warning-icon { 
  position: absolute; 
  top: 10rpx; 
  right: 10rpx; 
  font-size: 28rpx; 
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(1.1); }
}
```

---

## âœ… éªŒè¯ç»“æœ

### åç«¯éªŒè¯

```bash
âœ… Health check passed: True
```

**æ—¥å¿—è¾“å‡º**:
```
âœ… doubao: OK
âœ… deepseek: OK
âœ… qwen: OK
âœ… chatgpt: OK
âœ… gemini: OK
âœ… zhipu: OK
âš ï¸  wenxin: Provider not configured

â„¹ï¸  1 platform(s) not configured: wenxin. Add API keys to .env if needed.
âš ï¸  AI Platform health check completed with warnings, 
    but system is proceeding with available platforms.
```

### å‰ç«¯æ•ˆæœ

**è§†è§‰æ•ˆæœ**:

| çŠ¶æ€ | æ ·å¼ | å›¾æ ‡ | è¡Œä¸º |
|------|------|------|------|
| å·²é…ç½® | æ­£å¸¸è¾¹æ¡† | âœ“ | å¯é€‰æ‹©/å–æ¶ˆ |
| æœªé…ç½® | æ©™è‰²è™šçº¿è¾¹æ¡† + åŠé€æ˜ | âš ï¸ (è„‰å†²åŠ¨ç”») | ç‚¹å‡»æ˜¾ç¤ºæç¤º |

**ç”¨æˆ·äº¤äº’**:
1. ç‚¹å‡»æœªé…ç½®å¹³å° â†’ Toast æç¤º + Modal è¯´æ˜
2. Modal æä¾›"æŸ¥çœ‹é…ç½®"é€‰é¡¹
3. å¼•å¯¼ç”¨æˆ·è”ç³»ç®¡ç†å‘˜é…ç½®

---

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰

```
âŒ wenxin: Provider not registered
ERROR: Health check failed!
[è¿›ç¨‹ç»ˆæ­¢]
```

### ä¿®å¤å

```
âš ï¸  wenxin: Provider not registered (adapter OK)
â„¹ï¸  1 platform(s) not configured: wenxin. Add API keys to .env if needed.
âš ï¸  AI Platform health check completed with warnings, 
    but system is proceeding with available platforms.
âœ… ç³»ç»Ÿæ­£å¸¸å¯åŠ¨
âœ… å‰ç«¯æ˜¾ç¤ºæœªé…ç½®å¹³å°çŠ¶æ€
âœ… ç”¨æˆ·å¯æ¸…æ¥šè¯†åˆ«å“ªäº›å¹³å°å¯ç”¨
```

---

## ğŸ¯ ç”¨æˆ·ä½“éªŒæå‡

### é€æ˜åº¦æå‡
- âœ… å‰ç«¯æ¸…æ™°æ ‡è®°æœªé…ç½®å¹³å°
- âœ… æ©™è‰²è™šçº¿è¾¹æ¡† + è­¦å‘Šå›¾æ ‡
- âœ… è„‰å†²åŠ¨ç”»å¸å¼•æ³¨æ„

### äº¤äº’å‹å¥½
- âœ… ç‚¹å‡»æœªé…ç½®å¹³å°æ—¶æ˜¾ç¤ºè¯¦ç»†è¯´æ˜
- âœ… æä¾›æ˜ç¡®çš„åç»­æ“ä½œæŒ‡å¼•
- âœ… é¿å…ç”¨æˆ·å›°æƒ‘"ä¸ºä»€ä¹ˆé€‰ä¸äº†"

### ç³»ç»Ÿç¨³å®šæ€§
- âœ… é…ç½®ç¼ºå¤±ä¸å†å¯¼è‡´å¯åŠ¨å¤±è´¥
- âœ… ä¼˜é›…é™çº§ï¼Œä½¿ç”¨å¯ç”¨å¹³å°
- âœ… æ—¥å¿—æ¸…æ™°ï¼Œä¾¿äºè¯Šæ–­

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶
- [x] `wechat_backend/ai_adapters/platform_health_monitor.py`
- [x] `wechat_backend/views/diagnosis_views.py`

### å‰ç«¯æ–‡ä»¶
- [x] `pages/index/index.js`
- [x] `pages/index/index.wxml`
- [x] `pages/index/index.wxss`

### å·¥å…·è„šæœ¬
- [x] `update_platform_status_api.py`

---

## ğŸš€ åç»­å»ºè®®

1. **é…ç½®å‘å¯¼é¡µé¢**
   - åˆ›å»ºä¸“é—¨çš„é…ç½®è¯´æ˜é¡µé¢
   - æä¾›å„å¹³å° API Key è·å–æ•™ç¨‹

2. **è‡ªåŠ¨æ£€æµ‹ .env æ–‡ä»¶**
   - å¯åŠ¨æ—¶æ£€æµ‹ .env æ˜¯å¦å­˜åœ¨
   - æä¾›é…ç½®ç¼ºå¤±å¹³å°åˆ—è¡¨

3. **é…ç½®çŠ¶æ€æŒä¹…åŒ–**
   - å°†é…ç½®çŠ¶æ€ç¼“å­˜åˆ°æœ¬åœ°
   - å‡å°‘ API è¯·æ±‚é¢‘ç‡

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026-03-01 16:26  
**æµ‹è¯•éªŒè¯**: âœ… é€šè¿‡  
**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-03-01
