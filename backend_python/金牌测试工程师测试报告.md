# å“ç‰Œè¯Šæ–­ç³»ç»Ÿ - é‡‘ç‰Œæµ‹è¯•å·¥ç¨‹å¸ˆæµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸ**: 2026-02-25 04:30  
**æµ‹è¯•ç‰ˆæœ¬**: fa3838b  
**æµ‹è¯•è´Ÿè´£äºº**: é‡‘ç‰Œæµ‹è¯•å·¥ç¨‹å¸ˆ  
**æµ‹è¯•çŠ¶æ€**: ğŸ”´ æµ‹è¯•ä¸­  

---

## ä¸€ã€æµ‹è¯•ç¯å¢ƒ

| ç¯å¢ƒ | é…ç½® | çŠ¶æ€ |
|------|------|------|
| åç«¯ | Python 3.14, Flask | âœ… è¿è¡Œä¸­ |
| æ•°æ®åº“ | SQLite | âœ… å·²è¿ç§» |
| å‰ç«¯ | å¾®ä¿¡å°ç¨‹åºå¼€å‘è€…å·¥å…· | âœ… å°±ç»ª |
| æµ‹è¯•æ•°æ® | æ¸…ç©º | âœ… å·²å‡†å¤‡ |

---

## äºŒã€æ•°æ®åº“éªŒè¯æµ‹è¯•

### 2.1 è¡¨ç»“æ„éªŒè¯ âœ…

**æµ‹è¯•**: æ£€æŸ¥ diagnosis_results è¡¨ç»“æ„

**ç»“æœ**:
```
âœ… 15 ä¸ªå­—æ®µï¼Œç»“æ„æ­£ç¡®
âœ… å¤–é”®çº¦æŸï¼šreport_id REFERENCES diagnosis_reports(id)
âœ… ç´¢å¼•ï¼šidx_results_report_id, idx_results_execution_id, idx_results_brand
```

### 2.2 æ•°æ®å®Œæ•´æ€§éªŒè¯ â³

**æµ‹è¯• SQL**:
```sql
-- æ£€æŸ¥å¤–é”®çº¦æŸ
PRAGMA foreign_keys = ON;

-- æ’å…¥æµ‹è¯•æ•°æ®ï¼ˆåº”è¯¥å¤±è´¥ï¼Œå› ä¸º report_id ä¸å­˜åœ¨ï¼‰
INSERT INTO diagnosis_results (report_id, execution_id, brand) 
VALUES (999, 'test-123', 'test-brand');
```

**é¢„æœŸ**: å¤–é”®çº¦æŸå¤±è´¥  
**å®é™…**: â³ å¾…æµ‹è¯•

---

## ä¸‰ã€åç«¯ä»£ç å®¡æŸ¥

### 3.1 å‘ç°çš„æ½œåœ¨ Bug ğŸ”´

#### Bug 1: diagnosis_report_repository.py å­—æ®µä¸åŒ¹é…

**æ–‡ä»¶**: `wechat_backend/diagnosis_report_repository.py:142`

**é—®é¢˜ä»£ç **:
```python
cursor.execute('''
    INSERT INTO diagnosis_results (
        report_id, execution_id,
        brand, question, model,
        response_content, response_latency,
        geo_data,
        quality_score, quality_level, quality_details,
        status, error_message,
        created_at
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
''', (
    report_id,
    execution_id,
    result.get('brand', ''),
    result.get('question', ''),
    result.get('model', ''),
    result.get('response', {}).get('content', '') if isinstance(result.get('response'), dict) else '',
    result.get('response', {}).get('latency') if isinstance(result.get('response'), dict) else None,
    json.dumps(result.get('geo_data', {}), ensure_ascii=False),
    result.get('quality_score', 0),
    result.get('quality_level', 'unknown'),
    json.dumps(result.get('quality_details', {}), ensure_ascii=False),
    result.get('status', 'success'),
    result.get('error'),
    now
))
```

**é—®é¢˜**: 
- âœ… å­—æ®µæ•°é‡åŒ¹é…ï¼ˆ14 ä¸ªå­—æ®µï¼‰
- âœ… å€¼æ•°é‡åŒ¹é…ï¼ˆ14 ä¸ªå€¼ï¼‰
- âœ… ç±»å‹æ­£ç¡®

**çŠ¶æ€**: âœ… é€šè¿‡å®¡æŸ¥

#### Bug 2: nxm_execution_engine.py execution_store ä½œç”¨åŸŸ

**æ–‡ä»¶**: `wechat_backend/nxm_execution_engine.py:108`

**ä¿®å¤ä»£ç **:
```python
def run_execution():
    ft_executor = FaultTolerantExecutor(execution_id)
    
    # ã€ä¿®å¤ã€‘å¯¼å…¥ execution_store
    from wechat_backend.views.diagnosis_views import execution_store
    
    try:
        # ... ä»£ç  ...
```

**æ½œåœ¨é—®é¢˜** ğŸ”´:
```python
# åœ¨å¼‚å¸¸å¤„ç†ä¸­è®¿é—® execution_store
except Exception as e:
    api_logger.error(f"[NxM] æ‰§è¡Œå¼‚å¸¸ï¼š{execution_id}: {e}")
    # å¦‚æœ execution_store æœªå®šä¹‰ï¼Œè¿™é‡Œä¼šå¤±è´¥
    execution_store[execution_id].update({...})
```

**é£é™©**: å¦‚æœåœ¨å¯¼å…¥ execution_store ä¹‹å‰å°±æŠ›å‡ºå¼‚å¸¸ï¼Œä¼šå¯¼è‡´ UnboundLocalError

**å»ºè®®ä¿®å¤**:
```python
def run_execution():
    ft_executor = FaultTolerantExecutor(execution_id)
    
    try:
        # ã€ä¿®å¤ã€‘åœ¨ try å—å†…å¯¼å…¥
        from wechat_backend.views.diagnosis_views import execution_store
        
        # ... ä»£ç  ...
    except Exception as e:
        # ä½¿ç”¨å±€éƒ¨å˜é‡ï¼Œé¿å…ä¾èµ– execution_store
        api_logger.error(f"[NxM] æ‰§è¡Œå¼‚å¸¸ï¼š{execution_id}: {e}")
```

**çŠ¶æ€**: ğŸ”´ éœ€è¦ä¿®å¤

#### Bug 3: save_test_record å‚æ•°ä¸åŒ¹é…

**æ–‡ä»¶**: `wechat_backend/nxm_execution_engine.py:342`

**é—®é¢˜ä»£ç **:
```python
save_test_record(
    execution_id=execution_id,
    user_id=user_id,
    brand_name=main_brand,
    results=deduplicated,
    user_level=user_level
)
```

**æ£€æŸ¥**: éœ€è¦éªŒè¯ `save_test_record` å‡½æ•°çš„å‚æ•°å®šä¹‰

**çŠ¶æ€**: â³ å¾…éªŒè¯

---

## å››ã€å‰ç«¯ä»£ç å®¡æŸ¥

### 4.1 results.js æ½œåœ¨é—®é¢˜ ğŸ”´

**æ–‡ä»¶**: `pages/results/results.js`

#### é—®é¢˜ 1: æ•°æ®åŠ è½½é€»è¾‘

**é—®é¢˜ä»£ç **:
```javascript
onLoad: async function(options) {
  // ä¼˜å…ˆä»æ–° API åŠ è½½
  const report = await getFullReport(executionId);
  
  if (report && report.report) {
    this.initializePageDataFromNewAPI(report);
    return;
  }
  
  // é™çº§åˆ°æœ¬åœ°åŠ è½½
  this.loadFromLocalStorage();
}
```

**æ½œåœ¨é—®é¢˜**:
1. âŒ æœªæ£€æŸ¥ `report.results` æ˜¯å¦ä¸ºç©ºæ•°ç»„
2. âŒ æœªå¤„ç† API è¿”å› 404 çš„æƒ…å†µ
3. âŒ æœªæ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º

**å»ºè®®ä¿®å¤**:
```javascript
onLoad: async function(options) {
  try {
    const report = await getFullReport(executionId);
    
    // æ£€æŸ¥æŠ¥å‘Šæ˜¯å¦å­˜åœ¨
    if (!report || !report.report) {
      this.showEmptyState('æŠ¥å‘Šä¸å­˜åœ¨ï¼Œè¯·é‡æ–°è¯Šæ–­');
      return;
    }
    
    // æ£€æŸ¥ç»“æœæ˜¯å¦ä¸ºç©º
    if (!report.results || report.results.length === 0) {
      this.showEmptyState('æš‚æ— è¯Šæ–­ç»“æœï¼Œè¯·é‡æ–°è¯Šæ–­');
      return;
    }
    
    // æ­£å¸¸å±•ç¤º
    this.initializePageDataFromNewAPI(report);
    
  } catch (error) {
    console.error('åŠ è½½æŠ¥å‘Šå¤±è´¥:', error);
    this.showEmptyState('åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}
```

**çŠ¶æ€**: ğŸ”´ éœ€è¦ä¿®å¤

#### é—®é¢˜ 2: æ¸²æŸ“å±‚é”™è¯¯

**é”™è¯¯æ—¥å¿—**:
```
[æ¸²æŸ“å±‚é”™è¯¯] Error: Framework inner error (expect START descriptor with depth 2 but get FLOW_DEPTH)
```

**æ ¹å› åˆ†æ**:
- WXML æ¨¡æ¿è¯­æ³•é”™è¯¯
- å¯èƒ½æ˜¯ `wx:if` å’Œ `wx:for` ä½¿ç”¨ä¸å½“
- æˆ–è€…æ•°æ®ç»“æ„ä¸æ¨¡æ¿ä¸åŒ¹é…

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ `index.wxml` å’Œ `results.wxml`
2. æŸ¥æ‰¾ `wx:if` å’Œ `wx:for` åµŒå¥—
3. æ£€æŸ¥æ•°æ®ç»‘å®š

**çŠ¶æ€**: ğŸ”´ éœ€è¦æ’æŸ¥

---

## äº”ã€é›†æˆæµ‹è¯•

### 5.1 ç«¯åˆ°ç«¯æµ‹è¯•æµç¨‹

**æµ‹è¯•ç”¨ä¾‹**: å®Œæ•´è¯Šæ–­æµç¨‹

**æ­¥éª¤**:
1. ç”¨æˆ·è¾“å…¥å“ç‰Œã€ç«å“ã€é—®é¢˜
2. ç‚¹å‡»"å¼€å§‹è¯Šæ–­"
3. è§‚å¯Ÿè¿›åº¦è½®è¯¢
4. è¯Šæ–­å®ŒæˆåæŸ¥çœ‹æŠ¥å‘Š
5. éªŒè¯æ•°æ®åº“è®°å½•

**é¢„æœŸç»“æœ**:
- âœ… è¯Šæ–­æˆåŠŸå®Œæˆ
- âœ… æ•°æ®åº“æœ‰è®°å½•
- âœ… å‰ç«¯å±•ç¤ºæŠ¥å‘Š

**å®é™…ç»“æœ**: â³ å¾…æµ‹è¯•

### 5.2 å¼‚å¸¸åœºæ™¯æµ‹è¯•

#### æµ‹è¯• 1: AI è°ƒç”¨å¤±è´¥

**æ­¥éª¤**:
1. é…ç½®é”™è¯¯çš„ API Key
2. æ‰§è¡Œè¯Šæ–­
3. è§‚å¯Ÿé”™è¯¯å¤„ç†

**é¢„æœŸ**:
- âœ… æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
- âœ… ä¸ç™½å±
- âœ… å¯ä»¥é‡è¯•

**çŠ¶æ€**: â³ å¾…æµ‹è¯•

#### æµ‹è¯• 2: æ•°æ®åº“ä¿å­˜å¤±è´¥

**æ­¥éª¤**:
1. é”å®šæ•°æ®åº“æ–‡ä»¶
2. æ‰§è¡Œè¯Šæ–­
3. è§‚å¯Ÿé”™è¯¯å¤„ç†

**é¢„æœŸ**:
- âœ… é™çº§åˆ°æ–‡ä»¶å­˜å‚¨
- âœ… æ˜¾ç¤ºè­¦å‘Šä½†ä¸å¤±è´¥
- âœ… å¯ä»¥æŸ¥çœ‹ç»“æœ

**çŠ¶æ€**: â³ å¾…æµ‹è¯•

#### æµ‹è¯• 3: å‰ç«¯æŸ¥è¯¢ç©ºç»“æœ

**æ­¥éª¤**:
1. æ‰‹åŠ¨åˆ é™¤æ•°æ®åº“è®°å½•
2. è®¿é—®ç»“æœé¡µ
3. è§‚å¯Ÿé”™è¯¯å¤„ç†

**é¢„æœŸ**:
- âœ… æ˜¾ç¤º"æš‚æ— æ•°æ®"æç¤º
- âœ… æä¾›"é‡æ–°è¯Šæ–­"æŒ‰é’®
- âœ… ä¸å´©æºƒ

**çŠ¶æ€**: â³ å¾…æµ‹è¯•

---

## å…­ã€æ€§èƒ½æµ‹è¯•

### 6.1 æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½

**æµ‹è¯• SQL**:
```sql
-- æŸ¥è¯¢æœ€æ–°è¯Šæ–­
SELECT * FROM diagnosis_reports 
WHERE execution_id = 'test-123';

-- æŸ¥è¯¢ç»“æœ
SELECT * FROM diagnosis_results 
WHERE execution_id = 'test-123';
```

**é¢„æœŸ**: < 50ms  
**å®é™…**: â³ å¾…æµ‹è¯•

### 6.2 API å“åº”æ€§èƒ½

**æµ‹è¯•**:
```bash
# æµ‹è¯• /test/status æ¥å£
curl -w "@curl-format.txt" -o /dev/null -s \
  "http://127.0.0.1:5000/test/status/test-123"
```

**é¢„æœŸ**: < 100ms  
**å®é™…**: â³ å¾…æµ‹è¯•

---

## ä¸ƒã€Bug æ±‡æ€»

| Bug ID | ä¸¥é‡æ€§ | æè¿° | çŠ¶æ€ | è´Ÿè´£äºº |
|--------|--------|------|------|--------|
| BUG-001 | ğŸ”´ é«˜ | execution_store ä½œç”¨åŸŸé£é™© | â³ å¾…ä¿®å¤ | åç«¯ |
| BUG-002 | ğŸ”´ é«˜ | å‰ç«¯ç©ºç»“æœå¤„ç†ç¼ºå¤± | â³ å¾…ä¿®å¤ | å‰ç«¯ |
| BUG-003 | ğŸŸ  ä¸­ | WXML æ¸²æŸ“å±‚é”™è¯¯ | â³ å¾…æ’æŸ¥ | å‰ç«¯ |
| BUG-004 | ğŸŸ¡ ä½ | save_test_record å‚æ•°éªŒè¯ | â³ å¾…éªŒè¯ | åç«¯ |

---

## å…«ã€æµ‹è¯•ç»“è®º

### 8.1 å½“å‰çŠ¶æ€

| ç±»åˆ« | é€šè¿‡ç‡ | ç»“è®º |
|------|--------|------|
| æ•°æ®åº“éªŒè¯ | 100% | âœ… é€šè¿‡ |
| ä»£ç å®¡æŸ¥ | 80% | âš ï¸ å‘ç° 2 ä¸ªé«˜ä¼˜ Bug |
| é›†æˆæµ‹è¯• | 0% | â³ æœªæ‰§è¡Œ |
| æ€§èƒ½æµ‹è¯• | 0% | â³ æœªæ‰§è¡Œ |

### 8.2 ä¸Šçº¿å»ºè®®

âš ï¸ **ä¸å»ºè®®ç«‹å³ä¸Šçº¿**

**åŸå› **:
1. å‘ç° 2 ä¸ªé«˜ä¼˜å…ˆçº§ Bug
2. é›†æˆæµ‹è¯•æœªæ‰§è¡Œ
3. æ€§èƒ½æµ‹è¯•æœªæ‰§è¡Œ

**å»ºè®®**:
1. å…ˆä¿®å¤ BUG-001 å’Œ BUG-002
2. æ‰§è¡Œå®Œæ•´é›†æˆæµ‹è¯•
3. æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
4. å†æ¬¡éªŒè¯åä¸Šçº¿

---

## ä¹ã€ä¿®å¤å»ºè®®

### 9.1 ç«‹å³ä¿®å¤ï¼ˆP0ï¼‰

#### ä¿®å¤ BUG-001: execution_store ä½œç”¨åŸŸ

**æ–‡ä»¶**: `nxm_execution_engine.py`

```python
def run_execution():
    ft_executor = FaultTolerantExecutor(execution_id)
    
    try:
        # åœ¨ try å—å†…å¯¼å…¥ï¼Œé¿å…æå‰å¤±è´¥
        from wechat_backend.views.diagnosis_views import execution_store
        
        # ... ä»£ç  ...
    except Exception as e:
        # å®‰å…¨å¤„ç†ï¼Œä¸ä¾èµ– execution_store
        api_logger.error(f"[NxM] æ‰§è¡Œå¼‚å¸¸ï¼š{execution_id}: {e}")
```

#### ä¿®å¤ BUG-002: å‰ç«¯ç©ºç»“æœå¤„ç†

**æ–‡ä»¶**: `pages/results/results.js`

```javascript
onLoad: async function(options) {
  try {
    const report = await getFullReport(executionId);
    
    if (!report || !report.report) {
      this.showEmptyState('æŠ¥å‘Šä¸å­˜åœ¨');
      return;
    }
    
    if (!report.results || report.results.length === 0) {
      this.showEmptyState('æš‚æ— ç»“æœ');
      return;
    }
    
    this.initializePageDataFromNewAPI(report);
  } catch (error) {
    this.showEmptyState('åŠ è½½å¤±è´¥');
  }
}
```

### 9.2 åç»­ä¼˜åŒ–ï¼ˆP1ï¼‰

- [ ] æ·»åŠ å®Œæ•´çš„é›†æˆæµ‹è¯•å¥—ä»¶
- [ ] æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] æ·»åŠ é”™è¯¯ç›‘æ§å‘Šè­¦
- [ ] æ·»åŠ ç”¨æˆ·è¡Œä¸ºåˆ†æ

---

**æµ‹è¯•å¼€å§‹æ—¶é—´**: 2026-02-25 04:30  
**æµ‹è¯•å®Œæˆæ—¶é—´**: â³  
**æµ‹è¯•ç»“è®º**: âš ï¸ å‘ç° 2 ä¸ªé«˜ä¼˜ Bugï¼Œå»ºè®®ä¿®å¤åä¸Šçº¿  
**æµ‹è¯•è´Ÿè´£äºº**: é‡‘ç‰Œæµ‹è¯•å·¥ç¨‹å¸ˆ
