# 当前诊断运行问题分析报告

**分析时间**: 2026-02-25 03:00  
**诊断 ID**: `a2d39c01-1318-455e-9f63-539a51cee10f`  
**严重等级**: 🔴 严重  

---

## 一、问题概述

当前诊断任务在执行过程中遇到**AI 响应解析失败**问题，导致诊断无法正常完成。

### 核心问题

**DeepSeek AI 返回的响应无法解析出 geo_analysis 字段**

错误日志：
```
[GeoParser] 解析失败（有错误标记）：a2d39c01-1318-455e-9f63-539a51cee10f, Q0, deepseek: 
无法从 AI 响应中提取 geo_analysis 字段
```

---

## 二、问题详细分析

### 2.1 AI 响应格式问题

**AI 实际返回的内容**（从日志中提取）：
```
作为您的专业购车顾问，我将基于当前（截至 2024 年中）20 万元左右价位段新能源汽车市场的公开信息、产品力及市场口碑，为您进行客观分析和推荐。
```

**期望的 AI 响应格式**：
```json
{
  "geo_analysis": {
    "brand_mentioned": true/false,
    "rank": 1-10,
    "sentiment": -1.0 to 1.0,
    "cited_sources": [],
    "interception": ""
  }
}
```

### 2.2 问题根因

1. **AI 未按要求格式返回**
   - AI 返回了普通的对话文本
   - 没有包含要求的 JSON 格式 geo_analysis 字段

2. **提示词可能不够明确**
   - AI 可能没有理解需要返回结构化数据
   - 可能缺少明确的格式要求

3. **解析器容错性不足**
   - 无法从非结构化文本中提取有用信息
   - 缺少降级处理机制

### 2.3 影响范围

| 影响项 | 程度 | 说明 |
|--------|------|------|
| 诊断完成 | 🔴 严重 | 无法完成诊断 |
| 结果展示 | 🔴 严重 | 无结果可展示 |
| 用户体验 | 🔴 严重 | 用户等待后得到失败结果 |
| API 费用 | 🟠 高 | AI 调用费用浪费 |

---

## 三、并发问题分析

### 3.1 频繁的报告查询

日志显示大量重复查询：
```
2026-02-25 02:55:43,755 - 报告不存在：a2d39c01-1318-455e-9f63-539a51cee10f
2026-02-25 02:55:44,076 - 报告不存在：a2d39c01-1318-455e-9f63-539a51cee10f
2026-02-25 02:55:44,404 - 报告不存在：a2d39c01-1318-455e-9f63-539a51cee10f
...
```

**问题**：
- 前端轮询频率过高（约每 320ms 一次）
- 每次查询都触发数据库查询
- 数据库返回"报告不存在"警告

### 3.2 存储层问题

**新存储层未正确集成**：
- `get_full_report()` 方法返回"报告不存在"
- 说明诊断结果未保存到数据库
- 新存储层与执行引擎集成可能有问题

---

## 四、解决方案

### 4.1 立即修复（短期）

#### 方案 1: 增强 AI 提示词

**修改位置**: `nxm_execution_engine.py`

```python
# 在构建提示词时添加明确的格式要求
GEO_PROMPT_TEMPLATE = """
{context}

【重要】请在回答结束时，另起一行提供以下 JSON 格式的分析结果：
```json
{
  "geo_analysis": {
    "brand_mentioned": true/false,
    "rank": 数字，
    "sentiment": 数字，
    "cited_sources": [],
    "interception": ""
  }
}
```

注意：
1. 必须包含 geo_analysis 字段
2. 必须是有效的 JSON 格式
3. 不要添加额外说明
"""
```

#### 方案 2: 增强解析器容错性

**修改位置**: `geo_parser.py`

```python
def parse_geo_json_enhanced(text: str, ...):
    # 1. 尝试提取 JSON 代码块
    json_match = re.search(r'```json\s*(.*?)\s*```', text, re.DOTALL)
    if json_match:
        try:
            data = json.loads(json_match.group(1))
            return data.get('geo_analysis', default_data)
        except:
            pass
    
    # 2. 尝试提取任何 JSON 对象
    json_objects = extract_json_objects(text)
    for json_str in json_objects:
        try:
            data = json.loads(json_str)
            if 'geo_analysis' in data:
                return data['geo_analysis']
        except:
            pass
    
    # 3. 降级：返回默认值，但标记为成功
    api_logger.warning(f"无法提取 geo_analysis，使用默认值")
    return {
        'brand_mentioned': False,
        'rank': -1,
        'sentiment': 0.0,
        'cited_sources': [],
        'interception': '',
        '_parse_warning': '无法从 AI 响应中提取结构化数据'
    }
```

#### 方案 3: 切换到其他 AI 平台

**修改位置**: `doubao_priority_adapter.py`

```python
# 如果 DeepSeek 连续失败 2 次，自动切换到豆包
if model_name == 'deepseek' and retry_count >= 2:
    api_logger.warning(f"DeepSeek 连续失败，切换到豆包")
    return self._retry_with_model('doubao', prompt)
```

### 4.2 长期优化

#### 优化 1: AI 响应验证

在 AI 调用后立即验证响应格式：

```python
def validate_ai_response(response):
    """验证 AI 响应是否包含必需的 geo_analysis"""
    try:
        data = json.loads(response)
        if 'geo_analysis' not in data:
            return False, "缺少 geo_analysis 字段"
        return True, None
    except:
        return False, "无效的 JSON 格式"
```

#### 优化 2: 多模型冗余

同时调用多个 AI 平台，取第一个成功响应的结果：

```python
async def call_multiple_models(prompt, models=['doubao', 'deepseek', 'qwen']):
    tasks = [call_model(model, prompt) for model in models]
    done, pending = await asyncio.wait(tasks, return_when=FIRST_COMPLETED)
    
    for task in done:
        try:
            result = task.result()
            if validate_ai_response(result):
                return result  # 返回第一个有效结果
        except:
            pass
    
    raise Exception("所有 AI 平台调用失败")
```

#### 优化 3: 前端轮询优化

减少轮询频率，使用增量轮询：

```javascript
// 前端轮询间隔动态调整
const poll = async () => {
  const res = await getTaskStatus(executionId, lastUpdateTime);
  
  if (!res.has_updates) {
    // 无更新时延长轮询间隔
    interval = Math.min(interval * 1.5, 2000);
  }
  
  setTimeout(poll, interval);
};
```

---

## 五、修复优先级

| 优先级 | 修复项 | 预计时间 | 负责人 |
|--------|--------|---------|--------|
| 🔴 P0 | 增强解析器容错性 | 1 小时 | 后端工程师 |
| 🔴 P0 | 优化 AI 提示词 | 30 分钟 | 后端工程师 |
| 🟠 P1 | 切换到其他 AI 平台 | 1 小时 | 后端工程师 |
| 🟠 P1 | 减少前端轮询频率 | 30 分钟 | 前端工程师 |
| 🟡 P2 | AI 响应验证 | 2 小时 | 后端工程师 |
| 🟡 P2 | 多模型冗余 | 4 小时 | 后端工程师 |

---

## 六、验证步骤

### 6.1 立即验证

1. **修改解析器**
   ```bash
   # 修改 geo_parser.py
   # 添加容错处理
   ```

2. **测试解析**
   ```python
   # 测试无法解析的响应
   text = "作为您的专业购车顾问..."
   result = parse_geo_json_enhanced(text)
   assert result is not None
   ```

3. **重新执行诊断**
   - 使用相同的输入
   - 观察是否能完成诊断

### 6.2 回归测试

- [ ] 测试正常 AI 响应解析
- [ ] 测试异常 AI 响应解析
- [ ] 测试 AI 调用失败重试
- [ ] 测试多模型切换

---

## 七、监控告警

### 7.1 新增监控项

```yaml
monitoring:
  ai_parse_errors:
    threshold: 5/小时
    alert: true
  ai_fallback_count:
    threshold: 10/小时
    alert: true
  diagnosis_failure_rate:
    threshold: 20%
    alert: true
```

### 7.2 告警通知

- 解析错误率 > 10% → 邮件通知
- AI 切换次数 > 20/小时 → 短信通知
- 诊断失败率 > 30% → 电话通知

---

**报告人**: 首席架构师  
**审核人**: CTO  
**日期**: 2026-02-25  
**状态**: ⏳ 待修复
