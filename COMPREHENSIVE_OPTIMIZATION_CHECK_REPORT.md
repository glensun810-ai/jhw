# å…¨é¢ä¼˜åŒ–æ£€æŸ¥æŠ¥å‘Š

**æ£€æŸ¥æ—¥æœŸ**: 2026-02-24  
**æ£€æŸ¥èŒƒå›´**: æ‰€æœ‰ AI é€‚é…å™¨ã€æ•…éšœè½¬ç§»é€»è¾‘ã€é”™è¯¯å¤„ç†  
**æ£€æŸ¥çŠ¶æ€**: âœ… **å·²å®Œæˆ**

---

## ğŸ“Š æ£€æŸ¥èŒƒå›´

### 1. AI é€‚é…å™¨æ£€æŸ¥

| é€‚é…å™¨ | ä½ç½® | ç±»å‹ | æ˜¯å¦éœ€è¦æ•…éšœè½¬ç§» | çŠ¶æ€ |
|--------|------|------|-----------------|------|
| DoubaoPriorityAdapter | `wechat_backend/ai_adapters/` | å¤šæ¨¡å‹ä¼˜å…ˆçº§ | âœ… éœ€è¦ | âœ… å·²ä¿®å¤ |
| DeepSeekAdapter | `wechat_backend/ai_adapters/` | å•ä¸€æ¨¡å‹ | âŒ ä¸éœ€è¦ | âœ… æ­£å¸¸ |
| QwenAdapter | `wechat_backend/ai_adapters/` | å•ä¸€æ¨¡å‹ | âŒ ä¸éœ€è¦ | âœ… æ­£å¸¸ |
| ZhipuAdapter | `wechat_backend/ai_adapters/` | å•ä¸€æ¨¡å‹ | âŒ ä¸éœ€è¦ | âœ… æ­£å¸¸ |
| ChatGPTAdapter | `wechat_backend/ai_adapters/` | å•ä¸€æ¨¡å‹ | âŒ ä¸éœ€è¦ | âœ… æ­£å¸¸ |
| GeminiAdapter | `wechat_backend/ai_adapters/` | å•ä¸€æ¨¡å‹ | âŒ ä¸éœ€è¦ | âœ… æ­£å¸¸ |
| ErnieBotAdapter | `wechat_backend/ai_adapters/` | å•ä¸€æ¨¡å‹ | âŒ ä¸éœ€è¦ | âœ… æ­£å¸¸ |

**ç»“è®º**: åªæœ‰ `DoubaoPriorityAdapter` éœ€è¦æ•…éšœè½¬ç§»é€»è¾‘ï¼Œå…¶ä»–éƒ½æ˜¯å•ä¸€æ¨¡å‹é€‚é…å™¨ã€‚

---

### 2. å¥åº·æ£€æŸ¥é—®é¢˜æ£€æŸ¥

#### é—®é¢˜é€‚é…å™¨
| é€‚é…å™¨ | æ˜¯å¦æœ‰å¥åº·æ£€æŸ¥ | æ˜¯å¦æ¶ˆè€—é…é¢ | ä¿®å¤çŠ¶æ€ |
|--------|---------------|-------------|----------|
| DoubaoPriorityAdapter | âœ… æœ‰ | âœ… æ˜¯ | âœ… å·²ç§»é™¤ |
| DoubaoAdapter | âœ… æœ‰ | âœ… æ˜¯ | âš ï¸ éœ€æ£€æŸ¥ |
| å…¶ä»–é€‚é…å™¨ | âŒ æ—  | âŒ å¦ | âœ… æ­£å¸¸ |

#### DoubaoAdapter å¥åº·æ£€æŸ¥åˆ†æ

**ä½ç½®**: `wechat_backend/ai_adapters/doubao_adapter.py:66`

**ä»£ç **:
```python
def _health_check(self):
    """æ‰§è¡Œå¥åº·æ£€æŸ¥ï¼ˆä»…ç”¨äºåˆå§‹åŒ–éªŒè¯ï¼‰"""
    try:
        # å‘é€ä¸€ä¸ªç®€å•çš„æµ‹è¯•è¯·æ±‚
        test_prompt = "ä½ å¥½"
        response = self.send_prompt(test_prompt)
        
        if not response.success:
            raise Exception(f"Health check failed: {response.error_message}")
        
        api_logger.info(f"[DoubaoAdapter] Health check passed for model: {self.model_name}")
        
    except Exception as e:
        api_logger.error(f"[DoubaoAdapter] Health check failed: {e}")
        raise
```

**é—®é¢˜**: 
- âŒ å¥åº·æ£€æŸ¥ä¼šæ¶ˆè€— API é…é¢
- âŒ åœ¨ `DoubaoPriorityAdapter._init_adapter()` ä¸­è¢«è°ƒç”¨

**ä¿®å¤çŠ¶æ€**: 
- âœ… `DoubaoPriorityAdapter._init_adapter()` å·²ç§»é™¤å¥åº·æ£€æŸ¥è°ƒç”¨
- âš ï¸ `DoubaoAdapter._health_check()` æ–¹æ³•ä»ç„¶å­˜åœ¨ï¼Œä½†ä¸å†è¢«ä¼˜å…ˆçº§é€‚é…å™¨ä½¿ç”¨

**å»ºè®®**: ä¿ç•™ `DoubaoAdapter._health_check()` æ–¹æ³•ï¼Œå› ä¸ºå…¶ä»–ç›´æ¥ä½¿ç”¨ `DoubaoAdapter` çš„åœ°æ–¹å¯èƒ½è¿˜éœ€è¦å®ƒã€‚

---

### 3. ç”µè·¯æ–­è·¯å™¨æ£€æŸ¥

#### æ‰€æœ‰é€‚é…å™¨çš„ç”µè·¯æ–­è·¯å™¨ä½¿ç”¨æƒ…å†µ

| é€‚é…å™¨ | æ˜¯å¦ä½¿ç”¨ç”µè·¯æ–­è·¯å™¨ | é…ç½® | çŠ¶æ€ |
|--------|------------------|------|------|
| DoubaoPriorityAdapter | âœ… æ˜¯ | æ¯ä¸ªæ¨¡å‹ç‹¬ç«‹ | âœ… æ­£å¸¸ |
| DeepSeekAdapter | âœ… æ˜¯ | æ¯æ¨¡å‹ç‹¬ç«‹ | âœ… æ­£å¸¸ |
| QwenAdapter | âœ… æ˜¯ | æ¯æ¨¡å‹ç‹¬ç«‹ | âœ… æ­£å¸¸ |
| ZhipuAdapter | âœ… æ˜¯ | æ¯æ¨¡å‹ç‹¬ç«‹ | âœ… æ­£å¸¸ |
| ChatGPTAdapter | âœ… æ˜¯ | æ¯æ¨¡å‹ç‹¬ç«‹ | âœ… æ­£å¸¸ |
| GeminiAdapter | âœ… æ˜¯ | æ¯æ¨¡å‹ç‹¬ç«‹ | âœ… æ­£å¸¸ |
| ErnieBotAdapter | âœ… æ˜¯ | æ¯æ¨¡å‹ç‹¬ç«‹ | âœ… æ­£å¸¸ |

**ç»“è®º**: æ‰€æœ‰é€‚é…å™¨éƒ½æ­£ç¡®ä½¿ç”¨äº†ç”µè·¯æ–­è·¯å™¨ï¼Œé…ç½®åˆç†ã€‚

---

### 4. é”™è¯¯å¤„ç†æ£€æŸ¥

#### 429 é”™è¯¯å¤„ç†

| é€‚é…å™¨ | æ˜¯å¦æ£€æµ‹ 429 | æ˜¯å¦åˆ‡æ¢æ¨¡å‹ | çŠ¶æ€ |
|--------|-------------|-------------|------|
| DoubaoPriorityAdapter | âœ… æ˜¯ | âœ… æ˜¯ | âœ… å·²ä¿®å¤ |
| å…¶ä»–é€‚é…å™¨ | âŒ å¦ | âŒ å¦ | âœ… æ­£å¸¸ï¼ˆå•ä¸€æ¨¡å‹ï¼‰ |

#### é”™è¯¯ç±»å‹å¤„ç†

æ‰€æœ‰é€‚é…å™¨éƒ½æ­£ç¡®å¤„ç†äº†ä»¥ä¸‹é”™è¯¯ç±»å‹ï¼š
- âœ… `AIErrorType.SERVICE_UNAVAILABLE`
- âœ… `AIErrorType.SERVER_ERROR`
- âœ… `AIErrorType.INVALID_API_KEY`
- âœ… `AIErrorType.INSUFFICIENT_QUOTA`
- âœ… `AIErrorType.RATE_LIMIT_EXCEEDED`

**ç»“è®º**: é”™è¯¯å¤„ç†å®Œå–„ã€‚

---

### 5. é‡è¯•æœºåˆ¶æ£€æŸ¥

#### é‡è¯•é€»è¾‘

| ç»„ä»¶ | æ˜¯å¦æœ‰é‡è¯• | é‡è¯•ç­–ç•¥ | çŠ¶æ€ |
|------|-----------|---------|------|
| DoubaoPriorityAdapter | âœ… æœ‰ | åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ¨¡å‹ | âœ… å·²ä¼˜åŒ– |
| è¯·æ±‚å°è£…å™¨ | âœ… æœ‰ | æŒ‡æ•°é€€é¿é‡è¯• | âœ… æ­£å¸¸ |
| NXM æ‰§è¡Œå¼•æ“ | âœ… æœ‰ | æ¯é—®é¢˜æœ€å¤šé‡è¯• 2 æ¬¡ | âœ… æ­£å¸¸ |

**ç»“è®º**: é‡è¯•æœºåˆ¶å®Œå–„ï¼Œç­–ç•¥åˆç†ã€‚

---

## ğŸ”§ å·²å®Œæˆçš„ä¿®å¤

### ä¿®å¤ 1: DoubaoPriorityAdapter æ•…éšœè½¬ç§»é€»è¾‘ âœ…

**é—®é¢˜**: 
- å¥åº·æ£€æŸ¥æ¶ˆè€—é…é¢
- 429 é”™è¯¯ä¸è§¦å‘åˆ‡æ¢
- æ²¡æœ‰è®°å½•å·²è€—å°½æ¨¡å‹

**ä¿®å¤**:
```python
# æ·»åŠ å·²è€—å°½æ¨¡å‹è®°å½•
self.exhausted_models: set = set()

# ç§»é™¤å¥åº·æ£€æŸ¥
# âŒ åˆ é™¤ï¼šadapter._health_check()

# 429 é”™è¯¯è§¦å‘åˆ‡æ¢
if '429' in str(response.error_message) or 'SetLimitExceeded' in str(response.error_message):
    is_429 = True
    self.exhausted_models.add(failed_model)
    self._retry_with_next_model(self.selected_model, is_429_error=is_429)
```

**æ–‡ä»¶**: `wechat_backend/ai_adapters/doubao_priority_adapter.py`

---

### ä¿®å¤ 2: AIResponse å¯¹è±¡å¤„ç† âœ…

**é—®é¢˜**: 
- AIResponse å¯¹è±¡ä¸å¯è®¢é˜…
- AIResponse å¯¹è±¡ä¸å¯åºåˆ—åŒ–

**ä¿®å¤**:
```python
# nxm_result_aggregator.py
if isinstance(response_text, AIResponse):
    if response_text.success and response_text.content:
        response_text = response_text.content
    else:
        return error_response

# nxm_execution_engine.py
if isinstance(response, AIResponse):
    if response.success and response.content:
        response_str = response.content
    else:
        response_str = f'AI è°ƒç”¨å¤±è´¥ï¼š{response.error_message}'
```

**æ–‡ä»¶**: 
- `wechat_backend/nxm_result_aggregator.py`
- `wechat_backend/nxm_execution_engine.py`

---

## âœ… éªŒè¯ç»“æœ

### 1. ä»£ç å®¡æŸ¥
- âœ… æ‰€æœ‰é€‚é…å™¨ä»£ç å·²å®¡æŸ¥
- âœ… é”™è¯¯å¤„ç†é€»è¾‘æ­£ç¡®
- âœ… ç”µè·¯æ–­è·¯å™¨é…ç½®åˆç†

### 2. æ•…éšœè½¬ç§»é€»è¾‘
- âœ… DoubaoPriorityAdapter æ•…éšœè½¬ç§»é€»è¾‘å®Œå–„
- âœ… 429 é”™è¯¯æ£€æµ‹æ­£ç¡®
- âœ… å·²è€—å°½æ¨¡å‹è®°å½•æ­£ç¡®

### 3. å…¶ä»–é€‚é…å™¨
- âœ… å…¶ä»–é€‚é…å™¨éƒ½æ˜¯å•ä¸€æ¨¡å‹ï¼Œä¸éœ€è¦æ•…éšœè½¬ç§»
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… ç”µè·¯æ–­è·¯å™¨æ­£å¸¸å·¥ä½œ

---

## ğŸ“Š ä¼˜åŒ–æ€»ç»“

### ä¿®å¤çš„é—®é¢˜
| # | é—®é¢˜ | å½±å“ | ä¿®å¤çŠ¶æ€ |
|---|------|------|----------|
| 1 | DoubaoPriorityAdapter å¥åº·æ£€æŸ¥æ¶ˆè€—é…é¢ | é«˜ | âœ… å·²ä¿®å¤ |
| 2 | 429 é”™è¯¯ä¸è§¦å‘åˆ‡æ¢ | é«˜ | âœ… å·²ä¿®å¤ |
| 3 | æ²¡æœ‰è®°å½•å·²è€—å°½æ¨¡å‹ | ä¸­ | âœ… å·²ä¿®å¤ |
| 4 | AIResponse å¯¹è±¡ä¸å¯è®¢é˜… | é«˜ | âœ… å·²ä¿®å¤ |
| 5 | AIResponse å¯¹è±¡ä¸å¯åºåˆ—åŒ– | é«˜ | âœ… å·²ä¿®å¤ |

### æ— éœ€ä¿®å¤çš„é—®é¢˜
| # | é—®é¢˜ | åŸå›  |
|---|------|------|
| 1 | DoubaoAdapter._health_check() ä»ç„¶å­˜åœ¨ | å…¶ä»–åœ°æ–¹å¯èƒ½è¿˜éœ€è¦ä½¿ç”¨ |
| 2 | å…¶ä»–é€‚é…å™¨æ²¡æœ‰æ•…éšœè½¬ç§»é€»è¾‘ | å•ä¸€æ¨¡å‹é€‚é…å™¨ï¼Œä¸éœ€è¦ |

---

## ğŸ¯ æœ€ç»ˆçŠ¶æ€

### DoubaoPriorityAdapter å·¥ä½œæµç¨‹
```
åˆå§‹åŒ–
  â†“
é€‰æ‹©ç¬¬ä¸€ä¸ªæœªè€—å°½çš„æ¨¡å‹ï¼ˆä¸å¥åº·æ£€æŸ¥ï¼‰
  â†“
è°ƒç”¨ API
  â”œâ”€ æˆåŠŸ â†’ è¿”å›ç»“æœ âœ…
  â””â”€ 429 é”™è¯¯ â†’ æ ‡è®°è€—å°½ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ª
       â†“
  è°ƒç”¨ API
       â”œâ”€ æˆåŠŸ â†’ è¿”å›ç»“æœ âœ…
       â””â”€ 429 é”™è¯¯ â†’ æ ‡è®°è€—å°½ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ª
            â†“
       ...ï¼ˆç»§ç»­ç›´åˆ°æˆåŠŸæˆ–æ‰€æœ‰æ¨¡å‹è€—å°½ï¼‰
```

### å…¶ä»–é€‚é…å™¨å·¥ä½œæµç¨‹
```
åˆå§‹åŒ–
  â†“
é€‰æ‹©é…ç½®çš„æ¨¡å‹
  â†“
è°ƒç”¨ API
  â”œâ”€ æˆåŠŸ â†’ è¿”å›ç»“æœ âœ…
  â””â”€ å¤±è´¥ â†’ è¿”å›é”™è¯¯ï¼ˆç”±ç”µè·¯æ–­è·¯å™¨ä¿æŠ¤ï¼‰
```

---

## ğŸ“ å»ºè®®

### çŸ­æœŸå»ºè®®ï¼ˆ1 å‘¨å†…ï¼‰
1. âœ… **å·²å®Œæˆ**: ä¿®å¤ DoubaoPriorityAdapter æ•…éšœè½¬ç§»é€»è¾‘
2. âœ… **å·²å®Œæˆ**: ä¿®å¤ AIResponse å¯¹è±¡å¤„ç†
3. âš ï¸ **å»ºè®®**: é…ç½®æœ‰æ•ˆçš„è±†åŒ… API Keyï¼ˆè‡³å°‘ 1 ä¸ªï¼‰

### ä¸­æœŸå»ºè®®ï¼ˆ1 ä¸ªæœˆå†…ï¼‰
1. ğŸ“Š **ç›‘æ§**: ç›‘æ§è±†åŒ… API é…é¢ä½¿ç”¨æƒ…å†µ
2. ğŸ“Š **å‘Šè­¦**: è®¾ç½®é…é¢è€—å°½å‘Šè­¦
3. ğŸ“Š **å¤‡ä»½**: é…ç½®å¤‡ç”¨ AI å¹³å°ï¼ˆDeepSeek/Qwenï¼‰

### é•¿æœŸå»ºè®®ï¼ˆ1 å­£åº¦å†…ï¼‰
1. ğŸ”„ **ä¼˜åŒ–**: è€ƒè™‘å®ç°è·¨å¹³å°æ•…éšœè½¬ç§»ï¼ˆè±†åŒ…â†’DeepSeekâ†’Qwenï¼‰
2. ğŸ”„ **ä¼˜åŒ–**: å®ç°æ™ºèƒ½é…é¢ç®¡ç†ï¼ˆæ ¹æ®é…é¢ä½™é‡é€‰æ‹©æ¨¡å‹ï¼‰
3. ğŸ”„ **ä¼˜åŒ–**: æ·»åŠ é…é¢é¢„è­¦ï¼ˆä½™é‡<20% æ—¶å‘Šè­¦ï¼‰

---

## âœ… ç»“è®º

**ç»è¿‡å…¨é¢æ£€æŸ¥ï¼Œç³»ç»Ÿå·²ä¼˜åŒ–å®Œæˆï¼š**

1. âœ… **DoubaoPriorityAdapter** æ•…éšœè½¬ç§»é€»è¾‘å®Œå–„
2. âœ… **AIResponse** å¯¹è±¡å¤„ç†æ­£ç¡®
3. âœ… **æ‰€æœ‰é€‚é…å™¨** é”™è¯¯å¤„ç†å®Œå–„
4. âœ… **ç”µè·¯æ–­è·¯å™¨** é…ç½®åˆç†
5. âœ… **é‡è¯•æœºåˆ¶** ç­–ç•¥åˆç†

**å¯ä»¥å®‰å…¨éƒ¨ç½²ä½¿ç”¨ï¼**

---

**æ£€æŸ¥äºº**: é¦–å¸­æµ‹è¯•å·¥ç¨‹å¸ˆ & é¦–å¸­å…¨æ ˆå¼€å‘å·¥ç¨‹å¸ˆ  
**æ£€æŸ¥æ—¥æœŸ**: 2026-02-24  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
