# API 响应存储完整性分析报告

**报告版本**: v1.0  
**分析时间**: 2026-02-27  
**分析目的**: 检查系统是否完整存储 API 请求返回的详细信息  

---

## 一、执行摘要

### 1.1 核心结论

**⚠️ 存储不完整 - 需要立即修复**

当前系统存在**严重的 API 响应数据丢失问题**：

| 存储位置 | 状态 | 问题 |
|---------|------|------|
| **diagnosis_results 表** | ❌ 空表 | 最近 2 次运行的结果未写入 |
| **ai_responses.jsonl** | ✅ 有数据 | 仅存储简化版响应 |
| **diagnosis_reports 表** | ✅ 有记录 | 仅存储任务元数据 |

### 1.2 缺失的关键数据

当前**未存储**的 API 响应详细信息：

```
❌ tokens_used (Token 消耗量)
❌ metadata (完整元数据)
❌ choices (完整选择列表)
❌ usage (详细用量统计)
❌ finish_reason (完成原因)
❌ reasoning_content (推理内容)
❌ model_version (模型版本)
❌ request_id (请求 ID)
❌ timestamp (精确时间戳)
```

---

## 二、当前存储结构分析

### 2.1 diagnosis_results 表结构

**现有字段**:
```sql
CREATE TABLE diagnosis_results (
    -- 主键
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    
    -- 外键
    report_id INTEGER NOT NULL,
    
    -- 执行标识
    execution_id TEXT NOT NULL,
    
    -- 结果内容（不可变）
    brand TEXT NOT NULL,
    question TEXT NOT NULL,
    model TEXT NOT NULL,
    response_content TEXT NOT NULL,  -- ❌ 仅存储文本内容
    response_latency REAL,           -- ✅ 响应时间
    
    -- GEO 分析
    geo_data TEXT NOT NULL,          -- ✅ JSON 对象
    
    -- 质量评分
    quality_score REAL NOT NULL DEFAULT 0,
    quality_level TEXT NOT NULL DEFAULT 'unknown',
    quality_details TEXT NOT NULL,   -- ✅ JSON 对象
    
    -- 状态
    status TEXT NOT NULL DEFAULT 'success',
    error_message TEXT,
    
    -- 时间戳
    created_at TEXT NOT NULL,
    
    -- 外键约束
    FOREIGN KEY (report_id) REFERENCES diagnosis_reports(id) ON DELETE CASCADE
);
```

**缺失字段**:
```sql
-- ❌ 缺少以下关键字段：
-- API 完整响应
raw_response TEXT,           -- 完整原始响应
response_metadata TEXT,      -- 响应元数据
tokens_used INTEGER,         -- Token 消耗
prompt_tokens INTEGER,       -- 输入 Token
completion_tokens INTEGER,   -- 输出 Token
finish_reason TEXT,          -- 完成原因

-- 请求追踪
request_id TEXT,             -- API 请求 ID
model_version TEXT,          -- 模型版本
api_endpoint TEXT,           -- API 端点

-- 重试信息
retry_count INTEGER,         -- 重试次数
is_fallback BOOLEAN,         -- 是否降级

-- 索引
created_at TEXT,
updated_at TEXT
```

### 2.2 实际存储的数据

**查询结果**:
```sql
-- 检查 diagnosis_results 表
SELECT COUNT(*) FROM diagnosis_results;
-- 结果：0 行（空表！）

-- 检查 diagnosis_reports 表
SELECT execution_id, brand_name, status, created_at 
FROM diagnosis_reports 
ORDER BY created_at DESC;
-- 结果：2 行记录（仅元数据）
```

**实际存储内容**:
```
执行 1: fff462cf-7f22-4f5a-8e5b-a8f6013ba2a6
  brand_name: 华为
  status: completed
  progress: 100
  ✅ 仅存储任务元数据

执行 2: 0ba8dd4b-6251-470c-a748-eed098a41df6
  brand_name: 趣车良品
  status: completed
  progress: 100
  ✅ 仅存储任务元数据
```

### 2.3 文件存储（ai_responses.jsonl）

**存储格式**:
```json
{
  "timestamp": "2026-02-14T23:38:35.041789",
  "question": "数字转型咨询公司推荐",
  "response": "选择数字转型咨询公司时，需结合企业规模...",
  "platform": "豆包",
  "model": "ep-20260212000000-gd5tq",
  "success": true,
  "brand": "埃菲索",
  "competitor": "百思特，艾瑞咨询",
  "latency_ms": 56017,
  "tokens_used": 2660,
  "metadata": {
    "source": "mvp_brand_test",
    "execution_id": "e8390249-c0ab-4de9-9c95-bd6b63fc8c70",
    "question_index": 1,
    "total_questions": 3
  }
}
```

**问题分析**:
```
✅ 存储了：question, response, platform, model, latency_ms, tokens_used
❌ 缺失：raw_response, choices[], usage{}, finish_reason, request_id
```

---

## 三、保存代码分析

### 3.1 保存逻辑位置

**主要保存代码**:
```
/backend_python/wechat_backend/diagnosis_report_storage.py:289
/backend_python/wechat_backend/diagnosis_report_repository.py:349
/backend_python/wechat_backend/views/diagnosis_views.py:814-826
```

### 3.2 实际保存的数据

**diagnosis_views.py 第 814-826 行**:
```python
# 第 814 行：获取 tokens_used
tokens_used=getattr(ai_response, 'tokens_used', None),

# 第 826 行：获取 metadata
raw_response=getattr(ai_response, 'metadata', None),
```

**问题**:
```
⚠️ tokens_used 获取了但未保存到数据库
⚠️ metadata 保存为 raw_response 但不完整
⚠️ ai_response.content 保存为 response_content（仅文本）
⚠️ ai_response.choices[] 未保存
⚠️ ai_response.usage{} 未保存
```

### 3.3 保存流程

**当前流程**:
```
1. AI 调用 → ai_response 对象
   └─ content: "回答文本"
   └─ tokens_used: 1234
   └─ metadata: {...}
   └─ choices: [{...}]  ❌ 未使用
   └─ usage: {...}      ❌ 未使用

2. 提取数据 → result 字典
   └─ brand: "品牌名"
   └─ question: "问题"
   └─ model: "模型"
   └─ response: {
        content: ai_response.content,  ✅
        latency: latency,              ✅
      }
   └─ geo_data: {...}                 ✅
   └─ quality_score: 0.95             ✅

3. 保存到数据库
   └─ response_content: result['response']['content']  ✅
   └─ response_latency: result['response']['latency']  ✅
   └─ geo_data: json.dumps(...)                        ✅
   └─ ❌ tokens_used: 未保存
   └─ ❌ metadata: 未保存
   └─ ❌ choices: 未保存
```

---

## 四、完整 API 响应示例

### 4.1 Doubao API 完整响应

```json
{
  "id": "021772015561276ae81ad6b30110f2c19318a8959acf8019bbfe7",
  "object": "chat.completion",
  "created": 1772015580,
  "model": "doubao-seed-2-0-mini-260215",
  "choices": [
    {
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "作为专业汽车顾问，20 万左右的新能源汽车市场选择丰富...",
        "reasoning_content": "用户现在需要我以专业顾问身份推荐..."
      },
      "finish_reason": "stop",
      "logprobs": null
    }
  ],
  "usage": {
    "prompt_tokens": 325,
    "completion_tokens": 2968,
    "total_tokens": 3293,
    "prompt_tokens_details": {
      "cached_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 2596
    }
  },
  "service_tier": "default"
}
```

### 4.2 当前存储 vs 应存储对比

| 字段 | 当前存储 | 应存储 | 状态 |
|------|---------|--------|------|
| id | ❌ | ✅ | 缺失 |
| model | ✅ | ✅ | 已存 |
| created | ❌ | ✅ | 缺失 |
| choices[].message.content | ✅ (仅文本) | ✅ (完整) | 部分 |
| choices[].message.reasoning_content | ❌ | ✅ | 缺失 |
| choices[].finish_reason | ❌ | ✅ | 缺失 |
| usage.prompt_tokens | ❌ | ✅ | 缺失 |
| usage.completion_tokens | ❌ | ✅ | 缺失 |
| usage.total_tokens | ✅ (tokens_used) | ✅ | 已存 |
| usage.prompt_tokens_details | ❌ | ✅ | 缺失 |
| usage.completion_tokens_details | ❌ | ✅ | 缺失 |
| service_tier | ❌ | ✅ | 缺失 |

---

## 五、影响分析

### 5.1 业务影响

**数据追溯问题**:
```
❌ 无法追溯具体使用了哪个模型版本
❌ 无法分析 Token 消耗详情（prompt vs completion）
❌ 无法查看 AI 推理过程（reasoning_content）
❌ 无法统计缓存命中率（cached_tokens）
❌ 无法优化提示词（缺少完整上下文）
```

**成本核算问题**:
```
❌ 无法精确计算每次调用的成本
❌ 无法按品牌/问题类型分析费用
❌ 无法优化 Token 使用策略
```

**质量分析问题**:
```
❌ 无法分析 finish_reason 分布
❌ 无法优化被截断的回答
❌ 无法评估 reasoning_tokens 占比
```

### 5.2 调试问题

**问题排查困难**:
```
场景：用户反馈回答质量差
当前：只能看到文本内容，无法分析原因
完整：可以查看：
  - finish_reason: 是否被截断
  - usage: Token 是否不足
  - reasoning_tokens: 推理是否充分
  - cached_tokens: 是否命中缓存
```

---

## 六、修复方案

### 6.1 数据库表结构升级

**方案 A: 扩展 diagnosis_results 表**

```sql
-- 添加新字段
ALTER TABLE diagnosis_results ADD COLUMN raw_response TEXT;
ALTER TABLE diagnosis_results ADD COLUMN response_metadata TEXT;
ALTER TABLE diagnosis_results ADD COLUMN tokens_used INTEGER;
ALTER TABLE diagnosis_results ADD COLUMN prompt_tokens INTEGER;
ALTER TABLE diagnosis_results ADD COLUMN completion_tokens INTEGER;
ALTER TABLE diagnosis_results ADD COLUMN finish_reason TEXT;
ALTER TABLE diagnosis_results ADD COLUMN request_id TEXT;
ALTER TABLE diagnosis_results ADD COLUMN model_version TEXT;
ALTER TABLE diagnosis_results ADD COLUMN api_endpoint TEXT;
ALTER TABLE diagnosis_results ADD COLUMN retry_count INTEGER DEFAULT 0;
ALTER TABLE diagnosis_results ADD COLUMN is_fallback BOOLEAN DEFAULT 0;
ALTER TABLE diagnosis_results ADD COLUMN reasoning_content TEXT;
ALTER TABLE diagnosis_results ADD COLUMN cached_tokens INTEGER;
ALTER TABLE diagnosis_results ADD COLUMN updated_at TEXT;

-- 创建索引
CREATE INDEX idx_results_created_at ON diagnosis_results(created_at);
CREATE INDEX idx_results_model ON diagnosis_results(model);
CREATE INDEX idx_results_status ON diagnosis_results(status);
```

**方案 B: 新建 api_responses 表（推荐）**

```sql
CREATE TABLE api_responses (
    -- 主键
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    
    -- 外键
    result_id INTEGER,
    execution_id TEXT NOT NULL,
    
    -- 请求信息
    request_id TEXT,
    api_endpoint TEXT,
    request_body TEXT,
    
    -- 完整响应
    raw_response TEXT NOT NULL,
    response_status INTEGER,
    
    -- 响应详情
    model TEXT NOT NULL,
    model_version TEXT,
    content TEXT NOT NULL,
    reasoning_content TEXT,
    finish_reason TEXT,
    
    -- Token 统计
    prompt_tokens INTEGER,
    completion_tokens INTEGER,
    total_tokens INTEGER,
    cached_tokens INTEGER,
    
    -- 性能
    latency_ms INTEGER,
    first_token_ms INTEGER,
    
    -- 重试信息
    retry_count INTEGER DEFAULT 0,
    is_fallback BOOLEAN DEFAULT 0,
    
    -- 元数据
    service_tier TEXT,
    system_fingerprint TEXT,
    
    -- 时间戳
    created_at TEXT NOT NULL,
    
    FOREIGN KEY (result_id) REFERENCES diagnosis_results(id) ON DELETE CASCADE
);

CREATE INDEX idx_api_responses_execution ON api_responses(execution_id);
CREATE INDEX idx_api_responses_request ON api_responses(request_id);
```

### 6.2 代码修改

**修改 diagnosis_report_storage.py**:

```python
def add(self, report_id: int, execution_id: str, result: Dict[str, Any]) -> int:
    """添加诊断结果（完整版）"""
    now = datetime.now().isoformat()
    
    # 提取完整响应数据
    response = result.get('response', {})
    metadata = response.get('metadata', {})
    usage = metadata.get('usage', {})
    choices = metadata.get('choices', [{}])
    first_choice = choices[0] if choices else {}
    message = first_choice.get('message', {})
    
    with self.get_connection() as conn:
        cursor = conn.cursor()
        cursor.execute('''
            INSERT INTO diagnosis_results (
                report_id, execution_id,
                brand, question, model,
                response_content, response_latency,
                geo_data,
                quality_score, quality_level, quality_details,
                status, error_message,
                raw_response, response_metadata,
                tokens_used, prompt_tokens, completion_tokens,
                finish_reason, request_id, model_version,
                reasoning_content, cached_tokens,
                created_at
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            report_id,
            execution_id,
            result.get('brand', ''),
            result.get('question', ''),
            result.get('model', ''),
            response.get('content', ''),
            response.get('latency'),
            json.dumps(result.get('geo_data', {}), ensure_ascii=False),
            result.get('quality_score', 0),
            result.get('quality_level', 'unknown'),
            json.dumps(result.get('quality_details', {}), ensure_ascii=False),
            result.get('status', 'success'),
            result.get('error'),
            json.dumps(metadata, ensure_ascii=False),  # raw_response
            json.dumps(usage, ensure_ascii=False),     # response_metadata
            usage.get('total_tokens', 0),
            usage.get('prompt_tokens', 0),
            usage.get('completion_tokens', 0),
            first_choice.get('finish_reason', 'stop'),
            metadata.get('id', ''),
            metadata.get('model', ''),
            message.get('reasoning_content', ''),
            usage.get('prompt_tokens_details', {}).get('cached_tokens', 0),
            now
        ))
        
        return cursor.lastrowid
```

### 6.3 迁移脚本

**migrations/005_add_api_response_fields.sql**:
```sql
-- 迁移脚本：添加 API 响应完整字段

-- 1. 备份现有数据
CREATE TABLE diagnosis_results_backup AS SELECT * FROM diagnosis_results;

-- 2. 添加新字段
ALTER TABLE diagnosis_results ADD COLUMN raw_response TEXT;
ALTER TABLE diagnosis_results ADD COLUMN response_metadata TEXT;
ALTER TABLE diagnosis_results ADD COLUMN tokens_used INTEGER;
ALTER TABLE diagnosis_results ADD COLUMN prompt_tokens INTEGER;
ALTER TABLE diagnosis_results ADD COLUMN completion_tokens INTEGER;
ALTER TABLE diagnosis_results ADD COLUMN finish_reason TEXT DEFAULT 'stop';
ALTER TABLE diagnosis_results ADD COLUMN request_id TEXT;
ALTER TABLE diagnosis_results ADD COLUMN model_version TEXT;
ALTER TABLE diagnosis_results ADD COLUMN reasoning_content TEXT;
ALTER TABLE diagnosis_results ADD COLUMN cached_tokens INTEGER DEFAULT 0;
ALTER TABLE diagnosis_results ADD COLUMN updated_at TEXT;

-- 3. 创建索引
CREATE INDEX IF NOT EXISTS idx_results_created_at ON diagnosis_results(created_at);
CREATE INDEX IF NOT EXISTS idx_results_model ON diagnosis_results(model);
CREATE INDEX IF NOT EXISTS idx_results_status ON diagnosis_results(status);

-- 4. 更新现有记录（如果有）
UPDATE diagnosis_results SET updated_at = created_at WHERE updated_at IS NULL;
```

---

## 七、实施计划

### 7.1 短期修复（1 天内）

**P0 优先级**:
1. ✅ 创建数据库迁移脚本
2. ✅ 修改保存代码，存储完整响应
3. ✅ 添加查询接口，验证数据完整性
4. ✅ 更新数据模型类

**验收标准**:
- [ ] 新诊断任务存储完整 API 响应
- [ ] 可查询 tokens_used、finish_reason 等字段
- [ ] 历史数据兼容

### 7.2 中期优化（1 周内）

**P1 优先级**:
1. 新建 api_responses 表（可选）
2. 添加数据导出功能
3. 添加 Token 消耗统计报表
4. 添加 finish_reason 分析

### 7.3 长期规划（1 月内）

**P2 优先级**:
1. 添加响应内容压缩存储
2. 添加数据归档策略
3. 添加成本分析功能
4. 添加推理内容可视化

---

## 八、验证方法

### 8.1 数据完整性检查

```sql
-- 检查新字段是否有数据
SELECT 
    COUNT(*) as total,
    COUNT(tokens_used) as with_tokens,
    COUNT(finish_reason) as with_finish_reason,
    COUNT(raw_response) as with_raw_response
FROM diagnosis_results;

-- 检查具体记录
SELECT 
    execution_id,
    brand,
    model,
    tokens_used,
    prompt_tokens,
    completion_tokens,
    finish_reason,
    length(raw_response) as raw_response_length
FROM diagnosis_results
LIMIT 5;
```

### 8.2 代码验证

```python
# 测试脚本：test_api_response_storage.py
from wechat_backend.diagnosis_report_repository import DiagnosisReportRepository

repo = DiagnosisReportRepository()

# 获取最新结果
results = repo.get_by_execution_id('0ba8dd4b-6251-470c-a748-eed098a41df6')

for result in results:
    print(f"Brand: {result['brand']}")
    print(f"Model: {result['model']}")
    print(f"Tokens Used: {result.get('tokens_used', 'N/A')}")
    print(f"Finish Reason: {result.get('finish_reason', 'N/A')}")
    print(f"Raw Response Length: {len(result.get('raw_response', ''))}")
```

---

## 九、结论

### 9.1 当前状态

**❌ 存储不完整，需要立即修复**

- diagnosis_results 表为空（最近 2 次运行未写入）
- ai_responses.jsonl 存储了简化版响应
- 缺失关键字段：tokens_used、finish_reason、raw_response 等

### 9.2 修复优先级

| 修复项 | 优先级 | 预计时间 |
|--------|--------|---------|
| 添加缺失字段到数据库 | P0 | 2 小时 |
| 修改保存代码 | P0 | 2 小时 |
| 数据迁移 | P1 | 1 小时 |
| 添加查询接口 | P1 | 2 小时 |
| 添加统计报表 | P2 | 4 小时 |

### 9.3 建议

1. **立即执行**: 数据库表结构升级 + 代码修改
2. **本周完成**: 数据迁移 + 查询接口
3. **本月完成**: 统计报表 + 成本分析

---

**报告编制**: 系统架构组  
**审核**: 技术委员会  
**日期**: 2026-02-27  
**版本**: v1.0  

---

## 附录

### A. 相关文件清单

```
/backend_python/wechat_backend/diagnosis_report_storage.py
/backend_python/wechat_backend/diagnosis_report_repository.py
/backend_python/wechat_backend/views/diagnosis_views.py
/backend_python/wechat_backend/v2/models/diagnosis_result.py
/backend_python/data/ai_responses/ai_responses.jsonl
```

### B. 参考文档

- [Doubao API 文档](https://www.volcengine.com/docs/82379)
- [Qwen API 文档](https://help.aliyun.com/zh/dashscope)
- [OpenAI API 文档](https://platform.openai.com/docs/api-reference)
