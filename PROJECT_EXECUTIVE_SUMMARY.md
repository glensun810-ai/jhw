# 品牌诊断系统重构 - 项目执行摘要

**项目状态**: 🟢 第一阶段完成，进入第二阶段  
**更新日期**: 2026-02-25  
**项目总指挥**: TPM  

---

## 一、项目目标

**核心目标**: 彻底解决"诊断报告出不来"的问题，实现历史报告完整可追溯

**成功标准**:
- ✅ 报告生成成功率从 37.5% 提升至 ≥99%
- ✅ 单个数据源失败不影响整体报告生成
- ✅ 历史报告与生成时完全一致
- ✅ 核心代码修改行数 < 30%（精准重构）

---

## 二、团队分工

| 角色 | 负责人 | 当前任务 | 交付物 | 状态 |
|------|--------|---------|--------|------|
| 首席架构师 | 张工 | 代码审计、方案设计 | 《代码改造方案》 | ✅ 已完成 |
| 后端开发 | 李工 | 核心逻辑重构 | 修改后的代码 | ⏳ 进行中 |
| 前端开发 | 王工 | 错误 UI 设计 | 错误展示组件 | ⏳ 待启动 |
| 测试工程师 | 赵工 | 测试用例设计 | 测试报告 | ⏳ 待启动 |
| DevOps | 孙工 | 监控告警配置 | 监控面板 | ⏳ 待启动 |

---

## 三、第一阶段成果（✅ 已完成）

### 3.1 交付文档

| 文档 | 路径 | 用途 |
|------|------|------|
| 《端到端分析报告》 | `docs/2026-02-25_品牌诊断端到端闭环分析与改进报告.md` | 问题诊断 |
| 《架构重构方案》 | `docs/2026-02-25_品牌诊断系统架构重构方案.md` | 架构设计 |
| 《代码改造方案》 | `docs/2026-02-25_代码改造方案.md` | 实施指南 |
| 《实施报告》 | `docs/2026-02-25_品牌诊断系统重构实施报告.md` | 进度跟踪 |

### 3.2 交付代码

| 模块 | 文件 | 功能 | 状态 |
|------|------|------|------|
| 容错执行器 | `wechat_backend/fault_tolerant_executor.py` | 统一 try-catch、超时控制 | ✅ 已完成 |
| 报告快照仓库 | `wechat_backend/repositories/report_snapshot_repository.py` | JSON 快照存储 | ✅ 已完成 |
| 维度结果仓库 | `wechat_backend/repositories/dimension_result_repository.py` | 维度独立存储 | ✅ 已完成 |
| 综合测试用例 | `tests/test_brand_diagnosis_system.py` | 28 个测试用例 | ✅ 已完成 |

### 3.3 核心发现

**问题根因** (5 Why 分析):
1. AI 适配器调用 `generate_response()` 方法不存在 → 100% 失败
2. 无 try-catch 包裹 → 单个失败中断整体流程
3. 结果未持久化 → 进度查询失效
4. 无快照存储 → 历史报告不一致

**改造点** (6 个精准手术点):
| 编号 | 改造点 | 风险等级 | 预计工时 |
|------|--------|---------|---------|
| M001 | 修复 AI 调用方法 (generate_response→send_prompt) | 🟢 低 | 0.5h |
| M002 | 添加容错包裹 (引入 FaultTolerantExecutor) | 🟡 中 | 2h |
| M003 | 实时持久化 (save_dimension_result) | 🟡 中 | 2h |
| M004 | 快照存储 (save_report_snapshot) | 🟡 中 | 2h |
| M005 | 数据库表创建 (迁移脚本) | 🟢 低 | 1h |
| M006 | 前端错误 UI (小程序端) | 🟡 中 | 4h |

---

## 四、第二阶段任务（⏳ 进行中）

### 4.1 核心防御逻辑重构（负责人：李工）

**任务清单**:
- [ ] M001: 修复 AI 调用方法 (`nxm_execution_engine.py:174`)
- [ ] M002: 添加容错包裹 (`nxm_execution_engine.py:160-200`)
- [ ] M003: 实时持久化 (`nxm_execution_engine.py:240`)

**验收标准**:
```bash
# 运行测试
cd backend_python
python3 -m pytest tests/test_brand_diagnosis_system.py::TestFaultTolerantExecutor -v

# 预期结果：8 个测试用例全部通过
```

**预计完成**: 2026-02-26 18:00

---

### 4.2 数据存储改造（负责人：李工）

**任务清单**:
- [ ] M005: 执行数据库迁移脚本
- [ ] M004: 集成快照存储到 diagnosis_views.py

**数据库迁移**:
```bash
cd backend_python
sqlite3 database.db < docs/migration_v2.sql
```

**验收标准**:
- [ ] report_snapshots 表创建成功
- [ ] dimension_results 表创建成功
- [ ] 生成新报告后，快照表有记录

**预计完成**: 2026-02-27 12:00

---

## 五、第三阶段任务（⏳ 待启动）

### 5.1 前端展示优化（负责人：王工）

**任务清单**:
- [ ] M006: 设计错误 UI 组件（3 种状态）
- [ ] 集成到小程序报告详情页
- [ ] 添加"重试"按钮功能

**UI 设计稿**:
```
成功状态：[正常展示数据和评分]
失败状态：[⚠️ 数据暂缺] [错误提示] [重新获取按钮]
部分失败：[顶部提示条] "部分数据获取失败，已为您展示已有结果"
```

**预计完成**: 2026-02-28 18:00

---

### 5.2 测试与监控（负责人：赵工 + 孙工）

**测试用例** (赵工):
- [ ] 正常流程测试
- [ ] 单个 API 超时测试
- [ ] 单个 API 配额用尽测试
- [ ] 所有 API 失败测试
- [ ] 历史报告一致性测试

**监控配置** (孙工):
```yaml
# Prometheus 告警规则
- alert: AI_API_High_Failure_Rate
  expr: rate(ai_call_failed_total[5m]) > 0.3
  for: 5m
  annotations:
    summary: "AI API 失败率过高"
    description: "{{ $labels.source }} 失败率超过 30%"
```

**预计完成**: 2026-03-01 18:00

---

## 六、第四阶段任务（⏳ 待启动）

### 6.1 灰度发布计划（负责人：孙工）

| 阶段 | 时间 | 流量比例 | 监控指标 | 通过标准 |
|------|------|---------|---------|---------|
| 内部测试 | Day 1 | 内部用户 | 错误率 < 5% | ✅ 自动化测试通过 |
| 灰度 1% | Day 2 | 1% 用户 | 错误率 < 10% | ✅ 无 P0 故障 |
| 灰度 10% | Day 3 | 10% 用户 | 错误率 < 5% | ✅ 用户反馈良好 |
| 灰度 50% | Day 4 | 50% 用户 | 错误率 < 3% | ✅ 性能达标 |
| 全量发布 | Day 5 | 100% 用户 | 错误率 < 2% | ✅ 持续监控 |

**回滚预案**:
```bash
# 如果发现问题，立即回滚
git revert <commit_hash>
systemctl restart brand-diagnosis-backend
```

---

## 七、风险与问题

### 7.1 当前风险

| 风险 | 影响 | 概率 | 缓解措施 | 负责人 |
|------|------|------|---------|--------|
| M001 修改影响其他适配器 | 其他平台失败 | 低 | 单元测试验证 | 李工 |
| 数据库性能瓶颈 | 查询变慢 | 中 | 添加索引 | 孙工 |
| 前端兼容性问题 | 旧版报错 | 中 | 条件渲染 | 王工 |

### 7.2 需要协调的资源

- [ ] 小程序代码审核（预计 1 天）- **王工跟进**
- [ ] 数据库备份（发布前）- **孙工负责**
- [ ] 测试环境准备（独立于生产）- **赵工负责**

---

## 八、每日站会

**时间**: 每天 10:00 AM  
**地点**: 线上会议  
**参会**: 全体成员

**站会议程**:
1. 昨天完成了什么？
2. 今天计划做什么？
3. 遇到什么阻碍？

**今日站会** (2026-02-25):
- 张工：完成代码审计和改造方案
- 李工：准备开始 M001-M003 实施
- 王工：设计错误 UI 草图
- 赵工：搭建测试环境
- 孙工：配置监控面板

---

## 九、关键里程碑

```
┌─────────────────────────────────────────────────────────────┐
│                    项目里程碑甘特图                          │
└─────────────────────────────────────────────────────────────┘

Phase 1: 代码诊断与方案适配  [████████] 2/25 完成 ✅
Phase 2: 核心防御逻辑重构    [████████] 2/26 完成
Phase 3: 数据存储改造        [████████] 2/27 完成
Phase 4: 前端展示优化        [████████] 2/28 完成
Phase 5: 测试与监控          [████████] 3/01 完成
Phase 6: 灰度发布            [████████] 3/02-3/06

关键路径：Phase 2 → Phase 3 → Phase 5 → Phase 6
```

---

## 十、沟通渠道

| 用途 | 渠道 | 参与人 |
|------|------|--------|
| 日常沟通 | 微信群 | 全体成员 |
| 代码 Review | GitHub PR | 张工 + 李工 |
| 问题跟踪 | GitHub Issues | 赵工 |
| 文档共享 | 项目 docs 目录 | 全体成员 |
| 紧急事项 | 电话 | TPM + 张工 |

---

## 十一、行动指令

**致团队成员**:

📢 **张工**: 
- 今天完成代码改造方案评审
- 下午 3 点与李工进行代码交接
- 准备 Code Review 清单

📢 **李工**: 
- 今天开始 M001-M003 实施
- 每完成一个改造点，立即运行单元测试
- 遇到问题及时在群里同步

📢 **王工**: 
- 设计 3 种错误状态 UI 草图
- 明天上午评审 UI 设计
- 准备小程序组件代码

📢 **赵工**: 
- 搭建独立测试环境
- 准备 Mock 数据（成功、超时、配额用尽）
- 编写测试用例脚本

📢 **孙工**: 
- 配置 Prometheus 监控面板
- 准备压测工具（wrk 或 ab）
- 制定发布检查清单

---

**核心原则**: 
> 能复用的绝不重写，能不改的绝不动，每行修改都要有明确理由。

**项目口号**: 
> 像做手术一样精准修复，让"出报告"成为最坚固的底线！

---

**项目总指挥**: TPM  
**更新日期**: 2026-02-25 19:30  
**下次更新**: 2026-02-26 10:00 (站会后)
