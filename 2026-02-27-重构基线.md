代码库结构综合分析报告
1. 项目类型和主要技术栈
项目类型: 微信小程序 + Flask 后端 API 系统
主要技术栈:
•
前端: 微信小程序 (WXML, WXSS, JavaScript)
•
后端: Python Flask 3.1.2
•
数据库: SQLite3 (带连接池和 WAL 模式)
•
AI 平台集成: DeepSeek, 豆包 (Doubao), 通义千问 (Qwen), ChatGPT, Gemini, 智谱 AI, 文心一言等
•
认证: JWT (PyJWT), 微信小程序认证
•
安全: CORS, 速率限制, SQL 注入防护, 输入验证
核心功能: 品牌诊断/GEO(生成式引擎优化) 分析系统
2. 目录结构概览
/Users/sgl/PycharmProjects/PythonProject/
├── api/                              # 前端 API 调用层 (JavaScript)
│   ├── auth.js                       # 认证 API
│   ├── brand-enhanced-api.js         # 品牌诊断增强 API
│   ├── competitive-analysis.js       # 竞品分析 API
│   ├── data-sync.js                  # 数据同步 API
│   ├── export.js                     # 导出 API
│   ├── history.js                    # 历史记录 API
│   ├── home.js                       # 首页 API
│   ├── sync.js                       # 同步 API
│   └── user.js                       # 用户 API
│
├── backend_python/                   # Python 后端主目录
│   ├── wechat_backend/               # 微信小程序后端
│   │   ├── ai_adapters/              # AI 平台适配器
│   │   ├── analytics/                # 分析服务
│   │   ├── cache/                    # 缓存服务
│   │   ├── config/                   # 配置管理
│   │   ├── database/                 # 数据库工具
│   │   ├── intelligence_services/    # 情报服务
│   │   ├── monitoring/               # 监控服务
│   │   ├── repositories/             # 数据仓库层
│   │   ├── security/                 # 安全模块
│   │   ├── services/                 # 业务服务层
│   │   ├── views/                    # API 视图/路由
│   │   ├── app.py                    # Flask 应用入口
│   │   ├── models.py                 # 数据模型
│   │   ├── diagnosis_report_service.py    # 诊断报告服务
│   │   ├── diagnosis_report_repository.py # 诊断报告仓库
│   │   ├── state_manager.py          # 状态管理器
│   │   ├── nxm_execution_engine.py   # NxM 执行引擎
│   │   └── diagnosis_views.py        # 诊断视图
│   │
│   ├── tests/                        # 后端测试
│   ├── config/                       # 配置模块
│   └── utils/                        # 工具函数
│
├── components/                       # 微信小程序组件
│   ├── diagnostic-drawer/            # 诊断抽屉组件
│   ├── AnalysisCard/                 # 分析卡片
│   ├── AnalysisCharts/               # 分析图表
│   ├── BattlefieldMatrix/            # 战场矩阵
│   ├── CompetitiveAnalysis/          # 竞品分析
│   ├── ScoreRadar/                   # 评分雷达图
│   └── ... (多个可视化组件)
│
├── pages/                            # 微信小程序页面
│   ├── index/                        # 首页 (诊断入口)
│   ├── results/                      # 结果页
│   ├── report/                       # 报告页
│   ├── history/                      # 历史记录
│   ├── saved-results/                # 收藏报告
│   ├── user-profile/                 # 用户资料
│   ├── admin/                        # 管理后台
│   └── ... (共 20+ 页面)
│
├── services/                         # 前端服务层
├── store/                            # 前端状态管理
├── styles/                           # 全局样式
├── utils/                            # 前端工具函数
├── tests/                            # 前端测试
├── data/                             # 数据文件
├── logs/                             # 日志文件
└── docs/                             # 文档
3. 品牌诊断功能相关文件
3.1 后端核心文件
文件路径
描述
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/app.py
Flask 应用主入口，注册所有蓝图
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/views/diagnosis_api.py
诊断 API 路由定义 (/api/diagnosis/*)
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/views/diagnosis_views.py
诊断视图实现 (3056 行，核心业务逻辑)
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/diagnosis_report_service.py
诊断报告业务服务层
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/diagnosis_report_repository.py
诊断报告数据仓库层 (806 行)
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/state_manager.py
状态管理器 (统一内存和数据库状态)
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/models.py
数据模型定义 (BrandTestResult, DeepIntelligenceResult 等)
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/nxm_execution_engine.py
NxM 矩阵执行引擎
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/nxm_result_aggregator.py
NxM 结果聚合器
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/realtime_analyzer.py
实时分析器
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/incremental_aggregator.py
增量聚合器
3.2 AI 适配器
文件路径
描述
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/ai_adapters/factory.py
AI 适配器工厂
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/ai_adapters/base_adapter.py
AI 适配器基类
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/ai_adapters/doubao_adapter.py
豆包 API 适配器
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/ai_adapters/deepseek_r1_adapter.py
DeepSeek 适配器
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/ai_adapters/qwen_provider.py
通义千问适配器
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/ai_adapters/chatgpt_adapter.py
ChatGPT 适配器
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/ai_adapters/gemini_adapter.py
Gemini 适配器
3.3 前端核心文件
文件路径
描述
/Users/sgl/PycharmProjects/PythonProject/pages/index/index.js
首页逻辑 (2061 行，诊断入口)
/Users/sgl/PycharmProjects/PythonProject/pages/results/results.js
结果页逻辑
/Users/sgl/PycharmProjects/PythonProject/pages/results/results.wxml
结果页模板
/Users/sgl/PycharmProjects/PythonProject/api/brand-enhanced-api.js
品牌诊断 API 封装
/Users/sgl/PycharmProjects/PythonProject/services/brandTestService.js
品牌测试服务
/Users/sgl/PycharmProjects/PythonProject/services/dataProcessorService.js
数据处理服务
/Users/sgl/PycharmProjects/PythonProject/components/diagnostic-drawer/index.js
诊断抽屉组件
4. API 路由定义
4.1 主要诊断 API
# 诊断 API 蓝图 (diagnosis_api.py)
GET  /api/diagnosis/history              # 获取用户历史报告
GET  /api/diagnosis/report/<execution_id>  # 获取完整报告
GET  /api/diagnosis/report/<execution_id>/validate  # 验证报告完整性

# 诊断视图 (diagnosis_views.py)
POST /api/perform-brand-test             # 启动品牌诊断任务
GET  /test/status/<task_id>              # 获取任务状态
GET  /test/result/<task_id>              # 获取测试结果
GET  /api/test-progress                  # 获取测试进度
GET  /api/stream/progress/<execution_id> # SSE 流式进度

# 监控 API (app.py)
GET  /api/monitoring/dashboard           # 监控大盘数据
GET  /api/monitoring/recent              # 最近诊断列表
GET  /api/monitoring/export              # 导出监控数据
4.2 其他重要 API
# 用户认证
POST /api/login                          # 登录
POST /api/register                       # 注册
POST /api/logout                         # 登出
GET  /api/user/profile                   # 获取用户资料

# 数据分析
GET  /api/geo-analysis/<execution_id>    # GEO 分析数据
GET  /api/workflow-results/<execution_id> # 工作流结果
GET  /api/roi-metrics/<execution_id>     # ROI 指标

# 管理后台
GET  /admin/monitoring                   # 监控大盘页面
GET  /api/admin/tests                    # 测试管理
GET  /api/admin/users                    # 用户管理
5. 数据库模型和 Schema
5.1 核心数据表 (models.py)
-- 任务状态表
CREATE TABLE task_statuses (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id TEXT UNIQUE NOT NULL,
    progress INTEGER DEFAULT 0,
    stage TEXT NOT NULL,          -- init, ai_fetching, ranking_analysis, source_tracing, completed, failed
    status_text TEXT,
    is_completed BOOLEAN DEFAULT 0,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- 深度情报结果表
CREATE TABLE deep_intelligence_results (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id TEXT UNIQUE NOT NULL,
    exposure_analysis TEXT,       -- JSON
    source_intelligence TEXT,     -- JSON
    evidence_chain TEXT,          -- JSON
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- 品牌测试结果表
CREATE TABLE brand_test_results (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id TEXT UNIQUE NOT NULL,
    brand_name TEXT NOT NULL,
    ai_models_used TEXT,          -- JSON
    questions_used TEXT,          -- JSON
    overall_score REAL,
    total_tests INTEGER,
    results_summary TEXT,         -- JSON
    detailed_results TEXT,        -- JSON
    deep_intelligence_result TEXT, -- JSON
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
5.2 诊断报告表 (diagnosis_report_repository.py)
-- 诊断报告主表
CREATE TABLE diagnosis_reports (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    execution_id TEXT UNIQUE NOT NULL,
    user_id TEXT NOT NULL,
    brand_name TEXT,
    competitor_brands TEXT,       -- JSON
    selected_models TEXT,         -- JSON
    custom_questions TEXT,        -- JSON
    status TEXT,                  -- initializing, ai_fetching, analyzing, completed, failed
    progress INTEGER,
    stage TEXT,
    is_completed BOOLEAN,
    created_at TIMESTAMP,
    completed_at TIMESTAMP,
    data_schema_version TEXT,
    server_version TEXT,
    checksum TEXT
);

-- 诊断结果明细表
CREATE TABLE diagnosis_results (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    report_id INTEGER,
    execution_id TEXT,
    brand TEXT,
    question TEXT,
    model TEXT,
    response TEXT,                -- JSON
    geo_data TEXT,                -- JSON
    quality_score REAL,
    quality_level TEXT,
    created_at TIMESTAMP,
    FOREIGN KEY (report_id) REFERENCES diagnosis_reports(id)
);

-- 诊断分析数据表
CREATE TABLE diagnosis_analysis (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    report_id INTEGER,
    execution_id TEXT,
    analysis_type TEXT,           -- competitive_analysis, brand_scores, etc.
    analysis_data TEXT,           -- JSON
    created_at TIMESTAMP,
    FOREIGN KEY (report_id) REFERENCES diagnosis_reports(id)
);

-- 报告快照表
CREATE TABLE report_snapshots (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    execution_id TEXT UNIQUE NOT NULL,
    user_id TEXT,
    report_data TEXT,             -- 完整报告 JSON
    report_version TEXT,
    created_at TIMESTAMP
);
6. 测试文件
6.1 后端测试
文件路径
描述
/Users/sgl/PycharmProjects/PythonProject/backend_python/tests/test_brand_diagnosis_system.py
品牌诊断系统测试
/Users/sgl/PycharmProjects/PythonProject/backend_python/tests/test_e2e_full_flow.py
端到端完整流程测试
/Users/sgl/PycharmProjects/PythonProject/backend_python/tests/test_e2e_connectivity.py
端到端连接测试
/Users/sgl/PycharmProjects/PythonProject/backend_python/tests/test_integration_full.py
完整集成测试
/Users/sgl/PycharmProjects/PythonProject/backend_python/tests/test_services/
服务层测试
/Users/sgl/PycharmProjects/PythonProject/backend_python/tests/test_adapters/
AI 适配器测试
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/tests/test_diagnosis_report_storage.py
诊断报告存储测试
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/tests/test_quality_scorer.py
质量评分器测试
6.2 前端测试
文件路径
描述
/Users/sgl/PycharmProjects/PythonProject/tests/test-brandTestService.js
品牌测试服务测试
/Users/sgl/PycharmProjects/PythonProject/tests/test-dataLoaderService.test.js
数据加载服务测试
/Users/sgl/PycharmProjects/PythonProject/tests/test-taskStatusService.test.js
任务状态服务测试
/Users/sgl/PycharmProjects/PythonProject/tests/test-pages-index.js
首页测试
/Users/sgl/PycharmProjects/PythonProject/tests/test-pages-results.js
结果页测试
6.3 综合测试脚本
文件路径
描述
/Users/sgl/PycharmProjects/PythonProject/test_diagnosis_e2e.py
诊断端到端测试
/Users/sgl/PycharmProjects/PythonProject/test_p0_fixes_comprehensive.py
P0 修复综合测试
/Users/sgl/PycharmProjects/PythonProject/test_comprehensive_p0_fix.py
P0 修复综合验证
/Users/sgl/PycharmProjects/PythonProject/run_comprehensive_tests.py
综合测试运行器
/Users/sgl/PycharmProjects/PythonProject/complete_diagnostics_test.py
完整诊断测试
7. 配置文件
文件路径
描述
/Users/sgl/PycharmProjects/PythonProject/requirements.txt
根目录依赖 (Flask 3.1.2)
/Users/sgl/PycharmProjects/PythonProject/backend_python/requirements.txt
后端依赖 (Flask 2.0.1 + 扩展)
/Users/sgl/PycharmProjects/PythonProject/.env.example
环境变量示例
/Users/sgl/PycharmProjects/PythonProject/.flaskenv
Flask 环境配置
/Users/sgl/PycharmProjects/PythonProject/app.json
小程序页面配置
/Users/sgl/PycharmProjects/PythonProject/project.config.json
微信开发者工具配置
/Users/sgl/PycharmProjects/PythonProject/api_contract.json
API 契约文档
8. 明显的模式和问题
8.1 架构模式
1.
分层架构:
◦
Repository 层 (数据访问)
◦
Service 层 (业务逻辑)
◦
View 层 (API 路由)
2.
状态管理:
◦
使用 execution_store 内存存储
◦
使用 DiagnosisStateManager 统一内存和数据库状态
◦
支持 SSE 实时推送
3.
执行模式:
◦
NxM 矩阵执行 (N 个问题 × M 个模型)
◦
支持并发执行
◦
WAL (Write-Ahead Logging) 持久化
8.2 发现的问题
1.
文件组织混乱:
◦
根目录有 200+ 个脚本文件 (add_.py, fix_.py, test_*.py)
◦
大量修复脚本和报告文件散落在根目录
◦
建议：创建 scripts/ 和 docs/reports/ 目录归类
2.
代码重复:
◦
多个 AI 适配器实现有重复代码
◦
存在多个版本的相同功能文件 (如 sse_service.py 和 sse_service_v2.py)
3.
配置分散:
◦
配置分布在 .env, config.py, config_manager.py 等多处
◦
建议：统一配置管理
4.
测试覆盖不全:
◦
虽然有大量测试文件，但很多是临时修复验证脚本
◦
缺少系统的单元测试和集成测试套件
5.
日志过多:
◦
代码中有大量调试日志 (api_logger.info, debug_log 等)
◦
生产环境应降低日志级别
6.
硬编码路径:
◦
部分文件路径硬编码 (如 /tmp/nxm_wal)
◦
建议使用配置或环境变量
7.
数据库 Schema 演进:
◦
有多个迁移文件但缺少版本管理
◦
建议：使用正式的迁移工具 (如 Alembic)
8.
文档分散:
◦
大量 Markdown 报告文件在根目录
◦
建议：整理到 docs/ 目录并建立索引
9. 品牌诊断核心流程
用户输入品牌名称和竞品
        ↓
前端验证并发送 POST /api/perform-brand-test
        ↓
后端生成 execution_id 并创建初始数据库记录
        ↓
NxM 执行引擎启动异步任务
        ↓
遍历问题 × 模型组合调用 AI API
        ↓
实时结果通过 SSE 推送到前端
        ↓
结果聚合和质量评分
        ↓
生成深度情报分析 (露出分析、信源归因、证据链)
        ↓
保存到数据库和文件归档
        ↓
前端轮询 /test/status/<execution_id> 获取进度
        ↓
完成后展示结果页面
10. 关键数据流
前端 (pages/index/index.js)
  ↓ POST /api/perform-brand-test
后端 (diagnosis_views.py::perform_brand_test)
  ↓ 创建报告 (diagnosis_report_service.py::create_report)
  ↓ 执行 NxM 测试 (nxm_execution_engine.py::execute_nxm_test)
  ↓ 实时分析 (realtime_analyzer.py)
  ↓ 增量聚合 (incremental_aggregator.py)
  ↓ 保存结果 (diagnosis_report_repository.py::add_results_batch)
  ↓ 生成分析 (competitive_analysis.py, analytics_service.py)
  ↓ 完成报告 (diagnosis_report_service.py::complete_report)
  ↓ SSE 通知 (sse_service.py::send_completion_notification)
前端轮询状态
  ↓ GET /test/status/<execution_id>
后端返回进度和结果
  ↓
前端展示 (pages/results/results.js)
这份分析报告涵盖了项目的整体架构、关键技术文件、API 路由、数据库模型、测试文件和发现的问题。项目是一个功能完善的品牌诊断/GEO 分析系统，具有完整的前后端实现和多 AI 平台集成能力。
I'll explore the codebase comprehensively. Let me start with multiple parallel searches to understand the project structure.
Let me continue exploring the key directories and configuration files:
Now let me look at key backend files, API routes, database models, and diagnostic-related components:
Let me explore more key files - services, repositories, and frontend pages:
Let me look at the test files and explore additional key components:
Let me look at a few more key files to complete the analysis:
Now I have a comprehensive understanding of the codebase. Let me provide a detailed summary:
代码库结构综合分析报告
1. 项目类型和主要技术栈
项目类型: 微信小程序 + Flask 后端 API 系统
主要技术栈:
•
前端: 微信小程序 (WXML, WXSS, JavaScript)
•
后端: Python Flask 3.1.2
•
数据库: SQLite3 (带连接池和 WAL 模式)
•
AI 平台集成: DeepSeek, 豆包 (Doubao), 通义千问 (Qwen), ChatGPT, Gemini, 智谱 AI, 文心一言等
•
认证: JWT (PyJWT), 微信小程序认证
•
安全: CORS, 速率限制, SQL 注入防护, 输入验证
核心功能: 品牌诊断/GEO(生成式引擎优化) 分析系统
2. 目录结构概览
/Users/sgl/PycharmProjects/PythonProject/
├── api/                              # 前端 API 调用层 (JavaScript)
│   ├── auth.js                       # 认证 API
│   ├── brand-enhanced-api.js         # 品牌诊断增强 API
│   ├── competitive-analysis.js       # 竞品分析 API
│   ├── data-sync.js                  # 数据同步 API
│   ├── export.js                     # 导出 API
│   ├── history.js                    # 历史记录 API
│   ├── home.js                       # 首页 API
│   ├── sync.js                       # 同步 API
│   └── user.js                       # 用户 API
│
├── backend_python/                   # Python 后端主目录
│   ├── wechat_backend/               # 微信小程序后端
│   │   ├── ai_adapters/              # AI 平台适配器
│   │   ├── analytics/                # 分析服务
│   │   ├── cache/                    # 缓存服务
│   │   ├── config/                   # 配置管理
│   │   ├── database/                 # 数据库工具
│   │   ├── intelligence_services/    # 情报服务
│   │   ├── monitoring/               # 监控服务
│   │   ├── repositories/             # 数据仓库层
│   │   ├── security/                 # 安全模块
│   │   ├── services/                 # 业务服务层
│   │   ├── views/                    # API 视图/路由
│   │   ├── app.py                    # Flask 应用入口
│   │   ├── models.py                 # 数据模型
│   │   ├── diagnosis_report_service.py    # 诊断报告服务
│   │   ├── diagnosis_report_repository.py # 诊断报告仓库
│   │   ├── state_manager.py          # 状态管理器
│   │   ├── nxm_execution_engine.py   # NxM 执行引擎
│   │   └── diagnosis_views.py        # 诊断视图
│   │
│   ├── tests/                        # 后端测试
│   ├── config/                       # 配置模块
│   └── utils/                        # 工具函数
│
├── components/                       # 微信小程序组件
│   ├── diagnostic-drawer/            # 诊断抽屉组件
│   ├── AnalysisCard/                 # 分析卡片
│   ├── AnalysisCharts/               # 分析图表
│   ├── BattlefieldMatrix/            # 战场矩阵
│   ├── CompetitiveAnalysis/          # 竞品分析
│   ├── ScoreRadar/                   # 评分雷达图
│   └── ... (多个可视化组件)
│
├── pages/                            # 微信小程序页面
│   ├── index/                        # 首页 (诊断入口)
│   ├── results/                      # 结果页
│   ├── report/                       # 报告页
│   ├── history/                      # 历史记录
│   ├── saved-results/                # 收藏报告
│   ├── user-profile/                 # 用户资料
│   ├── admin/                        # 管理后台
│   └── ... (共 20+ 页面)
│
├── services/                         # 前端服务层
├── store/                            # 前端状态管理
├── styles/                           # 全局样式
├── utils/                            # 前端工具函数
├── tests/                            # 前端测试
├── data/                             # 数据文件
├── logs/                             # 日志文件
└── docs/                             # 文档
3. 品牌诊断功能相关文件
3.1 后端核心文件
文件路径
描述
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/app.py
Flask 应用主入口，注册所有蓝图
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/views/diagnosis_api.py
诊断 API 路由定义 (/api/diagnosis/*)
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/views/diagnosis_views.py
诊断视图实现 (3056 行，核心业务逻辑)
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/diagnosis_report_service.py
诊断报告业务服务层
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/diagnosis_report_repository.py
诊断报告数据仓库层 (806 行)
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/state_manager.py
状态管理器 (统一内存和数据库状态)
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/models.py
数据模型定义 (BrandTestResult, DeepIntelligenceResult 等)
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/nxm_execution_engine.py
NxM 矩阵执行引擎
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/nxm_result_aggregator.py
NxM 结果聚合器
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/realtime_analyzer.py
实时分析器
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/incremental_aggregator.py
增量聚合器
3.2 AI 适配器
文件路径
描述
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/ai_adapters/factory.py
AI 适配器工厂
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/ai_adapters/base_adapter.py
AI 适配器基类
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/ai_adapters/doubao_adapter.py
豆包 API 适配器
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/ai_adapters/deepseek_r1_adapter.py
DeepSeek 适配器
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/ai_adapters/qwen_provider.py
通义千问适配器
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/ai_adapters/chatgpt_adapter.py
ChatGPT 适配器
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/ai_adapters/gemini_adapter.py
Gemini 适配器
3.3 前端核心文件
文件路径
描述
/Users/sgl/PycharmProjects/PythonProject/pages/index/index.js
首页逻辑 (2061 行，诊断入口)
/Users/sgl/PycharmProjects/PythonProject/pages/results/results.js
结果页逻辑
/Users/sgl/PycharmProjects/PythonProject/pages/results/results.wxml
结果页模板
/Users/sgl/PycharmProjects/PythonProject/api/brand-enhanced-api.js
品牌诊断 API 封装
/Users/sgl/PycharmProjects/PythonProject/services/brandTestService.js
品牌测试服务
/Users/sgl/PycharmProjects/PythonProject/services/dataProcessorService.js
数据处理服务
/Users/sgl/PycharmProjects/PythonProject/components/diagnostic-drawer/index.js
诊断抽屉组件
4. API 路由定义
4.1 主要诊断 API
# 诊断 API 蓝图 (diagnosis_api.py)
GET  /api/diagnosis/history              # 获取用户历史报告
GET  /api/diagnosis/report/<execution_id>  # 获取完整报告
GET  /api/diagnosis/report/<execution_id>/validate  # 验证报告完整性

# 诊断视图 (diagnosis_views.py)
POST /api/perform-brand-test             # 启动品牌诊断任务
GET  /test/status/<task_id>              # 获取任务状态
GET  /test/result/<task_id>              # 获取测试结果
GET  /api/test-progress                  # 获取测试进度
GET  /api/stream/progress/<execution_id> # SSE 流式进度

# 监控 API (app.py)
GET  /api/monitoring/dashboard           # 监控大盘数据
GET  /api/monitoring/recent              # 最近诊断列表
GET  /api/monitoring/export              # 导出监控数据
4.2 其他重要 API
# 用户认证
POST /api/login                          # 登录
POST /api/register                       # 注册
POST /api/logout                         # 登出
GET  /api/user/profile                   # 获取用户资料

# 数据分析
GET  /api/geo-analysis/<execution_id>    # GEO 分析数据
GET  /api/workflow-results/<execution_id> # 工作流结果
GET  /api/roi-metrics/<execution_id>     # ROI 指标

# 管理后台
GET  /admin/monitoring                   # 监控大盘页面
GET  /api/admin/tests                    # 测试管理
GET  /api/admin/users                    # 用户管理
5. 数据库模型和 Schema
5.1 核心数据表 (models.py)
-- 任务状态表
CREATE TABLE task_statuses (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id TEXT UNIQUE NOT NULL,
    progress INTEGER DEFAULT 0,
    stage TEXT NOT NULL,          -- init, ai_fetching, ranking_analysis, source_tracing, completed, failed
    status_text TEXT,
    is_completed BOOLEAN DEFAULT 0,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- 深度情报结果表
CREATE TABLE deep_intelligence_results (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id TEXT UNIQUE NOT NULL,
    exposure_analysis TEXT,       -- JSON
    source_intelligence TEXT,     -- JSON
    evidence_chain TEXT,          -- JSON
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- 品牌测试结果表
CREATE TABLE brand_test_results (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id TEXT UNIQUE NOT NULL,
    brand_name TEXT NOT NULL,
    ai_models_used TEXT,          -- JSON
    questions_used TEXT,          -- JSON
    overall_score REAL,
    total_tests INTEGER,
    results_summary TEXT,         -- JSON
    detailed_results TEXT,        -- JSON
    deep_intelligence_result TEXT, -- JSON
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
5.2 诊断报告表 (diagnosis_report_repository.py)
-- 诊断报告主表
CREATE TABLE diagnosis_reports (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    execution_id TEXT UNIQUE NOT NULL,
    user_id TEXT NOT NULL,
    brand_name TEXT,
    competitor_brands TEXT,       -- JSON
    selected_models TEXT,         -- JSON
    custom_questions TEXT,        -- JSON
    status TEXT,                  -- initializing, ai_fetching, analyzing, completed, failed
    progress INTEGER,
    stage TEXT,
    is_completed BOOLEAN,
    created_at TIMESTAMP,
    completed_at TIMESTAMP,
    data_schema_version TEXT,
    server_version TEXT,
    checksum TEXT
);

-- 诊断结果明细表
CREATE TABLE diagnosis_results (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    report_id INTEGER,
    execution_id TEXT,
    brand TEXT,
    question TEXT,
    model TEXT,
    response TEXT,                -- JSON
    geo_data TEXT,                -- JSON
    quality_score REAL,
    quality_level TEXT,
    created_at TIMESTAMP,
    FOREIGN KEY (report_id) REFERENCES diagnosis_reports(id)
);

-- 诊断分析数据表
CREATE TABLE diagnosis_analysis (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    report_id INTEGER,
    execution_id TEXT,
    analysis_type TEXT,           -- competitive_analysis, brand_scores, etc.
    analysis_data TEXT,           -- JSON
    created_at TIMESTAMP,
    FOREIGN KEY (report_id) REFERENCES diagnosis_reports(id)
);

-- 报告快照表
CREATE TABLE report_snapshots (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    execution_id TEXT UNIQUE NOT NULL,
    user_id TEXT,
    report_data TEXT,             -- 完整报告 JSON
    report_version TEXT,
    created_at TIMESTAMP
);
6. 测试文件
6.1 后端测试
文件路径
描述
/Users/sgl/PycharmProjects/PythonProject/backend_python/tests/test_brand_diagnosis_system.py
品牌诊断系统测试
/Users/sgl/PycharmProjects/PythonProject/backend_python/tests/test_e2e_full_flow.py
端到端完整流程测试
/Users/sgl/PycharmProjects/PythonProject/backend_python/tests/test_e2e_connectivity.py
端到端连接测试
/Users/sgl/PycharmProjects/PythonProject/backend_python/tests/test_integration_full.py
完整集成测试
/Users/sgl/PycharmProjects/PythonProject/backend_python/tests/test_services/
服务层测试
/Users/sgl/PycharmProjects/PythonProject/backend_python/tests/test_adapters/
AI 适配器测试
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/tests/test_diagnosis_report_storage.py
诊断报告存储测试
/Users/sgl/PycharmProjects/PythonProject/backend_python/wechat_backend/tests/test_quality_scorer.py
质量评分器测试
6.2 前端测试
文件路径
描述
/Users/sgl/PycharmProjects/PythonProject/tests/test-brandTestService.js
品牌测试服务测试
/Users/sgl/PycharmProjects/PythonProject/tests/test-dataLoaderService.test.js
数据加载服务测试
/Users/sgl/PycharmProjects/PythonProject/tests/test-taskStatusService.test.js
任务状态服务测试
/Users/sgl/PycharmProjects/PythonProject/tests/test-pages-index.js
首页测试
/Users/sgl/PycharmProjects/PythonProject/tests/test-pages-results.js
结果页测试
6.3 综合测试脚本
文件路径
描述
/Users/sgl/PycharmProjects/PythonProject/test_diagnosis_e2e.py
诊断端到端测试
/Users/sgl/PycharmProjects/PythonProject/test_p0_fixes_comprehensive.py
P0 修复综合测试
/Users/sgl/PycharmProjects/PythonProject/test_comprehensive_p0_fix.py
P0 修复综合验证
/Users/sgl/PycharmProjects/PythonProject/run_comprehensive_tests.py
综合测试运行器
/Users/sgl/PycharmProjects/PythonProject/complete_diagnostics_test.py
完整诊断测试
7. 配置文件
文件路径
描述
/Users/sgl/PycharmProjects/PythonProject/requirements.txt
根目录依赖 (Flask 3.1.2)
/Users/sgl/PycharmProjects/PythonProject/backend_python/requirements.txt
后端依赖 (Flask 2.0.1 + 扩展)
/Users/sgl/PycharmProjects/PythonProject/.env.example
环境变量示例
/Users/sgl/PycharmProjects/PythonProject/.flaskenv
Flask 环境配置
/Users/sgl/PycharmProjects/PythonProject/app.json
小程序页面配置
/Users/sgl/PycharmProjects/PythonProject/project.config.json
微信开发者工具配置
/Users/sgl/PycharmProjects/PythonProject/api_contract.json
API 契约文档
8. 明显的模式和问题
8.1 架构模式
1.
分层架构:
◦
Repository 层 (数据访问)
◦
Service 层 (业务逻辑)
◦
View 层 (API 路由)
2.
状态管理:
◦
使用 execution_store 内存存储
◦
使用 DiagnosisStateManager 统一内存和数据库状态
◦
支持 SSE 实时推送
3.
执行模式:
◦
NxM 矩阵执行 (N 个问题 × M 个模型)
◦
支持并发执行
◦
WAL (Write-Ahead Logging) 持久化
8.2 发现的问题
1.
文件组织混乱:
◦
根目录有 200+ 个脚本文件 (add_.py, fix_.py, test_*.py)
◦
大量修复脚本和报告文件散落在根目录
◦
建议：创建 scripts/ 和 docs/reports/ 目录归类
2.
代码重复:
◦
多个 AI 适配器实现有重复代码
◦
存在多个版本的相同功能文件 (如 sse_service.py 和 sse_service_v2.py)
3.
配置分散:
◦
配置分布在 .env, config.py, config_manager.py 等多处
◦
建议：统一配置管理
4.
测试覆盖不全:
◦
虽然有大量测试文件，但很多是临时修复验证脚本
◦
缺少系统的单元测试和集成测试套件
5.
日志过多:
◦
代码中有大量调试日志 (api_logger.info, debug_log 等)
◦
生产环境应降低日志级别
6.
硬编码路径:
◦
部分文件路径硬编码 (如 /tmp/nxm_wal)
◦
建议使用配置或环境变量
7.
数据库 Schema 演进:
◦
有多个迁移文件但缺少版本管理
◦
建议：使用正式的迁移工具 (如 Alembic)
8.
文档分散:
◦
大量 Markdown 报告文件在根目录
◦
建议：整理到 docs/ 目录并建立索引
9. 品牌诊断核心流程
用户输入品牌名称和竞品
        ↓
前端验证并发送 POST /api/perform-brand-test
        ↓
后端生成 execution_id 并创建初始数据库记录
        ↓
NxM 执行引擎启动异步任务
        ↓
遍历问题 × 模型组合调用 AI API
        ↓
实时结果通过 SSE 推送到前端
        ↓
结果聚合和质量评分
        ↓
生成深度情报分析 (露出分析、信源归因、证据链)
        ↓
保存到数据库和文件归档
        ↓
前端轮询 /test/status/<execution_id> 获取进度
        ↓
完成后展示结果页面
10. 关键数据流
前端 (pages/index/index.js)
  ↓ POST /api/perform-brand-test
后端 (diagnosis_views.py::perform_brand_test)
  ↓ 创建报告 (diagnosis_report_service.py::create_report)
  ↓ 执行 NxM 测试 (nxm_execution_engine.py::execute_nxm_test)
  ↓ 实时分析 (realtime_analyzer.py)
  ↓ 增量聚合 (incremental_aggregator.py)
  ↓ 保存结果 (diagnosis_report_repository.py::add_results_batch)
  ↓ 生成分析 (competitive_analysis.py, analytics_service.py)
  ↓ 完成报告 (diagnosis_report_service.py::complete_report)
  ↓ SSE 通知 (sse_service.py::send_completion_notification)
前端轮询状态
  ↓ GET /test/status/<execution_id>
后端返回进度和结果
  ↓
前端展示 (pages/results/results.js)
这份分析报告涵盖了项目的整体架构、关键技术文件、API 路由、数据库模型、测试文件和发现的问题。项目是一个功能完善的品牌诊断/GEO 分析系统，具有完整的前后端实现和多 AI 平台集成能力。
Now let me read the key diagnostic-related files to understand the current implementation details:
Let me continue reading more critical files to understand the current issues:
Now I have a comprehensive understanding of the codebase and the issues. Let me create the comprehensive refactoring baseline report.
I've created the comprehensive refactoring baseline report: 2026-02-27-重构基线.md.
Summary
The report is structured around 5 core modules as requested:
1. Business Requirements & User Journey Review (Product Expert)
•
User Personas: Brand Manager, Market Analyst, Digital Marketing Specialist
•
Core Scenarios: Brand health diagnosis, competitive analysis, campaign effectiveness evaluation
•
Value Proposition: Defined what constitutes a "valuable diagnostic report" (authenticity, completeness, statistical analysis, actionability, traceability)
•
Ideal User Journey: Complete state machine diagram with 7 states (initializing → ai_fetching → analyzing → completed/partial_success/failed/timeout)
2. Data Flow & State Machine Redesign (Chief Full-Stack Engineer)
•
End-to-End Data Flow: Frontend request → API gateway → Execution engine → AI adapters → Data pipeline → Storage
•
State Machine: Precise state definitions with entry/exit conditions and exception handling
•
Exception Mechanisms: Timeout (10 min), retry (3 attempts), circuit breaker, dead letter queue
3. Frontend-Backend Interaction & API Contracts (Full-Stack & Test Engineers)
•
OpenAPI Specifications: 3 key endpoints defined with full request/response schemas
◦
POST /api/v1/diagnostic/tasks - Create diagnostic task
◦
GET /api/v1/diagnostic/tasks/{taskId}/status - Poll task status
◦
GET /api/v1/diagnostic/tasks/{taskId}/report - Get diagnostic report
•
Data Consistency: Atomic updates, state verification, periodic sync mechanisms
4. Key Features & Bottleneck Analysis (Performance & Test Experts)
•
24 Core Features: Prioritized (P0/P1) with complexity estimates
•
Test Scenarios:
◦
Stability testing (100 concurrent users)
◦
Exception testing (API timeout, errors, invalid formats)
◦
Data accuracy testing (raw data completeness, statistical accuracy)
5. Deliverables & Acceptance Criteria
•
4 Acceptance Criteria with automated test cases:
i.
User can successfully initiate a diagnosis
ii.
System state accurately transitions from "running" to final state
iii.
User can view detailed report with real API data and statistical analysis
iv.
History page shows past diagnoses with consistent reports
The report includes:
•
4 Mermaid diagrams (state machine, sequence diagram)
•
Complete OpenAPI specifications
•
Python test case examples
•
Database schema definitions
•
24-item feature checklist
•
Automated test suite structure
This document serves as the single source of truth for the refactoring effort, replacing the 30+ patch scripts with a clean-slate design based on first principles.